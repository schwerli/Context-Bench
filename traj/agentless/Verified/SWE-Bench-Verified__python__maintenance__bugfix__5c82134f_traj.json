{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__5c82134f",
  "original_id": "django__django-13343",
  "1_model_selected_files": [
    "django/db/models/fields/files.py",
    "django/db/migrations/serializer.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/fields/files.py",
    "django/core/files/storage.py",
    "django/core/files/__init__.py",
    "django/db/migrations/operations/fields.py",
    "django/db/models/fields/__init__.py",
    "django/core/files/base.py",
    "django/core/files/uploadedfile.py",
    "django/db/migrations/autodetector.py",
    "django/core/files/uploadhandler.py",
    "django/db/models/fields/mixins.py",
    "django/db/migrations/questioner.py",
    "django/db/models/fields/related.py",
    "django/core/files/utils.py",
    "django/db/migrations/operations/utils.py",
    "django/db/models/lookups.py",
    "django/db/models/functions/mixins.py",
    "django/db/models/fields/proxy.py",
    "django/utils/deconstruct.py",
    "django/core/files/images.py",
    "django/core/files/temp.py",
    "django/db/models/sql/query.py",
    "django/utils/__init__.py",
    "django/core/__init__.py",
    "django/core/files/locks.py",
    "django/db/migrations/operations/__init__.py",
    "django/db/models/expressions.py",
    "django/utils/itercompat.py",
    "django/core/files/move.py",
    "django/db/models/fields/json.py",
    "django/core/management/commands/inspectdb.py",
    "django/db/models/query_utils.py",
    "django/utils/deprecation.py",
    "django/core/management/commands/__init__.py",
    "django/db/migrations/recorder.py",
    "django/utils/hashable.py",
    "django/db/migrations/writer.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/migrations/operations/models.py",
    "django/db/models/utils.py",
    "django/utils/formats.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/__init__.py",
    "django/db/models/base.py",
    "django/core/exceptions.py",
    "django/db/models/functions/window.py",
    "django/db/migrations/serializer.py",
    "django/utils/autoreload.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/models/options.py",
    "django/db/migrations/executor.py",
    "django/db/models/functions/datetime.py",
    "django/utils/_os.py",
    "django/db/migrations/operations/base.py",
    "django/utils/decorators.py",
    "django/utils/functional.py",
    "django/core/validators.py",
    "django/utils/asyncio.py"
  ],
  "3_final_combined_files": [
    "django/db/models/fields/files.py",
    "django/db/migrations/serializer.py",
    "django/core/files/storage.py",
    "django/core/files/__init__.py"
  ],
  "4_related_elements": {
    "django/db/models/fields/files.py": [
      "function: FileField.__init__\nfunction: FileField.deconstruct\nfunction: ImageField.deconstruct"
    ],
    "django/db/migrations/serializer.py": [
      "class: ModelFieldSerializer\nclass: FunctionTypeSerializer\nclass: DeconstructableSerializer\nclass: Serializer\nfunction: serializer_factory\nvariable: Serializer._registry"
    ],
    "django/core/files/storage.py": [
      "class: FileSystemStorage\nfunction: get_storage_class\nclass: DefaultStorage\nvariable: default_storage"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/fields/files.py": [
          "\nfunction: FileField.__init__\nfunction: FileField.deconstruct"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..968ad81 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,21 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve the original storage argument for deconstruction.\n+        self._storage_argument = storage\n+\n+        # Resolve the storage for runtime use.\n+        resolved_storage = storage or default_storage\n+        if callable(resolved_storage):\n+            # Keep a reference to the callable so deconstruction can serialize it.\n+            self._storage_argument = resolved_storage\n+            resolved_storage = resolved_storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,8 +285,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs['storage'] = self.storage\n+        # Preserve callable storage during deconstruction by referencing the original argument.\n+        storage_arg = getattr(self, '_storage_argument', None)\n+        if storage_arg is not None and storage_arg is not default_storage:\n+            kwargs['storage'] = storage_arg\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..3bd9492 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,9 +227,11 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable for deconstruction if provided.\n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n+        if self._storage_callable is not None:\n+            self.storage = self._storage_callable()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n@@ -278,7 +280,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was originally provided, return the callable reference.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..0af2424 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Keep a reference to the original storage callable (if provided) so\n+        # that deconstruction can serialize the callable rather than its result.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was provided for storage, preserve the callable reference\n+        # rather than the evaluated Storage instance.\n+        if self._storage_callable is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..7b08da8 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,13 +228,16 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n+        self._storage_callable = None\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            self._storage_callable = self.storage\n+            resolved_storage = self.storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +281,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..d98e8dc 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,9 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable storage (if any) for deconstruction.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +281,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..f0faa13 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,8 +228,10 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n+        self._storage_callable = None\n         if callable(self.storage):\n-            self.storage = self.storage()\n+            self._storage_callable = self.storage\n+            self.storage = self._storage_callable()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n@@ -278,7 +280,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..d593fb4 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,26 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable for deconstruction while still evaluating to a Storage\n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        if callable(storage):\n+            evaluated_storage = storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n+        elif callable(self.storage):\n+            # Backward compatibility in case a callable is assigned to default_storage\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n+                raise TypeError(\n+                    \"%s.storage must be a subclass/instance of %s.%s\"\n+                    % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n+                )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +290,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # Preserve callable storage in deconstruction to avoid inlining evaluated instance.\n+        if self._storage_callable is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..392a43e 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,21 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n-                raise TypeError(\n-                    \"%s.storage must be a subclass/instance of %s.%s\"\n-                    % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n-                )\n+        # Preserve the original storage argument for deconstruction.\n+        if storage is None:\n+            self._storage = default_storage\n+            self.storage = default_storage\n+        else:\n+            self._storage = storage\n+            if callable(storage):\n+                self.storage = storage()\n+                if not isinstance(self.storage, Storage):\n+                    raise TypeError(\n+                        \"%s.storage must be a subclass/instance of %s.%s\"\n+                        % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n+                    )\n+            else:\n+                self.storage = storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,8 +285,8 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs['storage'] = self.storage\n+        if self._storage is not default_storage:\n+            kwargs['storage'] = self._storage\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..9da76b4 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,19 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve callable storage for deconstruction; evaluate lazily for runtime use.\n+        self._storage_callable = storage if callable(storage) else None\n+\n+        # For runtime operations, self.storage should be a Storage instance.\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +283,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # Preserve the original callable for storage to allow runtime selection.\n+        if getattr(self, \"_storage_callable\", None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..c2fe699 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,7 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +279,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/fields/files.py": [
          "\nfunction: FileField.__init__\nfunction: FileField.deconstruct"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..63bcd95 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,9 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable for deconstruction if provided.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +281,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was provided for storage, preserve the callable in the\n+        # deconstructed kwargs instead of the evaluated storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..6e24b1b 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,6 +228,8 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n+        # Preserve original callable storage for deconstruction, if provided.\n+        self._storage_callable = storage if callable(storage) else None\n         if callable(self.storage):\n             self.storage = self.storage()\n             if not isinstance(self.storage, Storage):\n@@ -278,7 +280,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If storage was provided as a callable, return the callable itself so it\n+        # can be serialized properly and evaluated at runtime.\n+        if getattr(self, \"_storage_callable\", None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..1091ac9 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original storage callable for correct deconstruction behavior.\n+        self._storage_callable = None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            self._storage_callable = self.storage\n+            evaluated_storage = self._storage_callable()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If storage was provided as a callable, preserve the callable reference.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..34c0095 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,13 +228,18 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve a callable storage for deconstruction while still evaluating\n+        # it for runtime use.\n+        self._storage_callable = None\n+        if callable(storage):\n+            self._storage_callable = storage\n+            evaluated_storage = storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +283,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..dcb85ad 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,8 +227,12 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable storage for proper deconstruction.\n+        self._storage_callable = None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n+            self._storage_callable = self.storage\n             self.storage = self.storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable storage was provided, return the callable itself in\n+        # the deconstructed kwargs. Otherwise, only include non-default storage.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..88269d3 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,16 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +280,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..8907696 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,9 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve a callable storage for deconstruction while still evaluating\n+        # it for runtime use.\n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +281,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, \"_storage_callable\", None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..d933222 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original storage argument (callable or instance) for deconstruction.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            resolved_storage = self.storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..dde0b3d 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable passed as storage (if any) so\n+        # deconstruction can serialize a reference to it rather than the\n+        # evaluated Storage instance.\n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was provided for storage, preserve the callable\n+        # rather than the evaluated Storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..8182151 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable storage (if any) for deconstruction,\n+        # but use its evaluated value at runtime.\n+        self._storage_callable = storage if callable(storage) else None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/fields/files.py": [
          "\nfunction: FileField.__init__\nline: 230\nline: 231\nline: 232\nline: 233\nline: 234\nline: 235\nline: 236\nline: 237\nfunction: FileField.deconstruct\nline: 281\nline: 282\nline: 283"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..1213d14 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,13 +228,16 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n+        # Preserve the original callable (if provided) for correct deconstruction.\n+        self._storage_callable = storage if callable(storage) else None\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +281,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was provided for storage, preserve it during deconstruction.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..53290b4 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,19 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve the original callable for deconstruction, but evaluate it\n+        # for runtime use.\n+        self._storage_callable = None\n+        storage_obj = storage or default_storage\n+        if callable(storage_obj):\n+            self._storage_callable = storage_obj\n+            storage_obj = storage_obj()\n+            if not isinstance(storage_obj, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        self.storage = storage_obj\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +283,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If the storage was provided as a callable, preserve the callable in\n+        # the deconstructed kwargs instead of the evaluated storage instance.\n+        if self._storage_callable is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..7c4d3ac 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Remember the original callable, if any, so deconstruction can preserve it.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated = self.storage()\n+            if not isinstance(evaluated, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # Preserve a callable storage by returning the callable itself rather than\n+        # the evaluated storage instance.\n+        if getattr(self, \"_storage_callable\", None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..e0fb2e4 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,20 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve the original storage parameter for deconstruction.\n+        self._storage = storage if storage is not None else default_storage\n+\n+        # Evaluate storage if it's callable to obtain the actual Storage instance.\n+        if callable(self._storage):\n+            evaluated_storage = self._storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n+        else:\n+            self.storage = self._storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,8 +284,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs['storage'] = self.storage\n+        # Return the original storage parameter for deconstruction. If the\n+        # storage was provided as a callable, keep the callable rather than\n+        # the evaluated storage instance.\n+        if self._storage is not default_storage:\n+            kwargs['storage'] = self._storage\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..dc60d68 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable for deconstruction if provided.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If the storage was provided as a callable, return the callable reference.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..189cfe3 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,11 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable storage (if provided) so that\n+        # deconstruction can return a reference to the callable rather than\n+        # an evaluated Storage instance.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +283,12 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was originally provided for storage, preserve that\n+        # callable in the deconstructed kwargs rather than the evaluated\n+        # Storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..3c0cd63 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,19 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        self._storage_arg = storage\n+        if storage is None:\n+            self.storage = default_storage\n+        elif callable(storage):\n+            evaluated_storage = storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n+        else:\n+            self.storage = storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +283,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if callable(getattr(self, '_storage_arg', None)):\n+            kwargs['storage'] = self._storage_arg\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..4e49541 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable for deconstruction so that migrations\n+        # can refer to the callable rather than the evaluated storage instance.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +282,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            # If a callable was provided originally, preserve the reference.\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..48050f6 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve original callable for correct deconstruction while still\n+        # evaluating it for runtime usage.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable storage was provided, preserve the callable reference\n+        # during deconstruction instead of the evaluated storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..1d89441 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,8 +227,13 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original storage parameter for deconstruction.\n+        self._storage_parameter = storage\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n+            # Evaluate the callable for runtime usage but preserve the original\n+            # callable for deconstruction so migrations can serialize a reference.\n             self.storage = self.storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n@@ -278,7 +283,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # Preserve callable storage in deconstruction to avoid inlining the evaluated storage.\n+        if hasattr(self, '_storage_parameter') and callable(self._storage_parameter):\n+            kwargs['storage'] = self._storage_parameter\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/fields/files.py": [
          "\nfunction: FileField.__init__\nline: 230\nline: 231\nline: 232\nline: 233\nline: 234\nline: 235\nline: 236\nline: 237\nfunction: FileField.deconstruct\nline: 281\nline: 282"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..a2d19a8 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,19 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve the original storage argument (which may be callable) for deconstruction.\n+        self._storage_callable = storage\n+\n+        # Resolve the storage to be used at runtime.\n+        resolved_storage = storage or default_storage\n+        if callable(resolved_storage):\n+            resolved_storage = resolved_storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,8 +283,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs['storage'] = self.storage\n+        # Preserve callable storages during deconstruction; don't inline evaluated storage instances.\n+        original_storage = getattr(self, '_storage_callable', None)\n+        if original_storage is not None and original_storage is not default_storage:\n+            kwargs['storage'] = original_storage\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..957e546 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,21 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n+        # Preserve the original callable for deconstruction if provided.\n+        self._storage_callable = storage if callable(storage) else None\n+\n+        if storage is None:\n+            self.storage = default_storage\n+        elif callable(storage):\n+            self.storage = storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        else:\n+            self.storage = storage\n+\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +285,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if self._storage_callable is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..498bcbb 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,9 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable for deconstruction if provided.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +281,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..ec80b4d 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,18 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Keep original callable storage (if provided) for deconstruction.\n+        self._storage_callable = storage if callable(storage) else None\n+        # Resolve the storage to an instance for runtime use.\n+        resolved_storage = storage if storage is not None else default_storage\n+        if callable(resolved_storage):\n+            resolved_storage = resolved_storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +282,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # Preserve callable storage in migrations; otherwise include non-default storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..d91a152 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -228,13 +228,18 @@ class FileField(Field):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n         self.storage = storage or default_storage\n+        # Preserve the original callable storage for deconstruction if provided.\n         if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+            self._storage_callable = self.storage\n+            evaluated_storage = self.storage()\n+            if not isinstance(evaluated_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+            self.storage = evaluated_storage\n+        else:\n+            self._storage_callable = None\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +283,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If the storage was provided as a callable, preserve the callable in migrations.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..885c75c 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,8 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        self._storage_callable = None\n         self.storage = storage or default_storage\n         if callable(self.storage):\n+            self._storage_callable = self.storage\n             self.storage = self.storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n@@ -278,7 +280,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..c4b9279 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,8 +227,14 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable, if provided, so deconstruction can\n+        # reference it without evaluating.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n+            # Evaluate the callable for runtime use, but keep a reference to it\n+            # in _storage_callable for deconstruction.\n             self.storage = self.storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n@@ -278,7 +284,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If 'storage' was provided as a callable, keep the callable reference.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..c2df88a 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,16 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n-                raise TypeError(\n-                    \"%s.storage must be a subclass/instance of %s.%s\"\n-                    % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n-                )\n+        # Preserve the original callable for proper deconstruction while still\n+        # resolving to a Storage instance for runtime use.\n+        self._storage_callable = storage if callable(storage) else None\n+        resolved_storage = storage() if callable(storage) else (storage or default_storage)\n+        if callable(storage) and not isinstance(resolved_storage, Storage):\n+            raise TypeError(\n+                \"%s.storage must be a subclass/instance of %s.%s\"\n+                % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n+            )\n+        self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +280,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If a callable was originally provided for storage, return that callable\n+        # rather than the evaluated Storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..6642ad7 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,6 +227,10 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n+        # Preserve the original callable storage (if provided) so deconstruction\n+        # can reference it without eagerly evaluating it.\n+        self._storage_callable = storage if callable(storage) else None\n+\n         self.storage = storage or default_storage\n         if callable(self.storage):\n             self.storage = self.storage()\n@@ -278,7 +282,11 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        # If the storage was provided as a callable, preserve the callable in\n+        # the deconstructed kwargs rather than the evaluated Storage instance.\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n",
        "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..da73690 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,21 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n+        # Preserve the original callable for deconstruction if provided, but\n+        # evaluate it now so that runtime access to field.storage uses a Storage instance.\n+        self._storage_callable = None\n+        if storage is None:\n+            self.storage = default_storage\n+        elif callable(storage):\n+            self._storage_callable = storage\n+            self.storage = storage()\n             if not isinstance(self.storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        else:\n+            self.storage = storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,7 +285,9 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n+        if getattr(self, '_storage_callable', None) is not None:\n+            kwargs['storage'] = self._storage_callable\n+        elif self.storage is not default_storage:\n             kwargs['storage'] = self.storage\n         return name, path, args, kwargs\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/fields/files.py b/django/db/models/fields/files.py\nindex 4e9ee79..968ad81 100644\n--- a/django/db/models/fields/files.py\n+++ b/django/db/models/fields/files.py\n@@ -227,14 +227,21 @@ class FileField(Field):\n     def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **kwargs):\n         self._primary_key_set_explicitly = 'primary_key' in kwargs\n \n-        self.storage = storage or default_storage\n-        if callable(self.storage):\n-            self.storage = self.storage()\n-            if not isinstance(self.storage, Storage):\n+        # Preserve the original storage argument for deconstruction.\n+        self._storage_argument = storage\n+\n+        # Resolve the storage for runtime use.\n+        resolved_storage = storage or default_storage\n+        if callable(resolved_storage):\n+            # Keep a reference to the callable so deconstruction can serialize it.\n+            self._storage_argument = resolved_storage\n+            resolved_storage = resolved_storage()\n+            if not isinstance(resolved_storage, Storage):\n                 raise TypeError(\n                     \"%s.storage must be a subclass/instance of %s.%s\"\n                     % (self.__class__.__qualname__, Storage.__module__, Storage.__qualname__)\n                 )\n+        self.storage = resolved_storage\n         self.upload_to = upload_to\n \n         kwargs.setdefault('max_length', 100)\n@@ -278,8 +285,10 @@ class FileField(Field):\n         if kwargs.get(\"max_length\") == 100:\n             del kwargs[\"max_length\"]\n         kwargs['upload_to'] = self.upload_to\n-        if self.storage is not default_storage:\n-            kwargs['storage'] = self.storage\n+        # Preserve callable storage during deconstruction by referencing the original argument.\n+        storage_arg = getattr(self, '_storage_argument', None)\n+        if storage_arg is not None and storage_arg is not default_storage:\n+            kwargs['storage'] = storage_arg\n         return name, path, args, kwargs\n \n     def get_internal_type(self):\n",
  "7_resolved": true
}