{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__60bc9e86",
  "original_id": "django__django-15863",
  "1_model_selected_files": [
    "django/template/defaultfilters.py",
    "django/utils/numberformat.py"
  ],
  "2_embedding_selected_files": [
    "django/utils/formats.py",
    "django/utils/numberformat.py",
    "django/template/defaultfilters.py",
    "django/utils/baseconv.py",
    "django/template/backends/__init__.py",
    "django/template/response.py",
    "django/template/backends/utils.py",
    "django/utils/datetime_safe.py",
    "django/template/backends/jinja2.py",
    "django/utils/translation/template.py",
    "django/utils/dateformat.py",
    "django/utils/dateparse.py",
    "django/utils/__init__.py",
    "django/utils/duration.py",
    "django/template/backends/dummy.py",
    "django/utils/dates.py",
    "django/template/base.py",
    "django/template/exceptions.py",
    "django/utils/text.py",
    "django/template/loaders/__init__.py",
    "django/template/backends/django.py",
    "django/utils/translation/__init__.py",
    "django/utils/ipv6.py",
    "django/utils/hashable.py",
    "django/utils/html.py",
    "django/utils/http.py",
    "django/setup.py",
    "django/utils/itercompat.py",
    "django/template/__init__.py",
    "django/template/context_processors.py",
    "django/template/autoreload.py",
    "django/utils/translation/trans_null.py",
    "django/template/utils.py",
    "django/template/defaulttags.py",
    "django/utils/version.py",
    "django/utils/encoding.py",
    "django/utils/crypto.py",
    "django/template/loader.py",
    "django/utils/timezone.py",
    "django/__init__.py",
    "django/utils/safestring.py",
    "django/utils/deconstruct.py",
    "django/utils/termcolors.py",
    "django/template/engine.py",
    "django/template/loader_tags.py",
    "django/shortcuts.py",
    "django/utils/inspect.py",
    "django/utils/translation/trans_real.py",
    "django/utils/deprecation.py",
    "django/template/library.py",
    "django/utils/asyncio.py",
    "django/utils/_os.py",
    "django/utils/functional.py",
    "django/template/loaders/cached.py",
    "django/utils/log.py",
    "django/utils/regex_helper.py",
    "django/template/loaders/locmem.py",
    "django/utils/timesince.py",
    "django/template/backends/base.py",
    "django/utils/translation/reloader.py",
    "django/template/context.py",
    "django/utils/decorators.py",
    "django/template/loaders/app_directories.py",
    "django/template/loaders/base.py",
    "django/template/loaders/filesystem.py",
    "django/utils/datastructures.py",
    "django/utils/archive.py",
    "django/template/smartif.py",
    "django/utils/autoreload.py",
    "django/utils/cache.py",
    "django/utils/module_loading.py",
    "django/utils/connection.py",
    "django/utils/jslex.py"
  ],
  "3_final_combined_files": [
    "django/template/defaultfilters.py",
    "django/utils/numberformat.py",
    "django/utils/formats.py"
  ],
  "4_related_elements": {
    "django/template/defaultfilters.py": [
      "function: floatformat"
    ],
    "django/utils/numberformat.py": [
      "function: format"
    ],
    "django/utils/formats.py": [
      "function: number_format\nfunction: localize\nfunction: localize_input\nfunction: sanitize_separators\nvariable: FORMAT_SETTINGS"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 153\nline: 154\nline: 155\nline: 156\nline: 157\nline: 158\nline: 159\nline: 160"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..784d97c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Avoid loss of precision and invalid parsing from repr(Decimal(...)).\n+        d = text\n+        input_val = str(text)\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..afd715b 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Use Decimal directly to preserve precision and avoid float conversion.\n+        d = text\n+        input_val = str(text)\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..bf437d7 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Preserve Decimal inputs to avoid precision loss from float conversion.\n+        input_val = str(text)\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(text))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..f489fa6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,9 +150,12 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n             d = Decimal(str(float(text)))\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..4aead5e 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,8 +151,15 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        input_val = str(text)\n+        if isinstance(text, float):\n+            # Use repr() for floats to retain precision in their string form.\n+            d = Decimal(repr(text))\n+        elif isinstance(text, Decimal):\n+            # Preserve Decimal values as-is to avoid precision loss.\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n             d = Decimal(str(float(text)))\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..88b406c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,20 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Preserve precision for Decimal inputs and provide a clean string\n+        # representation for fallback returns (e.g., NaN/Infinity).\n+        input_val = str(text)\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..6e3206b 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,13 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n+    except (InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..730d429 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,10 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        d = text if isinstance(text, Decimal) else Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..5578e64 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,13 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..b875068 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,27 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    # Convert input to Decimal, preserving precision for Decimal inputs and\n+    # avoiding binary floating point rounding for float inputs.\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        elif isinstance(text, float):\n+            d = Decimal(str(text))\n+        else:\n+            d = Decimal(text)\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n-            d = Decimal(str(float(text)))\n+            d = Decimal(str(text))\n         except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            try:\n+                # Fallback through float for non-standard types, as a last resort.\n+                float_val = float(text)\n+                input_val = str(float_val)\n+                d = Decimal(str(float_val))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 154\nline: 155\nline: 156\nline: 157\nline: 158\nline: 159\nline: 160"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..7562a5a 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,8 +151,14 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Preserve Decimal precision and ensure a sensible string\n+            # representation for potential fallback returns (e.g. NaN/Inf).\n+            input_val = str(text)\n+            d = text\n+        else:\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n             d = Decimal(str(float(text)))\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..f8d2944 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,20 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    # Use str() for input_val to preserve Decimal precision and a readable\n+    # representation for special values like NaN/Infinity.\n+    input_val = str(text)\n+    # Avoid converting Decimals to float which drops precision.\n+    if isinstance(text, Decimal):\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..9fbb9f8 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,10 +151,16 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Use the Decimal value directly to preserve precision.\n+            d = text\n+            input_val = str(text)\n+        else:\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n+            # Fallback: attempt to coerce through float for non-Decimal inputs.\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..43b12d6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -152,9 +152,14 @@ def floatformat(text, arg=-1):\n             arg = arg[:-1] or -1\n     try:\n         input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Preserve precision for Decimal inputs by using the value directly.\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n+            # Fallback for non-Decimal inputs that can't be parsed directly.\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..a502cf6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,24 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    # Preserve precision for Decimal values and avoid lossy float conversion.\n+    if isinstance(text, Decimal):\n+        d = text\n+        input_val = str(text)\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = str(text)\n+            d = Decimal(input_val)\n+        except (InvalidOperation, TypeError, ValueError):\n+            try:\n+                f = float(text)\n+            except (TypeError, ValueError):\n+                return \"\"\n+            input_val = str(f)\n+            try:\n+                d = Decimal(input_val)\n+            except InvalidOperation:\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..3cac9ee 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,13 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = repr(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..b69ddc0 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,11 +151,21 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            # Preserve exact value for Decimal inputs.\n+            d = text\n+            input_val = str(text)\n+        else:\n+            # For plain numbers, repr() is fine (handles inf/nan for floats).\n+            # For other types (e.g. strings), use str() to avoid wrapping type info,\n+            # e.g. \"Decimal('...')\", which Decimal() cannot parse.\n+            input_val = repr(text) if isinstance(text, (int, float)) else str(text)\n+            d = Decimal(input_val)\n+    except (InvalidOperation, ValueError, TypeError):\n         try:\n+            # Fallback: convert via float (may lose precision).\n             d = Decimal(str(float(text)))\n+            input_val = str(text)\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..109e0b1 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,12 +150,26 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    # Build a Decimal while preserving precision, especially for Decimal inputs.\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            # Use the Decimal value directly to preserve precision.\n+            d = text\n+            input_val = str(text)\n+        else:\n+            # First, try using repr() (works well for floats, ints, NaN/Inf).\n+            input_val = repr(text)\n+            try:\n+                d = Decimal(input_val)\n+            except InvalidOperation:\n+                # If repr() isn't a valid Decimal (e.g., strings), try str() directly.\n+                input_val = str(text)\n+                d = Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n+        # As a last resort, convert through float (may lose precision).\n         try:\n             d = Decimal(str(float(text)))\n+            input_val = repr(text)\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..503097b 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,26 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n+    # Convert the input to Decimal without losing precision when possible.\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            if isinstance(text, str):\n+                d = Decimal(text.strip())\n+            else:\n+                d = Decimal(str(text))\n+    except (InvalidOperation, TypeError, ValueError):\n+        # Fallback to float conversion and handle Infinity/NaN.\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n+            f = float(text)\n+        except (TypeError, ValueError):\n             return \"\"\n+        # If the float is NaN or infinity, display its string representation.\n+        if f != f or f == float(\"inf\") or f == float(\"-inf\"):\n+            return input_val\n+        d = Decimal(str(f))\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..a3ea171 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,18 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = repr(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n-        try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+        if isinstance(text, Decimal):\n+            d = text\n+        elif isinstance(text, bool):\n+            d = Decimal(int(text))\n+        else:\n+            # Use string conversion to avoid precision loss for Decimals and\n+            # strings while handling floats and ints gracefully.\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n+        return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 154\nline: 155\nline: 156\nline: 157\nline: 158\nline: 159\nline: 160"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..81092bb 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,18 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = repr(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n-        try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+        if isinstance(text, Decimal):\n+            d = text\n+        elif isinstance(text, (int, float)):\n+            d = Decimal(str(text))\n+        elif isinstance(text, str):\n+            d = Decimal(text)\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n+        return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..f5b3913 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,11 +151,17 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            d = text\n+            input_val = str(text)\n+        else:\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n+            # Fallback: attempt to coerce through float for non-Decimal inputs.\n             d = Decimal(str(float(text)))\n+            input_val = repr(text)\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..8845aa7 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Preserve Decimal precision and avoid conversion to float.\n+        input_val = str(text)\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..6b89853 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -152,7 +152,10 @@ def floatformat(text, arg=-1):\n             arg = arg[:-1] or -1\n     try:\n         input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n             d = Decimal(str(float(text)))\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..dd50f06 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,11 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n-        try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+        d = text if isinstance(text, Decimal) else Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n+        return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..0046eaa 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,11 +151,18 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Preserve exact value for Decimal inputs.\n+            input_val = str(text)\n+            d = text\n+        else:\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n-            d = Decimal(str(float(text)))\n+            # Fallback: avoid converting through float to preserve precision.\n+            d = Decimal(str(text))\n+            input_val = str(text)\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..023b8ba 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,17 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    input_val = repr(text)\n+    if isinstance(text, Decimal):\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(text))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..322d56c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -151,11 +151,21 @@ def floatformat(text, arg=-1):\n             use_l10n = False\n             arg = arg[:-1] or -1\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Preserve Decimal inputs without converting through float.\n+            d = text\n+            input_val = str(text)\n+        else:\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n-            d = Decimal(str(float(text)))\n+            if isinstance(text, str):\n+                # If it's a numeric string, convert directly to Decimal.\n+                input_val = text\n+                d = Decimal(text)\n+            else:\n+                d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..d0c4d34 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    # Represent the original value for potential fallback output (e.g., NaN/Inf).\n+    input_val = repr(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        elif isinstance(text, float):\n+            # Preserve special values and avoid binary rounding artifacts.\n+            d = Decimal.from_float(text)\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n+        # As a last resort, try going through float for types that can be\n+        # coerced to float (e.g., bool), matching previous behavior.\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..5efe511 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,13 +150,18 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        d = text if isinstance(text, Decimal) else Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n+            f = float(text)\n+        except (ValueError, TypeError):\n+            return \"\"\n+        input_val = str(f)\n+        try:\n+            d = Decimal(input_val)\n+        except (InvalidOperation, ValueError):\n             return \"\"\n     try:\n         p = int(arg)\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 154\nline: 155\nline: 156\nline: 157\nline: 158\nline: 159\nline: 160"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..39b03bc 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,10 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n         d = Decimal(input_val)\n-    except InvalidOperation:\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..f624371 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,26 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    # Convert to Decimal without losing precision for Decimal inputs.\n+    if isinstance(text, Decimal):\n+        d = text\n+        input_val = str(text)\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n+            # Use repr() for floats to avoid precision loss.\n+            if isinstance(text, float):\n+                input_val = repr(text)\n+            else:\n+                input_val = str(text)\n+            d = Decimal(input_val)\n         except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            try:\n+                # Fallback through float for other types/strings.\n+                f = float(text)\n+                input_val = repr(f)\n+                d = Decimal(input_val)\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..3cac9ee 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,10 +150,13 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = repr(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..b8d0f89 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,11 +150,16 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = repr(text)\n+    # Avoid loss of precision for Decimal values by not converting through float.\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        if isinstance(text, Decimal):\n+            d = text\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n+            # Fallback: attempt to convert through float for non-Decimal inputs.\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..d092d07 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Preserve exact value for Decimal inputs.\n+        input_val = str(text)\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..66a1010 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,17 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    input_val = str(text)\n+    if isinstance(text, Decimal):\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            d = Decimal(input_val)\n+        except (InvalidOperation, TypeError, ValueError):\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..93ce76c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,21 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    input_val = repr(text)\n+    # Preserve precision for Decimal instances by avoiding float conversion.\n+    if isinstance(text, Decimal):\n+        d = text\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n+            if isinstance(text, str):\n+                d = Decimal(text)\n+            else:\n+                d = Decimal(input_val)\n         except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            try:\n+                d = Decimal(repr(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..b935350 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,11 +150,16 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    # Preserve a string representation of the input for exceptional returns\n+    # (e.g., when encountering NaN/Infinity or invalid args).\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+        # Avoid precision loss for Decimal inputs by using them directly.\n+        d = text if isinstance(text, Decimal) else Decimal(input_val)\n+    except (ValueError, InvalidOperation, TypeError):\n         try:\n+            # Fallback: attempt conversion via float for types that cannot be\n+            # directly converted to Decimal.\n             d = Decimal(str(float(text)))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..57b87fc 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -152,10 +152,15 @@ def floatformat(text, arg=-1):\n             arg = arg[:-1] or -1\n     try:\n         input_val = repr(text)\n-        d = Decimal(input_val)\n+        if isinstance(text, Decimal):\n+            # Preserve exact Decimal values without converting through float.\n+            d = text\n+        else:\n+            d = Decimal(input_val)\n     except InvalidOperation:\n         try:\n-            d = Decimal(str(float(text)))\n+            # Fall back to string conversion (not via float) to avoid precision loss.\n+            d = Decimal(str(text))\n         except (ValueError, InvalidOperation, TypeError):\n             return \"\"\n     try:\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..abbcc52 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n+    input_val = str(text)\n     try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n-        try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+        if isinstance(text, Decimal):\n+            d = text\n+        elif isinstance(text, int):\n+            d = Decimal(text)\n+        elif isinstance(text, float):\n+            d = Decimal(str(text))\n+        else:\n+            d = Decimal(str(text))\n+    except (ValueError, InvalidOperation, TypeError):\n+        return \"\"\n+\n     try:\n         p = int(arg)\n     except ValueError:\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex 9a0415d..784d97c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -150,14 +150,19 @@ def floatformat(text, arg=-1):\n         elif last_char == \"u\":\n             use_l10n = False\n             arg = arg[:-1] or -1\n-    try:\n-        input_val = repr(text)\n-        d = Decimal(input_val)\n-    except InvalidOperation:\n+    if isinstance(text, Decimal):\n+        # Avoid loss of precision and invalid parsing from repr(Decimal(...)).\n+        d = text\n+        input_val = str(text)\n+    else:\n         try:\n-            d = Decimal(str(float(text)))\n-        except (ValueError, InvalidOperation, TypeError):\n-            return \"\"\n+            input_val = repr(text)\n+            d = Decimal(input_val)\n+        except InvalidOperation:\n+            try:\n+                d = Decimal(str(float(text)))\n+            except (ValueError, InvalidOperation, TypeError):\n+                return \"\"\n     try:\n         p = int(arg)\n     except ValueError:\n",
  "7_resolved": true
}