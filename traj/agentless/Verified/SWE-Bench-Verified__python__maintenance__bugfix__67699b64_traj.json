{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__67699b64",
  "original_id": "matplotlib__matplotlib-23299",
  "1_model_selected_files": [
    "lib/matplotlib/__init__.py",
    "lib/matplotlib/backends/__init__.py",
    "lib/matplotlib/pyplot.py",
    "lib/matplotlib/_pylab_helpers.py",
    "lib/matplotlib/rcsetup.py"
  ],
  "2_embedding_selected_files": [
    "lib/matplotlib/pyplot.py",
    "lib/matplotlib/_pylab_helpers.py",
    "lib/matplotlib/backends/backend_gtk3cairo.py",
    "lib/matplotlib/backends/backend_gtk3agg.py",
    "lib/matplotlib/backends/backend_gtk3.py",
    "lib/matplotlib/backends/backend_gtk4cairo.py",
    "lib/matplotlib/backends/backend_gtk4.py",
    "lib/matplotlib/backends/backend_qt.py",
    "lib/matplotlib/backends/backend_gtk4agg.py",
    "lib/matplotlib/backends/backend_qtcairo.py",
    "lib/matplotlib/backends/_backend_gtk.py",
    "lib/matplotlib/backends/backend_template.py",
    "lib/matplotlib/backends/backend_qt5cairo.py",
    "lib/matplotlib/backends/__init__.py",
    "lib/matplotlib/backends/backend_cairo.py",
    "lib/matplotlib/backends/backend_qt5.py",
    "lib/matplotlib/backend_bases.py",
    "lib/matplotlib/__init__.py",
    "lib/matplotlib/backends/qt_editor/__init__.py",
    "lib/matplotlib/backends/backend_nbagg.py",
    "lib/matplotlib/backends/_backend_tk.py",
    "lib/matplotlib/backends/backend_tkcairo.py",
    "lib/matplotlib/backends/backend_webagg.py",
    "lib/matplotlib/backends/backend_tkagg.py",
    "lib/matplotlib/rcsetup.py",
    "lib/matplotlib/backends/backend_pdf.py",
    "lib/matplotlib/backends/qt_editor/figureoptions.py",
    "lib/matplotlib/axes/_axes.py",
    "lib/matplotlib/backends/backend_macosx.py",
    "lib/matplotlib/backends/backend_pgf.py",
    "lib/matplotlib/backends/backend_wxcairo.py",
    "lib/matplotlib/gridspec.py",
    "lib/matplotlib/figure.py",
    "lib/matplotlib/backends/qt_compat.py",
    "lib/matplotlib/backends/backend_wx.py",
    "lib/matplotlib/_layoutgrid.py",
    "lib/matplotlib/backends/backend_qtagg.py",
    "lib/matplotlib/backends/backend_webagg_core.py",
    "lib/matplotlib/backends/backend_qt5agg.py",
    "lib/matplotlib/_constrained_layout.py",
    "lib/matplotlib/backends/backend_wxagg.py",
    "lib/matplotlib/backends/backend_agg.py",
    "lib/matplotlib/backend_tools.py",
    "lib/matplotlib/axes/_subplots.py",
    "lib/matplotlib/pylab.py",
    "lib/matplotlib/_cm.py"
  ],
  "3_final_combined_files": [
    "lib/matplotlib/pyplot.py",
    "lib/matplotlib/__init__.py",
    "lib/matplotlib/backends/__init__.py",
    "lib/matplotlib/_pylab_helpers.py",
    "lib/matplotlib/backends/backend_gtk3cairo.py"
  ],
  "4_related_elements": {
    "lib/matplotlib/__init__.py": [
      "function: get_backend\nfunction: use\nfunction: rc_context\nclass: RcParams\nvariable: rcParams\nvariable: rcParamsOrig"
    ],
    "lib/matplotlib/pyplot.py": [
      "function: switch_backend\nvariable: _backend_mod\nfunction: _get_backend_mod\nfunction: rc_context\nfunction: figure\nfunction: new_figure_manager\nfunction: draw_if_interactive\nfunction: show\nfunction: isinteractive\nfunction: ion\nfunction: ioff\nfunction: get_current_fig_manager\nfunction: close"
    ],
    "lib/matplotlib/backends/__init__.py": [
      "variable: backend"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "lib/matplotlib/__init__.py": [
          "\nfunction: rc_context\nline: 1098\nline: 1099"
        ]
      },
      "patches": [
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..1a93c36 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs, honoring validators/callbacks.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..d077e7e 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,11 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert only keys that were changed in this context to avoid\n+        # triggering side-effects (e.g., backend re-selection) on unchanged keys.\n+        for k, v in orig.items():\n+            if rcParams.get(k) != v:\n+                rcParams[k] = v\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..b385b02 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,9 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams using RcParams.update to ensure\n+        # proper validation and callbacks (e.g., backend/interactive state).\n+        rcParams.update(orig)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..d46c051 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1087,7 +1087,8 @@ def rc_context(rc=None, fname=None):\n              plt.plot(x, y)  # uses 'print.rc'\n \n     \"\"\"\n-    orig = rcParams.copy()\n+    # Only take a snapshot if we will actually modify rcParams.\n+    orig = rcParams.copy() if (rc or fname) else None\n     try:\n         if fname:\n             rc_file(fname)\n@@ -1095,7 +1096,9 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams only if we changed them.\n+        if orig is not None:\n+            dict.update(rcParams, orig)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..34fbffd 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcParams using proper setters.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..72cb7b6 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,13 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert only parameters that were actually changed within the context.\n+        # Restoring all keys unconditionally can inadvertently trigger backend\n+        # (re)initialization later, which may clear existing figures when\n+        # get_backend() performs lazy backend setup. Limiting restoration to\n+        # changed keys prevents that unintended side effect.\n+        to_restore = {k: v for k, v in orig.items() if rcParams.get(k) != v}\n+        rcParams.update(to_restore)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..101492c 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,12 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams, but avoid resetting the backend.\n+        # Resetting the backend after a figure has been created can lead to\n+        # backend reinitialization, which in turn may clear existing figures\n+        # (e.g., upon a subsequent get_backend() call).\n+        orig_wo_backend = {k: v for k, v in orig.items() if k != 'backend'}\n+        dict.update(rcParams, orig_wo_backend)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..f2a75c0 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,12 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams, but only set keys that actually\n+        # changed. This avoids triggering unnecessary callbacks (e.g.,\n+        # backend re-selection) and keeps internal state consistent.\n+        for k, v in orig.items():\n+            if rcParams.get(k) != v:\n+                rcParams[k] = v\n \n \n def use(backend, *, force=True):\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "lib/matplotlib/__init__.py": [
          "\nfunction: RcParams.__getitem__\nline: 671\nline: 679\nfunction: rc_context\nline: 1090\nline: 1099"
        ]
      },
      "patches": [
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..5daa9ad 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,21 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Do not revert 'backend' to the auto backend sentinel if it was\n+        # resolved during the context (e.g., by creating a figure). Reverting\n+        # to the sentinel can trigger a backend switch on get_backend(), which\n+        # clears Gcf.figs.\n+        try:\n+            orig_backend = orig.get(\"backend\")\n+            current_backend = rcParams.get(\"backend\")\n+        except Exception:\n+            orig_backend = None\n+            current_backend = None\n+        if (orig_backend is getattr(rcsetup, \"_auto_backend_sentinel\", None)\n+                and current_backend is not getattr(rcsetup, \"_auto_backend_sentinel\", None)):\n+            # Keep the resolved backend instead of restoring the sentinel.\n+            orig[\"backend\"] = current_backend\n+        dict.update(rcParams, orig)  # Revert to the original rcs (with backend exception).\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..5ce2014 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,20 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams, but avoid resetting the backend to\n+        # the auto-backend sentinel if it got resolved during the context.\n+        try:\n+            from . import rcsetup as _rcsetup\n+        except Exception:\n+            _rcsetup = None\n+        if _rcsetup is not None:\n+            orig_backend = orig.get(\"backend\")\n+            if orig_backend is _rcsetup._auto_backend_sentinel:\n+                # Keep the currently resolved backend; do not overwrite it with\n+                # the auto sentinel, which would trigger a backend switch and\n+                # clear existing figures on next access.\n+                orig = {k: v for k, v in orig.items() if k != \"backend\"}\n+        dict.update(rcParams, orig)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..08bb7dd 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,38 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    # Track whether rc_context explicitly modified the backend.\n+    _backend_modified = False\n+    # Read the backend value before applying rc/fname without triggering resolution.\n+    _orig_backend_raw = dict.__getitem__(rcParams, \"backend\")\n     try:\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Detect if backend was explicitly modified by the context.\n+        _after_backend_raw = dict.__getitem__(rcParams, \"backend\")\n+        _backend_modified = (_after_backend_raw != _orig_backend_raw)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to original rcParams, but avoid resetting the backend to the\n+        # auto-sentinel if it has been resolved during the context and was not\n+        # explicitly modified by rc_context. Resetting to the auto-sentinel can\n+        # cause get_backend() to re-resolve the backend and clear existing figures.\n+        revert_dict = orig\n+        try:\n+            from . import rcsetup as _rcsetup\n+        except Exception:\n+            _rcsetup = None\n+        if not _backend_modified and _rcsetup is not None:\n+            orig_backend_raw = orig.get(\"backend\")\n+            current_backend_raw = dict.__getitem__(rcParams, \"backend\")\n+            if (orig_backend_raw is _rcsetup._auto_backend_sentinel\n+                    and current_backend_raw is not _rcsetup._auto_backend_sentinel):\n+                revert_dict = orig.copy()\n+                # Preserve the resolved backend instead of reverting to auto.\n+                revert_dict[\"backend\"] = current_backend_raw\n+        dict.update(rcParams, revert_dict)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..aca8cd0 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,19 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams. However, if the original backend\n+        # was the auto-backend sentinel and the backend got resolved during\n+        # the context (e.g., by creating a figure), preserve the resolved\n+        # backend to avoid re-switching (which can clear existing figures).\n+        orig_backend = orig.get(\"backend\")\n+        current_backend = rcParams._get_backend_or_none()  # Does not trigger resolution.\n+        if (orig_backend is rcsetup._auto_backend_sentinel\n+                and current_backend is not None):\n+            to_restore = orig.copy()\n+            to_restore.pop(\"backend\", None)\n+            dict.update(rcParams, to_restore)\n+        else:\n+            dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..8308fff 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,6 +1095,11 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n+        # Preserve a resolved backend; don't revert to the \"auto\" sentinel,\n+        # which would trigger a backend switch on access and may discard figures.\n+        current_backend = rcParams._get_backend_or_none()\n+        if current_backend is not None and not isinstance(orig.get(\"backend\"), str):\n+            orig[\"backend\"] = current_backend\n         dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..3255555 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,22 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams, but avoid resetting the backend to\n+        # the \"auto\" sentinel if the backend was resolved while inside the\n+        # context (e.g., due to creating a figure). Resetting it to \"auto\"\n+        # would cause get_backend() to trigger a backend switch, which clears\n+        # existing figures.\n+        to_apply = orig.copy()\n+        from matplotlib import rcsetup\n+        auto = rcsetup._auto_backend_sentinel\n+        # Access the backend without triggering resolution.\n+        current_backend = rcParams._get_backend_or_none()\n+        # Only skip resetting the backend if this rc_context did not explicitly\n+        # set it (via rc or fname), and the backend was resolved during use.\n+        if not rc and not fname and to_apply.get(\"backend\", None) is auto and current_backend is not None:\n+            to_apply.pop(\"backend\", None)\n+        with _api.suppress_matplotlib_deprecation_warning():\n+            rcParams.update(to_apply)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..db93126 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -673,8 +673,11 @@ class RcParams(MutableMapping, dict):\n         elif key == \"backend\" and self is globals().get(\"rcParams\"):\n             val = dict.__getitem__(self, key)\n             if val is rcsetup._auto_backend_sentinel:\n-                from matplotlib import pyplot as plt\n-                plt.switch_backend(rcsetup._auto_backend_sentinel)\n+                # Resolve the auto-selected backend without clearing\n+                # existing figures. Using use(..., force=False) selects\n+                # the backend lazily and preserves current figure managers.\n+                from matplotlib import use as _mpl_use\n+                _mpl_use(rcsetup._auto_backend_sentinel, force=False)\n \n         return dict.__getitem__(self, key)\n \n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..8bfa183 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,33 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    # Record the original raw backend value without triggering resolution.\n+    _orig_backend_value = dict.__getitem__(rcParams, \"backend\")\n+    _changed_backend = False\n     try:\n         if fname:\n+            # Apply settings from file.\n             rc_file(fname)\n+            # Detect if the file changed the backend without triggering resolution.\n+            if dict.__getitem__(rcParams, \"backend\") != _orig_backend_value:\n+                _changed_backend = True\n         if rc:\n+            # Explicit rc dict may change backend.\n+            if \"backend\" in rc:\n+                _changed_backend = True\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # If the original backend was the auto sentinel and we did not explicitly\n+        # change the backend via rc_context, avoid restoring it. Restoring the\n+        # auto sentinel after figures were created can trigger backend re-resolution\n+        # on access (e.g., get_backend()) which may clear Gcf.figs.\n+        if (_orig_backend_value is rcsetup._auto_backend_sentinel) and not _changed_backend:\n+            new_orig = orig.copy()\n+            new_orig.pop(\"backend\", None)\n+            dict.update(rcParams, new_orig)\n+        else:\n+            dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..f0408c4 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,6 +1088,16 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    # Ensure the snapshot does not contain the auto-backend sentinel.\n+    # If the backend has not yet been resolved, access it once to trigger\n+    # resolution and store the resolved value into our snapshot. This avoids\n+    # restoring the sentinel later, which would retrigger backend resolution\n+    # (and may clear existing figures).\n+    if rcParams._get_backend_or_none() is None:\n+        _ = rcParams[\"backend\"]  # Trigger backend resolution if needed.\n+        resolved = rcParams._get_backend_or_none()\n+        if resolved is not None:\n+            orig[\"backend\"] = resolved\n     try:\n         if fname:\n             rc_file(fname)\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..18b2e90 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1087,15 +1087,28 @@ def rc_context(rc=None, fname=None):\n              plt.plot(x, y)  # uses 'print.rc'\n \n     \"\"\"\n-    orig = rcParams.copy()\n+    orig = None\n     try:\n-        if fname:\n-            rc_file(fname)\n-        if rc:\n-            rcParams.update(rc)\n+        # Only snapshot and modify rcParams if changes are requested.\n+        if fname or rc:\n+            orig = rcParams.copy()\n+            if fname:\n+                rc_file(fname)\n+            if rc:\n+                rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        if orig is not None:\n+            # If backend was 'auto' before the context, but resolved to a\n+            # concrete backend during the context (e.g., by creating a figure),\n+            # do not revert it back to 'auto' as that can trigger a backend\n+            # switch on next access and clear existing figures.\n+            _auto = rcsetup._auto_backend_sentinel\n+            if orig.get(\"backend\") is _auto and rcParams.get(\"backend\") is not _auto:\n+                preserved = rcParams[\"backend\"]\n+                orig = orig.copy()\n+                orig[\"backend\"] = preserved\n+            dict.update(rcParams, orig)  # Revert to the original rcs (with preserved backend if needed).\n \n \n def use(backend, *, force=True):\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "lib/matplotlib/__init__.py": [
          "\nfunction: rc_context\nline: 1090\nline: 1092\nline: 1095\nline: 1098\nline: 1099"
        ]
      },
      "patches": [
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..f0cfe11 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,12 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Only restore keys that actually changed during the context to avoid\n+        # triggering unnecessary side-effects (e.g., backend re-selection)\n+        # that can clear existing figures from Gcf.\n+        to_restore = {k: v for k, v in orig.items() if rcParams.get(k) != v}\n+        if to_restore:\n+            rcParams.update(to_restore)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..3543e33 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,11 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert only the rcParams that changed within the context,\n+        # and use rcParams.update to ensure proper validation and callbacks.\n+        changed = {k: orig[k] for k in orig if rcParams[k] != orig[k]}\n+        if changed:\n+            rcParams.update(changed)\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..87e66a1 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,24 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    changes = None\n     try:\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Track only the keys changed by applying rc/fname so that we don't\n+        # revert modifications made by operations inside the context (e.g.,\n+        # backend normalization during figure creation).\n+        changes = {k for k in rcParams if rcParams.get(k) != orig.get(k)}\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        if changes is None:\n+            # If applying settings failed before we could compute changes,\n+            # revert safely using validated update.\n+            rcParams.update(orig)\n+        else:\n+            rcParams.update({k: orig[k] for k in changes})\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..906f665 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,8 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Use rcParams.update to ensure proper validation and side-effects\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..9c2fe25 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,12 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Revert to the original rcParams, but avoid resetting the 'backend'.\n+        # Resetting 'backend' here can lead to a backend switch on a later\n+        # get_backend() call, which may close figures created within this\n+        # context. Runtime backend switches are unsupported and should not be\n+        # implicitly triggered by rc_context.\n+        dict.update(rcParams, {k: v for k, v in orig.items() if k != 'backend'})\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..51725b9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1087,6 +1087,12 @@ def rc_context(rc=None, fname=None):\n              plt.plot(x, y)  # uses 'print.rc'\n \n     \"\"\"\n+    # If neither rc nor fname is provided, this is a no-op context.\n+    # Avoid touching rcParams to prevent unintended side-effects.\n+    if rc is None and fname is None:\n+        yield\n+        return\n+\n     orig = rcParams.copy()\n     try:\n         if fname:\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "lib/matplotlib/pyplot.py": [
          "\nfunction: switch_backend\nline: 225"
        ],
        "lib/matplotlib/__init__.py": [
          "\nfunction: rc_context\nline: 1098"
        ]
      },
      "patches": [
        "diff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 9ba243c..2978d39 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -222,7 +222,10 @@ def switch_backend(newbackend):\n     global _backend_mod\n     # make sure the init is pulled up so we can assign to it later\n     import matplotlib.backends\n-    close(\"all\")\n+    # Only close figures if a backend is already initialized; initial backend setup\n+    # should not close existing figures.\n+    if _backend_mod is not None:\n+        close(\"all\")\n \n     if newbackend is rcsetup._auto_backend_sentinel:\n         current_framework = cbook._get_running_interactive_framework()\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..a7938b9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,6 +1095,18 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n+        # Preserve a resolved backend selection if the original backend was the\n+        # auto-sentinel. Reverting to 'auto' here would trigger a backend\n+        # switch (and close figures) on the next backend query.\n+        try:\n+            from . import rcsetup as _rcsetup\n+            _auto = _rcsetup._auto_backend_sentinel\n+        except Exception:\n+            _auto = None\n+        if _auto is not None and orig.get('backend') == _auto and rcParams.get('backend') != _auto:\n+            # Do not overwrite the currently selected backend.\n+            orig = orig.copy()\n+            orig.pop('backend', None)\n         dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..63b92b7 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,19 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    changed = set()\n     try:\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Only track keys changed by rc_file/rc compared to the original snapshot.\n+        changed = {k for k in rcParams if rcParams.get(k) != orig.get(k)}\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Only revert rcParams that were modified by this context.\n+        for k in changed:\n+            rcParams[k] = orig[k]\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..5bcd6a5 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,6 +1095,21 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n+        # Revert to the original rcParams, but avoid resetting 'backend' from a\n+        # resolved value back to the 'auto' sentinel. Doing so would trigger backend\n+        # resolution (and a backend switch that closes all figures) on next access,\n+        # e.g., when calling matplotlib.get_backend().\n+        try:\n+            from . import rcsetup as _rcsetup\n+            orig_backend = orig.get('backend')\n+            current_backend = dict.__getitem__(rcParams, 'backend')\n+            if (orig_backend is _rcsetup._auto_backend_sentinel\n+                    and current_backend is not _rcsetup._auto_backend_sentinel):\n+                # Keep the resolved backend; do not revert 'backend' to 'auto'.\n+                orig = {k: v for k, v in orig.items() if k != 'backend'}\n+        except Exception:\n+            # If anything goes wrong while checking, fall back to reverting everything.\n+            pass\n         dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..8bc30a4 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1087,15 +1087,26 @@ def rc_context(rc=None, fname=None):\n              plt.plot(x, y)  # uses 'print.rc'\n \n     \"\"\"\n+    # Capture original values only for keys we change within this context,\n+    # so we don't undo unrelated side effects (e.g., backend resolution).\n     orig = rcParams.copy()\n+    changed = set()\n     try:\n         if fname:\n+            before = rcParams.copy()\n             rc_file(fname)\n+            for k, v in rcParams.items():\n+                if before.get(k) != v:\n+                    changed.add(k)\n         if rc:\n+            for k, v in rc.items():\n+                if rcParams.get(k) != v:\n+                    changed.add(k)\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        for k in changed:\n+            rcParams[k] = orig[k]\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..4e12194 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,26 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    # Track whether this context explicitly set the backend (via rc or fname)\n+    backend_was_set_by_context = False\n     try:\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Determine if backend was set by this context\n+        if rc and 'backend' in rc:\n+            backend_was_set_by_context = True\n+        elif fname and rcParams.get('backend') != orig.get('backend'):\n+            backend_was_set_by_context = True\n         yield\n     finally:\n+        # Preserve any backend selection that occurred during the context\n+        # unless the context itself explicitly set the backend.\n+        new_backend = rcParams.get('backend')\n         dict.update(rcParams, orig)  # Revert to the original rcs.\n+        if not backend_was_set_by_context:\n+            rcParams['backend'] = new_backend\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0b36fae 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,24 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    managed_keys = set()\n     try:\n+        # Snapshot before applying any context-specific changes.\n+        before = rcParams.copy()\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Record which keys were modified by rc_file/rc (and only those).\n+        after = rcParams.copy()\n+        for k in after:\n+            if after[k] != before[k]:\n+                managed_keys.add(k)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        # Only revert the keys that this context manager explicitly changed.\n+        for k in managed_keys:\n+            rcParams[k] = orig[k]\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/pyplot.py b/lib/matplotlib/pyplot.py\nindex 9ba243c..8027e9a 100644\n--- a/lib/matplotlib/pyplot.py\n+++ b/lib/matplotlib/pyplot.py\n@@ -220,6 +220,18 @@ def switch_backend(newbackend):\n         The name of the backend to use.\n     \"\"\"\n     global _backend_mod\n+    # If resolving the auto backend and a backend is already active, avoid\n+    # tearing down existing figures by simply resolving to the current backend.\n+    if newbackend is rcsetup._auto_backend_sentinel and _backend_mod is not None:\n+        import matplotlib.backends\n+        resolved = matplotlib.backends.backend\n+        if resolved is not None:\n+            rcParams['backend'] = rcParamsDefault['backend'] = resolved\n+            try:\n+                rcParamsOrig['backend'] = resolved\n+            except NameError:\n+                pass\n+            return\n     # make sure the init is pulled up so we can assign to it later\n     import matplotlib.backends\n     close(\"all\")\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..8f087de 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1088,14 +1088,22 @@ def rc_context(rc=None, fname=None):\n \n     \"\"\"\n     orig = rcParams.copy()\n+    changed_keys = None\n     try:\n         if fname:\n             rc_file(fname)\n         if rc:\n             rcParams.update(rc)\n+        # Record only the keys changed by this context setup (rc/file).\n+        changed_keys = {k for k in rcParams if rcParams[k] != orig[k]}\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        if changed_keys is None:\n+            # If setup failed before we computed the diff, fall back to a full restore.\n+            rcParams.update(orig)\n+        elif changed_keys:\n+            # Only restore keys changed by this context; honor RcParams hooks.\n+            rcParams.update({k: orig[k] for k in changed_keys})\n \n \n def use(backend, *, force=True):\n",
        "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..acea999 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1087,14 +1087,43 @@ def rc_context(rc=None, fname=None):\n              plt.plot(x, y)  # uses 'print.rc'\n \n     \"\"\"\n+    # Save a copy of the original rcParams.\n     orig = rcParams.copy()\n+    # Track whether this context explicitly set the backend.\n+    backend_changed_by_user = False\n     try:\n+        # Record the original backend raw value (may be the auto sentinel).\n+        try:\n+            orig_backend_raw = dict.__getitem__(rcParams, \"backend\")\n+        except Exception:\n+            orig_backend_raw = rcParams.get(\"backend\")\n         if fname:\n+            # Detect if the file sets the backend by comparing before/after.\n+            pre_backend = orig_backend_raw\n             rc_file(fname)\n+            post_backend = dict.__getitem__(rcParams, \"backend\")\n+            if post_backend != pre_backend:\n+                backend_changed_by_user = True\n         if rc:\n+            if \"backend\" in rc:\n+                backend_changed_by_user = True\n             rcParams.update(rc)\n         yield\n     finally:\n+        # If the original backend was the auto sentinel and this rc_context\n+        # did not explicitly set the backend, keep the resolved backend\n+        # instead of restoring the auto sentinel. Restoring the auto sentinel\n+        # can later trigger a backend switch (and close figures) when queried.\n+        try:\n+            from . import rcsetup as _rcsetup  # local import to avoid cycle\n+            orig_backend_raw = dict.__getitem__(orig, \"backend\")\n+            if (orig_backend_raw is _rcsetup._auto_backend_sentinel\n+                    and not backend_changed_by_user):\n+                current_backend_raw = dict.__getitem__(rcParams, \"backend\")\n+                orig[\"backend\"] = current_backend_raw\n+        except Exception:\n+            # If anything goes wrong, fall back to the original behavior.\n+            pass\n         dict.update(rcParams, orig)  # Revert to the original rcs.\n \n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex afdb2d9..0ade4d9 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -1095,7 +1095,7 @@ def rc_context(rc=None, fname=None):\n             rcParams.update(rc)\n         yield\n     finally:\n-        dict.update(rcParams, orig)  # Revert to the original rcs.\n+        rcParams.update(orig)  # Revert to the original rcs.\n \n \n def use(backend, *, force=True):\n",
  "7_resolved": false
}