{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__4e7b7c81",
  "original_id": "django__django-15741",
  "1_model_selected_files": [
    "django/utils/formats.py"
  ],
  "2_embedding_selected_files": [
    "django/utils/datetime_safe.py",
    "django/utils/formats.py",
    "django/template/backends/utils.py",
    "django/utils/text.py",
    "django/utils/dates.py",
    "django/utils/dateformat.py",
    "django/utils/functional.py",
    "django/template/defaultfilters.py",
    "django/utils/dateparse.py",
    "django/template/backends/dummy.py",
    "django/utils/__init__.py",
    "django/utils/html.py",
    "django/utils/http.py",
    "django/utils/timezone.py",
    "django/template/backends/__init__.py",
    "django/utils/deprecation.py",
    "django/template/loaders/__init__.py",
    "django/template/base.py",
    "django/template/backends/jinja2.py",
    "django/utils/translation/template.py",
    "django/utils/numberformat.py",
    "django/template/autoreload.py",
    "django/utils/translation/__init__.py",
    "django/utils/duration.py",
    "django/utils/asyncio.py",
    "django/template/exceptions.py",
    "django/utils/itercompat.py",
    "django/template/response.py",
    "django/template/backends/django.py",
    "django/template/context_processors.py",
    "django/template/defaulttags.py",
    "django/utils/version.py",
    "django/template/loader_tags.py",
    "django/template/loader.py",
    "django/utils/safestring.py",
    "django/template/engine.py",
    "django/utils/log.py",
    "django/template/loaders/cached.py",
    "django/setup.py",
    "django/template/utils.py",
    "django/utils/inspect.py",
    "django/utils/decorators.py",
    "django/utils/translation/trans_real.py",
    "django/template/__init__.py",
    "django/shortcuts.py",
    "django/utils/hashable.py",
    "django/utils/autoreload.py",
    "django/template/library.py",
    "django/utils/ipv6.py",
    "django/utils/translation/trans_null.py",
    "django/utils/regex_helper.py",
    "django/template/backends/base.py",
    "django/utils/timesince.py",
    "django/template/loaders/base.py",
    "django/utils/encoding.py",
    "django/template/loaders/locmem.py",
    "django/utils/archive.py",
    "django/utils/baseconv.py",
    "django/__init__.py",
    "django/utils/termcolors.py",
    "django/utils/translation/reloader.py",
    "django/template/loaders/app_directories.py",
    "django/utils/_os.py",
    "django/utils/deconstruct.py",
    "django/utils/feedgenerator.py",
    "django/utils/jslex.py",
    "django/utils/datastructures.py",
    "django/template/smartif.py",
    "django/template/context.py",
    "django/template/loaders/filesystem.py",
    "django/utils/xmlutils.py",
    "django/utils/cache.py"
  ],
  "3_final_combined_files": [
    "django/utils/formats.py",
    "django/utils/datetime_safe.py",
    "django/template/backends/utils.py"
  ],
  "4_related_elements": {
    "django/utils/formats.py": [
      "function: get_format\nvariable: get_format_lazy\nfunction: date_format\nfunction: time_format\nfunction: number_format\nfunction: localize\nfunction: localize_input\nfunction: sanitize_strftime_format\nfunction: sanitize_separators\nfunction: iter_format_modules\nfunction: get_format_modules\nfunction: reset_format_cache\nvariable: FORMAT_SETTINGS\nvariable: _format_cache\nvariable: _format_modules_cache\nvariable: ISO_INPUT_FORMATS"
    ],
    "django/utils/datetime_safe.py": [
      "class: date\nclass: datetime\nfunction: strftime\nvariable: _illegal_formatting"
    ],
    "django/template/backends/utils.py": [
      "function: csrf_input\nvariable: csrf_input_lazy\nvariable: csrf_token_lazy"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/utils/formats.py": [
          "\nline: 10\nfunction: get_format\nline: 109"
        ]
      },
      "patches": [
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..3290387 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -7,7 +8,7 @@ from importlib import import_module\n \n from django.conf import settings\n from django.utils import dateformat, numberformat\n-from django.utils.functional import lazy\n+from django.utils.functional import lazy, Promise\n from django.utils.translation import check_for_language, get_language, to_locale\n \n # format_cache is a mapping from (format_type, lang) to the format string.\n@@ -113,6 +114,9 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Coerce lazy strings to real str to avoid getattr/type errors.\n+    if isinstance(format_type, Promise):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..da045e6 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -106,6 +107,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow lazy objects (e.g., gettext_lazy) to be passed for format_type by\n+    # coercing them to str to avoid TypeError in getattr() below.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..a0073ad 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -119,6 +120,14 @@ def get_format(format_type, lang=None, use_l10n=None):\n     except KeyError:\n         pass\n \n+    # If the format_type isn't one of the known format setting names,\n+    # treat it as a literal format value and return it as-is. This\n+    # allows passing lazy strings without triggering getattr with a\n+    # non-string attribute name.\n+    if format_type not in FORMAT_SETTINGS:\n+        _format_cache[cache_key] = format_type\n+        return format_type\n+\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n@@ -129,8 +138,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..cec538f 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -113,6 +114,12 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Allow lazy objects for format_type by forcing evaluation to str.\n+    # This avoids TypeError in getattr() and ensures a stable cache key.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..afd94ab 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -106,6 +107,12 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # If format_type is a literal format string (e.g. 'Y-m-d') rather than a\n+    # known setting name (e.g. 'DATE_FORMAT'), return it directly. This also\n+    # supports lazy strings passed from templates/translation utilities.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n@@ -125,12 +132,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n+            # format_type is guaranteed to be a real setting name here.\n             val = getattr(module, format_type, None)\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..105e804 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -113,6 +114,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Ensure format_type is a real string if it's a lazy object (e.g., _('Y-m-d')).\n+    # getattr() requires the attribute name to be a string.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..95d6804 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -113,6 +114,20 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Coerce lazy objects to str so that membership checks and getattr work.\n+    if not isinstance(format_type, str):\n+        try:\n+            format_type = str(format_type)\n+        except Exception:\n+            # If coercion fails, just return the original value unchanged.\n+            return format_type\n+\n+    # If format_type is not a known setting name, it's a literal format string.\n+    # Return it unchanged without touching localization modules.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -129,8 +144,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..2d88f74 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -113,6 +114,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Coerce lazy objects (e.g., from translation) to strings to avoid\n+    # TypeError when used as attribute names.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..990891c 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -113,6 +114,16 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Ensure lazy objects are coerced to real strings before using them\n+    # for attribute access or membership checks.\n+    if not isinstance(format_type, str):\n+        try:\n+            format_type = str(format_type)\n+        except Exception:\n+            # If coercion fails, leave as-is; subsequent logic will handle it.\n+            pass\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -120,10 +131,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n         pass\n \n     # The requested format_type has not been cached yet. Try to find it in any\n-    # of the format_modules for the given lang if l10n is enabled. If it's not\n-    # there or if l10n is disabled, fall back to the project settings.\n+    # of the format_modules for the given lang if l10n is enabled and the\n+    # format_type is a known setting. If it's not there or if l10n is disabled,\n+    # fall back to the project settings or return the provided format string.\n     val = None\n-    if use_l10n:\n+    if use_l10n and format_type in FORMAT_SETTINGS:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..1bb197f 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -8,6 +9,7 @@ from importlib import import_module\n from django.conf import settings\n from django.utils import dateformat, numberformat\n from django.utils.functional import lazy\n+from django.utils.encoding import force_str\n from django.utils.translation import check_for_language, get_language, to_locale\n \n # format_cache is a mapping from (format_type, lang) to the format string.\n@@ -113,6 +115,15 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Coerce lazy objects to strings to avoid TypeError in getattr() and cache keys.\n+    if not isinstance(format_type, str):\n+        format_type = force_str(format_type)\n+\n+    # If format_type isn't one of the known format setting names, return it as-is.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -129,8 +140,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/utils/formats.py": [
          "\nfunction: get_format\nline: 128\nline: 132\nline: 133\nline: 134"
        ]
      },
      "patches": [
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..c36e528 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,9 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Coerce potential lazy objects to str to avoid TypeError in getattr()\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..6460767 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Coerce lazy or non-str format_type to a real string to avoid TypeError\n+    # when used as an attribute name and to ensure consistent cache keys.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..f2a27f3 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Ensure format_type is a real string (handle lazy objects) before using it\n+    # as an attribute name and as part of the cache key.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..104b1ea 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,15 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Allow lazy strings: coerce to a real string before any lookups.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n+\n+    # If this isn't a known format setting, treat it as a raw format string.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -129,8 +138,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..631b9ee 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,7 +113,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n-    cache_key = (format_type, lang)\n+\n+    # Coerce lazy objects (e.g., from translation) to real strings for lookups.\n+    format_type_str = str(format_type)\n+\n+    cache_key = (format_type_str, lang)\n     try:\n         return _format_cache[cache_key]\n     except KeyError:\n@@ -125,18 +129,18 @@ def get_format(format_type, lang=None, use_l10n=None):\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n-            val = getattr(module, format_type, None)\n+            val = getattr(module, format_type_str, None)\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n-        val = getattr(settings, format_type)\n-    elif format_type in ISO_INPUT_FORMATS:\n+        if format_type_str not in FORMAT_SETTINGS:\n+            return format_type_str\n+        val = getattr(settings, format_type_str)\n+    elif format_type_str in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n         # retrieved, make sure the ISO_INPUT_FORMATS are in this list.\n         val = list(val)\n-        for iso_input in ISO_INPUT_FORMATS.get(format_type, ()):\n+        for iso_input in ISO_INPUT_FORMATS.get(format_type_str, ()):\n             if iso_input not in val:\n                 val.append(iso_input)\n     _format_cache[cache_key] = val\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..43ba7a8 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,12 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # If a non-setting format (e.g., a literal or lazy format string) is\n+    # passed in, return it directly. This avoids calling getattr() with a\n+    # non-string attribute name when format_type is lazy.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n@@ -129,8 +135,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..1e492af 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -122,15 +122,24 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n+    # Normalize lazy proxies to real strings before attribute lookup.\n+    try:\n+        from django.utils.encoding import force_str\n+    except ImportError:\n+        # Backwards compatibility for older Django versions.\n+        from django.utils.encoding import force_text as force_str\n+    if not isinstance(format_type, str):\n+        format_type = force_str(format_type)\n+\n     val = None\n-    if use_l10n:\n+    if use_l10n and format_type in FORMAT_SETTINGS:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n                 break\n     if val is None:\n         if format_type not in FORMAT_SETTINGS:\n-            return format_type\n+            return force_str(format_type)\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..1e71f7a 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -119,6 +119,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n     except KeyError:\n         pass\n \n+    # If the requested format_type isn't a predefined setting name,\n+    # assume it's a format string (possibly lazy) and return it unchanged.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..e4ccd1d 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,26 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Allow lazy/non-string parameters such as _('Y-m-d') by coercing to string\n+    # and short-circuiting if it's a literal format (not a known setting name).\n+    try:\n+        from django.utils.functional import Promise\n+        from django.utils.encoding import force_text\n+    except Exception:\n+        Promise = None\n+        force_text = None\n+    if Promise is not None and isinstance(format_type, Promise):\n+        format_type = force_text(format_type) if force_text is not None else str(format_type)\n+    elif force_text is not None and not isinstance(format_type, str):\n+        format_type = force_text(format_type)\n+    elif not isinstance(format_type, str):\n+        format_type = str(format_type)\n+\n+    # If it's not one of the predefined format setting names, return it directly.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -129,8 +149,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..afe7c15 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -119,6 +119,16 @@ def get_format(format_type, lang=None, use_l10n=None):\n     except KeyError:\n         pass\n \n+    # If format_type isn't a known setting name (e.g., it's a literal or a\n+    # lazy translation object), return it as-is to avoid passing a non-string\n+    # to getattr() below.\n+    try:\n+        is_setting = format_type in FORMAT_SETTINGS\n+    except TypeError:\n+        is_setting = False\n+    if not is_setting:\n+        return format_type\n+\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n@@ -129,8 +139,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/utils/formats.py": [
          "\nfunction: get_format"
        ]
      },
      "patches": [
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..c5e0616 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow lazily-translated format strings by coercing to a real string.\n+    # This avoids TypeError when using a lazy object as an attribute name.\n+    if format_type is not None and not isinstance(format_type, str):\n+        format_type = str(format_type)\n+\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..22243b1 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,9 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Ensure format_type is a real string (resolve lazy objects)\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..92730d9 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,15 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow lazy translation objects as format_type by forcing them to str\n+    # because getattr() requires a real string for attribute names.\n+    if not isinstance(format_type, str):\n+        try:\n+            from django.utils.functional import Promise\n+        except Exception:\n+            Promise = ()\n+        if isinstance(format_type, Promise):\n+            format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..5b9b308 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow lazy objects (e.g., from translations) by forcing to a real string\n+    # before using as an attribute name or dict key.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..14a9164 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Ensure format_type supports lazy strings (e.g., gettext_lazy)\n+    # by coercing to a real string before using it as an attribute name\n+    # or a cache key.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..b8c179c 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,16 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Coerce lazy strings (e.g., from ugettext_lazy) to real str for getattr().\n+    try:\n+        from django.utils.functional import Promise\n+        if isinstance(format_type, Promise):\n+            format_type = str(format_type)\n+    except Exception:\n+        # If importing Promise fails for any reason, proceed without coercion.\n+        pass\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..4307fa5 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -122,15 +122,19 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n+    # If the requested type isn't a known format setting name, return it as-is.\n+    # This allows passing lazy format strings (e.g. _('Y-m-d')) without errors.\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n+            # Only look up attributes for known setting names.\n             val = getattr(module, format_type, None)\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..f2588d8 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,9 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Accept lazy/non-str values by coercing to str to avoid getattr() TypeError\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..a8f157b 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Accept lazy (Promise) values for format_type (e.g., _('Y-m-d'))\n+    # by coercing them to a real string before attribute access/caching.\n+    from django.utils.functional import Promise\n+    if isinstance(format_type, Promise):\n+        format_type = str(format_type)\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..99931bd 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -123,7 +123,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n     val = None\n-    if use_l10n:\n+    # Only attempt to retrieve from format modules if requesting a known\n+    # format setting; this avoids calling getattr() with arbitrary (possibly\n+    # lazy) format strings like _('Y-m-d').\n+    if use_l10n and format_type in FORMAT_SETTINGS:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/utils/formats.py": [
          "\nfunction: get_format"
        ]
      },
      "patches": [
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..831e754 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -123,7 +123,7 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n     val = None\n-    if use_l10n:\n+    if use_l10n and format_type in FORMAT_SETTINGS:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..918282a 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,12 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow lazy (Promise) objects for format_type, e.g., _('Y-m-d')\n+    # to avoid TypeError when used with getattr().\n+    from django.utils.functional import Promise\n+    if isinstance(format_type, Promise):\n+        format_type = str(format_type)\n+\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..8d59c21 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -123,14 +123,17 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n     val = None\n+    # If format_type is not a known format setting, return it immediately.\n+    # This allows passing lazy strings (e.g., via gettext) without causing\n+    # TypeError in getattr() when l10n is enabled.\n+    if format_type not in FORMAT_SETTINGS:\n+        return str(format_type)\n     if use_l10n:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..6d7e39e 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,12 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Accept lazy objects (e.g. from gettext) for format_type by coercing to str\n+    try:\n+        format_type = str(format_type)\n+    except Exception:\n+        # If coercion fails for any reason, leave as-is and let subsequent logic handle it\n+        pass\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..777e832 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -122,6 +122,11 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n+    # If it's not a known format setting name, return it as-is\n+    # (e.g., a literal format string or a lazy translation).\n+    if format_type not in FORMAT_SETTINGS:\n+        return format_type\n+\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n@@ -129,8 +134,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..1597147 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -119,9 +119,14 @@ def get_format(format_type, lang=None, use_l10n=None):\n     except KeyError:\n         pass\n \n-    # The requested format_type has not been cached yet. Try to find it in any\n-    # of the format_modules for the given lang if l10n is enabled. If it's not\n-    # there or if l10n is disabled, fall back to the project settings.\n+    # The requested format_type has not been cached yet. If it isn't a known\n+    # format setting key (e.g. 'DATE_FORMAT'), just return it. This allows\n+    # passing literal or lazy strings such as _('Y-m-d') without errors.\n+    if format_type not in FORMAT_SETTINGS:\n+        return str(format_type)\n+    # Otherwise, try to find it in any of the format_modules for the given lang\n+    # if l10n is enabled. If it's not there or if l10n is disabled, fall back\n+    # to the project settings.\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n@@ -129,8 +134,6 @@ def get_format(format_type, lang=None, use_l10n=None):\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n         val = getattr(settings, format_type)\n     elif format_type in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..17730ff 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,30 +113,40 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n-    cache_key = (format_type, lang)\n+\n+    # Ensure lazy objects are coerced to strings for attribute lookups and caching.\n+    try:\n+        format_type_str = str(format_type)\n+    except Exception:\n+        format_type_str = format_type\n+\n+    cache_key = (format_type_str, lang)\n     try:\n         return _format_cache[cache_key]\n     except KeyError:\n         pass\n \n+    # If a concrete format string was provided (e.g. 'Y-m-d'), just return it.\n+    if format_type_str not in FORMAT_SETTINGS:\n+        _format_cache[cache_key] = format_type_str\n+        return format_type_str\n+\n     # The requested format_type has not been cached yet. Try to find it in any\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n     val = None\n     if use_l10n:\n         for module in get_format_modules(lang):\n-            val = getattr(module, format_type, None)\n+            val = getattr(module, format_type_str, None)\n             if val is not None:\n                 break\n     if val is None:\n-        if format_type not in FORMAT_SETTINGS:\n-            return format_type\n-        val = getattr(settings, format_type)\n-    elif format_type in ISO_INPUT_FORMATS:\n+        val = getattr(settings, format_type_str)\n+    elif format_type_str in ISO_INPUT_FORMATS:\n         # If a list of input formats from one of the format_modules was\n         # retrieved, make sure the ISO_INPUT_FORMATS are in this list.\n         val = list(val)\n-        for iso_input in ISO_INPUT_FORMATS.get(format_type, ()):\n+        for iso_input in ISO_INPUT_FORMATS.get(format_type_str, ()):\n             if iso_input not in val:\n                 val.append(iso_input)\n     _format_cache[cache_key] = val\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..7eb3551 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,16 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+\n+    # Ensure format_type is a real string (resolve lazy objects) before using it\n+    # for attribute access or caching.\n+    if not isinstance(format_type, str):\n+        try:\n+            format_type = str(format_type)\n+        except Exception:\n+            # If coercion fails for some unexpected type, fall back to returning it.\n+            return format_type\n+\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n@@ -123,7 +133,8 @@ def get_format(format_type, lang=None, use_l10n=None):\n     # of the format_modules for the given lang if l10n is enabled. If it's not\n     # there or if l10n is disabled, fall back to the project settings.\n     val = None\n-    if use_l10n:\n+    # Only consult format modules for known format setting names.\n+    if use_l10n and format_type in FORMAT_SETTINGS:\n         for module in get_format_modules(lang):\n             val = getattr(module, format_type, None)\n             if val is not None:\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..fbcc599 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -113,6 +113,10 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Allow lazy objects (e.g., from gettext) by forcing to a real string\n+    # before using as an attribute name or as part of the cache key.\n+    if not isinstance(format_type, str):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
        "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..51e95b0 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -106,6 +106,15 @@ def get_format(format_type, lang=None, use_l10n=None):\n     If use_l10n is provided and is not None, it forces the value to\n     be localized (or not), overriding the value of settings.USE_L10N.\n     \"\"\"\n+    # Allow a lazy translation object (e.g., _('Y-m-d')) to be passed in.\n+    # Coerce to a real string before using it as an attribute name.\n+    if not isinstance(format_type, str):\n+        try:\n+            format_type = str(format_type)\n+        except Exception:\n+            # If coercion fails for some reason, leave as-is and let later code handle it.\n+            pass\n+\n     if use_l10n is None:\n         try:\n             use_l10n = settings._USE_L10N_INTERNAL\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/utils/formats.py b/django/utils/formats.py\nindex 82173e8..3290387 100644\n--- a/django/utils/formats.py\n+++ b/django/utils/formats.py\n@@ -1,3 +1,4 @@\n+\n import datetime\n import decimal\n import functools\n@@ -7,7 +8,7 @@ from importlib import import_module\n \n from django.conf import settings\n from django.utils import dateformat, numberformat\n-from django.utils.functional import lazy\n+from django.utils.functional import lazy, Promise\n from django.utils.translation import check_for_language, get_language, to_locale\n \n # format_cache is a mapping from (format_type, lang) to the format string.\n@@ -113,6 +114,9 @@ def get_format(format_type, lang=None, use_l10n=None):\n             use_l10n = settings.USE_L10N\n     if use_l10n and lang is None:\n         lang = get_language()\n+    # Coerce lazy strings to real str to avoid getattr/type errors.\n+    if isinstance(format_type, Promise):\n+        format_type = str(format_type)\n     cache_key = (format_type, lang)\n     try:\n         return _format_cache[cache_key]\n",
  "7_resolved": true
}