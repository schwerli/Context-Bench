{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__80c9776a",
  "original_id": "django__django-11555",
  "1_model_selected_files": [
    "django/db/models/sql/query.py",
    "django/db/models/query.py",
    "django/db/models/expressions.py",
    "django/db/models/options.py",
    "django/db/models/sql/compiler.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/base.py",
    "django/db/models/__init__.py",
    "django/db/models/sql/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/backends/mysql/operations.py",
    "django/db/models/expressions.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/fields/proxy.py",
    "django/db/backends/oracle/operations.py",
    "django/db/models/sql/datastructures.py",
    "django/db/backends/mysql/schema.py",
    "django/db/models/query_utils.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/query.py",
    "django/db/models/fields/related.py",
    "django/db/migrations/questioner.py",
    "django/db/models/sql/where.py",
    "django/db/models/constraints.py",
    "django/db/backends/mysql/features.py",
    "django/db/migrations/operations/models.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/backends/base/features.py",
    "django/db/backends/base/operations.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/backends/mysql/__init__.py",
    "django/db/models/functions/window.py",
    "django/db/migrations/operations/__init__.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/backends/base/schema.py",
    "django/db/migrations/exceptions.py",
    "django/db/models/sql/constants.py",
    "django/db/models/options.py",
    "django/db/migrations/autodetector.py",
    "django/db/backends/sqlite3/__init__.py",
    "django/db/backends/base/__init__.py",
    "django/db/models/manager.py",
    "django/db/backends/__init__.py",
    "django/db/backends/oracle/schema.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/backends/oracle/features.py",
    "django/db/backends/oracle/__init__.py",
    "django/db/backends/postgresql/features.py",
    "django/db/models/functions/mixins.py",
    "django/db/backends/postgresql/__init__.py",
    "django/db/backends/oracle/base.py",
    "django/db/migrations/__init__.py",
    "django/db/models/fields/__init__.py",
    "django/db/models/aggregates.py",
    "django/db/backends/mysql/creation.py",
    "django/db/models/lookups.py",
    "django/db/backends/mysql/base.py",
    "django/db/backends/postgresql/base.py"
  ],
  "3_final_combined_files": [
    "django/db/models/sql/query.py",
    "django/db/models/query.py",
    "django/db/models/expressions.py",
    "django/db/models/base.py",
    "django/db/models/__init__.py"
  ],
  "4_related_elements": {
    "django/db/models/sql/query.py": [
      "function: get_order_dir\nfunction: Query.add_ordering\nfunction: Query.add_extra\nfunction: Query.join_parent_model\nfunction: Query.clear_ordering"
    ],
    "django/db/models/query.py": [
      "function: QuerySet.order_by\nfunction: QuerySet.extra\nfunction: QuerySet.reverse"
    ],
    "django/db/models/expressions.py": [
      "class: OrderBy\nclass: BaseExpression\nclass: F"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: get_order_dir"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..4690312 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,17 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string fields (e.g., OrderBy or other expressions).\n+    # Avoid string operations on expressions that don't support indexing.\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is True:\n+            return field, 'DESC'\n+        if descending is False:\n+            return field, 'ASC'\n+        # No explicit direction: use the default.\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..8d6680c 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,8 +2218,14 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If field is an expression (e.g., OrderBy) rather than a string, return it\n+    # as-is with the default direction.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field.startswith('-'):\n         return field[1:], dirn[1]\n+    if field.startswith('+'):\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..db79e15 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,22 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy or BaseExpression), return it\n+    unchanged with the default sort direction. Expressions encode their own\n+    ordering and shouldn't be parsed as strings.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n+    # Non-string orderings (e.g., expressions like OrderBy) should be returned\n+    # unchanged; they carry their own ordering semantics.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if not field:\n+        return field, dirn[0]\n     if field[0] == '-':\n         return field[1:], dirn[1]\n+    if field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..fe3479e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n+    Return the field/expression and direction for an order specification. For\n     example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+' prefix)\n+    should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy or expression), it's\n+    returned as-is with the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Expressions (e.g., OrderBy/F expressions) should be passed through.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..eb27409 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,11 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If field is not a string (e.g., an OrderBy or expression object),\n+    # return it unchanged with the default ordering direction.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..d64a966 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,13 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Accept non-string order expressions (e.g., OrderBy, F(), Func()).\n+    # In such cases, return the expression unchanged with the default\n+    # direction. Callers that handle expressions will apply direction\n+    # as appropriate.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..da32d86 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,17 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string order specifications (e.g., OrderBy expressions).\n+    if not isinstance(field, str):\n+        # Attempt to infer direction from OrderBy.descending if available,\n+        # otherwise use the default ascending direction.\n+        descending = getattr(field, 'descending', None)\n+        if descending is True:\n+            return field, dirn[1]\n+        if descending is False:\n+            return field, dirn[0]\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..b1606dc 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,27 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is a non-string expression (e.g., OrderBy, F, Func, etc.),\n+    honor its explicit direction when available, otherwise use the default.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # Handle string-based field names with optional '-' prefix.\n+    if isinstance(field, str):\n+        if field.startswith('-'):\n+            return field[1:], dirn[1]\n+        return field, dirn[0]\n+    # Non-string expressions (e.g., OrderBy, F, Func, etc.).\n+    # If the object explicitly specifies ordering direction, honor it.\n+    descending = getattr(field, 'descending', None)\n+    if descending is not None:\n+        return field, 'DESC' if descending else 'ASC'\n+    # Otherwise, use the default direction.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..3eaaa22 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,8 +2218,20 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string order specifications such as expressions (e.g., OrderBy).\n+    # In those cases, don't attempt string prefix parsing.\n+    if not isinstance(field, str):\n+        # If the object carries its own direction, honor it when available.\n+        descending = getattr(field, 'descending', None)\n+        if descending is True:\n+            return field, dirn[1]\n+        elif descending is False:\n+            return field, dirn[0]\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..eccad47 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,9 +2216,17 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., it's an Expression or OrderBy instance),\n+    return it unchanged along with the default direction. Expressions encode\n+    their own ordering, so callers should respect that and not attempt to\n+    parse a prefix.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Guard against non-string order specifications (e.g., expressions).\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: get_order_dir\nline: 2212"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..5e621ad 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,16 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string orderings (e.g., expressions/OrderBy objects).\n+    # If it's an OrderBy-like object, extract its expression and direction.\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        expression = getattr(field, 'expression', None)\n+        if descending is not None and expression is not None:\n+            return expression, 'DESC' if descending else 'ASC'\n+        # For other expression objects, leave as-is with default direction.\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..4038d3a 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,20 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy or Func), return it unchanged\n+    with the default direction, since expressions carry their own ordering.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string order expressions safely.\n+    try:\n+        prefix = field[0]\n+    except (TypeError, IndexError):\n+        return field, dirn[0]\n+    if prefix == '-':\n         return field[1:], dirn[1]\n+    if prefix == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..f0f798a 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,9 +2216,20 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy or expression), return it\n+    as-is with a sensible direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Handle non-string order specifications gracefully (e.g., OrderBy objects).\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is True:\n+            return field, dirn[1]\n+        if descending is False:\n+            return field, dirn[0]\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..eb28b08 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,8 +2218,14 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If \"field\" is an expression (e.g. OrderBy or other non-string), don't try\n+    # to parse prefix characters. Return it unchanged with the default direction.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..a949d2c 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,21 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy, F, Func), it won't support\n+    string indexing. In that case, return the expression unchanged along with\n+    the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    try:\n+        if field[0] == '-':\n+            return field[1:], dirn[1]\n+        if field[0] == '+':\n+            return field[1:], dirn[0]\n+    except (TypeError, IndexError):\n+        # Non-string \"field\" (such as an OrderBy/expression) or empty string\n+        # should be treated as-is with the default direction.\n+        pass\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..66f8609 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,20 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy, F, Func), return it as-is\n+    and use the default direction. OrderBy instances already encode their\n+    own direction, which will be respected later in compilation.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Handle non-string ordering expressions (e.g., OrderBy, F, Func, etc.).\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    # Handle explicit direction prefixes for string field names.\n+    if field.startswith('-'):\n         return field[1:], dirn[1]\n+    if field.startswith('+'):\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..59b4fa4 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,14 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+' prefix)\n+    should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy), honor its \"descending\"\n+    attribute and return the expression unchanged.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support expressions (e.g., OrderBy) that might be passed here.\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is not None:\n+            return field, dirn[1] if descending else dirn[0]\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..1f110b9 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,9 +2216,17 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy or other expression),\n+    it already encapsulates ordering and should be returned unchanged\n+    with the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Expressions (e.g., OrderBy/BaseExpression) are not strings and\n+    # shouldn't be parsed for a leading '-' sign.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..8d3eade 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,26 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n+    Return the field or expression and direction for an order specification. For\n     example, '-foo' is returned as ('foo', 'DESC').\n \n+    Expressions (e.g., OrderBy) are returned unchanged with the default\n+    direction.\n+\n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # If field is not a string (e.g., an expression or OrderBy), don't attempt\n+    # to parse prefixes; return it unchanged with the default direction.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field:\n+        first = field[0]\n+        if first == '-':\n+            return field[1:], dirn[1]\n+        if first == '+':\n+            return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..27009ba 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,16 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string order specifications (e.g., OrderBy/expressions).\n+    # If an OrderBy is given, unwrap its expression and derive direction\n+    # respecting the requested default (used by reverse()).\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is not None:\n+            return getattr(field, 'expression', field), dirn[1] if descending else dirn[0]\n+        # Plain expressions without explicit direction: use the default.\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: get_order_dir\nline: 2212\nline: 2213\nline: 2214\nline: 2215\nline: 2216\nline: 2217\nline: 2218\nline: 2219\nline: 2220\nline: 2221\nline: 2222\nline: 2223"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..4d7ea2d 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n+    Return the field/expression and direction for an order specification. For\n     example, '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is a non-string (e.g., an OrderBy expression), return it as-is\n+    with the default direction. Direction encoded in expressions is handled\n+    elsewhere in the query compilation.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # Only attempt prefix parsing for string-based field names.\n+    if isinstance(field, str):\n+        if field and field[0] == '-':\n+            return field[1:], dirn[1]\n+        return field, dirn[0]\n+    # Expressions are handled elsewhere; return as-is with default direction.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..8fda688 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n+    Return the field/expression and direction for an order specification. For\n     example, '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is a non-string expression (e.g., an OrderBy or other expression),\n+    it is returned unchanged with the default sort direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    if isinstance(field, str):\n+        if field.startswith('-'):\n+            return field[1:], dirn[1]\n+        if field.startswith('+'):\n+            return field[1:], dirn[0]\n+        return field, dirn[0]\n+    # Non-string order expressions (e.g., OrderBy) are returned unchanged.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..4b49fb4 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+' prefix)\n+    should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy/expression object), return\n+    it unchanged with the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If field is an expression (not a string), don't attempt to parse prefixes.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..a121335 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2217,8 +2217,22 @@ def get_order_dir(field, default='ASC'):\n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n+    # If field is an OrderBy/expression, don't try to parse it as a string.\n+    try:\n+        from django.db.models.expressions import OrderBy\n+    except Exception:\n+        OrderBy = None\n+\n+    if OrderBy is not None and isinstance(field, OrderBy):\n+        # Direction is encoded in the OrderBy instance.\n+        return field, ''\n+\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    if not isinstance(field, str):\n+        # Non-string order spec; return as-is with default direction.\n+        return field, dirn[0]\n+\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..62139dc 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,31 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification. For\n+    example, a string '-foo' is returned as ('foo', 'DESC'), and '+foo' or\n+    'foo' is returned with the default direction.\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If an expression (e.g., an OrderBy object) is provided, return the\n+    underlying expression and its inherent direction if available, otherwise\n+    use the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # Handle string-based order specifications.\n+    if isinstance(field, str):\n+        if field.startswith('-'):\n+            return field[1:], dirn[1]\n+        if field.startswith('+'):\n+            return field[1:], dirn[0]\n+        return field, dirn[0]\n+    # Handle expression-based order specifications (duck-typed OrderBy).\n+    descending = getattr(field, 'descending', None)\n+    if descending is not None:\n+        expr = getattr(field, 'expression', field)\n+        return expr, dirn[1] if descending else dirn[0]\n+    # Fallback for non-string, non-OrderBy-like objects: use default direction.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..14f053a 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,24 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field name (or expression) and direction for an order\n+    specification. For example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+' prefix)\n+    should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy expression), return it\n+    unchanged alongside the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Non-string ordering specifications (e.g., expressions) should be\n+    # passed through without attempting string slicing.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field.startswith('-'):\n         return field[1:], dirn[1]\n+    if field.startswith('+'):\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..e8fc713 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,22 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    Also supports non-string expressions (e.g., OrderBy instances). In that\n+    case, respect an explicit 'descending' attribute if present; otherwise\n+    default to the provided direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # Handle string field specifications.\n+    if isinstance(field, str):\n+        if field.startswith('-'):\n+            return field[1:], dirn[1]\n+        return field, dirn[0]\n+    # Handle expression/OrderBy objects.\n+    descending = getattr(field, 'descending', None)\n+    if descending is not None:\n+        return field, 'DESC' if descending else 'ASC'\n+    # Fallback: non-string without explicit direction -> default.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..18a71a6 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,27 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n-\n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    Return the field/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC'). If an expression\n+    (e.g., OrderBy or other non-string object) is provided, return it\n+    unchanged and determine direction from the expression when possible,\n+    otherwise use the default.\n+    The 'default' param indicates which way no prefix (or a '+' prefix)\n+    should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # Handle string-based field names, including optional '+'/'-' prefixes.\n+    if isinstance(field, str):\n+        if field[:1] == '-':\n+            return field[1:], dirn[1]\n+        if field[:1] == '+':\n+            return field[1:], dirn[0]\n+        return field, dirn[0]\n+    # Handle expression objects (e.g., OrderBy) which may carry their own\n+    # direction. Duck-type on the 'descending' attribute to detect OrderBy.\n+    if hasattr(field, 'descending'):\n+        return field, 'DESC' if getattr(field, 'descending') else 'ASC'\n+    # Fallback for other non-string expressions: keep as-is and use default.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..ac892a5 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,28 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n+    For strings, e.g. '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    For expression objects (e.g. OrderBy), return the object and its inherent\n+    direction if available, otherwise the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Handle non-string fields such as expressions/OrderBy objects.\n+    if not isinstance(field, str):\n+        # If the object encodes its sort direction, use it; otherwise default.\n+        descending = getattr(field, 'descending', None)\n+        if descending is not None:\n+            return field, 'DESC' if descending else 'ASC'\n+        return field, dirn[0]\n+    # Handle string specifications.\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..77f0f0e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,24 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    Also handle non-string order specifications (e.g., OrderBy/expressions)\n+    by returning the object as-is and an appropriate direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If the order specification is not a string (e.g., an OrderBy or expression),\n+    # avoid string operations. If it looks like an OrderBy, preserve its direction.\n+    if not isinstance(field, str):\n+        if hasattr(field, 'descending'):\n+            direction = 'DESC' if getattr(field, 'descending') else 'ASC'\n+            expr = getattr(field, 'expression', field)\n+            return expr, direction\n+        return field, dirn[0]\n+\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: get_order_dir"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..8139804 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,19 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression (e.g., OrderBy), return it unchanged and\n+    use the default direction. Parsing of prefixes only applies to strings.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If field is not a string (e.g., an expression or OrderBy), don't try to\n+    # inspect a prefix, just return it with the default direction.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..76ebc05 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,35 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification. For\n+    example, '-foo' is returned as ('foo', 'DESC'). Supports string field names\n+    and expression objects such as OrderBy instances.\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+\n+    # Handle string specifications.\n+    if isinstance(field, str):\n+        if field:\n+            if field[0] == '-':\n+                return field[1:], dirn[1]\n+            if field[0] == '+':\n+                return field[1:], dirn[0]\n+        return field, dirn[0]\n+\n+    # Handle OrderBy expressions gracefully.\n+    try:\n+        from django.db.models.expressions import OrderBy\n+    except Exception:\n+        OrderBy = None\n+\n+    if OrderBy is not None and isinstance(field, OrderBy):\n+        order = 'DESC' if getattr(field, 'descending', False) else 'ASC'\n+        return field, order\n+\n+    # For other expressions, return default ordering.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..6283fd9 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,10 +2216,23 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    Supports both string field names and expression objects (e.g., OrderBy).\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+\n+    # If the field is a string, parse any leading '-' to determine direction.\n+    if isinstance(field, str):\n+        if field.startswith('-'):\n+            return field[1:], dirn[1]\n+        return field, dirn[0]\n+\n+    # If the field is an OrderBy expression, respect its direction.\n+    # Avoid importing to prevent circular dependencies; detect via 'descending'.\n+    if hasattr(field, 'descending'):\n+        return field, 'DESC' if getattr(field, 'descending', False) else 'ASC'\n+\n+    # For other non-string expressions, use the default direction.\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..a819068 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,25 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n+    Return the field/expression and direction for an order specification. For\n     example, '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy or expression), it is returned\n+    as-is with the default direction. Expressions typically encode their own\n+    direction so the returned direction acts as a fallback.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n-        return field[1:], dirn[1]\n+    # If the field is an expression (e.g., OrderBy), don't attempt string slicing.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field:\n+        if field[0] == '-':\n+            return field[1:], dirn[1]\n+        if field[0] == '+':\n+            return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..fc01912 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,24 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    - For strings, '-foo' is returned as ('foo', 'DESC'), '+foo' or 'foo'\n+      as ('foo', default).\n+    - For expressions (e.g., OrderBy), return the expression itself and its\n+      intrinsic direction if available, otherwise the default.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Non-string ordering (e.g., OrderBy, expressions)\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is not None:\n+            return field, 'DESC' if descending else 'ASC'\n+        return field, dirn[0]\n+    if field.startswith('-'):\n         return field[1:], dirn[1]\n+    if field.startswith('+'):\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..7389886 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,28 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification. For\n+    example, '-foo' is returned as ('foo', 'DESC'). If an OrderBy/expression\n+    object is provided, it is returned along with its configured direction.\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+\n+    # Handle non-string order specifications (e.g., OrderBy or other expressions).\n+    # OrderBy has a 'descending' attribute indicating its direction.\n+    if not isinstance(field, str):\n+        if hasattr(field, 'descending'):\n+            return field, 'DESC' if getattr(field, 'descending', False) else 'ASC'\n+        # Unknown non-string expression: fall back to the default direction.\n+        return field, dirn[0]\n+\n+    # Handle string-based order specifications.\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..e1f76b4 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,14 +2211,23 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field name/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an expression object (e.g., OrderBy), return it unchanged\n+    with the appropriate direction, avoiding indexing errors.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Handle non-string order specifications (e.g., expressions, OrderBy).\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is not None:\n+            return field, dirn[1] if descending else dirn[0]\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..ec68e29 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,27 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+') should sort.\n+    The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is an OrderBy or expression object (i.e., not a string),\n+    respect its explicit direction if available and otherwise use the default.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # If field is not a string (e.g., OrderBy/expression), handle gracefully.\n+    if not isinstance(field, str):\n+        # Respect OrderBy.descending if present.\n+        if hasattr(field, 'descending'):\n+            return field, 'DESC' if getattr(field, 'descending') else 'ASC'\n+        return field, dirn[0]\n+    # Handle string prefixes.\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n+    if field and field[0] == '+':\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..e3d940f 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2216,9 +2216,20 @@ def get_order_dir(field, default='ASC'):\n \n     The 'default' param is used to indicate which way no prefix (or a '+'\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n+\n+    If \"field\" is not a string (e.g., an OrderBy or expression), don't try to\n+    parse a prefix. Instead, return the object as-is and derive the direction\n+    from its \"descending\" attribute if available, falling back to the default\n+    direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Allow expressions/OrderBy objects to pass through safely.\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is None:\n+            return field, dirn[0]\n+        return field, 'DESC' if descending else 'ASC'\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..206ba8e 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2211,15 +2211,24 @@ class Query(BaseExpression):\n \n def get_order_dir(field, default='ASC'):\n     \"\"\"\n-    Return the field name and direction for an order specification. For\n-    example, '-foo' is returned as ('foo', 'DESC').\n+    Return the field name/expression and direction for an order specification.\n+    For example, '-foo' is returned as ('foo', 'DESC').\n \n-    The 'default' param is used to indicate which way no prefix (or a '+'\n-    prefix) should sort. The '-' prefix always sorts the opposite way.\n+    The 'default' param indicates which way no prefix (or a '+' prefix) should\n+    sort. The '-' prefix always sorts the opposite way.\n+\n+    If 'field' is a query expression (e.g., an OrderBy or any object that is\n+    not a string), return it as-is along with the default direction.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Expressions or OrderBy objects are returned as-is; prefix parsing only\n+    # applies to string field names.\n+    if not isinstance(field, str):\n+        return field, dirn[0]\n+    if field.startswith('-'):\n         return field[1:], dirn[1]\n+    if field.startswith('+'):\n+        return field[1:], dirn[0]\n     return field, dirn[0]\n \n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 7177b41..4690312 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2218,7 +2218,17 @@ def get_order_dir(field, default='ASC'):\n     prefix) should sort. The '-' prefix always sorts the opposite way.\n     \"\"\"\n     dirn = ORDER_DIR[default]\n-    if field[0] == '-':\n+    # Support non-string fields (e.g., OrderBy or other expressions).\n+    # Avoid string operations on expressions that don't support indexing.\n+    if not isinstance(field, str):\n+        descending = getattr(field, 'descending', None)\n+        if descending is True:\n+            return field, 'DESC'\n+        if descending is False:\n+            return field, 'ASC'\n+        # No explicit direction: use the default.\n+        return field, dirn[0]\n+    if field and field[0] == '-':\n         return field[1:], dirn[1]\n     return field, dirn[0]\n \n",
  "7_resolved": false
}