{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__15e5aaa3",
  "original_id": "sympy__sympy-21930",
  "1_model_selected_files": [
    "sympy/physics/secondquant.py",
    "sympy/printing/latex.py"
  ],
  "2_embedding_selected_files": [
    "sympy/printing/latex.py",
    "sympy/physics/secondquant.py",
    "sympy/printing/mathml.py",
    "sympy/printing/printer.py",
    "sympy/printing/conventions.py",
    "sympy/printing/octave.py",
    "sympy/printing/preview.py",
    "sympy/printing/numpy.py",
    "sympy/printing/mathematica.py",
    "sympy/printing/__init__.py",
    "sympy/interactive/printing.py",
    "sympy/printing/julia.py",
    "sympy/abc.py",
    "sympy/printing/str.py",
    "sympy/printing/repr.py",
    "sympy/__init__.py",
    "sympy/printing/tensorflow.py",
    "sympy/printing/llvmjitcode.py",
    "sympy/physics/wigner.py",
    "sympy/physics/paulialgebra.py",
    "sympy/printing/maple.py",
    "sympy/this.py",
    "sympy/printing/pycode.py",
    "sympy/printing/lambdarepr.py",
    "sympy/printing/gtk.py",
    "sympy/printing/fortran.py",
    "sympy/printing/codeprinter.py",
    "sympy/printing/glsl.py",
    "sympy/interactive/ipythonprinting.py",
    "sympy/physics/matrices.py",
    "sympy/printing/jscode.py",
    "sympy/printing/defaults.py",
    "sympy/printing/rust.py",
    "sympy/printing/rcode.py"
  ],
  "3_final_combined_files": [
    "sympy/physics/secondquant.py",
    "sympy/printing/latex.py",
    "sympy/printing/mathml.py"
  ],
  "4_related_elements": {
    "sympy/physics/secondquant.py": [
      "function: CreateBoson._latex\nfunction: AnnihilateBoson._latex\nfunction: CreateFermion._latex\nfunction: AnnihilateFermion._latex\nfunction: Commutator._latex\nfunction: NO._latex"
    ],
    "sympy/printing/latex.py": [
      "variable: LatexPrinter._default_settings\nfunction: LatexPrinter.parenthesize_super\nfunction: LatexPrinter._pow_is_clean\nfunction: LatexPrinter._do_exponent\nfunction: LatexPrinter._print_Pow\nfunction: LatexPrinter._helper_print_standard_power"
    ],
    "sympy/printing/mathml.py": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "sympy/printing/latex.py": [
          "\nfunction: _print_Pow\nline: 638\nline: 639\nfunction: _helper_print_standard_power\nline: 668\nline: 669"
        ]
      },
      "patches": [
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..934f59e 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -633,9 +633,9 @@ class LatexPrinter(Printer):\n                 and expr.exp.q != 1:\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n-            # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n-                base = self.parenthesize_super(base)\n+            # issue #12886 and related: ensure bases with existing\n+            # superscripts/subscripts are grouped when raised to a power\n+            base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n@@ -665,9 +665,10 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n-            base = self.parenthesize_super(base)\n-        elif (isinstance(expr.base, Derivative)\n+        # Ensure that any base that already carries a superscript/subscript\n+        # is wrapped so that the outer power binds to the entire base.\n+        base = self.parenthesize_super(base)\n+        if (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n             and re.match(r'\\\\left\\(\\\\d?d?dot', base)\n             and base.endswith(r'\\right)')):\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..fab77a7 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -634,7 +634,8 @@ class LatexPrinter(Printer):\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n             # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n+            # Also handle non-Symbol bases that already contain superscripts (e.g. \\dagger)\n+            if expr.base.is_Symbol or '^' in base:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n@@ -665,9 +666,10 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n+        # Also handle non-Symbol bases that already contain superscripts (e.g. \\dagger)\n+        if expr.base.is_Symbol or '^' in base:\n             base = self.parenthesize_super(base)\n-        elif (isinstance(expr.base, Derivative)\n+        if (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n             and re.match(r'\\\\left\\(\\\\d?d?dot', base)\n             and base.endswith(r'\\right)')):\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..26fffd8 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -637,7 +637,13 @@ class LatexPrinter(Printer):\n             if expr.base.is_Symbol:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n-                return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n+                base_str = self._print(expr.base)\n+                exp_str = \"%s/%s\" % (p, q)\n+                # If the base already contains super/subscripts, wrap it in braces\n+                # before adding another superscript to avoid LaTeX misinterpretation.\n+                if ('^' in base_str) or ('_' in base_str):\n+                    return r\"{%s}^{%s}\" % (base_str, exp_str)\n+                return self._print(expr.base, exp=exp_str)\n             return r\"%s^{%s/%s}\" % (base, p, q)\n         elif expr.exp.is_Rational and expr.exp.is_negative and \\\n                 expr.base.is_commutative:\n@@ -655,7 +661,13 @@ class LatexPrinter(Printer):\n             return self._print_Mul(expr)\n         else:\n             if expr.base.is_Function:\n-                return self._print(expr.base, exp=self._print(expr.exp))\n+                base_str = self._print(expr.base)\n+                exp_str = self._print(expr.exp)\n+                # If the base already contains super/subscripts, wrap it in braces\n+                # before adding another superscript to avoid LaTeX misinterpretation.\n+                if ('^' in base_str) or ('_' in base_str):\n+                    return r\"{%s}^{%s}\" % (base_str, exp_str)\n+                return self._print(expr.base, exp=exp_str)\n             else:\n                 tex = r\"%s^{%s}\"\n                 return self._helper_print_standard_power(expr, tex)\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..34d70a2 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -637,6 +637,10 @@ class LatexPrinter(Printer):\n             if expr.base.is_Symbol:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n+                base_func = self._print(expr.base)\n+                if '^' in base_func:\n+                    base_func = self.parenthesize_super(base_func)\n+                    return r\"%s^{%s/%s}\" % (base_func, p, q)\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n         elif expr.exp.is_Rational and expr.exp.is_negative and \\\n@@ -655,7 +659,12 @@ class LatexPrinter(Printer):\n             return self._print_Mul(expr)\n         else:\n             if expr.base.is_Function:\n-                return self._print(expr.base, exp=self._print(expr.exp))\n+                base_func = self._print(expr.base)\n+                exp_func = self._print(expr.exp)\n+                if '^' in base_func:\n+                    base_func = self.parenthesize_super(base_func)\n+                    return r\"%s^{%s}\" % (base_func, exp_func)\n+                return self._print(expr.base, exp=exp_func)\n             else:\n                 tex = r\"%s^{%s}\"\n                 return self._helper_print_standard_power(expr, tex)\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..139f57e 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -637,6 +637,13 @@ class LatexPrinter(Printer):\n             if expr.base.is_Symbol:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n+                # If the function's LaTeX already contains a superscript (e.g. \\dagger),\n+                # group the whole base before applying an additional power to avoid\n+                # double-superscript rendering issues.\n+                fbase = self._print(expr.base)\n+                if '^' in fbase:\n+                    fbase = self.parenthesize_super(fbase)\n+                    return r\"%s^{%s/%s}\" % (fbase, p, q)\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n         elif expr.exp.is_Rational and expr.exp.is_negative and \\\n@@ -655,6 +662,14 @@ class LatexPrinter(Printer):\n             return self._print_Mul(expr)\n         else:\n             if expr.base.is_Function:\n+                # If the function's LaTeX already contains a superscript (e.g. \\dagger),\n+                # group the whole base before applying an additional power to avoid\n+                # double-superscript rendering issues.\n+                fbase = self._print(expr.base)\n+                if '^' in fbase:\n+                    fbase = self.parenthesize_super(fbase)\n+                    fexp = self._print(expr.exp)\n+                    return r\"%s^{%s}\" % (fbase, fexp)\n                 return self._print(expr.base, exp=self._print(expr.exp))\n             else:\n                 tex = r\"%s^{%s}\"\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..d79f8cc 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -634,7 +634,8 @@ class LatexPrinter(Printer):\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n             # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n+            # Also handle non-Symbol bases that already contain a superscript (e.g. b^\\dagger_{0})\n+            if expr.base.is_Symbol or '^' in base:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n@@ -665,7 +666,9 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n+        # issue #12886: add parentheses around superscripts raised to powers.\n+        # Also handle non-Symbol bases that already contain a superscript (e.g. b^\\dagger_{0})\n+        if expr.base.is_Symbol or '^' in base:\n             base = self.parenthesize_super(base)\n         elif (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..8ebfb8f 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -634,7 +634,8 @@ class LatexPrinter(Printer):\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n             # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n+            # Also parenthesize when the LaTeX base already contains a sub/superscript\n+            if expr.base.is_Symbol or ('^' in base) or ('_' in base):\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n@@ -665,14 +666,15 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n-            base = self.parenthesize_super(base)\n-        elif (isinstance(expr.base, Derivative)\n+        # don't use parentheses around dotted derivative\n+        if (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n             and re.match(r'\\\\left\\(\\\\d?d?dot', base)\n             and base.endswith(r'\\right)')):\n-            # don't use parentheses around dotted derivative\n             base = base[6: -7]  # remove outermost added parens\n+        elif expr.base.is_Symbol or ('^' in base) or ('_' in base):\n+            # Also parenthesize when the LaTeX base already contains a sub/superscript\n+            base = self.parenthesize_super(base)\n         return template % (base, exp)\n \n     def _print_UnevaluatedExpr(self, expr):\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..19a8c90 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -637,7 +637,14 @@ class LatexPrinter(Printer):\n             if expr.base.is_Symbol:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n-                return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n+                base_func = self._print(expr.base)\n+                # If the base's LaTeX already contains a superscript,\n+                # wrap it in braces before adding another exponent\n+                if '^' in base_func:\n+                    base_func = self.parenthesize_super(base_func)\n+                    return r\"%s^{%s/%s}\" % (base_func, p, q)\n+                else:\n+                    return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n         elif expr.exp.is_Rational and expr.exp.is_negative and \\\n                 expr.base.is_commutative:\n@@ -655,7 +662,15 @@ class LatexPrinter(Printer):\n             return self._print_Mul(expr)\n         else:\n             if expr.base.is_Function:\n-                return self._print(expr.base, exp=self._print(expr.exp))\n+                base_func = self._print(expr.base)\n+                exp_latex = self._print(expr.exp)\n+                # If the function's LaTeX already contains a superscript,\n+                # wrap it in braces to avoid double-superscript issues\n+                if '^' in base_func:\n+                    base_func = self.parenthesize_super(base_func)\n+                    return r\"%s^{%s}\" % (base_func, exp_latex)\n+                else:\n+                    return self._print(expr.base, exp=exp_latex)\n             else:\n                 tex = r\"%s^{%s}\"\n                 return self._helper_print_standard_power(expr, tex)\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..7d8055b 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -633,8 +633,8 @@ class LatexPrinter(Printer):\n                 and expr.exp.q != 1:\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n-            # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n+            # issue #12886 and similar: if base already contains a superscript, wrap it\n+            if '^' in base:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n@@ -665,7 +665,7 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n+        if '^' in base:\n             base = self.parenthesize_super(base)\n         elif (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..058e4e6 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -637,6 +637,12 @@ class LatexPrinter(Printer):\n             if expr.base.is_Symbol:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n+                # If the base already contains a superscript (e.g. b^\\dagger_{0}),\n+                # wrap the whole base in braces before applying another power to\n+                # avoid LaTeX double-superscript issues.\n+                base_tex = self._print(expr.base)\n+                if '^' in base_tex:\n+                    return r\"{%s}^{%s/%s}\" % (base_tex, p, q)\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n         elif expr.exp.is_Rational and expr.exp.is_negative and \\\n@@ -655,6 +661,12 @@ class LatexPrinter(Printer):\n             return self._print_Mul(expr)\n         else:\n             if expr.base.is_Function:\n+                # If the base already contains a superscript (e.g. b^\\dagger_{0}),\n+                # wrap it in braces before applying another power to avoid\n+                # double-superscript issues in LaTeX.\n+                base_tex = self._print(expr.base)\n+                if '^' in base_tex:\n+                    return r\"{%s}^{%s}\" % (base_tex, self._print(expr.exp))\n                 return self._print(expr.base, exp=self._print(expr.exp))\n             else:\n                 tex = r\"%s^{%s}\"\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "sympy/physics/secondquant.py": [
          "\nfunction: CreateBoson._latex\nline: 480\nline: 481\nline: 482\nfunction: CreateFermion._latex\nline: 941\nline: 942\nline: 943"
        ],
        "sympy/printing/latex.py": [
          "\nfunction: LatexPrinter._print_Pow\nline: 636\nline: 637\nline: 638\nline: 639\nline: 640\nline: 641\nfunction: LatexPrinter._helper_print_standard_power\nline: 668\nline: 669\nline: 670\nline: 671\nline: 672\nline: 673\nline: 674\nline: 675\nline: 676"
        ]
      },
      "patches": [
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..3bddc34 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -939,7 +939,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the base in braces so that external powers apply to the whole operator.\n+        # This prevents LaTeX from interpreting the second superscript incorrectly.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..77e2fd8 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when raised to a power,\n+        # e.g. {b^\\dagger_{0}}^{2} instead of b^\\dagger_{0}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when raised to a power,\n+        # e.g. {a^\\dagger_{0}}^{2} instead of a^\\dagger_{0}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..1dd5620 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct rendering when raising to another power,\n+        # e.g., {b^\\dagger_{0}}^{2} instead of b^\\dagger_{0}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct rendering when raising to another power,\n+        # e.g., {a^\\dagger_{0}}^{2} instead of a^\\dagger_{0}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..b1939cc 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that powers like (Bd(a))**2\n+        # render correctly as {b^\\dagger_{0}}^{2} in LaTeX/MathJax.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct rendering when raised to powers.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..832788f 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,8 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so that raising to a power (e.g., Bd(a)**2) groups the daggered operator correctly.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +940,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so that raising to a power groups the daggered operator correctly.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..6b25bbf 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that exponentiation renders correctly,\n+        # e.g., {b^\\dagger_{i}}^{2} instead of b^\\dagger_{i}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that exponentiation renders correctly,\n+        # e.g., {a^\\dagger_{i}}^{2} instead of a^\\dagger_{i}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..ae0beef 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,10 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that external exponents\n+        # (e.g., powers) bind to the whole symbol, avoiding constructions\n+        # like b^\\dagger_{0}^{2} which LaTeX parses incorrectly.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +942,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that external exponents\n+        # bind to the whole symbol, avoiding misinterpretation by LaTeX.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..0d53ba5 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -634,7 +634,8 @@ class LatexPrinter(Printer):\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n             # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n+            # Also wrap bases whose LaTeX contains a superscript (e.g. dagger operators)\n+            if expr.base.is_Symbol or '^' in base:\n                 base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n@@ -665,7 +666,9 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n+        # Wrap base if it is a Symbol or if its LaTeX already contains a superscript,\n+        # e.g. for daggered creation/annihilation operators.\n+        if expr.base.is_Symbol or '^' in base:\n             base = self.parenthesize_super(base)\n         elif (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..91a3cff 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the whole operator in braces so that further superscripts (e.g., powers)\n+        # are applied to the entire symbol rather than just the \\dagger.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the whole operator in braces so that further superscripts (e.g., powers)\n+        # are applied to the entire symbol rather than just the \\dagger.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "sympy/physics/secondquant.py": [
          "\nline: 481\nline: 942"
        ],
        "sympy/printing/latex.py": [
          "\nline: 638\nline: 639\nline: 668\nline: 669"
        ]
      },
      "patches": [
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..f3fddad 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,8 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so powers attach to the entire operator, not just the dagger\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +940,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so powers attach to the entire operator, not just the dagger\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..20d35b1 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when raising to a power,\n+        # e.g., {b^\\dagger_{i}}^{2} rather than b^\\dagger_{i}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when raising to a power\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..8acc4e3 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap with braces so that external superscripts (e.g., powers) apply to the whole operator\n+        # and do not conflict with the internal dagger superscript.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap with braces so that external superscripts (e.g., powers) apply to the whole operator\n+        # and do not conflict with the internal dagger superscript.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..1eb9856 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct rendering when raised to a further power\n+        # e.g. {b^\\dagger_{0}}^{2} instead of b^\\dagger_{0}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct rendering when raised to a further power\n+        # e.g. {a^\\dagger_{0}}^{2} instead of a^\\dagger_{0}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..992bf3c 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,10 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so raising this operator to a power yields\n+        # expressions like \"{b^\\dagger_{i}}^{2}\" rather than\n+        # \"b^\\dagger_{i}^{2}\", avoiding double-superscript issues.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +942,10 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so raising this operator to a power yields\n+        # expressions like \"{a^\\dagger_{i}}^{2}\" rather than\n+        # \"a^\\dagger_{i}^{2}\", avoiding double-superscript issues.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..3794b1d 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,10 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the daggered symbol in braces so powers are applied to the whole operator.\n+        # Without braces, expressions like Bd(a)**2 produce \"b^\\dagger_{0}^{2}\",\n+        # which renders incorrectly in LaTeX. Using \"{b^\\dagger_{0}}^{2}\" fixes this.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +942,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the daggered symbol in braces so powers are applied to the whole operator.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..562b7ff 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in curly braces so that powers like Bd(a)**2\n+        # render correctly as {b^\\dagger_{0}}^{2} in LaTeX.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in curly braces so that powers like Fd(p)**2\n+        # render correctly as {a^\\dagger_{p}}^{2} in LaTeX.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..7aa9725 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when this operator is raised to a power,\n+        # e.g., Bd(a)**2 should render as {b^\\dagger_{0}}^{2} rather than b^\\dagger_{0}^{2}.\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces to ensure correct LaTeX when this operator is raised to a power,\n+        # e.g., Fd(p)**2 should render as {a^\\dagger_{p}}^{2} rather than a^\\dagger_{p}^{2}.\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "sympy/printing/latex.py": [
          "\nfunction: LatexPrinter._print_Pow\nfunction: LatexPrinter._helper_print_standard_power"
        ],
        "sympy/physics/secondquant.py": [
          "\nline: 481\nline: 942"
        ]
      },
      "patches": [
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..1ec2fc2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,8 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap entire operator in braces so powers like Bd(a)**2 render as {b^\\dagger_{a}}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +940,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap entire operator in braces so powers like Fd(p)**2 render as {a^\\dagger_{p}}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..7296a43 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,8 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so powers like Bd(a)**2 render correctly as {b^\\dagger_{0}}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +940,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so powers like Fd(p)**2 render correctly as {a^\\dagger_{p}}^{2}\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..8b3e6d8 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so that powering this operator (e.g., Bd(a)**2)\n+        # results in correct LaTeX grouping: {b^\\dagger_{i}}^{2}\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,8 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap in braces so that powers are applied to the whole operator\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..86cf8f6 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,9 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that powers like Bd(a)**2\n+        # render correctly in LaTeX (e.g. {b^\\dagger_{0}}^{2}).\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +941,9 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        # Wrap the entire operator in braces so that powers like Fd(p)**2\n+        # render correctly in LaTeX (e.g. {a^\\dagger_{p}}^{2}).\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..e658af2 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^\\\\dagger_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^\\\\dagger_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n",
        "diff --git a/sympy/physics/secondquant.py b/sympy/physics/secondquant.py\nindex a68b85d..028df36 100644\n--- a/sympy/physics/secondquant.py\n+++ b/sympy/physics/secondquant.py\n@@ -478,7 +478,7 @@ class CreateBoson(BosonicOperator, Creator):\n         return \"CreateBoson(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"b^\\\\dagger_{%s}\" % self.state.name\n+        return \"{b^{\\\\dagger}_{%s}}\" % self.state.name\n \n B = AnnihilateBoson\n Bd = CreateBoson\n@@ -939,7 +939,7 @@ class CreateFermion(FermionicOperator, Creator):\n         return \"CreateFermion(%s)\" % self.state\n \n     def _latex(self, printer):\n-        return \"a^\\\\dagger_{%s}\" % self.state.name\n+        return \"{a^{\\\\dagger}_{%s}}\" % self.state.name\n \n Fd = CreateFermion\n F = AnnihilateFermion\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex 6e027b7..934f59e 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -633,9 +633,9 @@ class LatexPrinter(Printer):\n                 and expr.exp.q != 1:\n             base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n             p, q = expr.exp.p, expr.exp.q\n-            # issue #12886: add parentheses for superscripts raised to powers\n-            if expr.base.is_Symbol:\n-                base = self.parenthesize_super(base)\n+            # issue #12886 and related: ensure bases with existing\n+            # superscripts/subscripts are grouped when raised to a power\n+            base = self.parenthesize_super(base)\n             if expr.base.is_Function:\n                 return self._print(expr.base, exp=\"%s/%s\" % (p, q))\n             return r\"%s^{%s/%s}\" % (base, p, q)\n@@ -665,9 +665,10 @@ class LatexPrinter(Printer):\n         # issue #12886: add parentheses around superscripts raised\n         # to powers\n         base = self.parenthesize(expr.base, PRECEDENCE['Pow'])\n-        if expr.base.is_Symbol:\n-            base = self.parenthesize_super(base)\n-        elif (isinstance(expr.base, Derivative)\n+        # Ensure that any base that already carries a superscript/subscript\n+        # is wrapped so that the outer power binds to the entire base.\n+        base = self.parenthesize_super(base)\n+        if (isinstance(expr.base, Derivative)\n             and base.startswith(r'\\left(')\n             and re.match(r'\\\\left\\(\\\\d?d?dot', base)\n             and base.endswith(r'\\right)')):\n",
  "7_resolved": false
}