{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__afcc47be",
  "original_id": "django__django-16032",
  "1_model_selected_files": [
    "django/db/models/lookups.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/sql/query.py",
    "django/db/models/query.py",
    "django/db/models/expressions.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/query_utils.py",
    "django/db/models/query.py",
    "django/db/models/sql/query.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/expressions.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/sql/where.py",
    "django/db/models/__init__.py",
    "django/db/models/lookups.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/backends/oracle/features.py",
    "django/db/models/base.py",
    "django/db/models/fields/related.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/models/sql/__init__.py",
    "django/db/backends/mysql/schema.py",
    "django/db/backends/postgresql/features.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/models/sql/datastructures.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/backends/base/features.py",
    "django/db/backends/oracle/operations.py",
    "django/db/migrations/autodetector.py",
    "django/db/backends/base/schema.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/backends/mysql/operations.py",
    "django/db/migrations/operations/models.py",
    "django/db/models/aggregates.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/backends/mysql/introspection.py",
    "django/db/backends/mysql/features.py",
    "django/db/backends/sqlite3/features.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/models/manager.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/models/constraints.py",
    "django/db/models/fields/json.py",
    "django/db/backends/oracle/schema.py",
    "django/db/backends/ddl_references.py"
  ],
  "3_final_combined_files": [
    "django/db/models/sql/query.py",
    "django/db/models/lookups.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/query_utils.py",
    "django/db/models/query.py"
  ],
  "4_related_elements": {
    "django/db/models/sql/query.py": [
      "class: Query\nfunction: Query.clear_select_fields\nfunction: Query.clear_select_clause\nfunction: Query.add_annotation\nfunction: Query.set_annotation_mask\nfunction: Query.append_annotation_mask\nfunction: Query.set_values\nfunction: Query.annotation_select\nfunction: Query.extra_select"
    ],
    "django/db/models/lookups.py": [
      "class: Lookup\nclass: In\nfunction: In.process_rhs\nfunction: In.as_sql\nclass: FieldGetDbPrepValueIterableMixin\nfunction: FieldGetDbPrepValueIterableMixin.process_rhs\nfunction: FieldGetDbPrepValueIterableMixin.batch_process_rhs"
    ],
    "django/db/models/fields/related_lookups.py": [
      "class: RelatedIn\nfunction: RelatedIn.get_prep_lookup\nfunction: RelatedIn.as_sql\nclass: RelatedLookupMixin\nfunction: RelatedLookupMixin.get_prep_lookup\nfunction: RelatedLookupMixin.as_sql\nclass: MultiColSource\nfunction: get_normalized_value"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/lookups.py": [
          "\nfunction: In.get_prep_lookup\nline: 424"
        ],
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.get_prep_lookup\nline: 95"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..8c02e3d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,13 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS doesn't have an explicit select or is still selecting\n+            # default columns (e.g., after annotate()/alias()), ensure it\n+            # returns a single column by selecting the primary key.\n+            if (\n+                not self.rhs.has_select_fields\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..bcabf47 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif (not getattr(self.rhs, \"has_select_fields\", True) or getattr(self.rhs, \"annotation_select\", False)) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..1f3e93d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,9 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the inner query doesn't have an explicit select or has\n+            # pending annotations/aliases, ensure it only selects the PK.\n+            if (not self.rhs.has_select_fields) or getattr(self.rhs, \"annotation_select\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..222ef86 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                getattr(self.rhs, \"values_select\", None) is None\n+                or len(getattr(self.rhs, \"values_select\", None)) != 1\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..7532438 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure the RHS of an IN subquery selects exactly one column.\n+            # If values()/values_list() was used with a single field, keep it;\n+            # otherwise, clear the select clause and use the primary key.\n+            values_select = getattr(self.rhs, \"values_select\", None)\n+            if not values_select or len(values_select) != 1:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..bbd407c 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,22 +90,23 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n-                self.rhs.clear_select_clause()\n-                if (\n-                    getattr(self.lhs.output_field, \"primary_key\", False)\n-                    and self.lhs.output_field.model == self.rhs.model\n-                ):\n-                    # A case like\n-                    # Restaurant.objects.filter(place__in=restaurant_qs), where\n-                    # place is a OneToOneField and the primary key of\n-                    # Restaurant.\n-                    target_field = self.lhs.field.name\n-                else:\n-                    target_field = self.lhs.field.target_field.name\n-                self.rhs.add_fields([target_field], True)\n+            elif not getattr(self.lhs.field.target_field, \"primary_key\", False):\n+                selected = getattr(self.rhs, \"select\", None)\n+                selected_count = len(selected) if selected is not None else 0\n+                if (not getattr(self.rhs, \"has_select_fields\", True)) or selected_count != 1:\n+                    self.rhs.clear_select_clause()\n+                    if (\n+                        getattr(self.lhs.output_field, \"primary_key\", False)\n+                        and self.lhs.output_field.model == self.rhs.model\n+                    ):\n+                        # A case like\n+                        # Restaurant.objects.filter(place__in=restaurant_qs), where\n+                        # place is a OneToOneField and the primary key of\n+                        # Restaurant.\n+                        target_field = self.lhs.field.name\n+                    else:\n+                        target_field = self.lhs.field.target_field.name\n+                    self.rhs.add_fields([target_field], True)\n         return super().get_prep_lookup()\n \n     def as_sql(self, compiler, connection):\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..279bb50 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure the RHS subquery returns a single column. If it doesn't\n+            # have an explicit single selected field, default to the primary key.\n+            selected = getattr(self.rhs, \"select\", None)\n+            selected_count = len(selected) if selected is not None else 0\n+            if (not getattr(self.rhs, \"has_select_fields\", False)) or selected_count != 1:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..14301d6 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,14 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or (\n+                    not bool(getattr(self.rhs, \"select\", ()))\n+                    and bool(getattr(self.rhs, \"annotation_select\", {}))\n+                    and not bool(getattr(self.rhs, \"values_select\", ()))\n+                )\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..9fb4f97 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,16 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure subqueries used in IN() return a single column. If the\n+            # RHS has no explicit field selection (e.g., only annotations/aliases),\n+            # clear the select clause and use the primary key.\n+            rhs_has_explicit_select = bool(getattr(self.rhs, \"select\", ()))\n+            rhs_has_values_select = bool(getattr(self.rhs, \"values_select\", ()))\n+            rhs_has_annotation_select = bool(getattr(self.rhs, \"annotation_select\", {}))\n+            if (\n+                not getattr(self.rhs, \"has_select_fields\", False)\n+                or (not rhs_has_explicit_select and rhs_has_annotation_select and not rhs_has_values_select)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..e874ccc 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,8 +90,9 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n+            elif (\n+                (not getattr(self.rhs, \"has_select_fields\", True) or getattr(self.rhs, \"default_cols\", False))\n+                and not getattr(self.lhs.field.target_field, \"primary_key\", False)\n             ):\n                 self.rhs.clear_select_clause()\n                 if (\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..807f65d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            if (\n+                not self.rhs.has_select_fields\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..101e67c 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,14 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", False)\n+                or (\n+                    getattr(self.rhs, \"has_select_fields\", False)\n+                    and not getattr(self.rhs, \"values_select\", None)\n+                    and not getattr(self.rhs, \"select\", ())\n+                )\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..d12f4a9 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure RHS subquery selects a single column unless explicitly specified via values()/values_list().\n+            has_select_fields = getattr(self.rhs, \"has_select_fields\", False)\n+            values_select = getattr(self.rhs, \"values_select\", None)\n+            select_list = getattr(self.rhs, \"select\", ())\n+            if not has_select_fields or (has_select_fields and not values_select and not select_list):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..fc6a9ac 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..90f6fcc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,13 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS doesn't explicitly select values (e.g., it's selecting\n+            # default model columns due to annotate()/alias()), ensure it selects\n+            # a single column (the primary key) for the IN subquery.\n+            if (\n+                not getattr(self.rhs, \"has_select_fields\", False)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..03e11ea 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,22 +90,34 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n-                self.rhs.clear_select_clause()\n-                if (\n-                    getattr(self.lhs.output_field, \"primary_key\", False)\n-                    and self.lhs.output_field.model == self.rhs.model\n-                ):\n-                    # A case like\n-                    # Restaurant.objects.filter(place__in=restaurant_qs), where\n-                    # place is a OneToOneField and the primary key of\n-                    # Restaurant.\n-                    target_field = self.lhs.field.name\n-                else:\n-                    target_field = self.lhs.field.target_field.name\n-                self.rhs.add_fields([target_field], True)\n+            else:\n+                # For queryset RHS ensure the subquery selects exactly one column.\n+                # If it selects zero or multiple columns (e.g., due to annotations/aliases),\n+                # clear the selection and set the appropriate target field.\n+                from django.db.models.sql.query import Query  # avoid circular import\n+\n+                if isinstance(self.rhs, Query):\n+                    num_selected = len(getattr(self.rhs, \"select\", ())) + len(\n+                        getattr(self.rhs, \"annotation_select\", {})\n+                    )\n+                    if num_selected != 1 and not getattr(\n+                        self.lhs.field.target_field, \"primary_key\", False\n+                    ):\n+                        self.rhs.clear_select_clause()\n+                        if hasattr(self.rhs, \"annotation_select\"):\n+                            self.rhs.annotation_select = {}\n+                        if (\n+                            getattr(self.lhs.output_field, \"primary_key\", False)\n+                            and self.lhs.output_field.model == self.rhs.model\n+                        ):\n+                            # A case like\n+                            # Restaurant.objects.filter(place__in=restaurant_qs), where\n+                            # place is a OneToOneField and the primary key of\n+                            # Restaurant.\n+                            target_field = self.lhs.field.name\n+                        else:\n+                            target_field = self.lhs.field.target_field.name\n+                        self.rhs.add_fields([target_field], True)\n         return super().get_prep_lookup()\n \n     def as_sql(self, compiler, connection):\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..e4af1ad 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,8 +420,18 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure RHS subquery selects exactly one column for IN by\n+            # considering both explicit selects and annotation/alias selections.\n+            num_selected = len(getattr(self.rhs, \"select\", ())) + len(\n+                getattr(self.rhs, \"annotation_select\", {})\n+            )\n+            if num_selected != 1:\n+                # Clear both regular and annotation selects to avoid returning\n+                # multiple columns from the subquery.\n                 self.rhs.clear_select_clause()\n+                if hasattr(self.rhs, \"annotation_select\"):\n+                    self.rhs.annotation_select = {}\n+                # Default to using the primary key.\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n \n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..35cb944 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif (not getattr(self.rhs, \"has_select_fields\", True) or not getattr(self.rhs, \"select\", None)) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..38c4f74 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,9 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If no explicit select was provided (e.g., only annotations are present),\n+            # ensure the subquery selects a single column (the primary key).\n+            if not self.rhs.has_select_fields or not getattr(self.rhs, \"select\", None):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/lookups.py": [
          "\nfunction: In.get_prep_lookup"
        ],
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.get_prep_lookup"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..fc6a9ac 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..cea5ad2 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,12 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS query is selecting the model's default columns (e.g.,\n+            # due to annotate()/alias()) or has no explicit select fields,\n+            # reduce it to a single column (PK) for the IN subquery.\n+            if (not getattr(self.rhs, \"has_select_fields\", False)) or getattr(\n+                self.rhs, \"default_cols\", False\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..a482c49 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif getattr(self.rhs, \"default_cols\", False) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..3a8dc35 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,9 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS selects the model's default columns (e.g., due to\n+            # annotate() or alias()), reduce it to a single column suitable for IN.\n+            if getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..d6c32e7 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif (not getattr(self.rhs, \"has_select_fields\", True) or getattr(self.rhs, \"default_cols\", False)) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..787e196 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS query is still selecting the model's default columns\n+            # (default_cols) or has no explicit select clause, ensure the subquery\n+            # selects only the primary key to produce a single-column result.\n+            if (not self.rhs.has_select_fields) or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..fc6a9ac 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..de49aca 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,9 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS selects default model columns (e.g., after annotate/alias),\n+            # ensure we only select a single column suitable for IN subquery.\n+            if not self.rhs.has_select_fields or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..d6c32e7 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif (not getattr(self.rhs, \"has_select_fields\", True) or getattr(self.rhs, \"default_cols\", False)) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..4328995 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If RHS uses default column selection (no explicit values/values_list),\n+            # ensure the subquery only selects the primary key. This also covers\n+            # cases where alias() after annotate() might incorrectly mark the\n+            # query as having select fields.\n+            if not self.rhs.has_select_fields or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..3204516 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,22 +90,30 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n-                self.rhs.clear_select_clause()\n-                if (\n-                    getattr(self.lhs.output_field, \"primary_key\", False)\n-                    and self.lhs.output_field.model == self.rhs.model\n-                ):\n-                    # A case like\n-                    # Restaurant.objects.filter(place__in=restaurant_qs), where\n-                    # place is a OneToOneField and the primary key of\n-                    # Restaurant.\n-                    target_field = self.lhs.field.name\n+            elif not getattr(self.lhs.field.target_field, \"primary_key\", False):\n+                # Ensure RHS subquery projects exactly one column. If it doesn't,\n+                # force selecting the appropriate target field for the relation.\n+                has_select_fields = getattr(self.rhs, \"has_select_fields\", False)\n+                if has_select_fields:\n+                    select_count = len(getattr(self.rhs, \"select\", ()) or ()) + len(\n+                        getattr(self.rhs, \"annotation_select\", {}) or {}\n+                    )\n                 else:\n-                    target_field = self.lhs.field.target_field.name\n-                self.rhs.add_fields([target_field], True)\n+                    select_count = 0\n+                if not has_select_fields or select_count != 1:\n+                    self.rhs.clear_select_clause()\n+                    if (\n+                        getattr(self.lhs.output_field, \"primary_key\", False)\n+                        and self.lhs.output_field.model == self.rhs.model\n+                    ):\n+                        # A case like\n+                        # Restaurant.objects.filter(place__in=restaurant_qs), where\n+                        # place is a OneToOneField and the primary key of\n+                        # Restaurant.\n+                        target_field = self.lhs.field.name\n+                    else:\n+                        target_field = self.lhs.field.target_field.name\n+                    self.rhs.add_fields([target_field], True)\n         return super().get_prep_lookup()\n \n     def as_sql(self, compiler, connection):\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..f49e2de 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,16 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure the RHS subquery projects exactly one column. If it doesn't,\n+            # force selecting the primary key to avoid multi-column subselects.\n+            has_select_fields = getattr(self.rhs, \"has_select_fields\", False)\n+            if has_select_fields:\n+                select_count = len(getattr(self.rhs, \"select\", ()) or ()) + len(\n+                    getattr(self.rhs, \"annotation_select\", {}) or {}\n+                )\n+            else:\n+                select_count = 0\n+            if not has_select_fields or select_count != 1:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..a482c49 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif getattr(self.rhs, \"default_cols\", False) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..47da72d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS query is selecting the model's default columns (which can\n+            # happen after annotate()/alias()), reduce it to a single column (pk)\n+            # to satisfy the IN subquery requirement. Preserve explicit projections\n+            # such as values()/values_list(), which set default_cols to False.\n+            if (not self.rhs.has_select_fields) or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..47bcd7f 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif (not getattr(self.rhs, \"has_select_fields\", True) or bool(getattr(self.rhs, \"annotation_select\", {}))) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..233f7e4 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure RHS subquery selects a single column. Annotations/aliases\n+            # can implicitly add selected columns even when no explicit values()\n+            # selection is present, which breaks IN-subqueries.\n+            has_selected_annotations = bool(getattr(self.rhs, \"annotation_select\", {}))\n+            if not getattr(self.rhs, \"has_select_fields\", False) or has_selected_annotations:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..09539f1 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or not getattr(self.rhs, \"select\", ())\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..ac403cc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS doesn't have an explicit field selection (e.g., it only\n+            # has default columns or annotations/aliases), ensure it selects a\n+            # single primary key column for the IN subquery.\n+            if not self.rhs.has_select_fields or not getattr(self.rhs, \"select\", ()):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..718c7b7 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,8 +90,11 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n+            elif (\n+                hasattr(self.rhs, \"has_select_fields\")\n+                and not getattr(self.rhs, \"select\", ())\n+                and not getattr(self.rhs, \"annotation_select\", ())\n+                and not getattr(self.lhs.field.target_field, \"primary_key\", False)\n             ):\n                 self.rhs.clear_select_clause()\n                 if (\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..ddd1b85 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,12 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure the RHS subquery selects a single column. If no explicit\n+            # field or annotation selection was made (e.g., annotate()/alias()\n+            # without values()), force it to select the primary key.\n+            if not getattr(self.rhs, \"select\", ()) and not getattr(\n+                self.rhs, \"annotation_select\", ()\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: Query.has_select_fields\nline: 267\nline: 268\nline: 269\nline: 270"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..13de8fc 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -266,7 +266,7 @@ class Query(BaseExpression):\n     @property\n     def has_select_fields(self):\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select_mask\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..13de8fc 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -266,7 +266,7 @@ class Query(BaseExpression):\n     @property\n     def has_select_fields(self):\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select_mask\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..f38cf60 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,8 +265,12 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n+        # Consider both selected columns and annotated columns as part of the\n+        # SELECT clause. Using alias() after annotate() can modify the annotation\n+        # select mask, so rely on the underlying annotation_select to detect if\n+        # annotations are contributing to the SELECT list.\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select_mask\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..c3653e0 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,8 +265,12 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n+        # Only consider explicit select columns, annotations, or extras.\n+        # Masks (annotation_select_mask/extra_select_mask) indicate filtering\n+        # of already selected fields and shouldn't make the query appear to\n+        # have selected fields on their own.\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..4a7e38d 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,9 +265,10 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n-        return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n-        )\n+        # Only consider explicit 'select' fields when determining if the query\n+        # has a user-defined select clause. Annotations/aliases should not\n+        # prevent clearing the select clause for subqueries (e.g., RHS of __in).\n+        return bool(self.select)\n \n     @cached_property\n     def base_table(self):\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..da281ae 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,8 +265,13 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n+        # True if there are base select columns, or if annotations are selected.\n+        # When annotation_select_mask is None, it means all annotations are selected.\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select\n+            or (self.annotation_select and self.annotation_select_mask is None)\n+            or self.annotation_select_mask\n+            or self.extra_select_mask\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..b3eef89 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -266,7 +266,7 @@ class Query(BaseExpression):\n     @property\n     def has_select_fields(self):\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..c8ff342 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,8 +265,15 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n+        # Consider both explicit selects and annotations/extras. When\n+        # annotation_select_mask is None, all annotations are implicitly\n+        # selected, so treat any present annotations as selected fields.\n+        # The same applies to extra selects when extra_select_mask is None.\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select\n+            or self.annotation_select_mask\n+            or self.extra_select_mask\n+            or (self.annotation_select and self.annotation_select_mask is None)\n         )\n \n     @cached_property\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..3c854dd 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,9 +265,13 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n-        return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n-        )\n+        # Only treat an explicit column selection (e.g., .values()/extra())\n+        # as \"select fields\". Annotations and aliases shouldn't prevent\n+        # subqueries (e.g., RHS of __in) from being reduced to a single\n+        # column (the PK). Considering annotation_select_mask here can\n+        # incorrectly flag queries with aliases as having an explicit\n+        # selection, leading to multi-column subselects.\n+        return bool(self.select or self.extra_select_mask)\n \n     @cached_property\n     def base_table(self):\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..7daba7a 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -265,8 +265,14 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n+        # A query is considered to have explicit select fields if either\n+        # explicit column selection is present, or there are selected\n+        # annotations, or extra selects are masked in.\n+        # Use annotation_select (selected annotations) rather than the\n+        # annotation_select_mask, since alias() may populate masks for\n+        # internal aliases which should not be treated as selected fields.\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select_mask\n         )\n \n     @cached_property\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/lookups.py": [
          "\nfunction: In.get_prep_lookup"
        ],
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.get_prep_lookup"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..a482c49 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif getattr(self.rhs, \"default_cols\", False) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..49366c5 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS hasn't been restricted to a specific set of fields\n+            # (e.g., via values()/values_list()), ensure it selects only the\n+            # primary key to produce a single-column subquery.\n+            if getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..e874ccc 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,8 +90,9 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n+            elif (\n+                (not getattr(self.rhs, \"has_select_fields\", True) or getattr(self.rhs, \"default_cols\", False))\n+                and not getattr(self.lhs.field.target_field, \"primary_key\", False)\n             ):\n                 self.rhs.clear_select_clause()\n                 if (\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..ebd8e18 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If no explicit fields were selected or the query is selecting\n+            # the model's default columns (possibly with annotations/aliases),\n+            # ensure the subquery selects only the primary key.\n+            if (not getattr(self.rhs, \"has_select_fields\", False)) or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..fc6a9ac 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..f44d70f 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS hasn't explicitly selected fields or is using default\n+            # columns (e.g., due to annotate()/alias()), clear the select clause\n+            # so the subquery returns a single column.\n+            if not self.rhs.has_select_fields or getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..ac6c046 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,12 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif getattr(self.rhs, \"default_cols\", False) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n+                # If the RHS still selects default model columns (even with\n+                # annotations/aliases), reduce it to the single related field\n+                # to make the subquery valid for an IN lookup.\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..bf756d0 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS still selects the model's default columns (even if\n+            # annotations/aliases were added), collapse it to a single column\n+            # for use in an IN subquery.\n+            if getattr(self.rhs, \"default_cols\", False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..c222fca 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"annotations\", None)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..8553fab 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,13 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS is a subquery, ensure it returns a single column.\n+            # Clear any selected fields added via annotate()/alias() so that\n+            # we only select the primary key by default.\n+            if (\n+                not getattr(self.rhs, \"has_select_fields\", False)\n+                or getattr(self.rhs, \"annotations\", None)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..330a028 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,7 +90,7 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n+            elif not getattr(self.rhs, \"values_select\", None) and not getattr(\n                 self.lhs.field.target_field, \"primary_key\", False\n             ):\n                 self.rhs.clear_select_clause()\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..d6a456b 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,9 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If there is no explicit projection via values()/values_list(),\n+            # ensure the subquery selects a single column (the primary key).\n+            if not getattr(self.rhs, \"values_select\", None):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..f923cd2 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,8 +90,14 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n+            elif (\n+                # If the RHS query only has annotations/aliases and no explicit\n+                # selected fields, treat it as lacking select fields so we can\n+                # constrain it to the appropriate target column.\n+                (not getattr(self.rhs, \"has_select_fields\", True) or (\n+                    getattr(self.rhs, \"annotation_select\", None) and not getattr(self.rhs, \"select\", None)\n+                ))\n+                and not getattr(self.lhs.field.target_field, \"primary_key\", False)\n             ):\n                 self.rhs.clear_select_clause()\n                 if (\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..9f92f6f 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Treat queries that only have annotations/aliases (and no explicit\n+            # selected fields) as lacking select fields, so we can ensure the\n+            # subquery returns a single column for IN.\n+            annotations_only = bool(getattr(self.rhs, \"annotation_select\", None)) and not bool(getattr(self.rhs, \"select\", None))\n+            if not getattr(self.rhs, \"has_select_fields\", True) or annotations_only:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..e9abd75 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,22 +90,38 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n-                self.rhs.clear_select_clause()\n-                if (\n-                    getattr(self.lhs.output_field, \"primary_key\", False)\n-                    and self.lhs.output_field.model == self.rhs.model\n+            else:\n+                # Ensure the RHS subquery returns exactly one column. If it\n+                # currently selects default model columns or multiple fields/\n+                # annotations/aliases, coerce it to the appropriate target\n+                # field unless it's already the primary key.\n+                has_select = getattr(self.rhs, \"has_select_fields\", False)\n+                returns_single_col = False\n+                if has_select:\n+                    select_list = getattr(self.rhs, \"select\", None)\n+                    annotation_select = getattr(self.rhs, \"annotation_select\", None)\n+                    count = (len(select_list) if select_list is not None else 0) + (\n+                        len(annotation_select) if annotation_select is not None else 0\n+                    )\n+                    returns_single_col = count == 1\n+                if getattr(self.rhs, \"default_cols\", False):\n+                    returns_single_col = False\n+                if not returns_single_col and not getattr(\n+                    self.lhs.field.target_field, \"primary_key\", False\n                 ):\n-                    # A case like\n-                    # Restaurant.objects.filter(place__in=restaurant_qs), where\n-                    # place is a OneToOneField and the primary key of\n-                    # Restaurant.\n-                    target_field = self.lhs.field.name\n-                else:\n-                    target_field = self.lhs.field.target_field.name\n-                self.rhs.add_fields([target_field], True)\n+                    self.rhs.clear_select_clause()\n+                    if (\n+                        getattr(self.lhs.output_field, \"primary_key\", False)\n+                        and self.lhs.output_field.model == self.rhs.model\n+                    ):\n+                        # A case like\n+                        # Restaurant.objects.filter(place__in=restaurant_qs), where\n+                        # place is a OneToOneField and the primary key of\n+                        # Restaurant.\n+                        target_field = self.lhs.field.name\n+                    else:\n+                        target_field = self.lhs.field.target_field.name\n+                    self.rhs.add_fields([target_field], True)\n         return super().get_prep_lookup()\n \n     def as_sql(self, compiler, connection):\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..820d0c2 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,22 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # Ensure the RHS subquery returns exactly one column.\n+            # If it selects default model columns or multiple explicit\n+            # fields/annotations/aliases, coerce it to the PK.\n+            has_select = getattr(self.rhs, \"has_select_fields\", False)\n+            returns_single_col = False\n+            if has_select:\n+                select_list = getattr(self.rhs, \"select\", None)\n+                annotation_select = getattr(self.rhs, \"annotation_select\", None)\n+                count = (len(select_list) if select_list is not None else 0) + (\n+                    len(annotation_select) if annotation_select is not None else 0\n+                )\n+                returns_single_col = count == 1\n+            # Selecting default columns implies multiple columns.\n+            if getattr(self.rhs, \"default_cols\", False):\n+                returns_single_col = False\n+            if not returns_single_col:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..55f41b6 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS query hasn't explicitly selected values (e.g. via\n+            # values()/values_list()), or if it's still selecting the model's\n+            # default columns (which can happen after annotate()/alias()),\n+            # reduce it to a single-column subquery by selecting the primary key.\n+            if getattr(self.rhs, \"default_cols\", False) or not self.rhs.has_select_fields:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex c2102e8..fc6a9ac 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -90,9 +90,10 @@ class RelatedIn(In):\n                         -1\n                     ]\n                     self.rhs = [target_field.get_prep_value(v) for v in self.rhs]\n-            elif not getattr(self.rhs, \"has_select_fields\", True) and not getattr(\n-                self.lhs.field.target_field, \"primary_key\", False\n-            ):\n+            elif (\n+                not getattr(self.rhs, \"has_select_fields\", True)\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ) and not getattr(self.lhs.field.target_field, \"primary_key\", False):\n                 self.rhs.clear_select_clause()\n                 if (\n                     getattr(self.lhs.output_field, \"primary_key\", False)\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex a6d533b..636dde8 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -420,7 +420,13 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n \n         if isinstance(self.rhs, Query):\n             self.rhs.clear_ordering(clear_default=True)\n-            if not self.rhs.has_select_fields:\n+            # If the RHS doesn't have an explicit select (e.g. values()/values_list()),\n+            # or still selects default model columns (possibly with annotations/aliases),\n+            # reduce it to a single primary key column.\n+            if (\n+                not self.rhs.has_select_fields\n+                or getattr(self.rhs, \"default_cols\", False)\n+            ):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields([\"pk\"])\n         return super().get_prep_lookup()\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 250c6ee..13de8fc 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -266,7 +266,7 @@ class Query(BaseExpression):\n     @property\n     def has_select_fields(self):\n         return bool(\n-            self.select or self.annotation_select_mask or self.extra_select_mask\n+            self.select or self.annotation_select or self.extra_select_mask\n         )\n \n     @cached_property\n",
  "7_resolved": false
}