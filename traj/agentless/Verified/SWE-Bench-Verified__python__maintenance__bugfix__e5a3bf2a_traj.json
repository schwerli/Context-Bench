{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__e5a3bf2a",
  "original_id": "astropy__astropy-14539",
  "1_model_selected_files": [
    "astropy/io/fits/diff.py",
    "astropy/io/fits/fitsrec.py",
    "astropy/io/fits/column.py",
    "astropy/io/fits/hdu/table.py"
  ],
  "2_embedding_selected_files": [
    "astropy/io/fits/diff.py",
    "astropy/io/fits/hdu/hdulist.py",
    "astropy/utils/diff.py",
    "astropy/io/fits/__init__.py",
    "astropy/io/fits/hdu/table.py",
    "astropy/io/fits/hdu/__init__.py",
    "astropy/io/fits/util.py",
    "astropy/io/fits/file.py",
    "astropy/io/fits/connect.py",
    "astropy/io/fits/fitsrec.py",
    "astropy/io/fits/hdu/image.py",
    "astropy/io/fits/hdu/nonstandard.py",
    "astropy/io/fits/column.py",
    "astropy/io/fits/hdu/compressed.py",
    "astropy/io/fits/convenience.py",
    "astropy/io/fits/header.py",
    "astropy/utils/compat/numpycompat.py",
    "astropy/io/fits/hdu/base.py",
    "astropy/io/fits/hdu/groups.py",
    "astropy/utils/introspection.py",
    "astropy/utils/compat/__init__.py",
    "astropy/io/fits/fitstime.py",
    "astropy/io/fits/verify.py",
    "astropy/version.py",
    "astropy/io/fits/card.py",
    "astropy/conftest.py",
    "astropy/io/fits/hdu/streaming.py",
    "astropy/utils/__init__.py",
    "astropy/io/__init__.py",
    "astropy/utils/iers/__init__.py",
    "astropy/utils/iers/iers.py",
    "astropy/utils/compat/optional_deps.py",
    "astropy/utils/data.py",
    "astropy/utils/compat/misc.py"
  ],
  "3_final_combined_files": [
    "astropy/io/fits/diff.py",
    "astropy/io/fits/fitsrec.py",
    "astropy/io/fits/column.py",
    "astropy/io/fits/hdu/hdulist.py",
    "astropy/utils/diff.py"
  ],
  "4_related_elements": {
    "astropy/io/fits/diff.py": [
      "class: FITSDiff\nclass: HDUDiff\nclass: TableDataDiff"
    ],
    "astropy/io/fits/fitsrec.py": [
      "class: FITS_rec\nvariable: FITS_rec._load_variable_length_data\nclass: FITS_record\nfunction: _get_recarray_field"
    ],
    "astropy/io/fits/column.py": [
      "class: Column\nclass: Delayed\nclass: _VLF\nclass: _FormatP\nclass: _FormatQ\nfunction: _makep\nfunction: _convert_fits2record\nfunction: _parse_tformat"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "astropy/io/fits/diff.py": [
          "\nfunction: TableDataDiff._diff\nline: 1453\nline: 1454\nline: 1455\nline: 1456\nline: 1457\nline: 1458\nline: 1459\nline: 1460\nline: 1461"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..bc2af68 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1445,20 +1445,25 @@ class TableDataDiff(_BaseDiff):\n             arra = self.a[col.name]\n             arrb = self.b[col.name]\n \n-            if np.issubdtype(arra.dtype, np.floating) and np.issubdtype(\n+            # Handle variable-length array (VLA) columns first: both 'P' and 'Q'\n+            # denote VLA descriptors in FITS (32-bit and 64-bit respectively).\n+            if isinstance(col.format, str) and col.format[:1] in (\"P\", \"Q\"):\n+                row_diffs = []\n+                for idx in range(len(arra)):\n+                    va = arra[idx]\n+                    vb = arrb[idx]\n+                    try:\n+                        equal = np.allclose(va, vb, rtol=self.rtol, atol=self.atol)\n+                    except TypeError:\n+                        # For non-numeric VLAs (e.g., PA), fall back to exact comparison\n+                        equal = np.array_equal(va, vb)\n+                    if not equal:\n+                        row_diffs.append(idx)\n+                diffs = (row_diffs,)\n+            elif np.issubdtype(arra.dtype, np.floating) and np.issubdtype(\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n-                diffs = (\n-                    [\n-                        idx\n-                        for idx in range(len(arra))\n-                        if not np.allclose(\n-                            arra[idx], arrb[idx], rtol=self.rtol, atol=self.atol\n-                        )\n-                    ],\n-                )\n             else:\n                 diffs = np.where(arra != arrb)\n \n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..001d9f8 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(c in str(col.format).upper() for c in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..28f5e0c 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(v in col.format.upper() for v in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..10891d4 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,10 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(c in str(col.format) for c in (\"P\", \"Q\")):\n+                # Handle FITS variable-length array (VLA) columns, which use\n+                # 'P' (32-bit descriptors) or 'Q' (64-bit descriptors) in the\n+                # TFORM format. Compare each row element-wise using allclose.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..cbf23df 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,9 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(x in str(col.format).upper() for x in (\"P\", \"Q\")):\n+                # Variable-length array (VLA) columns use P or Q descriptors.\n+                # Compare row-wise using allclose on the variable-length elements.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..3fab283 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,13 +1449,16 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(vla_char in str(col.format).upper() for vla_char in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n                         for idx in range(len(arra))\n                         if not np.allclose(\n-                            arra[idx], arrb[idx], rtol=self.rtol, atol=self.atol\n+                            np.asarray(arra[idx]),\n+                            np.asarray(arrb[idx]),\n+                            rtol=self.rtol,\n+                            atol=self.atol,\n                         )\n                     ],\n                 )\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..80650fc 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,8 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n+                # Handle FITS variable-length arrays: both 32-bit ('P') and 64-bit ('Q') descriptors\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..686166c 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,12 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n+                # Handle FITS variable-length array (VLA) columns. In FITS TFORM\n+                # strings, both 'P' and 'Q' indicate VLAs (with 32-bit and\n+                # 64-bit descriptors respectively). Compare row-by-row using\n+                # allclose to avoid object identity comparisons on the nested\n+                # arrays.\n                 diffs = (\n                     [\n                         idx\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "astropy/io/fits/diff.py": [
          "\nfunction: TableDataDiff._diff\nline: 1452"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..94d993b 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,8 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif col.format and col.format[0] in (\"P\", \"Q\"):\n+                # Handle variable-length arrays (both 32-bit 'P' and 64-bit 'Q' descriptors)\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..93b774a 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,10 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n+                # Handle variable-length arrays (VLAs): both 32-bit ('P') and 64-bit ('Q')\n+                # descriptor formats. Compare row-by-row using allclose to avoid\n+                # object-identity comparisons that can falsely report differences.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..e83ce0f 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif col.format and col.format.upper()[0] in (\"P\", \"Q\"):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..a0df0f7 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,10 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif isinstance(col.format, str) and col.format[:1] in (\"P\", \"Q\"):\n+                # Handle FITS variable-length array (VLA) columns. In FITS TFORM,\n+                # 'P' uses 32-bit descriptors and 'Q' uses 64-bit descriptors.\n+                # Compare row-by-row using allclose on the per-row arrays.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..c6ad599 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(vla_code in str(col.format).upper() for vla_code in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..15a4510 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,9 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format.upper()) or (\"Q\" in col.format.upper()):\n+                # Handle FITS variable-length array columns ('P' for 32-bit, 'Q' for 64-bit)\n+                # Compare each row's array value using allclose rather than object identity\n                 diffs = (\n                     [\n                         idx\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "astropy/io/fits/diff.py": [
          "\nfunction: TableDataDiff._diff\nline: 1452\nline: 1453\nline: 1454\nline: 1455\nline: 1456\nline: 1457\nline: 1458\nline: 1459\nline: 1460\nline: 1461\nline: 1462"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..6a6359e 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,9 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif col.format and col.format[0] in (\"P\", \"Q\"):\n+                # Handle variable-length arrays (VLAs) correctly by comparing\n+                # each row's expanded array content with allclose semantics.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..585d077 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif \"P\" in col.format.upper() or \"Q\" in col.format.upper():\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..28f5e0c 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(v in col.format.upper() for v in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..4f45ed3 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,11 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n+                # Variable-length array (VLA) columns ('P' for 32-bit descriptors,\n+                # 'Q' for 64-bit descriptors) are stored as object arrays of per-row\n+                # numpy arrays. Compare row-by-row using allclose to avoid object\n+                # identity comparisons.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..c12582e 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(marker in col.format.upper() for marker in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..e6b03d2 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,9 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(code in str(col.format).upper() for code in (\"P\", \"Q\")):\n+                # Handle FITS variable-length arrays ('P' for 32-bit descriptors,\n+                # 'Q' for 64-bit descriptors) with per-element allclose checks.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..6984b43 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(v in str(col.format).upper() for v in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..4e40ba9 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1445,11 +1445,8 @@ class TableDataDiff(_BaseDiff):\n             arra = self.a[col.name]\n             arrb = self.b[col.name]\n \n-            if np.issubdtype(arra.dtype, np.floating) and np.issubdtype(\n-                arrb.dtype, np.floating\n-            ):\n-                diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            # Handle variable-length array (VLA) columns whose format uses 'P' or 'Q'\n+            if any(vla_code in col.format.upper() for vla_code in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n@@ -1459,6 +1456,10 @@ class TableDataDiff(_BaseDiff):\n                         )\n                     ],\n                 )\n+            elif np.issubdtype(arra.dtype, np.floating) and np.issubdtype(\n+                arrb.dtype, np.floating\n+            ):\n+                diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n             else:\n                 diffs = np.where(arra != arrb)\n \n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..8d29824 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(vla_code in col.format.upper() for vla_code in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "astropy/io/fits/diff.py": [
          "\nfunction: TableDataDiff._diff\nline: 1453\nline: 1454\nline: 1455\nline: 1456\nline: 1457\nline: 1458\nline: 1459\nline: 1460\nline: 1461"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..eff545b 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(c in col.format.upper() for c in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..16d156e 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,10 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif col.format and col.format.lstrip().upper().startswith((\"P\", \"Q\")):\n+                # Handle FITS variable-length array (VLA) columns. In FITS, VLA\n+                # descriptors can start with 'P' (32-bit) or 'Q' (64-bit).\n+                # Compare row-by-row to avoid object-identity comparisons.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..4e45fed 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,13 +1449,18 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(c in col.format.upper() for c in (\"P\", \"Q\")):\n+                # Variable-length array columns use 'P' (32-bit) or 'Q' (64-bit)\n+                # descriptors in the TFORMn; compare row-by-row with allclose.\n                 diffs = (\n                     [\n                         idx\n                         for idx in range(len(arra))\n                         if not np.allclose(\n-                            arra[idx], arrb[idx], rtol=self.rtol, atol=self.atol\n+                            np.asarray(arra[idx]),\n+                            np.asarray(arrb[idx]),\n+                            rtol=self.rtol,\n+                            atol=self.atol,\n                         )\n                     ],\n                 )\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..48f7136 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,8 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(v in str(col.format).upper() for v in (\"P\", \"Q\")):\n+                # Handle FITS variable-length array columns with 'P' (32-bit) or 'Q' (64-bit) descriptors\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..3e1937e 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,11 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n+                # Handle FITS variable-length array (VLA) columns. Both 'P' and\n+                # 'Q' TFORM descriptors denote VLAs (32-bit and 64-bit descriptors\n+                # respectively). Compare row-by-row with allclose to avoid\n+                # object-identity or descriptor-based inequality.\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
        "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..8d29824 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif any(vla_code in col.format.upper() for vla_code in (\"P\", \"Q\")):\n                 diffs = (\n                     [\n                         idx\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 0a08301..2c0e1fb 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,7 +1449,7 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n+            elif (\"P\" in col.format) or (\"Q\" in col.format):\n                 diffs = (\n                     [\n                         idx\n",
  "7_resolved": true
}