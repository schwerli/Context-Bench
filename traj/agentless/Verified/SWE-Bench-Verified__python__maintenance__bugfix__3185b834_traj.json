{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__3185b834",
  "original_id": "astropy__astropy-14598",
  "1_model_selected_files": [
    "astropy/io/fits/card.py",
    "astropy/io/fits/header.py",
    "astropy/io/fits/util.py"
  ],
  "2_embedding_selected_files": [
    "astropy/io/fits/card.py",
    "astropy/io/fits/diff.py",
    "astropy/io/fits/__init__.py",
    "astropy/io/fits/fitstime.py",
    "astropy/io/fits/column.py",
    "astropy/io/fits/util.py",
    "astropy/io/fits/header.py",
    "astropy/io/fits/file.py",
    "astropy/io/fits/fitsrec.py",
    "astropy/io/fits/connect.py",
    "astropy/conftest.py",
    "astropy/io/fits/verify.py",
    "astropy/io/fits/convenience.py",
    "astropy/__init__.py",
    "astropy/version.py",
    "astropy/io/__init__.py",
    "astropy/setup.py",
    "astropy/logger.py"
  ],
  "3_final_combined_files": [
    "astropy/io/fits/card.py",
    "astropy/io/fits/header.py",
    "astropy/io/fits/util.py",
    "astropy/io/fits/diff.py",
    "astropy/io/fits/__init__.py"
  ],
  "4_related_elements": {
    "astropy/io/fits/card.py": [
      "class: Card\nvariable: _strg\nvariable: _value_FSC_RE\nvariable: _value_NFSC_RE\nfunction: Card.__str__\nfunction: Card.fromstring\nfunction: Card._parse_value\nfunction: Card._format_value\nfunction: Card._format_image\nfunction: Card._format_long_image\nfunction: Card._split\nfunction: Card._fix_value\nfunction: Card.value\nfunction: Card.rawvalue\nvariable: CARD_LENGTH\nfunction: _format_value\nfunction: _pad"
    ],
    "astropy/io/fits/header.py": [
      ""
    ],
    "astropy/io/fits/util.py": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "astropy/io/fits/card.py": [
          "\nline: 67"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..fe05aeb 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,8 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a quoted string where internal single quotes are escaped by doubling.\n+    _strg = r\"'(?P<strg>(?:[^']|'')*)'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..b14f8a8 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow any printable characters except a single quote, or a doubled single-quote inside the string.\n+    # This avoids prematurely treating the first of a doubled single-quote as the closing quote.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..a650f56 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,7 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..c9492ae 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS string: content may include any printable ASCII except a single quote,\n+    # where a literal single quote inside the string is represented by two consecutive quotes ('').\n+    # This ensures internal quotes are not mistaken for the closing delimiter.\n+    _strg = r\"\\'(?P<strg>(?:[ !-&(-~]|\\'\\')*)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..ca9491e 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,11 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow any printable ASCII except a single quote, and allow doubled single\n+    # quotes inside the string (FITS escapes a single quote as two quotes).\n+    # This prevents interpreting internal '' as the closing quote and fixes\n+    # cases where a trailing '' was being collapsed to a single ' during parsing.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..67b5d35 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,11 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS quoted string allowing doubled single-quotes inside the value.\n+    # The content may contain any printable ASCII except a single quote, or\n+    # a doubled single-quote to represent a literal quote character.\n+    # Trailing spaces inside the quotes are preserved.\n+    _strg = r\"\\'(?P<strg>(?:[ -&\\(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..085d047 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # This pattern correctly handles embedded single quotes represented as ''\n+    # per the FITS standard, and only treats an unmatched single quote as the\n+    # string terminator.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..bf3f31c 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,13 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS string value that:\n+    # - starts and ends with a single quote\n+    # - allows any printable ASCII except a single quote\n+    # - allows embedded single quotes represented as two consecutive single quotes ('')\n+    # This ensures that doubled quotes inside the value are preserved and not\n+    # mistaken for the closing quote, fixing cases where '' was reduced to '.\n+    _strg = r\"\\'(?P<strg>(?:(?:[ -&(-~])|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..326e7a9 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS-quoted string where internal single quotes are doubled.\n+    # Content is any printable ASCII except a single unmatched quote, or a pair of quotes ''.\n+    _strg = r\"'(?P<strg>(?:[ -&(-~]|'')*)'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..c1452d2 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Ensure that single quotes inside the string are only matched as pairs ('')\n+    # so that the closing quote is not accidentally consumed from a doubled quote.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "astropy/io/fits/card.py": [
          "\nfunction: Card._split\nline: 862"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..81a2a1c 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -871,7 +871,10 @@ class Card(_Verify):\n                 valuecomment = \"\".join(values)\n             else:\n                 # CONTINUE card\n-                valuecomment = f\"'{''.join(values)}' / {' '.join(comments)}\"\n+                # Re-escape internal quotes for FITS string representation\n+                joined = \"\".join(values)\n+                joined = joined.replace(\"'\", \"''\")\n+                valuecomment = f\"'{joined}' / {' '.join(comments)}\"\n             return keyword, valuecomment\n \n         if self.keyword in self._special_keywords:\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..2ee9273 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,10 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Do not collapse doubled single-quotes here; decoding of FITS string quoting\n+                # is handled later in the parsing pipeline. Collapsing at this stage can\n+                # incorrectly reduce '' to ' for certain long/continued strings.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..cdec960 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -871,7 +871,10 @@ class Card(_Verify):\n                 valuecomment = \"\".join(values)\n             else:\n                 # CONTINUE card\n-                valuecomment = f\"'{''.join(values)}' / {' '.join(comments)}\"\n+                # Join the values and re-escape any single quotes for FITS string representation\n+                full_value = ''.join(values)\n+                escaped_value = full_value.replace(\"'\", \"''\")\n+                valuecomment = f\"'{escaped_value}' / {' '.join(comments)}\"\n             return keyword, valuecomment\n \n         if self.keyword in self._special_keywords:\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..e0d1dd8 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,8 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Preserve FITS escaping in sub-card segments; only trim spaces and '&'\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n@@ -871,7 +872,9 @@ class Card(_Verify):\n                 valuecomment = \"\".join(values)\n             else:\n                 # CONTINUE card\n-                valuecomment = f\"'{''.join(values)}' / {' '.join(comments)}\"\n+                # Re-escape any single quotes in the joined value to valid FITS format\n+                joined = ''.join(values).replace(\"'\", \"''\")\n+                valuecomment = f\"'{joined}' / {' '.join(comments)}\"\n             return keyword, valuecomment\n \n         if self.keyword in self._special_keywords:\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..8a9a30e 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,9 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Keep doubled single-quotes intact here; they are part of the FITS\n+                # string escaping and will be handled by the general parsing logic later.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..53929e2 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,9 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Preserve doubled single quotes here; they represent escaped quotes in FITS strings.\n+                # Let the normal parsing handle escaping after recombining CONTINUE cards.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..ad1d118 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,7 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n@@ -871,7 +871,10 @@ class Card(_Verify):\n                 valuecomment = \"\".join(values)\n             else:\n                 # CONTINUE card\n-                valuecomment = f\"'{''.join(values)}' / {' '.join(comments)}\"\n+                joined_values = ''.join(values)\n+                # Undouble embedded quotes across the full continued string\n+                joined_values = joined_values.replace(\"''\", \"'\")\n+                valuecomment = f\"'{joined_values}' / {' '.join(comments)}\"\n             return keyword, valuecomment\n \n         if self.keyword in self._special_keywords:\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..cd9c894 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,8 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Preserve FITS-escaped quotes here; unescaping is handled later\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..d85e144 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,10 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Preserve FITS escaping (double single-quotes) across subcards.\n+                # Unescaping here can split pairs across boundaries and corrupt the result.\n+                # The full recombined value will be parsed later to handle escaping correctly.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..25c89ac 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,10 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Do not un-escape doubled quotes per-segment; defer to the final\n+                # parsing step after joining all segments to avoid double-decoding\n+                # when adjacent decoded quotes span segment boundaries.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "astropy/io/fits/card.py": [
          "\nline: 67"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..b161308 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS quoted string where internal quotes must be doubled.\n+    # The content allows any printable ASCII except a single quote,\n+    # and permits internal pairs of quotes ('') which represent a literal quote.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..61709c3 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a quoted FITS string where internal quotes are represented by two single quotes.\n+    # This ensures that embedded single quotes are only matched as part of a pair and not\n+    # mistaken for the closing delimiter, preventing loss of quotes in round-trips.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..2a87453 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # The string content may contain escaped single quotes represented by two consecutive\n+    # single quotes (''). Ensure we do not prematurely terminate the string on the first\n+    # of a doubled quote by only allowing non-quote characters or escaped quotes inside.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..5ba7fa2 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,11 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # The string content must treat doubled single-quotes ('') as a literal\n+    # single quote within the value and avoid matching an isolated single-quote\n+    # as part of the content. This ensures that escaped quotes are preserved\n+    # even near card length boundaries when using the CONTINUE convention.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..fc74878 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match a FITS quoted string, correctly handling escaped single-quotes ('').\n+    # The content may contain any printable ASCII character or pairs of quotes ('').\n+    # The closing quote is the first single-quote not part of an escaped pair.\n+    _strg = r\"\\'(?P<strg>(?:[ -~]|(?:\\'\\'))*)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..29c224d 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,12 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # String value inside single quotes: allow any printable ASCII except\n+    # unpaired single quotes, and treat embedded quotes as doubled ('').\n+    # Using a negative lookahead ensures that a single quote is only matched\n+    # as part of a pair, preventing accidental consumption of one quote from\n+    # a trailing '' as the closing delimiter.\n+    _strg = r\"\\'(?P<strg>(?:(?!')(?:[ -~])|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..e24fe7b 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # String content allows printable ASCII except a single quote, unless the quote\n+    # is represented as a doubled quote (''). This ensures sequences like '''\n+    # are parsed correctly as '' (content) + ' (closing delimiter).\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..e498a3e 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Inside the quoted string, allow any printable ASCII except a single\n+    # quote, and treat a pair of single quotes ('') as an escaped quote.\n+    # This avoids prematurely closing on the first quote of a doubled quote.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..58c7799 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Ensure that single quotes inside the string are only matched as escaped pairs (''),\n+    # preventing a closing quote from being misinterpreted when content contains '' near field limits.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\'){0,} *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "astropy/io/fits/card.py": [
          "\nline: 67"
        ]
      },
      "patches": [
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..56caf44 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -63,8 +63,14 @@ class Card(_Verify):\n     _number_NFSC_RE = re.compile(rf\"(?P<sign>[+-])? *0*?(?P<digt>{_digits_NFSC})\")\n \n     # Used in cards using the CONTINUE convention which expect a string\n-    # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # followed by an optional comment.\n+    # The inner content must be any printable ASCII character except a single\n+    # quote, or a pair of single quotes to represent an escaped quote in FITS.\n+    # Using (?:[^']|\\'\\')* would allow non-ASCII; here we restrict to printable\n+    # ASCII while excluding a lone quote: [ -&(-~] excludes ' (0x27).\n+    # This prevents interpreting one of a doubled-quote pair as the closing\n+    # delimiter when the value ends with an escaped quote.\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..7c70261 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,11 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # The content can include any printable character except a single quote,\n+    # and single quotes must be represented as doubled quotes ('').\n+    # This avoids incorrectly treating a paired quote within the content\n+    # as the closing quote of the FITS string.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..b5b4aee 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow embedded doubled single-quotes ('') anywhere inside the string.\n+    # The content is defined as any number of non-quote characters or pairs of quotes.\n+    _strg = r\"'(?P<strg>(?:[^']|(?:''))*?)'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..36011d6 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,8 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow any printable ASCII except an unescaped single quote; embedded quotes must be doubled ('')\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..d0c0caa 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,9 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Ensure that any internal single quote characters are represented by doubled quotes ('')\n+    # so that the closing quote is not misinterpreted as part of the content.\n+    _strg = r\"\\'(?P<strg>((?:[ -&\\(-~]|\\'\\')*?) *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..ad04500 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,11 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow embedded single quotes inside a FITS string by matching them as doubled quotes ('')\n+    # anywhere in the value. This prevents interpreting the first of a doubled-quote pair\n+    # as the closing delimiter, which caused occasional loss of one quote.\n+    # The content is any sequence of non-quote characters or doubled quotes, followed by a closing quote.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..9bf553c 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,10 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Allow any printable ASCII except single-quote, and treat pairs of single-quotes\n+    # inside the string as an escaped quote character. Trailing spaces inside the\n+    # quotes are captured in the group so they can be handled by downstream logic.\n+    _strg = r\"\\'(?P<strg>(?:[ !-&\\(-~]|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..6cb714d 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -63,8 +63,13 @@ class Card(_Verify):\n     _number_NFSC_RE = re.compile(rf\"(?P<sign>[+-])? *0*?(?P<digt>{_digits_NFSC})\")\n \n     # Used in cards using the CONTINUE convention which expect a string\n-    # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # followed by an optional comment.\n+    # This pattern captures any sequence of printable characters that does not\n+    # include a single unescaped quote, while allowing escaped quotes represented\n+    # by two consecutive single quotes (''). This ensures that embedded quotes\n+    # are handled correctly and prevents accidental consumption of the closing\n+    # delimiter when multiple embedded quotes occur near the end of the value.\n+    _strg = r\"\\'(?P<strg>(?:[^']|\\'\\')*?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..bf191b7 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,12 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    # Match any sequence of non-quote characters or escaped single quotes ('')\n+    # as the string content, optionally followed by spaces inside the quotes,\n+    # then the closing quote. This ensures that embedded quotes are only\n+    # recognized as part of the content when doubled, avoiding accidental\n+    # consumption of one quote from a pair near field boundaries.\n+    _strg = r\"'(?P<strg>(?:[^']|(?:''))*? *?)'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n",
        "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..19d5d2f 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -64,7 +64,7 @@ class Card(_Verify):\n \n     # Used in cards using the CONTINUE convention which expect a string\n     # followed by an optional comment\n-    _strg = r\"\\'(?P<strg>([ -~]+?|\\'\\'|) *?)\\'(?=$|/| )\"\n+    _strg = r\"\\'(?P<strg>(?:[ -&(-~]|\\'\\')*? *?)\\'(?=$|/| )\"\n     _comm_field = r\"(?P<comm_field>(?P<sepr>/ *)(?P<comm>(.|\\n)*))\"\n     _strg_comment_RE = re.compile(f\"({_strg})? *{_comm_field}?\")\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/astropy/io/fits/card.py b/astropy/io/fits/card.py\nindex c54f5c8..2ee9273 100644\n--- a/astropy/io/fits/card.py\n+++ b/astropy/io/fits/card.py\n@@ -859,7 +859,10 @@ class Card(_Verify):\n                     return kw, vc\n \n                 value = m.group(\"strg\") or \"\"\n-                value = value.rstrip().replace(\"''\", \"'\")\n+                # Do not collapse doubled single-quotes here; decoding of FITS string quoting\n+                # is handled later in the parsing pipeline. Collapsing at this stage can\n+                # incorrectly reduce '' to ' for certain long/continued strings.\n+                value = value.rstrip()\n                 if value and value[-1] == \"&\":\n                     value = value[:-1]\n                 values.append(value)\n",
  "7_resolved": false
}