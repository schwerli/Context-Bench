{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__183a2a5b",
  "original_id": "django__django-15973",
  "1_model_selected_files": [
    "django/db/migrations/autodetector.py",
    "django/db/migrations/state.py",
    "django/db/models/fields/related.py",
    "django/db/migrations/serializer.py",
    "django/db/backends/base/schema.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/fields/related.py",
    "django/db/migrations/autodetector.py",
    "django/db/models/base.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/migrations/operations/__init__.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/migrations/state.py",
    "django/db/migrations/exceptions.py",
    "django/db/models/options.py",
    "django/db/migrations/operations/models.py",
    "django/db/models/__init__.py",
    "django/db/migrations/executor.py",
    "django/db/migrations/questioner.py",
    "django/db/migrations/loader.py",
    "django/db/migrations/__init__.py",
    "django/db/migrations/migration.py",
    "django/db/utils.py",
    "django/db/migrations/writer.py",
    "django/db/backends/base/schema.py",
    "django/apps/config.py",
    "django/db/migrations/utils.py",
    "django/db/migrations/recorder.py",
    "django/db/models/fields/__init__.py",
    "django/db/backends/mysql/schema.py",
    "django/db/backends/base/__init__.py",
    "django/db/backends/__init__.py",
    "django/db/backends/sqlite3/__init__.py",
    "django/apps/registry.py",
    "django/db/backends/mysql/__init__.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/backends/dummy/__init__.py",
    "django/db/backends/oracle/schema.py",
    "django/db/models/utils.py",
    "django/db/models/manager.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/backends/postgresql/__init__.py",
    "django/db/migrations/graph.py",
    "django/apps/__init__.py",
    "django/db/migrations/operations/base.py",
    "django/db/models/sql/__init__.py",
    "django/db/migrations/operations/fields.py",
    "django/db/migrations/operations/special.py",
    "django/db/backends/oracle/features.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/models/constraints.py",
    "django/db/backends/sqlite3/operations.py"
  ],
  "3_final_combined_files": [
    "django/db/migrations/autodetector.py",
    "django/db/models/fields/related.py",
    "django/db/migrations/state.py",
    "django/db/models/base.py"
  ],
  "4_related_elements": {
    "django/db/migrations/autodetector.py": [
      "class: MigrationAutodetector"
    ],
    "django/db/models/fields/related.py": [
      "function: resolve_relation\nfunction: lazy_related_operation\nfunction: create_many_to_many_intermediary_model\nclass: RelatedField\nclass: ManyToManyField"
    ],
    "django/db/migrations/state.py": [
      "function: _get_app_label_and_model_name\nfunction: get_related_models_tuples\nfunction: get_related_models_recursive\nclass: ProjectState\nclass: StateApps\nclass: ModelState"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/migrations/autodetector.py": [
          "\nfunction: MigrationAutodetector._get_dependencies_for_foreign_key\nline: 1417\nline: 1418\nline: 1419\nline: 1420\nline: 1421\nline: 1422\nline: 1423\nline: 1424"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..7739436 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..b0820e2 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_rel = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_rel,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..b37c5ae 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,11 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        # If this is a ManyToManyField, ensure we depend on the through model too.\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..b89a49e 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,11 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        # If this is a ManyToManyField with an explicit through model, depend on it.\n+        through_model = getattr(field.remote_field, \"through\", None)\n+        if through_model:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..73343aa 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_model = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/migrations/autodetector.py": [
          "\nfunction: MigrationAutodetector._get_dependencies_for_foreign_key\nline: 1425\nline: 1426\nline: 1427\nline: 1428\nline: 1429\nline: 1430"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..7739436 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..7739436 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..70a5c57 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through is not None:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..8302c88 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,12 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n+        # If this is a ManyToManyField with an explicit through model, ensure\n+        # the through model's migration is a dependency so the relation can\n+        # be resolved at migration runtime.\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/migrations/autodetector.py": [
          "\nfunction: MigrationAutodetector._get_dependencies_for_foreign_key\nline: 1425\nline: 1426\nline: 1427\nline: 1428\nline: 1429\nline: 1430"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..42b597c 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through_model = getattr(field.remote_field, \"through\", None)\n+        if through_model:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..73343aa 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_model = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..879dce9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,11 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            # Ensure the dependency is added for the actual through model,\n+            # not the remote target model of the relation.\n+            through_model = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..7739436 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,10 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..54207f5 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_relation = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_relation,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..d70f84f 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,12 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n-        if getattr(field.remote_field, \"through\", None):\n+        # If this relation uses an explicit through model (e.g., ManyToMany),\n+        # add a dependency on that model to ensure it is created first.\n+        through = getattr(field.remote_field, \"through\", None)\n+        if through:\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/migrations/autodetector.py": [
          "\nfunction: MigrationAutodetector._get_dependencies_for_foreign_key\nline: 1422\nline: 1423\nline: 1424\nline: 1425\nline: 1426\nline: 1427\nline: 1428\nline: 1429\nline: 1430"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..73343aa 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_model = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..73343aa 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1421,8 +1421,9 @@ class MigrationAutodetector:\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n+            through_model = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through_model,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..5f736f5 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,11 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n+        # If this is a relationship that uses an explicit through model (e.g., M2M),\n+        # ensure the through model's migration is a dependency as well.\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
        "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..151c66f 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1420,9 +1420,12 @@ class MigrationAutodetector:\n                 model_name,\n             )\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n+        # If this is a ManyToManyField with an explicit 'through', ensure we\n+        # depend on the through model's migration, not the remote target model.\n         if getattr(field.remote_field, \"through\", None):\n+            through = field.remote_field.through\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                through,\n                 app_label,\n                 model_name,\n             )\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex fbce8a8..9d5f7a9 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1422,7 +1422,7 @@ class MigrationAutodetector:\n         dependencies = [(dep_app_label, dep_object_name, None, True)]\n         if getattr(field.remote_field, \"through\", None):\n             through_app_label, through_object_name = resolve_relation(\n-                remote_field_model,\n+                field.remote_field.through,\n                 app_label,\n                 model_name,\n             )\n",
  "7_resolved": true
}