{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__1ce4c38e",
  "original_id": "astropy__astropy-14995",
  "1_model_selected_files": [
    "astropy/nddata/mixins/ndarithmetic.py",
    "astropy/nddata/nddata_withmixins.py",
    "astropy/nddata/nddata.py",
    "astropy/nddata/nddata_base.py",
    "astropy/nddata/utils.py"
  ],
  "2_embedding_selected_files": [
    "astropy/nddata/mixins/ndarithmetic.py",
    "astropy/nddata/bitmask.py",
    "astropy/nddata/compat.py",
    "astropy/nddata/nddata_withmixins.py",
    "astropy/nddata/nddata.py",
    "astropy/nddata/__init__.py",
    "astropy/nddata/nduncertainty.py",
    "astropy/nddata/blocks.py",
    "astropy/nddata/decorators.py",
    "astropy/nddata/utils.py",
    "astropy/nddata/nddata_base.py",
    "astropy/nddata/mixins/__init__.py",
    "astropy/nddata/mixins/ndslicing.py",
    "astropy/nddata/mixins/ndio.py",
    "astropy/nddata/flag_collection.py",
    "astropy/nddata/ccddata.py",
    "astropy/nddata/_testing.py",
    "astropy/conftest.py",
    "astropy/version.py",
    "astropy/__init__.py",
    "astropy/setup.py",
    "astropy/logger.py"
  ],
  "3_final_combined_files": [
    "astropy/nddata/mixins/ndarithmetic.py",
    "astropy/nddata/nddata_withmixins.py",
    "astropy/nddata/nddata.py",
    "astropy/nddata/bitmask.py",
    "astropy/nddata/compat.py"
  ],
  "4_related_elements": {
    "astropy/nddata/mixins/ndarithmetic.py": [
      "function: NDArithmeticMixin._arithmetic_mask\nfunction: NDArithmeticMixin._arithmetic\nfunction: NDArithmeticMixin._prepare_then_do_arithmetic\nfunction: NDArithmeticMixin.multiply"
    ],
    "astropy/nddata/nddata.py": [
      "function: NDData.__init__\nfunction: NDData.mask\nfunction: NDData.mask.setter"
    ],
    "astropy/nddata/nddata_withmixins.py": [
      "class: NDDataRef"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "astropy/nddata/mixins/ndarithmetic.py": [
          "\nfunction: NDArithmeticMixin._arithmetic_mask"
        ]
      },
      "patches": [
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ac363c4 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -516,11 +516,16 @@ class NDArithmeticMixin:\n         if (\n             self.mask is None and operand is not None and operand.mask is None\n         ) or handle_mask is None:\n+            # No masks present or no handler specified\n             return None\n         elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n+            # Only operand has a mask: copy it so there is no reference in the result.\n             return deepcopy(operand.mask)\n         elif operand is None:\n+            # Operand is a scalar or has no NDData: copy self's mask.\n+            return deepcopy(self.mask)\n+        elif operand is not None and getattr(operand, \"mask\", None) is None:\n+            # Only self has a mask: copy it to the result.\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..08a8e3b 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,23 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Normalize operand mask\n+        op_mask = None\n+        if operand is not None:\n+            op_mask = getattr(operand, \"mask\", None)\n+\n+        # If there is no handler or neither operand has a mask, there is nothing to propagate\n+        if handle_mask is None or (self.mask is None and op_mask is None):\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # If only one mask is present, copy it to avoid a reference in the result\n+        if self.mask is None and op_mask is not None:\n+            return deepcopy(op_mask)\n+        if self.mask is not None and op_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both operands have masks: use handler to combine them (operation enforces copy)\n+        return handle_mask(self.mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..f8d7ee2 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,26 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Short-circuit if no mask handling is requested\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Determine masks safely\n+        self_mask = self.mask\n+        operand_mask = None if operand is None else getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask, return None\n+        if self_mask is None and operand_mask is None:\n+            return None\n+        # If only the operand has a mask, copy it\n+        if self_mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        # If only self has a mask, copy it\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks: combine using the provided handler (enforces copy)\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..eb17a20 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine presence of masks on both operands\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = False\n+        if operand is not None:\n+            operand_has_mask = getattr(operand, \"mask\", None) is not None\n+\n+        # If mask handling is disabled, do not propagate any mask\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Neither operand has a mask\n+        if not self_has_mask and not operand_has_mask:\n+            return None\n+\n+        # Only one operand has a mask: copy it to avoid references\n+        if self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+        if not self_has_mask and operand_has_mask:\n+            return deepcopy(operand.mask)\n+\n+        # Both operands have masks: combine using the provided handler\n+        return handle_mask(self.mask, operand.mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..b8c4ca3 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If there is no handle_mask function, there is nothing to do.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Determine masks of self and operand (operand may be None or lack a mask)\n+        self_mask = self.mask\n+        op_mask = None\n+        if operand is not None:\n+            op_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask -> no mask in result\n+        if self_mask is None and op_mask is None:\n+            return None\n+\n+        # If only one mask is present -> copy it into the result\n+        if self_mask is None:\n+            return deepcopy(op_mask)\n+        if op_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks -> combine using the handler\n+        return handle_mask(self_mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..5d5704d 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -520,6 +520,9 @@ class NDArithmeticMixin:\n         elif self.mask is None and operand is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n+        elif operand is not None and operand.mask is None:\n+            # Operand has no mask, self has a mask -> copy self's mask\n+            return deepcopy(self.mask)\n         elif operand is None:\n             return deepcopy(self.mask)\n         else:\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..aed5c1f 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,27 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine operand's mask safely\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask, nothing to propagate\n+        if self.mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # If only one mask is present, just copy it over to the result\n+        if self.mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        if self.mask is not None and (operand is None or operand_mask is None):\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both operands have masks; if no handler is provided, return None\n+        if handle_mask is None:\n+            return None\n+\n+        # Now calculate the resulting mask (operation enforces copy)\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..abf253b 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,29 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Normalize operand mask to a simple variable to simplify the logic\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If mask handling is disabled, do not propagate any mask\n+        if handle_mask is None:\n+            return None\n+\n+        # Neither operand has a mask\n+        if self.mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Only the second operand has a mask\n+        if self.mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+\n+        # Only self has a mask (operand exists but has no mask, or operand is None)\n+        if operand_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both operands have masks: combine them using the handler\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..5300df7 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,30 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no handler is given, do not propagate a mask.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # If operand is a scalar (i.e., not NDData-like), propagate self.mask if present.\n+        if operand is None:\n+            return deepcopy(self.mask) if self.mask is not None else None\n+\n+        # Determine mask presence on both operands.\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = getattr(operand, \"mask\", None) is not None\n+\n+        if self_has_mask and operand_has_mask:\n+            # Both have masks -> use the handler to combine them.\n+            return handle_mask(self.mask, operand.mask, **kwds)\n+        elif self_has_mask and not operand_has_mask:\n+            # Only self has a mask -> copy it to the result.\n             return deepcopy(self.mask)\n+        elif not self_has_mask and operand_has_mask:\n+            # Only operand has a mask -> copy it to the result.\n+            return deepcopy(operand.mask)\n         else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            # Neither has a mask.\n+            return None\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..e269fdb 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,31 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled explicitly, don't propagate any mask\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Determine presence of masks on both operands\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = False\n+        if operand is not None:\n+            try:\n+                operand_has_mask = operand.mask is not None\n+            except AttributeError:\n+                operand_has_mask = False\n+\n+        # If neither has a mask, nothing to propagate\n+        if not self_has_mask and not operand_has_mask:\n+            return None\n+\n+        # If exactly one has a mask, copy that mask\n+        if self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+        if operand_has_mask and not self_has_mask:\n+            return deepcopy(operand.mask)\n+\n+        # Both have masks: combine using handle_mask\n+        return handle_mask(self.mask, operand.mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "astropy/nddata/mixins/ndarithmetic.py": [
          "\nfunction: NDArithmeticMixin._arithmetic_mask"
        ]
      },
      "patches": [
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..e7ae738 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -522,6 +522,9 @@ class NDArithmeticMixin:\n             return deepcopy(operand.mask)\n         elif operand is None:\n             return deepcopy(self.mask)\n+        elif operand is not None and operand.mask is None:\n+            # Operand has no mask but self does; propagate self's mask.\n+            return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..1f004d8 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -513,14 +513,16 @@ class NDArithmeticMixin:\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n         # If only one mask is present we need not bother about any type checks\n+        # If neither mask is present or mask handling is disabled, return None\n         if (\n-            self.mask is None and operand is not None and operand.mask is None\n+            (self.mask is None and (operand is None or (operand is not None and operand.mask is None)))\n         ) or handle_mask is None:\n             return None\n         elif self.mask is None and operand is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+        elif operand is None or (operand is not None and operand.mask is None):\n+            # Operand has no mask (either scalar or NDDataRef without mask), copy our mask\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ec91652 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,18 +512,32 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine if each operand has a mask\n+        self_has_mask = self.mask is not None\n+        op_has_mask = operand is not None and getattr(operand, \"mask\", None) is not None\n+\n+        # If no handle function is provided:\n+        # - propagate a single existing mask\n+        # - otherwise, if both lack masks or both have masks, return None (no combination)\n+        if handle_mask is None:\n+            if self_has_mask and not op_has_mask:\n+                return deepcopy(self.mask)\n+            if op_has_mask and not self_has_mask:\n+                return deepcopy(operand.mask)\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # With a handle function:\n+        # - if neither has a mask -> no mask\n+        # - if only one has a mask -> copy that mask\n+        # - if both have masks -> combine via handle_mask\n+        if not self_has_mask and not op_has_mask:\n+            return None\n+        elif self_has_mask and not op_has_mask:\n             return deepcopy(self.mask)\n+        elif not self_has_mask and op_has_mask:\n+            return deepcopy(operand.mask)\n         else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n+            # Both have masks: calculate the resulting mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..6f5f9ba 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,27 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no mask handling is requested, there is no resulting mask.\n+        if handle_mask is None:\n+            return None\n+\n+        # Extract operand mask safely\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = operand.mask\n+\n+        # If neither operand has a mask, return None.\n+        if self.mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # If only one has a mask, return a copy of that mask.\n+        if self.mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        if self.mask is not None and operand_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both have masks: combine them using the provided handler.\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ce294f0 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,32 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no mask handling requested, always return None\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # If operand is None (e.g., operation with a scalar), return a copy of self.mask.\n+        if operand is None:\n+            return deepcopy(self.mask) if self.mask is not None else None\n+\n+        # At this point operand is not None; check masks explicitly.\n+        self_mask = self.mask\n+        other_mask = operand.mask\n+\n+        # Neither operand has a mask\n+        if self_mask is None and other_mask is None:\n+            return None\n+\n+        # Only the other operand has a mask\n+        if self_mask is None:\n+            return deepcopy(other_mask)\n+\n+        # Only self has a mask\n+        if other_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks: combine using the provided handler\n+        return handle_mask(self_mask, other_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..53bbe11 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no handler is given, don't propagate masks.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Normalize operand mask to a local variable (operand may be None or may not have a mask)\n+        self_mask = self.mask\n+        operand_mask = getattr(operand, \"mask\", None) if operand is not None else None\n+\n+        # If neither operand has a mask, return None\n+        if self_mask is None and operand_mask is None:\n+            return None\n+\n+        # If only the operand has a mask, copy it\n+        if self_mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+\n+        # If only self has a mask, copy it\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks, combine using the handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..1980b0e 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,30 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no mask handling is requested, always return None\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Determine presence of masks\n+        self_has_mask = self.mask is not None\n+\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+        operand_has_mask = operand_mask is not None\n+\n+        # If neither operand has a mask, nothing to propagate\n+        if not self_has_mask and not operand_has_mask:\n+            return None\n+\n+        # If only one operand has a mask, copy it to avoid referencing original\n+        if self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+        if operand_has_mask and not self_has_mask:\n+            return deepcopy(operand_mask)\n+\n+        # Both have masks: combine using the provided handler\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..00e2e76 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,31 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, nothing to propagate\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Operand being a scalar or otherwise not carrying a mask\n+        if operand is None:\n+            # Copy our own mask (may be None which is fine)\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # At this point operand is an NDData-like object\n+        op_mask = getattr(operand, \"mask\", None)\n+        self_mask = self.mask\n+\n+        # Neither has a mask\n+        if self_mask is None and op_mask is None:\n+            return None\n+\n+        # Only one side has a mask -> just copy it\n+        if self_mask is None and op_mask is not None:\n+            return deepcopy(op_mask)\n+        if self_mask is not None and op_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both masks present -> combine using handler\n+        return handle_mask(self_mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..fd70f75 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is explicitly disabled, don't propagate masks\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Get masks from both operands (operand may be None or have no mask)\n+        self_mask = self.mask\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask, nothing to propagate\n+        if self_mask is None and operand_mask is None:\n+            return None\n+\n+        # If only one mask is present, return a copy of that mask\n+        if self_mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both masks present -> combine using the provided handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..5b6452c 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,21 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine operand mask safely even if operand is a scalar or lacks a mask\n+        op_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither operand has a mask or mask handling is disabled, return None\n+        if (self.mask is None and operand is not None and op_mask is None) or handle_mask is None:\n             return None\n         elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+            # Only the operand has a mask; copy it so there is no reference in the result.\n+            return deepcopy(op_mask)\n+        elif operand is None or op_mask is None:\n+            # Only self has a mask (operand missing or mask is None); copy self's mask.\n             return deepcopy(self.mask)\n         else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            # Both have masks; calculate the resulting mask (operation enforces copy)\n+            return handle_mask(self.mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "astropy/nddata/mixins/ndarithmetic.py": [
          "\nfunction: NDArithmeticMixin._arithmetic_mask\nline: 520\nline: 521\nline: 522\nline: 523\nline: 524\nline: 525\nline: 526\nline: 527"
        ]
      },
      "patches": [
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..7060d0a 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,18 +512,27 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine presence of masks for both operands\n+        if handle_mask is None:\n+            return None\n+\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = (\n+            operand is not None and getattr(operand, \"mask\", None) is not None\n+        )\n+\n+        # If neither has a mask, return None\n+        if not self_has_mask and not operand_has_mask:\n             return None\n-        elif self.mask is None and operand is not None:\n+        # If only operand has a mask, copy it\n+        elif not self_has_mask and operand_has_mask:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+        # If only self has a mask (operand is None or has no mask), copy self's mask\n+        elif self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n         else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n+            # Both have masks: combine using handle_mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..693cbbe 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If there is no mask handler, we cannot combine masks\n+        if handle_mask is None:\n+            return None\n+\n+        # Determine the operand's mask (it may be absent or the operand may be None)\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = operand.mask\n+\n+        # No masks present on either side\n+        if self.mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+        # Only operand has a mask\n+        elif self.mask is None and operand_mask is not None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+            return deepcopy(operand_mask)\n+        # Only self has a mask\n+        elif self.mask is not None and operand_mask is None:\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..6a33bd9 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,22 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Normalize operand mask presence\n+        op_mask = getattr(operand, \"mask\", None) if operand is not None else None\n+\n+        # If mask handling is disabled, or neither operand has a mask, return None\n+        if handle_mask is None or (self.mask is None and op_mask is None):\n             return None\n-        elif self.mask is None and operand is not None:\n+\n+        # If only one mask is present, copy it to the result\n+        if self.mask is None and op_mask is not None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+            return deepcopy(op_mask)\n+        if self.mask is not None and op_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both masks present: combine using handler (enforces copy)\n+        return handle_mask(self.mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ae25369 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,31 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine masks for both operands\n+        self_mask = self.mask\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask, nothing to propagate\n+        if self_mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+\n+        # If only one mask is present, just copy it\n+        if self_mask is None and operand_mask is not None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            return deepcopy(operand_mask)\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks: combine according to handle_mask\n+        if handle_mask is None:\n+            # No combination function supplied; default to copying self mask\n+            # to avoid returning a view.\n+            return deepcopy(self_mask)\n+\n+        # Now lets calculate the resulting mask (operation enforces copy)\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..958109a 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,23 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If no mask propagation is requested just return no mask\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Determine operand mask presence safely even if operand lacks a mask attribute\n+        operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If the operand has no mask (or is not NDData-like), propagate self's mask if present\n+        if operand is None or operand_mask is None:\n+            return None if self.mask is None else deepcopy(self.mask)\n+\n+        # If self has no mask but operand does, propagate operand's mask\n+        if self.mask is None:\n+            return deepcopy(operand_mask)\n+\n+        # Both have masks: combine using the provided handle_mask\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..39ee69b 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -520,7 +520,7 @@ class NDArithmeticMixin:\n         elif self.mask is None and operand is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+        elif operand is None or (operand is not None and operand.mask is None):\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..0caab3f 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -522,6 +522,9 @@ class NDArithmeticMixin:\n             return deepcopy(operand.mask)\n         elif operand is None:\n             return deepcopy(self.mask)\n+        elif operand is not None and operand.mask is None:\n+            # Operand has no mask but self does -> copy self's mask\n+            return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ed1e724 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If handle_mask is None, do not propagate any mask\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Determine masks of both operands (operand may be None or may not have a mask)\n+        self_mask = self.mask\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = operand.mask\n+\n+        # If neither has a mask, nothing to propagate\n+        if self_mask is None and operand_mask is None:\n+            return None\n+\n+        # If only one has a mask, copy that mask to the result\n+        if self_mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks -> combine them using the provided handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..706f1f2 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,21 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine the operand's mask safely (operand may be a scalar or None)\n+        operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If mask handling is disabled or neither operand has a mask, return None\n+        if handle_mask is None or (self.mask is None and operand_mask is None):\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # If only one mask is present, copy that mask into the result\n+        if self.mask is None and operand_mask is not None:\n+            return deepcopy(operand_mask)\n+        if self.mask is not None and operand_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both have masks: combine using the provided handler (enforces copy)\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..98f9153 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,31 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine presence of masks and handle all combinations safely.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n+\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = False\n+        if operand is not None:\n+            # Use getattr to avoid AttributeError if operand lacks 'mask'\n+            operand_mask = getattr(operand, \"mask\", None)\n+            operand_has_mask = operand_mask is not None\n         else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            operand_mask = None\n+\n+        # No masks on either side -> nothing to propagate.\n+        if not self_has_mask and not operand_has_mask:\n+            return None\n+\n+        # Only one side has a mask -> copy that mask through.\n+        if self_has_mask and not operand_has_mask:\n+            return deepcopy(self.mask)\n+        if operand_has_mask and not self_has_mask:\n+            return deepcopy(operand_mask)\n+\n+        # Both sides have masks -> combine using the provided handler.\n+        return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "astropy/nddata/mixins/ndarithmetic.py": [
          "\nfunction: NDArithmeticMixin._arithmetic_mask\nline: 516\nline: 520\nline: 523\nline: 527"
        ]
      },
      "patches": [
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..46bbb4e 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,30 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled altogether, return no mask.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # If the operand is a scalar (i.e., has no mask), just copy our mask.\n+        if operand is None:\n+            return deepcopy(self.mask) if self.mask is not None else None\n+\n+        # Determine masks of both operands.\n+        self_mask = self.mask\n+        operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If neither operand has a mask, return no mask.\n+        if self_mask is None and operand_mask is None:\n+            return None\n+        # If only the other operand has a mask, copy it.\n+        if self_mask is None:\n+            return deepcopy(operand_mask)\n+        # If only we have a mask, copy ours.\n+        if operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks: combine them using the provided handler.\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..931e7bb 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,31 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, do not propagate any mask.\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Operand may be a scalar/constant (represented here as None).\n+        if operand is None:\n+            return deepcopy(self.mask) if self.mask is not None else None\n+\n+        # At this point, operand is NDData-like. Determine presence of masks.\n+        op_mask = getattr(operand, \"mask\", None)\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = op_mask is not None\n+\n+        # If neither has a mask, nothing to propagate.\n+        if not self_has_mask and not operand_has_mask:\n+            return None\n+\n+        # If only one has a mask, copy and return that one.\n+        if not self_has_mask and operand_has_mask:\n+            return deepcopy(op_mask)\n+        if self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both have masks: combine using the provided handler (enforces copy).\n+        return handle_mask(self.mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..197b9f5 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Determine mask of the operand safely\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = getattr(operand, \"mask\", None)\n+\n+        # If mask handling is disabled return no mask\n+        if handle_mask is None:\n+            return None\n+\n+        # No mask on either side\n+        if self.mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+        # Only operand has a mask\n+        elif self.mask is None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+            return deepcopy(operand_mask)\n+        # Only self has a mask\n+        elif operand_mask is None:\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            return handle_mask(self.mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..c9c0569 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,28 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, return None\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+\n+        self_mask = self.mask\n+        operand_mask = None\n+        if operand is not None:\n+            operand_mask = operand.mask\n+\n+        # If neither operand has a mask\n+        if self_mask is None and operand_mask is None:\n+            return None\n+        # If only the second operand has a mask\n+        if self_mask is None and operand_mask is not None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            return deepcopy(operand_mask)\n+        # If only self has a mask (operand is None or has no mask)\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks: combine using the provided handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..a729455 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,32 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, nothing to propagate.\n+        if handle_mask is None:\n+            return None\n+\n+        # If the operand is None (e.g., arithmetic with a scalar), just copy our mask.\n+        if operand is None:\n+            return deepcopy(self.mask) if self.mask is not None else None\n+\n+        # At this point operand is not None; check masks on both sides.\n+        self_has_mask = self.mask is not None\n+        operand_has_mask = getattr(operand, \"mask\", None) is not None\n+\n+        # Neither has a mask -> no mask in result.\n+        if not self_has_mask and not operand_has_mask:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n+\n+        # Only operand has a mask -> copy operand's mask.\n+        if not self_has_mask and operand_has_mask:\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Only self has a mask -> copy self's mask.\n+        if self_has_mask and not operand_has_mask:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both have masks -> combine using the provided handler.\n+        return handle_mask(self.mask, operand.mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..b2f1658 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,26 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, no mask in result\n+        if handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Safely determine masks for self and operand\n+        self_mask = getattr(self, \"mask\", None)\n+        operand_mask = getattr(operand, \"mask\", None) if operand is not None else None\n+\n+        # If neither has a mask, nothing to propagate\n+        if self_mask is None and operand_mask is None:\n+            return None\n+\n+        # If only one mask is present, copy it into the result\n+        if self_mask is None:\n+            return deepcopy(operand_mask)\n+        if operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both masks present: combine using the provided handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..66f32e0 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -520,7 +520,8 @@ class NDArithmeticMixin:\n         elif self.mask is None and operand is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n-        elif operand is None:\n+        elif operand is None or (operand is not None and getattr(operand, \"mask\", None) is None):\n+            # Make a copy so there is no reference in the result.\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..df59ddb 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,27 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # Normalize operand mask (constants or non-NDData-like operands have no mask)\n+        op_mask = None\n+        if operand is not None:\n+            op_mask = operand.mask\n+\n+        # If mask handling is disabled, do not propagate any mask\n+        if handle_mask is None:\n+            return None\n+\n+        # Neither operand has a mask\n+        if self.mask is None and op_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n+\n+        # Only one operand has a mask -> copy it\n+        if self.mask is None and op_mask is not None:\n+            return deepcopy(op_mask)\n+        if self.mask is not None and op_mask is None:\n             return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+\n+        # Both operands have masks -> combine using the provided handler\n+        return handle_mask(self.mask, op_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..bad0dcf 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -521,6 +521,10 @@ class NDArithmeticMixin:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n         elif operand is None:\n+            # Operand is a scalar, propagate our existing mask.\n+            return deepcopy(self.mask)\n+        elif operand is not None and operand.mask is None:\n+            # Operand has no mask, propagate our existing mask.\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
        "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..90cc8fb 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -512,19 +512,27 @@ class NDArithmeticMixin:\n             If neither had a mask ``None`` is returned. Otherwise\n             ``handle_mask`` must create (and copy) the returned mask.\n         \"\"\"\n-        # If only one mask is present we need not bother about any type checks\n-        if (\n-            self.mask is None and operand is not None and operand.mask is None\n-        ) or handle_mask is None:\n+        # If mask handling is disabled, do not propagate masks\n+        if handle_mask is None:\n+            return None\n+\n+        # Determine masks of both operands robustly\n+        self_mask = self.mask\n+        operand_mask = None if operand is None else getattr(operand, \"mask\", None)\n+\n+        # If neither has a mask, nothing to propagate\n+        if self_mask is None and operand_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+\n+        # If only one has a mask, copy that one\n+        if self_mask is None and operand_mask is not None:\n             # Make a copy so there is no reference in the result.\n-            return deepcopy(operand.mask)\n-        elif operand is None:\n-            return deepcopy(self.mask)\n-        else:\n-            # Now lets calculate the resulting mask (operation enforces copy)\n-            return handle_mask(self.mask, operand.mask, **kwds)\n+            return deepcopy(operand_mask)\n+        if self_mask is not None and operand_mask is None:\n+            return deepcopy(self_mask)\n+\n+        # Both have masks, combine using the provided handler\n+        return handle_mask(self_mask, operand_mask, **kwds)\n \n     def _arithmetic_wcs(self, operation, operand, compare_wcs, **kwds):\n         \"\"\"\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex fbb2aba..ac363c4 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -516,11 +516,16 @@ class NDArithmeticMixin:\n         if (\n             self.mask is None and operand is not None and operand.mask is None\n         ) or handle_mask is None:\n+            # No masks present or no handler specified\n             return None\n         elif self.mask is None and operand is not None:\n-            # Make a copy so there is no reference in the result.\n+            # Only operand has a mask: copy it so there is no reference in the result.\n             return deepcopy(operand.mask)\n         elif operand is None:\n+            # Operand is a scalar or has no NDData: copy self's mask.\n+            return deepcopy(self.mask)\n+        elif operand is not None and getattr(operand, \"mask\", None) is None:\n+            # Only self has a mask: copy it to the result.\n             return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n",
  "7_resolved": true
}