{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__bc999af3",
  "original_id": "sympy__sympy-13877",
  "1_model_selected_files": [
    "sympy/matrices/matrices.py",
    "sympy/polys/polytools.py",
    "sympy/core/exprtools.py",
    "sympy/matrices/densetools.py",
    "sympy/matrices/expressions/determinant.py"
  ],
  "2_embedding_selected_files": [
    "sympy/matrices/matrices.py",
    "sympy/matrices/dense.py",
    "sympy/matrices/expressions/matmul.py",
    "sympy/matrices/expressions/blockmatrix.py",
    "sympy/matrices/expressions/determinant.py",
    "sympy/matrices/expressions/matexpr.py",
    "sympy/matrices/common.py",
    "sympy/matrices/sparse.py",
    "sympy/core/exprtools.py",
    "sympy/matrices/expressions/matpow.py",
    "sympy/matrices/densesolve.py",
    "sympy/matrices/expressions/inverse.py",
    "sympy/matrices/expressions/hadamard.py",
    "sympy/polys/polymatrix.py",
    "sympy/core/power.py",
    "sympy/polys/numberfields.py",
    "sympy/core/numbers.py",
    "sympy/matrices/densetools.py",
    "sympy/core/mul.py",
    "sympy/matrices/expressions/matadd.py",
    "sympy/matrices/expressions/funcmatrix.py",
    "sympy/matrices/expressions/diagonal.py",
    "sympy/matrices/expressions/factorizations.py",
    "sympy/matrices/__init__.py",
    "sympy/polys/polyroots.py",
    "sympy/matrices/immutable.py",
    "sympy/core/add.py",
    "sympy/matrices/expressions/__init__.py",
    "sympy/core/expr.py",
    "sympy/core/backend.py",
    "sympy/matrices/expressions/transpose.py",
    "sympy/matrices/expressions/adjoint.py",
    "sympy/matrices/densearith.py",
    "sympy/core/operations.py",
    "sympy/polys/polyquinticconst.py",
    "sympy/core/function.py",
    "sympy/polys/polytools.py",
    "sympy/core/evalf.py",
    "sympy/matrices/expressions/dotproduct.py"
  ],
  "3_final_combined_files": [
    "sympy/matrices/matrices.py",
    "sympy/polys/polytools.py",
    "sympy/core/exprtools.py",
    "sympy/matrices/dense.py",
    "sympy/matrices/expressions/matmul.py"
  ],
  "4_related_elements": {
    "sympy/matrices/matrices.py": [
      "class: MatrixDeterminant\nfunction: _iszero\nfunction: _find_reasonable_pivot\nfunction: _find_reasonable_pivot_naive\nclass: MatrixBase"
    ],
    "sympy/polys/polytools.py": [
      "function: cancel"
    ],
    "sympy/core/exprtools.py": [
      "function: factor_terms\nfunction: gcd_terms\nfunction: _gcd_terms\nclass: Term\nclass: Factors\nfunction: _monotonic_sign\nfunction: _isnumber"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "sympy/core/exprtools.py": [
          "\nfunction: factor_terms\nline: 1171"
        ],
        "sympy/matrices/matrices.py": [
          "\nfunction: MatrixDeterminant._eval_det_bareiss\nline: 208\nline: 216\nline: 178\nline: 183\nfunction: MatrixDeterminant.det\nline: 383"
        ]
      },
      "patches": [
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..74745ed 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,7 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..9cdf5fd 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use .is_negative to avoid Invalid NaN comparison when coefficients contain NaN\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..0b0819a 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Avoid direct numeric comparison which can fail for NaN; use is_negative instead.\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..318de83 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..990fd6f 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g., with NaN)\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..c28d3af 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid Invalid NaN comparison errors\n+            if all(a.as_coeff_Mul()[0].is_negative is True for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..08cadcd 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid NaN comparisons (e.g., with NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..be70590 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g. with NaN)\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..28e9e19 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g. NaN < 0)\n+            if all(a.as_coeff_Mul()[0].is_negative is True for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..ca0f32b 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "sympy/matrices/matrices.py": [
          "\nfunction: MatrixDeterminant._eval_det_bareiss\nline: 211"
        ],
        "sympy/core/exprtools.py": [
          "\nfunction: factor_terms\nline: 1171"
        ]
      },
      "patches": [
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..318de83 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..2b03a9d 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons with NaN or symbolic coefficients\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..a609bbc 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., with NaN)\n+            if sign and all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..2ca23c9 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g. NaN)\n+            # Treat indeterminate negativity as not common negative\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..8aac6e6 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # avoid direct numeric comparison which can raise for NaN;\n+            # use is_negative so unknown signs won't trigger an error\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..54da1e6 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., NaN) when checking coefficients\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..d7a9e89 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..5e1f274 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g., NaN)\n+            if list_args and all(getattr(a.as_coeff_Mul()[0], 'is_negative', False) is True for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..91d04b1 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -189,6 +189,10 @@ class MatrixDeterminant(MatrixCommon):\n                 return S.One\n             elif mat.rows == 1:\n                 return mat[0, 0]\n+            # if the previous pivot (denominator) is zero then the determinant is zero\n+            # avoid division by zero that would lead to NaN\n+            if cumm == 0:\n+                return S.Zero\n \n             # find a pivot and extract the remaining matrix\n             # XXX should use `_find_reasonable_pivot`.  Blocked by issue #12362\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..2885f90 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., with NaN or symbolic coefficients)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..7a83de1 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_Number and c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..7d7cdf4 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -176,7 +176,13 @@ class MatrixDeterminant(MatrixCommon):\n \n         # XXX included as a workaround for issue #12362.  Should use `_find_reasonable_pivot` instead\n         def _find_pivot(l):\n-            for pos,val in enumerate(l):\n+            # Prefer a pivot that is definitely nonzero; avoid NaN as a pivot.\n+            for pos, val in enumerate(l):\n+                if val is S.NaN:\n+                    continue\n+                if val.is_zero is True:\n+                    continue\n+                # fall back to truthiness only if not known-zero/NaN\n                 if val:\n                     return (pos, val, None, None)\n             return (None, None, None, None)\n@@ -198,7 +204,7 @@ class MatrixDeterminant(MatrixCommon):\n \n             # if we have a valid pivot, we'll do a \"row swap\", so keep the\n             # sign of the det\n-            sign = (-1) ** (pivot_pos % 2)\n+            sign = (-1) ** pivot_pos\n \n             # we want every row but the pivot row and every column\n             rows = list(i for i in range(mat.rows) if i != pivot_pos)\n@@ -208,7 +214,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "sympy/core/exprtools.py": [
          "\nline: 1171"
        ],
        "sympy/matrices/matrices.py": [
          "\nfunction: MatrixDeterminant._eval_det_bareiss\nline: 211\nline: 216\nfunction: MatrixDeterminant.det"
        ]
      },
      "patches": [
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..a617d25 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Avoid direct relational comparison which can raise on indeterminate values (e.g. NaN).\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..235de44 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Only flip sign if all terms have a well-defined negative numeric coefficient.\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # Avoid Invalid NaN comparison: only consider numeric, real, finite coefficients\n+            if coeffs and all(c.is_Number and c.is_real and c.is_finite and (c < 0) for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..8e7a6c1 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,11 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Only factor out -1 if every term has a numeric, finite, real negative coefficient.\n+            def _has_negative_numeric_coeff(arg):\n+                coeff = arg.as_coeff_Mul()[0]\n+                return coeff.is_Number and (coeff.is_finite is True) and (coeff.is_real is True) and (coeff.is_negative is True)\n+            if list_args and all(_has_negative_numeric_coeff(a) for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..402ffe3 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g., NaN)\n+            if all(a.as_coeff_Mul()[0].is_negative is True for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..6b690dc 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use a safe negativity check to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..86d9bef 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1175,8 +1175,16 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         cont, p = expr.as_content_primitive(radical=radical, clear=clear)\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n-            # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # get a common negative (if there) which gcd_terms does not remove.\n+            # Use is_negative to avoid TypeError for indeterminates or NaN.\n+            neg_all = True\n+            for a in list_args:\n+                c = a.as_coeff_Mul()[0]\n+                # Only treat as negative if it can be determined to be strictly negative\n+                if c.is_negative is not True:\n+                    neg_all = False\n+                    break\n+            if neg_all:\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..dec6970 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative attribute to avoid invalid comparisons (e.g. NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..a346ac7 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative instead of numeric comparison to handle indeterminate/NaN safely\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(getattr(c, 'is_negative', False) is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..2fe455d 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Avoid direct inequality comparisons that can raise with NaN or symbolic coefficients.\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # Only factor out -1 when every coefficient is known to be negative.\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..cc048c1 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid invalid comparisons (e.g., NaN) and\n+            # to handle non-real or indeterminate coefficients safely\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_real and c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..07ab4d3 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -207,8 +207,8 @@ class MatrixDeterminant(MatrixCommon):\n \n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n-                if not ret.is_Atom:\n-                    cancel(ret)\n+                # Avoid premature cancellation that can introduce NaN with symbolic entries;\n+                # final cancellation is applied after recursion.\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "sympy/core/exprtools.py": [
          "\nline: 1171"
        ],
        "sympy/matrices/matrices.py": [
          "\nfunction: MatrixDeterminant._eval_det_bareiss\nline: 210\nline: 211\nline: 212"
        ]
      },
      "patches": [
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..d7a9e89 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..ba3ad2d 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # Only flip signs if all coefficients are definitively negative.\n+            # Using is_negative avoids invalid comparisons (e.g. with NaN).\n+            if all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..b9a7dfd 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # use is_negative to avoid Invalid NaN comparison (e.g. when coefficients are NaN or symbolic)\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..36474fb 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -190,6 +190,11 @@ class MatrixDeterminant(MatrixCommon):\n             elif mat.rows == 1:\n                 return mat[0, 0]\n \n+            # If the previous pivot (cumm) is zero then the determinant is zero.\n+            # This avoids division by zero leading to NaN during fraction-free elimination.\n+            if getattr(cumm, 'is_zero', False):\n+                return S.Zero\n+\n             # find a pivot and extract the remaining matrix\n             # XXX should use `_find_reasonable_pivot`.  Blocked by issue #12362\n             pivot_pos, pivot_val, _, _ = _find_pivot(mat[:, 0])\n@@ -208,7 +213,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..87ab8c9 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # only factor out -1 if all leading coefficients are known negative\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..a16e5dc 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid Invalid NaN comparison and symbolic ambiguities.\n+            # Only flip the sign if all leading coefficients are strictly negative.\n+            if all((a.as_coeff_Mul()[0].is_negative is True) for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..6b2f07f 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -177,18 +177,21 @@ class MatrixDeterminant(MatrixCommon):\n         # XXX included as a workaround for issue #12362.  Should use `_find_reasonable_pivot` instead\n         def _find_pivot(l):\n             for pos,val in enumerate(l):\n-                if val:\n+                if not getattr(val, 'is_zero', False):\n                     return (pos, val, None, None)\n             return (None, None, None, None)\n \n \n         # Recursively implemented Bareiss' algorithm as per Deanna Richelle Leggett's\n         # thesis http://www.math.usm.edu/perry/Research/Thesis_DRL.pdf\n-        def bareiss(mat, cumm=1):\n+        def bareiss(mat, cumm=S.One):\n             if mat.rows == 0:\n                 return S.One\n             elif mat.rows == 1:\n                 return mat[0, 0]\n+            # If the previous pivot is zero then the determinant is zero\n+            if cumm.is_zero:\n+                return S.Zero\n \n             # find a pivot and extract the remaining matrix\n             # XXX should use `_find_reasonable_pivot`.  Blocked by issue #12362\n@@ -206,9 +209,13 @@ class MatrixDeterminant(MatrixCommon):\n             tmp_mat = mat.extract(rows, cols)\n \n             def entry(i, j):\n-                ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n+                # Form the Bareiss update for the (i,j)-th entry\n+                numerator = pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]\n+                if cumm.is_zero:\n+                    return S.Zero\n+                ret = numerator / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..776dfec 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # avoid invalid comparisons with NaN or non-real coefficients\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..a69db28 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -206,9 +206,12 @@ class MatrixDeterminant(MatrixCommon):\n             tmp_mat = mat.extract(rows, cols)\n \n             def entry(i, j):\n-                ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n+                num = pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]\n+                # Avoid division by zero which can lead to NaN; if cumm is zero,\n+                # defer simplification to cancel() rather than performing the division.\n+                ret = num if cumm == 0 else num / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..d727049 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1175,8 +1175,10 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         cont, p = expr.as_content_primitive(radical=radical, clear=clear)\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n-            # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # get a common negative (if there) which gcd_terms does not remove,\n+            # but avoid invalid comparisons (e.g., with NaN) by using is_negative\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..8628981 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -206,9 +206,12 @@ class MatrixDeterminant(MatrixCommon):\n             tmp_mat = mat.extract(rows, cols)\n \n             def entry(i, j):\n-                ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n+                num = pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]\n+                # Avoid division by zero which can lead to NaN; if the previous pivot\n+                # is exactly zero, skip the division (the determinant will be zero).\n+                ret = num if getattr(cumm, 'is_zero', False) is True else num / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..1f75390 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,8 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., with NaN or symbolic coefficients)\n+            if all(a.as_coeff_Mul()[0].is_negative for a in list_args):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..032f256 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -197,8 +197,8 @@ class MatrixDeterminant(MatrixCommon):\n                 return S.Zero\n \n             # if we have a valid pivot, we'll do a \"row swap\", so keep the\n-            # sign of the det\n-            sign = (-1) ** (pivot_pos % 2)\n+            # sign of the det. Swapping the pivot row with the first row is a single swap\n+            sign = -S.One if pivot_pos != 0 else S.One\n \n             # we want every row but the pivot row and every column\n             rows = list(i for i in range(mat.rows) if i != pivot_pos)\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..8aad977 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            neg_coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            # use is_negative to avoid invalid comparisons (e.g. NaN)\n+            if all(c.is_negative for c in neg_coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
        "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..a22147d 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if coeffs and all(c.is_negative is True for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..b39657e 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -206,9 +206,14 @@ class MatrixDeterminant(MatrixCommon):\n             tmp_mat = mat.extract(rows, cols)\n \n             def entry(i, j):\n-                ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n+                num = pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]\n+                # Avoid creating NaN from 0/0; if the cumulative pivot is zero\n+                # then the determinant of the submatrix is zero.\n+                if cumm == 0:\n+                    return S.Zero if num == 0 else num / cumm\n+                ret = num / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/sympy/core/exprtools.py b/sympy/core/exprtools.py\nindex 8f86407..318de83 100644\n--- a/sympy/core/exprtools.py\n+++ b/sympy/core/exprtools.py\n@@ -1176,7 +1176,9 @@ def factor_terms(expr, radical=False, clear=False, fraction=False, sign=True):\n         if p.is_Add:\n             list_args = [do(a) for a in Add.make_args(p)]\n             # get a common negative (if there) which gcd_terms does not remove\n-            if all(a.as_coeff_Mul()[0] < 0 for a in list_args):\n+            # Use is_negative to avoid invalid comparisons (e.g., NaN)\n+            coeffs = [a.as_coeff_Mul()[0] for a in list_args]\n+            if all(c.is_negative for c in coeffs):\n                 cont = -cont\n                 list_args = [-a for a in list_args]\n             # watch out for exp(-(x+2)) which gcd_terms will change to exp(-x-2)\ndiff --git a/sympy/matrices/matrices.py b/sympy/matrices/matrices.py\nindex 3216a40..3e2be22 100644\n--- a/sympy/matrices/matrices.py\n+++ b/sympy/matrices/matrices.py\n@@ -208,7 +208,7 @@ class MatrixDeterminant(MatrixCommon):\n             def entry(i, j):\n                 ret = (pivot_val*tmp_mat[i, j + 1] - mat[pivot_pos, j + 1]*tmp_mat[i, 0]) / cumm\n                 if not ret.is_Atom:\n-                    cancel(ret)\n+                    ret = cancel(ret)\n                 return ret\n \n             return sign*bareiss(self._new(mat.rows - 1, mat.cols - 1, entry), pivot_val)\n",
  "7_resolved": true
}