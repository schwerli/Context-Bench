{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__cecff61c",
  "original_id": "django__django-16819",
  "1_model_selected_files": [
    "django/db/migrations/operations/models.py",
    "django/db/migrations/optimizer.py",
    "django/db/models/indexes.py",
    "django/core/management/commands/optimizemigration.py"
  ],
  "2_embedding_selected_files": [
    "django/db/migrations/operations/models.py",
    "django/db/migrations/autodetector.py",
    "django/db/migrations/optimizer.py",
    "django/db/migrations/operations/fields.py",
    "django/db/migrations/operations/__init__.py",
    "django/db/migrations/operations/base.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/migrations/__init__.py",
    "django/db/migrations/executor.py",
    "django/db/migrations/operations/special.py",
    "django/db/models/indexes.py",
    "django/db/models/sql/query.py",
    "django/db/models/base.py",
    "django/db/migrations/state.py",
    "django/db/migrations/writer.py",
    "django/db/migrations/migration.py",
    "django/db/models/deletion.py",
    "django/db/migrations/graph.py",
    "django/db/migrations/recorder.py",
    "django/db/migrations/loader.py",
    "django/db/models/query_utils.py",
    "django/db/models/query.py",
    "django/db/migrations/exceptions.py",
    "django/db/models/lookups.py",
    "django/db/migrations/questioner.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/__init__.py",
    "django/db/models/fields/json.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/sql/where.py",
    "django/db/models/functions/mixins.py",
    "django/db/__init__.py",
    "django/db/models/fields/related.py",
    "django/db/models/functions/comparison.py",
    "django/db/models/sql/constants.py",
    "django/db/models/functions/__init__.py",
    "django/db/models/functions/text.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/constraints.py",
    "django/db/models/utils.py",
    "django/db/models/functions/math.py",
    "django/db/migrations/serializer.py",
    "django/db/models/functions/datetime.py",
    "django/db/models/options.py"
  ],
  "3_final_combined_files": [
    "django/db/migrations/operations/models.py",
    "django/db/migrations/optimizer.py",
    "django/db/models/indexes.py",
    "django/db/migrations/autodetector.py"
  ],
  "4_related_elements": {
    "django/db/migrations/operations/models.py": [
      "class: IndexOperation\nclass: AddIndex\nclass: RemoveIndex\nclass: RenameIndex"
    ],
    "django/db/migrations/optimizer.py": [
      "function: MigrationOptimizer.optimize\nfunction: MigrationOptimizer.optimize_inner"
    ],
    "django/db/models/indexes.py": [
      "class: Index"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: AddIndex.reduce\nfunction: RemoveIndex.reduce"
        ]
      },
      "patches": [
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        ""
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nclass: AddIndex\nclass: RemoveIndex"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..a284102 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,19 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        \"\"\"\n+        Optimize away a no-op sequence of AddIndex followed by RemoveIndex\n+        for the same model and index name.\n+        \"\"\"\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..a0713f5 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,24 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        # If the following operation removes the same index, both cancel out.\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        # If the following operation adds an index with the same name on the\n+        # same model, keep only the latter definition.\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.index.name\n+        ):\n+            return [operation]\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n@@ -900,6 +918,16 @@ class RemoveIndex(IndexOperation):\n     def describe(self):\n         return \"Remove index %s from %s\" % (self.name, self.model_name)\n \n+    def reduce(self, operation, app_label):\n+        # If the following operation adds back the same index, reduce to just AddIndex.\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.name == operation.index.name\n+        ):\n+            return [operation]\n+        return super().reduce(operation, app_label)\n+\n     @property\n     def migration_name_fragment(self):\n         return \"remove_%s_%s\" % (self.model_name_lower, self.name.lower())\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..c123d41 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,15 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..0404a82 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,17 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        # If an AddIndex is immediately followed by a RemoveIndex for the same\n+        # model and index name, they cancel each other out.\n+        if isinstance(operation, RemoveIndex):\n+            if (\n+                self.model_name_lower == operation.model_name_lower\n+                and self.index.name == operation.name\n+            ):\n+                return []\n+        return None\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..a3c13d3 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -844,6 +844,16 @@ class AddIndex(IndexOperation):\n             kwargs,\n         )\n \n+    def reduce(self, operation, app_label):\n+        # Cancel out a subsequent RemoveIndex for the same model/index.\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        return super().reduce(operation, app_label)\n+\n     def describe(self):\n         if self.index.expressions:\n             return \"Create index %s on %s on model %s\" % (\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..0cb64dc 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -833,6 +833,16 @@ class AddIndex(IndexOperation):\n         if self.allow_migrate_model(schema_editor.connection.alias, model):\n             schema_editor.remove_index(model, self.index)\n \n+    def reduce(self, operation, app_label):\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            # AddIndex immediately followed by RemoveIndex is a no-op.\n+            return []\n+        return super().reduce(operation, app_label)\n+\n     def deconstruct(self):\n         kwargs = {\n             \"model_name\": self.model_name,\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..7376e14 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,17 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        # If an AddIndex is immediately followed by a RemoveIndex with the same\n+        # name on the same model, they cancel each other out.\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..b1f0620 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -857,6 +857,16 @@ class AddIndex(IndexOperation):\n             self.model_name,\n         )\n \n+    def reduce(self, operation, app_label):\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            # Adding and then removing the same index is a no-op.\n+            return []\n+        return [self, operation]\n+\n     @property\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n@@ -900,6 +910,16 @@ class RemoveIndex(IndexOperation):\n     def describe(self):\n         return \"Remove index %s from %s\" % (self.name, self.model_name)\n \n+    def reduce(self, operation, app_label):\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.name == operation.index.name\n+        ):\n+            # Removing and then adding the same index is a no-op.\n+            return []\n+        return [self, operation]\n+\n     @property\n     def migration_name_fragment(self):\n         return \"remove_%s_%s\" % (self.model_name_lower, self.name.lower())\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..eb8f468 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,24 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        # AddIndex followed by RemoveIndex of the same index cancels out.\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        # Two consecutive AddIndex operations for the same named index on the same\n+        # model can be reduced to the latter one.\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.index.name\n+        ):\n+            return [operation]\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n@@ -900,6 +918,17 @@ class RemoveIndex(IndexOperation):\n     def describe(self):\n         return \"Remove index %s from %s\" % (self.name, self.model_name)\n \n+    def reduce(self, operation, app_label):\n+        # A RemoveIndex followed by an AddIndex of the same named index on the\n+        # same model can be reduced to just the AddIndex.\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.name == operation.index.name\n+        ):\n+            return [operation]\n+        return super().reduce(operation, app_label)\n+\n     @property\n     def migration_name_fragment(self):\n         return \"remove_%s_%s\" % (self.model_name_lower, self.name.lower())\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..ca3dd8e 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -807,6 +807,9 @@ class IndexOperation(Operation):\n     def model_name_lower(self):\n         return self.model_name.lower()\n \n+    def references_model(self, name, app_label):\n+        return name.lower() == self.model_name_lower\n+\n \n class AddIndex(IndexOperation):\n     \"\"\"Add an index on a model.\"\"\"\n@@ -833,6 +836,20 @@ class AddIndex(IndexOperation):\n         if self.allow_migrate_model(schema_editor.connection.alias, model):\n             schema_editor.remove_index(model, self.index)\n \n+    def reduce(self, operation, app_label, in_between):\n+        # Drop a no-op AddIndex followed by RemoveIndex of the same index\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            # Ensure no intermediate ops touch this model.\n+            if not in_between or all(\n+                not op.references_model(self.model_name, app_label) for op in in_between\n+            ):\n+                return []\n+        return None\n+\n     def deconstruct(self):\n         kwargs = {\n             \"model_name\": self.model_name,\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: AddIndex.reduce\nfunction: RemoveIndex.reduce"
        ]
      },
      "patches": [
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        ""
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: AddIndex.reduce\nfunction: RemoveIndex.reduce"
        ]
      },
      "patches": [
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        ""
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 7088737..a284102 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -861,6 +861,19 @@ class AddIndex(IndexOperation):\n     def migration_name_fragment(self):\n         return \"%s_%s\" % (self.model_name_lower, self.index.name.lower())\n \n+    def reduce(self, operation, app_label):\n+        \"\"\"\n+        Optimize away a no-op sequence of AddIndex followed by RemoveIndex\n+        for the same model and index name.\n+        \"\"\"\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name == operation.name\n+        ):\n+            return []\n+        return super().reduce(operation, app_label)\n+\n \n class RemoveIndex(IndexOperation):\n     \"\"\"Remove an index from a model.\"\"\"\n",
  "7_resolved": true
}