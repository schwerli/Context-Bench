{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__88e1ffd3",
  "original_id": "psf__requests-1142",
  "1_model_selected_files": [
    "requests/models.py",
    "requests/adapters.py",
    "requests/packages/urllib3/connectionpool.py",
    "requests/sessions.py",
    "requests/packages/urllib3/poolmanager.py"
  ],
  "2_embedding_selected_files": [
    "requests/utils.py",
    "requests/__init__.py",
    "requests/models.py",
    "requests/status_codes.py",
    "requests/auth.py",
    "requests/api.py",
    "requests/sessions.py",
    "requests/packages/__init__.py",
    "requests/packages/urllib3/request.py",
    "requests/structures.py",
    "requests/setup.py",
    "requests/packages/urllib3/filepost.py",
    "requests/packages/urllib3/response.py",
    "requests/adapters.py",
    "requests/packages/urllib3/util.py",
    "requests/packages/urllib3/connectionpool.py",
    "requests/packages/urllib3/__init__.py",
    "requests/cookies.py",
    "requests/compat.py",
    "requests/packages/urllib3/_collections.py",
    "requests/hooks.py",
    "requests/exceptions.py",
    "requests/packages/urllib3/exceptions.py",
    "requests/certs.py",
    "requests/packages/urllib3/poolmanager.py"
  ],
  "3_final_combined_files": [
    "requests/models.py",
    "requests/adapters.py",
    "requests/packages/urllib3/connectionpool.py",
    "requests/utils.py",
    "requests/__init__.py"
  ],
  "4_related_elements": {
    "requests/models.py": [
      "function: PreparedRequest.prepare_body\nfunction: PreparedRequest.prepare_content_length\nfunction: PreparedRequest.prepare_headers\nfunction: Request.prepare"
    ],
    "requests/adapters.py": [
      "function: HTTPAdapter.send"
    ],
    "requests/packages/urllib3/connectionpool.py": [
      "function: HTTPConnectionPool.__init__\nfunction: HTTPConnectionPool._make_request\nfunction: HTTPConnectionPool.urlopen"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "requests/models.py": [
          "\nfunction: PreparedRequest.prepare_content_length\nline: 380"
        ]
      },
      "patches": [
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..f6ba1aa 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,18 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when we actually have a body.\n+        if body is None:\n+            # Ensure we don't send a Content-Length header for empty bodies.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..d1111d8 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,20 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        \"\"\"Set Content-Length only when a body is present and its size is known.\"\"\"\n+        # Do not send Content-Length for requests without a body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Determine size of file-like object.\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n-            self.headers['Content-Length'] = str(len(body))\n+            # For string/bytes-like bodies, set length; otherwise, leave unset.\n+            try:\n+                self.headers['Content-Length'] = str(len(body))\n+            except Exception:\n+                # Length is not determinable; omit header.\n+                pass\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..af147db 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present; avoid sending it for bodyless requests (e.g., GET).\n+        if body is None:\n+            return\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..99d589f 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,18 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present and length is known.\n+        # Do not add Content-Length for requests without a body (e.g., typical GET).\n+        if 'Content-Length' in self.headers:\n+            # Respect an explicitly provided Content-Length.\n+            return\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None and no explicit Content-Length, leave it unset.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..cbc07de 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Do not set a Content-Length header when there is no request body.\n+        if body is None:\n+            return\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..ba87f34 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present or its size can be determined.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..83de810 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,25 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Respect an explicitly provided Content-Length header.\n+        if 'Content-Length' in self.headers:\n+            return\n+\n+        # Only set Content-Length if there is a request body.\n+        if body is None:\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Compute length of files/streams.\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n-            self.headers['Content-Length'] = str(len(body))\n+        else:\n+            try:\n+                self.headers['Content-Length'] = str(len(body))\n+            except (TypeError, AttributeError):\n+                # Unable to determine length; do not set the header.\n+                pass\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..a8eb777 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length header when a body is present.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..56f71f2 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,15 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if there is an actual request body.\n+        # Some servers reject GET requests that include a Content-Length header.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not add a Content-Length header.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..1cfd7d7 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,20 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Avoid automatically sending Content-Length for GET/HEAD requests with no body.\n+        method = getattr(self, 'method', '').upper()\n+        if method in ('GET', 'HEAD') and body is None:\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # For non-GET/HEAD requests with no body, default to Content-Length: 0.\n+            self.headers['Content-Length'] = '0'\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "requests/models.py": [
          "\nfunction: PreparedRequest.prepare_body\nline: 380\nfunction: PreparedRequest.prepare_content_length\nline: 388\nline: 389\nline: 390\nline: 391\nline: 392\nline: 393\nline: 394\nline: 395\nline: 396"
        ]
      },
      "patches": [
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..c2c5f8d 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,19 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Determine the size of a file-like body.\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n+            # Non-file body: use its length.\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body: do not send Content-Length.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..8743d81 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present or its length can be determined.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..7a2ef1a 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,16 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if we actually have a body\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Calculate size for file-like bodies\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n+            # For non-file-like bodies, use length of the encoded body\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not set Content-Length at all.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..42e19ba 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,15 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if we actually have a body; for GET/HEAD with no body,\n+        # do not send a Content-Length header.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, intentionally avoid setting Content-Length\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..6235634 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..014a814 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,17 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if we actually have a body or a file-like object.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body present: do not add a Content-Length header (e.g., for GET/HEAD).\n+            # Leave any user-provided Content-Length untouched.\n+            pass\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..7abc2dd 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,6 +386,11 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n+        # Do not set Content-Length for GET requests without a body.\n+        if body is None and getattr(self, 'method', None) and str(self.method).upper() == 'GET':\n+            return\n+\n+        # Default to 0, then override if we can compute a length.\n         self.headers['Content-Length'] = '0'\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..49d938e 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,27 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is actually present.\n+        if body is None:\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n-            body.seek(0, 2)\n-            self.headers['Content-Length'] = str(body.tell())\n-            body.seek(0, 0)\n-        elif body is not None:\n+            # Determine length without forcing Content-Length on empty bodies.\n+            current_pos = None\n+            try:\n+                current_pos = body.tell()\n+                body.seek(0, 2)\n+                length = body.tell()\n+            finally:\n+                try:\n+                    if current_pos is not None:\n+                        body.seek(current_pos, 0)\n+                    else:\n+                        body.seek(0, 0)\n+                except Exception:\n+                    pass\n+            self.headers['Content-Length'] = str(length)\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..e804512 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,18 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a real body is present and its length can be determined.\n+        # For requests without a body (e.g., typical GET requests), do not send Content-Length.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body: avoid sending a Content-Length header.\n+            # If the user explicitly provided a Content-Length header, leave it untouched.\n+            pass\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..6c3f08d 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,15 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present.\n+        # For requests without a body (e.g., typical GET), omit the header.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # else: no body, leave Content-Length unset\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "requests/models.py": [
          "\nfunction: PreparedRequest.prepare_content_length\nline: 389\nfunction: PreparedRequest.prepare_body\nline: 380"
        ]
      },
      "patches": [
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..bf8e6a0 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present or size is known.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not set Content-Length.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..b74431a 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,17 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if there is a body.\n+        if body is None:\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Compute length for file-like objects without forcing header on empty requests.\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n+            # For string/bytes-like bodies, use their length.\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..4c205f7 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,17 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when we actually have a body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body: do not send Content-Length header.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..44610fe 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if there is an actual body to send.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not add a Content-Length header.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..321d75c 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,8 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when we have a body or can determine its exact length.\n+        # This prevents sending Content-Length on methods like GET when there is no body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..d317bc2 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present or size can be determined.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, don't automatically add a Content-Length header.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..03b70f1 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,21 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present and its length can be determined.\n+        if body is None:\n+            # Do not set Content-Length for empty bodies (e.g., GET without data).\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n-            self.headers['Content-Length'] = str(len(body))\n+        else:\n+            try:\n+                self.headers['Content-Length'] = str(len(body))\n+            except (TypeError, AttributeError):\n+                # Length unknown; omit header.\n+                pass\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..33214a2 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when there is a request body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..af7ff57 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when there is a body or its length can be determined.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not set Content-Length automatically.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..d186dde 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,28 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a body is present, or for methods that\n+        # traditionally include a request body when empty (POST/PUT/PATCH).\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n-            self.headers['Content-Length'] = str(body.tell())\n+            size = body.tell()\n             body.seek(0, 0)\n+            if size > 0:\n+                self.headers['Content-Length'] = str(size)\n+            else:\n+                if getattr(self, 'method', '').upper() in ('POST', 'PUT', 'PATCH'):\n+                    self.headers.setdefault('Content-Length', '0')\n         elif body is not None:\n-            self.headers['Content-Length'] = str(len(body))\n+            try:\n+                clen = len(body)\n+            except (TypeError, AttributeError):\n+                clen = None\n+            if clen is not None:\n+                if clen > 0:\n+                    self.headers['Content-Length'] = str(clen)\n+                else:\n+                    if getattr(self, 'method', '').upper() in ('POST', 'PUT', 'PATCH'):\n+                        self.headers.setdefault('Content-Length', '0')\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "requests/models.py": [
          "\nfunction: PreparedRequest.prepare_content_length\nline: 388\nline: 389\nline: 390\nline: 391\nline: 392\nline: 393\nline: 394\nline: 395\nline: 396"
        ]
      },
      "patches": [
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..14ab5ce 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,7 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when a request body is present.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..c8e3bc9 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,14 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if we have a body and the header wasn't explicitly provided.\n+        if body is None or 'Content-Length' in self.headers:\n+            return\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..ac91d64 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,6 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..ca8cd48 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,17 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length if there is an actual body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body: ensure Content-Length is not set.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..a8f2569 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,19 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        \"\"\"Set Content-Length header only when a body is present.\n+\n+        For requests with no body (e.g., typical GET requests), do not send a Content-Length header.\n+        \"\"\"\n+        if body is None:\n+            # No body: do not add Content-Length.\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..ac91d64 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,6 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..3418862 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,7 +386,11 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when there is a body and length can be determined.\n+        # Do not automatically add Content-Length for requests without a body (e.g., GET).\n+        # Also, if the user explicitly provided Content-Length, respect it.\n+        if 'Content-Length' in self.headers:\n+            return\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..d3944e3 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,17 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when there is a body; do not send it for body-less requests.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n         elif body is not None:\n             self.headers['Content-Length'] = str(len(body))\n+        else:\n+            # No body; ensure Content-Length is not sent.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..013dbdb 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,16 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when there is a request body.\n+        # For methods like GET without a payload, omit the header entirely.\n+        if body is None:\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
        "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..c87bd9f 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,13 +386,20 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when we actually have a body to send.\n+        # Avoid sending Content-Length: 0 for methods like GET with no body.\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n+            # Determine size of file-like body without consuming it.\n+            curr_pos = body.tell()\n             body.seek(0, 2)\n-            self.headers['Content-Length'] = str(body.tell())\n-            body.seek(0, 0)\n+            length = body.tell()\n+            body.seek(curr_pos, 0)\n+            if not 'content-length' in self.headers:\n+                self.headers['Content-Length'] = str(length)\n         elif body is not None:\n-            self.headers['Content-Length'] = str(len(body))\n+            if not 'content-length' in self.headers:\n+                self.headers['Content-Length'] = str(len(body))\n+        # If body is None, do not add Content-Length automatically.\n \n     def prepare_auth(self, auth):\n         \"\"\"Prepares the given HTTP auth data.\"\"\"\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/requests/models.py b/requests/models.py\nindex 0d4482a..f6ba1aa 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -386,12 +386,18 @@ class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):\n         self.body = body\n \n     def prepare_content_length(self, body):\n-        self.headers['Content-Length'] = '0'\n+        # Only set Content-Length when we actually have a body.\n+        if body is None:\n+            # Ensure we don't send a Content-Length header for empty bodies.\n+            if 'Content-Length' in self.headers:\n+                del self.headers['Content-Length']\n+            return\n+\n         if hasattr(body, 'seek') and hasattr(body, 'tell'):\n             body.seek(0, 2)\n             self.headers['Content-Length'] = str(body.tell())\n             body.seek(0, 0)\n-        elif body is not None:\n+        else:\n             self.headers['Content-Length'] = str(len(body))\n \n     def prepare_auth(self, auth):\n",
  "7_resolved": true
}