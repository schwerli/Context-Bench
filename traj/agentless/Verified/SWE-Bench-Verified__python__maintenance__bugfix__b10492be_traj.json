{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__b10492be",
  "original_id": "django__django-15022",
  "1_model_selected_files": [
    "django/contrib/admin/options.py",
    "django/contrib/admin/views/main.py"
  ],
  "2_embedding_selected_files": [
    "django/contrib/admin/views/main.py",
    "django/contrib/admin/options.py",
    "django/contrib/admin/filters.py",
    "django/contrib/admin/exceptions.py",
    "django/db/models/__init__.py",
    "django/contrib/admin/checks.py",
    "django/db/models/sql/subqueries.py",
    "django/contrib/admin/views/__init__.py",
    "django/contrib/admin/views/autocomplete.py",
    "django/db/models/query_utils.py",
    "django/contrib/admin/widgets.py",
    "django/contrib/admin/__init__.py",
    "django/contrib/admin/utils.py",
    "django/db/models/fields/related.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/sql/query.py",
    "django/contrib/admin/sites.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/__init__.py",
    "django/db/models/query.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/models/sql/compiler.py",
    "django/contrib/admin/helpers.py",
    "django/db/models/lookups.py",
    "django/contrib/admin/actions.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/base.py",
    "django/db/models/manager.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/models/sql/where.py",
    "django/contrib/admin/apps.py",
    "django/contrib/admin/models.py",
    "django/db/backends/oracle/operations.py",
    "django/db/backends/sqlite3/base.py",
    "django/contrib/__init__.py",
    "django/db/models/sql/datastructures.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/backends/sqlite3/__init__.py",
    "django/db/migrations/__init__.py",
    "django/db/backends/postgresql/client.py",
    "django/db/backends/mysql/client.py",
    "django/contrib/admin/decorators.py",
    "django/db/backends/base/schema.py",
    "django/db/migrations/questioner.py",
    "django/db/backends/mysql/schema.py",
    "django/db/backends/sqlite3/client.py",
    "django/db/backends/base/features.py",
    "django/db/backends/postgresql/__init__.py",
    "django/db/models/expressions.py",
    "django/db/backends/__init__.py"
  ],
  "3_final_combined_files": [
    "django/contrib/admin/options.py",
    "django/contrib/admin/views/main.py",
    "django/contrib/admin/filters.py"
  ],
  "4_related_elements": {
    "django/contrib/admin/options.py": [
      "function: ModelAdmin.get_search_results\nfunction: ModelAdmin.get_search_fields\nfunction: BaseModelAdmin.get_queryset"
    ],
    "django/contrib/admin/views/main.py": [
      "class: ChangeList\nvariable: SEARCH_VAR\nvariable: IGNORED_PARAMS"
    ],
    "django/contrib/admin/filters.py": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/contrib/admin/options.py": [
          "\nfunction: ModelAdmin.get_search_results\nline: 1041"
        ]
      },
      "patches": [
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..24a8bd9 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single combined query to avoid redundant joins for each term.\n+            and_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries.append(or_queries)\n+            if and_queries:\n+                combined_q = and_queries[0]\n+                for q_obj in and_queries[1:]:\n+                    combined_q &= q_obj\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..a3114f4 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q = or_queries if combined_q is None else (combined_q & or_queries)\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..26c6808 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-term OR queries into a single ANDed Q and\n+            # apply filter once to avoid repeated JOINs for multi-word searches.\n+            term_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                term_queries.append(or_queries)\n+            if term_queries:\n+                combined_queries = term_queries[0]\n+                for q_obj in term_queries[1:]:\n+                    combined_queries = combined_queries & q_obj\n+                queryset = queryset.filter(combined_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..298fdbf 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_queries\n+                else:\n+                    combined_q &= or_queries\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..46c0dcf 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine per-word OR queries into a single ANDed filter to avoid\n+            # generating redundant JOINs for each word.\n+            and_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries.append(or_queries)\n+            if and_queries:\n+                queryset = queryset.filter(*and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..1a224e6 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all words into a single ANDed Q to avoid repeated JOINs per word.\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_queries\n+                else:\n+                    combined_q &= or_queries\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..92ff165 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-bit OR queries into a single ANDed Q to avoid\n+            # repeated .filter() calls that can generate unnecessary JOINs.\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q = or_queries if combined_q is None else (combined_q & or_queries)\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..ec58e79 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search terms into a single ANDed Q to avoid\n+            # repeated joins from multiple filter() calls.\n+            search_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if search_q is None:\n+                    search_q = or_queries\n+                else:\n+                    search_q &= or_queries\n+            if search_q is not None:\n+                queryset = queryset.filter(search_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..d711b58 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-word OR queries into a single ANDed Q to avoid\n+            # repeated joins from successive filter() calls.\n+            combined_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q &= or_queries\n+            if combined_q.children:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..9f9d837 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            and_queries = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if and_queries is None:\n+                    and_queries = or_queries\n+                else:\n+                    and_queries &= or_queries\n+            if and_queries is not None:\n+                queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/contrib/admin/options.py": [
          "\nfunction: ModelAdmin.get_search_results\nline: 1034\nline: 1035\nline: 1036\nline: 1037\nline: 1038\nline: 1039\nline: 1040\nline: 1041"
        ]
      },
      "patches": [
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..bccc562 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,19 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single combined Q object to avoid repeated joins\n+            # from chaining multiple queryset.filter() calls per search term.\n+            final_query = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n+                or_query = models.Q(\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                final_query &= or_query\n+            if final_query.children:\n+                queryset = queryset.filter(final_query)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..2b8d59c 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            bit_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                bit_queries.append(or_queries)\n+            if bit_queries:\n+                queryset = queryset.filter(*bit_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..82d51fc 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single combined Q to avoid repeated joins per search term bit.\n+            final_query = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                final_query = or_queries if final_query is None else (final_query & or_queries)\n+            if final_query is not None:\n+                queryset = queryset.filter(final_query)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..8fc016c 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build OR queries for each word and combine them with AND in a single filter\n+            bit_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                bit_queries.append(or_queries)\n+            if bit_queries:\n+                combined_q = bit_queries[0]\n+                for q in bit_queries[1:]:\n+                    combined_q &= q\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..a932c6a 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single ANDed Q object for all search terms to avoid\n+            # repeated filter() calls that can introduce redundant JOINs.\n+            base_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if base_q is None:\n+                    base_q = or_queries\n+                else:\n+                    base_q &= or_queries\n+            if base_q is not None:\n+                queryset = queryset.filter(base_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..1e8bbc2 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,10 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all terms into a single ANDed Q to avoid generating\n+            # redundant JOINs per term when filtering related fields.\n+            and_queries = models.Q()\n+            have_terms = False\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1042,10 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries &= or_queries\n+                have_terms = True\n+            if have_terms:\n+                queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..ea0ffc4 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-word OR queries into a single ANDed Q to avoid duplicate joins.\n+            combined_queries = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_queries = or_queries if combined_queries is None else (combined_queries & or_queries)\n+            if combined_queries is not None:\n+                queryset = queryset.filter(combined_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..e6ac1c6 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            and_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries.append(or_queries)\n+            if and_queries:\n+                combined_q = and_queries[0]\n+                for q in and_queries[1:]:\n+                    combined_q &= q\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..488a85b 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,21 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search bits into a single Q to avoid generating\n+            # unnecessary JOINs from multiple .filter() calls.\n+            bits = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n-                    *((orm_lookup, bit) for orm_lookup in orm_lookups),\n-                    _connector=models.Q.OR,\n-                )\n-                queryset = queryset.filter(or_queries)\n+                bits.append(bit)\n+            if bits:\n+                combined_q = models.Q()\n+                for bit in bits:\n+                    bit_q = models.Q()\n+                    for orm_lookup in orm_lookups:\n+                        bit_q |= models.Q(**{orm_lookup: bit})\n+                    combined_q &= bit_q\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..894eb18 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,18 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            bit_qs = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n-                    *((orm_lookup, bit) for orm_lookup in orm_lookups),\n-                    _connector=models.Q.OR,\n-                )\n-                queryset = queryset.filter(or_queries)\n+                # Build a single OR query for this search term across all search fields.\n+                or_queries = models.Q(_connector=models.Q.OR)\n+                for orm_lookup in orm_lookups:\n+                    or_queries |= models.Q(**{orm_lookup: bit})\n+                bit_qs.append(or_queries)\n+            if bit_qs:\n+                # Apply all term queries in a single filter call to avoid redundant JOINs.\n+                queryset = queryset.filter(*bit_qs)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/contrib/admin/options.py": [
          "\nfunction: ModelAdmin.get_search_results\nline: 1034\nline: 1035\nline: 1036\nline: 1037\nline: 1038\nline: 1039\nline: 1040\nline: 1041"
        ]
      },
      "patches": [
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..c6568c4 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            combined_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,8 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q &= or_queries\n+            queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..be7bd99 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            and_queries = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,8 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries &= or_queries\n+            queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..01505c7 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,19 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine per-word OR queries into a single ANDed Q to avoid\n+            # multiple filter() calls which can cause unnecessary JOINs.\n+            and_query = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n+                or_query = models.Q(\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_query = (and_query & or_query) if and_query is not None else or_query\n+            if and_query is not None:\n+                queryset = queryset.filter(and_query)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..a76f1c1 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all terms into a single ANDed query to avoid generating\n+            # unnecessary JOINs on each .filter() call.\n+            combined_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q &= or_queries\n+            if combined_q.children:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..d3ebe9f 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search terms into a single filter to avoid repeated JOINs.\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_queries\n+                else:\n+                    combined_q &= or_queries\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..492f698 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-word OR queries into a single ANDed Q to avoid\n+            # generating repeated joins from multiple .filter() calls.\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_queries\n+                else:\n+                    combined_q &= or_queries\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..9de17d0 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            bit_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                bit_queries.append(or_queries)\n+            if bit_queries:\n+                combined_q = bit_queries[0]\n+                for q in bit_queries[1:]:\n+                    combined_q &= q\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..41ce117 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-word OR queries into a single filter to avoid\n+            # generating unnecessary joins for each word in the search term.\n+            base_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,8 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                base_q &= or_queries\n+            queryset = queryset.filter(base_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..a8ddabd 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,18 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine per-word queries using AND to avoid generating\n+            # redundant joins for each word in the search term.\n+            combined_queries = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n-                    *((orm_lookup, bit) for orm_lookup in orm_lookups),\n-                    _connector=models.Q.OR,\n-                )\n-                queryset = queryset.filter(or_queries)\n+                # Build an OR query across all search fields for this word.\n+                or_queries = models.Q()\n+                for orm_lookup in orm_lookups:\n+                    or_queries |= models.Q(**{orm_lookup: bit})\n+                combined_queries &= or_queries\n+            queryset = queryset.filter(combined_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..718cbf5 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all per-word OR queries into a single ANDed Q and\n+            # apply filter once to avoid generating duplicate JOINs.\n+            search_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if search_q is None:\n+                    search_q = or_queries\n+                else:\n+                    search_q &= or_queries\n+            if search_q is not None:\n+                queryset = queryset.filter(search_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/contrib/admin/options.py": [
          "\nfunction: ModelAdmin.get_search_results\nline: 1034\nline: 1035\nline: 1036\nline: 1037\nline: 1038\nline: 1039\nline: 1040\nline: 1041\nline: 1042"
        ]
      },
      "patches": [
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..78bd2c9 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search terms into a single ANDed Q of ORed lookups\n+            and_queries = models.Q()\n+            has_terms = False\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,10 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries &= or_queries\n+                has_terms = True\n+            if has_terms:\n+                queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..c861399 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all query terms into a single ANDed Q to avoid\n+            # creating redundant JOINs for each word in the search.\n+            combined_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,8 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                combined_q &= or_queries\n+            queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..693796d 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,19 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search terms into a single Q object to avoid\n+            # generating repeated JOINs for related lookups.\n+            combined_q = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n-                    *((orm_lookup, bit) for orm_lookup in orm_lookups),\n-                    _connector=models.Q.OR,\n-                )\n-                queryset = queryset.filter(or_queries)\n+                # OR across all search fields for this bit.\n+                or_q = models.Q()\n+                for orm_lookup in orm_lookups:\n+                    or_q |= models.Q(**{orm_lookup: bit})\n+                # AND across bits.\n+                combined_q &= or_q\n+            queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..a17d7fb 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine per-word OR queries into a single AND filter to avoid\n+            # generating redundant JOINs for each word in the search term.\n+            and_queries = models.Q(_connector=models.Q.AND)\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,8 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries &= or_queries\n+            queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..e9e59f2 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,9 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Combine all search terms into a single Q object to avoid\n+            # creating redundant JOINs by calling filter() repeatedly.\n+            and_queries = models.Q()\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1041,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries &= or_queries\n+            if and_queries.children:\n+                queryset = queryset.filter(and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..298fdbf 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_queries\n+                else:\n+                    combined_q &= or_queries\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..6ef1512 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,7 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            and_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1039,9 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries.append(or_queries)\n+            if and_queries:\n+                queryset = queryset.filter(*and_queries)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..8295555 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,20 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            combined_q = None\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n+                or_q = models.Q(\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                if combined_q is None:\n+                    combined_q = or_q\n+                else:\n+                    combined_q &= or_q\n+            if combined_q is not None:\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..44249a3 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,20 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single combined Q to avoid generating redundant JOINs per term.\n+            terms = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n-                    *((orm_lookup, bit) for orm_lookup in orm_lookups),\n-                    _connector=models.Q.OR,\n-                )\n-                queryset = queryset.filter(or_queries)\n+                terms.append(bit)\n+            if terms:\n+                combined_q = models.Q()\n+                for term in terms:\n+                    term_q = models.Q()\n+                    for orm_lookup in orm_lookups:\n+                        term_q |= models.Q(**{orm_lookup: term})\n+                    combined_q &= term_q\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
        "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..951934d 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,14 +1031,21 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build all per-term OR queries first, then apply a single AND-combined filter.\n+            bit_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n-                or_queries = models.Q(\n+                or_query = models.Q(\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                bit_queries.append(or_query)\n+            if bit_queries:\n+                combined_query = bit_queries[0]\n+                for q_obj in bit_queries[1:]:\n+                    combined_query &= q_obj\n+                queryset = queryset.filter(combined_query)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex ff74678..24a8bd9 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -1031,6 +1031,8 @@ class ModelAdmin(BaseModelAdmin):\n         if search_fields and search_term:\n             orm_lookups = [construct_search(str(search_field))\n                            for search_field in search_fields]\n+            # Build a single combined query to avoid redundant joins for each term.\n+            and_queries = []\n             for bit in smart_split(search_term):\n                 if bit.startswith(('\"', \"'\")) and bit[0] == bit[-1]:\n                     bit = unescape_string_literal(bit)\n@@ -1038,7 +1040,12 @@ class ModelAdmin(BaseModelAdmin):\n                     *((orm_lookup, bit) for orm_lookup in orm_lookups),\n                     _connector=models.Q.OR,\n                 )\n-                queryset = queryset.filter(or_queries)\n+                and_queries.append(or_queries)\n+            if and_queries:\n+                combined_q = and_queries[0]\n+                for q_obj in and_queries[1:]:\n+                    combined_q &= q_obj\n+                queryset = queryset.filter(combined_q)\n             may_have_duplicates |= any(\n                 lookup_spawns_duplicates(self.opts, search_spec)\n                 for search_spec in orm_lookups\n",
  "7_resolved": true
}