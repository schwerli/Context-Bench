{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__84effcbc",
  "original_id": "django__django-13158",
  "1_model_selected_files": [
    "django/db/models/query.py",
    "django/db/models/sql/query.py",
    "django/db/models/sql/compiler.py",
    "django/forms/models.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/query.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/sql/query.py",
    "django/db/models/query_utils.py",
    "django/forms/models.py",
    "django/db/models/expressions.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/where.py",
    "django/db/models/fields/related.py",
    "django/db/models/base.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/__init__.py",
    "django/db/models/deletion.py",
    "django/db/models/lookups.py",
    "django/forms/widgets.py",
    "django/db/migrations/questioner.py",
    "django/db/backends/oracle/operations.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/sql/datastructures.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/backends/mysql/schema.py",
    "django/db/models/manager.py",
    "django/db/models/options.py",
    "django/db/backends/base/schema.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/models/constraints.py",
    "django/forms/fields.py",
    "django/db/models/fields/__init__.py",
    "django/forms/formsets.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/models/aggregates.py",
    "django/db/migrations/operations/models.py",
    "django/db/backends/mysql/operations.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/models/functions/mixins.py",
    "django/db/migrations/autodetector.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/migrations/exceptions.py",
    "django/db/backends/oracle/schema.py",
    "django/db/migrations/operations/special.py",
    "django/db/migrations/operations/utils.py"
  ],
  "3_final_combined_files": [
    "django/db/models/query.py",
    "django/db/models/sql/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/subqueries.py"
  ],
  "4_related_elements": {
    "django/db/models/query.py": [
      "function: QuerySet.none\nfunction: QuerySet._combinator_query\nfunction: QuerySet.union\nfunction: QuerySet._chain\nclass: EmptyQuerySet"
    ],
    "django/db/models/sql/query.py": [
      "function: Query.combine\nfunction: Query.set_empty\nfunction: Query.is_empty"
    ],
    "django/db/models/sql/compiler.py": [
      "function: SQLCompiler.get_combinator_sql\nfunction: SQLCompiler.as_sql"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/sql/compiler.py": [
          "\nfunction: SQLCompiler.get_combinator_sql"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..03f414e 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # Short-circuit for explicitly empty combined queries (e.g., queryset.none()).\n+        # If the outer query has been marked as empty, the combined query must\n+        # return no rows regardless of its component queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..4ef9abc 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer combined queryset has been marked empty (e.g., via .none()),\n+        # return an empty result set rather than combining subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..a036406 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -431,6 +431,10 @@ class SQLCompiler:\n         return sql, params\n \n     def get_combinator_sql(self, combinator, all):\n+        # Short-circuit if the parent combined query is explicitly empty\n+        # (e.g., as a result of QuerySet.none()).\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         features = self.connection.features\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..4f940a7 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the overall combined query has been explicitly set to empty\n+        # (e.g., via QuerySet.none()), return no results regardless of the\n+        # state of the individual combined queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..3e0a871 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the parent combined query has been marked as empty (e.g., via QuerySet.none()),\n+        # the whole compound query should be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..32b2d43 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query itself has been marked as empty (e.g., via\n+        # QuerySet.none()), short-circuit and return no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..dbd16e8 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been set to return no results (e.g., via\n+        # QuerySet.none()), short-circuit and return an empty result set.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..2ae0806 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,12 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # Short-circuit if the overall combined query is empty (e.g., due to a\n+        # filter like pk__in=[] applied to the combined queryset). Without this,\n+        # the top-level emptiness would be ignored and the combined query could\n+        # return all rows from its parts.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..987f85e 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been explicitly set to return no results\n+        # (e.g., via QuerySet.none()), short-circuit to an empty result set.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..7fc1c1a 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been explicitly marked as empty (e.g., by\n+        # calling .none() on a combined queryset), propagate the emptiness to\n+        # ensure no results are returned instead of combining subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/sql/compiler.py": [
          "\nfunction: SQLCompiler.get_combinator_sql"
        ],
        "django/db/models/query.py": [
          "\nfunction: QuerySet.none"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..0583aaf 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,12 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined queryset has been explicitly set to empty (e.g. via\n+        # QuerySet.none()), respect that regardless of the subqueries' content.\n+        # Without this, a top-level .none() on a combined query could still\n+        # return results by combining its non-empty subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..10a590b 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query itself has been marked empty (e.g., via\n+        # QuerySet.none()), respect that and return no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex e0d8d05..10d46e6 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -920,6 +920,14 @@ class QuerySet:\n         \"\"\"Return an empty QuerySet.\"\"\"\n         clone = self._chain()\n         clone.query.set_empty()\n+        # If the queryset is a compound query (e.g., UNION/INTERSECTION/DIFFERENCE),\n+        # clear combinator and combined queries to ensure an empty result.\n+        try:\n+            clone.query.combinator = None\n+            clone.query.combined_queries = ()\n+        except AttributeError:\n+            # Attributes may not exist on some query implementations.\n+            pass\n         return clone\n \n     ##################################################################\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..0ee0f3f 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer combined query has been explicitly marked empty (e.g.,\n+        # via QuerySet.none()), the whole combined query should be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..960581c 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been set to empty (e.g., via QuerySet.none()),\n+        # the combined query must also be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..295161a 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the top-level combined query has been explicitly set to empty\n+        # (e.g., via QuerySet.none()), the whole result should be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..419f516 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been marked as empty (e.g., via QuerySet.none()),\n+        # ensure an empty result regardless of the combined subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..b948a18 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -431,6 +431,11 @@ class SQLCompiler:\n         return sql, params\n \n     def get_combinator_sql(self, combinator, all):\n+        # If the top-level combined query has been explicitly marked as empty\n+        # (e.g., via QuerySet.none()), return no results regardless of its\n+        # component queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         features = self.connection.features\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..45bc819 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the top-level combined query has been set to empty (e.g., via\n+        # QuerySet.none()), ensure no results are returned regardless of the\n+        # child queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..30504a7 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,18 +432,25 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n-        compilers = [\n-            query.get_compiler(self.using, self.connection)\n-            for query in self.query.combined_queries if not query.is_empty()\n+        # If the outer combined query itself has been marked empty (e.g. via\n+        # QuerySet.none()), the overall result must be empty regardless of any\n+        # subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n+        # Build aligned (query, compiler) pairs for all non-empty subqueries.\n+        subqueries = [\n+            (query, query.get_compiler(self.using, self.connection))\n+            for query in self.query.combined_queries\n+            if not query.is_empty()\n         ]\n         if not features.supports_slicing_ordering_in_compound:\n-            for query, compiler in zip(self.query.combined_queries, compilers):\n+            for query, compiler in subqueries:\n                 if query.low_mark or query.high_mark:\n                     raise DatabaseError('LIMIT/OFFSET not allowed in subqueries of compound statements.')\n                 if compiler.get_order_by():\n                     raise DatabaseError('ORDER BY not allowed in subqueries of compound statements.')\n         parts = ()\n-        for compiler in compilers:\n+        for query, compiler in subqueries:\n             try:\n                 # If the columns list is limited, then all combined queries\n                 # must have the same columns list. Set the selects defined on\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/sql/compiler.py": [
          "\nfunction: SQLCompiler.get_combinator_sql\nline: 435"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..8d88eac 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been explicitly marked empty (e.g., via\n+        # .none()), respect that and return an empty result set regardless of\n+        # the state of the individual subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..cdcd3ed 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer combined query was emptied (e.g., via QuerySet.none()),\n+        # the result must be empty regardless of the state of its components.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..fd537cb 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer combined query was turned into an empty queryset\n+        # (e.g., via QuerySet.none()), short-circuit and return no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..9bb362f 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # Short-circuit if the overall combined query has been explicitly set\n+        # to return no results (e.g., via QuerySet.none()).\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..dd87255 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been explicitly set to empty (e.g., via .none()),\n+        # short-circuit and return an empty result set regardless of subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..ff146dc 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query itself has been marked as empty (e.g., via .none()),\n+        # short-circuit and return an empty result set instead of compiling subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..7481398 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query itself has been marked empty (e.g., via qs.none()),\n+        # return no results instead of evaluating subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..a29cf56 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the overall combined query has been explicitly marked as empty\n+        # (e.g., via QuerySet.none()), short-circuit and return no results.\n+        # This must take precedence over any non-empty subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..dcde8ea 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query has been explicitly marked as empty (e.g., via\n+        # QuerySet.none()), respect that and return no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..0a65032 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -431,6 +431,10 @@ class SQLCompiler:\n         return sql, params\n \n     def get_combinator_sql(self, combinator, all):\n+        # If the top-level combined query has been marked as empty (e.g. via\n+        # QuerySet.none()), short-circuit and return an empty result.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         features = self.connection.features\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/sql/compiler.py": [
          "\nfunction: SQLCompiler.get_combinator_sql"
        ],
        "django/db/models/sql/query.py": [
          "\nfunction: Query.set_empty"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..ea47575 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been marked as empty (e.g., via QuerySet.none()),\n+        # the combined result must also be empty regardless of the inner queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..50f8dc6 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been marked as empty (e.g., QuerySet.none()),\n+        # return an empty result set instead of combining subqueries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..23a67d1 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the base combined query is empty (e.g., via QuerySet.none()),\n+        # the entire compound statement must be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..d58f402 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the base query has been set to empty (e.g., through QuerySet.none()),\n+        # the entire combined query must be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..7d6ff4f 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the parent combined query has been marked as empty (e.g., via QuerySet.none()),\n+        # the whole combined query must be empty.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..cec0cbc 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the combined query itself has been marked empty (e.g., via .none()),\n+        # short-circuit and return no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..2e14c9a 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the parent combined query was marked as empty (e.g., via .none()\n+        # or an empty __in filter), short-circuit with an empty result.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..6c4238f 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been marked as empty (e.g., via QuerySet.none()),\n+        # ensure the combined query returns no results.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..6113260 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,10 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # If the outer query has been explicitly marked as empty (e.g., via\n+        # QuerySet.none()), the whole combined query must be empty as well.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 55bdae8..d0c7e1c 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -1776,9 +1776,20 @@ class Query(BaseExpression):\n         return condition, needed_inner\n \n     def set_empty(self):\n-        self.where.add(NothingNode(), AND)\n+        # If this is a combined query (e.g., UNION/INTERSECTION/DIFFERENCE),\n+        # propagate emptiness to all component queries so that compilation\n+        # recognizes the combined query as empty.\n+        if getattr(self, 'combinator', None):\n+            for q in self.combined_queries:\n+                q.set_empty()\n+        else:\n+            self.where.add(NothingNode(), AND)\n \n     def is_empty(self):\n+        # A query is empty if its WHERE contains a NothingNode. For combined\n+        # queries, consider it empty only if all component queries are empty.\n+        if getattr(self, 'combinator', None):\n+            return all(q.is_empty() for q in self.combined_queries)\n         return any(isinstance(c, NothingNode) for c in self.where.children)\n \n     def set_limits(self, low=None, high=None):\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 59c0764..03f414e 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -432,6 +432,11 @@ class SQLCompiler:\n \n     def get_combinator_sql(self, combinator, all):\n         features = self.connection.features\n+        # Short-circuit for explicitly empty combined queries (e.g., queryset.none()).\n+        # If the outer query has been marked as empty, the combined query must\n+        # return no rows regardless of its component queries.\n+        if self.query.is_empty():\n+            raise EmptyResultSet\n         compilers = [\n             query.get_compiler(self.using, self.connection)\n             for query in self.query.combined_queries if not query.is_empty()\n",
  "7_resolved": true
}