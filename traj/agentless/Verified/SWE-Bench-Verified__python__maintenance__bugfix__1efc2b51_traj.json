{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__1efc2b51",
  "original_id": "django__django-16485",
  "1_model_selected_files": [
    "django/template/defaultfilters.py",
    "django/utils/numberformat.py"
  ],
  "2_embedding_selected_files": [
    "django/utils/formats.py",
    "django/utils/numberformat.py",
    "django/utils/dateformat.py",
    "django/template/defaultfilters.py",
    "django/utils/dateparse.py",
    "django/utils/dates.py",
    "django/utils/http.py",
    "django/utils/duration.py",
    "django/utils/text.py",
    "django/utils/__init__.py",
    "django/utils/html.py",
    "django/utils/hashable.py",
    "django/utils/encoding.py",
    "django/template/exceptions.py",
    "django/utils/itercompat.py",
    "django/template/response.py",
    "django/utils/translation/template.py",
    "django/template/base.py",
    "django/utils/ipv6.py",
    "django/utils/crypto.py",
    "django/utils/translation/__init__.py",
    "django/utils/safestring.py",
    "django/utils/timezone.py",
    "django/utils/version.py",
    "django/utils/asyncio.py",
    "django/shortcuts.py",
    "django/utils/termcolors.py",
    "django/setup.py",
    "django/template/defaulttags.py",
    "django/utils/deconstruct.py",
    "django/template/utils.py",
    "django/utils/translation/trans_null.py",
    "django/utils/regex_helper.py",
    "django/template/loader.py",
    "django/utils/_os.py",
    "django/__init__.py",
    "django/template/__init__.py",
    "django/utils/inspect.py",
    "django/utils/log.py",
    "django/template/loader_tags.py",
    "django/utils/archive.py",
    "django/utils/timesince.py",
    "django/template/smartif.py",
    "django/template/engine.py",
    "django/template/context_processors.py",
    "django/utils/translation/trans_real.py",
    "django/template/autoreload.py",
    "django/utils/deprecation.py",
    "django/utils/functional.py",
    "django/template/library.py",
    "django/utils/autoreload.py",
    "django/utils/xmlutils.py",
    "django/utils/jslex.py",
    "django/utils/decorators.py",
    "django/utils/cache.py",
    "django/template/context.py",
    "django/utils/feedgenerator.py",
    "django/utils/module_loading.py",
    "django/utils/datastructures.py",
    "django/utils/translation/reloader.py",
    "django/utils/lorem_ipsum.py",
    "django/__main__.py",
    "django/utils/connection.py",
    "django/utils/tree.py"
  ],
  "3_final_combined_files": [
    "django/utils/numberformat.py",
    "django/template/defaultfilters.py",
    "django/utils/formats.py",
    "django/utils/dateformat.py"
  ],
  "4_related_elements": {
    "django/template/defaultfilters.py": [
      "function: floatformat"
    ],
    "django/utils/formats.py": [
      "function: number_format"
    ],
    "django/utils/numberformat.py": [
      "function: format"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 186"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..b03e7d9 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,9 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements,\n+    # e.g., for inputs like Decimal('0.00') where units can be negative.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..608d02f 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -179,11 +179,12 @@ def floatformat(text, arg=-1):\n         )\n \n     exp = Decimal(1).scaleb(-abs(p))\n-    # Set the precision high enough to avoid an exception (#15789).\n+    # Set the precision high enough to avoid an exception (#15789) and ensure\n+    # the context precision is at least 1 to avoid ValueError for inputs like \"0.00\".\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..fd6860c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid invalid Context precision for cases like \"0.00\" with p=0.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..5818dc6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -184,6 +184,10 @@ def floatformat(text, arg=-1):\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n     prec = abs(p) + units + 1\n+    # Ensure the Decimal context precision is at least 1 to avoid\n+    # ValueError: valid range for prec is [1, MAX_PREC] on values like \"0.00\".\n+    if prec < 1:\n+        prec = 1\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..8096fec 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError: valid range for prec is [1, MAX_PREC].\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..7a356c4 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,9 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure the Decimal context precision is at least 1 to avoid\n+    # \"ValueError: valid range for prec is [1, MAX_PREC]\" for values like 0.00.\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..5eaf281 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -179,11 +179,11 @@ def floatformat(text, arg=-1):\n         )\n \n     exp = Decimal(1).scaleb(-abs(p))\n-    # Set the precision high enough to avoid an exception (#15789).\n+    # Set the precision high enough to avoid an exception (#15789) and ensure it's at least 1.\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..a51ede1 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -184,6 +184,10 @@ def floatformat(text, arg=-1):\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n     prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError when units is negative\n+    # (e.g., for values like Decimal('0.00')).\n+    if prec < 1:\n+        prec = 1\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..295b95f 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid Context(prec=0) which raises ValueError (#15789).\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..46214e6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -184,6 +184,9 @@ def floatformat(text, arg=-1):\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n     prec = abs(p) + units + 1\n+    # Ensure the Decimal context precision is at least 1 to avoid ValueError.\n+    if prec < 1:\n+        prec = 1\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 186"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..d8128ef 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid Context(prec=0) errors for inputs like \"0.00\".\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..d375150 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -184,6 +184,9 @@ def floatformat(text, arg=-1):\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n     prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError: valid range for prec is [1, MAX_PREC].\n+    if prec < 1:\n+        prec = 1\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..14dc8a3 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError for cases like Decimal('0.00') with p=0.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..3a22fa6 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError on Context(prec=0)\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..d26c9d3 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError for inputs like \"0.00\".\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..3daa733 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid Context(prec=0) errors, e.g., for \"0.00\" with p=0.\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..554958b 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure the context precision is at least 1 to avoid ValueError on zeros.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..8d6407f 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -179,11 +179,11 @@ def floatformat(text, arg=-1):\n         )\n \n     exp = Decimal(1).scaleb(-abs(p))\n-    # Set the precision high enough to avoid an exception (#15789).\n+    # Set the precision high enough to avoid an exception (#15789) and\n+    # avoid invalid precision (e.g., for 0.00 with p=0).\n     tupl = d.as_tuple()\n-    units = len(tupl[1])\n-    units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    units = len(tupl[1]) + abs(tupl[2])\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nfunction: floatformat\nline: 186"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c6547b9 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal.Context requirements.\n+    prec = max(abs(p) + units + 1, 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c13d026 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -184,6 +184,11 @@ def floatformat(text, arg=-1):\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n     prec = abs(p) + units + 1\n+    if prec < 1:\n+        # Ensure a valid precision for the decimal context. Some inputs like\n+        # Decimal('0.00') with a precision argument of 0 can yield prec=0,\n+        # which is invalid for Decimal Context. Clamp to at least 1.\n+        prec = 1\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..018ae1e 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -179,11 +179,12 @@ def floatformat(text, arg=-1):\n         )\n \n     exp = Decimal(1).scaleb(-abs(p))\n-    # Set the precision high enough to avoid an exception (#15789).\n+    # Set the precision high enough to avoid an exception (#15789) and ensure\n+    # it is at least 1 to satisfy the Decimal context requirements.\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..1b6339c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context constraints (#36091).\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..2f63aaf 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid Context(prec=0) errors.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c07100e 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,7 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c07100e 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,7 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c90a8bb 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,9 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure the context precision is at least 1 to avoid ValueError on cases\n+    # like Decimal('0.00') with p=0 where the computed precision can be 0.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..46c7e96 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -182,8 +182,12 @@ def floatformat(text, arg=-1):\n     # Set the precision high enough to avoid an exception (#15789).\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n-    units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Use the exponent sign rather than fractional-part check to avoid negative\n+    # unit counts for values like Decimal('0.00'), which would yield a precision\n+    # of 0 and crash Context(prec=prec).\n+    units += -tupl[2] if tupl[2] < 0 else tupl[2]\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/template/defaultfilters.py": [
          "\nline: 186"
        ]
      },
      "patches": [
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..3b00e6f 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError from Context.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..39bb030 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal's Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..9c71596 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Clamp precision to at least 1 to satisfy Decimal.Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..c059b4c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError for zeros like Decimal('0.00').\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..5d550ef 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure a minimum precision of 1 to avoid ValueError for cases like Decimal('0.00') with p=0.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..571403c 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError: valid range for prec is [1, MAX_PREC].\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
        "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..ba0b62d 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to avoid ValueError for Context(prec=0).\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/template/defaultfilters.py b/django/template/defaultfilters.py\nindex edd25c0..da42b14 100644\n--- a/django/template/defaultfilters.py\n+++ b/django/template/defaultfilters.py\n@@ -183,7 +183,8 @@ def floatformat(text, arg=-1):\n     tupl = d.as_tuple()\n     units = len(tupl[1])\n     units += -tupl[2] if m else tupl[2]\n-    prec = abs(p) + units + 1\n+    # Ensure precision is at least 1 to satisfy Decimal Context requirements.\n+    prec = max(1, abs(p) + units + 1)\n \n     # Avoid conversion to scientific notation by accessing `sign`, `digits`,\n     # and `exponent` from Decimal.as_tuple() directly.\n",
  "7_resolved": true
}