{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__e989ba2d",
  "original_id": "psf__requests-6028",
  "1_model_selected_files": [
    "requests/adapters.py",
    "requests/sessions.py",
    "requests/utils.py",
    "requests/auth.py",
    "requests/models.py"
  ],
  "2_embedding_selected_files": [
    "requests/__init__.py",
    "requests/adapters.py",
    "requests/utils.py",
    "requests/auth.py",
    "requests/packages.py",
    "requests/help.py",
    "requests/compat.py",
    "requests/__version__.py",
    "requests/setup.py",
    "requests/exceptions.py",
    "requests/status_codes.py",
    "requests/api.py",
    "requests/sessions.py",
    "requests/models.py",
    "requests/cookies.py",
    "requests/certs.py",
    "requests/_internal_utils.py",
    "requests/structures.py",
    "requests/hooks.py"
  ],
  "3_final_combined_files": [
    "requests/adapters.py",
    "requests/utils.py",
    "requests/sessions.py",
    "requests/__init__.py"
  ],
  "4_related_elements": {
    "requests/adapters.py": [
      "class: HTTPAdapter"
    ],
    "requests/utils.py": [
      "function: should_bypass_proxies\nfunction: get_environ_proxies\nfunction: select_proxy\nfunction: resolve_proxies\nfunction: get_auth_from_url\nfunction: urldefragauth"
    ],
    "requests/sessions.py": [
      "class: SessionRedirectMixin\nclass: Session"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "requests/sessions.py": [
          "\nfunction: Session.rebuild_proxies\nline: 296\nline: 297"
        ]
      },
      "patches": [
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b7c3cb8 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -288,13 +288,15 @@ class SessionRedirectMixin(object):\n         if 'Proxy-Authorization' in headers:\n             del headers['Proxy-Authorization']\n \n-        try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n-        except KeyError:\n+        proxy_url = new_proxies.get(scheme)\n+        if proxy_url:\n+            username, password = get_auth_from_url(proxy_url)\n+        else:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Send Proxy-Authorization if either credential is present; empty values are valid in Basic auth.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..cd72f37 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Build Proxy-Authorization header if any credential is present.\n+        # Empty passwords are valid; avoid truthiness checks that drop them.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b4970d6 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Set Proxy-Authorization if any credentials are provided, even if password is empty.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..f72744a 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Set Proxy-Authorization if either credential is present (empty values allowed).\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..a65d907 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Set Proxy-Authorization if username is present, even if the password is empty.\n+        # Python 3.8.12's urllib.parse may return an empty string for password; treat that as valid.\n+        if username is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username, password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..0c6eee7 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Set Proxy-Authorization if a username is present; allow empty passwords.\n+        if username is not None:\n+            if password is None:\n+                password = ''\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..023cffe 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,15 +285,13 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n-        if 'Proxy-Authorization' in headers:\n-            del headers['Proxy-Authorization']\n-\n         try:\n             username, password = get_auth_from_url(new_proxies[scheme])\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Only set/override Proxy-Authorization when proxy credentials are present.\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..d23719c 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,15 +285,14 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n-        if 'Proxy-Authorization' in headers:\n-            del headers['Proxy-Authorization']\n-\n+        # Preserve any existing Proxy-Authorization header set by the user or previous request.\n         try:\n             username, password = get_auth_from_url(new_proxies[scheme])\n         except KeyError:\n             username, password = None, None\n \n         if username and password:\n+            # Override or set Proxy-Authorization based on proxy URL credentials.\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..774b097 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Build Proxy-Authorization header even when username/password are empty strings.\n+        # Some Python versions (e.g., 3.8.12) may return empty strings from URL parsing,\n+        # and the previous truthiness check prevented sending auth, causing 407 responses.\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..fe43ace 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Set Proxy-Authorization if either username or password is present.\n+        # Use empty strings for missing parts to avoid TypeError in _basic_auth_str.\n+        if username or password:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "requests/utils.py": [
          "\nfunction: get_auth_from_url"
        ],
        "requests/sessions.py": [
          "\nfunction: Session.rebuild_proxies\nline: 296"
        ]
      },
      "patches": [
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..9df44ea 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Build Proxy-Authorization if any auth info is present.\n+        # Allow empty password; only skip when no auth components exist.\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..127c2a9 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -986,16 +986,31 @@ def get_auth_from_url(url):\n     \"\"\"Given a url with authentication components, extract them into a tuple of\n     username,password.\n \n-    :rtype: (str,str)\n+    If no authentication information is present, returns (None, None).\n+    If one of the components is missing it will be returned as an empty string.\n+\n+    :rtype: (str,str) or (None,None)\n     \"\"\"\n     parsed = urlparse(url)\n \n+    username = getattr(parsed, 'username', None)\n+    password = getattr(parsed, 'password', None)\n+\n+    # No auth info at all\n+    if username is None and password is None:\n+        return (None, None)\n+\n+    # Safely unquote present components; treat missing as empty string\n+    try:\n+        u = unquote(username) if isinstance(username, str) else ''\n+    except Exception:\n+        u = ''\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        p = unquote(password) if isinstance(password, str) else ''\n+    except Exception:\n+        p = ''\n \n-    return auth\n+    return (u, p)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b35318f 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Build Proxy-Authorization even if the password is empty.\n+        if username:\n+            if password is None:\n+                password = ''\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..667a638 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -986,16 +986,25 @@ def get_auth_from_url(url):\n     \"\"\"Given a url with authentication components, extract them into a tuple of\n     username,password.\n \n+    Empty passwords are allowed and will be returned as an empty string.\n+\n     :rtype: (str,str)\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    # Handle missing components gracefully. urllib.parse may return None for\n+    # username or password if they are not present in the URL.\n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Normalize to strings, preserving empty passwords.\n+    if username is None and password is None:\n+        return ('', '')\n+\n+    username = unquote(username) if username is not None else ''\n+    password = unquote(password) if password is not None else ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..284a8aa 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,22 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    # Handle None values for username/password independently to avoid dropping a valid\n+    # component when the other is missing (e.g., Python 3.8.12 may return None).\n+    username = parsed.username\n+    password = parsed.password\n+\n+    if isinstance(username, str):\n+        username = unquote(username)\n+    else:\n+        username = ''\n+\n+    if isinstance(password, str):\n+        password = unquote(password)\n+    else:\n+        password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..ed1a8d9 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -291,9 +291,11 @@ class SessionRedirectMixin(object):\n         try:\n             username, password = get_auth_from_url(new_proxies[scheme])\n         except KeyError:\n-            username, password = None, None\n+            username, password = '', ''\n \n-        if username and password:\n+        # Set Proxy-Authorization if any credential component is present,\n+        # allowing empty passwords which are valid in Basic Auth.\n+        if username or password:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..fc39c0c 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,28 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Safely handle None values returned by urlparse for missing user/password\n+    if username is not None:\n+        try:\n+            username = unquote(username)\n+        except (AttributeError, TypeError):\n+            # Fall back to the original value if unquoting fails unexpectedly\n+            pass\n+    else:\n+        username = ''\n+\n+    if password is not None:\n+        try:\n+            password = unquote(password)\n+        except (AttributeError, TypeError):\n+            pass\n+    else:\n+        password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b45da4f 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Allow empty password; build header if either username or password is present.\n+        if username or password:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..21eff7d 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,25 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Handle None values for username/password separately so that we don't\n+    # discard a provided username when the password is missing.\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        username = parsed.username\n+        password = parsed.password\n+    except AttributeError:\n+        return ('', '')\n \n-    return auth\n+    if username is None:\n+        username = ''\n+    else:\n+        username = unquote(username)\n+\n+    if password is None:\n+        password = ''\n+    else:\n+        password = unquote(password)\n+\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..72ac312 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Set Proxy-Authorization if any credentials were provided.\n+        # Empty passwords/usernames are valid for Basic auth.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..b700d64 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,24 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    username = parsed.username\n+    password = parsed.password\n+\n+    # If no auth present in the URL, return (None, None) so callers can detect absence\n+    if username is None and password is None:\n+        return (None, None)\n+\n+    # Allow empty usernames/passwords (e.g., 'user:@host' or ':pass@host')\n+    # and percent-decoding of provided values.\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        username = unquote(username) if username is not None else ''\n+        password = unquote(password) if password is not None else ''\n     except (AttributeError, TypeError):\n-        auth = ('', '')\n+        # Fallback: coerce to strings, treating None as empty\n+        username = '' if username is None else str(username)\n+        password = '' if password is None else str(password)\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..ab6ecdf 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Build Proxy-Authorization header if any credential is provided.\n+        if (username is not None) or (password is not None):\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..0051c33 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -984,18 +984,30 @@ def prepend_scheme_if_needed(url, new_scheme):\n \n def get_auth_from_url(url):\n     \"\"\"Given a url with authentication components, extract them into a tuple of\n-    username,password.\n+    (username, password). If auth components are absent, returns (None, None).\n \n-    :rtype: (str,str)\n+    :rtype: (Optional[str], Optional[str])\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Only unquote if values are present\n+    if username is not None:\n+        try:\n+            username = unquote(username)\n+        except Exception:\n+            # If unquoting fails, keep original\n+            pass\n+    if password is not None:\n+        try:\n+            password = unquote(password)\n+        except Exception:\n+            # If unquoting fails, keep original\n+            pass\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..64838b6 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,18 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n-\n-    return auth\n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Handle None values explicitly to avoid losing username or password\n+    if username is None and password is None:\n+        return ('', '')\n+    if username is None:\n+        username = ''\n+    if password is None:\n+        password = ''\n+\n+    return (unquote(username), unquote(password))\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..9e923cb 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,7 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..c48983b 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,21 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Return None for both when no auth info is present,\n+    # so callers can distinguish between missing and empty values.\n+    if username is None and password is None:\n+        return (None, None)\n+\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        username = unquote(username) if username is not None else None\n+        password = unquote(password) if password is not None else None\n     except (AttributeError, TypeError):\n-        auth = ('', '')\n+        return (None, None)\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..9e923cb 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,7 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..061d3ec 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,28 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    netloc = parsed.netloc\n+    if not netloc or '@' not in netloc:\n+        return None, None\n+\n+    # Extract userinfo from netloc and split into username/password\n+    userinfo, _ = netloc.rsplit('@', 1)\n+    if ':' in userinfo:\n+        username_raw, password_raw = userinfo.split(':', 1)\n+    else:\n+        username_raw, password_raw = userinfo, None\n+\n+    # Unquote components only if present, avoid clobbering one when the other is None\n+    try:\n+        username = unquote(username_raw) if username_raw is not None else None\n+    except (AttributeError, TypeError):\n+        username = None\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        password = unquote(password_raw) if password_raw is not None else None\n     except (AttributeError, TypeError):\n-        auth = ('', '')\n+        password = None\n \n-    return auth\n+    return username, password\n \n \n # Moved outside of function to avoid recompile every call\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "requests/utils.py": [
          "\nfunction: get_auth_from_url"
        ],
        "requests/sessions.py": [
          "\nfunction: Session.rebuild_proxies"
        ],
        "requests/adapters.py": [
          "\nfunction: HTTPAdapter.proxy_headers"
        ]
      },
      "patches": [
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..a00ba66 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,17 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    # Handle None values safely to avoid TypeError from unquote(None).\n+    username = parsed.username\n+    password = parsed.password\n+\n+    if username is None and password is None:\n+        return ('', '')\n+\n+    username = unquote(username) if username is not None else ''\n+    password = unquote(password) if password is not None else ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..d04b80e 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -984,14 +984,21 @@ def prepend_scheme_if_needed(url, new_scheme):\n \n def get_auth_from_url(url):\n     \"\"\"Given a url with authentication components, extract them into a tuple of\n-    username,password.\n+    (username, password). Values will be empty strings if missing.\n \n-    :rtype: (str,str)\n+    :rtype: (str, str)\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Ensure missing components are treated as empty strings.\n+    # In some Python versions (e.g., 3.8.12), parsed.password may be None\n+    # when no password is provided even if a username is present. Converting\n+    # None to '' avoids raising and preserves the username for auth.\n+    username = parsed.username or ''\n+    password = parsed.password or ''\n+\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        auth = (unquote(username), unquote(password))\n     except (AttributeError, TypeError):\n         auth = ('', '')\n \n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..178768b 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,32 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # In Python 3.8.12, parsed.username/parsed.password can be None if missing.\n+    # Preserve present values and default missing ones to empty strings.\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        username = parsed.username\n+        password = parsed.password\n+    except AttributeError:\n+        # Fallback if urlparse result is unexpected\n+        return ('', '')\n+\n+    if username is None:\n+        username = ''\n+    else:\n+        try:\n+            username = unquote(username)\n+        except (TypeError, AttributeError):\n+            username = ''\n+\n+    if password is None:\n+        password = ''\n+    else:\n+        try:\n+            password = unquote(password)\n+        except (TypeError, AttributeError):\n+            password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..7182a37 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,28 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    # In Python 3.8.12+, parsed.username/parsed.password may be None when not present.\n+    # Handle None per-field so that a missing password doesn't discard a provided username.\n+    username = parsed.username\n+    password = parsed.password\n+\n+    if username is None:\n+        username = ''\n+    else:\n+        try:\n+            username = unquote(username)\n+        except (TypeError, AttributeError):\n+            username = ''\n+\n+    if password is None:\n+        password = ''\n+    else:\n+        try:\n+            password = unquote(password)\n+        except (TypeError, AttributeError):\n+            password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..1159309 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,24 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Handle missing username/password values gracefully:\n+    # In some Python versions (e.g., 3.8.12), urlparse may return None for\n+    # missing components. Ensure we preserve the username even if the password\n+    # is absent.\n+    username = parsed.username if parsed.username is not None else ''\n+    password = parsed.password if parsed.password is not None else ''\n+\n+    # Percent-decode safely; if unexpected types are encountered, default to ''.\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        username = unquote(username)\n+    except (TypeError, AttributeError):\n+        username = ''\n+    try:\n+        password = unquote(password)\n+    except (TypeError, AttributeError):\n+        password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..2105d51 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,28 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n-    try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+    username = parsed.username\n+    password = parsed.password\n+\n+    # Normalize and unquote each component independently to avoid losing a valid username\n+    # when the password is missing (None) on some Python versions (e.g., 3.8.12).\n+    if username is None:\n+        username = ''\n+    else:\n+        try:\n+            username = unquote(username)\n+        except (AttributeError, TypeError):\n+            username = ''\n+\n+    if password is None:\n+        password = ''\n+    else:\n+        try:\n+            password = unquote(password)\n+        except (AttributeError, TypeError):\n+            password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..eb62709 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,18 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Safely handle missing username/password values to avoid dropping valid credentials\n+    # when one of them is None (e.g., due to parsing differences across Python versions).\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        username = unquote(parsed.username) if parsed.username is not None else ''\n     except (AttributeError, TypeError):\n-        auth = ('', '')\n+        username = ''\n+    try:\n+        password = unquote(parsed.password) if parsed.password is not None else ''\n+    except (AttributeError, TypeError):\n+        password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..ecf7862 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,21 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Preserve username even if password is missing (None), which can occur on some Python versions.\n+    username = parsed.username or ''\n+    password = parsed.password or ''\n+\n+    try:\n+        username = unquote(username)\n+    except (AttributeError, TypeError):\n+        username = ''\n+\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n+        password = unquote(password)\n     except (AttributeError, TypeError):\n-        auth = ('', '')\n+        password = ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/adapters.py b/requests/adapters.py\nindex d47134b..207923c 100644\n--- a/requests/adapters.py\n+++ b/requests/adapters.py\n@@ -386,9 +386,9 @@ class HTTPAdapter(BaseAdapter):\n         headers = {}\n         username, password = get_auth_from_url(proxy)\n \n-        if username:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username,\n-                                                             password)\n+        # Send Proxy-Authorization if either username or password is present\n+        if username or password:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return headers\n \ndiff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..bd2cf7d 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,12 +990,20 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Handle each component separately to avoid losing password when username is missing\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        user = parsed.username\n+    except AttributeError:\n+        user = None\n+    try:\n+        passwd = parsed.password\n+    except AttributeError:\n+        passwd = None\n+\n+    username = unquote(user) if user is not None else ''\n+    password = unquote(passwd) if passwd is not None else ''\n \n-    return auth\n+    return (username, password)\n \n \n # Moved outside of function to avoid recompile every call\n",
        "diff --git a/requests/utils.py b/requests/utils.py\nindex 90377ea..cd33de1 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -990,10 +990,28 @@ def get_auth_from_url(url):\n     \"\"\"\n     parsed = urlparse(url)\n \n+    # Handle None values for username/password separately to avoid losing one\n+    # when the other is missing (Python 3.8.12 may return None for empty fields).\n     try:\n-        auth = (unquote(parsed.username), unquote(parsed.password))\n-    except (AttributeError, TypeError):\n-        auth = ('', '')\n+        username = parsed.username\n+    except AttributeError:\n+        username = None\n+    try:\n+        password = parsed.password\n+    except AttributeError:\n+        password = None\n+\n+    if username is None:\n+        username = ''\n+    else:\n+        username = unquote(username)\n+\n+    if password is None:\n+        password = ''\n+    else:\n+        password = unquote(password)\n+\n+    auth = (username, password)\n \n     return auth\n \n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "requests/sessions.py": [
          "\nfunction: Session.rebuild_proxies\nline: 292\nline: 296\nline: 297\nline: 298"
        ]
      },
      "patches": [
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..ac042c1 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Set Proxy-Authorization header even if password is empty.\n+        # Basic auth allows an empty password; only skip when creds are truly absent.\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..2f9ad85 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,9 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Set Proxy-Authorization if credentials are present, even if empty strings.\n+        # Empty strings are valid in Basic auth and should not prevent header creation.\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..753a02d 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,8 +293,10 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Build Proxy-Authorization if any credentials are present,\n+        # even when username or password is empty.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..6c1e3ed 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,13 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Set Proxy-Authorization if either username or password is present.\n+        # This allows empty passwords and avoids 407 with Python 3.8.12 parsing changes.\n+        if username is not None or password is not None:\n+            if username is None:\n+                username = ''\n+            if password is None:\n+                password = ''\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..fcc3112 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -293,7 +293,8 @@ class SessionRedirectMixin(object):\n         except KeyError:\n             username, password = None, None\n \n-        if username and password:\n+        # Allow empty username/password; only skip if credentials are entirely absent (None).\n+        if username is not None and password is not None:\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..7563f51 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,16 +285,30 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n-        if 'Proxy-Authorization' in headers:\n-            del headers['Proxy-Authorization']\n-\n-        try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n-        except KeyError:\n-            username, password = None, None\n+        # Determine applicable proxy URL and extract any credentials.\n+        proxy_url = None\n+        if isinstance(new_proxies, dict):\n+            proxy_url = new_proxies.get(scheme)\n+            # Fallback: HTTPS requests often use the HTTP proxy entry.\n+            if proxy_url is None and scheme == 'https':\n+                proxy_url = new_proxies.get('http')\n+            # Some configurations may use a catch-all key.\n+            if proxy_url is None:\n+                proxy_url = new_proxies.get('all')\n+\n+        username = password = None\n+        if proxy_url:\n+            # Only rebuild Proxy-Authorization when we have a proxy URL to derive credentials from.\n+            if 'Proxy-Authorization' in headers:\n+                del headers['Proxy-Authorization']\n+            try:\n+                username, password = get_auth_from_url(proxy_url)\n+            except Exception:\n+                username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Send Proxy-Authorization if we have a username; allow empty passwords.\n+        if username is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username, password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..d1431eb 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,16 +285,22 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n+        # Remove any falsy proxy entries (e.g., empty strings or None) to avoid errors.\n+        new_proxies = {k: v for k, v in new_proxies.items() if v}\n+\n+        # Rebuild Proxy-Authorization header from proxy URL credentials, if present.\n         if 'Proxy-Authorization' in headers:\n             del headers['Proxy-Authorization']\n \n-        try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n-        except KeyError:\n-            username, password = None, None\n+        proxy = new_proxies.get(scheme)\n+        # Fallback to 'http' proxy credentials for HTTPS if a specific HTTPS proxy isn't provided.\n+        if not proxy and scheme == 'https':\n+            proxy = new_proxies.get('http')\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        if proxy:\n+            username, password = get_auth_from_url(proxy)\n+            if username and password:\n+                headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..bff533f 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -288,13 +288,14 @@ class SessionRedirectMixin(object):\n         if 'Proxy-Authorization' in headers:\n             del headers['Proxy-Authorization']\n \n-        try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n-        except KeyError:\n+        proxy = new_proxies.get(scheme)\n+        if proxy:\n+            username, password = get_auth_from_url(proxy)\n+        else:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b38c907 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,16 +285,22 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n-        if 'Proxy-Authorization' in headers:\n-            del headers['Proxy-Authorization']\n-\n+        # Determine credentials from the proxy URL without clobbering any user-provided header\n         try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n+            proxy_url = new_proxies[scheme]\n         except KeyError:\n+            proxy_url = None\n+\n+        try:\n+            username, password = get_auth_from_url(proxy_url) if proxy_url else (None, None)\n+        except Exception:\n+            # If parsing fails for any reason, do not alter existing headers.\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Build Proxy-Authorization whenever any credential component is present\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n+        # else: leave any existing Proxy-Authorization header untouched\n \n         return new_proxies\n \n",
        "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..cbfc36e 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -285,16 +285,28 @@ class SessionRedirectMixin(object):\n         scheme = urlparse(prepared_request.url).scheme\n         new_proxies = resolve_proxies(prepared_request, proxies, self.trust_env)\n \n-        if 'Proxy-Authorization' in headers:\n-            del headers['Proxy-Authorization']\n-\n+        # Determine proxy URL for this scheme, with a sensible fallback to 'http'\n+        proxy_url = None\n         try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n+            proxy_url = new_proxies[scheme]\n         except KeyError:\n-            username, password = None, None\n+            proxy_url = new_proxies.get('http')\n+\n+        username, password = None, None\n+        if proxy_url:\n+            try:\n+                username, password = get_auth_from_url(proxy_url)\n+            except ValueError:\n+                # Python 3.8.12's stricter URL parsing may raise on invalid auth;\n+                # ignore and avoid clobbering any existing header.\n+                username, password = None, None\n \n         if username and password:\n+            # Replace any existing Proxy-Authorization with the one from the proxy URL\n             headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        elif 'Proxy-Authorization' in headers and not proxy_url:\n+            # No proxy configured for this scheme; ensure we don't leak proxy creds.\n+            del headers['Proxy-Authorization']\n \n         return new_proxies\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 594e72b..b7c3cb8 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -288,13 +288,15 @@ class SessionRedirectMixin(object):\n         if 'Proxy-Authorization' in headers:\n             del headers['Proxy-Authorization']\n \n-        try:\n-            username, password = get_auth_from_url(new_proxies[scheme])\n-        except KeyError:\n+        proxy_url = new_proxies.get(scheme)\n+        if proxy_url:\n+            username, password = get_auth_from_url(proxy_url)\n+        else:\n             username, password = None, None\n \n-        if username and password:\n-            headers['Proxy-Authorization'] = _basic_auth_str(username, password)\n+        # Send Proxy-Authorization if either credential is present; empty values are valid in Basic auth.\n+        if username is not None or password is not None:\n+            headers['Proxy-Authorization'] = _basic_auth_str(username or '', password or '')\n \n         return new_proxies\n \n",
  "7_resolved": false
}