{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__31d4fe9d",
  "original_id": "django__django-14539",
  "1_model_selected_files": [
    "django/utils/html.py",
    "django/template/defaultfilters.py"
  ],
  "2_embedding_selected_files": [
    "django/utils/html.py",
    "django/utils/http.py",
    "django/utils/encoding.py",
    "django/utils/text.py",
    "django/utils/jslex.py",
    "django/utils/regex_helper.py",
    "django/utils/formats.py",
    "django/utils/safestring.py",
    "django/utils/ipv6.py",
    "django/shortcuts.py",
    "django/utils/feedgenerator.py",
    "django/utils/datetime_safe.py",
    "django/utils/dateformat.py",
    "django/utils/xmlutils.py",
    "django/utils/hashable.py",
    "django/utils/baseconv.py",
    "django/utils/lorem_ipsum.py",
    "django/utils/numberformat.py",
    "django/utils/cache.py",
    "django/utils/dates.py",
    "django/utils/dateparse.py",
    "django/utils/functional.py",
    "django/utils/deprecation.py",
    "django/utils/log.py",
    "django/utils/timesince.py",
    "django/utils/archive.py",
    "django/utils/asyncio.py",
    "django/utils/duration.py",
    "django/utils/crypto.py",
    "django/utils/termcolors.py",
    "django/utils/module_loading.py",
    "django/utils/timezone.py",
    "django/utils/datastructures.py",
    "django/utils/itercompat.py",
    "django/utils/_os.py",
    "django/utils/__init__.py",
    "django/utils/deconstruct.py",
    "django/utils/version.py",
    "django/utils/autoreload.py",
    "django/utils/inspect.py",
    "django/utils/decorators.py",
    "django/setup.py",
    "django/__init__.py",
    "django/utils/tree.py",
    "django/utils/topological_sort.py",
    "django/utils/connection.py",
    "django/__main__.py"
  ],
  "3_final_combined_files": [
    "django/utils/html.py",
    "django/template/defaultfilters.py",
    "django/utils/http.py",
    "django/utils/encoding.py"
  ],
  "4_related_elements": {
    "django/utils/html.py": [
      "variable: TRAILING_PUNCTUATION_CHARS\nvariable: WRAPPING_PUNCTUATION\nvariable: DOTS\nvariable: word_split_re\nvariable: simple_url_re\nvariable: simple_url_2_re\nfunction: smart_urlquote\nfunction: urlize"
    ],
    "django/template/defaultfilters.py": [
      "function: urlize\nfunction: urlizetrunc"
    ],
    "django/utils/http.py": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/utils/html.py": [
          "\nfunction: urlize.trim_punctuation\nline: 286\nline: 287"
        ]
      },
      "patches": [
        "",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..cb80385 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove the same number of trailing characters from the\n+                # original (escaped) string to avoid breaking HTML entities.\n+                n_removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-n_removed:] + trail\n+                middle = middle[:-n_removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..a82d1ee 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Move only the actual trailing punctuation characters. Compute\n+                # the count on the unescaped value to avoid breaking HTML entities.\n+                remove_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-remove_count:] + trail\n+                middle = middle[:-remove_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..8c4063c 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,9 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n-                trimmed_something = True\n+                removed = len(middle_unescaped) - len(stripped)\n+                if removed:\n+                    trail = middle[-removed:] + trail\n+                    middle = middle[:-removed]\n+                    trimmed_something = True\n         return lead, middle, trail\n \n     def is_email_simple(value):\n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..a794c52 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Move only the trailing punctuation characters (computed on the unescaped\n+                # string) from the original string to the trail, so that HTML entities\n+                # like '&lt' or '&amp;' aren't broken.\n+                removed_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..6596486 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,9 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..f70bf9f 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove the same number of trailing punctuation characters\n+                # from the original string, based on the unescaped difference.\n+                trimmed_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-trimmed_count:] + trail\n+                middle = middle[:-trimmed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..60214be 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,9 +283,14 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n-                trimmed_something = True\n+                # Compute how many trailing characters were stripped from the\n+                # unescaped value and remove the same number from the original\n+                # middle to preserve any entities.\n+                removed = len(middle_unescaped) - len(stripped)\n+                if removed:\n+                    trail = middle[-removed:] + trail\n+                    middle = middle[:-removed]\n+                    trimmed_something = True\n         return lead, middle, trail\n \n     def is_email_simple(value):\n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..99d8ebb 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove the same number of trailing characters from the original\n+                # string (middle) as were stripped from the unescaped version.\n+                strip_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-strip_count:] + trail\n+                middle = middle[:-strip_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        ""
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/utils/html.py": [
          "\nfunction: urlize\nline: 286\nline: 287"
        ]
      },
      "patches": [
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..5f1fdd5 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Number of trailing punctuation chars removed from the unescaped string.\n+                removed_count = len(middle_unescaped) - len(stripped)\n+                # Remove the same number of chars from the original string to avoid\n+                # misaligned slicing when entities change length on unescape.\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..06715dd 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -279,12 +279,15 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                     trimmed_something = True\n             # Trim trailing punctuation (after trimming wrapping punctuation,\n             # as encoded entities contain ';'). Unescape entities to avoid\n-            # breaking them by removing ';'.\n+            # breaking them by removing ';'. Compute removals from the end\n+            # to keep indices consistent with the original (possibly escaped)\n+            # string.\n             middle_unescaped = html.unescape(middle)\n-            stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n-            if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+            stripped_unescaped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n+            if middle_unescaped != stripped_unescaped:\n+                removed_count = len(middle_unescaped) - len(stripped_unescaped)\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..ad02ba8 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Determine how many characters were stripped from the end\n+                # of the unescaped string and remove the same number from\n+                # the original string to preserve entities like \"&lt;\".\n+                removed_chars = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed_chars:] + trail\n+                middle = middle[:-removed_chars]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..fe504ca 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,13 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Compute how many trailing punctuation chars were removed\n+                # from the unescaped string and remove the same number of\n+                # characters from the original string to avoid breaking\n+                # HTML entities like '&lt'.\n+                num_removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-num_removed:] + trail\n+                middle = middle[:-num_removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..e9ecc6b 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -279,12 +279,15 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                     trimmed_something = True\n             # Trim trailing punctuation (after trimming wrapping punctuation,\n             # as encoded entities contain ';'). Unescape entities to avoid\n-            # breaking them by removing ';'.\n+            # breaking them by removing ';'. Use lengths based on the\n+            # unescaped string to compute how many characters to trim from\n+            # the original (possibly escaped) string.\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                trimmed_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-trimmed_count:] + trail\n+                middle = middle[:-trimmed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..8433098 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,13 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Compute how many characters were stripped from the unescaped\n+                # representation and remove the same number of characters from\n+                # the original string. This avoids cutting into HTML entities\n+                # like \"&lt\" that don't end with a semicolon.\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..00ea5ff 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Calculate how many trailing characters were stripped from the\n+                # unescaped string and remove the same amount from the original\n+                # string to preserve any HTML entities intact.\n+                trimmed_len = len(middle_unescaped) - len(stripped)\n+                trail = middle[-trimmed_len:] + trail\n+                middle = middle[:-trimmed_len]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..46d229b 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,9 +283,14 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n-                trimmed_something = True\n+                # Calculate how many trailing punctuation characters were removed\n+                # from the unescaped string and remove the same number from the\n+                # original string to keep entity text intact.\n+                num_removed = len(middle_unescaped) - len(stripped)\n+                if num_removed > 0:\n+                    trail = middle[-num_removed:] + trail\n+                    middle = middle[:-num_removed]\n+                    trimmed_something = True\n         return lead, middle, trail\n \n     def is_email_simple(value):\n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..169fc4c 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,14 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Trim the same number of trailing characters from the original\n+                # string as were removed from the unescaped version. This avoids\n+                # corrupting entities like \"&lt\" by incorrectly slicing based on\n+                # unescaped lengths.\n+                remove = len(middle_unescaped) - len(stripped)\n+                if remove:\n+                    trail = middle[-remove:] + trail\n+                    middle = middle[:-remove]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..6596486 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,9 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/utils/html.py": [
          "\nfunction: urlize.trim_punctuation\nline: 286\nline: 287"
        ]
      },
      "patches": [
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..6596486 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,9 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..1d495fb 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Move only the stripped trailing punctuation to the trail,\n+                # computing lengths on the unescaped string but slicing the\n+                # original escaped \"middle\" to preserve entities.\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..0116e5a 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -279,12 +279,14 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                     trimmed_something = True\n             # Trim trailing punctuation (after trimming wrapping punctuation,\n             # as encoded entities contain ';'). Unescape entities to avoid\n-            # breaking them by removing ';'.\n+            # breaking them by removing ';'. Compare lengths to avoid mixing\n+            # escaped and unescaped lengths.\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..fad8ecb 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Determine how many trailing characters were stripped from the unescaped string,\n+                # then apply the same removal to the original (possibly escaped) string.\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..2323d52 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,9 +283,15 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n-                trimmed_something = True\n+                # Compute how many trailing punctuation characters were removed\n+                removed_len = len(middle_unescaped) - len(stripped)\n+                if removed_len > 0:\n+                    # Move exactly the removed punctuation from the escaped string to the trail\n+                    removed_part = middle[-removed_len:]\n+                    trail = removed_part + trail\n+                    # Trim the same number of characters from the end of the escaped middle\n+                    middle = middle[:-removed_len]\n+                    trimmed_something = True\n         return lead, middle, trail\n \n     def is_email_simple(value):\n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..371f2ad 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Move only the actual trailing punctuation from the original string\n+                # to the trail, regardless of any length changes caused by unescaping.\n+                num_stripped = len(middle_unescaped) - len(stripped)\n+                trail = middle[-num_stripped:] + trail\n+                middle = middle[:-num_stripped]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..98a0a7b 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Number of trailing punctuation characters removed from the unescaped string.\n+                removed = len(middle_unescaped) - len(stripped)\n+                # Move the same number of characters from the end of the original (escaped) string.\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..d408f27 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,9 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed_len = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed_len:] + trail\n+                middle = middle[:-removed_len]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        ""
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/utils/html.py": [
          "\nfunction: urlize.trim_punctuation\nline: 283\nline: 284\nline: 285\nline: 286\nline: 287\nline: 288"
        ]
      },
      "patches": [
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..6cf2329 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Compute how many trailing characters were stripped after unescaping.\n+                k = len(middle_unescaped) - len(stripped)\n+                # Move exactly those trailing characters from the original (possibly escaped) string.\n+                trail = middle[-k:] + trail\n+                middle = middle[:-k]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..e5fc6a5 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove only the trailing characters that were stripped from\n+                # the unescaped value to avoid miscalculating indices when\n+                # entities are present.\n+                removed_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..35b29a6 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove the same number of characters from the end of the original\n+                # (possibly entity-escaped) string to avoid breaking entities.\n+                num_removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-num_removed:] + trail\n+                middle = middle[:-num_removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..82ac156 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,13 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Move only the stripped trailing punctuation from the end of\n+                # the original string to the trail. Use lengths based on the\n+                # unescaped string to determine how many characters were removed.\n+                removed = len(middle_unescaped) - len(stripped)\n+                if removed > 0:\n+                    trail = middle[-removed:] + trail\n+                    middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..606b76e 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -279,12 +279,15 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                     trimmed_something = True\n             # Trim trailing punctuation (after trimming wrapping punctuation,\n             # as encoded entities contain ';'). Unescape entities to avoid\n-            # breaking them by removing ';'.\n+            # breaking them by removing ';'. Then compute the number of\n+            # trailing punctuation chars removed and slice from the end\n+            # of the original string so entities remain intact.\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..e58f967 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Compute how many trailing punctuation characters were removed\n+                # and trim that many characters from the original string to\n+                # preserve any entities without altering their content.\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..1cbed33 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Compute how many trailing punctuation characters were removed\n+                # from the unescaped representation and apply the same removal\n+                # to the original string to preserve any HTML entities.\n+                removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-removed:] + trail\n+                middle = middle[:-removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..10cebc7 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Remove the same number of trailing characters from the original\n+                # string to avoid mismatched slicing when entities change length.\n+                num_removed = len(middle_unescaped) - len(stripped)\n+                trail = middle[-num_removed:] + trail\n+                middle = middle[:-num_removed]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
        "",
        "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..5ee942f 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,7 +283,7 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n+                trail = middle[len(stripped) - len(middle_unescaped):] + trail\n                 middle = middle[:len(stripped) - len(middle_unescaped)]\n                 trimmed_something = True\n         return lead, middle, trail\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 809fc0f..5f1fdd5 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,12 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                # Number of trailing punctuation chars removed from the unescaped string.\n+                removed_count = len(middle_unescaped) - len(stripped)\n+                # Remove the same number of chars from the original string to avoid\n+                # misaligned slicing when entities change length on unescape.\n+                trail = middle[-removed_count:] + trail\n+                middle = middle[:-removed_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \n",
  "7_resolved": true
}