{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__5c1509d5",
  "original_id": "django__django-15695",
  "1_model_selected_files": [
    "django/db/migrations/operations/models.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/backends/base/schema.py"
  ],
  "2_embedding_selected_files": [
    "django/db/migrations/operations/models.py",
    "django/db/models/indexes.py",
    "django/db/migrations/operations/fields.py",
    "django/db/backends/mysql/schema.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/migrations/operations/__init__.py",
    "django/db/backends/base/schema.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/models/base.py",
    "django/db/migrations/operations/base.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/migrations/operations/special.py",
    "django/db/backends/postgresql/creation.py",
    "django/db/backends/oracle/schema.py",
    "django/db/migrations/autodetector.py",
    "django/db/migrations/migration.py",
    "django/db/models/fields/related.py",
    "django/db/migrations/state.py",
    "django/db/backends/sqlite3/creation.py",
    "django/db/migrations/__init__.py",
    "django/db/backends/mysql/operations.py",
    "django/db/backends/mysql/creation.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/migrations/executor.py",
    "django/db/models/sql/query.py",
    "django/db/migrations/optimizer.py",
    "django/db/migrations/exceptions.py",
    "django/db/models/constraints.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/backends/postgresql/__init__.py",
    "django/db/backends/postgresql/features.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/models/deletion.py",
    "django/db/backends/mysql/features.py",
    "django/db/migrations/writer.py",
    "django/db/backends/base/creation.py",
    "django/db/backends/sqlite3/__init__.py",
    "django/db/backends/mysql/introspection.py",
    "django/db/backends/oracle/features.py",
    "django/db/backends/sqlite3/features.py",
    "django/db/backends/ddl_references.py",
    "django/db/backends/utils.py",
    "django/db/backends/base/operations.py",
    "django/db/backends/base/__init__.py",
    "django/db/migrations/questioner.py",
    "django/db/backends/postgresql/base.py",
    "django/db/models/query.py",
    "django/db/backends/base/base.py",
    "django/db/migrations/recorder.py",
    "django/db/migrations/loader.py",
    "django/db/backends/__init__.py",
    "django/db/backends/base/features.py",
    "django/db/backends/mysql/__init__.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/backends/mysql/base.py",
    "django/db/backends/oracle/creation.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/backends/oracle/operations.py",
    "django/db/models/__init__.py",
    "django/db/backends/base/introspection.py"
  ],
  "3_final_combined_files": [
    "django/db/migrations/operations/models.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/backends/base/schema.py",
    "django/db/models/indexes.py",
    "django/db/migrations/operations/fields.py"
  ],
  "4_related_elements": {
    "django/db/migrations/operations/models.py": [
      "class: RenameIndex\nclass: AlterUniqueTogether\nclass: AlterIndexTogether"
    ],
    "django/db/backends/base/schema.py": [
      "function: BaseDatabaseSchemaEditor.rename_index\nfunction: BaseDatabaseSchemaEditor._rename_index_sql\nfunction: BaseDatabaseSchemaEditor._create_index_name\nfunction: BaseDatabaseSchemaEditor._constraint_names\nfunction: BaseDatabaseSchemaEditor._unique_sql\nfunction: BaseDatabaseSchemaEditor._create_unique_sql\nfunction: BaseDatabaseSchemaEditor._index_columns\nfunction: BaseDatabaseSchemaEditor._model_indexes_sql"
    ],
    "django/db/backends/postgresql/schema.py": [
      "class: DatabaseSchemaEditor"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: RenameIndex.database_backwards"
        ],
        "django/db/backends/base/schema.py": [
          "\nfunction: BaseDatabaseSchemaEditor.rename_index"
        ]
      },
      "patches": [
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..bedeedd 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the index names are identical to avoid database errors on renaming\n+        # to the same name (e.g., PostgreSQL raises \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..a514b39 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the target name is the same as the current name, no-op to avoid\n+        # backend errors (e.g., PostgreSQL raises \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..cd2245c 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # Avoid attempting to rename an index to the same name, which can\n+        # cause backend errors (e.g., PostgreSQL: \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..9728c22 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the desired name is already in use by the index, there's nothing to do.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..0a9ccc4 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..f849198 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if names are identical to avoid backend errors when re-applying.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..bb2ea51 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -966,10 +966,8 @@ class RenameIndex(IndexOperation):\n         schema_editor.rename_index(model, old_index, new_index)\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n-        if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n-            return\n-\n+        # Perform rename even for unnamed indexes to restore the original\n+        # auto-generated name when moving backward.\n         self.new_name_lower, self.old_name_lower = (\n             self.old_name_lower,\n             self.new_name_lower,\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..2bd9afa 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if names are identical to avoid backend errors (e.g. PostgreSQL).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..ba81eb8 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,11 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new index names are identical to avoid\n+        # unnecessary SQL and backend errors (e.g., PostgreSQL raises\n+        # \"relation ... already exists\" when renaming to the same name).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..bd1e591 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if names are the same (e.g., re-applying a rename after a no-op backward).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..7f3af02 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,12 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        # This can happen when re-applying a RenameIndex operation for an\n+        # unnamed index (e.g., backing unique_together) after a backward\n+        # migration that didn't revert the name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: RenameIndex.database_backwards\nfunction: RenameIndex.database_forwards"
        ],
        "django/db/backends/base/schema.py": [
          "\nfunction: BaseDatabaseSchemaEditor.rename_index"
        ]
      },
      "patches": [
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..2ed8b8d 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -967,7 +967,18 @@ class RenameIndex(IndexOperation):\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Restore the old auto-generated name for an unnamed index (e.g. index_together).\n+            model = from_state.apps.get_model(app_label, self.model_name)\n+            columns = [model._meta.get_field(field).column for field in self.old_fields]\n+            # Compute the original auto-generated index name.\n+            old_auto_name = schema_editor._create_index_name(model, columns, suffix=\"_idx\")\n+            # Current index is the explicitly named one from the \"from_state\".\n+            from_model_state = from_state.models[app_label, self.model_name_lower]\n+            new_index = from_model_state.get_index_by_name(self.new_name)\n+            # Target index with the auto-generated name.\n+            old_index = models.Index(fields=self.old_fields, name=old_auto_name)\n+            # Rename back to the auto-generated name.\n+            schema_editor.rename_index(model, new_index, old_index)\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..21027b2 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,11 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the old and new names are the same, do nothing to avoid backend errors\n+        # (e.g., PostgreSQL raises \"relation ... already exists\" when renaming to\n+        # the same name).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..19b688f 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the new name is the same as the current one. Some backends\n+        # (e.g., PostgreSQL) error when renaming an index to its existing name.\n+        if old_index.name == new_index.name:\n+            return None\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..06f946b 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,11 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the target name is the same as the current name, there's nothing to do.\n+        # This can occur when re-applying RenameIndex for an unnamed index where the\n+        # database already uses the desired name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..f158557 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the index names are identical (e.g., re-applying a rename).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..da5de2d 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,11 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is identical to the current name. Some\n+        # backends (e.g., PostgreSQL) error when attempting to rename an index\n+        # to the same name (\"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..ee91602 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if renaming to the same name (e.g., re-applying a migration).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..a841309 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new names are identical to avoid backend errors.\n+        if old_index.name == new_index.name:\n+            return None\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..df30489 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # Skip no-op renames where the old and new index names are identical.\n+        # This avoids backend errors like PostgreSQL's \"relation already exists\".\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..5c95d96 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if names are identical to avoid backend errors.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..a2509cb 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -966,8 +966,35 @@ class RenameIndex(IndexOperation):\n         schema_editor.rename_index(model, old_index, new_index)\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n+        model = to_state.apps.get_model(app_label, self.model_name)\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Restore the auto-generated name for the unnamed index (e.g., index_together).\n+            to_model = to_state.apps.get_model(app_label, self.model_name)\n+            columns = [\n+                to_model._meta.get_field(field).column for field in self.old_fields\n+            ]\n+            # Compute the auto-generated index name that would have been created\n+            # for index_together on these columns.\n+            auto_index_name = schema_editor._create_index_name(\n+                to_model._meta.db_table, columns, suffix=\"_idx\"\n+            )\n+            # Determine the current index name in the database for these columns.\n+            matching_index_name = schema_editor._constraint_names(\n+                to_model, column_names=columns, index=True\n+            )\n+            if len(matching_index_name) != 1:\n+                raise ValueError(\n+                    \"Found wrong number (%s) of indexes for %s(%s).\"\n+                    % (\n+                        len(matching_index_name),\n+                        to_model._meta.db_table,\n+                        \", \".join(columns),\n+                    )\n+                )\n+            old_index = models.Index(fields=self.old_fields, name=matching_index_name[0])\n+            new_index = models.Index(fields=self.old_fields, name=auto_index_name)\n+            if old_index.name != new_index.name:\n+                schema_editor.rename_index(model, old_index, new_index)\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: RenameIndex.database_backwards"
        ],
        "django/db/backends/base/schema.py": [
          "\nfunction: BaseDatabaseSchemaEditor.rename_index"
        ]
      },
      "patches": [
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..30e3a83 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new names are identical to avoid backend errors\n+        # (e.g. PostgreSQL raises \"relation ... already exists\" on such renames).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..01accc2 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new names are identical to avoid backend errors\n+        # (e.g., PostgreSQL raises \"relation ... already exists\" on rename).\n+        if old_index.name == new_index.name:\n+            return None\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..d3d3777 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the new name is identical to the current name to avoid\n+        # backend errors (e.g., PostgreSQL raises \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..0a9ccc4 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..49707dd 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the target name matches the current name, no operation is needed.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..3f93097 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the old and new index names are the same, skip to avoid backend errors.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..146d47e 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -967,7 +967,23 @@ class RenameIndex(IndexOperation):\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Restore the old auto-generated name when moving backward for unnamed index.\n+            # The database currently has the named index (self.new_name) from from_state.\n+            # Rename it back to the auto-generated name derived from to_state.\n+            model = from_state.apps.get_model(app_label, self.model_name)\n+            from_model_state = from_state.models[app_label, self.model_name_lower]\n+            old_index = from_model_state.get_index_by_name(self.new_name)\n+\n+            # Compute the old auto-generated name using the target state and index suffix.\n+            columns = [model._meta.get_field(field).column for field in self.old_fields]\n+            auto_old_name = schema_editor._create_index_name(\n+                model._meta.db_table,\n+                columns,\n+                suffix=old_index.suffix,\n+            )\n+            to_model_state = to_state.models[app_label, self.model_name_lower]\n+            new_index = to_model_state.get_index_by_name(auto_old_name)\n+            schema_editor.rename_index(model, old_index, new_index)\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..2f920bd 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if names are identical to avoid backend errors (e.g., PostgreSQL).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..0a9ccc4 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..b84f4a6 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -967,7 +967,17 @@ class RenameIndex(IndexOperation):\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Backward operation for unnamed index: restore the auto-generated name.\n+            # Compute the model and columns for default naming.\n+            model = to_state.apps.get_model(app_label, self.model_name)\n+            to_model_state = to_state.models[app_label, self.model_name_lower]\n+            columns = [to_model_state.get_field(field).column for field in self.old_fields]\n+            # Compute the auto-generated name for the previous state.\n+            auto_name = schema_editor._create_index_name(model, columns)\n+            # Rename index from the explicit new name back to the auto-generated name.\n+            old_index = models.Index(fields=self.old_fields, name=self.new_name)\n+            new_index = models.Index(fields=self.old_fields, name=auto_name)\n+            schema_editor.rename_index(model, old_index, new_index)\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..2fe5509 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -495,11 +495,17 @@ class BaseDatabaseSchemaEditor:\n \n     def rename_index(self, model, old_index, new_index):\n         if self.connection.features.can_rename_index:\n+            # Avoid attempting to rename an index to the same name.\n+            if old_index.name == new_index.name:\n+                return\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n                 params=None,\n             )\n         else:\n+            # Avoid unnecessary work if names are identical.\n+            if old_index.name == new_index.name:\n+                return\n             self.remove_index(model, old_index)\n             self.add_index(model, new_index)\n \ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..dfaf5e7 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -967,7 +967,27 @@ class RenameIndex(IndexOperation):\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Backward operation for unnamed index should restore the original\n+            # auto-generated name based on unique_together fields.\n+            model = to_state.apps.get_model(app_label, self.model_name)\n+            # Compute the original auto-generated index name.\n+            original_name = schema_editor._create_index_name(\n+                model._meta.db_table,\n+                self.old_fields,\n+                suffix=\"uniq\",\n+            )\n+            # If names are identical, nothing to do.\n+            if original_name == self.new_name:\n+                return\n+            if schema_editor.connection.features.can_rename_index:\n+                schema_editor.execute(\n+                    schema_editor._rename_index_sql(model, self.new_name, original_name),\n+                    params=None,\n+                )\n+            else:\n+                # Backends that can't rename indexes shouldn't attempt to drop/recreate\n+                # implicit unique_together indexes. Treat as no-op.\n+                return\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/migrations/operations/models.py": [
          "\nfunction: RenameIndex.database_backwards"
        ],
        "django/db/backends/base/schema.py": [
          "\nfunction: BaseDatabaseSchemaEditor.rename_index"
        ]
      },
      "patches": [
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..c77aafb 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new index names are the same to avoid backend\n+        # errors (e.g., PostgreSQL: \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..d6fa7dd 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the index already has the requested name, skip to avoid backend errors.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..441535f 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the target name is the same as the current name, nothing to do.\n+        # Avoids backend errors such as PostgreSQL's \"relation already exists\".\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..fed0747 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the old and new index names are identical to avoid backend errors.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..0a9ccc4 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..a75c6be 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -966,10 +966,6 @@ class RenameIndex(IndexOperation):\n         schema_editor.rename_index(model, old_index, new_index)\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n-        if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n-            return\n-\n         self.new_name_lower, self.old_name_lower = (\n             self.old_name_lower,\n             self.new_name_lower,\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..953b0b5 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,11 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name. This avoids\n+        # errors on databases that raise when renaming to an existing name and\n+        # makes re-applying RenameIndex safe for unnamed indexes.\n+        if old_index.name == new_index.name:\n+            return None\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..330e53a 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,10 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # Avoid attempting to rename an index to the same name, which can\n+        # raise errors on some backends (e.g., PostgreSQL).\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..f9ad3fb 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the index already has the requested name, do nothing.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..fc41fb9 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,12 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the old and new names are identical, there's nothing to do.\n+        # This avoids backend errors when re-applying RenameIndex for unnamed\n+        # indexes (e.g., on PostgreSQL where renaming to an existing name\n+        # raises \"relation ... already exists\").\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
        "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..642319a 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # If the target name matches the current name, there's nothing to do.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\ndiff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex b086232..00b0435 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -967,7 +967,24 @@ class RenameIndex(IndexOperation):\n \n     def database_backwards(self, app_label, schema_editor, from_state, to_state):\n         if self.old_fields:\n-            # Backward operation with unnamed index is a no-op.\n+            # Backward operation with unnamed index should restore the old auto-generated name.\n+            from_model_state = from_state.models[app_label, self.model_name_lower]\n+            model = from_model_state.render()\n+            # Current index has the new explicit name.\n+            old_index = from_model_state.get_index_by_name(self.new_name)\n+\n+            to_model_state = to_state.models[app_label, self.model_name_lower]\n+            # Find the original auto-generated name for the unnamed index by matching fields.\n+            matching_index_name = [\n+                index.name\n+                for index in to_model_state.options.get(\"indexes\", [])\n+                if index.fields == list(self.old_fields)\n+            ]\n+            new_index = models.Index(\n+                fields=list(self.old_fields),\n+                name=matching_index_name[0],\n+            )\n+            schema_editor.rename_index(model, old_index, new_index)\n             return\n \n         self.new_name_lower, self.old_name_lower = (\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 66b1797..0a9ccc4 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -494,6 +494,9 @@ class BaseDatabaseSchemaEditor:\n         self.execute(index.remove_sql(model, self))\n \n     def rename_index(self, model, old_index, new_index):\n+        # No-op if the target name is the same as the current name.\n+        if old_index.name == new_index.name:\n+            return\n         if self.connection.features.can_rename_index:\n             self.execute(\n                 self._rename_index_sql(model, old_index.name, new_index.name),\n",
  "7_resolved": false
}