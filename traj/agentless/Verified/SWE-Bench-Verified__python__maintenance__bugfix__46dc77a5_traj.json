{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__46dc77a5",
  "original_id": "django__django-12262",
  "1_model_selected_files": [
    "django/template/library.py",
    "django/utils/inspect.py"
  ],
  "2_embedding_selected_files": [
    "django/template/library.py",
    "django/template/defaulttags.py",
    "django/template/base.py",
    "django/template/exceptions.py",
    "django/template/loader_tags.py",
    "django/template/backends/django.py",
    "django/template/response.py",
    "django/template/smartif.py",
    "django/template/backends/dummy.py",
    "django/template/__init__.py",
    "django/template/defaultfilters.py",
    "django/utils/html.py",
    "django/utils/translation/template.py",
    "django/template/backends/jinja2.py",
    "django/template/loader.py",
    "django/template/engine.py",
    "django/template/backends/utils.py",
    "django/template/utils.py",
    "django/template/loaders/cached.py",
    "django/utils/cache.py",
    "django/utils/deprecation.py",
    "django/template/backends/base.py",
    "django/utils/text.py",
    "django/utils/feedgenerator.py",
    "django/template/backends/__init__.py",
    "django/utils/jslex.py",
    "django/utils/safestring.py",
    "django/template/context.py",
    "django/template/context_processors.py",
    "django/utils/timezone.py",
    "django/utils/inspect.py",
    "django/shortcuts.py",
    "django/utils/translation/__init__.py",
    "django/utils/regex_helper.py",
    "django/template/loaders/locmem.py",
    "django/template/loaders/__init__.py",
    "django/setup.py",
    "django/utils/archive.py",
    "django/utils/log.py",
    "django/utils/datetime_safe.py",
    "django/template/loaders/base.py",
    "django/utils/functional.py",
    "django/utils/xmlutils.py",
    "django/utils/datastructures.py",
    "django/utils/http.py",
    "django/utils/__init__.py",
    "django/utils/asyncio.py",
    "django/utils/translation/trans_real.py",
    "django/utils/encoding.py",
    "django/utils/autoreload.py",
    "django/utils/termcolors.py",
    "django/template/loaders/filesystem.py",
    "django/utils/formats.py",
    "django/utils/decorators.py",
    "django/utils/dateparse.py",
    "django/utils/dateformat.py",
    "django/utils/deconstruct.py",
    "django/template/loaders/app_directories.py",
    "django/utils/hashable.py",
    "django/utils/dates.py",
    "django/utils/duration.py",
    "django/utils/ipv6.py",
    "django/__init__.py",
    "django/utils/crypto.py",
    "django/utils/topological_sort.py",
    "django/utils/lorem_ipsum.py",
    "django/utils/translation/trans_null.py",
    "django/utils/tree.py"
  ],
  "3_final_combined_files": [
    "django/template/library.py",
    "django/utils/inspect.py",
    "django/template/defaulttags.py",
    "django/template/base.py"
  ],
  "4_related_elements": {
    "django/template/library.py": [
      "function: parse_bits\nfunction: Library.simple_tag\nfunction: Library.inclusion_tag\nfunction: TagHelperNode.get_resolved_arguments\nclass: SimpleNode\nclass: InclusionNode"
    ],
    "django/utils/inspect.py": [
      "function: get_func_full_args\nfunction: func_accepts_kwargs\nfunction: func_accepts_var_args"
    ],
    "django/template/defaulttags.py": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/template/library.py": [
          "\nline: 265"
        ]
      },
      "patches": [
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..1ccded4 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and param not in unhandled_kwargs and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..1ccded4 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and param not in unhandled_kwargs and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..349b038 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and (kwonly is None or param not in kwonly) and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/template/library.py": [
          "\nfunction: parse_bits\nline: 265"
        ]
      },
      "patches": [
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..d9e5390 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,27 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n+            # Check duplicate before validating allowed names to ensure proper error message.\n+            if param in kwargs:\n                 raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            elif param in kwargs:\n-                # The keyword argument has already been supplied once\n+            # Allow if it's a positional parameter name, a keyword-only parameter name,\n+            # or if the function accepts **kwargs.\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n-                    \"'%s' received multiple values for keyword argument '%s'\" %\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_kwargs:\n+                # Same for required keyword-only arguments\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..fd8c264 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,25 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_kwargs:\n+                # Same for keyword-only arguments\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        ""
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/template/library.py": [
          "\nfunction: parse_bits\nline: 264\nline: 265\nline: 266\nline: 269\nline: 270\nline: 271\nline: 272\nline: 273"
        ]
      },
      "patches": [
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..fd8c264 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,25 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_kwargs:\n+                # Same for keyword-only arguments\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b75453a 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,18 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            # Allow explicitly-declared keyword-only arguments (both with and\n+            # without defaults) even when **kwargs is not accepted.\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b677a87 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,25 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            if param in unhandled_kwargs:\n+                # Same for keyword-only arguments (only required ones tracked here)\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..d057293 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,10 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            # Validate keyword argument name against all acceptable keywords:\n+            # - positional parameters (can be passed by keyword)\n+            # - keyword-only parameters (including those with defaults)\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..8ab2b07 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,25 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_kwargs:\n+                # Same for required keyword-only arguments\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/template/library.py": [
          "\nfunction: parse_bits\nline: 264"
        ]
      },
      "patches": [
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..55f87d8 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,26 +261,25 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then\n+                # consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_kwargs:\n+                # Same for keyword-only arguments (only required ones are tracked here)\n+                unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n",
        "",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..b28c6c6 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..f5fcc2b 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,10 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            # Allow keyword-only arguments whether or not they have defaults.\n+            # unhandled_kwargs only tracks required kwargs for missing-arg checks,\n+            # so use 'kwonly' here to validate allowed keyword names.\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
        "",
        "",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..bf25dda 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            elif param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n@@ -279,7 +279,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n                     # consume it.\n                     unhandled_params.remove(param)\n                 elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n+                    # Same for required keyword-only arguments\n                     unhandled_kwargs.remove(param)\n         else:\n             if kwargs:\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..1f31a4d 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,16 +261,16 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n-                raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n-                    (name, param))\n-            elif param in kwargs:\n+            if param in kwargs:\n                 # The keyword argument has already been supplied once\n                 raise TemplateSyntaxError(\n                     \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n+            if param not in params and param not in kwonly and varkw is None:\n+                # An unexpected keyword argument was supplied\n+                raise TemplateSyntaxError(\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    (name, param))\n             else:\n                 # All good, record the keyword argument\n                 kwargs[str(param)] = value\n",
        "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..816410d 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -251,36 +251,45 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n     args = []\n     kwargs = {}\n     unhandled_params = list(params)\n-    unhandled_kwargs = [\n+\n+    # Determine which keyword-only arguments are required (no defaults) and\n+    # which keyword names are allowed.\n+    kwonly = kwonly or []\n+    allowed_kwonly = set(kwonly)\n+    required_kwonly = [\n         kwarg for kwarg in kwonly\n         if not kwonly_defaults or kwarg not in kwonly_defaults\n     ]\n+    unhandled_required_kwonly = list(required_kwonly)\n+\n     for bit in bits:\n         # First we try to extract a potential kwarg from the bit\n         kwarg = token_kwargs([bit], parser)\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n-                # An unexpected keyword argument was supplied\n+\n+            # Check for duplicate keyword arguments first so we report the\n+            # correct error even if the parameter has already been consumed.\n+            if param in kwargs:\n                 raise TemplateSyntaxError(\n-                    \"'%s' received unexpected keyword argument '%s'\" %\n+                    \"'%s' received multiple values for keyword argument '%s'\" %\n                     (name, param))\n-            elif param in kwargs:\n-                # The keyword argument has already been supplied once\n+\n+            # Validate that the keyword is expected, unless **kwargs is accepted.\n+            if param not in params and param not in allowed_kwonly and varkw is None:\n                 raise TemplateSyntaxError(\n-                    \"'%s' received multiple values for keyword argument '%s'\" %\n+                    \"'%s' received unexpected keyword argument '%s'\" %\n                     (name, param))\n-            else:\n-                # All good, record the keyword argument\n-                kwargs[str(param)] = value\n-                if param in unhandled_params:\n-                    # If using the keyword syntax for a positional arg, then\n-                    # consume it.\n-                    unhandled_params.remove(param)\n-                elif param in unhandled_kwargs:\n-                    # Same for keyword-only arguments\n-                    unhandled_kwargs.remove(param)\n+\n+            # All good, record the keyword argument\n+            kwargs[str(param)] = value\n+            if param in unhandled_params:\n+                # If using the keyword syntax for a positional arg, then consume it.\n+                unhandled_params.remove(param)\n+            elif param in unhandled_required_kwonly:\n+                # Same for required keyword-only arguments\n+                unhandled_required_kwonly.remove(param)\n         else:\n             if kwargs:\n                 raise TemplateSyntaxError(\n@@ -301,11 +310,11 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         # Consider the last n params handled, where n is the\n         # number of defaults.\n         unhandled_params = unhandled_params[:-len(defaults)]\n-    if unhandled_params or unhandled_kwargs:\n-        # Some positional arguments were not supplied\n+    if unhandled_params or unhandled_required_kwonly:\n+        # Some arguments were not supplied\n         raise TemplateSyntaxError(\n             \"'%s' did not receive value(s) for the argument(s): %s\" %\n-            (name, \", \".join(\"'%s'\" % p for p in unhandled_params + unhandled_kwargs)))\n+            (name, \", \".join(\"'%s'\" % p for p in unhandled_params + unhandled_required_kwonly)))\n     return args, kwargs\n \n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/template/library.py b/django/template/library.py\nindex e9453ed..a8f61ed 100644\n--- a/django/template/library.py\n+++ b/django/template/library.py\n@@ -261,7 +261,7 @@ def parse_bits(parser, bits, params, varargs, varkw, defaults,\n         if kwarg:\n             # The kwarg was successfully extracted\n             param, value = kwarg.popitem()\n-            if param not in params and param not in unhandled_kwargs and varkw is None:\n+            if param not in params and param not in kwonly and varkw is None:\n                 # An unexpected keyword argument was supplied\n                 raise TemplateSyntaxError(\n                     \"'%s' received unexpected keyword argument '%s'\" %\n",
  "7_resolved": true
}