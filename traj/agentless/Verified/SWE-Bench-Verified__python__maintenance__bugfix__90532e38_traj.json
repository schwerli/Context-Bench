{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__90532e38",
  "original_id": "pydata__xarray-4075",
  "1_model_selected_files": [
    "xarray/core/weighted.py",
    "xarray/core/computation.py",
    "xarray/core/duck_array_ops.py",
    "xarray/core/dataarray.py"
  ],
  "2_embedding_selected_files": [
    "xarray/core/weighted.py",
    "xarray/core/duck_array_ops.py",
    "xarray/__init__.py",
    "xarray/core/variable.py",
    "xarray/core/arithmetic.py",
    "xarray/core/nputils.py",
    "xarray/core/pycompat.py",
    "xarray/core/common.py",
    "xarray/core/npcompat.py",
    "xarray/core/computation.py",
    "xarray/core/dask_array_compat.py",
    "xarray/core/merge.py",
    "xarray/core/alignment.py",
    "xarray/core/dask_array_ops.py",
    "xarray/core/dtypes.py",
    "xarray/core/nanops.py",
    "xarray/core/utils.py",
    "xarray/core/formatting.py",
    "xarray/core/rolling.py",
    "xarray/core/combine.py",
    "xarray/core/dataarray.py",
    "xarray/ufuncs.py",
    "xarray/core/dataset.py",
    "xarray/conventions.py",
    "xarray/core/__init__.py",
    "xarray/core/rolling_exp.py",
    "xarray/core/groupby.py",
    "xarray/core/ops.py",
    "xarray/core/coordinates.py",
    "xarray/core/formatting_html.py",
    "xarray/core/indexing.py",
    "xarray/core/pdcompat.py",
    "xarray/core/missing.py",
    "xarray/core/indexes.py",
    "xarray/core/parallel.py",
    "xarray/core/accessor_str.py",
    "xarray/tutorial.py",
    "xarray/core/options.py",
    "xarray/core/accessor_dt.py",
    "xarray/core/extensions.py"
  ],
  "3_final_combined_files": [
    "xarray/core/weighted.py",
    "xarray/core/duck_array_ops.py",
    "xarray/core/computation.py",
    "xarray/__init__.py"
  ],
  "4_related_elements": {
    "xarray/core/weighted.py": [
      "class: Weighted\nclass: DataArrayWeighted\nclass: DatasetWeighted"
    ],
    "xarray/core/computation.py": [
      "function: dot"
    ],
    "xarray/core/duck_array_ops.py": [
      "function: einsum\nfunction: tensordot\nfunction: notnull"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "xarray/core/weighted.py": [
          "\nfunction: Weighted._sum_of_weights\nline: 145\nline: 148"
        ]
      },
      "patches": [
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..5e1db29 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,13 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean inputs produce a numeric sum when using dot\n+        weights = self.weights\n+        if mask.dtype.kind == \"b\" and weights.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..af095be 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,10 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n+        # ensure mask is numeric so the dot product yields a numeric sum\n+        # (dot over two boolean arrays can return a boolean)\n         mask = da.notnull()\n+        mask = mask.astype(\"float64\")\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..175ff3b 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,12 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # convert boolean weights to numeric (0/1) to ensure correct normalization\n+        weights = self.weights\n+        if getattr(weights.dtype, \"kind\", None) == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..a4b361e 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,8 +141,15 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n-\n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # xr.dot on boolean arrays can yield a boolean result, which is incorrect\n+        # for computing sum of weights. Cast any boolean inputs to a numeric type.\n+        weights = self.weights\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..45822d8 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,15 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean inputs are treated as numeric (1/0) for dot-product\n+        # Otherwise xr.dot(bool, bool) can yield a boolean result, which breaks normalization.\n+        mask = mask.astype(\"float64\")\n+\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..5eba019 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,9 +140,15 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # convert the boolean mask to numeric to ensure a numeric dot product\n+        mask = da.notnull().astype(\"float64\")\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean weights are treated as 0/1 numerics\n+        weights = self.weights\n+        if getattr(weights.dtype, \"kind\", None) == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..8497943 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,8 +141,16 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric types for mask/weights so dot() performs arithmetic reduction\n+        # rather than boolean semiring when weights are boolean.\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        weights = self.weights\n+        if hasattr(weights, \"dtype\") and weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..071277f 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,8 +141,13 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # cast boolean mask/weights to numeric to ensure proper summation\n+        mask = mask.astype(float)\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(float)\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..46938a1 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean inputs are treated as numeric for dot-product normalization\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(float)\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(float)\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..58c0727 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,9 +140,15 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast mask to numeric to avoid boolean dot semantics\n+        mask = da.notnull().astype(float)\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean weights are treated as numeric when computing sum of weights\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(float)\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "xarray/core/weighted.py": [
          "\nfunction: Weighted._sum_of_weights\nline: 143\nline: 145"
        ]
      },
      "patches": [
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..c28dba1 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean masks/weights are treated as numeric for dot-product.\n+        # If both are boolean, dot() would return a boolean, which is incorrect.\n+        weights = self.weights\n+        if hasattr(weights, \"dtype\") and weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+        mask_numeric = mask.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask_numeric, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..35a48a4 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,12 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean weights are treated as numeric counts for dot\n+        weights = self.weights\n+        if getattr(weights.dtype, \"kind\", None) == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..546b405 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,12 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure the mask is numeric so that the dot returns a numeric sum\n+        # even when weights are boolean. Otherwise xr.dot(bool, bool) can yield\n+        # a boolean True/False instead of the expected count.\n+        mask_numeric = mask.astype(float)\n+\n+        sum_of_weights = self._reduce(mask_numeric, self.weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..a643cbb 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,8 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast mask to numeric so that dot computes a numeric sum rather than a boolean result\n+        mask = da.notnull().astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..e813a0e 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -129,6 +129,12 @@ class Weighted:\n         if skipna or (skipna is None and da.dtype.kind in \"cfO\"):\n             da = da.fillna(0.0)\n \n+        # if either input is boolean, cast to numeric so dot performs an arithmetic sum\n+        if da.dtype.kind == \"b\":\n+            da = da.astype(\"int64\")\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"int64\")\n+\n         # `dot` does not broadcast arrays, so this avoids creating a large\n         # DataArray (if `weights` has additional dimensions)\n         # maybe add fasttrack (`(da * weights).sum(dims=dim, skipna=skipna)`)\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..120b795 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,8 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast to float so dot performs an arithmetic sum rather than a logical operation\n+        mask = da.notnull().astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..b439abf 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -129,6 +129,12 @@ class Weighted:\n         if skipna or (skipna is None and da.dtype.kind in \"cfO\"):\n             da = da.fillna(0.0)\n \n+        # Ensure boolean inputs are treated as numeric 0/1 for dot-products\n+        if da.dtype.kind == \"b\":\n+            da = da.astype(\"int64\")\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"int64\")\n+\n         # `dot` does not broadcast arrays, so this avoids creating a large\n         # DataArray (if `weights` has additional dimensions)\n         # maybe add fasttrack (`(da * weights).sum(dims=dim, skipna=skipna)`)\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..49e621f 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,9 +140,16 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n+        # ensure mask and weights are numeric so dot() returns a numeric sum even for boolean inputs\n         mask = da.notnull()\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        weights = self.weights\n+        if hasattr(weights, \"dtype\") and weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..b9912e9 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,12 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean weights are treated as numeric for dot product\n+        weights = self.weights\n+        if getattr(weights.dtype, \"kind\", None) == \"b\":\n+            weights = weights.astype(\"int64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..ce5e3cf 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,13 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean arrays are treated as 0/1 in dot-product calculations.\n+        # xr.dot may return boolean results when both inputs are boolean; coerce\n+        # to numeric to get correct sums.\n+        numeric_mask = mask * 1\n+        numeric_weights = self.weights * 1\n+\n+        sum_of_weights = self._reduce(numeric_mask, numeric_weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "xarray/core/weighted.py": [
          "\nfunction: Weighted._sum_of_weights\nline: 143\nline: 145"
        ]
      },
      "patches": [
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..e3dc947 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure boolean weights are treated as numeric in the dot-product.\n+        # Using boolean weights with boolean mask would otherwise yield a boolean\n+        # result (e.g., True) instead of a numeric sum (e.g., 2.0).\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..d0f02e0 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean mask/weights are treated as numeric for dot/reduce\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..1bf20a5 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure numeric types for dot: boolean dot boolean yields a boolean,\n+        # which breaks normalization for weighted reductions.\n+        weights = self.weights\n+        if mask.dtype.kind == \"b\" or weights.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..f0a7de4 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,9 +140,15 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # ensure numeric dtype so dot calculates a numeric sum instead of boolean\n+        mask = da.notnull().astype(\"float64\")\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        weights = self.weights\n+        if getattr(weights.dtype, \"kind\", None) == \"b\":\n+            # cast boolean weights to numeric to avoid boolean dot semantics\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..0b44767 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,8 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric mask so that dot returns a numeric sum even with boolean weights\n+        mask = mask * 1.0\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..bbb958d 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,6 +142,10 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n+        # ensure numeric dtype for dot operation; xr.dot with boolean inputs can yield a boolean\n+        # result, which breaks normalization when weights are boolean\n+        mask = mask.astype(\"float64\")\n+\n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..86e2b3b 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,8 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # ensure numeric dtype so dot yields a numeric sum even with boolean weights\n+        mask = da.notnull().astype(\"float\")\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..602f56e 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,8 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric mask to avoid boolean dot semantics when weights are boolean\n+        mask = mask.astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..a0ab8c2 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,16 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # Ensure numeric dot product when either mask or weights are boolean.\n+        # numpy/xarray dot on booleans can yield a boolean result, which breaks normalization.\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+        if mask.dtype.kind == \"b\":\n+            # cast mask to the weights dtype so the dot uses numeric arithmetic\n+            mask = mask.astype(weights.dtype)\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..71036f9 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,13 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # If weights are boolean, ensure we compute a numeric sum of weights.\n+        # Otherwise xr.dot on two boolean arrays yields a boolean scalar.\n+        weights = self.weights\n+        if getattr(weights, \"dtype\", None) is not None and weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "xarray/core/weighted.py": [
          "\nfunction: Weighted._sum_of_weights\nline: 143\nline: 145"
        ]
      },
      "patches": [
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..6697224 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,10 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric dtype before dot: boolean dot returns a boolean (e.g., True)\n+        # which causes incorrect normalization for boolean weights.\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"int64\")\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..778f771 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,8 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast boolean mask to numeric so dot computes a numeric sum rather than a boolean result\n+        mask = da.notnull().astype(\"float64\")\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..a04446a 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,8 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric dtype for dot product; boolean dot can return boolean\n+        mask = mask.astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..efee688 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,12 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean weights do not produce a boolean dot result\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..770becf 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,9 +140,14 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast boolean mask (and boolean weights) to numeric so dot performs arithmetic summation\n+        mask = da.notnull().astype(\"float64\")\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        weights = self.weights\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..86e01e1 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean masks/weights are treated as numeric (0/1) for dot product\n+        weights = self.weights\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(\"float\")\n+        if weights.dtype.kind == \"b\":\n+            weights = weights.astype(\"float\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..f4a1f2d 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,9 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # ensure boolean masks participate in arithmetic as 0/1 for dot product\n+        if mask.dtype.kind == \"b\":\n+            mask = mask.astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..66971e1 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,8 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # ensure mask is numeric so that dot returns a numeric sum even with boolean weights\n+        mask = mask.astype(int)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..cfb2a36 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,6 +141,10 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n+        # Ensure numeric dot-product when mask/weights are boolean.\n+        # Casting the mask to float yields 1.0 for True and 0.0 for False,\n+        # producing the correct sum of weights instead of a boolean.\n+        mask = mask.astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n",
        "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..9c16a41 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -140,7 +140,8 @@ class Weighted:\n         \"\"\" Calculate the sum of weights, accounting for missing values \"\"\"\n \n         # we need to mask data values that are nan; else the weights are wrong\n-        mask = da.notnull()\n+        # cast mask to a numeric dtype so boolean weights are summed correctly\n+        mask = da.notnull().astype(float)\n \n         sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 8119fa7..5e1db29 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,13 @@ class Weighted:\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # ensure boolean inputs produce a numeric sum when using dot\n+        weights = self.weights\n+        if mask.dtype.kind == \"b\" and weights.dtype.kind == \"b\":\n+            mask = mask.astype(\"float64\")\n+            weights = weights.astype(\"float64\")\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\n",
  "7_resolved": true
}