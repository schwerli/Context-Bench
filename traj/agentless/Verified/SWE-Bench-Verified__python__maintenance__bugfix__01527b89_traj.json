{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__01527b89",
  "original_id": "django__django-14351",
  "1_model_selected_files": [
    "django/db/models/fields/related_lookups.py",
    "django/db/models/lookups.py",
    "django/db/models/sql/query.py",
    "django/db/models/expressions.py",
    "django/db/models/sql/compiler.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/sql/compiler.py",
    "django/db/models/__init__.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/sql/where.py",
    "django/db/models/query.py",
    "django/db/models/fields/related.py",
    "django/db/models/sql/query.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/backends/oracle/operations.py",
    "django/db/models/expressions.py",
    "django/db/models/query_utils.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/backends/oracle/features.py",
    "django/db/models/sql/datastructures.py",
    "django/db/backends/postgresql/features.py",
    "django/db/models/base.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/models/manager.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/lookups.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/backends/base/features.py",
    "django/db/backends/base/schema.py",
    "django/db/backends/sqlite3/features.py",
    "django/db/backends/mysql/features.py",
    "django/db/models/fields/__init__.py",
    "django/db/backends/base/operations.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/backends/oracle/base.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/models/options.py",
    "django/db/backends/mysql/operations.py",
    "django/db/backends/mysql/schema.py",
    "django/db/models/deletion.py",
    "django/db/models/constraints.py",
    "django/db/backends/base/introspection.py",
    "django/db/backends/mysql/base.py",
    "django/db/migrations/autodetector.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/migrations/questioner.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/backends/postgresql/base.py"
  ],
  "3_final_combined_files": [
    "django/db/models/fields/related_lookups.py",
    "django/db/models/lookups.py",
    "django/db/models/sql/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/__init__.py",
    "django/db/models/sql/subqueries.py"
  ],
  "4_related_elements": {
    "django/db/models/fields/related_lookups.py": [
      "class: RelatedIn\nclass: RelatedLookupMixin\nclass: RelatedExact\nclass: MultiColSource\nfunction: get_normalized_value"
    ],
    "django/db/models/lookups.py": [
      "class: In\nclass: FieldGetDbPrepValueIterableMixin\nclass: Lookup\nclass: BuiltinLookup\nfunction: Lookup.get_group_by_cols\nfunction: In.process_rhs\nfunction: In.as_sql\nfunction: FieldGetDbPrepValueIterableMixin.process_rhs\nfunction: FieldGetDbPrepValueIterableMixin.batch_process_rhs"
    ],
    "django/db/models/sql/query.py": [
      "class: Query\nfunction: Query.__init__\nfunction: Query.as_sql\nfunction: Query.resolve_lookup_value\nfunction: Query.build_lookup\nfunction: Query.build_filter\nfunction: Query.add_q\nfunction: Query._add_q\nfunction: Query.names_to_path\nfunction: Query.setup_joins\nfunction: Query.clear_select_fields\nfunction: Query.set_select\nfunction: Query.add_select_col\nfunction: Query.has_select_fields\nfunction: Query.get_external_cols\nfunction: Query._gen_cols\nfunction: Query._gen_col_aliases\nfunction: Query.set_group_by\nfunction: get_children_from_q\nclass: JoinPromoter\nvariable: subq_aliases"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.as_sql\nline: 89\nline: 90\nline: 91\nline: 92\nline: 93\nline: 94\nline: 95\nline: 96\nline: 97\nline: 98\nline: 99\nline: 100\nline: 101"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..8573b4a 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,15 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            # Determine whether rhs query already has an explicit select clause.\n+            rhs_has_select_attr = getattr(self.rhs, 'has_select_fields', None)\n+            if callable(rhs_has_select_attr):\n+                rhs_has_select = rhs_has_select_attr()\n+            elif rhs_has_select_attr is None:\n+                rhs_has_select = True\n+            else:\n+                rhs_has_select = rhs_has_select_attr\n+            if (not rhs_has_select and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ffb2040 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,10 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            rhs_has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(rhs_has_select_fields):\n+                rhs_has_select_fields = rhs_has_select_fields()\n+            if (not rhs_has_select_fields and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..a25396f 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,12 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+                # Ensure the RHS subquery selects only a single column (the target\n+                # field) when it's using default model columns. Otherwise, IN\n+                # subqueries may incorrectly include all default columns which\n+                # results in \"subquery must return only one column\" errors.\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..7be687a 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,12 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            # Ensure the RHS subquery for __in selects a single column corresponding\n+            # to the target field, even when the target field is a primary key.\n+            # Otherwise, default column selection can cause multiple columns to be\n+            # selected (e.g., when OR-ing Q objects), resulting in a \"subquery must\n+            # return only one column\" error.\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..7e02d5c 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,10 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(has_select_fields):\n+                has_select_fields = has_select_fields()\n+            if (not has_select_fields and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ffb2040 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,10 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            rhs_has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(rhs_has_select_fields):\n+                rhs_has_select_fields = rhs_has_select_fields()\n+            if (not rhs_has_select_fields and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..0271325 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,10 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            # Ensure RHS subquery selects only the target field to avoid\n+            # \"subquery must return only one column\" errors, including when\n+            # the target field is a primary key.\n+            if hasattr(self.rhs, 'clear_select_clause'):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.as_sql\nline: 89\nline: 101"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ebfbdc5 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,13 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            # Normalize RHS select fields: call has_select_fields() if it's a method.\n+            rhs_has_select_fields = getattr(self.rhs, 'has_select_fields', None)\n+            if callable(rhs_has_select_fields):\n+                rhs_has_select_fields = rhs_has_select_fields()\n+            elif rhs_has_select_fields is None:\n+                rhs_has_select_fields = True\n+            if (not rhs_has_select_fields and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..dfe158b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,9 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n+                # Ensure the subquery selects only the relevant target field to avoid\n+                # returning multiple columns when default columns would otherwise be used.\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..f2da038 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,12 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n+                # Ensure subqueries used with __in select only a single column.\n+                # Even when the target field is a primary key, default column\n+                # selection might include all columns (e.g., when alias_cols is\n+                # enabled due to OR conditions), which would make the subquery\n+                # invalid. Force selecting the appropriate target field.\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..b717f9b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if (not getattr(self.rhs, 'has_select_fields', True)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..404593f 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,10 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            has_select = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(has_select):\n+                has_select = has_select()\n+            if (not has_select and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.as_sql"
        ],
        "django/db/models/lookups.py": [
          "\nfunction: In.process_rhs"
        ],
        "django/db/models/sql/query.py": [
          "\nfunction: Query.has_select_fields"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..6ad094e 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n@@ -96,7 +95,12 @@ class RelatedIn(In):\n                     # Restaurant.\n                     target_field = self.lhs.field.name\n                 else:\n-                    target_field = self.lhs.field.target_field.name\n+                    # If the related target field is the primary key, select 'pk' to\n+                    # ensure the subquery returns a single column.\n+                    if getattr(self.lhs.field.target_field, 'primary_key', False):\n+                        target_field = 'pk'\n+                    else:\n+                        target_field = self.lhs.field.target_field.name\n                 self.rhs.add_fields([target_field], True)\n             return super().as_sql(compiler, connection)\n \n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 9591387..fe02823 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -242,7 +242,9 @@ class Query(BaseExpression):\n \n     @property\n     def has_select_fields(self):\n-        return bool(self.select or self.annotation_select_mask or self.extra_select_mask)\n+        # Only consider explicit selections. Masks indicate potential selection\n+        # but don't mean a concrete SELECT list exists.\n+        return bool(self.select or self.annotation_select or self.extra_select)\n \n     @cached_property\n     def base_table(self):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..d63591e 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -89,6 +89,12 @@ class RelatedIn(In):\n             if (not getattr(self.rhs, 'has_select_fields', True) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n+                # Prevent automatic expansion to all default columns in subquery context.\n+                self.rhs.alias_cols = False\n+                try:\n+                    self.rhs.default_cols = False\n+                except Exception:\n+                    pass\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n                     # A case like Restaurant.objects.filter(place__in=restaurant_qs),\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..9c3a774 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -403,6 +403,15 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n         else:\n             if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n+                # Ensure the subquery doesn't expand to default columns when compiled.\n+                # This can happen when alias_cols/default_cols are set during OR'ed Q-object\n+                # compilation, causing a multi-column subquery and a \"subquery must return only one column\" error.\n+                self.rhs.alias_cols = False\n+                # default_cols may not always exist, but set it defensively if present.\n+                try:\n+                    self.rhs.default_cols = False\n+                except Exception:\n+                    pass\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n \n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..56c5939 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,18 +86,19 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            rhs_query = getattr(self.rhs, 'query', self.rhs)\n+            if (not getattr(rhs_query, 'has_select_fields', True) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n-                self.rhs.clear_select_clause()\n+                rhs_query.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n-                        self.lhs.output_field.model == self.rhs.model):\n+                        getattr(rhs_query, 'model', None) == self.lhs.output_field.model):\n                     # A case like Restaurant.objects.filter(place__in=restaurant_qs),\n                     # where place is a OneToOneField and the primary key of\n                     # Restaurant.\n                     target_field = self.lhs.field.name\n                 else:\n                     target_field = self.lhs.field.target_field.name\n-                self.rhs.add_fields([target_field], True)\n+                rhs_query.add_fields([target_field], True)\n             return super().as_sql(compiler, connection)\n \n \ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..70440b6 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,9 +401,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n-                self.rhs.clear_select_clause()\n-                self.rhs.add_fields(['pk'])\n+            rhs_query = getattr(self.rhs, 'query', self.rhs)\n+            if not getattr(rhs_query, 'has_select_fields', True):\n+                rhs_query.clear_select_clause()\n+                rhs_query.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n \n     def get_rhs_op(self, connection, rhs):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..1eddde1 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -89,6 +89,10 @@ class RelatedIn(In):\n             if (not getattr(self.rhs, 'has_select_fields', True) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n+                # Clear any auto-populated select mask that could cause multiple\n+                # columns to be selected in a subquery (e.g. when aliasing is enabled).\n+                if hasattr(self.rhs, 'select_fields'):\n+                    self.rhs.select_fields = []\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n                     # A case like Restaurant.objects.filter(place__in=restaurant_qs),\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..601e53d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -403,6 +403,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n         else:\n             if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n+                # Clear any auto-populated select mask that could cause multiple\n+                # columns to be selected in a subquery (e.g. when aliasing is enabled).\n+                if hasattr(self.rhs, 'select_fields'):\n+                    self.rhs.select_fields = []\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n \n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..1282dbe 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n@@ -96,7 +95,8 @@ class RelatedIn(In):\n                     # Restaurant.\n                     target_field = self.lhs.field.name\n                 else:\n-                    target_field = self.lhs.field.target_field.name\n+                    # Prefer the related target field name when available, fallback to pk.\n+                    target_field = getattr(self.lhs.field.target_field, 'name', 'pk')\n                 self.rhs.add_fields([target_field], True)\n             return super().as_sql(compiler, connection)\n \n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..f6f4796 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,11 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            # Ensure the RHS subquery selects only the appropriate target column.\n+            # This avoids \"subquery must return only one column\" errors when the\n+            # default columns would otherwise be selected (e.g., when combining\n+            # Q() objects with OR).\n+            if hasattr(self.rhs, 'clear_select_clause'):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..de0e9ec 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,8 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            needs_single_col = (not getattr(self.rhs, 'has_select_fields', True)) or getattr(self.rhs, 'default_cols', False)\n+            if needs_single_col:\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..9e5d184 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            # Ensure RHS subquery selects a single column (typically the primary key).\n+            # Some query combinations (e.g., OR'ed Q objects) can cause the RHS\n+            # query to keep default columns. Force it down to a single column\n+            # if no explicit select was defined or default cols are still enabled.\n+            if (not getattr(self.rhs, 'has_select_fields', True)) or getattr(self.rhs, 'default_cols', False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/fields/related_lookups.py": [
          "\nfunction: RelatedIn.as_sql\nline: 89\nline: 101"
        ],
        "django/db/models/lookups.py": [
          "\nfunction: In.process_rhs\nline: 404\nline: 407"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ac19932 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if (not getattr(self.rhs, 'has_select_fields', lambda: True)() and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..68d7945 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,7 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            if not getattr(self.rhs, 'has_select_fields', lambda: True)():\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..1b8bb09 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,11 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            # Ensure subqueries used on related lookups only select the needed field.\n+            has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(has_select_fields):\n+                has_select_fields = has_select_fields()\n+            if (not has_select_fields and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..4a7bd11 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            if callable(has_select_fields):\n+                has_select_fields = has_select_fields()\n+            if not has_select_fields:\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..5c9db72 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,8 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or\n+                    getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..46df497 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,13 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            # If the RHS is a QuerySet, ensure it only selects a single column.\n+            # In some query combinations (e.g. ORed Q objects), the subquery may\n+            # have default columns selected, which would produce a multi-column\n+            # subquery and cause a database error. Reduce it to the primary key\n+            # unless an explicit selection was made by the user.\n+            if (not getattr(self.rhs, 'has_select_fields', True) or\n+                    getattr(self.rhs, 'default_cols', False)):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ba21769 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..12f1d8e 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,10 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            # If the RHS is a queryset and it's currently selecting the model's\n+            # default columns (i.e. no explicit projection), force it to select\n+            # only the primary key so the subquery returns a single column.\n+            if (not getattr(self.rhs, 'has_select_fields', True)) or getattr(self.rhs, 'default_cols', False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..319e3db 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,11 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            # Ensure subqueries only select the target column. If the RHS is using\n+            # default columns (i.e., selecting all fields), force it to select the\n+            # target field to avoid multi-column subqueries.\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or\n+                    getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..23abb1f 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,11 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            # If the RHS subquery is selecting default columns (all fields),\n+            # force it to select only the primary key to satisfy IN's single\n+            # column requirement.\n+            if (not getattr(self.rhs, 'has_select_fields', True) or\n+                    getattr(self.rhs, 'default_cols', False)):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ba21769 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..4fd4f14 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,9 +401,17 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n-                self.rhs.clear_select_clause()\n-                self.rhs.add_fields(['pk'])\n+            # Ensure the RHS subquery selects a single column. In some cases\n+            # (e.g. when combining Q objects with OR), the compiler may leave\n+            # default columns enabled on the subquery which would otherwise\n+            # yield multiple columns and trigger \"subquery must return only one column\".\n+            # If no explicit select list was provided, or default columns are enabled,\n+            # narrow the RHS to the primary key.\n+            if hasattr(self.rhs, 'clear_select_clause'):\n+                if (not getattr(self.rhs, 'has_select_fields', True)\n+                        or getattr(self.rhs, 'default_cols', False)):\n+                    self.rhs.clear_select_clause()\n+                    self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n \n     def get_rhs_op(self, connection, rhs):\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..74fdecc 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,18 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            rhs_has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            # Treat queries that only have default columns due to aliasing as not\n+            # having explicit select fields, so we can restrict them to the\n+            # correct target field.\n+            only_default_cols = (\n+                getattr(self.rhs, 'default_cols', False) and\n+                getattr(self.rhs, 'alias_cols', False) and\n+                not getattr(self.rhs, 'select', ()) and\n+                not getattr(self.rhs, 'values_select', ()) and\n+                not getattr(self.rhs, 'annotations', {})\n+            )\n+            if ((not rhs_has_select_fields or only_default_cols) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..77573a9 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,21 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            # Ensure subqueries used in __in select only one column (the PK)\n+            # when no explicit select has been defined on the RHS. In some\n+            # cases (e.g. ORed Q objects), the query may have alias_cols and\n+            # default_cols set which would otherwise cause selection of all\n+            # default model columns and break with \"subquery must return only\n+            # one column\".\n+            rhs_has_select_fields = getattr(self.rhs, 'has_select_fields', True)\n+            only_default_cols = (\n+                getattr(self.rhs, 'default_cols', False) and\n+                getattr(self.rhs, 'alias_cols', False) and\n+                not getattr(self.rhs, 'select', ()) and\n+                not getattr(self.rhs, 'values_select', ()) and\n+                not getattr(self.rhs, 'annotations', {})\n+            )\n+            if hasattr(self.rhs, 'clear_select_clause') and (not rhs_has_select_fields or only_default_cols):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ba21769 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,7 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n+            if ((not getattr(self.rhs, 'has_select_fields', True) or getattr(self.rhs, 'default_cols', False)) and\n                     not getattr(self.lhs.field.target_field, 'primary_key', False)):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\ndiff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..fd05c79 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,7 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            if (not getattr(self.rhs, 'has_select_fields', True)) or getattr(self.rhs, 'default_cols', False):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 73cceb9..96d07cc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -401,7 +401,8 @@ class In(FieldGetDbPrepValueIterableMixin, BuiltinLookup):\n             placeholder = '(' + ', '.join(sqls) + ')'\n             return (placeholder, sqls_params)\n         else:\n-            if not getattr(self.rhs, 'has_select_fields', True):\n+            if (not getattr(self.rhs, 'has_select_fields', True)\n+                    or getattr(self.rhs, 'default_cols', False)):\n                 self.rhs.clear_select_clause()\n                 self.rhs.add_fields(['pk'])\n             return super().process_rhs(compiler, connection)\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/fields/related_lookups.py b/django/db/models/fields/related_lookups.py\nindex 03b5739..ea5263b 100644\n--- a/django/db/models/fields/related_lookups.py\n+++ b/django/db/models/fields/related_lookups.py\n@@ -86,8 +86,7 @@ class RelatedIn(In):\n                     AND)\n             return root_constraint.as_sql(compiler, connection)\n         else:\n-            if (not getattr(self.rhs, 'has_select_fields', True) and\n-                    not getattr(self.lhs.field.target_field, 'primary_key', False)):\n+            if not getattr(self.rhs, 'has_select_fields', True):\n                 self.rhs.clear_select_clause()\n                 if (getattr(self.lhs.output_field, 'primary_key', False) and\n                         self.lhs.output_field.model == self.rhs.model):\n",
  "7_resolved": false
}