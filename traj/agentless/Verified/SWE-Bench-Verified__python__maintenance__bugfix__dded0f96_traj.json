{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__dded0f96",
  "original_id": "django__django-15368",
  "1_model_selected_files": [
    "django/db/models/query.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/query.py",
    "django/db/models/expressions.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/sql/query.py",
    "django/db/models/fields/related.py",
    "django/db/models/__init__.py",
    "django/db/models/base.py",
    "django/db/models/query_utils.py",
    "django/db/models/utils.py",
    "django/db/models/functions/text.py",
    "django/db/models/constraints.py",
    "django/db/models/fields/__init__.py",
    "django/db/models/lookups.py",
    "django/db/models/indexes.py",
    "django/db/models/sql/where.py",
    "django/db/models/functions/window.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/functions/comparison.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/options.py",
    "django/db/models/sql/datastructures.py",
    "django/db/models/fields/files.py",
    "django/db/models/sql/constants.py",
    "django/db/models/aggregates.py",
    "django/db/models/fields/json.py",
    "django/db/models/functions/mixins.py",
    "django/db/models/functions/math.py",
    "django/db/models/constants.py",
    "django/db/models/fields/mixins.py",
    "django/db/models/fields/proxy.py",
    "django/db/models/deletion.py",
    "django/db/models/fields/reverse_related.py"
  ],
  "3_final_combined_files": [
    "django/db/models/query.py",
    "django/db/models/expressions.py",
    "django/db/models/sql/compiler.py"
  ],
  "4_related_elements": {
    "django/db/models/query.py": [
      "function: QuerySet.bulk_update\nfunction: QuerySet._validate_values_are_expressions\nfunction: QuerySet.update\nfunction: QuerySet._update"
    ],
    "django/db/models/expressions.py": [
      "class: F\nclass: Expression\nclass: BaseExpression\nfunction: BaseExpression._parse_expressions\nclass: Value\nclass: Case\nclass: When"
    ],
    "django/db/models/sql/compiler.py": [
      "class: SQLUpdateCompiler"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.bulk_update\nline: 673"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..37e5910 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Support plain F(...) and any expression-like object that\n+                    # can be resolved by the ORM.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..8197f75 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Use duck typing to allow plain F(...) and other expressions\n+                    # that implement resolve_expression to be passed through.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..e7ad073 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat objects that implement the expression API (e.g., F()) as expressions.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..22aafee 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like object that can be resolved by the ORM,\n+                    # e.g., plain F() expressions, by duck-typing on resolve_expression().\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..974a957 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,7 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..ae85fee 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like value (duck-typed) that can be resolved.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..3169520 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like object (e.g., F) that implements resolve_expression.\n+                    # Using duck-typing here ensures support for F() and other non-Expression classes\n+                    # that still participate in expression resolution.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..30f0b47 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object that implements the expression protocol\n+                    # (i.e., has resolve_expression) as an expression; otherwise\n+                    # wrap it in a Value.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..974a957 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,7 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..99ac57f 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept expression-like values (e.g., F('...')) via duck typing.\n+                    # Plain values are wrapped in Value() to be used in expressions.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.bulk_update\nline: 673"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..c8cd5e2 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any Django expression-like object (e.g., F expressions) as an expression.\n+                    # Use duck-typing on resolve_expression rather than a strict isinstance check.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..15b21e3 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any value that implements resolve_expression as an expression.\n+                    # This covers plain F(...) and other expression-like objects.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..5bb4012 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any value that implements the expression protocol\n+                    # (has resolve_expression) as a valid expression, e.g. F().\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..4c6f9be 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Allow plain expressions like F() by duck-typing on resolve_expression.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..fcae513 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object implementing the expression protocol as an expression\n+                    # (e.g., plain F(...) instances), otherwise wrap in Value.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..c9504d6 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object that implements the expression interface\n+                    # (i.e., has resolve_expression) as an expression, e.g., F().\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..d45a216 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Allow plain expression-like assignments (e.g., F('field')) to pass through.\n+                    # Use duck typing to detect expressions rather than a strict type check.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..415b773 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like value that can be resolved by the ORM,\n+                    # e.g., F() expressions, annotations, etc.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..453e179 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like object (e.g., F() expressions) via duck typing.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        ""
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.bulk_update\nline: 673"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..59ee792 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like object (e.g., F expressions) that\n+                    # can be resolved by the ORM; otherwise wrap as a Value.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..a8d21ac 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any object implementing the expression protocol (e.g., F).\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..b303735 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Support plain F(...) and other expressions by duck-typing.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..30f3aaa 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object with a resolve_expression method as an expression\n+                    # (e.g., F() expressions), otherwise wrap the value.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..e10f6af 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Support plain F(...) and other expressions by duck-typing.\n+                    # If the attribute doesn't implement the expression protocol,\n+                    # wrap it in Value() so it becomes a literal.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..144e0f7 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat objects implementing the expression protocol (e.g., F())\n+                    # as expressions rather than wrapping them as Value().\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..f6630f9 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object that provides resolve_expression() as an expression.\n+                    # This allows plain F(...) and other expression-like objects to work.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..8f3983d 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like value (duck typing), e.g., F(), Func(), etc.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..720d56e 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat values as expressions if they implement the expression API.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..eb3200a 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept expression-like values (e.g., F objects) by duck-typing.\n+                    # If the value doesn't implement resolve_expression(), treat it as a literal.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.bulk_update\nline: 673"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..c85306f 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any expression-like value via duck typing.\n+                    # Plain F() expressions (and other custom expressions) implement\n+                    # resolve_expression but may not be instances of Expression.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..9f1e536 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object implementing the expression protocol as an expression.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..bb2d3be 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object implementing the expressions protocol as an expression.\n+                    # Plain F() expressions don't subclass Expression but do define resolve_expression().\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..e0ee0e0 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Use duck typing to detect expressions, allowing plain F() and\n+                    # custom expressions that implement the expression API.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..fdd4f78 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Treat any object with a 'resolve_expression' method as an expression.\n+                    # This supports plain F(...) and other expression-like objects.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..ec9acd2 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept F() and any other expression-like values by checking for\n+                    # the presence of resolve_expression, instead of a strict type check.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..56ee45f 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Accept any object that behaves like an expression (duck-typing).\n+                    # Plain F(...) instances aren't subclasses of Expression but do\n+                    # implement resolve_expression, so handle them as expressions.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..f8a6eaf 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,8 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Support duck-typed expressions (e.g., F() and other custom expressions)\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..b782f71 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,10 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Allow any expression-like object (e.g., F() expressions) by\n+                    # checking for the resolve_expression protocol rather than\n+                    # restricting to the Expression base class.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..5c25918 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Detect Django expressions via duck typing to support plain F() and\n+                    # other expression-like objects that implement resolve_expression.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 8c5f021..37e5910 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -670,7 +670,9 @@ class QuerySet:\n                 when_statements = []\n                 for obj in batch_objs:\n                     attr = getattr(obj, field.attname)\n-                    if not isinstance(attr, Expression):\n+                    # Support plain F(...) and any expression-like object that\n+                    # can be resolved by the ORM.\n+                    if not hasattr(attr, 'resolve_expression'):\n                         attr = Value(attr, output_field=field)\n                     when_statements.append(When(pk=obj.pk, then=attr))\n                 case_statement = Case(*when_statements, output_field=field)\n",
  "7_resolved": true
}