{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__61a7a81e",
  "original_id": "django__django-12663",
  "1_model_selected_files": [
    "django/db/models/sql/query.py",
    "django/db/models/lookups.py",
    "django/db/models/query.py",
    "django/db/models/fields/__init__.py",
    "django/utils/functional.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/query.py",
    "django/db/models/query_utils.py",
    "django/db/models/fields/related.py",
    "django/db/models/sql/subqueries.py",
    "django/utils/functional.py",
    "django/db/models/__init__.py",
    "django/db/models/sql/query.py",
    "django/db/models/expressions.py",
    "django/db/models/lookups.py",
    "django/db/models/base.py",
    "django/db/models/manager.py",
    "django/db/models/sql/where.py",
    "django/db/models/sql/datastructures.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/models/sql/compiler.py",
    "django/db/backends/oracle/operations.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/backends/mysql/schema.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/sql/__init__.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/migrations/questioner.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/migrations/operations/models.py",
    "django/db/models/fields/__init__.py",
    "django/db/models/deletion.py",
    "django/db/backends/postgresql/features.py",
    "django/db/backends/base/features.py",
    "django/db/migrations/serializer.py",
    "django/db/backends/mysql/features.py",
    "django/db/backends/postgresql/base.py",
    "django/db/models/options.py",
    "django/db/backends/base/schema.py",
    "django/db/backends/mysql/base.py",
    "django/db/backends/postgresql/introspection.py",
    "django/utils/datastructures.py",
    "django/db/models/sql/constants.py",
    "django/db/migrations/autodetector.py",
    "django/db/backends/dummy/base.py",
    "django/db/backends/sqlite3/features.py",
    "django/db/models/constraints.py",
    "django/db/migrations/operations/utils.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/backends/mysql/operations.py",
    "django/utils/text.py"
  ],
  "3_final_combined_files": [
    "django/db/models/query.py",
    "django/db/models/sql/query.py",
    "django/db/models/lookups.py",
    "django/db/models/query_utils.py",
    "django/db/models/fields/related.py"
  ],
  "4_related_elements": {
    "django/db/models/query.py": [
      "function: QuerySet.filter\nfunction: QuerySet._filter_or_exclude\nfunction: QuerySet._filter_or_exclude_inplace\nfunction: QuerySet.annotate\nfunction: QuerySet.resolve_expression"
    ],
    "django/db/models/sql/query.py": [
      "function: Query.add_q\nfunction: Query.build_filter\nfunction: Query.build_lookup\nfunction: Query.resolve_lookup_value\nfunction: Query.check_query_object_type\nfunction: Query.check_related_objects\nfunction: Query.add_annotation\nfunction: Query.resolve_expression\nfunction: Query.solve_lookup_type"
    ],
    "django/db/models/lookups.py": [
      "class: Lookup\nclass: Exact\nclass: BuiltinLookup\nclass: FieldGetDbPrepValueMixin\nclass: FieldGetDbPrepValueIterableMixin\nvariable: Lookup.prepare_rhs"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: Query.resolve_lookup_value"
        ],
        "django/db/models/lookups.py": [
          "\nfunction: Lookup.get_prep_lookup"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..6502cfc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,17 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs_value = self.rhs\n+            # If RHS is a model instance (or a SimpleLazyObject proxying one),\n+            # use its primary key to support comparisons against annotations or\n+            # subqueries that yield raw IDs (e.g., values() on a ForeignKey).\n+            try:\n+                pk = rhs_value.pk\n+            except Exception:\n+                pk = None\n+            if pk is not None and not hasattr(rhs_value, 'resolve_expression'):\n+                rhs_value = pk\n+            return self.lhs.output_field.get_prep_value(rhs_value)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..039c5cf 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,29 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their real values.\n+        rhs = self.rhs\n+        try:\n+            from django.utils.functional import LazyObject\n+        except Exception:\n+            LazyObject = None\n+        if LazyObject is not None and isinstance(rhs, LazyObject):\n+            # Force evaluation and fetch the wrapped value if available.\n+            try:\n+                rhs._setup()\n+            except Exception:\n+                pass\n+            rhs = getattr(rhs, '_wrapped', rhs)\n+\n+        # If a model instance is provided, compare using its primary key.\n+        if hasattr(rhs, '_meta'):\n+            rhs = getattr(rhs, 'pk', rhs)\n+\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..5fa1fcc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,19 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # Evaluate SimpleLazyObject/LazyObject to their wrapped values.\n+            if hasattr(rhs, '_setup') and hasattr(rhs, '_wrapped'):\n+                rhs._setup()\n+                rhs = rhs._wrapped\n+            # If RHS is a model instance, use its primary key.\n+            if hasattr(rhs, '_meta') and hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..1a92a58 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,10 +68,22 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n+        # If RHS is an expression, let it handle its own preparation.\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        # Prepare RHS using the LHS output field, unwrapping model instances\n+        # (including SimpleLazyObject-wrapped instances) to their primary key.\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # Accessing '_meta' on a SimpleLazyObject will force evaluation.\n+            # For model instances, compare against their primary key.\n+            try:\n+                if hasattr(rhs, '_meta'):\n+                    rhs = getattr(rhs, 'pk', rhs)\n+            except Exception:\n+                # If evaluation raises, fall back to the original value.\n+                pass\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..8e4b932 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,15 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # If RHS is a model instance (or a lazy proxy to one), use its primary key.\n+        # This ensures proper preparation when LHS's output field is a non-relational\n+        # field (e.g., IntegerField from a Subquery/annotation).\n+        if self.prepare_rhs and hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..541b84d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,22 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their real value.\n+        try:\n+            from django.utils.functional import LazyObject, empty\n+            rhs = self.rhs\n+            if isinstance(rhs, LazyObject):\n+                if getattr(rhs, '_wrapped', empty) is empty:\n+                    rhs._setup()\n+                rhs = rhs._wrapped\n+        except Exception:\n+            rhs = self.rhs\n+        # If the RHS is a model instance, compare on its primary key.\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            if hasattr(rhs, '_meta') and hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..913d9bf 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,32 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        # Unwrap SimpleLazyObject instances to their underlying value to\n+        # ensure proper preparation by the output field.\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n+        if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+            # Force evaluation and use the wrapped object.\n+            try:\n+                rhs._setup()\n+            except Exception:\n+                pass\n+            try:\n+                rhs = rhs._wrapped\n+            except Exception:\n+                # Fall back to the original rhs if unwrapping fails.\n+                pass\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        # If a model instance is provided on the RHS, use its primary key.\n+        if self.prepare_rhs and hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..b0b24e2 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,26 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # Unwrap any lazy objects (e.g., SimpleLazyObject) before preparing.\n+        rhs = self.rhs\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        try:\n+            from django.utils.functional import SimpleLazyObject, empty\n+            if isinstance(rhs, SimpleLazyObject):\n+                # Force evaluation to get the underlying object.\n+                if getattr(rhs, '_wrapped', empty) is empty:\n+                    rhs._setup()\n+                rhs = rhs._wrapped\n+        except Exception:\n+            # If unwrapping fails for any reason, fall back to the original rhs.\n+            pass\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # If the RHS is a model instance, compare against its primary key.\n+            if hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..a620ee3 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,31 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their real value.\n+        rhs = self.rhs\n+        try:\n+            from django.utils.functional import LazyObject\n+        except Exception:\n+            LazyObject = None\n+        if LazyObject is not None and isinstance(rhs, LazyObject):\n+            # Force evaluation of the lazy object to avoid type mismatches during\n+            # preparation (e.g., lazy User instance when LHS expects an integer pk).\n+            setup = getattr(rhs, '_setup', None)\n+            if callable(setup):\n+                setup()\n+            rhs = getattr(rhs, '_wrapped', rhs)\n+        # If a model instance is provided, use its primary key for lookups.\n+        try:\n+            from django.db import models as dj_models\n+            if isinstance(rhs, dj_models.Model):\n+                rhs = rhs.pk\n+        except Exception:\n+            pass\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..6103fff 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,31 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # Unwrap SimpleLazyObject to its underlying value so that it can be\n+            # properly prepared by the output field. This covers cases where a\n+            # FK id (integer) annotation is compared to a lazily-evaluated\n+            # model instance (e.g., request.user), which should resolve to pk.\n+            try:\n+                from django.utils.functional import SimpleLazyObject\n+            except Exception:\n+                SimpleLazyObject = None\n+            was_lazy = False\n+            if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+                was_lazy = True\n+                try:\n+                    rhs._setup()\n+                except Exception:\n+                    # If forcing evaluation fails for any reason, fall back to\n+                    # the lazy object as-is; the field may still handle it.\n+                    pass\n+                rhs = getattr(rhs, '_wrapped', rhs)\n+            # If the unwrapped value is a model instance, use its primary key.\n+            # Restrict this behavior to lazily-wrapped values to avoid\n+            # unexpectedly coercing non-lazy objects with a 'pk' attribute.\n+            if was_lazy and hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/sql/query.py": [
          "\nfunction: Query.build_filter\nline: 1264\nline: 1272"
        ],
        "django/db/models/lookups.py": [
          "\nfunction: Lookup.get_prep_lookup\nline: 70\nline: 75"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..544da7d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,25 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # If rhs is an expression, leave it as-is.\n+        rhs = self.rhs\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) before preparation.\n+        try:\n+            from django.utils.functional import LazyObject\n+        except Exception:\n+            LazyObject = None\n+        if LazyObject is not None and isinstance(rhs, LazyObject):\n+            # Ensure the lazy object is evaluated to its wrapped value.\n+            rhs._setup()\n+            rhs = rhs._wrapped\n+        # If comparing against a model instance, use its primary key.\n+        if hasattr(rhs, 'pk') and hasattr(rhs, '_meta'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..b6036f1 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,26 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # If the right-hand side is an expression, leave preparation to the compiler.\n+        rhs = self.rhs\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their real value.\n+        try:\n+            from django.utils.functional import LazyObject\n+        except Exception:\n+            LazyObject = None\n+        if LazyObject is not None and isinstance(rhs, LazyObject):\n+            # Ensure the lazy object is evaluated and unwrap it.\n+            if hasattr(rhs, '_setup'):\n+                rhs._setup()\n+            rhs = getattr(rhs, '_wrapped', rhs)\n+        # If the RHS is a model instance, use its primary key value.\n+        if hasattr(rhs, '_meta'):\n+            rhs = getattr(rhs, 'pk', rhs)\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..87849f9 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,35 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        # Unwrap SimpleLazyObject instances to their underlying value.\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n+        if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+            try:\n+                # Force evaluation to get the wrapped object.\n+                rhs._setup()\n+                rhs = rhs._wrapped\n+            except Exception:\n+                # If unwrapping fails for any reason, fall back to the original value.\n+                pass\n+\n+        # For exact lookups, if the RHS is a model instance, use its primary key.\n+        if getattr(self, 'lookup_name', None) == 'exact':\n+            try:\n+                from django.db.models import Model\n+            except Exception:\n+                Model = None\n+            if (Model is not None and isinstance(rhs, Model)) or (Model is None and hasattr(rhs, 'pk')):\n+                rhs = getattr(rhs, 'pk', rhs)\n+\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..69f14e5 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,26 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # Unwrap SimpleLazyObject to its underlying value if present.\n+            try:\n+                from django.utils.functional import SimpleLazyObject\n+            except Exception:\n+                SimpleLazyObject = None\n+            if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+                # Ensure evaluation, then unwrap.\n+                setup = getattr(rhs, '_setup', None)\n+                if callable(setup):\n+                    setup()\n+                rhs = getattr(rhs, '_wrapped', rhs)\n+            # If RHS is a model instance, compare against its primary key.\n+            try:\n+                from django.db.models import Model\n+            except Exception:\n+                Model = None\n+            if Model is not None and isinstance(rhs, Model):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..49e82be 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,31 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        # Unwrap SimpleLazyObject values to their underlying object.\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n+        if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+            try:\n+                rhs._setup()\n+                rhs = rhs._wrapped\n+            except Exception:\n+                # If unwrapping fails for any reason, fall back to original rhs.\n+                pass\n+        # If a model instance is passed on the RHS, compare using its primary key.\n+        try:\n+            from django.db.models import Model\n+        except Exception:\n+            Model = None\n+        if Model is not None and isinstance(rhs, Model):\n+            rhs = rhs.pk\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..23ba8b9 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,20 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        # If the RHS is a model instance (or a SimpleLazyObject wrapping one),\n+        # use its primary key for preparation. Accessing .pk forces evaluation\n+        # for SimpleLazyObject without requiring a direct import or isinstance check.\n+        rhs = self.rhs\n+        try:\n+            pk = getattr(rhs, 'pk')\n+        except Exception:\n+            pk = None\n+        else:\n+            if pk is not None:\n+                rhs = pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..3be6c0d 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,11 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            # Unwrap SimpleLazyObject and model instances by using their primary key\n+            # when preparing the RHS. This ensures comparisons against annotated\n+            # integer-like expressions work with lazily-evaluated model instances.\n+            rhs = getattr(self.rhs, 'pk', self.rhs)\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..5b25b42 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,27 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        # Unwrap SimpleLazyObject and normalize model instances to primary keys\n+        value = self.rhs\n+        try:\n+            from django.utils.functional import SimpleLazyObject, empty\n+        except Exception:\n+            SimpleLazyObject = None\n+            empty = None\n+        if SimpleLazyObject is not None and isinstance(value, SimpleLazyObject):\n+            # Force evaluation if needed\n+            if empty is not None and getattr(value, '_wrapped', empty) is empty:\n+                value._setup()\n+            value = value._wrapped\n+        try:\n+            from django.db.models import Model\n+        except Exception:\n+            Model = None\n+        if Model is not None and isinstance(value, Model):\n+            value = value.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(value)\n+        return value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..42ee516 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,32 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # Unwrap and normalize RHS values such as SimpleLazyObject or model instances.\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n+        if SimpleLazyObject is not None and isinstance(rhs, SimpleLazyObject):\n+            # Force evaluation if it wraps a model instance by accessing 'pk'.\n+            _sentinel = object()\n+            pk = getattr(rhs, 'pk', _sentinel)\n+            if pk is not _sentinel:\n+                rhs = pk\n+            else:\n+                wrapped = getattr(rhs, '_wrapped', None)\n+                if wrapped is not None:\n+                    rhs = wrapped\n+        # If a model instance is passed, compare against its primary key value.\n+        try:\n+            from django.db.models import Model\n+        except Exception:\n+            Model = None\n+        if Model is not None and isinstance(rhs, Model):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..0c193e5 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,16 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # If rhs is (or wraps) a model instance, compare against its primary key.\n+            # Using hasattr() triggers evaluation for SimpleLazyObject wrapping a model.\n+            if hasattr(rhs, '_meta'):\n+                rhs = getattr(rhs, 'pk', rhs)\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/lookups.py": [
          "\nfunction: Lookup.get_prep_lookup\nline: 70\nfunction: FieldGetDbPrepValueIterableMixin.get_prep_lookup\nline: 215"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..257423b 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,27 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # Unwrap LazyObject (e.g., SimpleLazyObject) to its underlying value.\n+            try:\n+                from django.utils.functional import LazyObject\n+            except Exception:\n+                LazyObject = None\n+            if LazyObject is not None and isinstance(rhs, LazyObject):\n+                try:\n+                    rhs._setup()\n+                    rhs = rhs._wrapped\n+                except Exception:\n+                    # If evaluation fails for any reason, fall through with original rhs.\n+                    pass\n+            # If the rhs is a Model instance, compare using its primary key.\n+            try:\n+                from django.db.models.base import Model\n+            except Exception:\n+                Model = None\n+            if Model is not None and isinstance(rhs, Model):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +242,23 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # Unwrap LazyObject (e.g., SimpleLazyObject) and convert model instances to PKs.\n+                try:\n+                    from django.utils.functional import LazyObject\n+                except Exception:\n+                    LazyObject = None\n+                if LazyObject is not None and isinstance(rhs_value, LazyObject):\n+                    try:\n+                        rhs_value._setup()\n+                        rhs_value = rhs_value._wrapped\n+                    except Exception:\n+                        pass\n+                try:\n+                    from django.db.models.base import Model\n+                except Exception:\n+                    Model = None\n+                if Model is not None and isinstance(rhs_value, Model):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..a2ebb75 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,10 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = getattr(self.rhs, 'pk', self.rhs)\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +222,10 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                rhs_value = getattr(rhs_value, 'pk', rhs_value)\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..fea896b 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,20 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n-        if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+        rhs = self.rhs\n+        # Unwrap SimpleLazyObject (or similar lazy wrappers) to the actual value.\n+        if hasattr(rhs, '_setup') and hasattr(rhs, '_wrapped'):\n+            rhs._setup()\n+            rhs = rhs._wrapped\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        if self.prepare_rhs:\n+            # If a model instance is provided, compare using its primary key.\n+            if hasattr(rhs, '_meta') and hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            if hasattr(self.lhs.output_field, 'get_prep_value'):\n+                return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -217,12 +226,20 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n             return self.rhs\n         prepared_values = []\n         for rhs_value in self.rhs:\n+            # Unwrap SimpleLazyObject (or similar lazy wrappers) to the actual value.\n+            if hasattr(rhs_value, '_setup') and hasattr(rhs_value, '_wrapped'):\n+                rhs_value._setup()\n+                rhs_value = rhs_value._wrapped\n             if hasattr(rhs_value, 'resolve_expression'):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            elif self.prepare_rhs:\n+                # If a model instance is provided, compare using its primary key.\n+                if hasattr(rhs_value, '_meta') and hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n+                if hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..3afd276 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,13 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # Unwrap model instances (including SimpleLazyObject) to their primary key.\n+            if hasattr(rhs, 'pk'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -222,6 +226,9 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # Unwrap model instances (including SimpleLazyObject) to their primary key.\n+                if hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..db9b952 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,29 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n+        # If the RHS is an expression, let the database handle it.\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their real value.\n+        try:\n+            from django.utils.functional import LazyObject\n+            if isinstance(rhs, LazyObject):\n+                rhs._setup()\n+                rhs = rhs._wrapped\n+        except Exception:\n+            # If anything goes wrong during unwrapping, fall back to original rhs.\n+            pass\n+        # If RHS is a model instance, compare using its primary key.\n+        try:\n+            from django.db.models import Model\n+            if isinstance(rhs, Model):\n+                rhs = rhs.pk\n+        except Exception:\n+            pass\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -216,13 +234,23 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         prepared_values = []\n+        from django.utils.functional import LazyObject\n+        from django.db.models import Model\n         for rhs_value in self.rhs:\n             if hasattr(rhs_value, 'resolve_expression'):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # Unwrap lazy objects (e.g., SimpleLazyObject).\n+                if isinstance(rhs_value, LazyObject):\n+                    rhs_value._setup()\n+                    rhs_value = rhs_value._wrapped\n+                # If a model instance is provided, compare using its primary key.\n+                if isinstance(rhs_value, Model):\n+                    rhs_value = rhs_value.pk\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..8b4d27e 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,17 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # If rhs looks like a model instance (has a 'pk' attribute),\n+            # use its primary key. This also forces evaluation of lazy\n+            # proxies like SimpleLazyObject.\n+            try:\n+                pk = getattr(rhs, 'pk')\n+            except Exception:\n+                pk = None\n+            else:\n+                rhs = pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +232,14 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If rhs_value looks like a model instance (has a 'pk' attribute),\n+                # use its primary key. This also forces evaluation of lazy proxies.\n+                try:\n+                    pk = getattr(rhs_value, 'pk')\n+                except Exception:\n+                    pk = None\n+                else:\n+                    rhs_value = pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..584577c 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,12 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # Coerce model instances (including lazily wrapped ones) to their\n+            # primary keys before handing off to the field for preparation.\n+            if hasattr(rhs, '_meta'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +227,9 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # Coerce model instances (including lazily wrapped ones) to pks.\n+                if hasattr(rhs_value, '_meta'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..b365474 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,21 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        value = self.rhs\n+        # Unwrap Django LazyObject (e.g., SimpleLazyObject) to its real value.\n+        if hasattr(value, '_setup') and hasattr(value, '_wrapped'):\n+            try:\n+                value._setup()\n+                value = value._wrapped\n+            except Exception:\n+                # If unwrapping fails for any reason, fall back to the original value.\n+                pass\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # If comparing against a model instance, use its primary key value.\n+            if hasattr(value, 'pk'):\n+                value = value.pk\n+            return self.lhs.output_field.get_prep_value(value)\n+        return value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +233,19 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # Unwrap Django LazyObject (e.g., SimpleLazyObject) to its real value.\n+                if hasattr(rhs_value, '_setup') and hasattr(rhs_value, '_wrapped'):\n+                    try:\n+                        rhs_value._setup()\n+                        rhs_value = rhs_value._wrapped\n+                    except Exception:\n+                        pass\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    # If comparing against a model instance, use its primary key value.\n+                    if hasattr(rhs_value, 'pk'):\n+                        rhs_value = rhs_value.pk\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..934ced3 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,24 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        # Resolve SimpleLazyObject and model instances on the RHS before preparing.\n+        value = self.rhs\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+            if isinstance(value, SimpleLazyObject):\n+                # Force evaluation of the lazy object to its wrapped value.\n+                if getattr(value, '_wrapped', object()) is None:\n+                    value._setup()\n+                value = value._wrapped\n+        except Exception:\n+            # If anything goes wrong during lazy resolution, fall back to the original value.\n+            pass\n+        # If a model instance is provided, compare against its primary key.\n+        if getattr(value, '_meta', None) is not None and hasattr(value, 'pk'):\n+            value = value.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(value)\n+        return value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +236,20 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # Resolve SimpleLazyObject and model instances before preparing.\n+                try:\n+                    from django.utils.functional import SimpleLazyObject\n+                    if isinstance(rhs_value, SimpleLazyObject):\n+                        if getattr(rhs_value, '_wrapped', object()) is None:\n+                            rhs_value._setup()\n+                        rhs_value = rhs_value._wrapped\n+                except Exception:\n+                    pass\n+                if getattr(rhs_value, '_meta', None) is not None and hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n+                elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..765282c 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,28 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        # Evaluate Django LazyObject wrappers (e.g., SimpleLazyObject) to their\n+        # underlying value before further processing.\n+        rhs = self.rhs\n+        setup = getattr(rhs, '_setup', None)\n+        if setup is not None and hasattr(rhs, '_wrapped'):\n+            try:\n+                setup()\n+                rhs = rhs._wrapped\n+            except Exception:\n+                # If evaluation fails, proceed with the original rhs; later\n+                # stages will raise a more appropriate error.\n+                pass\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n+        # If a model instance is provided on the RHS, use its primary key\n+        # when comparing against non-relational output fields (e.g., Subquery\n+        # returning a target PK).\n+        if hasattr(rhs, '_meta') and hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -217,12 +234,26 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n             return self.rhs\n         prepared_values = []\n         for rhs_value in self.rhs:\n+            # Evaluate Django LazyObject wrappers (e.g., SimpleLazyObject) to their\n+            # underlying value before further processing.\n+            setup = getattr(rhs_value, '_setup', None)\n+            if setup is not None and hasattr(rhs_value, '_wrapped'):\n+                try:\n+                    setup()\n+                    rhs_value = rhs_value._wrapped\n+                except Exception:\n+                    # If evaluation fails, leave as-is; later stages will raise.\n+                    pass\n             if hasattr(rhs_value, 'resolve_expression'):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # If a model instance is provided, use its primary key.\n+                if hasattr(rhs_value, '_meta') and hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/lookups.py": [
          "\nfunction: Lookup.get_prep_lookup\nfunction: FieldGetDbPrepValueIterableMixin.get_prep_lookup"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..95ee7c8 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,12 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            value = self.rhs\n+            # If the RHS is (or proxies) a model instance, use its primary key.\n+            # This also forces evaluation of SimpleLazyObject wrapping a model.\n+            if hasattr(value, 'pk'):\n+                value = value.pk\n+            return self.lhs.output_field.get_prep_value(value)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +227,9 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If the RHS value is (or proxies) a model instance, use its pk.\n+                if hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..6c0bc16 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,22 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n+        # If rhs is an expression, leave as-is.\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n-        if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+        rhs_value = self.rhs\n+        # If comparing against a model instance (or a SimpleLazyObject wrapping one),\n+        # use its primary key for prep, so integer-based output fields can handle it.\n+        if self.prepare_rhs:\n+            try:\n+                pk = getattr(rhs_value, 'pk')\n+            except Exception:\n+                pk = None\n+            if pk is not None:\n+                rhs_value = pk\n+            if hasattr(self.lhs.output_field, 'get_prep_value'):\n+                return self.lhs.output_field.get_prep_value(rhs_value)\n+        return rhs_value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +232,16 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                if self.prepare_rhs:\n+                    try:\n+                        pk = getattr(rhs_value, 'pk')\n+                    except Exception:\n+                        pk = None\n+                    if pk is not None:\n+                        rhs_value = pk\n+                    if hasattr(self.lhs.output_field, 'get_prep_value'):\n+                        rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..8d4dab2 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,15 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # If rhs is a model instance or a lazy proxy to one (e.g., SimpleLazyObject),\n+        # use its primary key for comparison. hasattr() will trigger evaluation for\n+        # SimpleLazyObject proxies.\n+        if hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -222,6 +228,10 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If a value is a model instance or a lazy proxy (e.g., SimpleLazyObject),\n+                # compare by its primary key.\n+                if hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..461ce64 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,12 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs = self.rhs\n+            # If comparing against a model instance (or a lazy proxy to one),\n+            # coerce to its primary key before preparing for the output field.\n+            if hasattr(rhs, '_meta'):\n+                rhs = rhs.pk\n+            return self.lhs.output_field.get_prep_value(rhs)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +227,10 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If comparing against model instances (or lazy proxies),\n+                # coerce them to their primary keys before preparation.\n+                if hasattr(rhs_value, '_meta'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..653224e 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,22 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs_value = self.rhs\n+        # Unwrap SimpleLazyObject to its underlying value, if present.\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n+        if SimpleLazyObject is not None and isinstance(rhs_value, SimpleLazyObject):\n+            # Force evaluation of the lazy object and extract the underlying value.\n+            if hasattr(rhs_value, '_setup'):\n+                rhs_value._setup()\n+            rhs_value = getattr(rhs_value, '_wrapped', rhs_value)\n+        # If the output field can prepare the value, do so. If rhs is a model\n+        # instance, compare against its primary key.\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(getattr(rhs_value, 'pk', rhs_value))\n+        return rhs_value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -216,13 +229,23 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         prepared_values = []\n+        try:\n+            from django.utils.functional import SimpleLazyObject\n+        except Exception:\n+            SimpleLazyObject = None\n         for rhs_value in self.rhs:\n             if hasattr(rhs_value, 'resolve_expression'):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # Unwrap SimpleLazyObject if present.\n+                if SimpleLazyObject is not None and isinstance(rhs_value, SimpleLazyObject):\n+                    if hasattr(rhs_value, '_setup'):\n+                        rhs_value._setup()\n+                    rhs_value = getattr(rhs_value, '_wrapped', rhs_value)\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(getattr(rhs_value, 'pk', rhs_value))\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..58961c0 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,12 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            # If comparing to a model instance (or a SimpleLazyObject proxy),\n+            # allow using its primary key value.\n+            rhs_value = self.rhs\n+            if not hasattr(rhs_value, 'resolve_expression') and hasattr(rhs_value, 'pk'):\n+                rhs_value = rhs_value.pk\n+            return self.lhs.output_field.get_prep_value(rhs_value)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n@@ -222,6 +227,10 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If a model instance (or SimpleLazyObject proxy) is provided,\n+                # use its primary key.\n+                if not hasattr(rhs_value, 'resolve_expression') and hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..80f3878 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,24 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their underlying value.\n+        if hasattr(rhs, '_setup') and hasattr(rhs, '_wrapped'):\n+            try:\n+                rhs._setup()\n+                rhs = rhs._wrapped\n+            except Exception:\n+                # If evaluation fails for any reason, fall back to original rhs.\n+                pass\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            # If RHS is a model instance, use its primary key for non-relational fields.\n+            if hasattr(rhs, 'pk'):\n+                try:\n+                    rhs = rhs.pk\n+                except Exception:\n+                    pass\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +236,23 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # Unwrap lazy objects (e.g., SimpleLazyObject) to their underlying value.\n+                if hasattr(rhs_value, '_setup') and hasattr(rhs_value, '_wrapped'):\n+                    try:\n+                        rhs_value._setup()\n+                        rhs_value = rhs_value._wrapped\n+                    except Exception:\n+                        # If evaluation fails for any reason, keep original rhs_value.\n+                        pass\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    # If RHS is a model instance, use its primary key for non-relational fields.\n+                    if hasattr(rhs_value, 'pk'):\n+                        try:\n+                            rhs_value = rhs_value.pk\n+                        except Exception:\n+                            pass\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..d584020 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,14 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n+        rhs = self.rhs\n+        # If the right-hand side is a model instance (including a SimpleLazyObject\n+        # that resolves to one), use its primary key for preparation.\n+        if hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -222,6 +227,10 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # alongside real values.\n                 pass\n             elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                # If a model instance (or a SimpleLazyObject resolving to one)\n+                # is provided, use its primary key.\n+                if hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n                 rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..4d56afa 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -70,9 +70,31 @@ class Lookup:\n     def get_prep_lookup(self):\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n-        if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+        value = self.rhs\n+        if self.prepare_rhs:\n+            # Unwrap SimpleLazyObject to its underlying value, if needed.\n+            try:\n+                from django.utils.functional import SimpleLazyObject\n+            except Exception:\n+                SimpleLazyObject = None\n+            if SimpleLazyObject is not None and isinstance(value, SimpleLazyObject):\n+                # Force evaluation and extract the wrapped value.\n+                try:\n+                    value._setup()\n+                except Exception:\n+                    # If _setup() isn't available or fails, fall back to using the object as-is.\n+                    pass\n+                value = getattr(value, '_wrapped', value)\n+            # If comparing against a model instance, use its primary key.\n+            try:\n+                from django.db.models import Model\n+                if isinstance(value, Model):\n+                    value = value.pk\n+            except Exception:\n+                pass\n+            if hasattr(self.lhs.output_field, 'get_prep_value'):\n+                return self.lhs.output_field.get_prep_value(value)\n+        return value\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -221,8 +243,28 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                if self.prepare_rhs:\n+                    # Unwrap SimpleLazyObject to its underlying value, if needed.\n+                    try:\n+                        from django.utils.functional import SimpleLazyObject\n+                    except Exception:\n+                        SimpleLazyObject = None\n+                    if SimpleLazyObject is not None and isinstance(rhs_value, SimpleLazyObject):\n+                        try:\n+                            rhs_value._setup()\n+                        except Exception:\n+                            pass\n+                        rhs_value = getattr(rhs_value, '_wrapped', rhs_value)\n+                    # If comparing against a model instance, use its primary key.\n+                    try:\n+                        from django.db.models import Model\n+                        if isinstance(rhs_value, Model):\n+                            rhs_value = rhs_value.pk\n+                    except Exception:\n+                        pass\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n",
        "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..cfe49cf 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -68,11 +68,19 @@ class Lookup:\n             self.lhs, self.rhs = new_exprs\n \n     def get_prep_lookup(self):\n-        if hasattr(self.rhs, 'resolve_expression'):\n-            return self.rhs\n+        rhs = self.rhs\n+        # Unwrap lazy objects (e.g., SimpleLazyObject) to their actual value.\n+        if hasattr(rhs, '_setup') and hasattr(rhs, '_wrapped'):\n+            rhs._setup()\n+            rhs = rhs._wrapped\n+        # If rhs is a model instance, use its primary key for comparison.\n+        if self.prepare_rhs and hasattr(rhs, '_meta') and hasattr(rhs, 'pk'):\n+            rhs = rhs.pk\n+        if hasattr(rhs, 'resolve_expression'):\n+            return rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n-        return self.rhs\n+            return self.lhs.output_field.get_prep_value(rhs)\n+        return rhs\n \n     def get_db_prep_lookup(self, value, connection):\n         return ('%s', [value])\n@@ -217,12 +225,20 @@ class FieldGetDbPrepValueIterableMixin(FieldGetDbPrepValueMixin):\n             return self.rhs\n         prepared_values = []\n         for rhs_value in self.rhs:\n+            # Unwrap lazy objects (e.g., SimpleLazyObject) to their actual value.\n+            if hasattr(rhs_value, '_setup') and hasattr(rhs_value, '_wrapped'):\n+                rhs_value._setup()\n+                rhs_value = rhs_value._wrapped\n             if hasattr(rhs_value, 'resolve_expression'):\n                 # An expression will be handled by the database but can coexist\n                 # alongside real values.\n                 pass\n-            elif self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-                rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n+            else:\n+                # If rhs_value is a model instance, use its primary key.\n+                if self.prepare_rhs and hasattr(rhs_value, '_meta') and hasattr(rhs_value, 'pk'):\n+                    rhs_value = rhs_value.pk\n+                if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n+                    rhs_value = self.lhs.output_field.get_prep_value(rhs_value)\n             prepared_values.append(rhs_value)\n         return prepared_values\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9cf4391..6502cfc 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -71,7 +71,17 @@ class Lookup:\n         if hasattr(self.rhs, 'resolve_expression'):\n             return self.rhs\n         if self.prepare_rhs and hasattr(self.lhs.output_field, 'get_prep_value'):\n-            return self.lhs.output_field.get_prep_value(self.rhs)\n+            rhs_value = self.rhs\n+            # If RHS is a model instance (or a SimpleLazyObject proxying one),\n+            # use its primary key to support comparisons against annotations or\n+            # subqueries that yield raw IDs (e.g., values() on a ForeignKey).\n+            try:\n+                pk = rhs_value.pk\n+            except Exception:\n+                pk = None\n+            if pk is not None and not hasattr(rhs_value, 'resolve_expression'):\n+                rhs_value = pk\n+            return self.lhs.output_field.get_prep_value(rhs_value)\n         return self.rhs\n \n     def get_db_prep_lookup(self, value, connection):\n",
  "7_resolved": true
}