{
  "instance_id": "SWE-Bench-Verified__python__maintenance__bugfix__1ae3c3bd",
  "original_id": "django__django-13417",
  "1_model_selected_files": [
    "django/db/models/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/query.py"
  ],
  "2_embedding_selected_files": [
    "django/db/models/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/subqueries.py",
    "django/db/models/query_utils.py",
    "django/db/models/base.py",
    "django/db/models/__init__.py",
    "django/db/models/sql/query.py",
    "django/db/models/expressions.py",
    "django/db/models/sql/__init__.py",
    "django/db/backends/mysql/compiler.py",
    "django/db/models/sql/where.py",
    "django/db/backends/mysql/schema.py",
    "django/db/models/manager.py",
    "django/db/models/deletion.py",
    "django/db/backends/base/features.py",
    "django/db/migrations/operations/models.py",
    "django/db/backends/postgresql/operations.py",
    "django/db/models/fields/related.py",
    "django/db/backends/postgresql/introspection.py",
    "django/db/backends/mysql/operations.py",
    "django/db/backends/postgresql/features.py",
    "django/db/backends/sqlite3/operations.py",
    "django/db/backends/postgresql/schema.py",
    "django/db/models/sql/datastructures.py",
    "django/db/models/lookups.py",
    "django/db/models/options.py",
    "django/db/backends/oracle/operations.py",
    "django/db/migrations/questioner.py",
    "django/db/models/fields/proxy.py",
    "django/db/models/fields/related_lookups.py",
    "django/db/backends/base/schema.py",
    "django/db/models/constraints.py",
    "django/db/models/fields/related_descriptors.py",
    "django/db/backends/sqlite3/schema.py",
    "django/db/backends/sqlite3/features.py",
    "django/db/migrations/autodetector.py",
    "django/db/models/enums.py",
    "django/db/backends/oracle/introspection.py",
    "django/db/models/sql/constants.py",
    "django/db/backends/base/operations.py",
    "django/db/models/fields/__init__.py",
    "django/db/models/fields/reverse_related.py",
    "django/db/backends/sqlite3/base.py",
    "django/db/backends/mysql/features.py",
    "django/db/migrations/operations/special.py",
    "django/db/backends/postgresql/base.py",
    "django/db/models/aggregates.py",
    "django/db/backends/postgresql/__init__.py",
    "django/db/migrations/__init__.py",
    "django/db/migrations/operations/__init__.py"
  ],
  "3_final_combined_files": [
    "django/db/models/query.py",
    "django/db/models/sql/compiler.py",
    "django/db/models/sql/query.py",
    "django/db/models/sql/subqueries.py"
  ],
  "4_related_elements": {
    "django/db/models/query.py": [
      "function: QuerySet.ordered\nfunction: QuerySet.annotate\nfunction: QuerySet._annotate\nfunction: QuerySet.order_by"
    ],
    "django/db/models/sql/compiler.py": [
      "function: SQLCompiler.get_order_by\nfunction: SQLCompiler.get_group_by\nfunction: SQLCompiler.collapse_group_by\nfunction: SQLCompiler.as_sql"
    ],
    "django/db/models/sql/query.py": [
      "class: Query\nfunction: Query.add_ordering\nfunction: Query.clear_ordering\nfunction: Query.set_group_by\nfunction: Query.add_annotation\nfunction: Query.annotation_select\nfunction: get_order_dir"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.ordered\nline: 1217\nline: 1218\nline: 1225\nline: 1227\nline: 1228\nline: 1229"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..fe4507a 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,18 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when it will actually be used.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            # Aggregation/grouping queries don't apply default ordering unless an explicit order_by() is set.\n+            and not self.query.group_by\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..831faac 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,9 +1222,13 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering applies only when it will actually result in an\n+        # ORDER BY clause. For queries that introduce GROUP BY, default\n+        # ordering is not added and the final SQL won't be ordered.\n+        elif self.query.default_ordering and self.query.get_meta().ordering and not self.query.group_by:\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..9a0e2a1 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: For queries that introduce a GROUP BY (e.g. via annotate()),\n+        the model's default ordering is not automatically applied unless an\n+        explicit order_by() is present. In such cases, ordered returns False.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always wins.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n+        # If the query groups results, default ordering won't be added.\n+        if getattr(self.query, \"group_by\", None):\n             return False\n+        # Otherwise, default model ordering applies.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..0869a03 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,24 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: For queries that introduce GROUP BY (e.g., via annotate()),\n+        Django won't apply the model's default ordering unless an explicit\n+        order_by() is specified. Reflect that here.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means the queryset is ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering applies only when the query doesn't introduce\n+        # GROUP BY. If GROUP BY is present, default ordering is not added to SQL.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not self.query.group_by\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..3bc4bef 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,23 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when the query won't suppress it.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            # Queries with GROUP BY (often created via annotations) suppress\n+            # default model ordering unless an explicit order_by() is present.\n+            # In those cases, the final SQL won't include an ORDER BY clause.\n+            has_grouping = bool(getattr(self.query, \"group_by\", None))\n+            has_annotations = bool(\n+                getattr(self.query, \"annotation_select\", None)\n+                or getattr(self.query, \"annotations\", None)\n+            )\n+            if (has_grouping or has_annotations) and not (self.query.extra_order_by or self.query.order_by):\n+                return False\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..f448c53 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        For queries that introduce a GROUP BY (e.g. via annotate()), the\n+        default model ordering is not applied unless an explicit order_by()\n+        is present, so such querysets are considered unordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering applies only when not grouped.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..8603b0d 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,9 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n-        if self.query.extra_order_by or self.query.order_by:\n-            return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        # Use the query's resolved ordering, as default ordering may be\n+        # suppressed in certain cases (e.g. GROUP BY, aggregation).\n+        return bool(self.query.get_ordering())\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..e560f01 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,10 +1224,16 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Only consider default ordering if the query will actually apply it.\n+        # Queries that introduce grouping (e.g., via annotate()/values())\n+        # suppress the default ordering, so they should be reported as unordered.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and getattr(self.query, \"group_by\", None) is None\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..240acdc 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1218,13 +1218,20 @@ class QuerySet:\n     def ordered(self):\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n-        clause or a default ordering on the model (or is empty).\n+        clause or a default ordering on the model (or is empty). Default\n+        model ordering doesn't apply when the query has a GROUP BY clause\n+        unless an explicit order_by() is provided.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when the query isn't grouped.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..8c24463 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,6 +1222,11 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # If the query introduces a GROUP BY without an explicit order_by(),\n+        # the default model ordering is typically dropped by the compiler to\n+        # avoid invalid SQL. Reflect that here.\n+        if self.query.group_by and not (self.query.extra_order_by or self.query.order_by):\n+            return False\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n         elif self.query.default_ordering and self.query.get_meta().ordering:\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.ordered"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..28d8693 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,20 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        For queries that introduce GROUP BY (e.g., via annotate()), default\n+        model ordering won't result in an ORDER BY clause unless explicitly\n+        specified via order_by(), so treat those as unordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering applies only when the query doesn't introduce GROUP BY.\n+        group_by = getattr(self.query, \"group_by\", None)\n+        if self.query.default_ordering and self.query.get_meta().ordering and not group_by:\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..3c63271 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,20 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: Default model ordering doesn't apply when the query introduces\n+        a GROUP BY (e.g., via annotate()) unless an explicit order_by() is set.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies if the query isn't grouped.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", False)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..6c1e1a7 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,19 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the QuerySet ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n+        # If the query has a GROUP BY (e.g. due to annotations), the model's\n+        # default ordering won't result in an ORDER BY clause unless an\n+        # explicit order_by() is provided.\n+        group_by = getattr(self.query, \"group_by\", None)\n+        if group_by:\n             return False\n+        # Otherwise, fall back to the model's default ordering.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..8aadcf8 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,7 +1224,13 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies if it will actually be used.\n+        # Certain query shapes (e.g. GROUP BY/annotate) suppress default ordering.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..0dc0ce1 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        For queries that result in a GROUP BY (e.g. due to annotate()),\n+        Django doesn't apply the model's default ordering unless an explicit\n+        order_by() was added. Reflect that here by treating grouped queries\n+        without an explicit ORDER BY as unordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when the query isn't grouped.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not self.query.group_by\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..277fdf2 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,22 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: Default model ordering does not apply to queries that perform\n+        GROUP BY/aggregation, since those typically don't include an ORDER BY\n+        clause unless one is explicitly specified.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        # Default ordering only applies when it would result in an ORDER BY.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            group_by = getattr(self.query, \"group_by\", None)\n+            if not group_by:\n+                return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..df39b04 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,7 +1224,14 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Only consider default model ordering when it will actually be applied.\n+        # Queries that perform aggregation (i.e., have GROUP BY) won't include\n+        # the model's default ordering unless an explicit order_by() is set.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and (getattr(self.query, \"group_by\", None) is None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..624699e 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,17 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        # Default ordering applies only if it can be realized in SQL.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            # Aggregations/annotations often introduce GROUP BY and drop default ordering.\n+            has_group_by = bool(getattr(self.query, \"group_by\", None))\n+            has_annotations = bool(getattr(self.query, \"annotation_select\", None))\n+            if not (has_group_by or has_annotations):\n+                return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..eb00946 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,7 +1224,12 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering does not apply when the query has a GROUP BY.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..9f8bfc9 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,6 +1224,12 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n+        # If the query performs grouping/aggregation, default model ordering\n+        # may be suppressed to avoid invalid ORDER BY clauses. In that case,\n+        # consider the queryset unordered unless an explicit order_by() exists.\n+        group_by = getattr(self.query, 'group_by', None)\n+        if group_by is True or (isinstance(group_by, (list, tuple)) and group_by):\n+            return False\n         elif self.query.default_ordering and self.query.get_meta().ordering:\n             return True\n         else:\n"
      ]
    },
    {
      "sample_index": 2,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.ordered\nline: 1217\nline: 1218\nline: 1219\nline: 1225\nline: 1226\nline: 1227\nline: 1228\nline: 1229\nline: 1230\nline: 1231"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..43b71bf 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,20 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Default model ordering is ignored for queries that perform GROUP BY,\n+        since the SQL compiler will drop incompatible ordering in such cases.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always counts.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when the query doesn't group results.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..e4e0eb1 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,24 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: For GROUP BY queries (e.g., those produced by annotate()),\n+        Django does not apply a model's default ordering unless an explicit\n+        order_by() is specified. Reflect that here.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n+        # GROUP BY queries drop default ordering unless explicit order_by()\n+        group_by = getattr(self.query, \"group_by\", None)\n+        if group_by:\n             return False\n+        # Default model ordering applies only when not grouped.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..a0635a7 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,21 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit order_by() or extra order_by implies ordering.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when it can be honored.\n+        # Aggregated/grouped queries (e.g., annotate()/GROUP BY) skip default ordering.\n+        has_grouping = bool(getattr(self.query, 'group_by', False))\n+        has_annotations = bool(getattr(self.query, 'annotation_select', False))\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not has_grouping\n+            and not has_annotations\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..8d2451c 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,16 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering means the queryset is ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering applies unless the query uses GROUP BY,\n+        # in which case Django's SQL compiler won't include ORDER BY.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            if getattr(self.query, \"group_by\", None):\n+                return False\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..323688c 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,17 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering applies only when there's no GROUP BY.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..a966b68 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,14 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        # Default ordering only counts if it will actually produce an ORDER BY\n+        # in the final SQL (e.g., it may be suppressed for GROUP BY queries).\n+        if self.query.default_ordering:\n+            return bool(self.query.get_ordering())\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..646d089 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: Default model ordering is not applied to grouped/annotated\n+        queries where an ORDER BY would be dropped.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering applies only if the SQL compiler will keep it.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            # On GROUP BY queries (e.g., produced by annotate()), Django drops\n+            # default ordering unless an explicit order_by() is provided.\n+            group_by = getattr(self.query, \"group_by\", None)\n+            if group_by:\n+                return False\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..6d5b3a7 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,20 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: Default ordering is not applied when the query has a GROUP BY\n+        clause generated by annotations or explicit grouping.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when there is no GROUP BY.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..743bf84 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,25 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: Default ordering is not applied to queries that perform\n+        GROUP BY (e.g., via annotate()), so those are not considered\n+        ordered unless an explicit order_by() is present.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always wins.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering applies only when it will actually be used.\n+        # Queries that group results (e.g., due to annotations) do not\n+        # carry default ordering unless explicitly specified.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..cedff10 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,22 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: Default model ordering doesn't apply to queries that introduce\n+        grouping (e.g., annotate(), values() with aggregation) unless an\n+        explicit order_by() is provided. In such cases, consider the queryset\n+        unordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            # If the query groups results, default ordering won't be applied.\n+            group_by = getattr(self.query, \"group_by\", None)\n+            if group_by is None:\n+                return True\n+        return False\n \n     @property\n     def db(self):\n"
      ]
    },
    {
      "sample_index": 3,
      "edit_locs": {
        "django/db/models/query.py": [
          "\nfunction: QuerySet.ordered"
        ]
      },
      "patches": [
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..95593a5 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,19 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        For queries that introduce GROUP BY (e.g. via annotate), the default\n+        model ordering is not applied unless an explicit order_by() is set.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when it won't be suppressed by GROUP BY.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..d6e49c0 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: Default model ordering does not apply to grouped queries. If the\n+        query has a GROUP BY, only an explicit order_by() will make it ordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when the query isn't grouped.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not self.query.group_by\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..8131ca1 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1224,10 +1224,14 @@ class QuerySet:\n             return True\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering applies only if the query can actually include\n+        # an ORDER BY clause. For queries that introduce a GROUP BY (e.g.,\n+        # via annotations), Django doesn't apply the model's default ordering\n+        # unless order_by() was specified explicitly.\n+        has_group_by = bool(getattr(self.query, \"group_by\", None))\n+        if self.query.default_ordering and self.query.get_meta().ordering and not has_group_by:\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..c618f63 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        For queries that introduce GROUP BY (e.g. via annotate()), the\n+        default ordering is not applied unless an explicit order_by() is set.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ORDER BY always means the queryset is ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n+        # If the query groups results, default ordering won't be applied,\n+        # so the queryset shouldn't be considered ordered.\n+        group_by = getattr(self.query, \"group_by\", None)\n+        if group_by:\n             return False\n+        # Otherwise, rely on the model's default ordering.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            return True\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..afc0b85 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,22 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Default ordering is suppressed when the query introduces GROUP BY\n+        without an explicit order_by().\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means the queryset is ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering applies only if it's enabled and not suppressed by grouping.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            # If the query has a GROUP BY, default ordering does not apply unless\n+            # an explicit order_by is present (handled above).\n+            if getattr(self.query, \"group_by\", None):\n+                return False\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..e9ab5f9 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,24 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: Default model ordering is not applied to queries that perform\n+        grouping/aggregation unless an explicit order_by() is provided. In\n+        such cases, consider the queryset unordered.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when the query isn't grouped.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not self.query.group_by\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..aab8ea2 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1217,17 +1217,16 @@ class QuerySet:\n     @property\n     def ordered(self):\n         \"\"\"\n-        Return True if the QuerySet is ordered -- i.e. has an order_by()\n-        clause or a default ordering on the model (or is empty).\n+        Return True if the QuerySet is ordered -- i.e. if the SQL generated\n+        will include an ORDER BY clause, or the queryset is empty.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n-        if self.query.extra_order_by or self.query.order_by:\n-            return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n-            return True\n-        else:\n-            return False\n+        # Use the SQL compiler to determine the actual ORDER BY that will be\n+        # applied. This accounts for cases where default ordering is ignored,\n+        # e.g., due to GROUP BY, DISTINCT, or annotations.\n+        compiler = self.query.get_compiler(using=self.db)\n+        return bool(compiler.get_order_by())\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..76104ae 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,12 +1219,22 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+        Note: Default model ordering is not applied for queries that introduce\n+        a GROUP BY (e.g., via annotate()/values()), unless an explicit\n+        order_by() is present.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always counts.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when it won't be suppressed\n+        # by query operations such as GROUP BY.\n+        elif (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not self.query.group_by\n+        ):\n             return True\n         else:\n             return False\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..56df21f 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,20 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means the queryset is ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when it will actually be used.\n+        # Queries that introduce GROUP BY (e.g., via annotate()) can\n+        # suppress the default ordering. In those cases, consider the\n+        # queryset unordered unless explicit ordering was provided.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            and not getattr(self.query, \"group_by\", None)\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
        "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..e41db1c 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1219,15 +1219,23 @@ class QuerySet:\n         \"\"\"\n         Return True if the QuerySet is ordered -- i.e. has an order_by()\n         clause or a default ordering on the model (or is empty).\n+\n+        Note: Default ordering is not applied for queries that perform\n+        aggregation/grouping (e.g., annotate()), since such queries may\n+        drop ORDER BY clauses unless explicitly specified.\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always makes the queryset ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default ordering only applies when it will actually be used.\n+        if self.query.default_ordering and self.query.get_meta().ordering:\n+            group_by = getattr(self.query, 'group_by', None)\n+            if group_by:\n+                return False\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 5049ae4..fe4507a 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1222,12 +1222,18 @@ class QuerySet:\n         \"\"\"\n         if isinstance(self, EmptyQuerySet):\n             return True\n+        # Explicit ordering always means ordered.\n         if self.query.extra_order_by or self.query.order_by:\n             return True\n-        elif self.query.default_ordering and self.query.get_meta().ordering:\n+        # Default model ordering only applies when it will actually be used.\n+        if (\n+            self.query.default_ordering\n+            and self.query.get_meta().ordering\n+            # Aggregation/grouping queries don't apply default ordering unless an explicit order_by() is set.\n+            and not self.query.group_by\n+        ):\n             return True\n-        else:\n-            return False\n+        return False\n \n     @property\n     def db(self):\n",
  "7_resolved": true
}