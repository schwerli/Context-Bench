{
    "instance_id": "SWE-PolyBench__python__maintenance__bugfix__b110ef6c",
    "original_id": "keras-team__keras-19924",
    "1_model_selected_files": [
        "keras/src/saving/saving_lib.py",
        "keras/src/saving/serialization_lib.py",
        "keras/src/models/model.py",
        "keras/src/saving/saving_api.py",
        "keras/src/utils/file_utils.py"
    ],
    "2_embedding_selected_files": [
        "keras/src/saving/saving_lib.py",
        "keras/src/legacy/saving/legacy_h5_format.py",
        "keras/src/saving/saving_api.py",
        "keras/src/saving/saving_lib_test.py",
        "keras/src/legacy/saving/legacy_h5_format_test.py",
        "keras/src/models/model.py",
        "keras/src/callbacks/model_checkpoint_test.py",
        "keras/src/saving/saving_api_test.py",
        "keras/src/utils/torch_utils_test.py",
        "keras/api/_tf_keras/keras/models/__init__.py",
        "keras/src/backend/tensorflow/saved_model_test.py",
        "keras/src/export/export_lib.py",
        "keras/src/export/export_lib_test.py",
        "integration_tests/tf_distribute_training_test.py",
        "keras/src/trainers/trainer_test.py",
        "keras/src/legacy/saving/saving_utils.py",
        "keras/src/callbacks/tensorboard_test.py",
        "keras/api/_tf_keras/keras/saving/__init__.py",
        "keras/api/models/__init__.py",
        "keras/src/models/model_test.py",
        "keras/src/saving/serialization_lib.py",
        "keras/src/utils/torch_utils.py",
        "keras/api/_tf_keras/keras/utils/__init__.py",
        "keras/api/_tf_keras/keras/legacy/__init__.py",
        "keras/src/callbacks/swap_ema_weights_test.py",
        "keras/src/models/cloning_test.py",
        "keras/api/_tf_keras/keras/__init__.py",
        "keras/src/optimizers/optimizer_test.py",
        "keras/src/legacy/saving/__init__.py",
        "keras/src/layers/convolutional/conv_test.py",
        "guides/custom_train_step_in_tensorflow.py",
        "keras/pip_build.py",
        "benchmarks/model_benchmark/bert_benchmark.py",
        "keras/src/layers/core/dense_test.py",
        "keras/src/callbacks/backup_and_restore_test.py",
        "keras/src/models/cloning.py",
        "keras/src/callbacks/csv_logger_test.py",
        "keras/src/applications/resnet.py",
        "examples/demo_custom_tf_workflow.py",
        "keras/src/callbacks/early_stopping_test.py",
        "keras/src/layers/core/embedding_test.py"
    ],
    "3_final_combined_files": [
        "keras/src/saving/saving_lib.py",
        "keras/src/saving/serialization_lib.py",
        "keras/src/models/model.py",
        "keras/src/legacy/saving/legacy_h5_format.py",
        "keras/src/saving/saving_api.py"
    ],
    "4_related_elements": {
        "keras/src/saving/saving_lib.py": [
            "variable: _VARS_FNAME\nvariable: _VARS_FNAME_H5\nvariable: _VARS_FNAME_NPZ\nfunction: save_model\nfunction: _save_model_to_dir\nfunction: _save_model_to_fileobj\nfunction: load_model\nfunction: _load_model_from_dir\nfunction: _load_model_from_fileobj\nfunction: save_weights_only\nfunction: load_weights_only\nfunction: _write_to_zip_recursively\nfunction: _save_state\nfunction: _load_state\nfunction: _save_container_state\nfunction: _load_container_state\nfunction: get_temp_dir\nclass: DiskIOStore\nclass: H5IOStore\nclass: H5Entry\nclass: NpzIOStore"
        ],
        "keras/src/models/model.py": [
            "function: Model.save\nfunction: Model.save_weights\nfunction: Model.load_weights"
        ],
        "keras/src/saving/serialization_lib.py": [
            ""
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "keras/src/saving/saving_lib.py": [
                    "function: _save_model_to_fileobj\nline: 165\nline: 168\nline: 169\nline: 170\nline: 171\nline: 175\nline: 176\nline: 202\nline: 205\nline: 206\nfunction: _load_model_from_fileobj\nline: 315\nline: 318\nline: 319\nline: 320\nline: 321\nline: 353"
                ],
                "keras/src/saving/serialization_lib.py": [
                    ""
                ],
                "keras/src/models/model.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/saving/saving_lib.py b/keras/src/saving/saving_lib.py\nindex 16e8d08..26a84fc 100644\n--- a/keras/src/saving/saving_lib.py\n+++ b/keras/src/saving/saving_lib.py\n@@ -160,13 +160,15 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             f.write(config_json.encode())\n \n         weights_file_path = None\n+        created_temp_dir = False\n         try:\n             if weights_format == \"h5\":\n                 if isinstance(fileobj, io.BufferedWriter):\n-                    # First, open the .h5 file, then write it to `zf` at the end\n-                    # of the function call.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Write weights to a temporary .h5 file, then add it to the zip.\n+                    import tempfile\n+                    temp_dir_path = tempfile.mkdtemp()\n+                    weights_file_path = pathlib.Path(temp_dir_path) / _VARS_FNAME_H5\n+                    created_temp_dir = True\n                     weights_store = H5IOStore(weights_file_path, mode=\"w\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -203,6 +205,12 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             asset_store.close()\n             if weights_file_path:\n                 zf.write(weights_file_path, weights_file_path.name)\n+                if created_temp_dir:\n+                    try:\n+                        import shutil\n+                        shutil.rmtree(weights_file_path.parent, ignore_errors=True)\n+                    except Exception:\n+                        pass\n \n \n def load_model(filepath, custom_objects=None, compile=True, safe_mode=True):\n@@ -309,14 +317,16 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n \n         all_filenames = zf.namelist()\n         weights_file_path = None\n+        created_temp_dir = False\n+        temp_dir_path = None\n         try:\n             if _VARS_FNAME_H5 in all_filenames:\n                 if isinstance(fileobj, io.BufferedReader):\n-                    # First, extract the model.weights.h5 file, then load it\n-                    # using h5py.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    zf.extract(_VARS_FNAME_H5, working_dir)\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Extract the model.weights.h5 file to a temporary directory, then load it\n+                    import tempfile\n+                    temp_dir_path = tempfile.mkdtemp()\n+                    zf.extract(_VARS_FNAME_H5, temp_dir_path)\n+                    weights_file_path = pathlib.Path(temp_dir_path) / _VARS_FNAME_H5\n                     weights_store = H5IOStore(weights_file_path, mode=\"r\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -349,8 +359,17 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n             weights_store.close()\n             if asset_store:\n                 asset_store.close()\n-            if weights_file_path:\n-                weights_file_path.unlink()\n+            if temp_dir_path:\n+                try:\n+                    import shutil\n+                    shutil.rmtree(temp_dir_path, ignore_errors=True)\n+                except Exception:\n+                    pass\n+            elif weights_file_path:\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n \n         if failed_saveables:\n             _raise_loading_failure(error_msgs)\n",
                "diff --git a/keras/src/saving/saving_lib.py b/keras/src/saving/saving_lib.py\nindex 16e8d08..8d6725e 100644\n--- a/keras/src/saving/saving_lib.py\n+++ b/keras/src/saving/saving_lib.py\n@@ -163,10 +163,14 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n         try:\n             if weights_format == \"h5\":\n                 if isinstance(fileobj, io.BufferedWriter):\n-                    # First, open the .h5 file, then write it to `zf` at the end\n-                    # of the function call.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Write weights to a temporary file, then add to `zf` at the end.\n+                    import tempfile\n+                    tmp = tempfile.NamedTemporaryFile(suffix=\".h5\", delete=False)\n+                    try:\n+                        weights_file_path = pathlib.Path(tmp.name)\n+                    finally:\n+                        # Close the temporary file so H5IOStore can write to it.\n+                        tmp.close()\n                     weights_store = H5IOStore(weights_file_path, mode=\"w\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -202,7 +206,13 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             weights_store.close()\n             asset_store.close()\n             if weights_file_path:\n-                zf.write(weights_file_path, weights_file_path.name)\n+                # Add the weights file to the archive with a stable name.\n+                zf.write(str(weights_file_path), _VARS_FNAME_H5)\n+                # Clean up the temporary file.\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n \n \n def load_model(filepath, custom_objects=None, compile=True, safe_mode=True):\n@@ -309,14 +319,17 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n \n         all_filenames = zf.namelist()\n         weights_file_path = None\n+        temp_dir = None\n         try:\n             if _VARS_FNAME_H5 in all_filenames:\n                 if isinstance(fileobj, io.BufferedReader):\n-                    # First, extract the model.weights.h5 file, then load it\n-                    # using h5py.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    zf.extract(_VARS_FNAME_H5, working_dir)\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Extract the weights file to a unique temporary directory, then load it.\n+                    import tempfile\n+                    temp_dir = tempfile.TemporaryDirectory()\n+                    extracted_path = pathlib.Path(\n+                        zf.extract(_VARS_FNAME_H5, temp_dir.name)\n+                    )\n+                    weights_file_path = extracted_path\n                     weights_store = H5IOStore(weights_file_path, mode=\"r\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -350,7 +363,15 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n             if asset_store:\n                 asset_store.close()\n             if weights_file_path:\n-                weights_file_path.unlink()\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n+            if temp_dir:\n+                try:\n+                    temp_dir.cleanup()\n+                except Exception:\n+                    pass\n \n         if failed_saveables:\n             _raise_loading_failure(error_msgs)\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "keras/src/saving/saving_lib.py": [
                    "function: _save_model_to_fileobj\nline: 169\nline: 205\nfunction: _load_model_from_fileobj\nline: 318\nline: 353"
                ],
                "keras/src/saving/serialization_lib.py": [
                    ""
                ],
                "keras/src/models/model.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/saving/saving_lib.py b/keras/src/saving/saving_lib.py\nindex 16e8d08..5ce0605 100644\n--- a/keras/src/saving/saving_lib.py\n+++ b/keras/src/saving/saving_lib.py\n@@ -160,13 +160,17 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             f.write(config_json.encode())\n \n         weights_file_path = None\n+        tmpdir_obj = None\n         try:\n             if weights_format == \"h5\":\n                 if isinstance(fileobj, io.BufferedWriter):\n-                    # First, open the .h5 file, then write it to `zf` at the end\n-                    # of the function call.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Create a unique temporary directory to avoid leaving artifacts\n+                    # on disk and to prevent cross-process collisions.\n+                    import tempfile\n+\n+                    tmpdir_obj = tempfile.TemporaryDirectory()\n+                    tmpdir = pathlib.Path(tmpdir_obj.name)\n+                    weights_file_path = tmpdir / _VARS_FNAME_H5\n                     weights_store = H5IOStore(weights_file_path, mode=\"w\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -199,10 +203,25 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             weights_file_path = None\n             raise\n         finally:\n-            weights_store.close()\n-            asset_store.close()\n+            # Ensure stores are closed before any cleanup\n+            try:\n+                weights_store.close()\n+            except Exception:\n+                pass\n+            try:\n+                asset_store.close()\n+            except Exception:\n+                pass\n             if weights_file_path:\n+                # Write the temporary weights file into the archive, then clean it up\n                 zf.write(weights_file_path, weights_file_path.name)\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n+            if tmpdir_obj is not None:\n+                # Remove the temporary directory used for the weights file\n+                tmpdir_obj.cleanup()\n \n \n def load_model(filepath, custom_objects=None, compile=True, safe_mode=True):\n@@ -309,14 +328,19 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n \n         all_filenames = zf.namelist()\n         weights_file_path = None\n+        tmpdir_obj = None\n         try:\n             if _VARS_FNAME_H5 in all_filenames:\n                 if isinstance(fileobj, io.BufferedReader):\n-                    # First, extract the model.weights.h5 file, then load it\n-                    # using h5py.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    zf.extract(_VARS_FNAME_H5, working_dir)\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # First, extract the model.weights.h5 file to a unique temporary\n+                    # directory, then load it using h5py. This avoids race conditions\n+                    # and cleanup issues when multiple processes load the same file.\n+                    import tempfile\n+\n+                    tmpdir_obj = tempfile.TemporaryDirectory()\n+                    tmpdir = pathlib.Path(tmpdir_obj.name)\n+                    zf.extract(_VARS_FNAME_H5, tmpdir)\n+                    weights_file_path = tmpdir / _VARS_FNAME_H5\n                     weights_store = H5IOStore(weights_file_path, mode=\"r\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -346,11 +370,22 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n                 error_msgs=error_msgs,\n             )\n         finally:\n-            weights_store.close()\n+            try:\n+                weights_store.close()\n+            except Exception:\n+                pass\n             if asset_store:\n-                asset_store.close()\n+                try:\n+                    asset_store.close()\n+                except Exception:\n+                    pass\n             if weights_file_path:\n-                weights_file_path.unlink()\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n+            if tmpdir_obj is not None:\n+                tmpdir_obj.cleanup()\n \n         if failed_saveables:\n             _raise_loading_failure(error_msgs)\n",
                "diff --git a/keras/src/saving/saving_lib.py b/keras/src/saving/saving_lib.py\nindex 16e8d08..87f30ad 100644\n--- a/keras/src/saving/saving_lib.py\n+++ b/keras/src/saving/saving_lib.py\n@@ -165,8 +165,14 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n                 if isinstance(fileobj, io.BufferedWriter):\n                     # First, open the .h5 file, then write it to `zf` at the end\n                     # of the function call.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Create a temporary .h5 file and write it to `zf` at the end\n+                    # of the function call, avoiding leaving artifacts in the\n+                    # working directory.\n+                    import tempfile\n+                    tmp = tempfile.NamedTemporaryFile(suffix=\".h5\", delete=False)\n+                    tmp_path = pathlib.Path(tmp.name)\n+                    tmp.close()\n+                    weights_file_path = tmp_path\n                     weights_store = H5IOStore(weights_file_path, mode=\"w\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -202,7 +208,13 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             weights_store.close()\n             asset_store.close()\n             if weights_file_path:\n-                zf.write(weights_file_path, weights_file_path.name)\n+                # Ensure the weights are stored under the expected name inside the archive.\n+                zf.write(weights_file_path, _VARS_FNAME_H5)\n+                # Clean up the temporary weights file.\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n \n \n def load_model(filepath, custom_objects=None, compile=True, safe_mode=True):\n@@ -309,14 +321,17 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n \n         all_filenames = zf.namelist()\n         weights_file_path = None\n+        tmp_dir = None\n         try:\n             if _VARS_FNAME_H5 in all_filenames:\n                 if isinstance(fileobj, io.BufferedReader):\n-                    # First, extract the model.weights.h5 file, then load it\n-                    # using h5py.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    zf.extract(_VARS_FNAME_H5, working_dir)\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # First, extract the model.weights.h5 file to a temporary\n+                    # directory, then load it using h5py. This avoids concurrent\n+                    # processes clobbering or deleting the same file.\n+                    import tempfile\n+                    tmp_dir = tempfile.TemporaryDirectory()\n+                    zf.extract(_VARS_FNAME_H5, tmp_dir.name)\n+                    weights_file_path = pathlib.Path(tmp_dir.name) / _VARS_FNAME_H5\n                     weights_store = H5IOStore(weights_file_path, mode=\"r\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -350,7 +365,17 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n             if asset_store:\n                 asset_store.close()\n             if weights_file_path:\n-                weights_file_path.unlink()\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    # Another concurrent loader might have already removed it.\n+                    pass\n+            if tmp_dir:\n+                # Clean up the temporary directory used for extraction.\n+                try:\n+                    tmp_dir.cleanup()\n+                except Exception:\n+                    pass\n \n         if failed_saveables:\n             _raise_loading_failure(error_msgs)\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/keras/src/saving/saving_lib.py b/keras/src/saving/saving_lib.py\nindex 16e8d08..26a84fc 100644\n--- a/keras/src/saving/saving_lib.py\n+++ b/keras/src/saving/saving_lib.py\n@@ -160,13 +160,15 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             f.write(config_json.encode())\n \n         weights_file_path = None\n+        created_temp_dir = False\n         try:\n             if weights_format == \"h5\":\n                 if isinstance(fileobj, io.BufferedWriter):\n-                    # First, open the .h5 file, then write it to `zf` at the end\n-                    # of the function call.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Write weights to a temporary .h5 file, then add it to the zip.\n+                    import tempfile\n+                    temp_dir_path = tempfile.mkdtemp()\n+                    weights_file_path = pathlib.Path(temp_dir_path) / _VARS_FNAME_H5\n+                    created_temp_dir = True\n                     weights_store = H5IOStore(weights_file_path, mode=\"w\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -203,6 +205,12 @@ def _save_model_to_fileobj(model, fileobj, weights_format):\n             asset_store.close()\n             if weights_file_path:\n                 zf.write(weights_file_path, weights_file_path.name)\n+                if created_temp_dir:\n+                    try:\n+                        import shutil\n+                        shutil.rmtree(weights_file_path.parent, ignore_errors=True)\n+                    except Exception:\n+                        pass\n \n \n def load_model(filepath, custom_objects=None, compile=True, safe_mode=True):\n@@ -309,14 +317,16 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n \n         all_filenames = zf.namelist()\n         weights_file_path = None\n+        created_temp_dir = False\n+        temp_dir_path = None\n         try:\n             if _VARS_FNAME_H5 in all_filenames:\n                 if isinstance(fileobj, io.BufferedReader):\n-                    # First, extract the model.weights.h5 file, then load it\n-                    # using h5py.\n-                    working_dir = pathlib.Path(fileobj.name).parent\n-                    zf.extract(_VARS_FNAME_H5, working_dir)\n-                    weights_file_path = working_dir / _VARS_FNAME_H5\n+                    # Extract the model.weights.h5 file to a temporary directory, then load it\n+                    import tempfile\n+                    temp_dir_path = tempfile.mkdtemp()\n+                    zf.extract(_VARS_FNAME_H5, temp_dir_path)\n+                    weights_file_path = pathlib.Path(temp_dir_path) / _VARS_FNAME_H5\n                     weights_store = H5IOStore(weights_file_path, mode=\"r\")\n                 else:\n                     # Fall back when `fileobj` is an `io.BytesIO`. Typically,\n@@ -349,8 +359,17 @@ def _load_model_from_fileobj(fileobj, custom_objects, compile, safe_mode):\n             weights_store.close()\n             if asset_store:\n                 asset_store.close()\n-            if weights_file_path:\n-                weights_file_path.unlink()\n+            if temp_dir_path:\n+                try:\n+                    import shutil\n+                    shutil.rmtree(temp_dir_path, ignore_errors=True)\n+                except Exception:\n+                    pass\n+            elif weights_file_path:\n+                try:\n+                    weights_file_path.unlink()\n+                except FileNotFoundError:\n+                    pass\n \n         if failed_saveables:\n             _raise_loading_failure(error_msgs)\n"
}