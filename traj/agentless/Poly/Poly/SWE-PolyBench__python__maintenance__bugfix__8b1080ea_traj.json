{
    "instance_id": "SWE-PolyBench__python__maintenance__bugfix__8b1080ea",
    "original_id": "keras-team__keras-19863",
    "1_model_selected_files": [
        "keras/src/models/model.py",
        "keras/src/layers/layer.py",
        "keras/src/utils/summary_utils.py"
    ],
    "2_embedding_selected_files": [
        "keras/src/saving/saving_lib_test.py",
        "guides/sequential_model.py",
        "keras/src/models/sequential_test.py",
        "keras/src/trainers/trainer_test.py",
        "keras/src/models/model_test.py",
        "keras/src/utils/summary_utils.py",
        "keras/src/layers/layer_test.py",
        "keras/src/layers/core/dense_test.py",
        "keras/src/backend/tensorflow/saved_model_test.py",
        "keras/src/legacy/saving/legacy_h5_format_test.py",
        "keras/src/callbacks/tensorboard_test.py",
        "keras/src/export/export_lib_test.py",
        "guides/making_new_layers_and_models_via_subclassing.py",
        "keras/src/layers/core/embedding.py",
        "keras/src/utils/summary_utils_test.py",
        "integration_tests/model_visualization_test.py",
        "keras/src/layers/convolutional/base_conv.py",
        "guides/functional_api.py",
        "keras/src/models/model.py",
        "examples/demo_custom_layer_backend_agnostic.py",
        "keras/src/callbacks/model_checkpoint_test.py",
        "keras/src/layers/layer.py",
        "keras/src/models/cloning.py",
        "keras/src/utils/torch_utils_test.py",
        "keras/src/legacy/saving/legacy_h5_format.py",
        "guides/training_with_built_in_methods.py",
        "keras/src/models/sequential.py",
        "guides/custom_train_step_in_torch.py",
        "benchmarks/torch_ctl_benchmark/dense_model_benchmark.py",
        "guides/transfer_learning.py",
        "guides/custom_train_step_in_tensorflow.py",
        "keras/src/saving/saving_api_test.py",
        "keras/src/saving/serialization_lib_test.py",
        "examples/demo_subclass.py",
        "keras/src/layers/core/einsum_dense_test.py",
        "keras/src/models/functional_test.py"
    ],
    "3_final_combined_files": [
        "keras/src/models/model.py",
        "keras/src/layers/layer.py",
        "keras/src/utils/summary_utils.py",
        "keras/src/saving/saving_lib_test.py",
        "guides/sequential_model.py",
        "keras/src/models/sequential_test.py"
    ],
    "4_related_elements": {
        "keras/src/models/model.py": [
            "class: Model"
        ],
        "keras/src/layers/layer.py": [
            "function: Layer.build\nfunction: Layer._build_by_run_for_single_pos_arg\nfunction: Layer._build_by_run_for_kwargs\nfunction: Layer._maybe_build\nfunction: Layer.__call__\nfunction: Layer.compute_output_spec\nfunction: Layer.compute_output_shape\nfunction: might_have_unbuilt_state"
        ],
        "keras/src/utils/summary_utils.py": [
            "function: print_summary\nfunction: format_layer_shape"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "keras/src/models/model.py": [
                    "function: Model.build"
                ],
                "keras/src/layers/layer.py": [
                    ""
                ],
                "keras/src/utils/summary_utils.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/layers/layer.py b/keras/src/layers/layer.py\nindex c34c31e..ee9545d 100644\n--- a/keras/src/layers/layer.py\n+++ b/keras/src/layers/layer.py\n@@ -1319,7 +1319,11 @@ class Layer(BackendLayer, Operation, KerasSaveable):\n             lambda s: backend.KerasTensor(s), input_shape\n         )\n         try:\n-            backend.compute_output_spec(self.call, input_tensors)\n+            # Directly call `self.call` with KerasTensors to trigger variable\n+            # creation/build in sublayers. Using `compute_output_spec` may only\n+            # infer shapes without creating variables, which leads to unbuilt\n+            # sublayers and broken `model.summary()`.\n+            self.call(input_tensors)\n             return True\n         except:\n             return False\n@@ -1334,7 +1338,11 @@ class Layer(BackendLayer, Operation, KerasSaveable):\n                 for k, shape in shapes_dict.items()\n             }\n             try:\n-                backend.compute_output_spec(self.call, **input_tensors)\n+                # Directly call `self.call` with KerasTensors to trigger variable\n+                # creation/build in sublayers. Using `compute_output_spec` may only\n+                # infer shapes without creating variables, which leads to unbuilt\n+                # sublayers and broken `model.summary()`.\n+                self.call(**input_tensors)\n                 return True\n             except:\n                 return False\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "keras/src/models/model.py": [
                    "function: Model.build"
                ],
                "keras/src/layers/layer.py": [
                    "function: Layer._build_by_run_for_single_pos_arg\nfunction: Layer._build_by_run_for_kwargs"
                ],
                "keras/src/utils/summary_utils.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/layers/layer.py b/keras/src/layers/layer.py\nindex c34c31e..a3eda3f 100644\n--- a/keras/src/layers/layer.py\n+++ b/keras/src/layers/layer.py\n@@ -1311,7 +1311,18 @@ class Layer(BackendLayer, Operation, KerasSaveable):\n                     \"children layers).\\n\"\n                     f\"Exception encountered: ''{e}''\"\n                 )\n-        self.build(first_shape)\n+        # Try to build by tracing a run of `call()` with a KerasTensor input.\n+        built_by_run = False\n+        try:\n+            built_by_run = self._build_by_run_for_single_pos_arg(first_shape)\n+        except Exception:\n+            built_by_run = False\n+        if built_by_run:\n+            # Mark the layer/model as built since sublayers were built via the run.\n+            self.built = True\n+        else:\n+            # Fallback to user-implemented build (if any); otherwise base build will warn.\n+            self.build(first_shape)\n \n     def _build_by_run_for_single_pos_arg(self, input_shape):\n         # Case: all inputs are in the first arg (possibly nested).\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/keras/src/layers/layer.py b/keras/src/layers/layer.py\nindex c34c31e..ee9545d 100644\n--- a/keras/src/layers/layer.py\n+++ b/keras/src/layers/layer.py\n@@ -1319,7 +1319,11 @@ class Layer(BackendLayer, Operation, KerasSaveable):\n             lambda s: backend.KerasTensor(s), input_shape\n         )\n         try:\n-            backend.compute_output_spec(self.call, input_tensors)\n+            # Directly call `self.call` with KerasTensors to trigger variable\n+            # creation/build in sublayers. Using `compute_output_spec` may only\n+            # infer shapes without creating variables, which leads to unbuilt\n+            # sublayers and broken `model.summary()`.\n+            self.call(input_tensors)\n             return True\n         except:\n             return False\n@@ -1334,7 +1338,11 @@ class Layer(BackendLayer, Operation, KerasSaveable):\n                 for k, shape in shapes_dict.items()\n             }\n             try:\n-                backend.compute_output_spec(self.call, **input_tensors)\n+                # Directly call `self.call` with KerasTensors to trigger variable\n+                # creation/build in sublayers. Using `compute_output_spec` may only\n+                # infer shapes without creating variables, which leads to unbuilt\n+                # sublayers and broken `model.summary()`.\n+                self.call(**input_tensors)\n                 return True\n             except:\n                 return False\n"
}