{
    "instance_id": "SWE-PolyBench__python__maintenance__bugfix__ea5a4764",
    "original_id": "keras-team__keras-19775",
    "1_model_selected_files": [
        "keras/src/backend/tensorflow/numpy.py"
    ],
    "2_embedding_selected_files": [
        "keras/src/backend/tensorflow/numpy.py",
        "keras/src/ops/numpy.py",
        "keras/src/ops/math_test.py",
        "keras/src/backend/torch/numpy.py",
        "keras/src/ops/core_test.py",
        "keras/src/ops/numpy_test.py",
        "keras/src/backend/tensorflow/math.py",
        "keras/api/_tf_keras/keras/ops/numpy/__init__.py",
        "keras/src/backend/tensorflow/linalg.py",
        "keras/api/_tf_keras/keras/ops/__init__.py",
        "keras/src/ops/linalg_test.py",
        "keras/src/backend/tensorflow/nn.py",
        "keras/src/callbacks/terminate_on_nan_test.py",
        "keras/src/backend/tensorflow/core.py",
        "keras/src/ops/nn_test.py",
        "keras/src/ops/__init__.py",
        "keras/src/utils/numerical_utils_test.py",
        "keras/src/backend/tensorflow/optimizer_distribute_test.py"
    ],
    "3_final_combined_files": [
        "keras/src/backend/tensorflow/numpy.py",
        "keras/src/ops/numpy.py",
        "keras/src/ops/math_test.py"
    ],
    "4_related_elements": {
        "keras/src/backend/tensorflow/numpy.py": [
            "function: linspace\nfunction: logspace"
        ],
        "keras/src/ops/numpy.py": [
            "class: Linspace\nfunction: linspace\nclass: Logspace\nfunction: logspace"
        ],
        "keras/src/ops/math_test.py": [
            ""
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "keras/src/backend/tensorflow/numpy.py": [
                    "function: linspace\nline: 1333\nline: 1337"
                ],
                "keras/src/ops/numpy.py": [
                    ""
                ],
                "keras/src/ops/math_test.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/backend/tensorflow/numpy.py b/keras/src/backend/tensorflow/numpy.py\nindex 4c33614..022b335 100644\n--- a/keras/src/backend/tensorflow/numpy.py\n+++ b/keras/src/backend/tensorflow/numpy.py\n@@ -1321,25 +1321,37 @@ def linspace(\n         dtype = standardize_dtype(dtype)\n     start = convert_to_tensor(start, dtype=dtype)\n     stop = convert_to_tensor(stop, dtype=dtype)\n-    if num < 0:\n+\n+    # Normalize `num` to support tf.Tensor inputs\n+    num_tensor = tf.convert_to_tensor(num)\n+    # Try to obtain a Python value for control-flow when possible\n+    num_static = tf.get_static_value(num_tensor)\n+    # Integer tensor for tf.linspace\n+    num_int = tf.cast(num_tensor, tf.int32)\n+    # Floating tensor for arithmetic with start/stop dtype\n+    num_float = tf.cast(num_tensor, start.dtype)\n+\n+    if num_static is not None and int(num_static) < 0:\n         raise ValueError(\n-            f\"`num` must be a non-negative integer. Received: num={num}\"\n+            f\"`num` must be a non-negative integer. Received: num={num_static}\"\n         )\n+\n     step = tf.convert_to_tensor(np.nan)\n     if endpoint:\n-        result = tf.linspace(start, stop, num, axis=axis)\n-        if num > 1:\n-            step = (stop - start) / (num - 1)\n+        # tf.linspace expects an integer num; ensure correct dtype\n+        result = tf.linspace(start, stop, num_int, axis=axis)\n+        if num_static is not None and int(num_static) > 1:\n+            step = (stop - start) / (num_float - tf.cast(1, start.dtype))\n     else:\n         # tf.linspace doesn't support endpoint=False, so we manually handle it\n-        if num > 0:\n-            step = (stop - start) / num\n-        if num > 1:\n+        if num_static is not None and int(num_static) > 0:\n+            step = (stop - start) / num_float\n+        if num_static is not None and int(num_static) > 1:\n             new_stop = tf.cast(stop, step.dtype) - step\n             start = tf.cast(start, new_stop.dtype)\n-            result = tf.linspace(start, new_stop, num, axis=axis)\n+            result = tf.linspace(start, new_stop, num_int, axis=axis)\n         else:\n-            result = tf.linspace(start, stop, num, axis=axis)\n+            result = tf.linspace(start, stop, num_int, axis=axis)\n     if dtype is not None:\n         if \"int\" in dtype:\n             result = tf.floor(result)\n",
                "diff --git a/keras/src/backend/tensorflow/numpy.py b/keras/src/backend/tensorflow/numpy.py\nindex 4c33614..bf16c1e 100644\n--- a/keras/src/backend/tensorflow/numpy.py\n+++ b/keras/src/backend/tensorflow/numpy.py\n@@ -1321,25 +1321,59 @@ def linspace(\n         dtype = standardize_dtype(dtype)\n     start = convert_to_tensor(start, dtype=dtype)\n     stop = convert_to_tensor(stop, dtype=dtype)\n-    if num < 0:\n+\n+    # Ensure num is a Tensor with integer dtype for tf.linspace and comparisons\n+    num = convert_to_tensor(num)\n+    num = tf.cast(num, tf.int32)\n+\n+    # Try to get a static Python value for num when possible\n+    num_value = tf.get_static_value(num)\n+    if num_value is not None and num_value < 0:\n         raise ValueError(\n-            f\"`num` must be a non-negative integer. Received: num={num}\"\n+            f\"`num` must be a non-negative integer. Received: num={num_value}\"\n         )\n-    step = tf.convert_to_tensor(np.nan)\n+    elif num_value is None:\n+        tf.debugging.assert_greater_equal(num, tf.constant(0, dtype=num.dtype))\n+\n+    # Initialize step as NaN with the same dtype as start/stop\n+    step = tf.cast(tf.constant(np.nan), start.dtype)\n+\n     if endpoint:\n         result = tf.linspace(start, stop, num, axis=axis)\n-        if num > 1:\n-            step = (stop - start) / (num - 1)\n+        if num_value is not None:\n+            if num_value > 1:\n+                step = (stop - start) / tf.cast(num_value - 1, start.dtype)\n+        else:\n+            step = tf.where(\n+                tf.greater(num, 1),\n+                (stop - start) / tf.cast(num - 1, start.dtype),\n+                tf.cast(tf.constant(np.nan), start.dtype),\n+            )\n     else:\n         # tf.linspace doesn't support endpoint=False, so we manually handle it\n-        if num > 0:\n-            step = (stop - start) / num\n-        if num > 1:\n-            new_stop = tf.cast(stop, step.dtype) - step\n+        if num_value is not None:\n+            if num_value > 0:\n+                step = (stop - start) / tf.cast(num_value, start.dtype)\n+            if num_value > 1:\n+                new_stop = tf.cast(stop, step.dtype) - step\n+                start = tf.cast(start, new_stop.dtype)\n+                result = tf.linspace(start, new_stop, num, axis=axis)\n+            else:\n+                result = tf.linspace(start, stop, num, axis=axis)\n+        else:\n+            step = tf.where(\n+                tf.greater(num, 0),\n+                (stop - start) / tf.cast(num, start.dtype),\n+                tf.cast(tf.constant(np.nan), start.dtype),\n+            )\n+            new_stop = tf.where(\n+                tf.greater(num, 1),\n+                tf.cast(stop, step.dtype) - step,\n+                tf.cast(stop, step.dtype),\n+            )\n             start = tf.cast(start, new_stop.dtype)\n             result = tf.linspace(start, new_stop, num, axis=axis)\n-        else:\n-            result = tf.linspace(start, stop, num, axis=axis)\n+\n     if dtype is not None:\n         if \"int\" in dtype:\n             result = tf.floor(result)\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "keras/src/backend/tensorflow/numpy.py": [
                    "function: linspace\nline: 1332\nline: 1336"
                ],
                "keras/src/ops/numpy.py": [
                    ""
                ],
                "keras/src/ops/math_test.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/backend/tensorflow/numpy.py b/keras/src/backend/tensorflow/numpy.py\nindex 4c33614..4e63181 100644\n--- a/keras/src/backend/tensorflow/numpy.py\n+++ b/keras/src/backend/tensorflow/numpy.py\n@@ -1321,25 +1321,37 @@ def linspace(\n         dtype = standardize_dtype(dtype)\n     start = convert_to_tensor(start, dtype=dtype)\n     stop = convert_to_tensor(stop, dtype=dtype)\n-    if num < 0:\n+\n+    # Normalize num to be an integer for tf.linspace, and try to resolve to a Python int for branching.\n+    num_for_tf = num\n+    if tf.is_tensor(num_for_tf):\n+        static_num = tf.get_static_value(num_for_tf)\n+        if static_num is not None:\n+            num = int(static_num)\n+            num_for_tf = num\n+        else:\n+            if num_for_tf.dtype not in (tf.int32, tf.int64):\n+                num_for_tf = tf.cast(num_for_tf, tf.int32)\n+\n+    if not tf.is_tensor(num) and num < 0:\n         raise ValueError(\n             f\"`num` must be a non-negative integer. Received: num={num}\"\n         )\n-    step = tf.convert_to_tensor(np.nan)\n+    step = tf.convert_to_tensor(np.nan, dtype=start.dtype)\n     if endpoint:\n-        result = tf.linspace(start, stop, num, axis=axis)\n-        if num > 1:\n-            step = (stop - start) / (num - 1)\n+        result = tf.linspace(start, stop, num_for_tf, axis=axis)\n+        if not tf.is_tensor(num) and num > 1:\n+            step = (stop - start) / tf.cast(num - 1, start.dtype)\n     else:\n         # tf.linspace doesn't support endpoint=False, so we manually handle it\n-        if num > 0:\n-            step = (stop - start) / num\n-        if num > 1:\n+        if not tf.is_tensor(num) and num > 0:\n+            step = (stop - start) / tf.cast(num, start.dtype)\n+        if not tf.is_tensor(num) and num > 1:\n             new_stop = tf.cast(stop, step.dtype) - step\n             start = tf.cast(start, new_stop.dtype)\n-            result = tf.linspace(start, new_stop, num, axis=axis)\n+            result = tf.linspace(start, new_stop, num_for_tf, axis=axis)\n         else:\n-            result = tf.linspace(start, stop, num, axis=axis)\n+            result = tf.linspace(start, stop, num_for_tf, axis=axis)\n     if dtype is not None:\n         if \"int\" in dtype:\n             result = tf.floor(result)\n",
                "diff --git a/keras/src/backend/tensorflow/numpy.py b/keras/src/backend/tensorflow/numpy.py\nindex 4c33614..4fee706 100644\n--- a/keras/src/backend/tensorflow/numpy.py\n+++ b/keras/src/backend/tensorflow/numpy.py\n@@ -1325,15 +1325,17 @@ def linspace(\n         raise ValueError(\n             f\"`num` must be a non-negative integer. Received: num={num}\"\n         )\n-    step = tf.convert_to_tensor(np.nan)\n+    # Cast `num` to the same dtype as `start`/`stop` for arithmetic operations.\n+    num_f = tf.cast(tf.convert_to_tensor(num), dtype)\n+    step = tf.convert_to_tensor(np.nan, dtype=dtype)\n     if endpoint:\n         result = tf.linspace(start, stop, num, axis=axis)\n         if num > 1:\n-            step = (stop - start) / (num - 1)\n+            step = (stop - start) / (num_f - tf.convert_to_tensor(1, dtype=dtype))\n     else:\n         # tf.linspace doesn't support endpoint=False, so we manually handle it\n         if num > 0:\n-            step = (stop - start) / num\n+            step = (stop - start) / num_f\n         if num > 1:\n             new_stop = tf.cast(stop, step.dtype) - step\n             start = tf.cast(start, new_stop.dtype)\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/keras/src/backend/tensorflow/numpy.py b/keras/src/backend/tensorflow/numpy.py\nindex 4c33614..022b335 100644\n--- a/keras/src/backend/tensorflow/numpy.py\n+++ b/keras/src/backend/tensorflow/numpy.py\n@@ -1321,25 +1321,37 @@ def linspace(\n         dtype = standardize_dtype(dtype)\n     start = convert_to_tensor(start, dtype=dtype)\n     stop = convert_to_tensor(stop, dtype=dtype)\n-    if num < 0:\n+\n+    # Normalize `num` to support tf.Tensor inputs\n+    num_tensor = tf.convert_to_tensor(num)\n+    # Try to obtain a Python value for control-flow when possible\n+    num_static = tf.get_static_value(num_tensor)\n+    # Integer tensor for tf.linspace\n+    num_int = tf.cast(num_tensor, tf.int32)\n+    # Floating tensor for arithmetic with start/stop dtype\n+    num_float = tf.cast(num_tensor, start.dtype)\n+\n+    if num_static is not None and int(num_static) < 0:\n         raise ValueError(\n-            f\"`num` must be a non-negative integer. Received: num={num}\"\n+            f\"`num` must be a non-negative integer. Received: num={num_static}\"\n         )\n+\n     step = tf.convert_to_tensor(np.nan)\n     if endpoint:\n-        result = tf.linspace(start, stop, num, axis=axis)\n-        if num > 1:\n-            step = (stop - start) / (num - 1)\n+        # tf.linspace expects an integer num; ensure correct dtype\n+        result = tf.linspace(start, stop, num_int, axis=axis)\n+        if num_static is not None and int(num_static) > 1:\n+            step = (stop - start) / (num_float - tf.cast(1, start.dtype))\n     else:\n         # tf.linspace doesn't support endpoint=False, so we manually handle it\n-        if num > 0:\n-            step = (stop - start) / num\n-        if num > 1:\n+        if num_static is not None and int(num_static) > 0:\n+            step = (stop - start) / num_float\n+        if num_static is not None and int(num_static) > 1:\n             new_stop = tf.cast(stop, step.dtype) - step\n             start = tf.cast(start, new_stop.dtype)\n-            result = tf.linspace(start, new_stop, num, axis=axis)\n+            result = tf.linspace(start, new_stop, num_int, axis=axis)\n         else:\n-            result = tf.linspace(start, stop, num, axis=axis)\n+            result = tf.linspace(start, stop, num_int, axis=axis)\n     if dtype is not None:\n         if \"int\" in dtype:\n             result = tf.floor(result)\n"
}