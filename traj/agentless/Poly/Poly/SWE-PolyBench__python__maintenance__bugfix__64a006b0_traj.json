{
    "instance_id": "SWE-PolyBench__python__maintenance__bugfix__64a006b0",
    "original_id": "keras-team__keras-19844",
    "1_model_selected_files": [
        "keras/src/legacy/saving/legacy_h5_format.py",
        "keras/src/initializers/__init__.py",
        "keras/src/saving/object_registration.py",
        "keras/src/layers/rnn/gru.py",
        "keras/src/saving/serialization_lib.py"
    ],
    "2_embedding_selected_files": [
        "keras/api/initializers/__init__.py",
        "keras/api/_tf_keras/keras/initializers/__init__.py",
        "keras/src/initializers/random_initializers.py",
        "keras/src/initializers/random_initializers_test.py",
        "keras/src/legacy/saving/legacy_h5_format_test.py",
        "keras/src/legacy/saving/legacy_h5_format.py",
        "keras/src/utils/torch_utils_test.py",
        "keras/src/initializers/constant_initializers_test.py",
        "keras/src/saving/saving_lib_test.py",
        "keras/src/layers/rnn/gru.py",
        "keras/src/trainers/trainer_test.py",
        "keras/src/layers/rnn/gru_test.py",
        "keras/src/trainers/__init__.py",
        "keras/src/callbacks/model_checkpoint_test.py",
        "keras/api/_tf_keras/keras/regularizers/__init__.py",
        "keras/api/regularizers/__init__.py",
        "keras/src/models/__init__.py",
        "keras/src/backend/common/variables.py",
        "keras/src/optimizers/ftrl.py",
        "keras/src/optimizers/optimizer_test.py",
        "keras/src/saving/saving_api_test.py",
        "keras/api/_tf_keras/keras/backend/__init__.py",
        "keras/src/initializers/constant_initializers.py",
        "keras/src/legacy/__init__.py",
        "keras/src/__init__.py",
        "keras/src/applications/xception.py",
        "keras/src/saving/saving_api.py",
        "keras/src/applications/inception_v3.py",
        "keras/src/initializers/initializer.py",
        "keras/src/backend/tensorflow/rnn.py",
        "keras/src/layers/convolutional/conv_test.py",
        "keras/src/random/__init__.py",
        "keras/api/models/__init__.py",
        "integration_tests/model_visualization_test.py",
        "keras/api/applications/inception_v3/__init__.py",
        "keras/src/optimizers/optimizer_sparse_test.py",
        "keras/src/optimizers/adagrad.py",
        "keras/src/layers/core/embedding.py",
        "keras/api/_tf_keras/keras/models/__init__.py",
        "keras/src/layers/convolutional/base_conv.py",
        "keras/src/utils/torch_utils.py",
        "keras/api/optimizers/__init__.py",
        "keras/src/regularizers/regularizers_test.py",
        "keras/src/applications/__init__.py",
        "keras/src/layers/core/dense_test.py",
        "keras/src/layers/core/embedding_test.py",
        "keras/src/optimizers/loss_scale_optimizer_test.py",
        "keras/api/_tf_keras/keras/optimizers/__init__.py",
        "keras/api/_tf_keras/keras/applications/inception_v3/__init__.py",
        "examples/demo_custom_layer_backend_agnostic.py",
        "keras/api/_tf_keras/keras/layers/__init__.py",
        "keras/src/layers/rnn/lstm_test.py",
        "keras/src/layers/core/dense.py",
        "keras/src/callbacks/tensorboard_test.py",
        "keras/src/models/functional_test.py",
        "keras/api/_tf_keras/keras/optimizers/legacy/__init__.py",
        "keras/src/legacy/saving/saving_utils.py"
    ],
    "3_final_combined_files": [
        "keras/src/legacy/saving/legacy_h5_format.py",
        "keras/src/initializers/__init__.py",
        "keras/src/saving/object_registration.py",
        "keras/api/initializers/__init__.py",
        "keras/api/_tf_keras/keras/initializers/__init__.py",
        "keras/src/initializers/random_initializers.py"
    ],
    "4_related_elements": {
        "keras/src/initializers/__init__.py": [
            "variable: ALL_OBJECTS\nvariable: ALL_OBJECTS_DICT\nfunction: deserialize\nfunction: get"
        ],
        "keras/src/legacy/saving/legacy_h5_format.py": [
            "function: load_model_from_hdf5\nfunction: load_attributes_from_hdf5_group"
        ],
        "keras/src/saving/object_registration.py": [
            "variable: GLOBAL_CUSTOM_OBJECTS\nvariable: GLOBAL_CUSTOM_NAMES\nclass: CustomObjectScope\nfunction: get_custom_objects\nfunction: register_keras_serializable\nfunction: get_registered_name\nfunction: get_registered_object"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "keras/src/initializers/__init__.py": [
                    "line: 51"
                ],
                "keras/src/legacy/saving/legacy_h5_format.py": [
                    ""
                ],
                "keras/src/saving/object_registration.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/initializers/__init__.py b/keras/src/initializers/__init__.py\nindex 6fb16d6..5b88d83 100644\n--- a/keras/src/initializers/__init__.py\n+++ b/keras/src/initializers/__init__.py\n@@ -49,6 +49,7 @@ ALL_OBJECTS_DICT.update(\n         \"uniform\": RandomUniform,\n         \"normal\": RandomNormal,\n         \"orthogonal\": OrthogonalInitializer,\n+        \"Orthogonal\": OrthogonalInitializer,\n         \"one\": Ones,\n         \"zero\": Zeros,\n     }\n",
                "diff --git a/keras/src/initializers/__init__.py b/keras/src/initializers/__init__.py\nindex 6fb16d6..5b88d83 100644\n--- a/keras/src/initializers/__init__.py\n+++ b/keras/src/initializers/__init__.py\n@@ -49,6 +49,7 @@ ALL_OBJECTS_DICT.update(\n         \"uniform\": RandomUniform,\n         \"normal\": RandomNormal,\n         \"orthogonal\": OrthogonalInitializer,\n+        \"Orthogonal\": OrthogonalInitializer,\n         \"one\": Ones,\n         \"zero\": Zeros,\n     }\ndiff --git a/keras/src/legacy/saving/legacy_h5_format.py b/keras/src/legacy/saving/legacy_h5_format.py\nindex 424b115..ca44f92 100644\n--- a/keras/src/legacy/saving/legacy_h5_format.py\n+++ b/keras/src/legacy/saving/legacy_h5_format.py\n@@ -129,6 +129,19 @@ def load_model_from_hdf5(filepath, custom_objects=None, compile=True):\n             model_config = model_config.decode(\"utf-8\")\n         model_config = json_utils.decode(model_config)\n \n+        # Sanitize legacy configs: remove unsupported args such as 'implementation'\n+        def _remove_unsupported_keys(obj):\n+            if isinstance(obj, dict):\n+                # Pop any legacy 'implementation' keys that are not supported in Keras 3\n+                obj.pop(\"implementation\", None)\n+                for k, v in list(obj.items()):\n+                    _remove_unsupported_keys(v)\n+            elif isinstance(obj, (list, tuple)):\n+                for item in obj:\n+                    _remove_unsupported_keys(item)\n+\n+        _remove_unsupported_keys(model_config)\n+\n         with saving_options.keras_option_scope(use_legacy_config=True):\n             model = saving_utils.model_from_config(\n                 model_config, custom_objects=custom_objects\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "keras/src/initializers/__init__.py": [
                    "line: 51"
                ],
                "keras/src/legacy/saving/legacy_h5_format.py": [
                    "function: load_model_from_hdf5\nline: 130"
                ],
                "keras/src/saving/object_registration.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/initializers/__init__.py b/keras/src/initializers/__init__.py\nindex 6fb16d6..5b88d83 100644\n--- a/keras/src/initializers/__init__.py\n+++ b/keras/src/initializers/__init__.py\n@@ -49,6 +49,7 @@ ALL_OBJECTS_DICT.update(\n         \"uniform\": RandomUniform,\n         \"normal\": RandomNormal,\n         \"orthogonal\": OrthogonalInitializer,\n+        \"Orthogonal\": OrthogonalInitializer,\n         \"one\": Ones,\n         \"zero\": Zeros,\n     }\n",
                "diff --git a/keras/src/initializers/__init__.py b/keras/src/initializers/__init__.py\nindex 6fb16d6..5b88d83 100644\n--- a/keras/src/initializers/__init__.py\n+++ b/keras/src/initializers/__init__.py\n@@ -49,6 +49,7 @@ ALL_OBJECTS_DICT.update(\n         \"uniform\": RandomUniform,\n         \"normal\": RandomNormal,\n         \"orthogonal\": OrthogonalInitializer,\n+        \"Orthogonal\": OrthogonalInitializer,\n         \"one\": Ones,\n         \"zero\": Zeros,\n     }\ndiff --git a/keras/src/legacy/saving/legacy_h5_format.py b/keras/src/legacy/saving/legacy_h5_format.py\nindex 424b115..30fe32d 100644\n--- a/keras/src/legacy/saving/legacy_h5_format.py\n+++ b/keras/src/legacy/saving/legacy_h5_format.py\n@@ -129,6 +129,23 @@ def load_model_from_hdf5(filepath, custom_objects=None, compile=True):\n             model_config = model_config.decode(\"utf-8\")\n         model_config = json_utils.decode(model_config)\n \n+        # Remove legacy/unsupported args from old configs (e.g., 'implementation' in RNNs).\n+        def _remove_legacy_rnn_implementation(obj):\n+            if isinstance(obj, dict):\n+                class_name = obj.get(\"class_name\")\n+                config = obj.get(\"config\")\n+                if class_name in (\"GRU\", \"LSTM\", \"SimpleRNN\") and isinstance(config, dict):\n+                    if \"implementation\" in config:\n+                        config.pop(\"implementation\", None)\n+                # Recurse into nested structures\n+                for v in obj.values():\n+                    _remove_legacy_rnn_implementation(v)\n+            elif isinstance(obj, list):\n+                for item in obj:\n+                    _remove_legacy_rnn_implementation(item)\n+\n+        _remove_legacy_rnn_implementation(model_config)\n+\n         with saving_options.keras_option_scope(use_legacy_config=True):\n             model = saving_utils.model_from_config(\n                 model_config, custom_objects=custom_objects\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/keras/src/initializers/__init__.py b/keras/src/initializers/__init__.py\nindex 6fb16d6..5b88d83 100644\n--- a/keras/src/initializers/__init__.py\n+++ b/keras/src/initializers/__init__.py\n@@ -49,6 +49,7 @@ ALL_OBJECTS_DICT.update(\n         \"uniform\": RandomUniform,\n         \"normal\": RandomNormal,\n         \"orthogonal\": OrthogonalInitializer,\n+        \"Orthogonal\": OrthogonalInitializer,\n         \"one\": Ones,\n         \"zero\": Zeros,\n     }\n"
}