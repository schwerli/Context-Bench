{
    "instance_id": "SWE-PolyBench__python__maintenance__bugfix__380568e9",
    "original_id": "keras-team__keras-19636",
    "1_model_selected_files": [
        "keras/src/layers/layer.py",
        "keras/src/dtype_policies/dtype_policy.py",
        "keras/src/utils/dtype_utils.py",
        "keras/src/trainers/data_adapters/array_data_adapter.py",
        "keras/src/backend/common/dtypes.py"
    ],
    "2_embedding_selected_files": [
        "keras/src/utils/dtype_utils_test.py",
        "keras/src/ops/numpy.py",
        "keras/src/dtype_policies/dtype_policy_test.py",
        "keras/src/applications/imagenet_utils_test.py",
        "keras/src/losses/loss_test.py",
        "keras/api/_tf_keras/keras/ops/numpy/__init__.py",
        "keras/src/layers/core/einsum_dense_test.py",
        "keras/src/layers/preprocessing/random_translation_test.py",
        "keras/src/backend/tensorflow/numpy.py",
        "keras/api/_tf_keras/keras/backend/__init__.py",
        "keras/src/layers/core/embedding_test.py",
        "keras/src/dtype_policies/dtype_policy.py",
        "keras/api/_tf_keras/keras/ops/__init__.py",
        "keras/src/utils/dtype_utils.py",
        "keras/src/ops/numpy_test.py",
        "keras/api/ops/numpy/__init__.py",
        "keras/src/backend/tensorflow/nn.py",
        "keras/api/ops/__init__.py",
        "keras/src/backend/common/dtypes_test.py",
        "keras/src/legacy/backend.py",
        "keras/src/backend/numpy/nn.py",
        "keras/src/random/random_test.py",
        "keras/api/_tf_keras/keras/mixed_precision/__init__.py",
        "keras/src/layers/preprocessing/resizing_test.py",
        "keras/src/backend/numpy/__init__.py",
        "keras/src/layers/preprocessing/feature_space_test.py",
        "keras/src/models/functional_test.py",
        "keras/src/applications/inception_v3.py",
        "keras/src/layers/preprocessing/category_encoding_test.py",
        "keras/src/layers/core/input_layer_test.py",
        "keras/src/backend/numpy/core.py",
        "keras/src/backend/torch/numpy.py",
        "keras/src/utils/numerical_utils.py"
    ],
    "3_final_combined_files": [
        "keras/src/layers/layer.py",
        "keras/src/dtype_policies/dtype_policy.py",
        "keras/src/utils/dtype_utils.py",
        "keras/src/utils/dtype_utils_test.py",
        "keras/src/ops/numpy.py",
        "keras/src/dtype_policies/dtype_policy_test.py"
    ],
    "4_related_elements": {
        "keras/src/dtype_policies/dtype_policy.py": [
            "function: DTypePolicy.convert_input"
        ],
        "keras/src/utils/dtype_utils.py": [
            "function: is_float\nfunction: cast_to_common_dtype"
        ],
        "keras/src/layers/layer.py": [
            "function: Layer.__call__\nfunction: Layer.stateless_call"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "keras/src/dtype_policies/dtype_policy.py": [
                    "function: DTypePolicy.convert_input\nline: 155\nline: 156"
                ],
                "keras/src/layers/layer.py": [
                    ""
                ],
                "keras/src/utils/dtype_utils.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/dtype_policies/dtype_policy.py b/keras/src/dtype_policies/dtype_policy.py\nindex faedb54..a11fc2d 100644\n--- a/keras/src/dtype_policies/dtype_policy.py\n+++ b/keras/src/dtype_policies/dtype_policy.py\n@@ -153,7 +153,14 @@ class DTypePolicy:\n                 x.dtype = dtype\n             return x\n         elif hasattr(x, \"__array__\"):\n-            return ops.convert_to_tensor(x, dtype=dtype)\n+            # Preserve non-float numpy dtypes (e.g., int) and only autocast float arrays.\n+            if autocast:\n+                x_dtype = getattr(x, \"dtype\", None)\n+                if x_dtype is not None and backend.is_float_dtype(x_dtype):\n+                    # Only cast if the source float dtype differs from target dtype.\n+                    if backend.standardize_dtype(x_dtype) != dtype:\n+                        return ops.convert_to_tensor(x, dtype=dtype)\n+            return ops.convert_to_tensor(x)\n         return x\n \n     def get_config(self):\n",
                "diff --git a/keras/src/dtype_policies/dtype_policy.py b/keras/src/dtype_policies/dtype_policy.py\nindex faedb54..9108b61 100644\n--- a/keras/src/dtype_policies/dtype_policy.py\n+++ b/keras/src/dtype_policies/dtype_policy.py\n@@ -153,7 +153,20 @@ class DTypePolicy:\n                 x.dtype = dtype\n             return x\n         elif hasattr(x, \"__array__\"):\n-            return ops.convert_to_tensor(x, dtype=dtype)\n+            # For NumPy arrays or array-like inputs, only autocast float dtypes.\n+            if autocast:\n+                x_dtype = getattr(x, \"dtype\", None)\n+                # Determine if the input dtype is floating-point\n+                is_float = False\n+                if x_dtype is not None:\n+                    try:\n+                        is_float = backend.is_float_dtype(x_dtype)\n+                    except Exception:\n+                        # Fallback for NumPy dtypes\n+                        is_float = getattr(x_dtype, \"kind\", None) == \"f\"\n+                if is_float and backend.standardize_dtype(x_dtype) != dtype:\n+                    return ops.convert_to_tensor(x, dtype=dtype)\n+            return ops.convert_to_tensor(x)\n         return x\n \n     def get_config(self):\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "keras/src/dtype_policies/dtype_policy.py": [
                    "function: DTypePolicy.convert_input\nline: 155\nline: 156\nline: 157"
                ],
                "keras/src/layers/layer.py": [
                    ""
                ],
                "keras/src/utils/dtype_utils.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/keras/src/dtype_policies/dtype_policy.py b/keras/src/dtype_policies/dtype_policy.py\nindex faedb54..5768018 100644\n--- a/keras/src/dtype_policies/dtype_policy.py\n+++ b/keras/src/dtype_policies/dtype_policy.py\n@@ -153,7 +153,17 @@ class DTypePolicy:\n                 x.dtype = dtype\n             return x\n         elif hasattr(x, \"__array__\"):\n-            return ops.convert_to_tensor(x, dtype=dtype)\n+            # Preserve non-float dtypes (e.g., ints) and only cast floats when autocast is enabled\n+            np_dtype = getattr(x, \"dtype\", None)\n+            if (\n+                autocast\n+                and np_dtype is not None\n+                and backend.is_float_dtype(np_dtype)\n+                and backend.standardize_dtype(np_dtype) != dtype\n+            ):\n+                return ops.convert_to_tensor(x, dtype=dtype)\n+            # Convert without forcing dtype to avoid unintended casting of integers to floats\n+            return ops.convert_to_tensor(x)\n         return x\n \n     def get_config(self):\n",
                "diff --git a/keras/src/dtype_policies/dtype_policy.py b/keras/src/dtype_policies/dtype_policy.py\nindex faedb54..fc7b14a 100644\n--- a/keras/src/dtype_policies/dtype_policy.py\n+++ b/keras/src/dtype_policies/dtype_policy.py\n@@ -153,7 +153,13 @@ class DTypePolicy:\n                 x.dtype = dtype\n             return x\n         elif hasattr(x, \"__array__\"):\n-            return ops.convert_to_tensor(x, dtype=dtype)\n+            # Only autocast floating-point numpy inputs to the policy dtype.\n+            # Preserve non-floating dtypes (e.g., ints, bools) to avoid unintended casting.\n+            x_dtype = getattr(x, \"dtype\", None)\n+            if autocast and x_dtype is not None and backend.is_float_dtype(x_dtype):\n+                return ops.convert_to_tensor(x, dtype=dtype)\n+            else:\n+                return ops.convert_to_tensor(x)\n         return x\n \n     def get_config(self):\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/keras/src/dtype_policies/dtype_policy.py b/keras/src/dtype_policies/dtype_policy.py\nindex faedb54..a11fc2d 100644\n--- a/keras/src/dtype_policies/dtype_policy.py\n+++ b/keras/src/dtype_policies/dtype_policy.py\n@@ -153,7 +153,14 @@ class DTypePolicy:\n                 x.dtype = dtype\n             return x\n         elif hasattr(x, \"__array__\"):\n-            return ops.convert_to_tensor(x, dtype=dtype)\n+            # Preserve non-float numpy dtypes (e.g., int) and only autocast float arrays.\n+            if autocast:\n+                x_dtype = getattr(x, \"dtype\", None)\n+                if x_dtype is not None and backend.is_float_dtype(x_dtype):\n+                    # Only cast if the source float dtype differs from target dtype.\n+                    if backend.standardize_dtype(x_dtype) != dtype:\n+                        return ops.convert_to_tensor(x, dtype=dtype)\n+            return ops.convert_to_tensor(x)\n         return x\n \n     def get_config(self):\n"
}