{
    "instance_id": "SWE-PolyBench__typescript__evolution__feature__41cd3842",
    "original_id": "coder__code-server-4923",
    "1_model_selected_files": [
        "src/node/socket.ts",
        "src/node/cli.ts",
        "src/node/settings.ts",
        "src/node/http.ts",
        "src/node/app.ts"
    ],
    "2_embedding_selected_files": [
        "src/node/cli.ts",
        "src/node/main.ts",
        "src/node/socket.ts",
        "src/node/http.ts",
        "src/node/coder_cloud.ts",
        "src/node/settings.ts",
        "src/node/util.ts",
        "ci/dev/watch.ts",
        "src/node/routes/vscode.ts",
        "typings/pluginapi.d.ts",
        "src/node/wrapper.ts",
        "src/node/routes/domainProxy.ts",
        "src/common/http.ts",
        "src/node/entry.ts",
        "src/node/update.ts",
        "src/node/app.ts",
        "src/node/routes/errors.ts",
        "src/node/routes/pathProxy.ts",
        "src/node/plugin.ts",
        "src/node/wsRouter.ts",
        "src/node/constants.ts",
        "src/node/routes/index.ts",
        "src/node/proxy.ts",
        "src/node/heart.ts",
        "typings/httpolyglot/index.d.ts",
        "src/node/routes/health.ts",
        "src/node/routes/update.ts",
        "src/common/util.ts",
        "src/node/routes/logout.ts",
        "src/node/routes/login.ts",
        "src/common/emitter.ts",
        "src/node/routes/apps.ts"
    ],
    "3_final_combined_files": [
        "src/node/socket.ts",
        "src/node/cli.ts",
        "src/node/settings.ts",
        "src/node/main.ts"
    ],
    "4_related_elements": {
        "src/node/cli.ts": [
            "variable: options\nfunction: parse\nfunction: setDefaults\nfunction: toVsCodeArgs\nfunction: parseConfigFile\nvariable: DEFAULT_SOCKET_PATH\nfunction: shouldOpenInExistingInstance\nfunction: readSocketPath"
        ],
        "src/node/socket.ts": [
            "class: SocketProxyProvider\nfunction: SocketProxyProvider.startProxyServer\nfunction: SocketProxyProvider.findFreeSocketPath"
        ],
        "src/node/settings.ts": [
            ""
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/node/cli.ts": [
                    "line: 58\nfunction: parse\nline: 177"
                ],
                "src/node/socket.ts": [
                    "function: SocketProxyProvider.stop\nfunction: SocketProxyProvider.startProxyServer\nline: 79\nline: 80\nline: 81"
                ],
                "src/node/settings.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/node/socket.ts b/src/node/socket.ts\nindex 0b29ef8..a87421d 100644\n--- a/src/node/socket.ts\n+++ b/src/node/socket.ts\n@@ -77,7 +77,7 @@ export class SocketProxyProvider {\n           this.proxyPipe = pipe\n           return Promise.all([\n             fs.mkdir(path.dirname(this.proxyPipe), { recursive: true }),\n-            fs.rmdir(this.proxyPipe, { recursive: true }),\n+            fs.rm(this.proxyPipe, { recursive: true, force: true }),\n           ])\n         })\n         .then(() => {\n",
                "diff --git a/src/node/socket.ts b/src/node/socket.ts\nindex 0b29ef8..b45772f 100644\n--- a/src/node/socket.ts\n+++ b/src/node/socket.ts\n@@ -75,15 +75,32 @@ export class SocketProxyProvider {\n       this._proxyServer = this.findFreeSocketPath(this.proxyPipe)\n         .then((pipe) => {\n           this.proxyPipe = pipe\n-          return Promise.all([\n-            fs.mkdir(path.dirname(this.proxyPipe), { recursive: true }),\n-            fs.rmdir(this.proxyPipe, { recursive: true }),\n-          ])\n+          // Ensure the runtime directory exists and remove any stale socket\n+          // from previous runs to avoid EADDRINUSE when binding.\n+          await fs.mkdir(path.dirname(this.proxyPipe), { recursive: true })\n+          try {\n+            await fs.unlink(this.proxyPipe)\n+          } catch (error: any) {\n+            if (error.code !== \"ENOENT\") {\n+              throw error\n+            }\n+          }\n         })\n         .then(() => {\n           return new Promise((resolve) => {\n             const proxyServer = net.createServer((p) => this.onProxyConnect.emit(p))\n             proxyServer.once(\"listening\", () => resolve(proxyServer))\n+            // Unlink the socket file when the server closes.\n+            proxyServer.once(\"close\", async () => {\n+              try {\n+                await fs.unlink(this.proxyPipe)\n+              } catch (error: any) {\n+                if (error.code !== \"ENOENT\") {\n+                  // eslint-disable-next-line no-console\n+                  console.error(\"Failed to unlink proxy socket:\", error)\n+                }\n+              }\n+            })\n             proxyServer.listen(this.proxyPipe)\n           })\n         })\n@@ -99,4 +116,4 @@ export class SocketProxyProvider {\n     }\n     return path\n   }\n-}\n+}\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/node/cli.ts": [
                    "line: 177\nfunction: parse"
                ],
                "src/node/socket.ts": [
                    "class: SocketProxyProvider\nfunction: SocketProxyProvider.startProxyServer\nline: 80"
                ],
                "src/node/settings.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/node/cli.ts b/src/node/cli.ts\nindex b07d6e7..0b28fe6 100644\n--- a/src/node/cli.ts\n+++ b/src/node/cli.ts\n@@ -1,3 +1,4 @@\n+\n import { field, Level, logger } from \"@coder/logger\"\n import { promises as fs } from \"fs\"\n import yaml from \"js-yaml\"\n@@ -56,6 +57,9 @@ export interface UserProvidedArgs {\n   open?: boolean\n   \"bind-addr\"?: string\n   socket?: string\n+  \"socket-mode\"?: number\n+  \"socket-user\"?: string\n+  \"socket-group\"?: string\n   version?: boolean\n   \"proxy-domain\"?: string[]\n   \"reuse-window\"?: boolean\n@@ -175,6 +179,18 @@ const options: Options<Required<UserProvidedArgs>> = {\n   port: { type: \"number\", description: \"\" },\n \n   socket: { type: \"string\", path: true, description: \"Path to a socket (bind-addr will be ignored).\" },\n+  \"socket-mode\": {\n+    type: \"number\",\n+    description: \"Unix socket file mode in octal (e.g. 770) when using --socket.\",\n+  },\n+  \"socket-user\": {\n+    type: \"string\",\n+    description: \"Owner user (name or uid) for the unix socket when using --socket.\",\n+  },\n+  \"socket-group\": {\n+    type: \"string\",\n+    description: \"Owner group (name or gid) for the unix socket when using --socket.\",\n+  },\n   version: { type: \"boolean\", short: \"v\", description: \"Display version information.\" },\n   _: { type: \"string[]\" },\n \n@@ -360,6 +376,29 @@ export const parse = (\n         continue\n       }\n \n+      // Special handling for --socket to allow comma-separated mode,user,group.\n+      if (key === \"socket\" && value) {\n+        const parts = value.split(\",\")\n+        const pth = parts[0]\n+        const modeStr = parts[1]\n+        const userStr = parts[2]\n+        const groupStr = parts[3]\n+        if (modeStr && modeStr.length > 0) {\n+          const modeNum = parseInt(modeStr, 8)\n+          if (isNaN(modeNum)) {\n+            throw error(`--socket mode must be an octal number (e.g. 770)`)\n+          }\n+          ;(args[\"socket-mode\"] as number) = modeNum\n+        }\n+        if (userStr && userStr.length > 0) {\n+          ;(args[\"socket-user\"] as string) = userStr\n+        }\n+        if (groupStr && groupStr.length > 0) {\n+          ;(args[\"socket-group\"] as string) = groupStr\n+        }\n+        value = pth\n+      }\n+\n       if (option.path) {\n         value = path.resolve(value)\n       }\n@@ -771,4 +810,4 @@ export const toVsCodeArgs = async (args: DefaultedArgs): Promise<CodeServerLib.S\n     version: !!args.version,\n     port: args.port?.toString(),\n   }\n-}\n+}\ndiff --git a/src/node/socket.ts b/src/node/socket.ts\nindex 0b29ef8..4e4a467 100644\n--- a/src/node/socket.ts\n+++ b/src/node/socket.ts\n@@ -21,7 +21,11 @@ export class SocketProxyProvider {\n    */\n   public stop(): void {\n     if (this._proxyServer) {\n-      this._proxyServer.then((server) => server.close())\n+      this._proxyServer.then((server) => {\n+        server.close()\n+        // Attempt to clean up the proxy socket path to avoid \"address already in use\" on restart.\n+        fs.rm(this.proxyPipe, { force: true }).catch(() => undefined)\n+      })\n       this._proxyServer = undefined\n     }\n   }\n@@ -77,13 +81,18 @@ export class SocketProxyProvider {\n           this.proxyPipe = pipe\n           return Promise.all([\n             fs.mkdir(path.dirname(this.proxyPipe), { recursive: true }),\n-            fs.rmdir(this.proxyPipe, { recursive: true }),\n+            // Remove any stale socket file before binding.\n+            fs.rm(this.proxyPipe, { force: true }),\n           ])\n         })\n         .then(() => {\n           return new Promise((resolve) => {\n             const proxyServer = net.createServer((p) => this.onProxyConnect.emit(p))\n-            proxyServer.once(\"listening\", () => resolve(proxyServer))\n+            proxyServer.once(\"listening\", () => {\n+              // Set restrictive permissions on the proxy socket to avoid world-readability.\n+              fs.chmod(this.proxyPipe, 0o770).catch(() => undefined)\n+              resolve(proxyServer)\n+            })\n             proxyServer.listen(this.proxyPipe)\n           })\n         })\n",
                "diff --git a/src/node/socket.ts b/src/node/socket.ts\nindex 0b29ef8..86e6c7f 100644\n--- a/src/node/socket.ts\n+++ b/src/node/socket.ts\n@@ -21,7 +21,17 @@ export class SocketProxyProvider {\n    */\n   public stop(): void {\n     if (this._proxyServer) {\n-      this._proxyServer.then((server) => server.close())\n+      this._proxyServer.then(async (server) => {\n+        server.close()\n+        try {\n+          await fs.unlink(this.proxyPipe)\n+        } catch (error: any) {\n+          // It's fine if the socket file doesn't exist; ignore that error.\n+          if (error.code !== \"ENOENT\") {\n+            // Swallow other errors to avoid throwing during stop.\n+          }\n+        }\n+      })\n       this._proxyServer = undefined\n     }\n   }\n@@ -73,12 +83,17 @@ export class SocketProxyProvider {\n   private async startProxyServer(): Promise<net.Server> {\n     if (!this._proxyServer) {\n       this._proxyServer = this.findFreeSocketPath(this.proxyPipe)\n-        .then((pipe) => {\n+        .then(async (pipe) => {\n           this.proxyPipe = pipe\n-          return Promise.all([\n-            fs.mkdir(path.dirname(this.proxyPipe), { recursive: true }),\n-            fs.rmdir(this.proxyPipe, { recursive: true }),\n-          ])\n+          await fs.mkdir(path.dirname(this.proxyPipe), { recursive: true })\n+          try {\n+            await fs.unlink(this.proxyPipe)\n+          } catch (error: any) {\n+            // If it doesn't exist, that's fine; otherwise rethrow.\n+            if (error.code !== \"ENOENT\") {\n+              throw error\n+            }\n+          }\n         })\n         .then(() => {\n           return new Promise((resolve) => {\n@@ -99,4 +114,4 @@ export class SocketProxyProvider {\n     }\n     return path\n   }\n-}\n+}\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/node/socket.ts b/src/node/socket.ts\nindex 0b29ef8..a87421d 100644\n--- a/src/node/socket.ts\n+++ b/src/node/socket.ts\n@@ -77,7 +77,7 @@ export class SocketProxyProvider {\n           this.proxyPipe = pipe\n           return Promise.all([\n             fs.mkdir(path.dirname(this.proxyPipe), { recursive: true }),\n-            fs.rmdir(this.proxyPipe, { recursive: true }),\n+            fs.rm(this.proxyPipe, { recursive: true, force: true }),\n           ])\n         })\n         .then(() => {\n"
}