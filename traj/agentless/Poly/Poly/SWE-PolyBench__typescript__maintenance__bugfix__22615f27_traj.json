{
    "instance_id": "SWE-PolyBench__typescript__maintenance__bugfix__22615f27",
    "original_id": "microsoft__vscode-153121",
    "1_model_selected_files": [
        "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts",
        "src/vs/editor/common/core/wordCharacterClassifier.ts",
        "src/vs/base/common/strings.ts",
        "src/vs/editor/common/core/wordHelper.ts"
    ],
    "2_embedding_selected_files": [
        "src/vs/editor/common/config/editorOptions.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/fixBrackets.ts",
        "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts",
        "src/vs/workbench/contrib/codeEditor/browser/toggleWordWrap.ts",
        "src/vs/editor/browser/view/domLineBreaksComputer.ts",
        "src/vs/monaco.d.ts",
        "extensions/emmet/src/abbreviationActions.ts",
        "src/vs/editor/common/languages/supports/richEditBrackets.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsImpl.ts",
        "src/vs/workbench/browser/parts/editor/textDiffEditor.ts",
        "src/vs/base/common/marked/marked.js",
        "src/vs/editor/contrib/inlineCompletions/browser/inlineCompletionToGhostText.ts",
        "src/vs/editor/common/languages/supports/onEnter.ts",
        "src/vs/editor/common/cursor/cursorTypeOperations.ts",
        "src/vs/editor/common/diff/diffComputer.ts",
        "src/vs/editor/standalone/common/monarch/monarchCompile.ts",
        "src/vs/editor/common/languages/supports/languageBracketsConfiguration.ts",
        "src/vs/editor/browser/widget/diffEditorWidget.ts",
        "src/vs/editor/contrib/bracketMatching/browser/bracketMatching.ts",
        "src/vs/editor/browser/controller/textAreaHandler.ts",
        "src/vs/editor/common/viewLayout/viewLineRenderer.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/bracketPairsTree.ts",
        "src/vs/code/electron-sandbox/issue/issueReporterMain.ts",
        "extensions/vscode-api-tests/src/singlefolder-tests/workspace.test.ts",
        "extensions/vscode-api-tests/src/singlefolder-tests/window.test.ts",
        "extensions/vscode-api-tests/src/singlefolder-tests/editor.test.ts",
        "src/vs/editor/contrib/smartSelect/browser/bracketSelections.ts",
        "src/vs/editor/common/viewModel/viewModelLines.ts",
        "src/vs/code/electron-sandbox/issue/issueReporterPage.ts",
        "src/vs/editor/common/languages/supports.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/brackets.ts",
        "src/vs/workbench/browser/parts/editor/tabsTitleControl.ts",
        "src/vs/editor/common/cursor/cursorWordOperations.ts",
        "src/vs/editor/common/textModelBracketPairs.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/ast.ts",
        "src/vs/editor/browser/widget/diffReview.ts",
        "src/vs/base/common/jsonFormatter.ts",
        "src/vs/editor/common/standalone/standaloneEnums.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/parser.ts",
        "src/vscode-dts/vscode.proposed.inlineCompletionsAdditions.d.ts",
        "src/vs/editor/common/core/eolCounter.ts",
        "src/vs/editor/common/languages/languageConfiguration.ts",
        "src/vs/editor/common/tokens/contiguousTokensStore.ts",
        "src/vs/editor/common/model/guidesTextModelPart.ts",
        "extensions/emmet/src/splitJoinTag.ts",
        "src/vs/editor/standalone/common/monarch/monarchLexer.ts",
        "extensions/markdown-language-features/preview-src/index.ts",
        "src/vs/workbench/contrib/welcomeWalkthrough/browser/editor/vs_code_editor_walkthrough.ts",
        "src/vs/editor/common/languages/supports/characterPair.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/tokenizer.ts",
        "src/vs/editor/browser/viewParts/lines/viewLines.ts",
        "src/vs/workbench/contrib/codeEditor/browser/languageConfigurationExtensionPoint.ts"
    ],
    "3_final_combined_files": [
        "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts",
        "src/vs/editor/common/core/wordCharacterClassifier.ts",
        "src/vs/base/common/strings.ts",
        "src/vs/editor/common/config/editorOptions.ts",
        "src/vs/editor/common/model/bracketPairsTextModelPart/fixBrackets.ts"
    ],
    "4_related_elements": {
        "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts": [
            "class: MonospaceLineBreaksComputerFactory\nclass: WrappingCharacterClassifier\nfunction: createLineBreaks\nfunction: createLineBreaksFromPreviousLineBreaks\nfunction: canBreak\nfunction: computeWrappedTextIndentLength\nfunction: computeCharWidth\nvariable: arrPool1\nvariable: arrPool2\nvariable: EditorOption.wordWrapBreakBeforeCharacters\nvariable: EditorOption.wordWrapBreakAfterCharacters"
        ],
        "src/vs/editor/common/core/wordCharacterClassifier.ts": [
            "class: WordCharacterClassifier\nfunction: getMapForWordSeparators"
        ],
        "src/vs/base/common/strings.ts": [
            "function: isFullWidthCharacter\nfunction: isHighSurrogate\nfunction: isLowSurrogate\nfunction: firstNonWhitespaceIndex\nfunction: getLeadingWhitespace\nvariable: noBreakWhitespace"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts": [
                    "function: canBreak"
                ],
                "src/vs/editor/common/core/wordCharacterClassifier.ts": [
                    ""
                ],
                "src/vs/base/common/strings.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\nindex 64909ad..f1c66ea 100644\n--- a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n+++ b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n@@ -488,10 +488,11 @@ function tabCharacterWidth(visibleColumn: number, tabSize: number): number {\n function canBreak(prevCharCode: number, prevCharCodeClass: CharacterClass, charCode: number, charCodeClass: CharacterClass): boolean {\n \treturn (\n \t\tcharCode !== CharCode.Space\n+\t\t// Do not allow a break before trailing punctuation (e.g. comma, period)\n+\t\t&& charCodeClass !== CharacterClass.BREAK_BEFORE\n \t\t&& (\n \t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER)\n \t\t\t|| (prevCharCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && charCodeClass !== CharacterClass.BREAK_AFTER)\n-\t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE)\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n \t\t)\n \t);\n",
                "diff --git a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\nindex 64909ad..505a0ba 100644\n--- a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n+++ b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n@@ -489,7 +489,7 @@ function canBreak(prevCharCode: number, prevCharCodeClass: CharacterClass, charC\n \treturn (\n \t\tcharCode !== CharCode.Space\n \t\t&& (\n-\t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER)\n+\t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER && charCodeClass !== CharacterClass.BREAK_AFTER)\n \t\t\t|| (prevCharCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && charCodeClass !== CharacterClass.BREAK_AFTER)\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE)\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts": [
                    "function: canBreak\nline: 488\nline: 489\nline: 490\nline: 491\nline: 492\nline: 493\nline: 494\nline: 495\nline: 496\nline: 497"
                ],
                "src/vs/editor/common/core/wordCharacterClassifier.ts": [
                    ""
                ],
                "src/vs/base/common/strings.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\nindex 64909ad..779815a 100644\n--- a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n+++ b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n@@ -485,13 +485,26 @@ function tabCharacterWidth(visibleColumn: number, tabSize: number): number {\n  * Kinsoku Shori : Don't break after a leading character, like an open bracket\n  * Kinsoku Shori : Don't break before a trailing character, like a period\n  */\n+function isAsciiTrailingPunctuation(charCode: number): boolean {\n+\t// ASCII punctuation that should not start a line (i.e., don't break before them)\n+\t// , . : ; ? !\n+\treturn (\n+\t\tcharCode === 44  // ,\n+\t\t|| charCode === 46 // .\n+\t\t|| charCode === 58 // :\n+\t\t|| charCode === 59 // ;\n+\t\t|| charCode === 63 // ?\n+\t\t|| charCode === 33 // !\n+\t);\n+}\n+\n function canBreak(prevCharCode: number, prevCharCodeClass: CharacterClass, charCode: number, charCodeClass: CharacterClass): boolean {\n \treturn (\n \t\tcharCode !== CharCode.Space\n \t\t&& (\n \t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER)\n \t\t\t|| (prevCharCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && charCodeClass !== CharacterClass.BREAK_AFTER)\n-\t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE)\n+\t\t\t|| ((charCodeClass === CharacterClass.BREAK_BEFORE) && !isAsciiTrailingPunctuation(charCode))\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n \t\t)\n \t);\n",
                "diff --git a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\nindex 64909ad..b69deef 100644\n--- a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n+++ b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n@@ -489,9 +489,13 @@ function canBreak(prevCharCode: number, prevCharCodeClass: CharacterClass, charC\n \treturn (\n \t\tcharCode !== CharCode.Space\n \t\t&& (\n-\t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER)\n+\t\t\t// Allow breaking after trailing characters, but not if the next character is also trailing (e.g., before a comma)\n+\t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER && charCodeClass !== CharacterClass.BREAK_AFTER)\n+\t\t\t// Allow breaking around ideographic characters, respecting kinsoku rules\n \t\t\t|| (prevCharCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && charCodeClass !== CharacterClass.BREAK_AFTER)\n-\t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE)\n+\t\t\t// Allow breaking before leading characters, but not if the previous character is also a leading one\n+\t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n+\t\t\t// Allow breaking around ideographic characters, respecting kinsoku rules\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n \t\t)\n \t);\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\nindex 64909ad..f1c66ea 100644\n--- a/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n+++ b/src/vs/editor/common/viewModel/monospaceLineBreaksComputer.ts\n@@ -488,10 +488,11 @@ function tabCharacterWidth(visibleColumn: number, tabSize: number): number {\n function canBreak(prevCharCode: number, prevCharCodeClass: CharacterClass, charCode: number, charCodeClass: CharacterClass): boolean {\n \treturn (\n \t\tcharCode !== CharCode.Space\n+\t\t// Do not allow a break before trailing punctuation (e.g. comma, period)\n+\t\t&& charCodeClass !== CharacterClass.BREAK_BEFORE\n \t\t&& (\n \t\t\t(prevCharCodeClass === CharacterClass.BREAK_AFTER)\n \t\t\t|| (prevCharCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && charCodeClass !== CharacterClass.BREAK_AFTER)\n-\t\t\t|| (charCodeClass === CharacterClass.BREAK_BEFORE)\n \t\t\t|| (charCodeClass === CharacterClass.BREAK_IDEOGRAPHIC && prevCharCodeClass !== CharacterClass.BREAK_BEFORE)\n \t\t)\n \t);\n"
}