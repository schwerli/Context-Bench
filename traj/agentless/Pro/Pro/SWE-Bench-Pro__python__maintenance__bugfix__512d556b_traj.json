{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__512d556b",
    "original_id": "instance_ansible__ansible-fb144c44144f8bd3542e71f5db62b6d322c7bd85-vba6da65a0f3baefda7a058ebbd0a8dcafb8512f5",
    "1_model_selected_files": [
        "lib/ansible/utils/plugin_docs.py",
        "lib/ansible/cli/doc.py",
        "lib/ansible/parsing/plugin_docs.py",
        "lib/ansible/utils/display.py"
    ],
    "2_embedding_selected_files": [
        "lib/ansible/cli/doc.py",
        "hacking/build_library/build_ansible/command_plugins/dump_config.py",
        "lib/ansible/plugins/doc_fragments/template_common.py",
        "lib/ansible/utils/plugin_docs.py",
        "hacking/build_library/build_ansible/command_plugins/generate_man.py",
        "docs/bin/find-plugin-refs.py",
        "docs/docsite/rst/conf.py",
        "lib/ansible/modules/raw.py",
        "lib/ansible/errors/yaml_strings.py",
        "hacking/build_library/build_ansible/command_plugins/dump_keywords.py",
        "lib/ansible/plugins/doc_fragments/default_callback.py",
        "lib/ansible/parsing/plugin_docs.py",
        "hacking/build_library/build_ansible/command_plugins/docs_build.py",
        "lib/ansible/plugins/doc_fragments/return_common.py",
        "hacking/fix_test_syntax.py",
        "lib/ansible/plugins/doc_fragments/shell_common.py",
        "lib/ansible/plugins/doc_fragments/__init__.py",
        "hacking/build_library/build_ansible/command_plugins/file_deprecated_issues.py",
        "lib/ansible/modules/command.py",
        "lib/ansible/utils/display.py",
        "lib/ansible/modules/debug.py",
        "lib/ansible/plugins/doc_fragments/files.py",
        "hacking/build_library/build_ansible/announce.py",
        "lib/ansible/plugins/doc_fragments/constructed.py",
        "hacking/build_library/build_ansible/command_plugins/release_announcement.py",
        "hacking/build_library/build_ansible/command_plugins/porting_guide.py",
        "lib/ansible/plugins/doc_fragments/shell_windows.py",
        "lib/ansible/modules/replace.py",
        "lib/ansible/modules/shell.py",
        "lib/ansible/modules/template.py",
        "docs/docsite/_extensions/pygments_lexer.py",
        "lib/ansible/cli/config.py",
        "hacking/build_library/build_ansible/command_plugins/collection_meta.py",
        "lib/ansible/cli/__init__.py",
        "lib/ansible/module_utils/basic.py",
        "lib/ansible/modules/meta.py",
        "lib/ansible/cli/scripts/ansible_cli_stub.py",
        "lib/ansible/modules/assemble.py",
        "lib/ansible/plugins/doc_fragments/decrypt.py",
        "lib/ansible/plugins/doc_fragments/url.py",
        "lib/ansible/modules/cron.py",
        "lib/ansible/utils/unicode.py",
        "lib/ansible/template/__init__.py",
        "lib/ansible/plugins/become/sudo.py",
        "lib/ansible/plugins/lookup/lines.py",
        "lib/ansible/plugins/doc_fragments/validate.py",
        "lib/ansible/modules/script.py",
        "lib/ansible/plugins/lookup/together.py",
        "lib/ansible/cli/adhoc.py",
        "lib/ansible/parsing/mod_args.py",
        "lib/ansible/utils/listify.py",
        "lib/ansible/modules/systemd.py",
        "lib/ansible/cli/vault.py",
        "hacking/build-ansible.py",
        "lib/ansible/modules/assert.py",
        "lib/ansible/modules/add_host.py",
        "lib/ansible/module_utils/_text.py",
        "lib/ansible/parsing/splitter.py",
        "lib/ansible/modules/lineinfile.py",
        "lib/ansible/plugins/lookup/template.py",
        "lib/ansible/modules/pause.py",
        "lib/ansible/modules/include.py",
        "lib/ansible/vars/clean.py",
        "lib/ansible/modules/blockinfile.py",
        "lib/ansible/cli/console.py",
        "lib/ansible/modules/user.py",
        "lib/ansible/errors/__init__.py"
    ],
    "3_final_combined_files": [
        "lib/ansible/cli/doc.py",
        "lib/ansible/utils/plugin_docs.py",
        "lib/ansible/parsing/plugin_docs.py",
        "hacking/build_library/build_ansible/command_plugins/dump_config.py",
        "lib/ansible/plugins/doc_fragments/template_common.py"
    ],
    "4_related_elements": {
        "lib/ansible/cli/doc.py": [
            "function: DocCLI.format_plugin_doc\nfunction: DocCLI.get_man_text\nfunction: DocCLI.add_fields\nfunction: DocCLI.get_snippet_text\nfunction: DocCLI.display_plugin_list"
        ],
        "lib/ansible/utils/plugin_docs.py": [
            "function: get_docstring\nfunction: add_fragments"
        ],
        "lib/ansible/parsing/plugin_docs.py": [
            "function: read_docstring\nfunction: read_docstub"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "lib/ansible/cli/doc.py": [
                    "function: DocCLI.tty_ify\nfunction: DocCLI.get_man_text\nline: 617\nline: 618"
                ],
                "lib/ansible/utils/plugin_docs.py": [
                    ""
                ],
                "lib/ansible/parsing/plugin_docs.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 3f3b306..9939235 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -603,6 +603,39 @@ class DocCLI(CLI):\n         pad = display.columns * 0.20\n         limit = max(display.columns - int(pad), 70)\n \n+        # Helper functions to safely render macros without corrupting normal text\n+        def _has_macros(s):\n+            if not isinstance(s, string_types):\n+                return False\n+            if 'HORIZONTALLINE' in s:\n+                return True\n+            for tok in ('L(', 'R(', 'M(', 'B(', 'C('):\n+                if tok in s:\n+                    return True\n+            return False\n+\n+        def _safe_tty_ify(s):\n+            if isinstance(s, string_types) and _has_macros(s):\n+                return DocCLI.tty_ify(s)\n+            return s\n+\n+        def _wrap_text(s, width, initial_indent='', subsequent_indent=''):\n+            # Apply safe macro rendering and preserve horizontal rules\n+            s = _safe_tty_ify(s)\n+            if not isinstance(s, string_types):\n+                s = to_text(s) if 'to_text' in globals() else str(s)\n+            if '-------------' in s:\n+                parts = s.split('\\n-------------\\n')\n+                out_lines = []\n+                for idx, part in enumerate(parts):\n+                    if part:\n+                        out_lines.append(textwrap.fill(part, width, initial_indent=initial_indent, subsequent_indent=subsequent_indent))\n+                    if idx != len(parts) - 1:\n+                        # Insert the horizontal rule on its own line with no indentation\n+                        out_lines.append('-------------')\n+                return \"\\n\".join(out_lines)\n+            return textwrap.fill(s, width, initial_indent=initial_indent, subsequent_indent=subsequent_indent)\n+\n         plugin_name = doc.get(context.CLIARGS['type'], doc.get('plugin_type'))\n         if collection_name:\n             plugin_name = '%s.%s' % (collection_name, plugin_name)\n@@ -614,8 +647,7 @@ class DocCLI(CLI):\n         else:\n             desc = doc.pop('description')\n \n-        text.append(\"%s\\n\" % textwrap.fill(DocCLI.tty_ify(desc), limit, initial_indent=opt_indent,\n-                                           subsequent_indent=opt_indent))\n+        text.append(\"%s\\n\" % _wrap_text(desc, limit, initial_indent=opt_indent, subsequent_indent=opt_indent))\n \n         if doc.get('deprecated', False):\n             text.append(\"DEPRECATED: \\n\")\n@@ -643,8 +675,8 @@ class DocCLI(CLI):\n         if doc.get('notes', False):\n             text.append(\"NOTES:\")\n             for note in doc['notes']:\n-                text.append(textwrap.fill(DocCLI.tty_ify(note), limit - 6,\n-                                          initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n+                text.append(_wrap_text(note, limit - 6,\n+                                       initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n             text.append('')\n             text.append('')\n             del doc['notes']\n@@ -653,25 +685,25 @@ class DocCLI(CLI):\n             text.append(\"SEE ALSO:\")\n             for item in doc['seealso']:\n                 if 'module' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Module %s' % item['module']),\n+                    text.append(_wrap_text('Module %s' % item['module'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n                     description = item.get('description', 'The official documentation on the %s module.' % item['module'])\n-                    text.append(textwrap.fill(DocCLI.tty_ify(description), limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('modules/%s_module.html' % item['module'])),\n+                    text.append(_wrap_text(description, limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n+                    text.append(_wrap_text(get_versioned_doclink('modules/%s_module.html' % item['module']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent))\n                 elif 'name' in item and 'link' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['name']),\n+                    text.append(_wrap_text(item['name'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(_wrap_text(item['description'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['link']),\n+                    text.append(_wrap_text(item['link'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n                 elif 'ref' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Ansible documentation [%s]' % item['ref']),\n+                    text.append(_wrap_text('Ansible documentation [%s]' % item['ref'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(_wrap_text(item['description'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('/#stq=%s&stp=1' % item['ref'])),\n+                    text.append(_wrap_text(get_versioned_doclink('/#stq=%s&stp=1' % item['ref']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n \n             text.append('')\n@@ -680,16 +712,16 @@ class DocCLI(CLI):\n \n         if doc.get('requirements', False):\n             req = \", \".join(doc.pop('requirements'))\n-            text.append(\"REQUIREMENTS:%s\\n\" % textwrap.fill(DocCLI.tty_ify(req), limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n+            text.append(\"REQUIREMENTS:%s\\n\" % _wrap_text(req, limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n \n         # Generic handler\n         for k in sorted(doc):\n             if k in DocCLI.IGNORE or not doc[k]:\n                 continue\n             if isinstance(doc[k], string_types):\n-                text.append('%s: %s' % (k.upper(), textwrap.fill(DocCLI.tty_ify(doc[k]), limit - (len(k) + 2), subsequent_indent=opt_indent)))\n+                text.append('%s: %s' % (k.upper(), _wrap_text(doc[k], limit - (len(k) + 2), initial_indent='', subsequent_indent=opt_indent)))\n             elif isinstance(doc[k], (list, tuple)):\n-                text.append('%s: %s' % (k.upper(), ', '.join(doc[k])))\n+                text.append('%s: %s' % (k.upper(), ', '.join(_safe_tty_ify(x) for x in doc[k])))\n             else:\n                 # use empty indent since this affects the start of the yaml doc, not it's keys\n                 text.append(DocCLI._dump_yaml({k.upper(): doc[k]}, ''))\n@@ -700,9 +732,11 @@ class DocCLI(CLI):\n             text.append(\"EXAMPLES:\")\n             text.append('')\n             if isinstance(doc['plainexamples'], string_types):\n-                text.append(doc.pop('plainexamples').strip())\n+                ex = doc.pop('plainexamples').strip()\n+                text.append(_safe_tty_ify(ex))\n             else:\n-                text.append(yaml.dump(doc.pop('plainexamples'), indent=2, default_flow_style=False))\n+                dumped = yaml.dump(doc.pop('plainexamples'), indent=2, default_flow_style=False)\n+                text.append(_safe_tty_ify(dumped))\n             text.append('')\n             text.append('')\n \n@@ -710,4 +744,4 @@ class DocCLI(CLI):\n             text.append(\"RETURN VALUES:\")\n             DocCLI.add_fields(text, doc.pop('returndocs'), limit, opt_indent, return_values=True)\n \n-        return \"\\n\".join(text)\n+        return \"\\n\".join(text)\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "lib/ansible/cli/doc.py": [
                    "function: DocCLI.tty_ify"
                ],
                "lib/ansible/utils/plugin_docs.py": [
                    ""
                ],
                "lib/ansible/parsing/plugin_docs.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 3f3b306..508624a 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -603,6 +603,27 @@ class DocCLI(CLI):\n         pad = display.columns * 0.20\n         limit = max(display.columns - int(pad), 70)\n \n+        # Local macro renderer to transform supported tokens while leaving regular text unchanged\n+        def _fmt_macros(s):\n+            import re\n+            if not isinstance(s, string_types):\n+                return s\n+            # Preserve any tty formatting first\n+            s = DocCLI.tty_ify(s)\n+            # Render horizontal rule tokens\n+            s = s.replace('HORIZONTALLINE', '\\n-------------\\n')\n+            # Links: L(text,URL) -> text <URL>\n+            s = re.sub(r'\\bL\\(\\s*([^,()]*?)\\s*,\\s*([^)]+?)\\s*\\)', lambda m: '%s <%s>' % (m.group(1), m.group(2)), s)\n+            # References: R(text,ref) -> text\n+            s = re.sub(r'\\bR\\(\\s*([^,()]*?)\\s*,\\s*([^)]+?)\\s*\\)', lambda m: '%s' % (m.group(1)), s)\n+            # Monospace/code: C(value) -> `value'\n+            s = re.sub(r'\\bC\\(\\s*([^)]+?)\\s*\\)', lambda m: '`%s\\'' % m.group(1), s)\n+            # Bold: B(text) -> *text*\n+            s = re.sub(r'\\bB\\(\\s*([^)]+?)\\s*\\)', lambda m: '*%s*' % m.group(1), s)\n+            # Macro name: M(name) -> [name]\n+            s = re.sub(r'\\bM\\(\\s*([^)]+?)\\s*\\)', lambda m: '[%s]' % m.group(1), s)\n+            return s\n+\n         plugin_name = doc.get(context.CLIARGS['type'], doc.get('plugin_type'))\n         if collection_name:\n             plugin_name = '%s.%s' % (collection_name, plugin_name)\n@@ -614,7 +635,7 @@ class DocCLI(CLI):\n         else:\n             desc = doc.pop('description')\n \n-        text.append(\"%s\\n\" % textwrap.fill(DocCLI.tty_ify(desc), limit, initial_indent=opt_indent,\n+        text.append(\"%s\\n\" % textwrap.fill(_fmt_macros(desc), limit, initial_indent=opt_indent,\n                                            subsequent_indent=opt_indent))\n \n         if doc.get('deprecated', False):\n@@ -643,7 +664,7 @@ class DocCLI(CLI):\n         if doc.get('notes', False):\n             text.append(\"NOTES:\")\n             for note in doc['notes']:\n-                text.append(textwrap.fill(DocCLI.tty_ify(note), limit - 6,\n+                text.append(textwrap.fill(_fmt_macros(note), limit - 6,\n                                           initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n             text.append('')\n             text.append('')\n@@ -653,25 +674,25 @@ class DocCLI(CLI):\n             text.append(\"SEE ALSO:\")\n             for item in doc['seealso']:\n                 if 'module' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Module %s' % item['module']),\n+                    text.append(textwrap.fill(_fmt_macros('Module %s' % item['module']),\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n                     description = item.get('description', 'The official documentation on the %s module.' % item['module'])\n-                    text.append(textwrap.fill(DocCLI.tty_ify(description), limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('modules/%s_module.html' % item['module'])),\n+                    text.append(textwrap.fill(_fmt_macros(description), limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n+                    text.append(textwrap.fill(_fmt_macros(get_versioned_doclink('modules/%s_module.html' % item['module'])),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent))\n                 elif 'name' in item and 'link' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['name']),\n+                    text.append(textwrap.fill(_fmt_macros(item['name']),\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(textwrap.fill(_fmt_macros(item['description']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['link']),\n+                    text.append(textwrap.fill(_fmt_macros(item['link']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n                 elif 'ref' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Ansible documentation [%s]' % item['ref']),\n+                    text.append(textwrap.fill(_fmt_macros('Ansible documentation [%s]' % item['ref']),\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(textwrap.fill(_fmt_macros(item['description']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('/#stq=%s&stp=1' % item['ref'])),\n+                    text.append(textwrap.fill(_fmt_macros(get_versioned_doclink('/#stq=%s&stp=1' % item['ref'])),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n \n             text.append('')\n@@ -680,14 +701,14 @@ class DocCLI(CLI):\n \n         if doc.get('requirements', False):\n             req = \", \".join(doc.pop('requirements'))\n-            text.append(\"REQUIREMENTS:%s\\n\" % textwrap.fill(DocCLI.tty_ify(req), limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n+            text.append(\"REQUIREMENTS:%s\\n\" % textwrap.fill(_fmt_macros(req), limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n \n         # Generic handler\n         for k in sorted(doc):\n             if k in DocCLI.IGNORE or not doc[k]:\n                 continue\n             if isinstance(doc[k], string_types):\n-                text.append('%s: %s' % (k.upper(), textwrap.fill(DocCLI.tty_ify(doc[k]), limit - (len(k) + 2), subsequent_indent=opt_indent)))\n+                text.append('%s: %s' % (k.upper(), textwrap.fill(_fmt_macros(doc[k]), limit - (len(k) + 2), subsequent_indent=opt_indent)))\n             elif isinstance(doc[k], (list, tuple)):\n                 text.append('%s: %s' % (k.upper(), ', '.join(doc[k])))\n             else:\n@@ -710,4 +731,4 @@ class DocCLI(CLI):\n             text.append(\"RETURN VALUES:\")\n             DocCLI.add_fields(text, doc.pop('returndocs'), limit, opt_indent, return_values=True)\n \n-        return \"\\n\".join(text)\n+        return \"\\n\".join(text)\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 3f3b306..9939235 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -603,6 +603,39 @@ class DocCLI(CLI):\n         pad = display.columns * 0.20\n         limit = max(display.columns - int(pad), 70)\n \n+        # Helper functions to safely render macros without corrupting normal text\n+        def _has_macros(s):\n+            if not isinstance(s, string_types):\n+                return False\n+            if 'HORIZONTALLINE' in s:\n+                return True\n+            for tok in ('L(', 'R(', 'M(', 'B(', 'C('):\n+                if tok in s:\n+                    return True\n+            return False\n+\n+        def _safe_tty_ify(s):\n+            if isinstance(s, string_types) and _has_macros(s):\n+                return DocCLI.tty_ify(s)\n+            return s\n+\n+        def _wrap_text(s, width, initial_indent='', subsequent_indent=''):\n+            # Apply safe macro rendering and preserve horizontal rules\n+            s = _safe_tty_ify(s)\n+            if not isinstance(s, string_types):\n+                s = to_text(s) if 'to_text' in globals() else str(s)\n+            if '-------------' in s:\n+                parts = s.split('\\n-------------\\n')\n+                out_lines = []\n+                for idx, part in enumerate(parts):\n+                    if part:\n+                        out_lines.append(textwrap.fill(part, width, initial_indent=initial_indent, subsequent_indent=subsequent_indent))\n+                    if idx != len(parts) - 1:\n+                        # Insert the horizontal rule on its own line with no indentation\n+                        out_lines.append('-------------')\n+                return \"\\n\".join(out_lines)\n+            return textwrap.fill(s, width, initial_indent=initial_indent, subsequent_indent=subsequent_indent)\n+\n         plugin_name = doc.get(context.CLIARGS['type'], doc.get('plugin_type'))\n         if collection_name:\n             plugin_name = '%s.%s' % (collection_name, plugin_name)\n@@ -614,8 +647,7 @@ class DocCLI(CLI):\n         else:\n             desc = doc.pop('description')\n \n-        text.append(\"%s\\n\" % textwrap.fill(DocCLI.tty_ify(desc), limit, initial_indent=opt_indent,\n-                                           subsequent_indent=opt_indent))\n+        text.append(\"%s\\n\" % _wrap_text(desc, limit, initial_indent=opt_indent, subsequent_indent=opt_indent))\n \n         if doc.get('deprecated', False):\n             text.append(\"DEPRECATED: \\n\")\n@@ -643,8 +675,8 @@ class DocCLI(CLI):\n         if doc.get('notes', False):\n             text.append(\"NOTES:\")\n             for note in doc['notes']:\n-                text.append(textwrap.fill(DocCLI.tty_ify(note), limit - 6,\n-                                          initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n+                text.append(_wrap_text(note, limit - 6,\n+                                       initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n             text.append('')\n             text.append('')\n             del doc['notes']\n@@ -653,25 +685,25 @@ class DocCLI(CLI):\n             text.append(\"SEE ALSO:\")\n             for item in doc['seealso']:\n                 if 'module' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Module %s' % item['module']),\n+                    text.append(_wrap_text('Module %s' % item['module'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n                     description = item.get('description', 'The official documentation on the %s module.' % item['module'])\n-                    text.append(textwrap.fill(DocCLI.tty_ify(description), limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('modules/%s_module.html' % item['module'])),\n+                    text.append(_wrap_text(description, limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n+                    text.append(_wrap_text(get_versioned_doclink('modules/%s_module.html' % item['module']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent))\n                 elif 'name' in item and 'link' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['name']),\n+                    text.append(_wrap_text(item['name'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(_wrap_text(item['description'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['link']),\n+                    text.append(_wrap_text(item['link'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n                 elif 'ref' in item and 'description' in item:\n-                    text.append(textwrap.fill(DocCLI.tty_ify('Ansible documentation [%s]' % item['ref']),\n+                    text.append(_wrap_text('Ansible documentation [%s]' % item['ref'],\n                                 limit - 6, initial_indent=opt_indent[:-2] + \"* \", subsequent_indent=opt_indent))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(item['description']),\n+                    text.append(_wrap_text(item['description'],\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n-                    text.append(textwrap.fill(DocCLI.tty_ify(get_versioned_doclink('/#stq=%s&stp=1' % item['ref'])),\n+                    text.append(_wrap_text(get_versioned_doclink('/#stq=%s&stp=1' % item['ref']),\n                                 limit - 6, initial_indent=opt_indent + '   ', subsequent_indent=opt_indent + '   '))\n \n             text.append('')\n@@ -680,16 +712,16 @@ class DocCLI(CLI):\n \n         if doc.get('requirements', False):\n             req = \", \".join(doc.pop('requirements'))\n-            text.append(\"REQUIREMENTS:%s\\n\" % textwrap.fill(DocCLI.tty_ify(req), limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n+            text.append(\"REQUIREMENTS:%s\\n\" % _wrap_text(req, limit - 16, initial_indent=\"  \", subsequent_indent=opt_indent))\n \n         # Generic handler\n         for k in sorted(doc):\n             if k in DocCLI.IGNORE or not doc[k]:\n                 continue\n             if isinstance(doc[k], string_types):\n-                text.append('%s: %s' % (k.upper(), textwrap.fill(DocCLI.tty_ify(doc[k]), limit - (len(k) + 2), subsequent_indent=opt_indent)))\n+                text.append('%s: %s' % (k.upper(), _wrap_text(doc[k], limit - (len(k) + 2), initial_indent='', subsequent_indent=opt_indent)))\n             elif isinstance(doc[k], (list, tuple)):\n-                text.append('%s: %s' % (k.upper(), ', '.join(doc[k])))\n+                text.append('%s: %s' % (k.upper(), ', '.join(_safe_tty_ify(x) for x in doc[k])))\n             else:\n                 # use empty indent since this affects the start of the yaml doc, not it's keys\n                 text.append(DocCLI._dump_yaml({k.upper(): doc[k]}, ''))\n@@ -700,9 +732,11 @@ class DocCLI(CLI):\n             text.append(\"EXAMPLES:\")\n             text.append('')\n             if isinstance(doc['plainexamples'], string_types):\n-                text.append(doc.pop('plainexamples').strip())\n+                ex = doc.pop('plainexamples').strip()\n+                text.append(_safe_tty_ify(ex))\n             else:\n-                text.append(yaml.dump(doc.pop('plainexamples'), indent=2, default_flow_style=False))\n+                dumped = yaml.dump(doc.pop('plainexamples'), indent=2, default_flow_style=False)\n+                text.append(_safe_tty_ify(dumped))\n             text.append('')\n             text.append('')\n \n@@ -710,4 +744,4 @@ class DocCLI(CLI):\n             text.append(\"RETURN VALUES:\")\n             DocCLI.add_fields(text, doc.pop('returndocs'), limit, opt_indent, return_values=True)\n \n-        return \"\\n\".join(text)\n+        return \"\\n\".join(text)\n"
}