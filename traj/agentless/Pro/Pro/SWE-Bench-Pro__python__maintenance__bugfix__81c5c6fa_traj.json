{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__81c5c6fa",
    "original_id": "instance_internetarchive__openlibrary-757fcf46c70530739c150c57b37d6375f155dc97-ve8c8d62a2b60610a3c4631f5f23ed866bada9818",
    "1_model_selected_files": [
        "openlibrary/plugins/importapi/import_edition_builder.py"
    ],
    "2_embedding_selected_files": [
        "openlibrary/catalog/merge/merge_marc.py",
        "openlibrary/catalog/add_book/__init__.py",
        "openlibrary/catalog/marc/parse.py",
        "openlibrary/catalog/merge/merge.py",
        "openlibrary/catalog/utils/__init__.py",
        "openlibrary/catalog/utils/edit.py",
        "openlibrary/views/showmarc.py",
        "openlibrary/catalog/merge/names.py",
        "scripts/lc_marc_update.py",
        "openlibrary/catalog/marc/__init__.py",
        "openlibrary/catalog/merge/__init__.py",
        "openlibrary/catalog/add_book/match.py",
        "openlibrary/catalog/merge/normalize.py",
        "openlibrary/catalog/marc/marc_base.py",
        "openlibrary/catalog/marc/html.py",
        "scripts/oclc_to_marc.py",
        "openlibrary/records/functions.py",
        "openlibrary/catalog/marc/marc_xml.py",
        "openlibrary/catalog/get_ia.py",
        "openlibrary/catalog/marc/get_subjects.py",
        "openlibrary/utils/lccn.py",
        "openlibrary/plugins/upstream/merge_authors.py",
        "openlibrary/plugins/importapi/code.py",
        "openlibrary/plugins/upstream/code.py",
        "openlibrary/records/__init__.py",
        "openlibrary/core/vendors.py",
        "openlibrary/catalog/marc/marc_binary.py",
        "openlibrary/plugins/upstream/models.py",
        "openlibrary/catalog/marc/mnemonics.py",
        "openlibrary/records/matchers.py",
        "openlibrary/solr/update_work.py",
        "openlibrary/coverstore/archive.py",
        "openlibrary/solr/update_edition.py",
        "openlibrary/plugins/upstream/addbook.py",
        "openlibrary/plugins/upstream/utils.py",
        "openlibrary/catalog/__init__.py",
        "openlibrary/catalog/add_book/load_book.py",
        "openlibrary/core/__init__.py",
        "openlibrary/utils/lcc.py",
        "scripts/affiliate_server.py",
        "openlibrary/core/lending.py",
        "openlibrary/solr/read_dump.py",
        "openlibrary/plugins/upstream/account.py",
        "openlibrary/utils/bulkimport.py",
        "scripts/partner_batch_imports.py",
        "openlibrary/plugins/importapi/metaxml_to_json.py",
        "openlibrary/utils/ddc.py"
    ],
    "3_final_combined_files": [
        "openlibrary/plugins/importapi/import_edition_builder.py",
        "openlibrary/catalog/merge/merge_marc.py",
        "openlibrary/catalog/add_book/__init__.py",
        "openlibrary/catalog/marc/parse.py"
    ],
    "4_related_elements": {
        "openlibrary/catalog/merge/merge_marc.py": [
            "function: build_marc\nfunction: build_titles\nvariable: re_amazon_title_paren\nfunction: compare_title\nfunction: attempt_merge\nfunction: editions_match"
        ],
        "openlibrary/catalog/add_book/__init__.py": [
            "variable: ISBD_UNIT_PUNCT\nfunction: get_title\nfunction: split_subtitle\nfunction: normalize_record_bibids\nfunction: isbns_from_record\nfunction: build_pool\nfunction: find_quick_match\nfunction: editions_matched\nfunction: find_exact_match\nfunction: find_enriched_match\nfunction: find_match\nfunction: load_data\nfunction: load\nfunction: update_edition_with_rec_data\nfunction: update_work_with_rec_data"
        ],
        "openlibrary/plugins/importapi/import_edition_builder.py": [
            "class: import_edition_builder"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "openlibrary/catalog/merge/merge_marc.py": [
                    "function: build_marc\nfunction: build_titles"
                ],
                "openlibrary/catalog/add_book/__init__.py": [
                    "function: find_enriched_match\nline: 53"
                ],
                "openlibrary/plugins/importapi/import_edition_builder.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/openlibrary/catalog/add_book/__init__.py b/openlibrary/catalog/add_book/__init__.py\nindex 79debd5..88a5cf4 100644\n--- a/openlibrary/catalog/add_book/__init__.py\n+++ b/openlibrary/catalog/add_book/__init__.py\n@@ -51,6 +51,7 @@ from openlibrary.catalog.add_book.load_book import (\n     InvalidLanguage,\n )\n from openlibrary.catalog.add_book.match import editions_match\n+from openlibrary.catalog.utils import expand_record\n \n if TYPE_CHECKING:\n     from openlibrary.core.models import Edition, Work\n@@ -532,7 +533,7 @@ def find_enriched_match(rec, edition_pool):\n     :rtype: str|None\n     :return: None or the edition key '/books/OL...M' of the best edition match for enriched_rec in edition_pool\n     \"\"\"\n-    enriched_rec = build_marc(rec)\n+    enriched_rec = expand_record(rec)\n     add_db_name(enriched_rec)\n \n     seen = set()\n",
                "diff --git a/openlibrary/catalog/add_book/__init__.py b/openlibrary/catalog/add_book/__init__.py\nindex 79debd5..1cb5f68 100644\n--- a/openlibrary/catalog/add_book/__init__.py\n+++ b/openlibrary/catalog/add_book/__init__.py\n@@ -51,6 +51,7 @@ from openlibrary.catalog.add_book.load_book import (\n     InvalidLanguage,\n )\n from openlibrary.catalog.add_book.match import editions_match\n+from openlibrary.catalog.utils import expand_record\n \n if TYPE_CHECKING:\n     from openlibrary.core.models import Edition, Work\n@@ -532,7 +533,7 @@ def find_enriched_match(rec, edition_pool):\n     :rtype: str|None\n     :return: None or the edition key '/books/OL...M' of the best edition match for enriched_rec in edition_pool\n     \"\"\"\n-    enriched_rec = build_marc(rec)\n+    enriched_rec = expand_record(rec)\n     add_db_name(enriched_rec)\n \n     seen = set()\n@@ -728,7 +729,7 @@ def find_match(rec, edition_pool) -> str | None:\n \n     if not match:\n         # Add 'full_title' to the rec by conjoining 'title' and 'subtitle'.\n-        # build_marc() uses this for matching.\n+        # expand_record() uses this for matching.\n         rec['full_title'] = rec['title']\n         if subtitle := rec.get('subtitle'):\n             rec['full_title'] += ' ' + subtitle\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "openlibrary/catalog/merge/merge_marc.py": [
                    "line: 17\nline: 53\nline: 311\nline: 343"
                ],
                "openlibrary/catalog/add_book/__init__.py": [
                    "line: 55\nline: 535\nline: 730\nline: 735"
                ],
                "openlibrary/plugins/importapi/import_edition_builder.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/openlibrary/catalog/add_book/__init__.py b/openlibrary/catalog/add_book/__init__.py\nindex 79debd5..d8311fe 100644\n--- a/openlibrary/catalog/add_book/__init__.py\n+++ b/openlibrary/catalog/add_book/__init__.py\n@@ -43,6 +43,7 @@ from openlibrary.plugins.upstream.utils import strip_accents\n from openlibrary.utils import uniq, dicthash\n from openlibrary.utils.isbn import normalize_isbn\n from openlibrary.utils.lccn import normalize_lccn\n+from openlibrary.catalog.utils import expand_record\n \n from openlibrary.catalog.add_book.load_book import (\n     build_query,\n@@ -532,7 +533,7 @@ def find_enriched_match(rec, edition_pool):\n     :rtype: str|None\n     :return: None or the edition key '/books/OL...M' of the best edition match for enriched_rec in edition_pool\n     \"\"\"\n-    enriched_rec = build_marc(rec)\n+    enriched_rec = expand_record(rec)\n     add_db_name(enriched_rec)\n \n     seen = set()\ndiff --git a/openlibrary/catalog/merge/merge_marc.py b/openlibrary/catalog/merge/merge_marc.py\nindex 6757e30..c12c93b 100644\n--- a/openlibrary/catalog/merge/merge_marc.py\n+++ b/openlibrary/catalog/merge/merge_marc.py\n@@ -308,12 +308,10 @@ def compare_publisher(e1, e2):\n         return ('publisher', 'either missing', 0)\n \n \n-def build_marc(edition):\n+def expand_record(edition):\n     \"\"\"\n     Returns an expanded representation of an edition dict,\n-    usable for accurate comparisons between existing and new\n-    records.\n-    Called from openlibrary.catalog.add_book.load()\n+    usable for accurate comparisons between existing and new records.\n \n     :param dict edition: Import edition representation, requires 'full_title'\n     :rtype: dict\n@@ -321,26 +319,21 @@ def build_marc(edition):\n         more titles, normalized + short\n         all isbns in \"isbn\": []\n     \"\"\"\n-    marc = build_titles(edition['full_title'])\n-    marc['isbn'] = []\n+    record = build_titles(edition['full_title'])\n+    record['isbn'] = []\n     for f in 'isbn', 'isbn_10', 'isbn_13':\n-        marc['isbn'].extend(edition.get(f, []))\n-    if 'publish_country' in edition and edition['publish_country'] not in (\n-        '   ',\n-        '|||',\n-    ):\n-        marc['publish_country'] = edition['publish_country']\n-    for f in (\n-        'lccn',\n-        'publishers',\n-        'publish_date',\n-        'number_of_pages',\n-        'authors',\n-        'contribs',\n-    ):\n+        record['isbn'].extend(edition.get(f, []))\n+    if 'publish_country' in edition and edition['publish_country'] not in ('   ', '|||'):\n+        record['publish_country'] = edition['publish_country']\n+    for f in ('lccn', 'publishers', 'publish_date', 'number_of_pages', 'authors', 'contribs'):\n         if f in edition:\n-            marc[f] = edition[f]\n-    return marc\n+            record[f] = edition[f]\n+    return record\n+\n+\n+def build_marc(edition):\n+    \"\"\"Deprecated: use expand_record(edition) instead.\"\"\"\n+    return expand_record(edition)\n \n \n def attempt_merge(e1, e2, threshold, debug=False):\n",
                "diff --git a/openlibrary/catalog/add_book/__init__.py b/openlibrary/catalog/add_book/__init__.py\nindex 79debd5..f08e428 100644\n--- a/openlibrary/catalog/add_book/__init__.py\n+++ b/openlibrary/catalog/add_book/__init__.py\n@@ -51,6 +51,7 @@ from openlibrary.catalog.add_book.load_book import (\n     InvalidLanguage,\n )\n from openlibrary.catalog.add_book.match import editions_match\n+from openlibrary.catalog.merge.merge_marc import expand_record\n \n if TYPE_CHECKING:\n     from openlibrary.core.models import Edition, Work\n@@ -532,7 +533,7 @@ def find_enriched_match(rec, edition_pool):\n     :rtype: str|None\n     :return: None or the edition key '/books/OL...M' of the best edition match for enriched_rec in edition_pool\n     \"\"\"\n-    enriched_rec = build_marc(rec)\n+    enriched_rec = expand_record(rec)\n     add_db_name(enriched_rec)\n \n     seen = set()\n@@ -728,7 +729,7 @@ def find_match(rec, edition_pool) -> str | None:\n \n     if not match:\n         # Add 'full_title' to the rec by conjoining 'title' and 'subtitle'.\n-        # build_marc() uses this for matching.\n+        # expand_record() uses this for matching.\n         rec['full_title'] = rec['title']\n         if subtitle := rec.get('subtitle'):\n             rec['full_title'] += ' ' + subtitle\ndiff --git a/openlibrary/catalog/merge/merge_marc.py b/openlibrary/catalog/merge/merge_marc.py\nindex 6757e30..eeb1908 100644\n--- a/openlibrary/catalog/merge/merge_marc.py\n+++ b/openlibrary/catalog/merge/merge_marc.py\n@@ -308,7 +308,7 @@ def compare_publisher(e1, e2):\n         return ('publisher', 'either missing', 0)\n \n \n-def build_marc(edition):\n+def expand_record(edition):\n     \"\"\"\n     Returns an expanded representation of an edition dict,\n     usable for accurate comparisons between existing and new\n@@ -343,6 +343,11 @@ def build_marc(edition):\n     return marc\n \n \n+def build_marc(edition):\n+    \"\"\"Deprecated alias for backward compatibility. Use expand_record() instead.\"\"\"\n+    return expand_record(edition)\n+\n+\n def attempt_merge(e1, e2, threshold, debug=False):\n     \"\"\"Renaming for clarity, use editions_match() instead.\"\"\"\n     return editions_match(e1, e2, threshold, debug=False)\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/openlibrary/catalog/add_book/__init__.py b/openlibrary/catalog/add_book/__init__.py\nindex 79debd5..88a5cf4 100644\n--- a/openlibrary/catalog/add_book/__init__.py\n+++ b/openlibrary/catalog/add_book/__init__.py\n@@ -51,6 +51,7 @@ from openlibrary.catalog.add_book.load_book import (\n     InvalidLanguage,\n )\n from openlibrary.catalog.add_book.match import editions_match\n+from openlibrary.catalog.utils import expand_record\n \n if TYPE_CHECKING:\n     from openlibrary.core.models import Edition, Work\n@@ -532,7 +533,7 @@ def find_enriched_match(rec, edition_pool):\n     :rtype: str|None\n     :return: None or the edition key '/books/OL...M' of the best edition match for enriched_rec in edition_pool\n     \"\"\"\n-    enriched_rec = build_marc(rec)\n+    enriched_rec = expand_record(rec)\n     add_db_name(enriched_rec)\n \n     seen = set()\n"
}