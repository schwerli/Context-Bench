{
    "instance_id": "SWE-Bench-Pro__go__maintenance__bugfix__6efcf999",
    "original_id": "instance_flipt-io__flipt-3d5a345f94c2adc8a0eaa102c189c08ad4c0f8e8",
    "1_model_selected_files": [
        "internal/tracing/tracing.go"
    ],
    "2_embedding_selected_files": [
        "internal/config/tracing.go",
        "examples/openfeature/main.go",
        "internal/tracing/tracing.go",
        "internal/tracing/tracing_test.go",
        "internal/metrics/metrics.go",
        "cmd/flipt/main.go",
        "internal/telemetry/telemetry_test.go",
        "internal/config/audit.go",
        "internal/ext/exporter_test.go",
        "internal/server/analytics/sink_test.go",
        "rpc/flipt/flipt.pb.gw.go",
        "internal/ext/importer_test.go",
        "rpc/flipt/flipt.go",
        "rpc/flipt/flipt.pb.go",
        "internal/server/otel/noop_provider.go",
        "internal/config/log.go",
        "internal/config/diagnostics.go",
        "internal/server/otel/noop_exporter.go",
        "internal/cache/metrics.go",
        "internal/telemetry/telemetry.go",
        "internal/config/config_test.go",
        "internal/cmd/protoc-gen-go-flipt-sdk/main.go",
        "rpc/flipt/flipt_grpc.pb.go"
    ],
    "3_final_combined_files": [
        "internal/tracing/tracing.go",
        "internal/config/tracing.go",
        "examples/openfeature/main.go"
    ],
    "4_related_elements": {
        "internal/tracing/tracing.go": [
            "function: NewProvider\nfunction: GetExporter\nvariable: traceExpOnce\nvariable: traceExp\nvariable: traceExpFunc\nvariable: traceExpErr"
        ],
        "internal/config/tracing.go": [
            "class: TracingConfig\nfunction: TracingConfig.setDefaults\nfunction: TracingConfig.deprecations"
        ],
        "examples/openfeature/main.go": [
            "function: tracerProvider\nfunction: main"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "internal/tracing/tracing.go": [
                    "function: NewProvider\nline: 40"
                ],
                "internal/config/tracing.go": [
                    "line: 14\nfunction: TracingConfig.setDefaults\nfunction: TracingConfig.Validate"
                ],
                "examples/openfeature/main.go": [
                    "function: tracerProvider\nline: 74\nline: 100"
                ]
            },
            "patches": [
                "diff --git a/examples/openfeature/main.go b/examples/openfeature/main.go\nindex 7f99d1f..bd6ca40 100644\n--- a/examples/openfeature/main.go\n+++ b/examples/openfeature/main.go\n@@ -97,7 +97,10 @@ func main() {\n \t// register our TracerProvider as the global so any imported\n \t// instrumentation in the future will default to using it.\n \totel.SetTracerProvider(tp)\n-\totel.SetTextMapPropagator(propagation.TraceContext{})\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(\n+\t\tpropagation.TraceContext{},\n+\t\tpropagation.Baggage{},\n+\t))\n \n \t// add the opentelemetry hook\n \topenfeature.AddHooks(otelHook.NewTracesHook())\ndiff --git a/internal/config/tracing.go b/internal/config/tracing.go\nindex 31efac9..b2068df 100644\n--- a/internal/config/tracing.go\n+++ b/internal/config/tracing.go\n@@ -12,16 +12,20 @@ var _ defaulter = (*TracingConfig)(nil)\n // TracingConfig contains fields, which configure tracing telemetry\n // output destinations.\n type TracingConfig struct {\n-\tEnabled  bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n-\tExporter TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n-\tJaeger   JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n-\tZipkin   ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n-\tOTLP     OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tEnabled     bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n+\tExporter    TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n+\tJaeger      JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n+\tZipkin      ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n+\tOTLP        OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tSampleRatio float64             `json:\"sample_ratio,omitempty\" mapstructure:\"sample_ratio\" yaml:\"sample_ratio,omitempty\"`\n+\tPropagators []string            `json:\"propagators,omitempty\" mapstructure:\"propagators\" yaml:\"propagators,omitempty\"`\n }\n \n func (c *TracingConfig) setDefaults(v *viper.Viper) error {\n \tv.SetDefault(\"tracing\", map[string]any{\n-\t\t\"enabled\":  false,\n+\t\t\"enabled\":       false,\n+\t\t\"sample_ratio\":  1.0,\n+\t\t\"propagators\":   []string{\"tracecontext\", \"baggage\"},\n \t\t\"exporter\": TracingJaeger,\n \t\t\"jaeger\": map[string]any{\n \t\t\t\"host\": \"localhost\",\ndiff --git a/internal/tracing/tracing.go b/internal/tracing/tracing.go\nindex e0e1f0c..0e039f6 100644\n--- a/internal/tracing/tracing.go\n+++ b/internal/tracing/tracing.go\n@@ -29,15 +29,73 @@ func newResource(ctx context.Context, fliptVersion string) (*resource.Resource,\n \t)\n }\n \n+import (\n+\t\"context\"\n+\t\"fmt\"\n+\t\"os\"\n+\t\"strconv\"\n+\t\"strings\"\n+\t\"sync\"\n+\n+\t\"go.opentelemetry.io/otel\"\n+\t\"go.opentelemetry.io/otel/propagation\"\n+\t\"go.opentelemetry.io/otel/sdk/resource\"\n+\ttracesdk \"go.opentelemetry.io/otel/sdk/trace\"\n+\tsemconv \"go.opentelemetry.io/otel/semconv/v1.17.0\"\n+)\n+\n // NewProvider creates a new TracerProvider configured for Flipt tracing.\n func NewProvider(ctx context.Context, fliptVersion string) (*tracesdk.TracerProvider, error) {\n \ttraceResource, err := newResource(ctx, fliptVersion)\n \tif err != nil {\n \t\treturn nil, err\n \t}\n+\n+\t// Determine sampling ratio from environment. Default is 1.0 (always on).\n+\tratioStr := strings.TrimSpace(os.Getenv(\"FLIPT_TRACING_SAMPLING_RATIO\"))\n+\tvar sampler tracesdk.Sampler\n+\tif ratioStr == \"\" {\n+\t\tsampler = tracesdk.AlwaysSample()\n+\t} else {\n+\t\tr, parseErr := strconv.ParseFloat(ratioStr, 64)\n+\t\tif parseErr != nil {\n+\t\t\treturn nil, fmt.Errorf(\"invalid FLIPT_TRACING_SAMPLING_RATIO %q: %w\", ratioStr, parseErr)\n+\t\t}\n+\t\tif r < 0 || r > 1 {\n+\t\t\treturn nil, fmt.Errorf(\"invalid FLIPT_TRACING_SAMPLING_RATIO %q: must be between 0 and 1\", ratioStr)\n+\t\t}\n+\t\tswitch {\n+\t\tcase r == 0:\n+\t\t\tsampler = tracesdk.NeverSample()\n+\t\tcase r == 1:\n+\t\t\tsampler = tracesdk.AlwaysSample()\n+\t\tdefault:\n+\t\t\tsampler = tracesdk.ParentBased(tracesdk.TraceIDRatioBased(r))\n+\t\t}\n+\t}\n+\n+\t// Configure propagators from environment. Default is tracecontext,baggage.\n+\tpropsStr := strings.TrimSpace(os.Getenv(\"FLIPT_TRACING_PROPAGATORS\"))\n+\tvar propagators []propagation.TextMapPropagator\n+\tif propsStr == \"\" {\n+\t\tpropagators = []propagation.TextMapPropagator{propagation.TraceContext{}, propagation.Baggage{}}\n+\t} else {\n+\t\tfor _, p := range strings.Split(propsStr, \",\") {\n+\t\t\tswitch strings.ToLower(strings.TrimSpace(p)) {\n+\t\t\tcase \"tracecontext\":\n+\t\t\t\tpropagators = append(propagators, propagation.TraceContext{})\n+\t\t\tcase \"baggage\":\n+\t\t\t\tpropagators = append(propagators, propagation.Baggage{})\n+\t\t\tdefault:\n+\t\t\t\treturn nil, fmt.Errorf(\"unsupported propagator %q in FLIPT_TRACING_PROPAGATORS\", p)\n+\t\t\t}\n+\t\t}\n+\t}\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagators...))\n+\n \treturn tracesdk.NewTracerProvider(\n \t\ttracesdk.WithResource(traceResource),\n-\t\ttracesdk.WithSampler(tracesdk.AlwaysSample()),\n+\t\ttracesdk.WithSampler(sampler),\n \t), nil\n }\n \n",
                "diff --git a/internal/config/tracing.go b/internal/config/tracing.go\nindex 31efac9..f75a3a1 100644\n--- a/internal/config/tracing.go\n+++ b/internal/config/tracing.go\n@@ -12,17 +12,21 @@ var _ defaulter = (*TracingConfig)(nil)\n // TracingConfig contains fields, which configure tracing telemetry\n // output destinations.\n type TracingConfig struct {\n-\tEnabled  bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n-\tExporter TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n-\tJaeger   JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n-\tZipkin   ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n-\tOTLP     OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tEnabled       bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n+\tExporter      TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n+\tSamplingRatio float64             `json:\"sampling_ratio\" mapstructure:\"sampling_ratio\" yaml:\"sampling_ratio\"`\n+\tPropagators   []string            `json:\"propagators,omitempty\" mapstructure:\"propagators\" yaml:\"propagators,omitempty\"`\n+\tJaeger        JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n+\tZipkin        ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n+\tOTLP          OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n }\n \n func (c *TracingConfig) setDefaults(v *viper.Viper) error {\n \tv.SetDefault(\"tracing\", map[string]any{\n-\t\t\"enabled\":  false,\n-\t\t\"exporter\": TracingJaeger,\n+\t\t\"enabled\":        false,\n+\t\t\"exporter\":       TracingJaeger,\n+\t\t\"sampling_ratio\": 1.0,\n+\t\t\"propagators\":    []string{\"tracecontext\", \"baggage\"},\n \t\t\"jaeger\": map[string]any{\n \t\t\t\"host\": \"localhost\",\n \t\t\t\"port\": 6831,\ndiff --git a/internal/tracing/tracing.go b/internal/tracing/tracing.go\nindex e0e1f0c..74ce485 100644\n--- a/internal/tracing/tracing.go\n+++ b/internal/tracing/tracing.go\n@@ -29,15 +29,60 @@ func newResource(ctx context.Context, fliptVersion string) (*resource.Resource,\n \t)\n }\n \n+import (\n+\t\"fmt\"\n+\t\"strings\"\n+\n+\t\"github.com/spf13/viper\"\n+\t\"go.opentelemetry.io/otel\"\n+\t\"go.opentelemetry.io/otel/propagation\"\n+)\n+\n // NewProvider creates a new TracerProvider configured for Flipt tracing.\n func NewProvider(ctx context.Context, fliptVersion string) (*tracesdk.TracerProvider, error) {\n \ttraceResource, err := newResource(ctx, fliptVersion)\n \tif err != nil {\n \t\treturn nil, err\n \t}\n+\n+\t// Read sampling ratio from configuration and validate.\n+\tratio := viper.GetFloat64(\"tracing.sampling_ratio\")\n+\tif ratio < 0 || ratio > 1 {\n+\t\treturn nil, fmt.Errorf(\"invalid tracing.sampling_ratio %f: must be between 0 and 1 (inclusive)\", ratio)\n+\t}\n+\n+\tvar sampler tracesdk.Sampler\n+\tswitch {\n+\tcase ratio >= 1:\n+\t\tsampler = tracesdk.AlwaysSample()\n+\tcase ratio <= 0:\n+\t\tsampler = tracesdk.NeverSample()\n+\tdefault:\n+\t\tsampler = tracesdk.ParentBased(tracesdk.TraceIDRatioBased(ratio))\n+\t}\n+\n+\t// Configure context propagators based on configuration.\n+\tprops := viper.GetStringSlice(\"tracing.propagators\")\n+\tif len(props) == 0 {\n+\t\tprops = []string{\"tracecontext\", \"baggage\"}\n+\t}\n+\n+\tvar pList []propagation.TextMapPropagator\n+\tfor _, p := range props {\n+\t\tswitch strings.ToLower(strings.TrimSpace(p)) {\n+\t\tcase \"tracecontext\":\n+\t\t\tpList = append(pList, propagation.TraceContext{})\n+\t\tcase \"baggage\":\n+\t\t\tpList = append(pList, propagation.Baggage{})\n+\t\tdefault:\n+\t\t\treturn nil, fmt.Errorf(\"invalid tracing.propagators value %q: supported values are [tracecontext, baggage]\", p)\n+\t\t}\n+\t}\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(pList...))\n+\n \treturn tracesdk.NewTracerProvider(\n \t\ttracesdk.WithResource(traceResource),\n-\t\ttracesdk.WithSampler(tracesdk.AlwaysSample()),\n+\t\ttracesdk.WithSampler(sampler),\n \t), nil\n }\n \n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "internal/tracing/tracing.go": [
                    "function: NewProvider\nline: 40"
                ],
                "internal/config/tracing.go": [
                    "class: TracingConfig\nfunction: TracingConfig.setDefaults\nfunction: TracingConfig.Validate"
                ],
                "examples/openfeature/main.go": [
                    "function: tracerProvider\nfunction: main"
                ]
            },
            "patches": [
                "diff --git a/examples/openfeature/main.go b/examples/openfeature/main.go\nindex 7f99d1f..bd6ca40 100644\n--- a/examples/openfeature/main.go\n+++ b/examples/openfeature/main.go\n@@ -97,7 +97,10 @@ func main() {\n \t// register our TracerProvider as the global so any imported\n \t// instrumentation in the future will default to using it.\n \totel.SetTracerProvider(tp)\n-\totel.SetTextMapPropagator(propagation.TraceContext{})\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(\n+\t\tpropagation.TraceContext{},\n+\t\tpropagation.Baggage{},\n+\t))\n \n \t// add the opentelemetry hook\n \topenfeature.AddHooks(otelHook.NewTracesHook())\ndiff --git a/internal/config/tracing.go b/internal/config/tracing.go\nindex 31efac9..66e44b7 100644\n--- a/internal/config/tracing.go\n+++ b/internal/config/tracing.go\n@@ -9,19 +9,23 @@ import (\n // cheers up the unparam linter\n var _ defaulter = (*TracingConfig)(nil)\n \n-// TracingConfig contains fields, which configure tracing telemetry\n+ // TracingConfig contains fields, which configure tracing telemetry\n // output destinations.\n type TracingConfig struct {\n-\tEnabled  bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n-\tExporter TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n-\tJaeger   JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n-\tZipkin   ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n-\tOTLP     OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tEnabled        bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n+\tExporter       TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n+\tJaeger         JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n+\tZipkin         ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n+\tOTLP           OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tSamplingRatio  float64             `json:\"sampling_ratio,omitempty\" mapstructure:\"sampling_ratio\" yaml:\"sampling_ratio,omitempty\"`\n+\tPropagators    []string            `json:\"propagators,omitempty\" mapstructure:\"propagators\" yaml:\"propagators,omitempty\"`\n }\n \n func (c *TracingConfig) setDefaults(v *viper.Viper) error {\n \tv.SetDefault(\"tracing\", map[string]any{\n-\t\t\"enabled\":  false,\n+\t\t\"enabled\":         false,\n+\t\t\"sampling_ratio\":  1.0,\n+\t\t\"propagators\":     []string{\"tracecontext\", \"baggage\"},\n \t\t\"exporter\": TracingJaeger,\n \t\t\"jaeger\": map[string]any{\n \t\t\t\"host\": \"localhost\",\ndiff --git a/internal/tracing/tracing.go b/internal/tracing/tracing.go\nindex e0e1f0c..1d51c99 100644\n--- a/internal/tracing/tracing.go\n+++ b/internal/tracing/tracing.go\n@@ -29,15 +29,73 @@ func newResource(ctx context.Context, fliptVersion string) (*resource.Resource,\n \t)\n }\n \n-// NewProvider creates a new TracerProvider configured for Flipt tracing.\n+ // NewProvider creates a new TracerProvider configured for Flipt tracing.\n func NewProvider(ctx context.Context, fliptVersion string) (*tracesdk.TracerProvider, error) {\n \ttraceResource, err := newResource(ctx, fliptVersion)\n \tif err != nil {\n \t\treturn nil, err\n \t}\n+\n+\t// Determine sampling ratio from environment, default to 1.0 (always sample)\n+\t// Users can set FLIPT_TRACING_SAMPLING_RATIO to a value in [0.0, 1.0].\n+\tratio := 1.0\n+\tif v, ok := os.LookupEnv(\"FLIPT_TRACING_SAMPLING_RATIO\"); ok {\n+\t\tval := strings.TrimSpace(v)\n+\t\tr, perr := strconv.ParseFloat(val, 64)\n+\t\tif perr != nil {\n+\t\t\treturn nil, fmt.Errorf(\"invalid FLIPT_TRACING_SAMPLING_RATIO %q: %w\", v, perr)\n+\t\t}\n+\t\tif r < 0.0 || r > 1.0 {\n+\t\t\treturn nil, fmt.Errorf(\"FLIPT_TRACING_SAMPLING_RATIO must be between 0 and 1 inclusive, got %f\", r)\n+\t\t}\n+\t\tratio = r\n+\t}\n+\tsampler := tracesdk.ParentBased(tracesdk.TraceIDRatioBased(ratio))\n+\n+\t// Configure propagators from environment, default to tracecontext and baggage.\n+\t// Users can set FLIPT_TRACING_PROPAGATORS to a comma-separated list of:\n+\t// \"tracecontext\", \"baggage\", \"b3\", \"b3multi\", \"jaeger\".\n+\tpropagatorsEnv := os.Getenv(\"FLIPT_TRACING_PROPAGATORS\")\n+\tvar propagators []propagation.TextMapPropagator\n+\tif strings.TrimSpace(propagatorsEnv) == \"\" {\n+\t\tpropagators = []propagation.TextMapPropagator{\n+\t\t\tpropagation.TraceContext{},\n+\t\t\tpropagation.Baggage{},\n+\t\t}\n+\t} else {\n+\t\tsupported := map[string]struct{}{\n+\t\t\t\"tracecontext\": {},\n+\t\t\t\"baggage\":      {},\n+\t\t\t\"b3\":           {},\n+\t\t\t\"b3multi\":      {},\n+\t\t\t\"jaeger\":       {},\n+\t\t}\n+\t\tfor _, p := range strings.Split(propagatorsEnv, \",\") {\n+\t\t\tname := strings.ToLower(strings.TrimSpace(p))\n+\t\t\tif _, ok := supported[name]; !ok {\n+\t\t\t\treturn nil, fmt.Errorf(\"unsupported propagator %q. Supported: tracecontext, baggage, b3, b3multi, jaeger\", name)\n+\t\t\t}\n+\t\t\tswitch name {\n+\t\t\tcase \"tracecontext\":\n+\t\t\t\tpropagators = append(propagators, propagation.TraceContext{})\n+\t\t\tcase \"baggage\":\n+\t\t\t\tpropagators = append(propagators, propagation.Baggage{})\n+\t\t\tcase \"b3\":\n+\t\t\t\tpropagators = append(propagators, b3.New())\n+\t\t\tcase \"b3multi\":\n+\t\t\t\tpropagators = append(propagators, b3.New(b3.WithInjectEncoding(b3.B3MultipleHeader)))\n+\t\t\tcase \"jaeger\":\n+\t\t\t\tpropagators = append(propagators, jaeger.New())\n+\t\t\t}\n+\t\t}\n+\t}\n+\tif len(propagators) > 0 {\n+\t\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagators...))\n+\t}\n+\n \treturn tracesdk.NewTracerProvider(\n \t\ttracesdk.WithResource(traceResource),\n-\t\ttracesdk.WithSampler(tracesdk.AlwaysSample()),\n+\t\ttracesdk.WithSampler(sampler),\n \t), nil\n }\n \n",
                "diff --git a/examples/openfeature/main.go b/examples/openfeature/main.go\nindex 7f99d1f..6fd8414 100644\n--- a/examples/openfeature/main.go\n+++ b/examples/openfeature/main.go\n@@ -73,6 +73,8 @@ func tracerProvider(url string) (*tracesdk.TracerProvider, error) {\n \n \ttp := tracesdk.NewTracerProvider(\n \t\ttracesdk.WithBatcher(exp, tracesdk.WithBatchTimeout(1000*time.Millisecond)),\n+\t\t// default to sampling 100% but use a configurable sampler type\n+\t\ttracesdk.WithSampler(tracesdk.ParentBased(tracesdk.TraceIDRatioBased(1.0))),\n \t\t// record information about this application in a Resource.\n \t\ttracesdk.WithResource(resource.NewWithAttributes(\n \t\t\tsemconv.SchemaURL,\n@@ -97,7 +99,10 @@ func main() {\n \t// register our TracerProvider as the global so any imported\n \t// instrumentation in the future will default to using it.\n \totel.SetTracerProvider(tp)\n-\totel.SetTextMapPropagator(propagation.TraceContext{})\n+\t// use a composite propagator; by default include W3C TraceContext and Baggage\n+\totel.SetTextMapPropagator(\n+\t\tpropagation.NewCompositeTextMapPropagator(propagation.TraceContext{}, propagation.Baggage{}),\n+\t)\n \n \t// add the opentelemetry hook\n \topenfeature.AddHooks(otelHook.NewTracesHook())\n@@ -156,4 +161,4 @@ func main() {\n \tlog.Println(\"Jaeger UI available at http://localhost:16686\")\n \tlog.Print(\"\\n -> run 'curl \\\"http://localhost:8000/api/greeting?user=xyz\\\"'\\n\")\n \tlog.Fatal(http.ListenAndServe(\":8000\", router))\n-}\n+}\ndiff --git a/internal/config/tracing.go b/internal/config/tracing.go\nindex 31efac9..a43e8a7 100644\n--- a/internal/config/tracing.go\n+++ b/internal/config/tracing.go\n@@ -9,20 +9,24 @@ import (\n // cheers up the unparam linter\n var _ defaulter = (*TracingConfig)(nil)\n \n-// TracingConfig contains fields, which configure tracing telemetry\n-// output destinations.\n-type TracingConfig struct {\n-\tEnabled  bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n-\tExporter TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n-\tJaeger   JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n-\tZipkin   ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n-\tOTLP     OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n-}\n+\t// TracingConfig contains fields, which configure tracing telemetry\n+\t// output destinations and behavior.\n+\ttype TracingConfig struct {\n+\t\tEnabled        bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n+\t\tExporter       TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n+\t\tSamplingRatio  float64             `json:\"sampling_ratio,omitempty\" mapstructure:\"sampling_ratio\" yaml:\"sampling_ratio,omitempty\"`\n+\t\tPropagators    []string            `json:\"propagators,omitempty\" mapstructure:\"propagators\" yaml:\"propagators,omitempty\"`\n+\t\tJaeger         JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n+\t\tZipkin         ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n+\t\tOTLP           OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\t}\n \n func (c *TracingConfig) setDefaults(v *viper.Viper) error {\n \tv.SetDefault(\"tracing\", map[string]any{\n-\t\t\"enabled\":  false,\n-\t\t\"exporter\": TracingJaeger,\n+\t\t\"enabled\":        false,\n+\t\t\"exporter\":       TracingJaeger,\n+\t\t\"sampling_ratio\": 1.0,\n+\t\t\"propagators\":    []string{\"tracecontext\", \"baggage\"},\n \t\t\"jaeger\": map[string]any{\n \t\t\t\"host\": \"localhost\",\n \t\t\t\"port\": 6831,\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/examples/openfeature/main.go b/examples/openfeature/main.go\nindex 7f99d1f..bd6ca40 100644\n--- a/examples/openfeature/main.go\n+++ b/examples/openfeature/main.go\n@@ -97,7 +97,10 @@ func main() {\n \t// register our TracerProvider as the global so any imported\n \t// instrumentation in the future will default to using it.\n \totel.SetTracerProvider(tp)\n-\totel.SetTextMapPropagator(propagation.TraceContext{})\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(\n+\t\tpropagation.TraceContext{},\n+\t\tpropagation.Baggage{},\n+\t))\n \n \t// add the opentelemetry hook\n \topenfeature.AddHooks(otelHook.NewTracesHook())\ndiff --git a/internal/config/tracing.go b/internal/config/tracing.go\nindex 31efac9..b2068df 100644\n--- a/internal/config/tracing.go\n+++ b/internal/config/tracing.go\n@@ -12,16 +12,20 @@ var _ defaulter = (*TracingConfig)(nil)\n // TracingConfig contains fields, which configure tracing telemetry\n // output destinations.\n type TracingConfig struct {\n-\tEnabled  bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n-\tExporter TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n-\tJaeger   JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n-\tZipkin   ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n-\tOTLP     OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tEnabled     bool                `json:\"enabled\" mapstructure:\"enabled\" yaml:\"enabled\"`\n+\tExporter    TracingExporter     `json:\"exporter,omitempty\" mapstructure:\"exporter\" yaml:\"exporter,omitempty\"`\n+\tJaeger      JaegerTracingConfig `json:\"jaeger,omitempty\" mapstructure:\"jaeger\" yaml:\"jaeger,omitempty\"`\n+\tZipkin      ZipkinTracingConfig `json:\"zipkin,omitempty\" mapstructure:\"zipkin\" yaml:\"zipkin,omitempty\"`\n+\tOTLP        OTLPTracingConfig   `json:\"otlp,omitempty\" mapstructure:\"otlp\" yaml:\"otlp,omitempty\"`\n+\tSampleRatio float64             `json:\"sample_ratio,omitempty\" mapstructure:\"sample_ratio\" yaml:\"sample_ratio,omitempty\"`\n+\tPropagators []string            `json:\"propagators,omitempty\" mapstructure:\"propagators\" yaml:\"propagators,omitempty\"`\n }\n \n func (c *TracingConfig) setDefaults(v *viper.Viper) error {\n \tv.SetDefault(\"tracing\", map[string]any{\n-\t\t\"enabled\":  false,\n+\t\t\"enabled\":       false,\n+\t\t\"sample_ratio\":  1.0,\n+\t\t\"propagators\":   []string{\"tracecontext\", \"baggage\"},\n \t\t\"exporter\": TracingJaeger,\n \t\t\"jaeger\": map[string]any{\n \t\t\t\"host\": \"localhost\",\ndiff --git a/internal/tracing/tracing.go b/internal/tracing/tracing.go\nindex e0e1f0c..0e039f6 100644\n--- a/internal/tracing/tracing.go\n+++ b/internal/tracing/tracing.go\n@@ -29,15 +29,73 @@ func newResource(ctx context.Context, fliptVersion string) (*resource.Resource,\n \t)\n }\n \n+import (\n+\t\"context\"\n+\t\"fmt\"\n+\t\"os\"\n+\t\"strconv\"\n+\t\"strings\"\n+\t\"sync\"\n+\n+\t\"go.opentelemetry.io/otel\"\n+\t\"go.opentelemetry.io/otel/propagation\"\n+\t\"go.opentelemetry.io/otel/sdk/resource\"\n+\ttracesdk \"go.opentelemetry.io/otel/sdk/trace\"\n+\tsemconv \"go.opentelemetry.io/otel/semconv/v1.17.0\"\n+)\n+\n // NewProvider creates a new TracerProvider configured for Flipt tracing.\n func NewProvider(ctx context.Context, fliptVersion string) (*tracesdk.TracerProvider, error) {\n \ttraceResource, err := newResource(ctx, fliptVersion)\n \tif err != nil {\n \t\treturn nil, err\n \t}\n+\n+\t// Determine sampling ratio from environment. Default is 1.0 (always on).\n+\tratioStr := strings.TrimSpace(os.Getenv(\"FLIPT_TRACING_SAMPLING_RATIO\"))\n+\tvar sampler tracesdk.Sampler\n+\tif ratioStr == \"\" {\n+\t\tsampler = tracesdk.AlwaysSample()\n+\t} else {\n+\t\tr, parseErr := strconv.ParseFloat(ratioStr, 64)\n+\t\tif parseErr != nil {\n+\t\t\treturn nil, fmt.Errorf(\"invalid FLIPT_TRACING_SAMPLING_RATIO %q: %w\", ratioStr, parseErr)\n+\t\t}\n+\t\tif r < 0 || r > 1 {\n+\t\t\treturn nil, fmt.Errorf(\"invalid FLIPT_TRACING_SAMPLING_RATIO %q: must be between 0 and 1\", ratioStr)\n+\t\t}\n+\t\tswitch {\n+\t\tcase r == 0:\n+\t\t\tsampler = tracesdk.NeverSample()\n+\t\tcase r == 1:\n+\t\t\tsampler = tracesdk.AlwaysSample()\n+\t\tdefault:\n+\t\t\tsampler = tracesdk.ParentBased(tracesdk.TraceIDRatioBased(r))\n+\t\t}\n+\t}\n+\n+\t// Configure propagators from environment. Default is tracecontext,baggage.\n+\tpropsStr := strings.TrimSpace(os.Getenv(\"FLIPT_TRACING_PROPAGATORS\"))\n+\tvar propagators []propagation.TextMapPropagator\n+\tif propsStr == \"\" {\n+\t\tpropagators = []propagation.TextMapPropagator{propagation.TraceContext{}, propagation.Baggage{}}\n+\t} else {\n+\t\tfor _, p := range strings.Split(propsStr, \",\") {\n+\t\t\tswitch strings.ToLower(strings.TrimSpace(p)) {\n+\t\t\tcase \"tracecontext\":\n+\t\t\t\tpropagators = append(propagators, propagation.TraceContext{})\n+\t\t\tcase \"baggage\":\n+\t\t\t\tpropagators = append(propagators, propagation.Baggage{})\n+\t\t\tdefault:\n+\t\t\t\treturn nil, fmt.Errorf(\"unsupported propagator %q in FLIPT_TRACING_PROPAGATORS\", p)\n+\t\t\t}\n+\t\t}\n+\t}\n+\totel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagators...))\n+\n \treturn tracesdk.NewTracerProvider(\n \t\ttracesdk.WithResource(traceResource),\n-\t\ttracesdk.WithSampler(tracesdk.AlwaysSample()),\n+\t\ttracesdk.WithSampler(sampler),\n \t), nil\n }\n \n"
}