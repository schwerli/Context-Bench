{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__53ca6a30",
    "original_id": "instance_internetarchive__openlibrary-8a5a63af6e0be406aa6c8c9b6d5f28b2f1b6af5a-v0f5aece3601a5b4419f7ccec1dbda2071be28ee4",
    "1_model_selected_files": [
        "openlibrary/olbase/events.py",
        "openlibrary/plugins/openlibrary/stats.py",
        "openlibrary/config.py",
        "openlibrary/app.py",
        "openlibrary/plugins/openlibrary/code.py"
    ],
    "2_embedding_selected_files": [
        "scripts/monitoring/utils.py",
        "scripts/monitoring/monitor.py",
        "scripts/solr_builder/solr_builder/solr_builder.py",
        "scripts/cron_wrapper.py",
        "scripts/affiliate_server.py",
        "openlibrary/plugins/openlibrary/stats.py",
        "openlibrary/plugins/worksearch/schemes/lists.py",
        "openlibrary/plugins/worksearch/schemes/subjects.py",
        "scripts/obfi/shownames.py",
        "openlibrary/plugins/upstream/utils.py",
        "openlibrary/core/lists/model.py",
        "scripts/solr_updater.py",
        "openlibrary/plugins/worksearch/schemes/authors.py",
        "openlibrary/plugins/openlibrary/dev_instance.py",
        "scripts/manage-imports.py",
        "openlibrary/utils/sentry.py",
        "scripts/delete_import_items.py",
        "scripts/gh_scripts/issue_comment_bot.py",
        "openlibrary/core/processors/invalidation.py",
        "openlibrary/plugins/worksearch/subjects.py",
        "openlibrary/solr/data_provider.py",
        "openlibrary/plugins/openlibrary/code.py",
        "openlibrary/plugins/openlibrary/status.py",
        "openlibrary/plugins/worksearch/schemes/works.py",
        "scripts/promise_batch_imports.py",
        "openlibrary/core/bookshelves.py",
        "openlibrary/core/booknotes.py",
        "openlibrary/core/follows.py",
        "openlibrary/data/mapreduce.py",
        "openlibrary/utils/processors.py",
        "openlibrary/core/imports.py",
        "openlibrary/solr/updater/work.py",
        "openlibrary/core/bookshelves_events.py",
        "openlibrary/plugins/upstream/code.py",
        "openlibrary/plugins/worksearch/code.py",
        "openlibrary/views/showmarc.py",
        "scripts/solr_builder/solr_builder/index_subjects.py",
        "openlibrary/plugins/openlibrary/bulk_tag.py",
        "scripts/sitemaps/sitemap.py",
        "openlibrary/plugins/worksearch/schemes/__init__.py",
        "openlibrary/plugins/openlibrary/processors.py",
        "openlibrary/core/waitinglist.py",
        "scripts/fake_loan_server.py",
        "scripts/partner_batch_imports.py",
        "openlibrary/core/bestbook.py",
        "openlibrary/core/processors/readableurls.py",
        "openlibrary/book_providers.py",
        "openlibrary/records/matchers.py",
        "openlibrary/core/observations.py",
        "scripts/copydocs.py",
        "openlibrary/plugins/openlibrary/api.py",
        "openlibrary/catalog/add_book/__init__.py",
        "scripts/mail_bad_author_query.py",
        "openlibrary/plugins/worksearch/schemes/editions.py",
        "openlibrary/conftest.py",
        "openlibrary/plugins/worksearch/bulk_search.py",
        "openlibrary/coverstore/archive.py",
        "scripts/bulk_load_ia_query.py",
        "openlibrary/plugins/admin/services.py",
        "openlibrary/core/stats.py",
        "openlibrary/plugins/upstream/account.py",
        "openlibrary/olbase/events.py",
        "openlibrary/plugins/admin/code.py",
        "openlibrary/core/lists/engine.py",
        "openlibrary/core/ratings.py"
    ],
    "3_final_combined_files": [
        "openlibrary/olbase/events.py",
        "openlibrary/plugins/openlibrary/stats.py",
        "openlibrary/config.py",
        "scripts/monitoring/utils.py",
        "scripts/monitoring/monitor.py",
        "scripts/solr_builder/solr_builder/solr_builder.py"
    ],
    "4_related_elements": {
        "openlibrary/plugins/openlibrary/stats.py": [
            "function: setup\nfunction: stats_hook\nfunction: update_all_stats\nfunction: evaluate_and_store_stat\nclass: GraphiteRequestStats\nfunction: page_load_hook\nfunction: page_unload_hook"
        ],
        "openlibrary/config.py": [
            "variable: runtime_config\nfunction: load\nfunction: load_config\nfunction: setup_infobase_config"
        ],
        "openlibrary/olbase/events.py": [
            "function: setup\nfunction: setup_event_listener"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "openlibrary/config.py": [
                    "function: load_config"
                ],
                "openlibrary/plugins/openlibrary/stats.py": [
                    "function: setup"
                ],
                "openlibrary/olbase/events.py": [
                    "function: setup\nfunction: setup_event_listener"
                ]
            },
            "patches": [
                "diff --git a/openlibrary/olbase/events.py b/openlibrary/olbase/events.py\nindex fc8fa4c..63535eb 100644\n--- a/openlibrary/olbase/events.py\n+++ b/openlibrary/olbase/events.py\n@@ -10,6 +10,8 @@ List of events:\n \n import logging\n \n+import os\n+import socket\n import eventer\n import web\n \n@@ -20,8 +22,37 @@ logger = logging.getLogger(\"openlibrary.olbase\")\n \n \n def setup():\n-    setup_event_listener()\n-\n+    if _is_host_allowed():\n+        setup_event_listener()\n+    else:\n+        logger.info(\"skipping infobase event setup; host '%s' not allowed\", _get_current_hostname())\n+\n+\n+def _get_current_hostname():\n+    env_host = os.environ.get(\"HOSTNAME\") or os.environ.get(\"HOST\") or os.environ.get(\"SERVER_NAME\")\n+    if env_host:\n+        return env_host\n+    try:\n+        return socket.gethostname()\n+    except Exception:\n+        return \"\"\n+\n+def _is_host_allowed():\n+    raw = os.environ.get(\"OL_ALLOWED_HOSTS\", \"\")\n+    allowlist = [h.strip() for h in raw.split(\",\") if h.strip()]\n+    if not allowlist:\n+        # No restriction configured; default to allowed\n+        return True\n+    host = _get_current_hostname().lower()\n+    for pat in allowlist:\n+        p = pat.lower()\n+        if p.endswith(\"*\"):\n+            if host.startswith(p[:-1]):\n+                return True\n+        else:\n+            if host == p:\n+                return True\n+    return False\n \n def setup_event_listener():\n     logger.info(\"setting up infobase events for Open Library\")\n",
                "diff --git a/openlibrary/olbase/events.py b/openlibrary/olbase/events.py\nindex fc8fa4c..1f49f13 100644\n--- a/openlibrary/olbase/events.py\n+++ b/openlibrary/olbase/events.py\n@@ -10,6 +10,8 @@ List of events:\n \n import logging\n \n+import os\n+import socket\n import eventer\n import web\n \n@@ -18,12 +20,46 @@ from openlibrary.utils import olmemcache\n \n logger = logging.getLogger(\"openlibrary.olbase\")\n \n+def _host_is_allowed():\n+    \"\"\"\n+    Returns True if the current host is allowed to register background\n+    event listeners, based on the OL_EVENT_ALLOWED_HOSTS environment var.\n+\n+    OL_EVENT_ALLOWED_HOSTS should be a comma-separated list of hostnames\n+    or prefix wildcards ending with '*', e.g., \"app-1,app-2,app-\".\n+    \"\"\"\n+    raw = os.environ.get(\"OL_EVENT_ALLOWED_HOSTS\", \"\")\n+    if not raw:\n+        # No allowlist configured; allow by default to preserve existing behavior.\n+        return True\n+\n+    hostname = os.environ.get(\"HOSTNAME\") or socket.gethostname() or \"\"\n+    patterns = [p.strip() for p in raw.split(\",\") if p.strip()]\n+    for p in patterns:\n+        if p.endswith(\"*\"):\n+            prefix = p[:-1]\n+            if hostname.startswith(prefix):\n+                return True\n+        else:\n+            if hostname == p:\n+                return True\n+    return False\n+\n \n def setup():\n     setup_event_listener()\n \n \n def setup_event_listener():\n+    # Only register event listeners on allowed hosts\n+    if not _host_is_allowed():\n+        try:\n+            current_host = os.environ.get(\"HOSTNAME\") or socket.gethostname()\n+        except Exception:\n+            current_host = \"unknown\"\n+        logger.info(\"skipping infobase events setup on host '%s' (not in OL_EVENT_ALLOWED_HOSTS)\", current_host)\n+        return\n+\n     logger.info(\"setting up infobase events for Open Library\")\n \n     ol = server.get_site('openlibrary.org')\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "openlibrary/plugins/openlibrary/stats.py": [
                    "function: setup"
                ],
                "openlibrary/olbase/events.py": [
                    "function: setup\nfunction: setup_event_listener"
                ],
                "openlibrary/config.py": [
                    "function: load_config"
                ]
            },
            "patches": [
                "diff --git a/openlibrary/olbase/events.py b/openlibrary/olbase/events.py\nindex fc8fa4c..70c32d4 100644\n--- a/openlibrary/olbase/events.py\n+++ b/openlibrary/olbase/events.py\n@@ -19,7 +19,33 @@ from openlibrary.utils import olmemcache\n logger = logging.getLogger(\"openlibrary.olbase\")\n \n \n+def _get_hostname():\n+    import os\n+    import socket\n+    return os.environ.get('HOSTNAME') or socket.gethostname() or ''\n+\n+def _is_host_allowed():\n+    import os\n+    allowlist = (os.environ.get('OL_JOB_HOSTS') or '').strip()\n+    # If no allowlist is provided, default to allowing registration on all hosts\n+    if not allowlist:\n+        return True\n+    hostname = _get_hostname()\n+    patterns = [p.strip() for p in allowlist.split(',') if p.strip()]\n+    for pat in patterns:\n+        # Support simple prefix wildcard patterns like \"app-*\"\n+        if pat.endswith('*'):\n+            if hostname.startswith(pat[:-1]):\n+                return True\n+        elif hostname == pat:\n+            return True\n+    return False\n+\n def setup():\n+    if not _is_host_allowed():\n+        hostname = _get_hostname()\n+        logger.info(\"skipping infobase events setup on disallowed host: %s\", hostname)\n+        return\n     setup_event_listener()\n \n \n",
                "diff --git a/openlibrary/olbase/events.py b/openlibrary/olbase/events.py\nindex fc8fa4c..5de9808 100644\n--- a/openlibrary/olbase/events.py\n+++ b/openlibrary/olbase/events.py\n@@ -12,6 +12,8 @@ import logging\n \n import eventer\n import web\n+import os\n+import socket\n \n from infogami.infobase import config, server\n from openlibrary.utils import olmemcache\n@@ -26,6 +28,24 @@ def setup():\n def setup_event_listener():\n     logger.info(\"setting up infobase events for Open Library\")\n \n+    # Host-scoped registration: only register on allowed hosts\n+    allowlist = os.environ.get(\"OL_HOST_ALLOWLIST\", \"\").strip()\n+    hostname = os.environ.get(\"HOSTNAME\") or socket.gethostname()\n+    if allowlist:\n+        allowed = False\n+        for token in [t.strip() for t in allowlist.split(\",\") if t.strip()]:\n+            if token.endswith(\"*\"):\n+                if hostname.startswith(token[:-1]):\n+                    allowed = True\n+                    break\n+            else:\n+                if hostname == token:\n+                    allowed = True\n+                    break\n+        if not allowed:\n+            logger.info(\"Skipping infobase event registration on host %s; not in allowlist %r\", hostname, allowlist)\n+            return\n+\n     ol = server.get_site('openlibrary.org')\n     ib = server._infobase\n \n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/openlibrary/olbase/events.py b/openlibrary/olbase/events.py\nindex fc8fa4c..63535eb 100644\n--- a/openlibrary/olbase/events.py\n+++ b/openlibrary/olbase/events.py\n@@ -10,6 +10,8 @@ List of events:\n \n import logging\n \n+import os\n+import socket\n import eventer\n import web\n \n@@ -20,8 +22,37 @@ logger = logging.getLogger(\"openlibrary.olbase\")\n \n \n def setup():\n-    setup_event_listener()\n-\n+    if _is_host_allowed():\n+        setup_event_listener()\n+    else:\n+        logger.info(\"skipping infobase event setup; host '%s' not allowed\", _get_current_hostname())\n+\n+\n+def _get_current_hostname():\n+    env_host = os.environ.get(\"HOSTNAME\") or os.environ.get(\"HOST\") or os.environ.get(\"SERVER_NAME\")\n+    if env_host:\n+        return env_host\n+    try:\n+        return socket.gethostname()\n+    except Exception:\n+        return \"\"\n+\n+def _is_host_allowed():\n+    raw = os.environ.get(\"OL_ALLOWED_HOSTS\", \"\")\n+    allowlist = [h.strip() for h in raw.split(\",\") if h.strip()]\n+    if not allowlist:\n+        # No restriction configured; default to allowed\n+        return True\n+    host = _get_current_hostname().lower()\n+    for pat in allowlist:\n+        p = pat.lower()\n+        if p.endswith(\"*\"):\n+            if host.startswith(p[:-1]):\n+                return True\n+        else:\n+            if host == p:\n+                return True\n+    return False\n \n def setup_event_listener():\n     logger.info(\"setting up infobase events for Open Library\")\n"
}