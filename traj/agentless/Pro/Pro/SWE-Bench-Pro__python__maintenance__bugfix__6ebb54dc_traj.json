{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__6ebb54dc",
    "original_id": "instance_ansible__ansible-bec27fb4c0a40c5f8bbcf26a475704227d65ee73-v30a923fb5c164d6cd18280c02422f75e611e8fb2",
    "1_model_selected_files": [
        "lib/ansible/cli/doc.py",
        "lib/ansible/utils/plugin_docs.py",
        "lib/ansible/utils/display.py",
        "lib/ansible/playbook/role/metadata.py",
        "lib/ansible/utils/fqcn.py"
    ],
    "2_embedding_selected_files": [
        "lib/ansible/cli/doc.py",
        "lib/ansible/utils/plugin_docs.py",
        "lib/ansible/plugins/doc_fragments/default_callback.py",
        "lib/ansible/parsing/plugin_docs.py",
        "lib/ansible/plugins/doc_fragments/template_common.py",
        "lib/ansible/plugins/doc_fragments/action_common_attributes.py",
        "lib/ansible/plugins/doc_fragments/result_format_callback.py",
        "packaging/cli-doc/build.py",
        "lib/ansible/plugins/doc_fragments/__init__.py",
        "lib/ansible/plugins/doc_fragments/shell_common.py",
        "lib/ansible/modules/validate_argument_spec.py",
        "lib/ansible/utils/display.py",
        "lib/ansible/cli/galaxy.py",
        "lib/ansible/plugins/doc_fragments/constructed.py",
        "lib/ansible/cli/arguments/option_helpers.py",
        "lib/ansible/cli/config.py",
        "lib/ansible/plugins/doc_fragments/files.py",
        "lib/ansible/plugins/doc_fragments/validate.py",
        "lib/ansible/plugins/doc_fragments/action_core.py",
        "lib/ansible/plugins/doc_fragments/decrypt.py",
        "hacking/return_skeleton_generator.py",
        "lib/ansible/plugins/doc_fragments/return_common.py",
        "lib/ansible/modules/debug.py",
        "lib/ansible/utils/color.py",
        "lib/ansible/plugins/doc_fragments/shell_windows.py",
        "lib/ansible/plugins/doc_fragments/url.py",
        "lib/ansible/modules/command.py",
        "lib/ansible/modules/apt.py",
        "lib/ansible/plugins/doc_fragments/vars_plugin_staging.py",
        "lib/ansible/plugins/doc_fragments/backup.py",
        "lib/ansible/modules/assemble.py",
        "lib/ansible/galaxy/role.py",
        "lib/ansible/modules/meta.py",
        "lib/ansible/plugins/doc_fragments/url_windows.py",
        "lib/ansible/plugins/become/sudo.py",
        "lib/ansible/errors/yaml_strings.py",
        "lib/ansible/modules/raw.py",
        "lib/ansible/plugins/doc_fragments/inventory_cache.py",
        "lib/ansible/modules/setup.py",
        "lib/ansible/modules/pause.py",
        "lib/ansible/cli/__init__.py",
        "lib/ansible/plugins/become/runas.py",
        "lib/ansible/plugins/doc_fragments/connection_pipelining.py",
        "lib/ansible/plugins/become/su.py",
        "hacking/ansible-profile.py",
        "lib/ansible/plugins/lookup/config.py",
        "lib/ansible/plugins/callback/__init__.py",
        "lib/ansible/modules/add_host.py",
        "lib/ansible/modules/user.py",
        "lib/ansible/modules/template.py",
        "lib/ansible/modules/shell.py",
        "lib/ansible/modules/debconf.py",
        "lib/ansible/modules/import_role.py"
    ],
    "3_final_combined_files": [
        "lib/ansible/cli/doc.py",
        "lib/ansible/utils/plugin_docs.py",
        "lib/ansible/utils/display.py",
        "lib/ansible/plugins/doc_fragments/default_callback.py"
    ],
    "4_related_elements": {
        "lib/ansible/cli/doc.py": [
            "class: RoleMixin\nclass: DocCLI\nfunction: _do_yaml_snippet\nfunction: _do_lookup_snippet"
        ],
        "lib/ansible/utils/plugin_docs.py": [
            "function: add_fragments\nfunction: get_docstring\nfunction: get_plugin_docs\nfunction: find_plugin_docfile\nfunction: get_versioned_doclink\nfunction: merge_fragment\nfunction: _process_versions_and_dates\nfunction: add_collection_to_versions_and_dates\nfunction: remove_current_collection_from_versions_and_dates"
        ],
        "lib/ansible/utils/display.py": [
            "class: Display\nfunction: get_text_width"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "lib/ansible/cli/doc.py": [
                    "function: DocCLI.tty_ify\nfunction: DocCLI.warp_fill\nfunction: DocCLI.add_fields\nfunction: DocCLI.get_man_text\nfunction: DocCLI.get_role_man_text\nfunction: DocCLI.run\nfunction: RoleMixin._create_role_list"
                ],
                "lib/ansible/utils/plugin_docs.py": [
                    "function: add_fragments"
                ],
                "lib/ansible/utils/display.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 813f264..6204ca3 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -431,8 +431,8 @@ class DocCLI(CLI, RoleMixin):\n         t = cls._REF.sub(r\"\\1\", t)            # R(word, sphinx-ref) => word\n         t = cls._CONST.sub(r\"`\\1'\", t)        # C(word) => `word'\n         t = cls._SEM_OPTION_NAME.sub(cls._tty_ify_sem_complex, t)  # O(expr)\n-        t = cls._SEM_OPTION_VALUE.sub(cls._tty_ify_sem_simle, t)  # V(expr)\n-        t = cls._SEM_ENV_VARIABLE.sub(cls._tty_ify_sem_simle, t)  # E(expr)\n+        t = cls._SEM_OPTION_VALUE.sub(cls._tty_ify_sem_simple, t)  # V(expr)\n+        t = cls._SEM_ENV_VARIABLE.sub(cls._tty_ify_sem_simple, t)  # E(expr)\n         t = cls._SEM_RET_VALUE.sub(cls._tty_ify_sem_complex, t)  # RV(expr)\n         t = cls._RULER.sub(\"\\n{0}\\n\".format(\"-\" * 13), t)   # HORIZONTALLINE => -------\n \n@@ -819,7 +819,8 @@ class DocCLI(CLI, RoleMixin):\n             if plugin_type == 'keyword':\n                 docs = DocCLI._list_keywords()\n             elif plugin_type == 'role':\n-                docs = self._create_role_list()\n+                # Be tolerant of malformed/missing metadata/argspecs during listing\n+                docs = self._create_role_list(fail_on_errors=False)\n             else:\n                 docs = self._list_plugins(plugin_type, content)\n         else:\n@@ -1060,6 +1061,11 @@ class DocCLI(CLI, RoleMixin):\n \n     @staticmethod\n     def warp_fill(text, limit, initial_indent='', subsequent_indent='', **kwargs):\n+        # Avoid mid-word and hyphen breaks by default for readability\n+        if 'break_long_words' not in kwargs:\n+            kwargs['break_long_words'] = False\n+        if 'break_on_hyphens' not in kwargs:\n+            kwargs['break_on_hyphens'] = False\n         result = []\n         for paragraph in text.split('\\n\\n'):\n             result.append(textwrap.fill(paragraph, limit, initial_indent=initial_indent, subsequent_indent=subsequent_indent, **kwargs))\n@@ -1227,8 +1233,9 @@ class DocCLI(CLI, RoleMixin):\n         pad = display.columns * 0.20\n         limit = max(display.columns - int(pad), 70)\n \n-        plugin_name = doc.get(context.CLIARGS['type'], doc.get('name')) or doc.get('plugin_type') or plugin_type\n-        if collection_name:\n+        # Prefer fully-qualified plugin name if available\n+        plugin_name = doc.get('fqcn') or doc.get(context.CLIARGS['type'], doc.get('name')) or doc.get('name') or doc.get('plugin') or plugin_type\n+        if not doc.get('fqcn') and collection_name:\n             plugin_name = '%s.%s' % (collection_name, plugin_name)\n \n         text.append(\"> %s    (%s)\\n\" % (plugin_name.upper(), doc.pop('filename')))\ndiff --git a/lib/ansible/utils/plugin_docs.py b/lib/ansible/utils/plugin_docs.py\nindex 7d8c3ab..d379cf1 100644\n--- a/lib/ansible/utils/plugin_docs.py\n+++ b/lib/ansible/utils/plugin_docs.py\n@@ -127,7 +127,8 @@ def add_fragments(doc, filename, fragment_loader, is_module=False):\n     fragments = doc.pop('extends_documentation_fragment', [])\n \n     if isinstance(fragments, string_types):\n-        fragments = [fragments]\n+        # Allow comma-separated lists of fragments and strip whitespace\n+        fragments = [f.strip() for f in fragments.split(',') if f.strip()]\n \n     unknown_fragments = []\n \n",
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 813f264..d23ab00 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -1060,6 +1060,9 @@ class DocCLI(CLI, RoleMixin):\n \n     @staticmethod\n     def warp_fill(text, limit, initial_indent='', subsequent_indent='', **kwargs):\n+        # Avoid mid-word/hyphen breaks to improve readability in TTY output\n+        kwargs.setdefault('break_long_words', False)\n+        kwargs.setdefault('break_on_hyphens', False)\n         result = []\n         for paragraph in text.split('\\n\\n'):\n             result.append(textwrap.fill(paragraph, limit, initial_indent=initial_indent, subsequent_indent=subsequent_indent, **kwargs))\ndiff --git a/lib/ansible/utils/plugin_docs.py b/lib/ansible/utils/plugin_docs.py\nindex 7d8c3ab..84b5e25 100644\n--- a/lib/ansible/utils/plugin_docs.py\n+++ b/lib/ansible/utils/plugin_docs.py\n@@ -127,7 +127,11 @@ def add_fragments(doc, filename, fragment_loader, is_module=False):\n     fragments = doc.pop('extends_documentation_fragment', [])\n \n     if isinstance(fragments, string_types):\n-        fragments = [fragments]\n+        # Support comma-separated strings of fragment slugs\n+        if ',' in fragments:\n+            fragments = [f.strip() for f in fragments.split(',') if f.strip()]\n+        else:\n+            fragments = [fragments]\n \n     unknown_fragments = []\n \n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "lib/ansible/utils/plugin_docs.py": [
                    "function: add_fragments"
                ],
                "lib/ansible/cli/doc.py": [
                    "function: DocCLI.warp_fill\nfunction: DocCLI.add_fields\nfunction: DocCLI.get_man_text\nfunction: DocCLI.get_role_man_text\nfunction: DocCLI.display_plugin_list\nfunction: DocCLI._display_available_roles\nfunction: DocCLI.get_plugin_metadata\nline: 823"
                ],
                "lib/ansible/utils/display.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 813f264..c731b72 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -819,7 +819,9 @@ class DocCLI(CLI, RoleMixin):\n             if plugin_type == 'keyword':\n                 docs = DocCLI._list_keywords()\n             elif plugin_type == 'role':\n-                docs = self._create_role_list()\n+                # Gracefully continue on errors by default (respect CLI no_fail_on_errors flag)\n+                no_fail = bool(not context.CLIARGS.get('no_fail_on_errors'))\n+                docs = self._create_role_list(fail_on_errors=no_fail)\n             else:\n                 docs = self._list_plugins(plugin_type, content)\n         else:\n@@ -1060,9 +1062,21 @@ class DocCLI(CLI, RoleMixin):\n \n     @staticmethod\n     def warp_fill(text, limit, initial_indent='', subsequent_indent='', **kwargs):\n+        # Avoid breaking long words or hyphenated terms to improve readability\n+        if 'break_long_words' not in kwargs:\n+            kwargs['break_long_words'] = False\n+        if 'break_on_hyphens' not in kwargs:\n+            kwargs['break_on_hyphens'] = False\n+\n         result = []\n         for paragraph in text.split('\\n\\n'):\n-            result.append(textwrap.fill(paragraph, limit, initial_indent=initial_indent, subsequent_indent=subsequent_indent, **kwargs))\n+            result.append(textwrap.fill(\n+                paragraph,\n+                limit,\n+                initial_indent=initial_indent,\n+                subsequent_indent=subsequent_indent,\n+                **kwargs\n+            ))\n             initial_indent = subsequent_indent\n         return '\\n'.join(result)\n \ndiff --git a/lib/ansible/utils/plugin_docs.py b/lib/ansible/utils/plugin_docs.py\nindex 7d8c3ab..0cc609c 100644\n--- a/lib/ansible/utils/plugin_docs.py\n+++ b/lib/ansible/utils/plugin_docs.py\n@@ -126,8 +126,12 @@ def add_fragments(doc, filename, fragment_loader, is_module=False):\n \n     fragments = doc.pop('extends_documentation_fragment', [])\n \n+    # Support comma-separated string of fragments as well as list types\n     if isinstance(fragments, string_types):\n-        fragments = [fragments]\n+        if ',' in fragments:\n+            fragments = [f.strip() for f in fragments.split(',') if f and f.strip()]\n+        else:\n+            fragments = [fragments.strip()]\n \n     unknown_fragments = []\n \n",
                "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 813f264..11d65e9 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -912,8 +912,9 @@ class DocCLI(CLI, RoleMixin):\n             # Removed plugins don't have any documentation\n             return None\n \n+        fqcn_name = \"%s.%s\" % (collection_name, plugin_name) if collection_name else plugin_name\n         return dict(\n-            name=plugin_name,\n+            name=fqcn_name,\n             namespace=DocCLI.namespace_from_plugin_filepath(filename, plugin_name, loader.package_path),\n             description=doc.get('short_description', \"UNKNOWN\"),\n             version_added=doc.get('version_added', \"UNKNOWN\")\n@@ -1062,7 +1063,15 @@ class DocCLI(CLI, RoleMixin):\n     def warp_fill(text, limit, initial_indent='', subsequent_indent='', **kwargs):\n         result = []\n         for paragraph in text.split('\\n\\n'):\n-            result.append(textwrap.fill(paragraph, limit, initial_indent=initial_indent, subsequent_indent=subsequent_indent, **kwargs))\n+            result.append(textwrap.fill(\n+                paragraph,\n+                limit,\n+                initial_indent=initial_indent,\n+                subsequent_indent=subsequent_indent,\n+                break_long_words=False,\n+                break_on_hyphens=False,\n+                **kwargs\n+            ))\n             initial_indent = subsequent_indent\n         return '\\n'.join(result)\n \ndiff --git a/lib/ansible/utils/plugin_docs.py b/lib/ansible/utils/plugin_docs.py\nindex 7d8c3ab..cbf912c 100644\n--- a/lib/ansible/utils/plugin_docs.py\n+++ b/lib/ansible/utils/plugin_docs.py\n@@ -127,7 +127,8 @@ def add_fragments(doc, filename, fragment_loader, is_module=False):\n     fragments = doc.pop('extends_documentation_fragment', [])\n \n     if isinstance(fragments, string_types):\n-        fragments = [fragments]\n+        # Support comma-separated strings of fragments, strip whitespace and ignore empties\n+        fragments = [frag.strip() for frag in fragments.split(',') if frag.strip()]\n \n     unknown_fragments = []\n \n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/lib/ansible/cli/doc.py b/lib/ansible/cli/doc.py\nindex 813f264..6204ca3 100644\n--- a/lib/ansible/cli/doc.py\n+++ b/lib/ansible/cli/doc.py\n@@ -431,8 +431,8 @@ class DocCLI(CLI, RoleMixin):\n         t = cls._REF.sub(r\"\\1\", t)            # R(word, sphinx-ref) => word\n         t = cls._CONST.sub(r\"`\\1'\", t)        # C(word) => `word'\n         t = cls._SEM_OPTION_NAME.sub(cls._tty_ify_sem_complex, t)  # O(expr)\n-        t = cls._SEM_OPTION_VALUE.sub(cls._tty_ify_sem_simle, t)  # V(expr)\n-        t = cls._SEM_ENV_VARIABLE.sub(cls._tty_ify_sem_simle, t)  # E(expr)\n+        t = cls._SEM_OPTION_VALUE.sub(cls._tty_ify_sem_simple, t)  # V(expr)\n+        t = cls._SEM_ENV_VARIABLE.sub(cls._tty_ify_sem_simple, t)  # E(expr)\n         t = cls._SEM_RET_VALUE.sub(cls._tty_ify_sem_complex, t)  # RV(expr)\n         t = cls._RULER.sub(\"\\n{0}\\n\".format(\"-\" * 13), t)   # HORIZONTALLINE => -------\n \n@@ -819,7 +819,8 @@ class DocCLI(CLI, RoleMixin):\n             if plugin_type == 'keyword':\n                 docs = DocCLI._list_keywords()\n             elif plugin_type == 'role':\n-                docs = self._create_role_list()\n+                # Be tolerant of malformed/missing metadata/argspecs during listing\n+                docs = self._create_role_list(fail_on_errors=False)\n             else:\n                 docs = self._list_plugins(plugin_type, content)\n         else:\n@@ -1060,6 +1061,11 @@ class DocCLI(CLI, RoleMixin):\n \n     @staticmethod\n     def warp_fill(text, limit, initial_indent='', subsequent_indent='', **kwargs):\n+        # Avoid mid-word and hyphen breaks by default for readability\n+        if 'break_long_words' not in kwargs:\n+            kwargs['break_long_words'] = False\n+        if 'break_on_hyphens' not in kwargs:\n+            kwargs['break_on_hyphens'] = False\n         result = []\n         for paragraph in text.split('\\n\\n'):\n             result.append(textwrap.fill(paragraph, limit, initial_indent=initial_indent, subsequent_indent=subsequent_indent, **kwargs))\n@@ -1227,8 +1233,9 @@ class DocCLI(CLI, RoleMixin):\n         pad = display.columns * 0.20\n         limit = max(display.columns - int(pad), 70)\n \n-        plugin_name = doc.get(context.CLIARGS['type'], doc.get('name')) or doc.get('plugin_type') or plugin_type\n-        if collection_name:\n+        # Prefer fully-qualified plugin name if available\n+        plugin_name = doc.get('fqcn') or doc.get(context.CLIARGS['type'], doc.get('name')) or doc.get('name') or doc.get('plugin') or plugin_type\n+        if not doc.get('fqcn') and collection_name:\n             plugin_name = '%s.%s' % (collection_name, plugin_name)\n \n         text.append(\"> %s    (%s)\\n\" % (plugin_name.upper(), doc.pop('filename')))\ndiff --git a/lib/ansible/utils/plugin_docs.py b/lib/ansible/utils/plugin_docs.py\nindex 7d8c3ab..d379cf1 100644\n--- a/lib/ansible/utils/plugin_docs.py\n+++ b/lib/ansible/utils/plugin_docs.py\n@@ -127,7 +127,8 @@ def add_fragments(doc, filename, fragment_loader, is_module=False):\n     fragments = doc.pop('extends_documentation_fragment', [])\n \n     if isinstance(fragments, string_types):\n-        fragments = [fragments]\n+        # Allow comma-separated lists of fragments and strip whitespace\n+        fragments = [f.strip() for f in fragments.split(',') if f.strip()]\n \n     unknown_fragments = []\n \n"
}