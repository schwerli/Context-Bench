{
    "instance_id": "SWE-Bench-Pro__go__maintenance__bugfix__4df06349",
    "original_id": "instance_navidrome__navidrome-31799662706fedddf5bcc1a76b50409d1f91d327",
    "1_model_selected_files": [
        "server/auth.go",
        "server/middlewares.go"
    ],
    "2_embedding_selected_files": [
        "core/metrics/prometheus.go",
        "server/auth_test.go",
        "core/auth/auth_test.go",
        "core/auth/auth.go",
        "core/metrics/insights.go",
        "server/middlewares_test.go",
        "server/auth.go",
        "server/subsonic/middlewares_test.go",
        "server/subsonic/middlewares.go",
        "core/agents/listenbrainz/auth_router_test.go",
        "server/events/sse_test.go",
        "server/server.go",
        "server/initial_setup.go",
        "core/metrics/insights_default.go",
        "server/initial_setup_test.go",
        "core/agents/listenbrainz/client_test.go",
        "server/middlewares.go",
        "core/agents/listenbrainz/agent_test.go",
        "core/agents/session_keys_test.go",
        "core/agents/spotify/client_test.go",
        "core/metrics/insights_windows.go",
        "server/serve_index_test.go",
        "log/formatters_test.go",
        "core/agents/lastfm/agent_test.go",
        "consts/consts.go",
        "scanner/metadata/ffmpeg/ffmpeg_test.go",
        "core/media_streamer_test.go",
        "server/public/encode_id_test.go",
        "scanner/metadata/metadata_test.go",
        "server/events/sse.go",
        "core/metrics/insights_linux.go",
        "scanner/metadata/metadata_internal_test.go",
        "persistence/user_repository_test.go",
        "server/public/handle_streams.go",
        "server/subsonic/media_retrieval_test.go",
        "core/agents/lastfm/client_test.go",
        "scanner/metadata/taglib/taglib_test.go",
        "db/migrations/20200208222418_add_defaults_to_annotations.go",
        "core/agents/agents_test.go",
        "scanner/mapping_internal_test.go",
        "core/metrics/insights_darwin.go",
        "server/server_test.go",
        "server/subsonic/api_test.go",
        "utils/cache/cached_http_client_test.go",
        "core/agents/session_keys.go",
        "scanner/metadata/metadata.go",
        "server/events/events_test.go",
        "log/log_test.go",
        "cmd/root.go",
        "core/agents/lastfm/auth_router.go",
        "utils/req/req_test.go",
        "core/metrics/insights/data.go",
        "conf/configuration.go",
        "server/subsonic/media_annotation_test.go",
        "persistence/mediafile_repository_test.go",
        "model/lyrics_test.go",
        "core/agents/listenbrainz/auth_router.go",
        "core/agents/lastfm/responses_test.go",
        "db/migrations/20210430212322_add_bpm_metadata.go",
        "server/subsonic/system.go",
        "log/redactrus_test.go",
        "server/subsonic/opensubsonic_test.go",
        "cmd/svc.go"
    ],
    "3_final_combined_files": [
        "server/auth.go",
        "server/middlewares.go",
        "core/metrics/prometheus.go",
        "server/auth_test.go",
        "core/auth/auth_test.go"
    ],
    "4_related_elements": {
        "server/auth.go": [
            "function: authHeaderMapper\nfunction: jwtVerifier\nfunction: JWTRefresher\nfunction: UsernameFromToken\nfunction: Authenticator"
        ],
        "server/middlewares.go": [
            "function: corsHandler"
        ],
        "core/metrics/prometheus.go": [
            "function: WriteInitialMetrics\nfunction: WriteAfterScanMetrics\nfunction: getPrometheusMetrics\nfunction: newPrometheusMetrics\nfunction: processSqlAggregateMetrics\nvariable: prometheusMetricsInstance\nvariable: prometheusOnce\nvariable: UIAuthorizationHeader"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "core/metrics/prometheus.go": [
                    "function: init"
                ],
                "server/auth.go": [
                    "function: authHeaderMapper"
                ],
                "server/middlewares.go": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/core/metrics/prometheus.go b/core/metrics/prometheus.go\nindex 8d13db2..53ac91e 100644\n--- a/core/metrics/prometheus.go\n+++ b/core/metrics/prometheus.go\n@@ -1,3 +1,4 @@\n+\n package metrics\n \n import (\n@@ -16,6 +17,11 @@ func WriteInitialMetrics() {\n \tgetPrometheusMetrics().versionInfo.With(prometheus.Labels{\"version\": consts.Version}).Set(1)\n }\n \n+func init() {\n+\t// Write initial metrics as soon as the application starts\n+\tWriteInitialMetrics()\n+}\n+\n func WriteAfterScanMetrics(ctx context.Context, dataStore model.DataStore, success bool) {\n \tprocessSqlAggregateMetrics(ctx, dataStore, getPrometheusMetrics().dbTotal)\n \n@@ -120,4 +126,4 @@ func processSqlAggregateMetrics(ctx context.Context, dataStore model.DataStore,\n \t\treturn\n \t}\n \ttargetGauge.With(prometheus.Labels{\"model\": \"user\"}).Set(float64(usersCount))\n-}\n+}\ndiff --git a/server/auth.go b/server/auth.go\nindex ca4fac4..ae8a733 100644\n--- a/server/auth.go\n+++ b/server/auth.go\n@@ -174,8 +174,16 @@ func validateLogin(userRepo model.UserRepository, userName, password string) (*m\n // This method maps the custom authorization header to the default 'Authorization', used by the jwtauth library\n func authHeaderMapper(next http.Handler) http.Handler {\n \treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n-\t\tbearer := r.Header.Get(consts.UIAuthorizationHeader)\n-\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\t// Map custom UI authorization header to standard Authorization, extracting Bearer token\n+\t\theader := r.Header.Get(consts.UIAuthorizationHeader)\n+\t\tif header != \"\" {\n+\t\t\t// If header already contains Bearer prefix, keep it; otherwise, prefix with Bearer\n+\t\t\tif len(header) >= 7 && header[:7] == \"Bearer \" {\n+\t\t\t\tr.Header.Set(\"Authorization\", header)\n+\t\t\t} else {\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+header)\n+\t\t\t}\n+\t\t}\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n",
                "diff --git a/core/metrics/prometheus.go b/core/metrics/prometheus.go\nindex 8d13db2..abe2167 100644\n--- a/core/metrics/prometheus.go\n+++ b/core/metrics/prometheus.go\n@@ -16,6 +16,11 @@ func WriteInitialMetrics() {\n \tgetPrometheusMetrics().versionInfo.With(prometheus.Labels{\"version\": consts.Version}).Set(1)\n }\n \n+// init writes initial system metrics immediately on package initialization\n+func init() {\n+\tWriteInitialMetrics()\n+}\n+\n func WriteAfterScanMetrics(ctx context.Context, dataStore model.DataStore, success bool) {\n \tprocessSqlAggregateMetrics(ctx, dataStore, getPrometheusMetrics().dbTotal)\n \ndiff --git a/server/auth.go b/server/auth.go\nindex ca4fac4..c3ef159 100644\n--- a/server/auth.go\n+++ b/server/auth.go\n@@ -171,11 +171,18 @@ func validateLogin(userRepo model.UserRepository, userName, password string) (*m\n \treturn u, nil\n }\n \n-// This method maps the custom authorization header to the default 'Authorization', used by the jwtauth library\n+ // This method maps the custom authorization header to the default 'Authorization', used by the jwtauth library\n func authHeaderMapper(next http.Handler) http.Handler {\n \treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n-\t\tbearer := r.Header.Get(consts.UIAuthorizationHeader)\n-\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\tuiAuth := r.Header.Get(consts.UIAuthorizationHeader)\n+\t\tif uiAuth != \"\" {\n+\t\t\t// Ensure the Authorization header follows the expected \"Bearer <token>\" format\n+\t\t\tif len(uiAuth) >= 7 && (uiAuth[:7] == \"Bearer \" || uiAuth[:7] == \"bearer \") {\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+uiAuth[7:])\n+\t\t\t} else {\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+uiAuth)\n+\t\t\t}\n+\t\t}\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n@@ -274,7 +281,7 @@ func JWTRefresher(next http.Handler) http.Handler {\n \t\t\treturn\n \t\t}\n \n-\t\tw.Header().Set(consts.UIAuthorizationHeader, newTokenString)\n+\t\tw.Header().Set(consts.UIAuthorizationHeader, \"Bearer \"+newTokenString)\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "core/metrics/prometheus.go": [
                    "function: WriteInitialMetrics"
                ],
                "server/auth.go": [
                    "function: authHeaderMapper\nfunction: JWTRefresher"
                ],
                "server/middlewares.go": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/core/metrics/prometheus.go b/core/metrics/prometheus.go\nindex 8d13db2..0fd224a 100644\n--- a/core/metrics/prometheus.go\n+++ b/core/metrics/prometheus.go\n@@ -1,3 +1,4 @@\n+\n package metrics\n \n import (\n@@ -16,6 +17,11 @@ func WriteInitialMetrics() {\n \tgetPrometheusMetrics().versionInfo.With(prometheus.Labels{\"version\": consts.Version}).Set(1)\n }\n \n+// Ensure initial metrics are written on package initialization\n+func init() {\n+\tWriteInitialMetrics()\n+}\n+\n func WriteAfterScanMetrics(ctx context.Context, dataStore model.DataStore, success bool) {\n \tprocessSqlAggregateMetrics(ctx, dataStore, getPrometheusMetrics().dbTotal)\n \n@@ -120,4 +126,4 @@ func processSqlAggregateMetrics(ctx context.Context, dataStore model.DataStore,\n \t\treturn\n \t}\n \ttargetGauge.With(prometheus.Labels{\"model\": \"user\"}).Set(float64(usersCount))\n-}\n+}\ndiff --git a/server/auth.go b/server/auth.go\nindex ca4fac4..d3b3d96 100644\n--- a/server/auth.go\n+++ b/server/auth.go\n@@ -174,8 +174,19 @@ func validateLogin(userRepo model.UserRepository, userName, password string) (*m\n // This method maps the custom authorization header to the default 'Authorization', used by the jwtauth library\n func authHeaderMapper(next http.Handler) http.Handler {\n \treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n-\t\tbearer := r.Header.Get(consts.UIAuthorizationHeader)\n-\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\t// Map the custom authorization header to a standard \"Authorization: Bearer <token>\"\n+\t\t// Only set the Authorization header if a custom header is present\n+\t\tcustom := r.Header.Get(consts.UIAuthorizationHeader)\n+\t\tif custom != \"\" {\n+\t\t\t// Normalize header to proper Bearer format\n+\t\t\tif len(custom) >= 7 && (custom[:7] == \"Bearer \" || custom[:7] == \"bearer \") {\n+\t\t\t\t// Ensure the scheme is properly cased and trimmed\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+custom[7:])\n+\t\t\t} else {\n+\t\t\t\t// Assume the custom header contains only the raw token\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+custom)\n+\t\t\t}\n+\t\t}\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n",
                "diff --git a/core/metrics/prometheus.go b/core/metrics/prometheus.go\nindex 8d13db2..4078420 100644\n--- a/core/metrics/prometheus.go\n+++ b/core/metrics/prometheus.go\n@@ -16,6 +16,11 @@ func WriteInitialMetrics() {\n \tgetPrometheusMetrics().versionInfo.With(prometheus.Labels{\"version\": consts.Version}).Set(1)\n }\n \n+func init() {\n+\t// Write initial metrics as soon as the application starts\n+\tWriteInitialMetrics()\n+}\n+\n func WriteAfterScanMetrics(ctx context.Context, dataStore model.DataStore, success bool) {\n \tprocessSqlAggregateMetrics(ctx, dataStore, getPrometheusMetrics().dbTotal)\n \ndiff --git a/server/auth.go b/server/auth.go\nindex ca4fac4..b12e8ba 100644\n--- a/server/auth.go\n+++ b/server/auth.go\n@@ -175,7 +175,13 @@ func validateLogin(userRepo model.UserRepository, userName, password string) (*m\n func authHeaderMapper(next http.Handler) http.Handler {\n \treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n \t\tbearer := r.Header.Get(consts.UIAuthorizationHeader)\n-\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\tif bearer != \"\" {\n+\t\t\t// Ensure Authorization header is in the form \"Bearer <token>\"\n+\t\t\tif len(bearer) < 7 || bearer[:7] != \"Bearer \" {\n+\t\t\t\tbearer = \"Bearer \" + bearer\n+\t\t\t}\n+\t\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\t}\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n@@ -274,7 +280,7 @@ func JWTRefresher(next http.Handler) http.Handler {\n \t\t\treturn\n \t\t}\n \n-\t\tw.Header().Set(consts.UIAuthorizationHeader, newTokenString)\n+\t\tw.Header().Set(consts.UIAuthorizationHeader, \"Bearer \"+newTokenString)\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/core/metrics/prometheus.go b/core/metrics/prometheus.go\nindex 8d13db2..53ac91e 100644\n--- a/core/metrics/prometheus.go\n+++ b/core/metrics/prometheus.go\n@@ -1,3 +1,4 @@\n+\n package metrics\n \n import (\n@@ -16,6 +17,11 @@ func WriteInitialMetrics() {\n \tgetPrometheusMetrics().versionInfo.With(prometheus.Labels{\"version\": consts.Version}).Set(1)\n }\n \n+func init() {\n+\t// Write initial metrics as soon as the application starts\n+\tWriteInitialMetrics()\n+}\n+\n func WriteAfterScanMetrics(ctx context.Context, dataStore model.DataStore, success bool) {\n \tprocessSqlAggregateMetrics(ctx, dataStore, getPrometheusMetrics().dbTotal)\n \n@@ -120,4 +126,4 @@ func processSqlAggregateMetrics(ctx context.Context, dataStore model.DataStore,\n \t\treturn\n \t}\n \ttargetGauge.With(prometheus.Labels{\"model\": \"user\"}).Set(float64(usersCount))\n-}\n+}\ndiff --git a/server/auth.go b/server/auth.go\nindex ca4fac4..ae8a733 100644\n--- a/server/auth.go\n+++ b/server/auth.go\n@@ -174,8 +174,16 @@ func validateLogin(userRepo model.UserRepository, userName, password string) (*m\n // This method maps the custom authorization header to the default 'Authorization', used by the jwtauth library\n func authHeaderMapper(next http.Handler) http.Handler {\n \treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n-\t\tbearer := r.Header.Get(consts.UIAuthorizationHeader)\n-\t\tr.Header.Set(\"Authorization\", bearer)\n+\t\t// Map custom UI authorization header to standard Authorization, extracting Bearer token\n+\t\theader := r.Header.Get(consts.UIAuthorizationHeader)\n+\t\tif header != \"\" {\n+\t\t\t// If header already contains Bearer prefix, keep it; otherwise, prefix with Bearer\n+\t\t\tif len(header) >= 7 && header[:7] == \"Bearer \" {\n+\t\t\t\tr.Header.Set(\"Authorization\", header)\n+\t\t\t} else {\n+\t\t\t\tr.Header.Set(\"Authorization\", \"Bearer \"+header)\n+\t\t\t}\n+\t\t}\n \t\tnext.ServeHTTP(w, r)\n \t})\n }\n"
}