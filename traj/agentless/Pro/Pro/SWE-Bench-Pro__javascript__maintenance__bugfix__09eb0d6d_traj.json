{
    "instance_id": "SWE-Bench-Pro__javascript__maintenance__bugfix__09eb0d6d",
    "original_id": "instance_NodeBB__NodeBB-a5afad27e52fd336163063ba40dcadc80233ae10-vd59a5728dfc977f44533186ace531248c2917516",
    "1_model_selected_files": [
        "src/messaging/create.js",
        "src/user/settings.js",
        "src/controllers/accounts/settings.js",
        "src/upgrade.js",
        "src/messaging/rooms.js"
    ],
    "2_embedding_selected_files": [
        "src/upgrades/4.3.0/chat_allow_list.js",
        "public/src/client/account/settings.js",
        "src/messaging/index.js",
        "src/api/chats.js",
        "src/controllers/accounts/settings.js",
        "src/upgrades/1.7.4/chat_privilege.js",
        "public/src/client/chats/user-list.js",
        "public/src/client/chats.js",
        "public/src/client/chats/manage.js",
        "src/upgrades/3.3.0/chat_room_owners.js",
        "src/controllers/accounts/chats.js",
        "src/upgrades/1.0.0/chat_upgrade.js",
        "public/src/modules/chat.js",
        "src/controllers/write/chats.js",
        "src/user/settings.js",
        "public/src/client/header/chat.js",
        "src/upgrades/3.6.0/chat_message_counts.js",
        "src/upgrades/3.3.0/chat_room_refactor.js",
        "src/messaging/create.js",
        "src/upgrades/1.0.0/chat_room_hashes.js",
        "src/upgrades/3.3.0/chat_message_mids.js",
        "src/upgrades/3.3.0/chat_room_online_zset.js",
        "public/src/client/account/blocks.js",
        "public/src/client/chats/pinned-messages.js",
        "public/src/client/chats/messages.js",
        "src/upgrades/1.7.6/notification_types.js",
        "public/src/client/chats/user-search.js",
        "src/upgrades/1.17.0/banned_users_group.js",
        "src/upgrades/1.7.1/notification-settings.js",
        "src/routes/write/chats.js",
        "src/user/blocks.js",
        "src/messaging/rooms.js",
        "public/src/client/chats/recent.js",
        "src/upgrades/1.1.0/assign_topic_read_privilege.js",
        "src/upgrades/1.15.0/verified_users_group.js",
        "src/upgrades/1.10.2/upgrade_bans_to_hashes.js",
        "src/messaging/edit.js",
        "public/src/client/chats/create.js",
        "src/upgrades/1.2.0/edit_delete_deletetopic_privileges.js",
        "src/socket.io/modules.js",
        "src/upgrades/3.3.0/save_rooms_zset.js",
        "src/upgrades/2.8.7/fix-email-sorted-sets.js",
        "src/upgrades/1.12.3/give_mod_privileges.js",
        "src/upgrades/1.13.4/remove_allowFileUploads_priv.js",
        "src/upgrades/4.3.0/fix_duplicate_handles.js",
        "src/upgrades/1.12.1/moderation_notes_refactor.js",
        "src/user/info.js",
        "src/activitypub/out.js",
        "src/activitypub/notes.js",
        "src/controllers/accounts/helpers.js",
        "src/groups/update.js",
        "src/controllers/write/users.js",
        "src/user/approval.js",
        "src/user/follow.js",
        "src/messaging/data.js",
        "public/src/client/chats/message-search.js",
        "src/user/bans.js",
        "src/controllers/admin/settings.js",
        "src/api/users.js",
        "src/upgrades/1.4.4/sound_settings.js",
        "src/upgrades/4.0.0/activitypub_setup.js",
        "src/upgrades/1.13.3/fix_users_sorted_sets.js",
        "src/upgrades/1.0.0/global_moderators.js",
        "src/privileges/users.js",
        "src/activitypub/inbox.js",
        "src/upgrades/1.4.0/sorted_set_for_pinned_topics.js",
        "src/upgrades/3.7.0/change-category-sort-settings.js"
    ],
    "3_final_combined_files": [
        "src/messaging/create.js",
        "src/user/settings.js",
        "src/controllers/accounts/settings.js",
        "src/upgrades/4.3.0/chat_allow_list.js",
        "public/src/client/account/settings.js",
        "src/messaging/index.js"
    ],
    "4_related_elements": {
        "src/messaging/create.js": [
            "function: Messaging.sendMessage\nfunction: Messaging.addMessage\nfunction: Messaging.isUserInRoom\nfunction: Messaging.getRoomData\nfunction: Messaging.canViewMessage\nfunction: Messaging.getUidsInRoom"
        ],
        "src/user/settings.js": [
            "function: User.getSettings\nfunction: User.saveSettings\nfunction: onSettingsLoaded\nfunction: parseJSONSetting\nfunction: getSetting\nvariable: settings.chatAllowList\nvariable: settings.chatDenyList\nvariable: settings.disableIncomingChats"
        ],
        "src/controllers/accounts/settings.js": [
            "function: settingsController.get\nfunction: getChatAllowDenyList"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/user/settings.js": [
                    "function: User.saveSettings"
                ],
                "src/controllers/accounts/settings.js": [
                    "function: getChatAllowDenyList"
                ],
                "src/messaging/create.js": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/controllers/accounts/settings.js b/src/controllers/accounts/settings.js\nindex 97b2163..dae7080 100644\n--- a/src/controllers/accounts/settings.js\n+++ b/src/controllers/accounts/settings.js\n@@ -257,11 +257,16 @@ async function getSkinOptions(userData) {\n }\n \n async function getChatAllowDenyList(userData) {\n+\tconst allowListUids = Array.isArray(userData.settings.chatAllowList) ? userData.settings.chatAllowList : [];\n+\tconst denyListUids = Array.isArray(userData.settings.chatDenyList) ? userData.settings.chatDenyList : [];\n+\n \tconst [chatAllowListUsers, chatDenyListUsers] = await Promise.all([\n-\t\tuser.getUsersFields(userData.settings.chatAllowList, ['uid', 'username', 'picture']),\n-\t\tuser.getUsersFields(userData.settings.chatDenyList, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(allowListUids, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(denyListUids, ['uid', 'username', 'picture']),\n \t]);\n \n \tuserData.settings.chatAllowListUsers = chatAllowListUsers;\n \tuserData.settings.chatDenyListUsers = chatDenyListUsers;\n-};\n+\n+\treturn { chatAllowListUsers, chatDenyListUsers };\n+};",
                "diff --git a/src/controllers/accounts/settings.js b/src/controllers/accounts/settings.js\nindex 97b2163..11da5dd 100644\n--- a/src/controllers/accounts/settings.js\n+++ b/src/controllers/accounts/settings.js\n@@ -257,11 +257,16 @@ async function getSkinOptions(userData) {\n }\n \n async function getChatAllowDenyList(userData) {\n+\tconst allowList = Array.isArray(userData.settings.chatAllowList) ? userData.settings.chatAllowList : [];\n+\tconst denyList = Array.isArray(userData.settings.chatDenyList) ? userData.settings.chatDenyList : [];\n+\n \tconst [chatAllowListUsers, chatDenyListUsers] = await Promise.all([\n-\t\tuser.getUsersFields(userData.settings.chatAllowList, ['uid', 'username', 'picture']),\n-\t\tuser.getUsersFields(userData.settings.chatDenyList, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(allowList, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(denyList, ['uid', 'username', 'picture']),\n \t]);\n \n \tuserData.settings.chatAllowListUsers = chatAllowListUsers;\n \tuserData.settings.chatDenyListUsers = chatDenyListUsers;\n-};\n+\n+\treturn userData;\n+};"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/user/settings.js": [
                    "line: 79\nline: 92\nline: 93\nfunction: User.saveSettings"
                ],
                "src/controllers/accounts/settings.js": [
                    "function: getChatAllowDenyList"
                ],
                "src/messaging/create.js": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/controllers/accounts/settings.js b/src/controllers/accounts/settings.js\nindex 97b2163..04f418e 100644\n--- a/src/controllers/accounts/settings.js\n+++ b/src/controllers/accounts/settings.js\n@@ -264,4 +264,6 @@ async function getChatAllowDenyList(userData) {\n \n \tuserData.settings.chatAllowListUsers = chatAllowListUsers;\n \tuserData.settings.chatDenyListUsers = chatDenyListUsers;\n-};\n+\n+\treturn userData;\n+};\ndiff --git a/src/user/settings.js b/src/user/settings.js\nindex 4916aa9..fa52acf 100644\n--- a/src/user/settings.js\n+++ b/src/user/settings.js\n@@ -96,7 +96,18 @@ module.exports = function (User) {\n \n \tfunction parseJSONSetting(value, defaultValue) {\n \t\ttry {\n-\t\t\treturn JSON.parse(value);\n+\t\t\t// If already an array, return as-is\n+\t\t\tif (Array.isArray(value)) {\n+\t\t\t\treturn value;\n+\t\t\t}\n+\n+\t\t\t// Only parse strings, otherwise fall back to default\n+\t\t\tif (typeof value !== 'string') {\n+\t\t\t\treturn defaultValue;\n+\t\t\t}\n+\n+\t\t\tconst parsed = JSON.parse(value);\n+\t\t\treturn Array.isArray(parsed) ? parsed : defaultValue;\n \t\t} catch (err) {\n \t\t\treturn defaultValue;\n \t\t}",
                "diff --git a/src/controllers/accounts/settings.js b/src/controllers/accounts/settings.js\nindex 97b2163..88db9ea 100644\n--- a/src/controllers/accounts/settings.js\n+++ b/src/controllers/accounts/settings.js\n@@ -264,4 +264,5 @@ async function getChatAllowDenyList(userData) {\n \n \tuserData.settings.chatAllowListUsers = chatAllowListUsers;\n \tuserData.settings.chatDenyListUsers = chatDenyListUsers;\n-};\n+\treturn { chatAllowListUsers, chatDenyListUsers };\n+};\ndiff --git a/src/user/settings.js b/src/user/settings.js\nindex 4916aa9..43582df 100644\n--- a/src/user/settings.js\n+++ b/src/user/settings.js\n@@ -96,7 +96,13 @@ module.exports = function (User) {\n \n \tfunction parseJSONSetting(value, defaultValue) {\n \t\ttry {\n-\t\t\treturn JSON.parse(value);\n+\t\t\tif (Array.isArray(value)) {\n+\t\t\t\treturn value;\n+\t\t\t}\n+\t\t\tif (typeof value === 'string') {\n+\t\t\t\treturn JSON.parse(value);\n+\t\t\t}\n+\t\t\treturn defaultValue;\n \t\t} catch (err) {\n \t\t\treturn defaultValue;\n \t\t}"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/controllers/accounts/settings.js b/src/controllers/accounts/settings.js\nindex 97b2163..dae7080 100644\n--- a/src/controllers/accounts/settings.js\n+++ b/src/controllers/accounts/settings.js\n@@ -257,11 +257,16 @@ async function getSkinOptions(userData) {\n }\n \n async function getChatAllowDenyList(userData) {\n+\tconst allowListUids = Array.isArray(userData.settings.chatAllowList) ? userData.settings.chatAllowList : [];\n+\tconst denyListUids = Array.isArray(userData.settings.chatDenyList) ? userData.settings.chatDenyList : [];\n+\n \tconst [chatAllowListUsers, chatDenyListUsers] = await Promise.all([\n-\t\tuser.getUsersFields(userData.settings.chatAllowList, ['uid', 'username', 'picture']),\n-\t\tuser.getUsersFields(userData.settings.chatDenyList, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(allowListUids, ['uid', 'username', 'picture']),\n+\t\tuser.getUsersFields(denyListUids, ['uid', 'username', 'picture']),\n \t]);\n \n \tuserData.settings.chatAllowListUsers = chatAllowListUsers;\n \tuserData.settings.chatDenyListUsers = chatDenyListUsers;\n-};\n+\n+\treturn { chatAllowListUsers, chatDenyListUsers };\n+};"
}