{
    "instance_id": "SWE-Bench-Pro__javascript__maintenance__bugfix__5c001746",
    "original_id": "instance_element-hq__element-web-aeabf3b18896ac1eb7ae9757e66ce886120f8309-vnan",
    "1_model_selected_files": [
        "src/utils/EventRenderingUtils.ts",
        "src/stores/room-list/MessagePreviewStore.ts",
        "src/stores/room-list/previews/utils.ts",
        "src/stores/room-list/previews/MessageEventPreview.ts",
        "src/hooks/usePinnedEvents.ts"
    ],
    "2_embedding_selected_files": [
        "src/stores/room-list/previews/MessageEventPreview.ts",
        "src/stores/room-list/MessagePreviewStore.ts",
        "playwright/e2e/threads/threads.spec.ts",
        "playwright/e2e/timeline/timeline.spec.ts",
        "src/stores/room-list/previews/PollStartEventPreview.ts",
        "playwright/e2e/read-receipts/new-messages-thread-roots.spec.ts",
        "src/stores/room-list/previews/VoiceBroadcastPreview.ts",
        "src/stores/room-list/previews/StickerEventPreview.ts",
        "playwright/e2e/messages/messages.spec.ts",
        "src/stores/room-list/previews/LegacyCallInviteEventPreview.ts",
        "playwright/e2e/read-receipts/redactions-thread-roots.spec.ts",
        "src/stores/room-list/previews/ReactionEventPreview.ts",
        "src/stores/room-list/previews/IPreview.ts",
        "src/stores/room-list/previews/LegacyCallAnswerEventPreview.ts",
        "playwright/e2e/read-receipts/editing-messages-thread-roots.spec.ts",
        "playwright/e2e/read-receipts/new-messages-in-threads.spec.ts",
        "playwright/e2e/spaces/threads-activity-centre/threadsActivityCentre.spec.ts",
        "playwright/e2e/read-receipts/missing-referents.spec.ts",
        "src/components/views/rooms/wysiwyg_composer/utils/createMessageContent.ts",
        "playwright/e2e/read-receipts/high-level.spec.ts",
        "src/components/views/messages/IBodyProps.ts",
        "playwright/e2e/composer/RTE.spec.ts",
        "playwright/e2e/read-receipts/redactions-in-threads.spec.ts",
        "playwright/e2e/spaces/threads-activity-centre/index.ts",
        "playwright/e2e/read-receipts/editing-messages-in-threads.spec.ts",
        "playwright/e2e/editing/editing.spec.ts",
        "playwright/e2e/pinned-messages/pinned-messages.spec.ts",
        "src/utils/Reply.ts",
        "src/Unread.ts",
        "playwright/e2e/polls/polls.spec.ts",
        "playwright/e2e/read-receipts/reactions-thread-roots.spec.ts",
        "playwright/e2e/settings/appearance-user-settings-tab/message-layout-panel.ts",
        "playwright/e2e/read-receipts/reactions-in-threads.spec.ts",
        "playwright/e2e/crypto/decryption-failure-messages.spec.ts",
        "src/components/views/spaces/threads-activity-centre/useUnreadThreadRooms.ts",
        "src/contexts/RoomContext.ts",
        "src/stores/room-list/previews/utils.ts",
        "playwright/e2e/read-receipts/notifications.spec.ts",
        "playwright/e2e/read-receipts/index.ts",
        "src/ContentMessages.ts",
        "playwright/e2e/audio-player/audio-player.spec.ts",
        "src/stores/room-list/previews/LegacyCallHangupEvent.ts",
        "playwright/e2e/pinned-messages/index.ts",
        "playwright/e2e/read-receipts/editing-messages-main-timeline.spec.ts",
        "src/components/views/spaces/threads-activity-centre/index.ts",
        "playwright/e2e/read-receipts/read-receipts.spec.ts",
        "playwright/e2e/read-receipts/new-messages-main-timeline.spec.ts",
        "playwright/e2e/sliding-sync/sliding-sync.spec.ts",
        "src/dispatcher/payloads/ShowThreadPayload.ts",
        "src/usercontent/index.ts",
        "playwright/e2e/read-receipts/message-ordering.spec.ts",
        "playwright/e2e/permalinks/permalinks.spec.ts",
        "src/hooks/room/useRoomThreadNotifications.ts"
    ],
    "3_final_combined_files": [
        "src/stores/room-list/MessagePreviewStore.ts",
        "src/utils/EventRenderingUtils.ts",
        "src/stores/room-list/previews/utils.ts",
        "src/stores/room-list/previews/MessageEventPreview.ts",
        "playwright/e2e/threads/threads.spec.ts"
    ],
    "4_related_elements": {
        "src/stores/room-list/MessagePreviewStore.ts": [
            "class: MessagePreviewStore\nvariable: PREVIEWS\nfunction: isThreadReply\nfunction: mkMessagePreview"
        ],
        "src/stores/room-list/previews/utils.ts": [
            "function: shouldPrefixMessagesIn\nfunction: isSelf\nfunction: getSenderName"
        ],
        "src/utils/EventRenderingUtils.ts": [
            "function: getEventDisplayInfo\nfunction: calcIsInfoMessage"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/stores/room-list/MessagePreviewStore.ts": [
                    "function: MessagePreviewStore.generatePreviewForEvent\nline: 177\nfunction: MessagePreviewStore.generatePreview\nline: 222\nline: 231\nline: 238"
                ],
                "src/stores/room-list/previews/utils.ts": [
                    "function: shouldPrefixMessagesIn"
                ],
                "src/utils/EventRenderingUtils.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/stores/room-list/MessagePreviewStore.ts b/src/stores/room-list/MessagePreviewStore.ts\nindex 092428b..75b84bc 100644\n--- a/src/stores/room-list/MessagePreviewStore.ts\n+++ b/src/stores/room-list/MessagePreviewStore.ts\n@@ -174,7 +174,8 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n \n     public generatePreviewForEvent(event: MatrixEvent): string {\n         const previewDef = PREVIEWS[event.getType()];\n-        return previewDef?.previewer.getTextFor(event, undefined, true) ?? \"\";\n+        // Use default preview generation which includes appropriate type prefixes\n+        return previewDef?.previewer.getTextFor(event) ?? \"\";\n     }\n \n     private async generatePreview(room: Room, tagId?: TagID): Promise<void> {\n@@ -235,7 +236,7 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n                     map.delete(genTagId);\n                 } else {\n                     changed = changed || preview !== map.get(genTagId)?.text;\n-                    map.set(genTagId, preview ? mkMessagePreview(anyPreviewText, event) : null);\n+                    map.set(genTagId, preview ? mkMessagePreview(preview, event) : null);\n                 }\n             }",
                "diff --git a/src/stores/room-list/MessagePreviewStore.ts b/src/stores/room-list/MessagePreviewStore.ts\nindex 092428b..d1f3d16 100644\n--- a/src/stores/room-list/MessagePreviewStore.ts\n+++ b/src/stores/room-list/MessagePreviewStore.ts\n@@ -174,7 +174,8 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n \n     public generatePreviewForEvent(event: MatrixEvent): string {\n         const previewDef = PREVIEWS[event.getType()];\n-        return previewDef?.previewer.getTextFor(event, undefined, true) ?? \"\";\n+        // Use default preview generation so type prefixes and i18n are consistent across contexts\n+        return previewDef?.previewer.getTextFor(event) ?? \"\";\n     }\n \n     private async generatePreview(room: Room, tagId?: TagID): Promise<void> {\n@@ -235,7 +236,8 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n                     map.delete(genTagId);\n                 } else {\n                     changed = changed || preview !== map.get(genTagId)?.text;\n-                    map.set(genTagId, preview ? mkMessagePreview(anyPreviewText, event) : null);\n+                    // Store the tag-specific preview text, not the generic one\n+                    map.set(genTagId, preview ? mkMessagePreview(preview, event) : null);\n                 }\n             }"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/stores/room-list/MessagePreviewStore.ts": [
                    "function: MessagePreviewStore.generatePreviewForEvent\nline: 231\nline: 239\nfunction: ThreadListItem.getEventPreview\nfunction: ThreadListItem.render\nfunction: ThreadTile.getReplyPreview\nfunction: ThreadTile.render\nfunction: RoomPinnedMessagesBar.renderPinnedEventPreview"
                ],
                "src/utils/EventRenderingUtils.ts": [
                    ""
                ],
                "src/stores/room-list/previews/utils.ts": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/stores/room-list/MessagePreviewStore.ts b/src/stores/room-list/MessagePreviewStore.ts\nindex 092428b..cba5497 100644\n--- a/src/stores/room-list/MessagePreviewStore.ts\n+++ b/src/stores/room-list/MessagePreviewStore.ts\n@@ -219,7 +219,7 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n             if (!previewDef) continue;\n             if (previewDef.isState && isNullOrUndefined(event.getStateKey())) continue;\n \n-            const anyPreviewText = previewDef.previewer.getTextFor(event);\n+            const anyPreviewText = previewDef.previewer.getTextFor(event, undefined, true);\n             if (!anyPreviewText) continue; // not previewable for some reason\n \n             changed = changed || anyPreviewText !== map.get(TAG_ANY)?.text;\n@@ -228,14 +228,14 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n             const tagsToGenerate = Array.from(map.keys()).filter((t) => t !== TAG_ANY); // we did the any tag above\n             for (const genTagId of tagsToGenerate) {\n                 const realTagId = genTagId === TAG_ANY ? undefined : genTagId;\n-                const preview = previewDef.previewer.getTextFor(event, realTagId);\n+                const preview = previewDef.previewer.getTextFor(event, realTagId, true);\n \n                 if (preview === anyPreviewText) {\n                     changed = changed || anyPreviewText !== map.get(genTagId)?.text;\n                     map.delete(genTagId);\n                 } else {\n                     changed = changed || preview !== map.get(genTagId)?.text;\n-                    map.set(genTagId, preview ? mkMessagePreview(anyPreviewText, event) : null);\n+                    map.set(genTagId, preview ? mkMessagePreview(preview, event) : null);\n                 }\n             }"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/stores/room-list/MessagePreviewStore.ts b/src/stores/room-list/MessagePreviewStore.ts\nindex 092428b..75b84bc 100644\n--- a/src/stores/room-list/MessagePreviewStore.ts\n+++ b/src/stores/room-list/MessagePreviewStore.ts\n@@ -174,7 +174,8 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n \n     public generatePreviewForEvent(event: MatrixEvent): string {\n         const previewDef = PREVIEWS[event.getType()];\n-        return previewDef?.previewer.getTextFor(event, undefined, true) ?? \"\";\n+        // Use default preview generation which includes appropriate type prefixes\n+        return previewDef?.previewer.getTextFor(event) ?? \"\";\n     }\n \n     private async generatePreview(room: Room, tagId?: TagID): Promise<void> {\n@@ -235,7 +236,7 @@ export class MessagePreviewStore extends AsyncStoreWithClient<IState> {\n                     map.delete(genTagId);\n                 } else {\n                     changed = changed || preview !== map.get(genTagId)?.text;\n-                    map.set(genTagId, preview ? mkMessagePreview(anyPreviewText, event) : null);\n+                    map.set(genTagId, preview ? mkMessagePreview(preview, event) : null);\n                 }\n             }"
}