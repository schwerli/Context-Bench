{
    "instance_id": "SWE-Bench-Pro__javascript__maintenance__bugfix__7b6185af",
    "original_id": "instance_NodeBB__NodeBB-767973717be700f46f06f3e7f4fc550c63509046-vnan",
    "1_model_selected_files": [],
    "2_embedding_selected_files": [
        "src/database/postgres/hash.js",
        "src/database/mongo/hash.js",
        "src/upgrades/3.8.3/topic-event-ids.js",
        "src/upgrades/1.17.0/topic_thumb_count.js",
        "src/upgrades/1.15.0/add_target_uid_to_flags.js",
        "src/upgrades/4.3.0/topic_follower_counts.js",
        "src/upgrades/1.7.3/topic_votes.js",
        "src/upgrades/1.1.0/group_title_update.js",
        "src/upgrades/1.15.0/consolidate_flags.js",
        "src/upgrades/1.17.0/subcategories_per_page.js",
        "src/upgrades/1.12.1/moderation_notes_refactor.js",
        "src/upgrades/1.18.0/topic_tags_refactor.js",
        "src/upgrades/1.5.0/moderation_history_refactor.js",
        "src/upgrades/4.5.0/topic-thumbs-to-hash.js",
        "src/database/postgres/sorted/add.js",
        "src/upgrades/1.15.0/topic_poster_count.js",
        "src/upgrades/4.3.0/normalize_thumbs_uploads.js",
        "src/upgrades/3.3.0/chat_message_mids.js",
        "src/upgrades/4.5.0/post-uploads-to-hash.js",
        "src/upgrades/1.5.0/flags_refactor.js",
        "src/upgrades/3.3.0/chat_room_refactor.js",
        "src/upgrades/1.18.4/category_topics_views.js",
        "src/upgrades/1.14.0/fix_category_image_field.js",
        "src/user/posts.js",
        "src/upgrades/1.19.3/rename_post_upload_hashes.js",
        "src/upgrades/1.16.0/category_tags.js",
        "src/upgrades/3.8.0/events-uid-filter.js",
        "src/upgrades/3.11.0/default-custom-profile-fields.js",
        "src/database/mongo/sorted/add.js",
        "src/upgrades/1.5.0/post_votes_zset.js",
        "src/upgrades/3.5.0/notification_translations.js",
        "src/upgrades/1.1.0/user_post_count_per_tid.js",
        "src/upgrades/1.17.0/category_name_zset.js",
        "src/upgrades/1.5.2/tags_privilege.js",
        "src/upgrades/1.15.0/track_flags_by_target.js",
        "src/upgrades/1.6.2/topics_lastposttime_zset.js",
        "src/upgrades/1.15.0/fullname_search_set.js",
        "src/upgrades/3.6.0/category_tracking.js",
        "src/upgrades/4.0.0/regenerate_slugs_for_users_with_periods.js",
        "src/upgrades/1.16.0/migrate_thumbs.js",
        "src/upgrades/1.10.2/fix_category_topic_zsets.js",
        "src/upgrades/3.7.0/category-tid-created-zset.js",
        "src/upgrades/1.4.0/global_and_user_language_keys.js",
        "src/upgrades/1.7.3/key_value_schema_change.js",
        "src/upgrades/1.0.0/user_best_posts.js",
        "src/upgrades/3.8.0/remove-privilege-slugs.js",
        "src/upgrades/1.7.4/fix_moved_topics_byvotes.js",
        "src/upgrades/1.12.1/post_upload_sizes.js",
        "src/upgrades/1.0.0/global_moderators.js",
        "src/upgrades/1.10.2/fix_category_post_zsets.js",
        "src/upgrades/1.1.0/separate_upvote_downvote.js",
        "src/upgrades/1.13.3/fix_users_sorted_sets.js",
        "src/upgrades/3.7.0/change-category-sort-settings.js",
        "src/upgrades/3.6.0/rename_newbie_config.js",
        "src/upgrades/1.18.0/enable_include_unverified_emails.js",
        "src/upgrades/1.13.0/clean_post_topic_hash.js",
        "src/upgrades/1.14.1/readd_deleted_recent_topics.js",
        "src/upgrades/1.12.3/user_pid_sets.js",
        "src/upgrades/1.9.0/refresh_post_upload_associations.js",
        "src/batch.js",
        "src/topics/tags.js",
        "src/upgrades/1.19.0/navigation-enabled-hashes.js",
        "src/topics/data.js",
        "src/upgrades/1.3.0/sorted_sets_for_post_replies.js",
        "src/posts/delete.js",
        "src/categories/update.js",
        "src/upgrades/1.19.2/store_downvoted_posts_in_zset.js",
        "src/flags.js",
        "src/upgrades/3.2.0/migrate_api_tokens.js",
        "src/controllers/accounts/helpers.js",
        "src/topics/posts.js",
        "src/upgrades/1.1.1/upload_privileges.js",
        "src/upgrades/1.5.1/rename_mods_group.js",
        "src/upgrades/3.3.0/chat_room_owners.js",
        "src/upgrades/1.15.0/verified_users_group.js",
        "src/upgrades/1.11.0/resize_image_width.js",
        "src/upgrades/1.8.1/diffs_zset_to_listhash.js",
        "src/groups/update.js",
        "src/database/mongo/sorted.js",
        "src/upgrades/3.8.2/vote-visibility-config.js",
        "src/upgrades/3.3.0/chat_room_online_zset.js",
        "src/upgrades/3.8.0/user-upload-folders.js",
        "src/categories/data.js",
        "src/upgrades/3.6.0/chat_message_counts.js",
        "src/upgrades/4.3.0/chat_allow_list.js",
        "src/upgrades/1.4.0/sorted_set_for_pinned_topics.js",
        "src/upgrades/1.7.4/rename_min_reputation_settings.js",
        "src/upgrades/3.8.4/downvote-visibility-config.js",
        "src/upgrades/3.3.0/save_rooms_zset.js",
        "src/upgrades/1.7.4/fix_user_topics_per_category.js",
        "src/upgrades/1.0.0/users_notvalidated.js",
        "src/upgrades/1.17.0/banned_users_group.js",
        "src/upgrades/1.10.2/upgrade_bans_to_hashes.js"
    ],
    "3_final_combined_files": [
        "src/database/postgres/hash.js",
        "src/database/mongo/hash.js",
        "src/upgrades/3.8.3/topic-event-ids.js"
    ],
    "4_related_elements": {
        "src/database/postgres/hash.js": [
            "function: incrObjectFieldByBulk\nfunction: incrObjectFieldBy\nfunction: setObjectBulk"
        ],
        "src/database/mongo/hash.js": [
            "function: incrObjectFieldByBulk\nfunction: incrObjectFieldBy\nfunction: getObjectsFields\nvariable: module.objectCache"
        ],
        "src/upgrades/3.8.3/topic-event-ids.js": [
            ""
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/database/postgres/hash.js": [
                    "function: module.incrObjectFieldByBulk\nline: 392"
                ],
                "src/database/mongo/hash.js": [
                    ""
                ],
                "src/upgrades/3.8.3/topic-event-ids.js": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/database/postgres/hash.js b/src/database/postgres/hash.js\nindex e36d673..0a1cbf2 100644\n--- a/src/database/postgres/hash.js\n+++ b/src/database/postgres/hash.js\n@@ -391,16 +391,23 @@ INSERT INTO \"legacy_hash\" (\"_key\", \"data\")\n SELECT k, d\n FROM UNNEST($1::TEXT[], $2::JSONB[]) vs(k, d)\n ON CONFLICT (\"_key\")\n-DO UPDATE SET \"data\" = (\n+DO UPDATE SET \"data\" = COALESCE((\n     SELECT jsonb_object_agg(\n         key,\n         CASE\n             WHEN jsonb_typeof(legacy_hash.data -> key) = 'number'\n                  AND jsonb_typeof(EXCLUDED.data -> key) = 'number'\n-            THEN to_jsonb((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC)\n-            ELSE COALESCE(EXCLUDED.data -> key, legacy_hash.data -> key)\n+            THEN to_jsonb(((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC))\n+            WHEN EXCLUDED.data ? key\n+            THEN EXCLUDED.data -> key\n+            ELSE legacy_hash.data -> key\n         END\n     )\n+    FROM jsonb_object_keys(\n+        COALESCE(legacy_hash.data, '{}'::JSONB) || COALESCE(EXCLUDED.data, '{}'::JSONB)\n+    ) AS ks(key)\n+), COALESCE(legacy_hash.data, '{}'::JSONB)\n+    )\n     FROM jsonb_each(legacy_hash.data || EXCLUDED.data) AS merged(key, value)\n );`,\n \t\t\t\tvalues: [keys, dataStrings],",
                "diff --git a/src/database/postgres/hash.js b/src/database/postgres/hash.js\nindex e36d673..8b6f004 100644\n--- a/src/database/postgres/hash.js\n+++ b/src/database/postgres/hash.js\n@@ -398,7 +398,7 @@ DO UPDATE SET \"data\" = (\n             WHEN jsonb_typeof(legacy_hash.data -> key) = 'number'\n                  AND jsonb_typeof(EXCLUDED.data -> key) = 'number'\n             THEN to_jsonb((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC)\n-            ELSE COALESCE(EXCLUDED.data -> key, legacy_hash.data -> key)\n+            ELSE COALESCE(legacy_hash.data -> key, EXCLUDED.data -> key)\n         END\n     )\n     FROM jsonb_each(legacy_hash.data || EXCLUDED.data) AS merged(key, value)"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/database/postgres/hash.js": [
                    "function: module.incrObjectFieldByBulk\nline: 392"
                ],
                "src/database/mongo/hash.js": [
                    ""
                ],
                "src/upgrades/3.8.3/topic-event-ids.js": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/src/database/postgres/hash.js b/src/database/postgres/hash.js\nindex e36d673..ae3572e 100644\n--- a/src/database/postgres/hash.js\n+++ b/src/database/postgres/hash.js\n@@ -392,14 +392,20 @@ SELECT k, d\n FROM UNNEST($1::TEXT[], $2::JSONB[]) vs(k, d)\n ON CONFLICT (\"_key\")\n DO UPDATE SET \"data\" = (\n-    SELECT jsonb_object_agg(\n-        key,\n-        CASE\n-            WHEN jsonb_typeof(legacy_hash.data -> key) = 'number'\n-                 AND jsonb_typeof(EXCLUDED.data -> key) = 'number'\n-            THEN to_jsonb((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC)\n-            ELSE COALESCE(EXCLUDED.data -> key, legacy_hash.data -> key)\n-        END\n+    SELECT COALESCE(\n+        jsonb_object_agg(\n+            key,\n+            CASE\n+                WHEN jsonb_typeof(l.value) = 'number'\n+                     AND jsonb_typeof(e.value) = 'number'\n+                THEN to_jsonb(((l.value)::TEXT::NUMERIC + (e.value)::TEXT::NUMERIC))\n+                ELSE COALESCE(e.value, l.value)\n+            END\n+        ),\n+        '{}'::JSONB\n+    )\n+    FROM jsonb_each(COALESCE(legacy_hash.data, '{}'::JSONB)) AS l(key, value)\n+    FULL JOIN jsonb_each(COALESCE(EXCLUDED.data, '{}'::JSONB)) AS e(key, value) USING (key)\n     )\n     FROM jsonb_each(legacy_hash.data || EXCLUDED.data) AS merged(key, value)\n );`,",
                "diff --git a/src/database/postgres/hash.js b/src/database/postgres/hash.js\nindex e36d673..a39e613 100644\n--- a/src/database/postgres/hash.js\n+++ b/src/database/postgres/hash.js\n@@ -401,6 +401,8 @@ DO UPDATE SET \"data\" = (\n             ELSE COALESCE(EXCLUDED.data -> key, legacy_hash.data -> key)\n         END\n     )\n+    FROM jsonb_object_keys(COALESCE(legacy_hash.data, '{}'::jsonb) || COALESCE(EXCLUDED.data, '{}'::jsonb)) AS t(key)\n+    )\n     FROM jsonb_each(legacy_hash.data || EXCLUDED.data) AS merged(key, value)\n );`,\n \t\t\t\tvalues: [keys, dataStrings],"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/database/postgres/hash.js b/src/database/postgres/hash.js\nindex e36d673..0a1cbf2 100644\n--- a/src/database/postgres/hash.js\n+++ b/src/database/postgres/hash.js\n@@ -391,16 +391,23 @@ INSERT INTO \"legacy_hash\" (\"_key\", \"data\")\n SELECT k, d\n FROM UNNEST($1::TEXT[], $2::JSONB[]) vs(k, d)\n ON CONFLICT (\"_key\")\n-DO UPDATE SET \"data\" = (\n+DO UPDATE SET \"data\" = COALESCE((\n     SELECT jsonb_object_agg(\n         key,\n         CASE\n             WHEN jsonb_typeof(legacy_hash.data -> key) = 'number'\n                  AND jsonb_typeof(EXCLUDED.data -> key) = 'number'\n-            THEN to_jsonb((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC)\n-            ELSE COALESCE(EXCLUDED.data -> key, legacy_hash.data -> key)\n+            THEN to_jsonb(((legacy_hash.data ->> key)::NUMERIC + (EXCLUDED.data ->> key)::NUMERIC))\n+            WHEN EXCLUDED.data ? key\n+            THEN EXCLUDED.data -> key\n+            ELSE legacy_hash.data -> key\n         END\n     )\n+    FROM jsonb_object_keys(\n+        COALESCE(legacy_hash.data, '{}'::JSONB) || COALESCE(EXCLUDED.data, '{}'::JSONB)\n+    ) AS ks(key)\n+), COALESCE(legacy_hash.data, '{}'::JSONB)\n+    )\n     FROM jsonb_each(legacy_hash.data || EXCLUDED.data) AS merged(key, value)\n );`,\n \t\t\t\tvalues: [keys, dataStrings],"
}