{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__64fffdfa",
    "original_id": "instance_qutebrowser__qutebrowser-473a15f7908f2bb6d670b0e908ab34a28d8cf7e2-v363c8a7e5ccdf6968fc7ab84a2053ac78036691d",
    "1_model_selected_files": [
        "qutebrowser/misc/earlyinit.py",
        "qutebrowser/config/qtargs.py",
        "qutebrowser/config/configdata.py",
        "qutebrowser/utils/version.py",
        "qutebrowser/app.py"
    ],
    "2_embedding_selected_files": [
        "qutebrowser/misc/backendproblem.py",
        "qutebrowser/browser/webengine/webview.py",
        "qutebrowser/browser/webengine/webenginetab.py",
        "qutebrowser/browser/webengine/webenginesettings.py",
        "qutebrowser/misc/earlyinit.py",
        "qutebrowser/browser/webengine/spell.py",
        "qutebrowser/browser/webengine/webenginequtescheme.py",
        "qutebrowser/browser/webengine/__init__.py",
        "qutebrowser/browser/webkit/network/webkitqutescheme.py",
        "qutebrowser/resources.py",
        "qutebrowser/utils/qtutils.py",
        "qutebrowser/browser/webengine/webengineinspector.py",
        "qutebrowser/misc/crashdialog.py",
        "qutebrowser/misc/crashsignal.py",
        "scripts/dev/build_release.py",
        "qutebrowser/utils/utils.py",
        "qutebrowser/browser/webkit/webpage.py"
    ],
    "3_final_combined_files": [
        "qutebrowser/misc/earlyinit.py",
        "qutebrowser/config/qtargs.py",
        "qutebrowser/config/configdata.py",
        "qutebrowser/misc/backendproblem.py",
        "qutebrowser/browser/webengine/webview.py",
        "qutebrowser/browser/webengine/webenginetab.py"
    ],
    "4_related_elements": {
        "qutebrowser/config/qtargs.py": [
            "function: qt_args\nfunction: _qtwebengine_args\nfunction: _qtwebengine_features\nfunction: _qtwebengine_settings_args\nfunction: _warn_qtwe_flags_envvar\nfunction: init_envvars"
        ],
        "qutebrowser/misc/earlyinit.py": [
            "function: qt_version\nfunction: check_qt_version\nfunction: early_init"
        ],
        "qutebrowser/config/configdata.py": [
            "variable: DATA\nvariable: MIGRATIONS\nclass: Option\nclass: Migrations\nfunction: _read_yaml\nfunction: is_valid_prefix\nfunction: _parse_yaml_type\nfunction: _parse_yaml_backends_dict\nfunction: _parse_yaml_backends\nfunction: init"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "qutebrowser/config/qtargs.py": [
                    "function: _qtwebengine_args\nline: 29\nfunction: _compute_locale_override\nline: add new option \"qt.workarounds.locale\""
                ],
                "qutebrowser/misc/earlyinit.py": [
                    ""
                ],
                "qutebrowser/config/configdata.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/qutebrowser/config/qtargs.py b/qutebrowser/config/qtargs.py\nindex 6fdc495..c3f2077 100644\n--- a/qutebrowser/config/qtargs.py\n+++ b/qutebrowser/config/qtargs.py\n@@ -1,3 +1,4 @@\n+\n # vim: ft=python fileencoding=utf-8 sts=4 sw=4 et:\n \n # Copyright 2014-2021 Florian Bruhin (The Compiler) <mail@qutebrowser.org>\n@@ -22,6 +23,7 @@\n import os\n import sys\n import argparse\n+import locale\n from typing import Any, Dict, Iterator, List, Optional, Sequence, Tuple\n \n from qutebrowser.config import config\n@@ -209,6 +211,164 @@ def _qtwebengine_args(\n \n     yield from _qtwebengine_settings_args(versions)\n \n+    # WORKAROUND for QtWebEngine 5.15.3 locale handling on Linux:\n+    # If enabled via qt.workarounds.locale, attempt to normalize the locale\n+    # passed to Chromium so that a matching qtwebengine_locales/*.pak exists.\n+    # See issue: Network service crash loop on certain locales.\n+    def _get_workaround_enabled() -> bool:\n+        # Prefer config.instance if available, fall back to config.val access\n+        try:\n+            return bool(config.instance.get('qt.workarounds.locale'))\n+        except Exception:\n+            try:\n+                qt_section = getattr(config.val, 'qt', None)\n+                workarounds = getattr(qt_section, 'workarounds', None)\n+                return bool(getattr(workarounds, 'locale', False))\n+            except Exception:\n+                return False\n+\n+    def _normalize_bcp47(code: str) -> Optional[str]:\n+        if not code:\n+            return None\n+        # LANGUAGE may be colon-separated; take first\n+        code = code.split(':', 1)[0]\n+        # Strip encoding and modifier\n+        code = code.split('.', 1)[0]\n+        code = code.split('@', 1)[0]\n+        code = code.strip()\n+        if not code:\n+            return None\n+        code = code.replace('_', '-')\n+        parts = code.split('-')\n+        lang = parts[0].lower() if parts and parts[0] else ''\n+        region = parts[1].upper() if len(parts) > 1 and parts[1] else ''\n+        if not lang:\n+            return None\n+        return f'{lang}-{region}' if region else lang\n+\n+    def _current_locale_code() -> Optional[str]:\n+        # Check common environment variables first\n+        for var in ('LC_ALL', 'LC_MESSAGES', 'LANG', 'LANGUAGE'):\n+            val = os.environ.get(var)\n+            norm = _normalize_bcp47(val) if val else None\n+            if norm:\n+                return norm\n+        # Fallback to Python's locale\n+        try:\n+            lang, _enc = locale.getdefaultlocale()\n+        except Exception:\n+            lang = None\n+        return _normalize_bcp47(lang) if lang else None\n+\n+    def _candidate_locale_dirs() -> List[str]:\n+        paths: List[str] = []\n+        env_path = os.environ.get('QTWEBENGINE_LOCALES_PATH')\n+        if env_path:\n+            paths.append(env_path)\n+\n+        # Try to derive from Qt installation\n+        try:\n+            from PyQt5.QtCore import QLibraryInfo  # type: ignore\n+            # Probe a few plausible base locations\n+            base_keys = []\n+            for key_name in ('DataPath', 'ArchDataPath', 'PrefixPath'):\n+                if hasattr(QLibraryInfo, key_name):\n+                    base_keys.append(getattr(QLibraryInfo, key_name))\n+            for key in base_keys:\n+                try:\n+                    base = QLibraryInfo.location(key)  # type: ignore\n+                except Exception:\n+                    base = ''\n+                if base:\n+                    paths.append(os.path.join(base, 'resources', 'qtwebengine_locales'))\n+                    paths.append(os.path.join(base, 'qtwebengine_locales'))\n+        except Exception:\n+            pass\n+\n+        # Try PyQt5 package layout\n+        try:\n+            import PyQt5  # type: ignore\n+            pyqt_base = os.path.dirname(PyQt5.__file__)\n+            for qt_dir in ('Qt5', 'Qt'):\n+                paths.append(os.path.join(pyqt_base, qt_dir, 'resources', 'qtwebengine_locales'))\n+        except Exception:\n+            pass\n+\n+        # Deduplicate and keep only existing directories\n+        uniq = []\n+        seen = set()\n+        for p in paths:\n+            if p not in seen and os.path.isdir(p):\n+                uniq.append(p)\n+                seen.add(p)\n+        return uniq\n+\n+    def _pak_exists(code: str, dirs: Sequence[str]) -> bool:\n+        if not code or not dirs:\n+            return False\n+        # Try common filename variants\n+        candidates = [\n+            f'{code}.pak',\n+            f'{code.lower()}.pak',\n+            f'{code.replace(\"-\", \"_\")}.pak',\n+            f'{code.lower().replace(\"-\", \"_\")}.pak',\n+        ]\n+        for d in dirs:\n+            for name in candidates:\n+                if os.path.isfile(os.path.join(d, name)):\n+                    return True\n+        return False\n+\n+    def _fallback_candidates(code: Optional[str]) -> List[str]:\n+        # Build a list of fallback locales to try, based on Chromium mappings.\n+        lang = ''\n+        region = ''\n+        if code:\n+            parts = code.split('-')\n+            lang = parts[0]\n+            region = parts[1] if len(parts) > 1 else ''\n+\n+        cands: List[str] = []\n+        # Handle special mappings\n+        if lang == 'en':\n+            cands.append('en-GB')\n+        elif lang == 'es':\n+            cands.append('es-419')\n+        elif lang == 'pt':\n+            if region:\n+                cands.append('pt-PT')\n+            else:\n+                cands.append('pt-BR')\n+        elif lang == 'zh':\n+            if region in ('HK', 'MO'):\n+                cands.append('zh-HK')\n+            elif region == 'TW':\n+                cands.append('zh-TW')\n+            else:\n+                cands.append('zh-CN')\n+\n+        # Language-only fallback\n+        if lang:\n+            cands.append(lang)\n+\n+        # Ultimate safe fallback\n+        if 'en-GB' not in cands:\n+            cands.append('en-GB')\n+\n+        return cands\n+\n+    if utils.is_linux and versions.webengine == utils.VersionNumber(5, 15, 3):\n+        if _get_workaround_enabled():\n+            current = _current_locale_code()\n+            locale_dirs = _candidate_locale_dirs()\n+\n+            # Only attempt override if we can determine locale dirs to check\n+            if current and locale_dirs and not _pak_exists(current, locale_dirs):\n+                for cand in _fallback_candidates(current):\n+                    if _pak_exists(cand, locale_dirs):\n+                        yield f'--lang={cand}'\n+                        break\n+\n \n def _qtwebengine_settings_args(versions: version.WebEngineVersions) -> Iterator[str]:\n     settings: Dict[str, Dict[Any, Optional[str]]] = {\n@@ -324,4 +484,4 @@ def init_envvars() -> None:\n         if val is None and var in os.environ:\n             del os.environ[var]\n         elif val is not None:\n-            os.environ[var] = val\n+            os.environ[var] = val\n",
                "diff --git a/qutebrowser/config/qtargs.py b/qutebrowser/config/qtargs.py\nindex 6fdc495..28935da 100644\n--- a/qutebrowser/config/qtargs.py\n+++ b/qutebrowser/config/qtargs.py\n@@ -1,3 +1,4 @@\n+\n # vim: ft=python fileencoding=utf-8 sts=4 sw=4 et:\n \n # Copyright 2014-2021 Florian Bruhin (The Compiler) <mail@qutebrowser.org>\n@@ -22,6 +23,7 @@\n import os\n import sys\n import argparse\n+import locale\n from typing import Any, Dict, Iterator, List, Optional, Sequence, Tuple\n \n from qutebrowser.config import config\n@@ -157,6 +159,204 @@ def _qtwebengine_features(\n     return (enabled_features, disabled_features)\n \n \n+# Locale workaround helpers for QtWebEngine 5.15.3 on Linux\n+def _canonicalize_bcp47(code: str) -> str:\n+    \"\"\"Normalize to a canonical-ish BCP47 used by Chromium .pak files.\"\"\"\n+    if not code:\n+        return code\n+    parts = code.split('-')\n+    lang = parts[0].lower()\n+    region = None\n+    for p in parts[1:]:\n+        if len(p) == 2 and p.isalpha():\n+            region = p.upper()\n+            break\n+        if p.isdigit():\n+            region = p  # e.g., 419\n+            break\n+    return f\"{lang}-{region}\" if region else lang\n+\n+\n+def _get_bcp47_locale() -> Optional[str]:\n+    \"\"\"Get the current system locale as a BCP47-like tag.\"\"\"\n+    loc = None\n+    for var in ('LC_ALL', 'LC_MESSAGES', 'LANG'):\n+        val = os.environ.get(var)\n+        if val:\n+            loc = val\n+            break\n+    if not loc:\n+        try:\n+            # getdefaultlocale may return (language_code, encoding)\n+            default = locale.getdefaultlocale()\n+            if isinstance(default, tuple):\n+                loc = default[0]\n+            else:\n+                loc = default\n+        except Exception:\n+            loc = None\n+    if not loc:\n+        return None\n+    loc = loc.strip()\n+    if not loc:\n+        return None\n+    # Strip encoding and modifiers\n+    loc = loc.split('.')[0]\n+    loc = loc.split('@')[0]\n+    # Normalize separators\n+    loc = loc.replace('_', '-')\n+    return _canonicalize_bcp47(loc)\n+\n+\n+def _qtwe_locales_dirs() -> List[str]:\n+    \"\"\"Best-effort detection of QtWebEngine locales directories.\"\"\"\n+    dirs: List[str] = []\n+    env_dir = os.environ.get('QTWEBENGINE_LOCALES_PATH')\n+    if env_dir:\n+        dirs.append(env_dir)\n+\n+    try:\n+        # Try to build typical paths based on Qt installation\n+        from PyQt5.QtCore import QLibraryInfo\n+        # DataPath often points to .../share/qt5\n+        data_path = QLibraryInfo.location(QLibraryInfo.DataPath)\n+        if data_path:\n+            cand = os.path.join(data_path, 'resources', 'qtwebengine_locales')\n+            dirs.append(cand)\n+\n+        # PrefixPath e.g. /usr\n+        prefix_path = QLibraryInfo.location(QLibraryInfo.PrefixPath)\n+        if prefix_path:\n+            cand = os.path.join(prefix_path, 'resources', 'qtwebengine_locales')\n+            dirs.append(cand)\n+\n+        # LibraryExecutablesPath often .../libexec\n+        libexec_path = QLibraryInfo.location(QLibraryInfo.LibraryExecutablesPath)\n+        if libexec_path:\n+            # ../resources/qtwebengine_locales next to libexec\n+            cand = os.path.normpath(os.path.join(libexec_path, '..', 'resources', 'qtwebengine_locales'))\n+            dirs.append(cand)\n+            # Or sibling resources dir\n+            cand2 = os.path.join(os.path.dirname(libexec_path), 'resources', 'qtwebengine_locales')\n+            dirs.append(cand2)\n+    except Exception:\n+        # If PyQt5 isn't importable yet or anything else fails, ignore.\n+        pass\n+\n+    # Deduplicate while preserving order and only keep existing directories\n+    seen = set()\n+    result: List[str] = []\n+    for d in dirs:\n+        if not d:\n+            continue\n+        if d in seen:\n+            continue\n+        seen.add(d)\n+        if os.path.isdir(d):\n+            result.append(d)\n+    return result\n+\n+\n+def _locale_pak_exists(code: str) -> bool:\n+    \"\"\"Check whether a .pak file for the given locale exists.\"\"\"\n+    if not code:\n+        return False\n+    dirs = _qtwe_locales_dirs()\n+    # If we can't determine dirs, we can't reliably say it exists.\n+    if not dirs:\n+        return False\n+    candidates = [f\"{code}.pak\"]\n+    # Some distros might lowercase filenames; check a lowercase variant too.\n+    candidates.append(f\"{code.lower()}.pak\")\n+    for d in dirs:\n+        for fname in candidates:\n+            if os.path.isfile(os.path.join(d, fname)):\n+                return True\n+    return False\n+\n+\n+def _chromium_locale_fallbacks(code: str) -> List[str]:\n+    \"\"\"Return a list of reasonable fallback locales for Chromium .pak files.\"\"\"\n+    code = _canonicalize_bcp47(code)\n+    parts = code.split('-')\n+    lang = parts[0]\n+    region = parts[1] if len(parts) > 1 else None\n+    fallbacks: List[str] = []\n+\n+    if lang == 'en':\n+        # Prefer en-GB on Linux Chromium/QtWebEngine builds\n+        fallbacks += ['en-GB', 'en']\n+    elif lang == 'es':\n+        # Use Latin American Spanish pack if available\n+        fallbacks += ['es-419', 'es']\n+    elif lang == 'pt':\n+        if region is None:\n+            # Bare 'pt' -> pt-BR first (Chromium mapping), then pt-PT, then pt\n+            fallbacks += ['pt-BR', 'pt-PT', 'pt']\n+        else:\n+            # Any pt-* -> prefer pt-PT then pt-BR, then language-only\n+            fallbacks += ['pt-PT', 'pt-BR', 'pt']\n+    elif lang == 'zh':\n+        # Common Chinese mappings\n+        if region == 'HK':\n+            fallbacks += ['zh-HK', 'zh-TW', 'zh-CN', 'zh']\n+        elif region in ('TW', 'MO'):\n+            fallbacks += ['zh-TW', 'zh-CN', 'zh']\n+        else:\n+            fallbacks += ['zh-CN', 'zh-TW', 'zh']\n+    else:\n+        # Generic language-only fallback\n+        fallbacks.append(lang)\n+\n+    # Deduplicate while preserving order\n+    seen = set()\n+    result: List[str] = []\n+    for fb in fallbacks:\n+        if fb not in seen:\n+            seen.add(fb)\n+            result.append(fb)\n+    return result\n+\n+\n+def _safe_lang_override_if_needed(\n+        versions: version.WebEngineVersions\n+) -> Optional[str]:\n+    \"\"\"Return a '--lang=' override if the workaround should apply.\"\"\"\n+    # Only on Linux and on the affected version\n+    if not utils.is_linux or versions.webengine != utils.VersionNumber(5, 15, 3):\n+        return None\n+\n+    # Respect the guarded setting; default to False if unavailable\n+    try:\n+        enabled = bool(config.val.qt.workarounds.locale)\n+    except Exception:\n+        enabled = False\n+    if not enabled:\n+        return None\n+\n+    bcp47 = _get_bcp47_locale()\n+    if not bcp47:\n+        return None\n+\n+    # If exact match exists, do nothing\n+    if _locale_pak_exists(bcp47):\n+        return None\n+\n+    # Try sensible fallbacks\n+    fallbacks = _chromium_locale_fallbacks(bcp47)\n+    dirs = _qtwe_locales_dirs()\n+    if not dirs:\n+        # If we can't determine available dirs, pick the first fallback blindly\n+        return f\"--lang={fallbacks[0]}\" if fallbacks else None\n+\n+    for fb in fallbacks:\n+        if _locale_pak_exists(fb):\n+            return f\"--lang={fb}\"\n+\n+    # Nothing found\n+    return None\n+\n+\n def _qtwebengine_args(\n         namespace: argparse.Namespace,\n         special_flags: Sequence[str],\n@@ -207,6 +407,12 @@ def _qtwebengine_args(\n     if disabled_features:\n         yield _DISABLE_FEATURES + ','.join(disabled_features)\n \n+    # WORKAROUND: Force a safe Chromium language if the active locale lacks a .pak\n+    # Only applies on Linux with QtWebEngine 5.15.3 and when explicitly enabled\n+    lang_switch = _safe_lang_override_if_needed(versions)\n+    if lang_switch is not None:\n+        yield lang_switch\n+\n     yield from _qtwebengine_settings_args(versions)\n \n \n@@ -324,4 +530,4 @@ def init_envvars() -> None:\n         if val is None and var in os.environ:\n             del os.environ[var]\n         elif val is not None:\n-            os.environ[var] = val\n+            os.environ[var] = val\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "qutebrowser/config/qtargs.py": [
                    "function: _qtwebengine_args\nfunction: _qtwebengine_locale_override"
                ],
                "qutebrowser/misc/earlyinit.py": [
                    ""
                ],
                "qutebrowser/config/configdata.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/qutebrowser/config/qtargs.py b/qutebrowser/config/qtargs.py\nindex 6fdc495..a013710 100644\n--- a/qutebrowser/config/qtargs.py\n+++ b/qutebrowser/config/qtargs.py\n@@ -1,3 +1,4 @@\n+\n # vim: ft=python fileencoding=utf-8 sts=4 sw=4 et:\n \n # Copyright 2014-2021 Florian Bruhin (The Compiler) <mail@qutebrowser.org>\n@@ -74,8 +75,9 @@ def qt_args(namespace: argparse.Namespace) -> List[str]:\n \n     special_prefixes = (_ENABLE_FEATURES, _DISABLE_FEATURES, _BLINK_SETTINGS)\n     special_flags = [flag for flag in argv if flag.startswith(special_prefixes)]\n+    has_lang_flag = any(flag == '--lang' or flag.startswith('--lang=') for flag in argv)\n     argv = [flag for flag in argv if not flag.startswith(special_prefixes)]\n-    argv += list(_qtwebengine_args(namespace, special_flags))\n+    argv += list(_qtwebengine_args(namespace, special_flags, has_lang_flag))\n \n     return argv\n \n@@ -157,9 +159,179 @@ def _qtwebengine_features(\n     return (enabled_features, disabled_features)\n \n \n+def _parse_env_locale_bcp47() -> Optional[str]:\n+    \"\"\"Parse the current environment locale and convert it to a BCP47-like tag.\n+\n+    Examples:\n+        LANG=en_US.UTF-8 -> en-US\n+        LC_ALL=pt_BR -> pt-BR\n+        LANG=zh_TW@unicode -> zh-TW\n+    \"\"\"\n+    for var in ('LC_ALL', 'LC_MESSAGES', 'LANG'):\n+        val = os.environ.get(var)\n+        if val:\n+            locale = val.strip()\n+            break\n+    else:\n+        return None\n+\n+    # Ignore C/POSIX locales\n+    if locale in ('C', 'POSIX'):\n+        return None\n+\n+    # Strip charset (after .) and modifier (after @)\n+    if '.' in locale:\n+        locale = locale.split('.', 1)[0]\n+    if '@' in locale:\n+        locale = locale.split('@', 1)[0]\n+\n+    # Replace underscore with hyphen\n+    locale = locale.replace('_', '-')\n+\n+    parts = locale.split('-')\n+    if not parts:\n+        return None\n+    lang = parts[0].lower()\n+    rest: List[str] = parts[1:]\n+\n+    # Normalize region/script casing if present\n+    norm_parts = [lang]\n+    for p in rest:\n+        if len(p) == 2:\n+            norm_parts.append(p.upper())\n+        elif len(p) == 4:\n+            norm_parts.append(p.title())\n+        else:\n+            norm_parts.append(p)\n+    return '-'.join(norm_parts)\n+\n+\n+def _find_locales_dir() -> Optional[str]:\n+    \"\"\"Try to locate the qtwebengine_locales directory.\"\"\"\n+    env_path = os.environ.get('QTWEBENGINE_LOCALES_PATH')\n+    candidates: List[str] = []\n+    if env_path:\n+        candidates.append(env_path)\n+\n+    # Common locations on various Linux distributions\n+    candidates += [\n+        '/usr/share/qt/qtwebengine_locales',\n+        '/usr/share/qt5/qtwebengine_locales',\n+        '/usr/lib/qt/qtwebengine_locales',\n+        '/usr/lib/qt5/qtwebengine_locales',\n+        '/usr/lib64/qt/qtwebengine_locales',\n+        '/usr/lib64/qt5/qtwebengine_locales',\n+    ]\n+\n+    for path in candidates:\n+        if path and os.path.isdir(path):\n+            return path\n+    return None\n+\n+\n+def _pak_exists(locales_dir: str, tag: str) -> bool:\n+    \"\"\"Check if a given locale .pak exists.\"\"\"\n+    filename = f'{tag}.pak'\n+    return os.path.isfile(os.path.join(locales_dir, filename))\n+\n+\n+def _compute_locale_fallbacks(tag: str) -> List[str]:\n+    \"\"\"Compute sensible fallback locale candidates for Chromium/QtWebEngine.\n+\n+    Mirrors some Chromium mappings:\n+      - en-* -> en-GB\n+      - es-* -> es-419\n+      - pt -> pt-BR\n+      - pt-* -> pt-PT\n+      - zh with region HK/TW/MO -> zh-TW, otherwise zh-CN\n+    Then falls back to language-only, and finally en-US.\n+    \"\"\"\n+    parts = tag.split('-')\n+    lang = parts[0].lower()\n+    region = parts[1].upper() if len(parts) >= 2 else None\n+\n+    candidates: List[str] = []\n+\n+    if lang == 'zh':\n+        if region in {'HK', 'TW', 'MO'}:\n+            candidates.append('zh-TW')\n+        else:\n+            candidates.append('zh-CN')\n+    elif lang == 'pt':\n+        if region:\n+            candidates.append('pt-PT')\n+        else:\n+            candidates.append('pt-BR')\n+    elif lang == 'en' and region:\n+        candidates.append('en-GB')\n+    elif lang == 'es' and region:\n+        candidates.append('es-419')\n+\n+    # Language-only fallback\n+    if lang not in candidates:\n+        candidates.append(lang)\n+\n+    # As a last resort, use a widely available English locale\n+    if 'en-US' not in candidates:\n+        candidates.append('en-US')\n+\n+    return candidates\n+\n+\n+def _lang_override_for_locale_workaround(\n+        versions: version.WebEngineVersions,\n+        has_lang_flag: bool,\n+) -> Optional[str]:\n+    \"\"\"Determine a --lang override for the QtWebEngine 5.15.3 Linux locale crash.\n+\n+    Returns:\n+        A locale tag to pass via --lang, or None to not override.\n+    \"\"\"\n+    # Respect an explicit --lang passed by the user\n+    if has_lang_flag:\n+        return None\n+\n+    # Only apply on affected platform/version\n+    if not utils.is_linux or versions.webengine != utils.VersionNumber(5, 15, 3):\n+        return None\n+\n+    # Check if the workaround setting is enabled; default to False if missing\n+    try:\n+        enabled = bool(config.instance.get('qt.workarounds.locale'))\n+    except Exception:  # noqa: BLE001 - be safe regarding config backends\n+        enabled = False\n+\n+    if not enabled:\n+        return None\n+\n+    env_tag = _parse_env_locale_bcp47()\n+    if not env_tag:\n+        return None\n+\n+    locales_dir = _find_locales_dir()\n+\n+    # Skip override if exact .pak exists\n+    if locales_dir and _pak_exists(locales_dir, env_tag):\n+        return None\n+\n+    # Compute fallback candidates\n+    candidates = _compute_locale_fallbacks(env_tag)\n+\n+    if locales_dir:\n+        for cand in candidates:\n+            if _pak_exists(locales_dir, cand):\n+                return cand\n+        # If nothing found, still return the safest last resort\n+        return candidates[-1]\n+    else:\n+        # If we cannot determine the locales directory, still apply a sensible fallback\n+        return candidates[0]\n+\n+\n def _qtwebengine_args(\n         namespace: argparse.Namespace,\n         special_flags: Sequence[str],\n+        has_lang_flag: bool,\n ) -> Iterator[str]:\n     \"\"\"Get the QtWebEngine arguments to use based on the config.\"\"\"\n     versions = version.qtwebengine_versions(avoid_init=True)\n@@ -207,6 +379,11 @@ def _qtwebengine_args(\n     if disabled_features:\n         yield _DISABLE_FEATURES + ','.join(disabled_features)\n \n+    # WORKAROUND: Normalize/override locale for QtWebEngine 5.15.3 on Linux\n+    lang_override = _lang_override_for_locale_workaround(versions, has_lang_flag)\n+    if lang_override is not None:\n+        yield f'--lang={lang_override}'\n+\n     yield from _qtwebengine_settings_args(versions)\n \n \n@@ -324,4 +501,4 @@ def init_envvars() -> None:\n         if val is None and var in os.environ:\n             del os.environ[var]\n         elif val is not None:\n-            os.environ[var] = val\n+            os.environ[var] = val\n",
                "diff --git a/qutebrowser/config/qtargs.py b/qutebrowser/config/qtargs.py\nindex 6fdc495..da9ca3c 100644\n--- a/qutebrowser/config/qtargs.py\n+++ b/qutebrowser/config/qtargs.py\n@@ -1,3 +1,4 @@\n+\n # vim: ft=python fileencoding=utf-8 sts=4 sw=4 et:\n \n # Copyright 2014-2021 Florian Bruhin (The Compiler) <mail@qutebrowser.org>\n@@ -207,6 +208,99 @@ def _qtwebengine_args(\n     if disabled_features:\n         yield _DISABLE_FEATURES + ','.join(disabled_features)\n \n+    # WORKAROUND for QtWebEngine 5.15.3 locale issues on Linux:\n+    # Guarded by qt.workarounds.locale. If the exact locale .pak is missing,\n+    # try to pass a safe --lang override using sensible fallbacks.\n+    try:\n+        locale_workaround = bool(config.instance.get('qt.workarounds.locale'))\n+    except Exception:  # pragma: no cover - be safe if setting is unavailable\n+        locale_workaround = False\n+    if (utils.is_linux and\n+            versions.webengine == utils.VersionNumber(5, 15, 3) and\n+            locale_workaround):\n+        def _detect_locale() -> Optional[str]:\n+            for var in ('LC_ALL', 'LC_MESSAGES', 'LANG'):\n+                val = os.environ.get(var)\n+                if val:\n+                    loc = val\n+                    break\n+            else:\n+                return None\n+            loc = loc.split('.')[0]\n+            loc = loc.split('@')[0]\n+            loc = loc.replace('_', '-')\n+            if loc in ('C', 'POSIX'):\n+                return None\n+            # normalize casing like xx-YY\n+            parts = loc.split('-')\n+            if len(parts) >= 2:\n+                return parts[0].lower() + '-' + parts[1].upper()\n+            return parts[0].lower()\n+\n+        def _candidate_dirs() -> List[str]:\n+            dirs: List[str] = []\n+            env_dir = os.environ.get('QTWEBENGINE_LOCALES_PATH')\n+            if env_dir:\n+                dirs.append(env_dir)\n+            try:\n+                # Try to derive the default Qt resources path used by PyQt5\n+                import PyQt5.QtCore as _QtCore  # type: ignore\n+                qt_pkg_dir = os.path.dirname(_QtCore.__file__)\n+                guess = os.path.join(qt_pkg_dir, 'Qt', 'resources', 'qtwebengine_locales')\n+                if os.path.isdir(guess):\n+                    dirs.append(guess)\n+            except Exception:\n+                pass\n+            # Common fallback relative to the executable (PyInstaller etc.)\n+            exe_dir = os.path.dirname(sys.executable)\n+            guess = os.path.join(exe_dir, 'qtwebengine_locales')\n+            if os.path.isdir(guess):\n+                dirs.append(guess)\n+            return dirs\n+\n+        def _has_pak(code: str) -> bool:\n+            fname_variants = [f'{code}.pak', f'{code.lower()}.pak']\n+            for d in _candidate_dirs():\n+                for name in fname_variants:\n+                    if os.path.isfile(os.path.join(d, name)):\n+                        return True\n+            return False\n+\n+        def _map_locale(loc: str) -> List[str]:\n+            # Return candidates in order\n+            parts = loc.split('-')\n+            lang = parts[0].lower()\n+            region = parts[1].upper() if len(parts) >= 2 else None\n+            candidates: List[str] = []\n+            # Special cases following Chromium mappings\n+            if lang == 'zh':\n+                if region in ('CN', 'SG', 'HANS'):\n+                    candidates.append('zh-CN')\n+                elif region in ('TW', 'HK', 'MO', 'HANT'):\n+                    candidates.append('zh-TW')\n+                else:\n+                    candidates.append('zh-CN')\n+            elif lang == 'pt':\n+                if region is None:\n+                    candidates.append('pt-BR')\n+                else:\n+                    candidates.append('pt-PT')\n+            elif lang == 'es':\n+                candidates.append('es-419')\n+            elif lang == 'en':\n+                candidates.append('en-GB')\n+            # Language-only fallback\n+            candidates.append(lang)\n+            return candidates\n+\n+        loc = _detect_locale()\n+        if loc:\n+            if not _has_pak(loc):\n+                for cand in _map_locale(loc):\n+                    if _has_pak(cand):\n+                        yield f'--lang={cand}'\n+                        break\n+\n     yield from _qtwebengine_settings_args(versions)\n \n \n@@ -324,4 +418,4 @@ def init_envvars() -> None:\n         if val is None and var in os.environ:\n             del os.environ[var]\n         elif val is not None:\n-            os.environ[var] = val\n+            os.environ[var] = val\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/qutebrowser/config/qtargs.py b/qutebrowser/config/qtargs.py\nindex 6fdc495..c3f2077 100644\n--- a/qutebrowser/config/qtargs.py\n+++ b/qutebrowser/config/qtargs.py\n@@ -1,3 +1,4 @@\n+\n # vim: ft=python fileencoding=utf-8 sts=4 sw=4 et:\n \n # Copyright 2014-2021 Florian Bruhin (The Compiler) <mail@qutebrowser.org>\n@@ -22,6 +23,7 @@\n import os\n import sys\n import argparse\n+import locale\n from typing import Any, Dict, Iterator, List, Optional, Sequence, Tuple\n \n from qutebrowser.config import config\n@@ -209,6 +211,164 @@ def _qtwebengine_args(\n \n     yield from _qtwebengine_settings_args(versions)\n \n+    # WORKAROUND for QtWebEngine 5.15.3 locale handling on Linux:\n+    # If enabled via qt.workarounds.locale, attempt to normalize the locale\n+    # passed to Chromium so that a matching qtwebengine_locales/*.pak exists.\n+    # See issue: Network service crash loop on certain locales.\n+    def _get_workaround_enabled() -> bool:\n+        # Prefer config.instance if available, fall back to config.val access\n+        try:\n+            return bool(config.instance.get('qt.workarounds.locale'))\n+        except Exception:\n+            try:\n+                qt_section = getattr(config.val, 'qt', None)\n+                workarounds = getattr(qt_section, 'workarounds', None)\n+                return bool(getattr(workarounds, 'locale', False))\n+            except Exception:\n+                return False\n+\n+    def _normalize_bcp47(code: str) -> Optional[str]:\n+        if not code:\n+            return None\n+        # LANGUAGE may be colon-separated; take first\n+        code = code.split(':', 1)[0]\n+        # Strip encoding and modifier\n+        code = code.split('.', 1)[0]\n+        code = code.split('@', 1)[0]\n+        code = code.strip()\n+        if not code:\n+            return None\n+        code = code.replace('_', '-')\n+        parts = code.split('-')\n+        lang = parts[0].lower() if parts and parts[0] else ''\n+        region = parts[1].upper() if len(parts) > 1 and parts[1] else ''\n+        if not lang:\n+            return None\n+        return f'{lang}-{region}' if region else lang\n+\n+    def _current_locale_code() -> Optional[str]:\n+        # Check common environment variables first\n+        for var in ('LC_ALL', 'LC_MESSAGES', 'LANG', 'LANGUAGE'):\n+            val = os.environ.get(var)\n+            norm = _normalize_bcp47(val) if val else None\n+            if norm:\n+                return norm\n+        # Fallback to Python's locale\n+        try:\n+            lang, _enc = locale.getdefaultlocale()\n+        except Exception:\n+            lang = None\n+        return _normalize_bcp47(lang) if lang else None\n+\n+    def _candidate_locale_dirs() -> List[str]:\n+        paths: List[str] = []\n+        env_path = os.environ.get('QTWEBENGINE_LOCALES_PATH')\n+        if env_path:\n+            paths.append(env_path)\n+\n+        # Try to derive from Qt installation\n+        try:\n+            from PyQt5.QtCore import QLibraryInfo  # type: ignore\n+            # Probe a few plausible base locations\n+            base_keys = []\n+            for key_name in ('DataPath', 'ArchDataPath', 'PrefixPath'):\n+                if hasattr(QLibraryInfo, key_name):\n+                    base_keys.append(getattr(QLibraryInfo, key_name))\n+            for key in base_keys:\n+                try:\n+                    base = QLibraryInfo.location(key)  # type: ignore\n+                except Exception:\n+                    base = ''\n+                if base:\n+                    paths.append(os.path.join(base, 'resources', 'qtwebengine_locales'))\n+                    paths.append(os.path.join(base, 'qtwebengine_locales'))\n+        except Exception:\n+            pass\n+\n+        # Try PyQt5 package layout\n+        try:\n+            import PyQt5  # type: ignore\n+            pyqt_base = os.path.dirname(PyQt5.__file__)\n+            for qt_dir in ('Qt5', 'Qt'):\n+                paths.append(os.path.join(pyqt_base, qt_dir, 'resources', 'qtwebengine_locales'))\n+        except Exception:\n+            pass\n+\n+        # Deduplicate and keep only existing directories\n+        uniq = []\n+        seen = set()\n+        for p in paths:\n+            if p not in seen and os.path.isdir(p):\n+                uniq.append(p)\n+                seen.add(p)\n+        return uniq\n+\n+    def _pak_exists(code: str, dirs: Sequence[str]) -> bool:\n+        if not code or not dirs:\n+            return False\n+        # Try common filename variants\n+        candidates = [\n+            f'{code}.pak',\n+            f'{code.lower()}.pak',\n+            f'{code.replace(\"-\", \"_\")}.pak',\n+            f'{code.lower().replace(\"-\", \"_\")}.pak',\n+        ]\n+        for d in dirs:\n+            for name in candidates:\n+                if os.path.isfile(os.path.join(d, name)):\n+                    return True\n+        return False\n+\n+    def _fallback_candidates(code: Optional[str]) -> List[str]:\n+        # Build a list of fallback locales to try, based on Chromium mappings.\n+        lang = ''\n+        region = ''\n+        if code:\n+            parts = code.split('-')\n+            lang = parts[0]\n+            region = parts[1] if len(parts) > 1 else ''\n+\n+        cands: List[str] = []\n+        # Handle special mappings\n+        if lang == 'en':\n+            cands.append('en-GB')\n+        elif lang == 'es':\n+            cands.append('es-419')\n+        elif lang == 'pt':\n+            if region:\n+                cands.append('pt-PT')\n+            else:\n+                cands.append('pt-BR')\n+        elif lang == 'zh':\n+            if region in ('HK', 'MO'):\n+                cands.append('zh-HK')\n+            elif region == 'TW':\n+                cands.append('zh-TW')\n+            else:\n+                cands.append('zh-CN')\n+\n+        # Language-only fallback\n+        if lang:\n+            cands.append(lang)\n+\n+        # Ultimate safe fallback\n+        if 'en-GB' not in cands:\n+            cands.append('en-GB')\n+\n+        return cands\n+\n+    if utils.is_linux and versions.webengine == utils.VersionNumber(5, 15, 3):\n+        if _get_workaround_enabled():\n+            current = _current_locale_code()\n+            locale_dirs = _candidate_locale_dirs()\n+\n+            # Only attempt override if we can determine locale dirs to check\n+            if current and locale_dirs and not _pak_exists(current, locale_dirs):\n+                for cand in _fallback_candidates(current):\n+                    if _pak_exists(cand, locale_dirs):\n+                        yield f'--lang={cand}'\n+                        break\n+\n \n def _qtwebengine_settings_args(versions: version.WebEngineVersions) -> Iterator[str]:\n     settings: Dict[str, Dict[Any, Optional[str]]] = {\n@@ -324,4 +484,4 @@ def init_envvars() -> None:\n         if val is None and var in os.environ:\n             del os.environ[var]\n         elif val is not None:\n-            os.environ[var] = val\n+            os.environ[var] = val\n"
}