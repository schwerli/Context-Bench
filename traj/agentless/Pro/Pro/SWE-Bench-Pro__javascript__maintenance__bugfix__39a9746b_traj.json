{
    "instance_id": "SWE-Bench-Pro__javascript__maintenance__bugfix__39a9746b",
    "original_id": "instance_element-hq__element-web-5dfde12c1c1c0b6e48f17e3405468593e39d9492-vnan",
    "1_model_selected_files": [
        "src/DeviceListener.ts",
        "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts",
        "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts",
        "src/voice-broadcast/utils/VoiceBroadcastChunkEvents.ts",
        "src/components/views/settings/devices/useOwnDevices.ts"
    ],
    "2_embedding_selected_files": [
        "src/voice-broadcast/utils/VoiceBroadcastResumer.ts",
        "src/voice-broadcast/index.ts",
        "src/voice-broadcast/utils/doMaybeSetCurrentVoiceBroadcastPlayback.ts",
        "cypress/e2e/settings/device-management.spec.ts",
        "src/voice-broadcast/models/VoiceBroadcastPlayback.ts",
        "src/voice-broadcast/utils/doClearCurrentVoiceBroadcastPlaybackIfStopped.ts",
        "src/toasts/BulkUnverifiedSessionsToast.ts",
        "cypress/e2e/sliding-sync/sliding-sync.ts",
        "src/DeviceListener.ts",
        "src/voice-broadcast/models/VoiceBroadcastRecording.ts",
        "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts",
        "src/voice-broadcast/stores/VoiceBroadcastPlaybacksStore.ts",
        "src/toasts/UnverifiedSessionToast.ts",
        "src/voice-broadcast/utils/hasRoomLiveVoiceBroadcast.ts",
        "src/stores/room-list/previews/VoiceBroadcastPreview.ts",
        "src/voice-broadcast/types.ts",
        "src/voice-broadcast/hooks/useVoiceBroadcastPlayback.ts",
        "src/Lifecycle.ts",
        "src/voice-broadcast/utils/shouldDisplayAsVoiceBroadcastRecordingTile.ts",
        "src/voice-broadcast/utils/pauseNonLiveBroadcastFromOtherRoom.ts",
        "src/voice-broadcast/utils/VoiceBroadcastChunkEvents.ts",
        "src/voice-broadcast/utils/shouldDisplayAsVoiceBroadcastStoppedText.ts",
        "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts",
        "cypress/e2e/threads/threads.spec.ts",
        "src/voice-broadcast/models/VoiceBroadcastPreRecording.ts",
        "cypress/e2e/crypto/decryption-failure.spec.ts",
        "src/voice-broadcast/utils/textForVoiceBroadcastStoppedEventWithoutLink.ts",
        "src/voice-broadcast/utils/findRoomLiveVoiceBroadcastFromUserAndDevice.ts",
        "src/voice-broadcast/utils/retrieveStartedInfoEvent.ts",
        "src/utils/notifications.ts",
        "src/voice-broadcast/stores/VoiceBroadcastPreRecordingStore.ts",
        "cypress/e2e/timeline/timeline.spec.ts",
        "src/voice-broadcast/stores/VoiceBroadcastRecordingsStore.ts",
        "src/voice-broadcast/hooks/useCurrentVoiceBroadcastPlayback.ts",
        "src/models/Call.ts",
        "src/voice-broadcast/utils/shouldDisplayAsVoiceBroadcastTile.ts",
        "src/utils/device/snoozeBulkUnverifiedDeviceReminder.ts",
        "src/verification.ts",
        "src/voice-broadcast/utils/determineVoiceBroadcastLiveness.ts",
        "src/voice-broadcast/audio/VoiceBroadcastRecorder.ts",
        "src/audio/PlaybackQueue.ts",
        "cypress/e2e/crypto/crypto.spec.ts",
        "cypress/e2e/user-onboarding/user-onboarding-new.ts",
        "src/voice-broadcast/hooks/useCurrentVoiceBroadcastPreRecording.ts",
        "src/utils/leave-behaviour.ts",
        "src/voice-broadcast/hooks/useHasRoomLiveVoiceBroadcast.ts",
        "src/components/views/settings/devices/useOwnDevices.ts",
        "cypress/e2e/lazy-loading/lazy-loading.spec.ts",
        "src/audio/VoiceMessageRecording.ts",
        "cypress/e2e/spotlight/spotlight.spec.ts",
        "src/SlidingSyncManager.ts",
        "src/Presence.ts",
        "src/stores/room-list/RoomListStore.ts",
        "src/voice-broadcast/hooks/useCurrentVoiceBroadcastRecording.ts",
        "src/stores/AutoRageshakeStore.ts",
        "src/utils/device/clientInformation.ts",
        "src/ScalarMessaging.ts",
        "src/sentry.ts",
        "src/stores/local-echo/RoomEchoChamber.ts",
        "cypress/e2e/user-onboarding/user-onboarding-old.ts",
        "cypress/e2e/polls/polls.spec.ts",
        "src/Resend.ts",
        "src/stores/widgets/StopGapWidget.ts",
        "src/dispatcher/actions.ts"
    ],
    "3_final_combined_files": [
        "src/DeviceListener.ts",
        "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts",
        "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts",
        "src/voice-broadcast/utils/VoiceBroadcastResumer.ts",
        "src/voice-broadcast/index.ts",
        "src/voice-broadcast/utils/doMaybeSetCurrentVoiceBroadcastPlayback.ts"
    ],
    "4_related_elements": {
        "src/DeviceListener.ts": [
            "class: DeviceListener"
        ],
        "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts": [
            "function: setUpVoiceBroadcastPreRecording"
        ],
        "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts": [
            "function: startNewVoiceBroadcastRecording\nfunction: startBroadcast\nclass: VoiceBroadcastRecording"
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "src/DeviceListener.ts": [
                    "function: DeviceListener.onDevicesUpdated\nfunction: DeviceListener.ensureDeviceIdsAtStartPopulated\nline: 267\nline: 306"
                ],
                "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts": [
                    "function: setUpVoiceBroadcastPreRecording"
                ],
                "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts": [
                    "function: startNewVoiceBroadcastRecording\nline: 68\nline: 71"
                ]
            },
            "patches": [
                "diff --git a/src/DeviceListener.ts b/src/DeviceListener.ts\nindex 9fe69d5..5da2345 100644\n--- a/src/DeviceListener.ts\n+++ b/src/DeviceListener.ts\n@@ -151,7 +151,14 @@ export default class DeviceListener {\n     private ensureDeviceIdsAtStartPopulated() {\n         if (this.ourDeviceIdsAtStart === null) {\n             const cli = MatrixClientPeg.get();\n-            this.ourDeviceIdsAtStart = new Set(cli.getStoredDevicesForUser(cli.getUserId()).map((d) => d.deviceId));\n+            const userId = cli.getUserId();\n+            if (!userId) {\n+                // No user ID yet (e.g. during startup/auth changes), initialize to empty to avoid unsafe access\n+                this.ourDeviceIdsAtStart = new Set<string>();\n+                return;\n+            }\n+            const devices = cli.getStoredDevicesForUser(userId) || [];\n+            this.ourDeviceIdsAtStart = new Set(devices.map((d) => d.deviceId));\n         }\n     }\n \n@@ -162,7 +169,7 @@ export default class DeviceListener {\n         if (initialFetch) return;\n \n         const myUserId = MatrixClientPeg.get().getUserId();\n-        if (users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n+        if (myUserId && users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n \n         // No need to do a recheck here: we just need to get a snapshot of our devices\n         // before we download any new ones.\n@@ -303,17 +310,25 @@ export default class DeviceListener {\n         // Unverified devices that have appeared since then\n         const newUnverifiedDeviceIds = new Set<string>();\n \n-        const isCurrentDeviceTrusted =\n-            crossSigningReady && (await cli.checkDeviceTrust(cli.getUserId()!, cli.deviceId!).isCrossSigningVerified());\n+        let isCurrentDeviceTrusted = false;\n+        const uid = cli.getUserId();\n+        const did = cli.getDeviceId();\n+        if (crossSigningReady && uid && did) {\n+            const trust = await cli.checkDeviceTrust(uid, did);\n+            isCurrentDeviceTrusted = trust.isCrossSigningVerified();\n+        }\n \n         // as long as cross-signing isn't ready,\n         // you can't see or dismiss any device toasts\n         if (crossSigningReady) {\n-            const devices = cli.getStoredDevicesForUser(cli.getUserId());\n+            const uid = cli.getUserId();\n+            const devices = uid ? cli.getStoredDevicesForUser(uid) : [];\n             for (const device of devices) {\n+                if (!device?.deviceId) continue;\n                 if (device.deviceId === cli.deviceId) continue;\n \n-                const deviceTrust = await cli.checkDeviceTrust(cli.getUserId()!, device.deviceId!);\n+                if (!uid) continue;\n+                const deviceTrust = await cli.checkDeviceTrust(uid, device.deviceId!);\n                 if (!deviceTrust.isCrossSigningVerified() && !this.dismissed.has(device.deviceId)) {\n                     if (this.ourDeviceIdsAtStart.has(device.deviceId)) {\n                         oldUnverifiedDeviceIds.add(device.deviceId);\ndiff --git a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\nindex 8b5118d..7ff25e2 100644\n--- a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n+++ b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -31,6 +32,12 @@ export const setUpVoiceBroadcastPreRecording = async (\n     recordingsStore: VoiceBroadcastRecordingsStore,\n     preRecordingStore: VoiceBroadcastPreRecordingStore,\n ): Promise<VoiceBroadcastPreRecording | null> => {\n+    // Block setup if the client is offline / in a sync error state\n+    const syncState = client.getSyncState?.();\n+    if (syncState && syncState !== \"SYNCING\" && syncState !== \"PREPARED\" && syncState !== \"CATCHUP\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -48,4 +55,4 @@ export const setUpVoiceBroadcastPreRecording = async (\n     const preRecording = new VoiceBroadcastPreRecording(room, sender, client, playbacksStore, recordingsStore);\n     preRecordingStore.setCurrent(preRecording);\n     return preRecording;\n-};\n+};\ndiff --git a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\nindex 90c15bd..01b1e1c 100644\n--- a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n+++ b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -88,6 +89,12 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore: VoiceBroadcastPlaybacksStore,\n     recordingsStore: VoiceBroadcastRecordingsStore,\n ): Promise<VoiceBroadcastRecording | null> => {\n+    // Block starting a broadcast if the client is offline / in a sync error state\n+    const syncState = client.getSyncState?.();\n+    if (syncState && syncState !== \"SYNCING\" && syncState !== \"PREPARED\" && syncState !== \"CATCHUP\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -97,4 +104,4 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore.clearCurrent();\n \n     return startBroadcast(room, client, recordingsStore);\n-};\n+};",
                "diff --git a/src/DeviceListener.ts b/src/DeviceListener.ts\nindex 9fe69d5..51f9883 100644\n--- a/src/DeviceListener.ts\n+++ b/src/DeviceListener.ts\n@@ -151,7 +151,13 @@ export default class DeviceListener {\n     private ensureDeviceIdsAtStartPopulated() {\n         if (this.ourDeviceIdsAtStart === null) {\n             const cli = MatrixClientPeg.get();\n-            this.ourDeviceIdsAtStart = new Set(cli.getStoredDevicesForUser(cli.getUserId()).map((d) => d.deviceId));\n+            const userId = cli?.getUserId?.();\n+            if (!cli || !userId) {\n+                this.ourDeviceIdsAtStart = new Set();\n+                return;\n+            }\n+            const devices = cli.getStoredDevicesForUser(userId) || [];\n+            this.ourDeviceIdsAtStart = new Set(devices.map((d) => d.deviceId));\n         }\n     }\n \n@@ -162,7 +168,7 @@ export default class DeviceListener {\n         if (initialFetch) return;\n \n         const myUserId = MatrixClientPeg.get().getUserId();\n-        if (users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n+        if (myUserId && users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n \n         // No need to do a recheck here: we just need to get a snapshot of our devices\n         // before we download any new ones.\n@@ -303,17 +309,22 @@ export default class DeviceListener {\n         // Unverified devices that have appeared since then\n         const newUnverifiedDeviceIds = new Set<string>();\n \n+        const userId = cli.getUserId();\n+        const deviceId = cli.deviceId;\n         const isCurrentDeviceTrusted =\n-            crossSigningReady && (await cli.checkDeviceTrust(cli.getUserId()!, cli.deviceId!).isCrossSigningVerified());\n+            crossSigningReady && !!userId && !!deviceId\n+                ? (await cli.checkDeviceTrust(userId, deviceId).isCrossSigningVerified())\n+                : false;\n \n         // as long as cross-signing isn't ready,\n         // you can't see or dismiss any device toasts\n         if (crossSigningReady) {\n-            const devices = cli.getStoredDevicesForUser(cli.getUserId());\n+            const userIdForDevices = cli.getUserId();\n+            const devices = userIdForDevices ? cli.getStoredDevicesForUser(userIdForDevices) : [];\n             for (const device of devices) {\n                 if (device.deviceId === cli.deviceId) continue;\n \n-                const deviceTrust = await cli.checkDeviceTrust(cli.getUserId()!, device.deviceId!);\n+                const deviceTrust = await cli.checkDeviceTrust(userIdForDevices!, device.deviceId!);\n                 if (!deviceTrust.isCrossSigningVerified() && !this.dismissed.has(device.deviceId)) {\n                     if (this.ourDeviceIdsAtStart.has(device.deviceId)) {\n                         oldUnverifiedDeviceIds.add(device.deviceId);\ndiff --git a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\nindex 8b5118d..448d722 100644\n--- a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n+++ b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -31,6 +32,10 @@ export const setUpVoiceBroadcastPreRecording = async (\n     recordingsStore: VoiceBroadcastRecordingsStore,\n     preRecordingStore: VoiceBroadcastPreRecordingStore,\n ): Promise<VoiceBroadcastPreRecording | null> => {\n+    const syncState = client.getSyncState?.();\n+    if (syncState === \"ERROR\") {\n+        return null;\n+    }\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -48,4 +53,4 @@ export const setUpVoiceBroadcastPreRecording = async (\n     const preRecording = new VoiceBroadcastPreRecording(room, sender, client, playbacksStore, recordingsStore);\n     preRecordingStore.setCurrent(preRecording);\n     return preRecording;\n-};\n+};\ndiff --git a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\nindex 90c15bd..4e5fec2 100644\n--- a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n+++ b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -88,6 +89,10 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore: VoiceBroadcastPlaybacksStore,\n     recordingsStore: VoiceBroadcastRecordingsStore,\n ): Promise<VoiceBroadcastRecording | null> => {\n+    const syncState = client.getSyncState?.();\n+    if (syncState === \"ERROR\") {\n+        return null;\n+    }\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -97,4 +102,4 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore.clearCurrent();\n \n     return startBroadcast(room, client, recordingsStore);\n-};\n+};"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "src/DeviceListener.ts": [
                    "function: DeviceListener.onDevicesUpdated\nfunction: DeviceListener.updateClientInformation\nfunction: DeviceListener.ensureDeviceIdsAtStartPopulated\nfunction: DeviceListener.recheck\nline: 306"
                ],
                "src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts": [
                    "function: setUpVoiceBroadcastPreRecording"
                ],
                "src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts": [
                    "function: startNewVoiceBroadcastRecording\nfunction: startBroadcast\nline: 66"
                ]
            },
            "patches": [
                "diff --git a/src/DeviceListener.ts b/src/DeviceListener.ts\nindex 9fe69d5..8330350 100644\n--- a/src/DeviceListener.ts\n+++ b/src/DeviceListener.ts\n@@ -151,7 +151,13 @@ export default class DeviceListener {\n     private ensureDeviceIdsAtStartPopulated() {\n         if (this.ourDeviceIdsAtStart === null) {\n             const cli = MatrixClientPeg.get();\n-            this.ourDeviceIdsAtStart = new Set(cli.getStoredDevicesForUser(cli.getUserId()).map((d) => d.deviceId));\n+            const userId = cli.getUserId();\n+            if (!userId) {\n+                this.ourDeviceIdsAtStart = new Set();\n+                return;\n+            }\n+            const devices = cli.getStoredDevicesForUser(userId) || [];\n+            this.ourDeviceIdsAtStart = new Set(devices.map((d) => d.deviceId).filter(Boolean));\n         }\n     }\n \n@@ -254,6 +260,10 @@ export default class DeviceListener {\n         // (we add a listener on sync to do once check after the initial sync is done)\n         if (!cli.isInitialSyncComplete()) return;\n \n+        const userId = cli.getUserId();\n+        const deviceId = cli.deviceId;\n+        if (!userId || !deviceId) return;\n+\n         const crossSigningReady = await cli.isCrossSigningReady();\n         const secretStorageReady = await cli.isSecretStorageReady();\n         const allSystemsReady = crossSigningReady && secretStorageReady;\n@@ -264,10 +274,10 @@ export default class DeviceListener {\n             this.checkKeyBackupStatus();\n         } else if (this.shouldShowSetupEncryptionToast()) {\n             // make sure our keys are finished downloading\n-            await cli.downloadKeys([cli.getUserId()]);\n+            await cli.downloadKeys([userId]);\n             // cross signing isn't enabled - nag to enable it\n             // There are 3 different toasts for:\n-            if (!cli.getCrossSigningId() && cli.getStoredCrossSigningForUser(cli.getUserId())) {\n+            if (!cli.getCrossSigningId() && cli.getStoredCrossSigningForUser(userId)) {\n                 // Cross-signing on account but this device doesn't trust the master key (verify this session)\n                 showSetupEncryptionToast(SetupKind.VERIFY_THIS_SESSION);\n                 this.checkKeyBackupStatus();\n@@ -304,16 +314,16 @@ export default class DeviceListener {\n         const newUnverifiedDeviceIds = new Set<string>();\n \n         const isCurrentDeviceTrusted =\n-            crossSigningReady && (await cli.checkDeviceTrust(cli.getUserId()!, cli.deviceId!).isCrossSigningVerified());\n+            crossSigningReady && (await cli.checkDeviceTrust(userId, deviceId).isCrossSigningVerified());\n \n         // as long as cross-signing isn't ready,\n         // you can't see or dismiss any device toasts\n         if (crossSigningReady) {\n-            const devices = cli.getStoredDevicesForUser(cli.getUserId());\n+            const devices = cli.getStoredDevicesForUser(userId);\n             for (const device of devices) {\n-                if (device.deviceId === cli.deviceId) continue;\n+                if (!device.deviceId || device.deviceId === deviceId) continue;\n \n-                const deviceTrust = await cli.checkDeviceTrust(cli.getUserId()!, device.deviceId!);\n+                const deviceTrust = await cli.checkDeviceTrust(userId, device.deviceId);\n                 if (!deviceTrust.isCrossSigningVerified() && !this.dismissed.has(device.deviceId)) {\n                     if (this.ourDeviceIdsAtStart.has(device.deviceId)) {\n                         oldUnverifiedDeviceIds.add(device.deviceId);\ndiff --git a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\nindex 8b5118d..24cb4c3 100644\n--- a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n+++ b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -31,6 +32,11 @@ export const setUpVoiceBroadcastPreRecording = async (\n     recordingsStore: VoiceBroadcastRecordingsStore,\n     preRecordingStore: VoiceBroadcastPreRecordingStore,\n ): Promise<VoiceBroadcastPreRecording | null> => {\n+    const syncState = client.getSyncState ? client.getSyncState() : null;\n+    if (syncState === \"ERROR\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -48,4 +54,4 @@ export const setUpVoiceBroadcastPreRecording = async (\n     const preRecording = new VoiceBroadcastPreRecording(room, sender, client, playbacksStore, recordingsStore);\n     preRecordingStore.setCurrent(preRecording);\n     return preRecording;\n-};\n+};\ndiff --git a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\nindex 90c15bd..46091d2 100644\n--- a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n+++ b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -68,6 +69,7 @@ const startBroadcast = async (\n             device_id: client.getDeviceId(),\n             state: VoiceBroadcastInfoState.Started,\n             chunk_length: getChunkLength(),\n+            sequence: 0,\n         } as VoiceBroadcastInfoEventContent,\n         userId,\n     );\n@@ -88,6 +90,11 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore: VoiceBroadcastPlaybacksStore,\n     recordingsStore: VoiceBroadcastRecordingsStore,\n ): Promise<VoiceBroadcastRecording | null> => {\n+    const syncState = client.getSyncState ? client.getSyncState() : null;\n+    if (syncState === \"ERROR\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -97,4 +104,4 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore.clearCurrent();\n \n     return startBroadcast(room, client, recordingsStore);\n-};\n+};"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/src/DeviceListener.ts b/src/DeviceListener.ts\nindex 9fe69d5..5da2345 100644\n--- a/src/DeviceListener.ts\n+++ b/src/DeviceListener.ts\n@@ -151,7 +151,14 @@ export default class DeviceListener {\n     private ensureDeviceIdsAtStartPopulated() {\n         if (this.ourDeviceIdsAtStart === null) {\n             const cli = MatrixClientPeg.get();\n-            this.ourDeviceIdsAtStart = new Set(cli.getStoredDevicesForUser(cli.getUserId()).map((d) => d.deviceId));\n+            const userId = cli.getUserId();\n+            if (!userId) {\n+                // No user ID yet (e.g. during startup/auth changes), initialize to empty to avoid unsafe access\n+                this.ourDeviceIdsAtStart = new Set<string>();\n+                return;\n+            }\n+            const devices = cli.getStoredDevicesForUser(userId) || [];\n+            this.ourDeviceIdsAtStart = new Set(devices.map((d) => d.deviceId));\n         }\n     }\n \n@@ -162,7 +169,7 @@ export default class DeviceListener {\n         if (initialFetch) return;\n \n         const myUserId = MatrixClientPeg.get().getUserId();\n-        if (users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n+        if (myUserId && users.includes(myUserId)) this.ensureDeviceIdsAtStartPopulated();\n \n         // No need to do a recheck here: we just need to get a snapshot of our devices\n         // before we download any new ones.\n@@ -303,17 +310,25 @@ export default class DeviceListener {\n         // Unverified devices that have appeared since then\n         const newUnverifiedDeviceIds = new Set<string>();\n \n-        const isCurrentDeviceTrusted =\n-            crossSigningReady && (await cli.checkDeviceTrust(cli.getUserId()!, cli.deviceId!).isCrossSigningVerified());\n+        let isCurrentDeviceTrusted = false;\n+        const uid = cli.getUserId();\n+        const did = cli.getDeviceId();\n+        if (crossSigningReady && uid && did) {\n+            const trust = await cli.checkDeviceTrust(uid, did);\n+            isCurrentDeviceTrusted = trust.isCrossSigningVerified();\n+        }\n \n         // as long as cross-signing isn't ready,\n         // you can't see or dismiss any device toasts\n         if (crossSigningReady) {\n-            const devices = cli.getStoredDevicesForUser(cli.getUserId());\n+            const uid = cli.getUserId();\n+            const devices = uid ? cli.getStoredDevicesForUser(uid) : [];\n             for (const device of devices) {\n+                if (!device?.deviceId) continue;\n                 if (device.deviceId === cli.deviceId) continue;\n \n-                const deviceTrust = await cli.checkDeviceTrust(cli.getUserId()!, device.deviceId!);\n+                if (!uid) continue;\n+                const deviceTrust = await cli.checkDeviceTrust(uid, device.deviceId!);\n                 if (!deviceTrust.isCrossSigningVerified() && !this.dismissed.has(device.deviceId)) {\n                     if (this.ourDeviceIdsAtStart.has(device.deviceId)) {\n                         oldUnverifiedDeviceIds.add(device.deviceId);\ndiff --git a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\nindex 8b5118d..7ff25e2 100644\n--- a/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n+++ b/src/voice-broadcast/utils/setUpVoiceBroadcastPreRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -31,6 +32,12 @@ export const setUpVoiceBroadcastPreRecording = async (\n     recordingsStore: VoiceBroadcastRecordingsStore,\n     preRecordingStore: VoiceBroadcastPreRecordingStore,\n ): Promise<VoiceBroadcastPreRecording | null> => {\n+    // Block setup if the client is offline / in a sync error state\n+    const syncState = client.getSyncState?.();\n+    if (syncState && syncState !== \"SYNCING\" && syncState !== \"PREPARED\" && syncState !== \"CATCHUP\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -48,4 +55,4 @@ export const setUpVoiceBroadcastPreRecording = async (\n     const preRecording = new VoiceBroadcastPreRecording(room, sender, client, playbacksStore, recordingsStore);\n     preRecordingStore.setCurrent(preRecording);\n     return preRecording;\n-};\n+};\ndiff --git a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\nindex 90c15bd..01b1e1c 100644\n--- a/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n+++ b/src/voice-broadcast/utils/startNewVoiceBroadcastRecording.ts\n@@ -1,3 +1,4 @@\n+\n /*\n Copyright 2022 The Matrix.org Foundation C.I.C.\n \n@@ -88,6 +89,12 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore: VoiceBroadcastPlaybacksStore,\n     recordingsStore: VoiceBroadcastRecordingsStore,\n ): Promise<VoiceBroadcastRecording | null> => {\n+    // Block starting a broadcast if the client is offline / in a sync error state\n+    const syncState = client.getSyncState?.();\n+    if (syncState && syncState !== \"SYNCING\" && syncState !== \"PREPARED\" && syncState !== \"CATCHUP\") {\n+        return null;\n+    }\n+\n     if (!(await checkVoiceBroadcastPreConditions(room, client, recordingsStore))) {\n         return null;\n     }\n@@ -97,4 +104,4 @@ export const startNewVoiceBroadcastRecording = async (\n     playbacksStore.clearCurrent();\n \n     return startBroadcast(room, client, recordingsStore);\n-};\n+};"
}