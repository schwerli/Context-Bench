{
    "instance_id": "SWE-Bench-Pro__python__maintenance__bugfix__ab946da6",
    "original_id": "instance_internetarchive__openlibrary-60725705782832a2cb22e17c49697948a42a9d03-v298a7a812ceed28c4c18355a091f1b268fe56d86",
    "1_model_selected_files": [
        "openlibrary/plugins/upstream/models.py"
    ],
    "2_embedding_selected_files": [
        "openlibrary/plugins/upstream/utils.py",
        "openlibrary/plugins/upstream/account.py",
        "openlibrary/plugins/upstream/mybooks.py",
        "openlibrary/core/bookshelves.py",
        "openlibrary/plugins/upstream/code.py",
        "openlibrary/plugins/upstream/models.py",
        "openlibrary/core/models.py",
        "openlibrary/plugins/openlibrary/code.py",
        "openlibrary/core/edits.py",
        "openlibrary/plugins/upstream/checkins.py",
        "openlibrary/plugins/openlibrary/dev_instance.py",
        "openlibrary/plugins/openlibrary/status.py",
        "openlibrary/accounts/__init__.py",
        "openlibrary/plugins/openlibrary/utils.py",
        "openlibrary/plugins/upstream/forms.py",
        "openlibrary/accounts/model.py",
        "openlibrary/plugins/upstream/addbook.py",
        "openlibrary/plugins/upstream/borrow.py",
        "openlibrary/plugins/upstream/__init__.py",
        "openlibrary/plugins/upstream/covers.py",
        "openlibrary/plugins/openlibrary/api.py",
        "openlibrary/plugins/admin/code.py",
        "openlibrary/core/lending.py",
        "openlibrary/plugins/upstream/edits.py",
        "openlibrary/core/ratings.py",
        "openlibrary/core/sponsorships.py",
        "openlibrary/plugins/ol_infobase.py",
        "openlibrary/core/waitinglist.py",
        "openlibrary/plugins/upstream/recentchanges.py",
        "openlibrary/mocks/mock_infobase.py",
        "openlibrary/plugins/books/readlinks.py",
        "openlibrary/plugins/admin/__init__.py",
        "openlibrary/core/yearly_reading_goals.py",
        "openlibrary/core/db.py",
        "openlibrary/plugins/openlibrary/support.py",
        "openlibrary/core/observations.py"
    ],
    "3_final_combined_files": [
        "openlibrary/plugins/upstream/models.py",
        "openlibrary/plugins/upstream/utils.py",
        "openlibrary/plugins/upstream/account.py",
        "openlibrary/plugins/upstream/mybooks.py"
    ],
    "4_related_elements": {
        "openlibrary/plugins/upstream/models.py": [
            "function: User.get_safe_mode\nfunction: User.get_users_settings"
        ],
        "openlibrary/plugins/upstream/account.py": [
            "class: account_privacy"
        ],
        "openlibrary/plugins/upstream/utils.py": [
            ""
        ]
    },
    "5_sampled_edit_locs_and_patches": [
        {
            "sample_index": 0,
            "edit_locs": {
                "openlibrary/plugins/upstream/models.py": [
                    "class: User\nfunction: User.get_safe_mode\nfunction: User.save_preferences\nfunction: User.preferences"
                ],
                "openlibrary/plugins/upstream/utils.py": [
                    ""
                ],
                "openlibrary/plugins/upstream/account.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/openlibrary/plugins/upstream/models.py b/openlibrary/plugins/upstream/models.py\nindex ca9d409..40e34e6 100644\n--- a/openlibrary/plugins/upstream/models.py\n+++ b/openlibrary/plugins/upstream/models.py\n@@ -806,6 +806,35 @@ class User(models.User):\n         settings = web.ctx.site.get('%s/preferences' % self.key)\n         return settings.dict().get('notifications') if settings else {}\n \n+    def get_safe_mode(self):\n+        \"\"\"\n+        Returns the user's Safe Mode preference as 'yes', 'no', or '' when unset.\n+        Always reads from the preferences document to reflect the most recent value.\n+        \"\"\"\n+        settings = web.ctx.site.get('%s/preferences' % self.key)\n+        if not settings:\n+            return ''\n+        try:\n+            prefs = settings.dict()\n+        except Exception:\n+            return ''\n+        value = prefs.get('safe_mode')\n+        if value is None:\n+            value = prefs.get('safemode') or prefs.get('safeMode')\n+        if value is None:\n+            return ''\n+        if isinstance(value, bool):\n+            return 'yes' if value else 'no'\n+        if isinstance(value, int):\n+            return 'yes' if value else 'no'\n+        if isinstance(value, str):\n+            v = value.strip().lower()\n+            if v in ('yes', 'true', 'on', '1'):\n+                return 'yes'\n+            if v in ('no', 'false', 'off', '0'):\n+                return 'no'\n+        return ''\n+\n     def get_creation_info(self):\n         if web.ctx.path.startswith(\"/admin\"):\n             d = web.ctx.site.versions(\n"
            ]
        },
        {
            "sample_index": 1,
            "edit_locs": {
                "openlibrary/plugins/upstream/models.py": [
                    "function: User.get_safe_mode\nfunction: User.save_preferences\nfunction: User.preferences"
                ],
                "openlibrary/plugins/upstream/utils.py": [
                    ""
                ],
                "openlibrary/plugins/upstream/account.py": [
                    ""
                ]
            },
            "patches": [
                "diff --git a/openlibrary/plugins/upstream/models.py b/openlibrary/plugins/upstream/models.py\nindex ca9d409..483302f 100644\n--- a/openlibrary/plugins/upstream/models.py\n+++ b/openlibrary/plugins/upstream/models.py\n@@ -832,6 +832,41 @@ class User(models.User):\n         for loan in loans:\n             lending.sync_loan(loan['ocaid'])\n \n+    def get_safe_mode(self):\n+        \"\"\"Return the user's Safe Mode preference as 'yes', 'no', or '' (unset).\n+\n+        Always fetches from the preferences document to reflect the most recent\n+        value saved via save_preferences.\n+        \"\"\"\n+        settings = web.ctx.site.get(f\"{self.key}/preferences\")\n+        if not settings:\n+            return \"\"\n+\n+        # Obtain preferences as a plain dict\n+        prefs = settings.dict() if hasattr(settings, \"dict\") and callable(settings.dict) else dict(settings or {})\n+        val = prefs.get(\"safe_mode\", \"\")\n+\n+        # Normalize to 'yes', 'no', or ''\n+        if isinstance(val, str):\n+            v = val.strip().lower()\n+            if v in (\"yes\", \"no\", \"\"):\n+                return v\n+            if v in (\"true\", \"on\", \"1\"):\n+                return \"yes\"\n+            if v in (\"false\", \"off\", \"0\"):\n+                return \"no\"\n+            return \"\"\n+        if isinstance(val, bool):\n+            return \"yes\" if val else \"no\"\n+        if val is None:\n+            return \"\"\n+        if isinstance(val, int):\n+            if val == 1:\n+                return \"yes\"\n+            if val == 0:\n+                return \"no\"\n+        return \"\"\n+\n \n class UnitParser:\n     \"\"\"Parsers values like dimensions and weight.\n"
            ]
        }
    ],
    "6_final_selected_patch": "diff --git a/openlibrary/plugins/upstream/models.py b/openlibrary/plugins/upstream/models.py\nindex ca9d409..40e34e6 100644\n--- a/openlibrary/plugins/upstream/models.py\n+++ b/openlibrary/plugins/upstream/models.py\n@@ -806,6 +806,35 @@ class User(models.User):\n         settings = web.ctx.site.get('%s/preferences' % self.key)\n         return settings.dict().get('notifications') if settings else {}\n \n+    def get_safe_mode(self):\n+        \"\"\"\n+        Returns the user's Safe Mode preference as 'yes', 'no', or '' when unset.\n+        Always reads from the preferences document to reflect the most recent value.\n+        \"\"\"\n+        settings = web.ctx.site.get('%s/preferences' % self.key)\n+        if not settings:\n+            return ''\n+        try:\n+            prefs = settings.dict()\n+        except Exception:\n+            return ''\n+        value = prefs.get('safe_mode')\n+        if value is None:\n+            value = prefs.get('safemode') or prefs.get('safeMode')\n+        if value is None:\n+            return ''\n+        if isinstance(value, bool):\n+            return 'yes' if value else 'no'\n+        if isinstance(value, int):\n+            return 'yes' if value else 'no'\n+        if isinstance(value, str):\n+            v = value.strip().lower()\n+            if v in ('yes', 'true', 'on', '1'):\n+                return 'yes'\n+            if v in ('no', 'false', 'off', '0'):\n+                return 'no'\n+        return ''\n+\n     def get_creation_info(self):\n         if web.ctx.path.startswith(\"/admin\"):\n             d = web.ctx.site.versions(\n"
}