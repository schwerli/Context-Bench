{
  "instance_id": "Multi-SWE-Bench__typescript__maintenance__bugfix__c3284db4",
  "original_id": "mui__material-ui-39108",
  "1_model_selected_files": [
    "packages/mui-base/src/useSelect/useSelect.ts",
    "packages/mui-base/src/useList/useList.ts",
    "packages/mui-base/src/useOption/useOption.ts",
    "packages/mui-joy/src/Select/index.ts"
  ],
  "2_embedding_selected_files": [
    "packages/mui-base/src/useAutocomplete/useAutocomplete.js",
    "packages/mui-base/src/useSelect/useSelect.ts",
    "packages/mui-base/src/utils/useTextNavigation.ts",
    "packages/mui-base/src/useAutocomplete/useAutocomplete.test.js",
    "packages/mui-base/src/useSlider/useSlider.ts",
    "packages/mui-base/src/useSelect/selectReducer.test.ts",
    "packages/mui-base/src/useList/listReducer.test.ts",
    "packages/mui-joy/src/Select/index.ts",
    "packages/mui-joy/src/Select/SelectProps.ts",
    "packages/mui-base/src/useList/listReducer.ts",
    "packages/mui-base/src/useAutocomplete/useAutocomplete.spec.ts",
    "packages/mui-base/src/Select/index.ts",
    "packages/mui-base/src/Select/Select.types.ts",
    "packages/mui-base/src/useList/useList.ts",
    "packages/mui-joy/src/Select/selectClasses.ts",
    "packages/mui-joy/src/Autocomplete/AutocompleteProps.ts",
    "packages/mui-base/src/useAutocomplete/useAutocomplete.d.ts",
    "packages/mui-joy/src/index.test.js",
    "packages/mui-base/src/unstable_useNumberInput/useNumberInput.ts",
    "packages/mui-base/src/ClickAwayListener/ClickAwayListener.test.js",
    "packages/mui-base/src/useSelect/selectReducer.ts",
    "packages/mui-base/src/useMenu/useMenu.test.js",
    "packages/mui-base/src/useTabsList/useTabsList.ts",
    "packages/mui-joy/src/styles/components.d.ts",
    "packages/mui-base/src/useButton/useButton.ts",
    "packages/mui-base/src/useSelect/useSelect.types.ts",
    "packages/mui-joy/src/styles/variantUtils.test.js",
    "packages/mui-joy/src/Tab/TabProps.ts",
    "packages/mui-base/src/useMenu/useMenu.ts",
    "packages/mui-base/src/Tabs/TabsContext.ts",
    "packages/mui-base/src/MultiSelect/index.ts",
    "packages/mui-joy/src/styles/extendTheme.spec.ts",
    "packages/mui-base/src/useInput/useInput.ts"
  ],
  "3_final_combined_files": [
    "packages/mui-base/src/useSelect/useSelect.ts",
    "packages/mui-base/src/useList/useList.ts",
    "packages/mui-base/src/useOption/useOption.ts",
    "packages/mui-base/src/useAutocomplete/useAutocomplete.js",
    "packages/mui-base/src/utils/useTextNavigation.ts"
  ],
  "4_related_elements": {
    "packages/mui-base/src/useSelect/useSelect.ts": [
      "function: useSelect\nfunction: getButtonProps\nfunction: getSelectTriggerProps\nfunction: getListboxProps\nfunction: createHandleButtonMouseDown\nfunction: handleStateChange\nvariable: visuallyHiddenStyle\nfunction: preventDefault"
    ],
    "packages/mui-base/src/useList/useList.ts": [
      "function: useList\nfunction: createHandleKeyDown\nfunction: getRootProps\nfunction: createHandleBlur"
    ],
    "packages/mui-base/src/useOption/useOption.ts": [
      "function: useOption"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "packages/mui-base/src/useSelect/useSelect.ts": [
          "line: 349"
        ],
        "packages/mui-base/src/useList/useList.ts": [
          "line: 291\nline: 292\nline: 293\nline: 294\nline: 301"
        ],
        "packages/mui-base/src/useOption/useOption.ts": [
          ""
        ]
      },
      "patches": [
        "diff --git a/packages/mui-base/src/useList/useList.ts b/packages/mui-base/src/useList/useList.ts\nindex 6060e75..7dbe120 100644\n--- a/packages/mui-base/src/useList/useList.ts\n+++ b/packages/mui-base/src/useList/useList.ts\n@@ -1,3 +1,4 @@\n+\n 'use client';\n import * as React from 'react';\n import { unstable_useForkRef as useForkRef } from '@mui/utils';\n@@ -288,9 +289,11 @@ function useList<\n       const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n \n       if (orientation === 'vertical') {\n-        keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n+        // Include legacy WebKit key values ('Up'/'Down') in addition to standard 'ArrowUp'/'ArrowDown'\n+        keysToPreventDefault.push('ArrowUp', 'ArrowDown', 'Up', 'Down');\n       } else {\n-        keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\n+        // Include legacy WebKit key values ('Left'/'Right') in addition to standard 'ArrowLeft'/'ArrowRight'\n+        keysToPreventDefault.push('ArrowLeft', 'ArrowRight', 'Left', 'Right');\n       }\n \n       if (focusManagement === 'activeDescendant') {\n@@ -298,7 +301,8 @@ function useList<\n         // the list handles keyboard events on its behalf.\n         // We have to `preventDefault()` is this case to prevent the browser from\n         // scrolling the view when space is pressed or submitting forms when enter is pressed.\n-        keysToPreventDefault.push(' ', 'Enter');\n+        // Include legacy 'Spacebar' for older WebKit.\n+        keysToPreventDefault.push(' ', 'Enter', 'Spacebar');\n       }\n \n       if (keysToPreventDefault.includes(event.key)) {\n@@ -406,4 +410,4 @@ function useList<\n   };\n }\n \n-export { useList };\n+export { useList };\ndiff --git a/packages/mui-base/src/useSelect/useSelect.ts b/packages/mui-base/src/useSelect/useSelect.ts\nindex 477ec4a..c353b34 100644\n--- a/packages/mui-base/src/useSelect/useSelect.ts\n+++ b/packages/mui-base/src/useSelect/useSelect.ts\n@@ -1,3 +1,4 @@\n+\n 'use client';\n import * as React from 'react';\n import {\n@@ -411,13 +412,33 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n   const getHiddenInputProps = <ExternalProps extends Record<string, unknown>>(\n     externalProps: ExternalProps = {} as ExternalProps,\n   ): UseSelectHiddenInputSlotProps<ExternalProps> => {\n+    // Safari, when \"Press Tab to highlight each item on a webpage\" is disabled (default),\n+    // does not move focus to buttons with Tab. Making a (visually hidden) input focusable\n+    // ensures the Select is reachable via Tab. On focus, we immediately move the focus\n+    // to the button so keyboard navigation works as expected.\n+    const isSafari =\n+      typeof navigator !== 'undefined' &&\n+      /Safari/i.test(navigator.userAgent) &&\n+      !/Chrome|Chromium|Android/i.test(navigator.userAgent);\n+\n+    const handleHiddenInputFocus = (event: React.FocusEvent<HTMLInputElement>) => {\n+      // If the consumer provided an onFocus, call it first.\n+      (externalProps as any)?.onFocus?.(event);\n+      // Move focus to the trigger button so that arrow keys and other handlers work.\n+      // Use setTimeout to avoid interfering with the browser's focus navigation order.\n+      setTimeout(() => {\n+        buttonRef.current?.focus();\n+      });\n+    };\n+\n     return {\n       name,\n-      tabIndex: -1,\n+      tabIndex: isSafari ? 0 : -1,\n       'aria-hidden': true,\n       required: required ? true : undefined,\n       value: getSerializedValue(selectedOptionsMetadata),\n       onChange: noop,\n+      onFocus: isSafari ? handleHiddenInputFocus : (externalProps as any)?.onFocus,\n       style: visuallyHiddenStyle,\n       ...externalProps,\n     };\n@@ -442,4 +463,4 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n   };\n }\n \n-export { useSelect };\n+export { useSelect };\n",
        "diff --git a/packages/mui-base/src/useList/useList.ts b/packages/mui-base/src/useList/useList.ts\nindex 6060e75..d05b1db 100644\n--- a/packages/mui-base/src/useList/useList.ts\n+++ b/packages/mui-base/src/useList/useList.ts\n@@ -287,7 +287,8 @@ function useList<\n \n       const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n \n-      if (orientation === 'vertical') {\n+      if (orientation !== 'horizontal') {\n+        // Default to vertical list behavior when orientation is undefined.\n         keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n       } else {\n         keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\ndiff --git a/packages/mui-base/src/useSelect/useSelect.ts b/packages/mui-base/src/useSelect/useSelect.ts\nindex 477ec4a..d94b1f1 100644\n--- a/packages/mui-base/src/useSelect/useSelect.ts\n+++ b/packages/mui-base/src/useSelect/useSelect.ts\n@@ -343,7 +343,8 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n       ...otherHandlers,\n       onMouseDown: createHandleButtonMouseDown(otherHandlers),\n       ref: mergedListRootRef,\n-      role: 'combobox' as const,\n+      role: 'button' as const,\n+      'aria-haspopup': 'listbox' as const,\n       'aria-expanded': open,\n       'aria-controls': listboxId,\n     };\n"
      ],
      "edit_loc_traj": {
        "prompt": "\nPlease review the following GitHub problem description and relevant files, and provide a set of locations that need to be edited to fix the issue.\nThe locations can be specified as class names, function or method names, or exact line numbers that require modification.\n\n### GitHub Problem Description ###\n[Select][base-ui] Keyboard navigation does not work in Safari\n### Duplicates\n\n- [X] I have searched the existing issues\n\n### Latest version\n\n- [X] I have tested the latest version\n\n### Steps to reproduce ðŸ•¹\n\nLink to live example: https://mui.com/joy-ui/react-select/#basic-usage\r\n\r\nSteps:\r\n\r\n1. Open the example in Safari\r\n2. Use the arrow keys to select an option (this does not work)\r\n**or** use the tab key to focus the Select (this does not work)\r\n\n\n### Current behavior ðŸ˜¯\n\nThe Joy Select component does not work with the keyboard in **Safari**. There are two issues:\r\n\r\n- Selecting an option with the arrow keys does not work. Instead, the arrow keys scroll the page.\r\n- Unlike the MUI Select, the Joy Select cannot be selected with the tab key. This is an accessibility issues, especially when filling out forms.\n\n### Expected behavior ðŸ¤”\n\nThe Joy Select should work with the keyboard in Safari as it does in Chrome. The arrow keys should select menu items, and the tab key should focus the Select.\n\n### Context ðŸ”¦\n\n_No response_\n\n### Your environment ðŸŒŽ\n\n_No response_\n\n###\n### packages/mui-base/src/useSelect/useSelect.ts\n1|'use client';\n2|import * as React from 'react';\n3|import {\n4|  unstable_useForkRef as useForkRef,\n5|  unstable_useId as useId,\n6|  unstable_useEnhancedEffect as useEnhancedEffect,\n7|} from '@mui/utils';\n8|import { useButton } from '../useButton';\n9|import {\n10|  ButtonClickAction,\n11|  SelectAction,\n12|  SelectActionTypes,\n13|  SelectInternalState,\n14|  SelectValue,\n15|  UseSelectButtonSlotProps,\n16|  UseSelectHiddenInputSlotProps,\n17|  UseSelectListboxSlotProps,\n18|  UseSelectParameters,\n19|  UseSelectReturnValue,\n20|} from './useSelect.types';\n21|import { useList, UseListParameters } from '../useList';\n22|import { EventHandlers } from '../utils/types';\n23|import { defaultOptionStringifier } from './defaultOptionStringifier';\n24|import { SelectProviderValue } from './SelectProvider';\n25|import { useCompoundParent } from '../utils/useCompound';\n26|import { extractEventHandlers } from '../utils/extractEventHandlers';\n27|import { SelectOption } from '../useOption/useOption.types';\n28|import { selectReducer } from './selectReducer';\n29|import { combineHooksSlotProps } from '../utils/combineHooksSlotProps';\n30|import { MuiCancellableEvent } from '../utils/MuiCancellableEvent';\n31|\n32|// visually hidden style based on https://webaim.org/techniques/css/invisiblecontent/\n33|const visuallyHiddenStyle: React.CSSProperties = {\n34|  clip: 'rect(1px, 1px, 1px, 1px)',\n35|  clipPath: 'inset(50%)',\n36|  height: '1px',\n37|  width: '1px',\n38|  margin: '-1px',\n39|  overflow: 'hidden',\n40|  padding: 0,\n41|  position: 'absolute',\n42|  left: '50%',\n43|  bottom: 0, // to display the native browser validation error at the bottom of the Select.\n44|};\n45|\n46|const noop = () => {};\n47|\n48|function defaultFormValueProvider<OptionValue>(\n49|  selectedOption: SelectOption<OptionValue> | SelectOption<OptionValue>[] | null,\n50|) {\n51|  if (Array.isArray(selectedOption)) {\n52|    if (selectedOption.length === 0) {\n53|      return '';\n54|    }\n55|\n56|    return JSON.stringify(selectedOption.map((o) => o.value));\n57|  }\n58|\n59|  if (selectedOption?.value == null) {\n60|    return '';\n61|  }\n62|\n63|  if (typeof selectedOption.value === 'string' || typeof selectedOption.value === 'number') {\n64|    return selectedOption.value;\n65|  }\n66|\n67|  return JSON.stringify(selectedOption.value);\n68|}\n69|\n70|function preventDefault(event: React.SyntheticEvent) {\n71|  event.preventDefault();\n72|}\n73|\n74|/**\n75| *\n76| * Demos:\n77| *\n78| * - [Select](https://mui.com/base-ui/react-select/#hooks)\n79| *\n80| * API:\n81| *\n82| * - [useSelect API](https://mui.com/base-ui/react-select/hooks-api/#use-select)\n83| */\n84|function useSelect<OptionValue, Multiple extends boolean = false>(\n85|  props: UseSelectParameters<OptionValue, Multiple>,\n86|): UseSelectReturnValue<OptionValue, Multiple> {\n87|  const {\n88|    areOptionsEqual,\n89|    buttonRef: buttonRefProp,\n90|    defaultOpen = false,\n91|    defaultValue: defaultValueProp,\n92|    disabled = false,\n93|    listboxId: listboxIdProp,\n94|    listboxRef: listboxRefProp,\n95|    multiple = false as Multiple,\n96|    name,\n97|    required,\n98|    onChange,\n99|    onHighlightChange,\n100|    onOpenChange,\n101|    open: openProp,\n102|    options: optionsParam,\n103|    getOptionAsString = defaultOptionStringifier,\n104|    getSerializedValue = defaultFormValueProvider,\n105|    value: valueProp,\n106|  } = props;\n107|\n108|  const buttonRef = React.useRef<HTMLElement>(null);\n109|  const handleButtonRef = useForkRef(buttonRefProp, buttonRef);\n110|\n111|  const listboxRef = React.useRef<HTMLElement>(null);\n112|  const listboxId = useId(listboxIdProp);\n113|\n114|  let defaultValue: OptionValue[] | undefined;\n115|  if (valueProp === undefined && defaultValueProp === undefined) {\n116|    defaultValue = [];\n117|  } else if (defaultValueProp !== undefined) {\n118|    if (multiple) {\n119|      defaultValue = defaultValueProp as OptionValue[];\n120|    } else {\n121|      defaultValue = defaultValueProp == null ? [] : [defaultValueProp as OptionValue];\n122|    }\n123|  }\n124|\n125|  const value = React.useMemo(() => {\n126|    if (valueProp !== undefined) {\n127|      if (multiple) {\n128|        return valueProp as OptionValue[];\n129|      }\n130|\n131|      return valueProp == null ? [] : [valueProp as OptionValue];\n132|    }\n133|\n134|    return undefined;\n135|  }, [valueProp, multiple]);\n136|\n137|  const { subitems, contextValue: compoundComponentContextValue } = useCompoundParent<\n138|    OptionValue,\n139|    SelectOption<OptionValue>\n140|  >();\n141|\n142|  const options = React.useMemo(() => {\n143|    if (optionsParam != null) {\n144|      return new Map(\n145|        optionsParam.map((option, index) => [\n146|          option.value,\n147|          {\n148|            value: option.value,\n149|            label: option.label,\n150|            disabled: option.disabled,\n151|            ref: React.createRef<HTMLElement>(),\n152|            id: `${listboxId}_${index}`,\n153|          },\n154|        ]),\n155|      );\n156|    }\n157|\n158|    return subitems;\n159|  }, [optionsParam, subitems, listboxId]);\n160|\n161|  const handleListboxRef = useForkRef(listboxRefProp, listboxRef);\n162|\n163|  const {\n164|    getRootProps: getButtonRootProps,\n165|    active: buttonActive,\n166|    focusVisible: buttonFocusVisible,\n167|    rootRef: mergedButtonRef,\n168|  } = useButton({\n169|    disabled,\n170|    rootRef: handleButtonRef,\n171|  });\n172|\n173|  const optionValues = React.useMemo(() => Array.from(options.keys()), [options]);\n174|\n175|  const getOptionByValue = React.useCallback(\n176|    (valueToGet: OptionValue) => {\n177|      // This can't be simply `options.get(valueToGet)` because of the `areOptionsEqual` prop.\n178|      // If it's provided, we assume that the user wants to compare the options by value.\n179|      if (areOptionsEqual !== undefined) {\n180|        const similarValue = optionValues.find((optionValue) =>\n181|          areOptionsEqual(optionValue, valueToGet),\n182|        )!;\n183|        return options.get(similarValue);\n184|      }\n185|\n186|      return options.get(valueToGet);\n187|    },\n188|    [options, areOptionsEqual, optionValues],\n189|  );\n190|\n191|  const isItemDisabled = React.useCallback(\n192|    (valueToCheck: OptionValue) => {\n193|      const option = getOptionByValue(valueToCheck);\n194|      return option?.disabled ?? false;\n195|    },\n196|    [getOptionByValue],\n197|  );\n198|\n199|  const stringifyOption = React.useCallback(\n200|    (valueToCheck: OptionValue) => {\n201|      const option = getOptionByValue(valueToCheck);\n202|      if (!option) {\n203|        return '';\n204|      }\n205|\n206|      return getOptionAsString(option);\n207|    },\n208|    [getOptionByValue, getOptionAsString],\n209|  );\n210|\n211|  const controlledState = React.useMemo(\n212|    () => ({\n213|      selectedValues: value,\n214|      open: openProp,\n215|    }),\n216|    [value, openProp],\n217|  );\n218|\n219|  const getItemId = React.useCallback(\n220|    (itemValue: OptionValue) => options.get(itemValue)?.id,\n221|    [options],\n222|  );\n223|\n224|  const handleSelectionChange = React.useCallback(\n225|    (\n226|      event:\n227|        | React.MouseEvent<Element, MouseEvent>\n228|        | React.KeyboardEvent<Element>\n229|        | React.FocusEvent<Element, Element>\n230|        | null,\n231|      newValues: OptionValue[],\n232|    ) => {\n233|      if (multiple) {\n234|        onChange?.(event, newValues as SelectValue<OptionValue, Multiple>);\n235|      } else {\n236|        onChange?.(event, (newValues[0] ?? null) as SelectValue<OptionValue, Multiple>);\n237|      }\n238|    },\n239|    [multiple, onChange],\n240|  );\n241|\n242|  const handleHighlightChange = React.useCallback(\n243|    (\n244|      event:\n245|        | React.MouseEvent<Element, MouseEvent>\n246|        | React.KeyboardEvent<Element>\n247|        | React.FocusEvent<Element, Element>\n248|        | null,\n249|      newValue: OptionValue | null,\n250|    ) => {\n251|      onHighlightChange?.(event, newValue ?? null);\n252|    },\n253|    [onHighlightChange],\n254|  );\n255|\n256|  const handleStateChange = React.useCallback(\n257|    (event: React.SyntheticEvent | null, field: string, fieldValue: any) => {\n258|      if (field === 'open') {\n259|        onOpenChange?.(fieldValue as boolean);\n260|        if (fieldValue === false && event?.type !== 'blur') {\n261|          buttonRef.current?.focus();\n262|        }\n263|      }\n264|    },\n265|    [onOpenChange],\n266|  );\n267|\n268|  const useListParameters: UseListParameters<\n269|    OptionValue,\n270|    SelectInternalState<OptionValue>,\n271|    SelectAction,\n272|    { multiple: boolean }\n273|  > = {\n274|    getInitialState: () => ({\n275|      highlightedValue: null,\n276|      selectedValues: defaultValue ?? [],\n277|      open: defaultOpen,\n278|    }),\n279|    getItemId,\n280|    controlledProps: controlledState,\n281|    itemComparer: areOptionsEqual,\n282|    isItemDisabled,\n283|    rootRef: mergedButtonRef,\n284|    onChange: handleSelectionChange,\n285|    onHighlightChange: handleHighlightChange,\n286|    onStateChange: handleStateChange,\n287|    reducerActionContext: React.useMemo(() => ({ multiple }), [multiple]),\n288|    items: optionValues,\n289|    getItemAsString: stringifyOption,\n290|    selectionMode: multiple ? 'multiple' : 'single',\n291|    stateReducer: selectReducer,\n292|  };\n293|\n294|  const {\n295|    dispatch,\n296|    getRootProps: getListboxRootProps,\n297|    contextValue: listContextValue,\n298|    state: { open, highlightedValue: highlightedOption, selectedValues: selectedOptions },\n299|    rootRef: mergedListRootRef,\n300|  } = useList(useListParameters);\n301|\n302|  const createHandleButtonMouseDown =\n303|    (externalEventHandlers?: EventHandlers) => (event: React.MouseEvent & MuiCancellableEvent) => {\n304|      externalEventHandlers?.onMouseDown?.(event);\n305|      if (!event.defaultMuiPrevented) {\n306|        const action: ButtonClickAction = {\n307|          type: SelectActionTypes.buttonClick,\n308|          event,\n309|        };\n310|\n311|        dispatch(action);\n312|      }\n313|    };\n314|\n315|  useEnhancedEffect(() => {\n316|    // Scroll to the currently highlighted option.\n317|    if (highlightedOption != null) {\n318|      const optionRef = getOptionByValue(highlightedOption)?.ref;\n319|      if (!listboxRef.current || !optionRef?.current) {\n320|        return;\n321|      }\n322|\n323|      const listboxClientRect = (listboxRef.current as HTMLElement).getBoundingClientRect();\n324|      const optionClientRect = optionRef.current.getBoundingClientRect();\n325|\n326|      if (optionClientRect.top < listboxClientRect.top) {\n327|        listboxRef.current.scrollTop -= listboxClientRect.top - optionClientRect.top;\n328|      } else if (optionClientRect.bottom > listboxClientRect.bottom) {\n329|        listboxRef.current.scrollTop += optionClientRect.bottom - listboxClientRect.bottom;\n330|      }\n331|    }\n332|  }, [highlightedOption, getOptionByValue]);\n333|\n334|  const getOptionMetadata = React.useCallback(\n335|    (optionValue: OptionValue) => getOptionByValue(optionValue),\n336|    [getOptionByValue],\n337|  );\n338|\n339|  const getSelectTriggerProps = <OtherHandlers extends EventHandlers>(\n340|    otherHandlers: OtherHandlers = {} as OtherHandlers,\n341|  ) => {\n342|    return {\n343|      ...otherHandlers,\n344|      onMouseDown: createHandleButtonMouseDown(otherHandlers),\n345|      ref: mergedListRootRef,\n346|      role: 'combobox' as const,\n347|      'aria-expanded': open,\n348|      'aria-controls': listboxId,\n349|    };\n350|  };\n351|\n352|  const getButtonProps = <ExternalProps extends Record<string, unknown>>(\n353|    externalProps: ExternalProps = {} as ExternalProps,\n354|  ): UseSelectButtonSlotProps<ExternalProps> => {\n355|    const externalEventHandlers = extractEventHandlers(externalProps);\n356|    const listboxAndButtonProps = combineHooksSlotProps(getButtonRootProps, getListboxRootProps);\n357|    const combinedProps = combineHooksSlotProps(listboxAndButtonProps, getSelectTriggerProps);\n358|    return {\n359|      ...externalProps,\n360|      ...combinedProps(externalEventHandlers),\n361|    };\n362|  };\n363|\n364|  const getListboxProps = <ExternalProps extends Record<string, unknown>>(\n365|    externalProps: ExternalProps = {} as ExternalProps,\n366|  ): UseSelectListboxSlotProps<ExternalProps> => {\n367|    return {\n368|      ...externalProps,\n369|      id: listboxId,\n370|      role: 'listbox' as const,\n371|      'aria-multiselectable': multiple ? 'true' : undefined,\n372|      ref: handleListboxRef,\n373|      onMouseDown: preventDefault, // to prevent the button from losing focus when interacting with the listbox\n374|    };\n375|  };\n376|\n377|  React.useDebugValue({\n378|    selectedOptions,\n379|    highlightedOption,\n380|    open,\n381|  });\n382|\n383|  const contextValue: SelectProviderValue<OptionValue> = React.useMemo(\n384|    () => ({\n385|      ...listContextValue,\n386|      ...compoundComponentContextValue,\n387|    }),\n388|    [listContextValue, compoundComponentContextValue],\n389|  );\n390|\n391|  let selectValue: SelectValue<OptionValue, Multiple>;\n392|  if (props.multiple) {\n393|    selectValue = selectedOptions as SelectValue<OptionValue, Multiple>;\n394|  } else {\n395|    selectValue = (selectedOptions.length > 0 ? selectedOptions[0] : null) as SelectValue<\n396|      OptionValue,\n397|      Multiple\n398|    >;\n399|  }\n400|\n401|  let selectedOptionsMetadata: SelectValue<SelectOption<OptionValue>, Multiple>;\n402|  if (multiple) {\n403|    selectedOptionsMetadata = (selectValue as OptionValue[])\n404|      .map((v) => getOptionMetadata(v))\n405|      .filter((o) => o !== undefined) as SelectValue<SelectOption<OptionValue>, Multiple>;\n406|  } else {\n407|    selectedOptionsMetadata = (getOptionMetadata(selectValue as OptionValue) ??\n408|      null) as SelectValue<SelectOption<OptionValue>, Multiple>;\n409|  }\n410|\n411|  const getHiddenInputProps = <ExternalProps extends Record<string, unknown>>(\n412|    externalProps: ExternalProps = {} as ExternalProps,\n413|  ): UseSelectHiddenInputSlotProps<ExternalProps> => {\n414|    return {\n415|      name,\n416|      tabIndex: -1,\n417|      'aria-hidden': true,\n418|      required: required ? true : undefined,\n419|      value: getSerializedValue(selectedOptionsMetadata),\n420|      onChange: noop,\n421|      style: visuallyHiddenStyle,\n422|      ...externalProps,\n423|    };\n424|  };\n425|\n426|  return {\n427|    buttonActive,\n428|    buttonFocusVisible,\n429|    buttonRef: mergedButtonRef,\n430|    contextValue,\n431|    disabled,\n432|    dispatch,\n433|    getButtonProps,\n434|    getHiddenInputProps,\n435|    getListboxProps,\n436|    getOptionMetadata,\n437|    listboxRef: mergedListRootRef,\n438|    open,\n439|    options: optionValues,\n440|    value: selectValue,\n441|    highlightedOption,\n442|  };\n443|}\n444|\n445|export { useSelect };\n\n\n### packages/mui-base/src/useList/useList.ts\n1|'use client';\n2|import * as React from 'react';\n3|import { unstable_useForkRef as useForkRef } from '@mui/utils';\n4|import {\n5|  UseListParameters,\n6|  ListItemState,\n7|  UseListRootSlotProps,\n8|  ListState,\n9|  ListActionContext,\n10|  UseListReturnValue,\n11|} from './useList.types';\n12|import { ListActionTypes, ListAction } from './listActions.types';\n13|import { ListContextValue } from './ListContext';\n14|import { listReducer as defaultReducer } from './listReducer';\n15|import { useListChangeNotifiers } from './useListChangeNotifiers';\n16|import { useControllableReducer } from '../utils/useControllableReducer';\n17|import {\n18|  ControllableReducerAction,\n19|  StateChangeCallback,\n20|  StateComparers,\n21|} from '../utils/useControllableReducer.types';\n22|import { areArraysEqual } from '../utils/areArraysEqual';\n23|import { useLatest } from '../utils/useLatest';\n24|import { useTextNavigation } from '../utils/useTextNavigation';\n25|import { MuiCancellableEvent } from '../utils/MuiCancellableEvent';\n26|import { extractEventHandlers } from '../utils/extractEventHandlers';\n27|import { EventHandlers } from '../utils/types';\n28|\n29|const EMPTY_OBJECT = {};\n30|const NOOP = () => {};\n31|\n32|const defaultItemComparer = <ItemValue>(optionA: ItemValue, optionB: ItemValue) =>\n33|  optionA === optionB;\n34|\n35|const defaultIsItemDisabled = () => false;\n36|\n37|const defaultItemStringifier = <ItemValue>(item: ItemValue) =>\n38|  typeof item === 'string' ? item : String(item);\n39|\n40|const defaultGetInitialState = () => ({\n41|  highlightedValue: null,\n42|  selectedValues: [],\n43|});\n44|\n45|/**\n46| * The useList is a lower-level utility that is used to build list-like components.\n47| * It's used to manage the state of the list and its items.\n48| *\n49| * Supports highlighting a single item and selecting an arbitrary number of items.\n50| *\n51| * The state of the list is managed by a controllable reducer - that is a reducer that can have its state\n52| * controlled from outside.\n53| *\n54| * By default, the state consists of `selectedValues` and `highlightedValue` but can be extended by the caller of the hook.\n55| * Also the actions that can be dispatched and the reducer function can be defined externally.\n56| *\n57| * @template ItemValue The type of the item values.\n58| * @template State The type of the list state. This should be a subtype of `ListState<ItemValue>`.\n59| * @template CustomAction The type of the actions that can be dispatched (besides the standard ListAction).\n60| * @template CustomActionContext The shape of additional properties that will be added to actions when dispatched.\n61| *\n62| * @ignore - internal hook.\n63| */\n64|function useList<\n65|  ItemValue,\n66|  State extends ListState<ItemValue> = ListState<ItemValue>,\n67|  CustomAction extends ControllableReducerAction = never,\n68|  CustomActionContext = {},\n69|>(\n70|  params: UseListParameters<ItemValue, State, CustomAction, CustomActionContext>,\n71|): UseListReturnValue<ItemValue, State, CustomAction> {\n72|  const {\n73|    controlledProps = EMPTY_OBJECT,\n74|    disabledItemsFocusable = false,\n75|    disableListWrap = false,\n76|    focusManagement = 'activeDescendant',\n77|    getInitialState = defaultGetInitialState,\n78|    getItemDomElement,\n79|    getItemId,\n80|    isItemDisabled = defaultIsItemDisabled,\n81|    rootRef: externalListRef,\n82|    onStateChange = NOOP,\n83|    items,\n84|    itemComparer = defaultItemComparer,\n85|    getItemAsString = defaultItemStringifier,\n86|    onChange,\n87|    onHighlightChange,\n88|    onItemsChange,\n89|    orientation = 'vertical',\n90|    pageSize = 5,\n91|    reducerActionContext = EMPTY_OBJECT as CustomActionContext,\n92|    selectionMode = 'single',\n93|    stateReducer: externalReducer,\n94|  } = params;\n95|\n96|  if (process.env.NODE_ENV !== 'production') {\n97|    if (focusManagement === 'DOM' && getItemDomElement == null) {\n98|      throw new Error(\n99|        'useList: The `getItemDomElement` prop is required when using the `DOM` focus management.',\n100|      );\n101|    }\n102|\n103|    if (focusManagement === 'activeDescendant' && getItemId == null) {\n104|      throw new Error(\n105|        'useList: The `getItemId` prop is required when using the `activeDescendant` focus management.',\n106|      );\n107|    }\n108|  }\n109|\n110|  const listRef = React.useRef<HTMLUListElement>(null);\n111|  const handleRef = useForkRef(externalListRef, listRef);\n112|\n113|  const handleHighlightChange = React.useCallback(\n114|    (\n115|      event: React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n116|      value: ItemValue | null,\n117|      reason: string,\n118|    ) => {\n119|      onHighlightChange?.(event, value, reason);\n120|\n121|      if (\n122|        focusManagement === 'DOM' &&\n123|        value != null &&\n124|        (reason === ListActionTypes.itemClick ||\n125|          reason === ListActionTypes.keyDown ||\n126|          reason === ListActionTypes.textNavigation)\n127|      ) {\n128|        getItemDomElement?.(value)?.focus();\n129|      }\n130|    },\n131|    [getItemDomElement, onHighlightChange, focusManagement],\n132|  );\n133|\n134|  const stateComparers = React.useMemo(\n135|    () =>\n136|      ({\n137|        highlightedValue: itemComparer,\n138|        selectedValues: (valuesArray1, valuesArray2) =>\n139|          areArraysEqual(valuesArray1, valuesArray2, itemComparer),\n140|      } as StateComparers<State>),\n141|    [itemComparer],\n142|  );\n143|\n144|  // This gets called whenever a reducer changes the state.\n145|  const handleStateChange: StateChangeCallback<State> = React.useCallback(\n146|    (event, field, value, reason, state) => {\n147|      onStateChange?.(event, field, value, reason, state);\n148|\n149|      switch (field) {\n150|        case 'highlightedValue':\n151|          handleHighlightChange(\n152|            event as React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n153|            value as ItemValue | null,\n154|            reason,\n155|          );\n156|          break;\n157|        case 'selectedValues':\n158|          onChange?.(\n159|            event as React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n160|            value as ItemValue[],\n161|            reason,\n162|          );\n163|          break;\n164|        default:\n165|          break;\n166|      }\n167|    },\n168|    [handleHighlightChange, onChange, onStateChange],\n169|  );\n170|\n171|  // The following object is added to each action when it's dispatched.\n172|  // It's accessible in the reducer via the `action.context` field.\n173|  const listActionContext: ListActionContext<ItemValue> = React.useMemo(() => {\n174|    return {\n175|      disabledItemsFocusable,\n176|      disableListWrap,\n177|      focusManagement,\n178|      isItemDisabled,\n179|      itemComparer,\n180|      items,\n181|      getItemAsString,\n182|      onHighlightChange: handleHighlightChange,\n183|      orientation,\n184|      pageSize,\n185|      selectionMode,\n186|      stateComparers,\n187|    };\n188|  }, [\n189|    disabledItemsFocusable,\n190|    disableListWrap,\n191|    focusManagement,\n192|    isItemDisabled,\n193|    itemComparer,\n194|    items,\n195|    getItemAsString,\n196|    handleHighlightChange,\n197|    orientation,\n198|    pageSize,\n199|    selectionMode,\n200|    stateComparers,\n201|  ]);\n202|\n203|  const initialState = getInitialState();\n204|  const reducer = (externalReducer ?? defaultReducer) as React.Reducer<\n205|    State,\n206|    ListAction<ItemValue> | CustomAction\n207|  >;\n208|\n209|  const actionContext: ListActionContext<ItemValue> & CustomActionContext = React.useMemo(\n210|    () => ({ ...reducerActionContext, ...listActionContext }),\n211|    [reducerActionContext, listActionContext],\n212|  );\n213|\n214|  const [state, dispatch] = useControllableReducer<\n215|    State,\n216|    ListAction<ItemValue> | CustomAction,\n217|    ListActionContext<ItemValue> & CustomActionContext\n218|  >({\n219|    reducer,\n220|    actionContext,\n221|    initialState: initialState as State,\n222|    controlledProps,\n223|    stateComparers,\n224|    onStateChange: handleStateChange,\n225|  });\n226|\n227|  const { highlightedValue, selectedValues } = state;\n228|\n229|  const handleTextNavigation = useTextNavigation((searchString, event) =>\n230|    dispatch({\n231|      type: ListActionTypes.textNavigation,\n232|      event,\n233|      searchString,\n234|    }),\n235|  );\n236|\n237|  // introducing refs to avoid recreating the getItemState function on each change.\n238|  const latestSelectedValues = useLatest(selectedValues);\n239|  const latestHighlightedValue = useLatest(highlightedValue);\n240|  const previousItems = React.useRef<ItemValue[]>([]);\n241|\n242|  React.useEffect(() => {\n243|    // Whenever the `items` object changes, we need to determine if the actual items changed.\n244|    // If they did, we need to dispatch an `itemsChange` action, so the selected/highlighted state is updated.\n245|    if (areArraysEqual(previousItems.current, items, itemComparer)) {\n246|      return;\n247|    }\n248|\n249|    dispatch({\n250|      type: ListActionTypes.itemsChange,\n251|      event: null,\n252|      items,\n253|      previousItems: previousItems.current,\n254|    });\n255|\n256|    previousItems.current = items;\n257|    onItemsChange?.(items);\n258|  }, [items, itemComparer, dispatch, onItemsChange]);\n259|\n260|  // Subitems are notified of changes to the highlighted and selected values.\n261|  // This is not done via context because we don't want to trigger a re-render of all the subitems each time any of them changes state.\n262|  // Instead, we use a custom message bus to publish messages about changes.\n263|  // On the child component, we use a custom hook to subscribe to these messages and re-render only when the value they care about changes.\n264|  const {\n265|    notifySelectionChanged,\n266|    notifyHighlightChanged,\n267|    registerHighlightChangeHandler,\n268|    registerSelectionChangeHandler,\n269|  } = useListChangeNotifiers<ItemValue>();\n270|\n271|  React.useEffect(() => {\n272|    notifySelectionChanged(selectedValues);\n273|  }, [selectedValues, notifySelectionChanged]);\n274|\n275|  React.useEffect(() => {\n276|    notifyHighlightChanged(highlightedValue);\n277|  }, [highlightedValue, notifyHighlightChanged]);\n278|\n279|  const createHandleKeyDown =\n280|    (externalHandlers: EventHandlers) =>\n281|    (event: React.KeyboardEvent<HTMLElement> & MuiCancellableEvent) => {\n282|      externalHandlers.onKeyDown?.(event);\n283|\n284|      if (event.defaultMuiPrevented) {\n285|        return;\n286|      }\n287|\n288|      const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n289|\n290|      if (orientation === 'vertical') {\n291|        keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n292|      } else {\n293|        keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\n294|      }\n295|\n296|      if (focusManagement === 'activeDescendant') {\n297|        // When the child element is focused using the activeDescendant attribute,\n298|        // the list handles keyboard events on its behalf.\n299|        // We have to `preventDefault()` is this case to prevent the browser from\n300|        // scrolling the view when space is pressed or submitting forms when enter is pressed.\n301|        keysToPreventDefault.push(' ', 'Enter');\n302|      }\n303|\n304|      if (keysToPreventDefault.includes(event.key)) {\n305|        event.preventDefault();\n306|      }\n307|\n308|      dispatch({\n309|        type: ListActionTypes.keyDown,\n310|        key: event.key,\n311|        event,\n312|      });\n313|\n314|      handleTextNavigation(event);\n315|    };\n316|\n317|  const createHandleBlur =\n318|    (externalHandlers: EventHandlers) =>\n319|    (event: React.FocusEvent<HTMLElement> & MuiCancellableEvent) => {\n320|      externalHandlers.onBlur?.(event);\n321|\n322|      if (event.defaultMuiPrevented) {\n323|        return;\n324|      }\n325|\n326|      if (listRef.current?.contains(event.relatedTarget)) {\n327|        // focus remains within the list\n328|        return;\n329|      }\n330|\n331|      dispatch({\n332|        type: ListActionTypes.blur,\n333|        event,\n334|      });\n335|    };\n336|\n337|  const getRootProps = <ExternalProps extends Record<string, any> = {}>(\n338|    externalProps: ExternalProps = {} as ExternalProps,\n339|  ): UseListRootSlotProps<ExternalProps> => {\n340|    const externalEventHandlers = extractEventHandlers(externalProps);\n341|    return {\n342|      ...externalProps,\n343|      'aria-activedescendant':\n344|        focusManagement === 'activeDescendant' && highlightedValue != null\n345|          ? getItemId!(highlightedValue)\n346|          : undefined,\n347|      tabIndex: focusManagement === 'DOM' ? -1 : 0,\n348|      ref: handleRef,\n349|      ...externalEventHandlers,\n350|      onBlur: createHandleBlur(externalEventHandlers),\n351|      onKeyDown: createHandleKeyDown(externalEventHandlers),\n352|    };\n353|  };\n354|\n355|  const getItemState = React.useCallback(\n356|    (item: ItemValue): ListItemState => {\n357|      const index = items.findIndex((i) => itemComparer(i, item));\n358|      const selected = (latestSelectedValues.current ?? []).some(\n359|        (value) => value != null && itemComparer(item, value),\n360|      );\n361|\n362|      const disabled = isItemDisabled(item, index);\n363|      const highlighted =\n364|        latestHighlightedValue.current != null &&\n365|        itemComparer(item, latestHighlightedValue.current);\n366|      const focusable = focusManagement === 'DOM';\n367|\n368|      return {\n369|        disabled,\n370|        focusable,\n371|        highlighted,\n372|        index,\n373|        selected,\n374|      };\n375|    },\n376|    [\n377|      items,\n378|      isItemDisabled,\n379|      itemComparer,\n380|      latestSelectedValues,\n381|      latestHighlightedValue,\n382|      focusManagement,\n383|    ],\n384|  );\n385|\n386|  const contextValue: ListContextValue<ItemValue> = React.useMemo(\n387|    () => ({\n388|      dispatch,\n389|      getItemState,\n390|      registerHighlightChangeHandler,\n391|      registerSelectionChangeHandler,\n392|    }),\n393|    [dispatch, getItemState, registerHighlightChangeHandler, registerSelectionChangeHandler],\n394|  );\n395|\n396|  React.useDebugValue({\n397|    state,\n398|  });\n399|\n400|  return {\n401|    contextValue,\n402|    dispatch,\n403|    getRootProps,\n404|    rootRef: handleRef,\n405|    state,\n406|  };\n407|}\n408|\n409|export { useList };\n\n\n### packages/mui-base/src/useOption/useOption.ts\n...\n8|\n9|/**\n10| *\n11| * Demos:\n12| *\n13| * - [Select](https://mui.com/base-ui/react-select/#hooks)\n14| *\n15| * API:\n16| *\n17| * - [useOption API](https://mui.com/base-ui/react-select/hooks-api/#use-option)\n18| */\n19|export function useOption<Value>(params: UseOptionParameters<Value>): UseOptionReturnValue {\n20|  const { value, label, disabled, rootRef: optionRefParam, id: idParam } = params;\n21|\n22|  const {\n23|    getRootProps: getListItemProps,\n24|    rootRef: listItemRefHandler,\n25|    highlighted,\n26|    selected,\n27|  } = useListItem({\n28|    item: value,\n29|  });\n30|\n31|  const id = useId(idParam);\n32|\n33|  const optionRef = React.useRef<Element>(null);\n34|\n35|  const selectOption: SelectOption<Value> = React.useMemo(\n36|    () => ({\n37|      disabled,\n38|      label,\n39|      value,\n40|      ref: optionRef,\n41|      id,\n42|    }),\n43|    [disabled, label, value, id],\n44|  );\n45|\n46|  const { index } = useCompoundItem<Value, SelectOption<Value>>(value, selectOption);\n47|\n48|  const handleRef = useForkRef(optionRefParam, optionRef, listItemRefHandler)!;\n49|\n50|  return {\n51|    getRootProps: <ExternalProps extends Record<string, unknown> = {}>(\n52|      externalProps: ExternalProps = {} as ExternalProps,\n53|    ) => {\n54|      const externalEventHandlers = extractEventHandlers(externalProps);\n55|      return {\n56|        ...externalProps,\n57|        ...getListItemProps(externalEventHandlers),\n58|        id,\n59|        ref: handleRef,\n60|        role: 'option',\n61|        'aria-selected': selected,\n62|      };\n63|    },\n64|    highlighted,\n65|    index,\n66|    selected,\n67|    rootRef: handleRef,\n68|  };\n69|}\n\n\n\n\n###\n\nPlease provide the class name, function or method name, or the exact line numbers that need to be edited.\nThe possible location outputs should be either \"class\", \"function\" or \"line\".\n\n### Examples:\n```\nfull_path1/file1.ts\nline: 10\nclass: MyClass1\nline: 51\n\nfull_path2/file2.ts\nfunction: MyClass2.my_method\nline: 12\n\nfull_path3/file3.ts\nfunction: my_function\nline: 24\nline: 156\n```\n\nReturn just the location(s) wrapped with ```.\n",
        "response": [
          "```\npackages/mui-base/src/useSelect/useSelect.ts\nline: 349\n\npackages/mui-base/src/useList/useList.ts\nline: 291\nline: 292\nline: 293\nline: 294\nline: 301\n```",
          "```\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: createHandleButtonMouseDown\nline: 305\nline: 311\n\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: getSelectTriggerProps\nline: 344\nline: 350\n\npackages/mui-base/src/useList/useList.ts\nfunction: createHandleKeyDown\nline: 301\nline: 303\n```"
        ],
        "usage": {
          "completion_tokens": 0,
          "prompt_tokens": 0
        }
      },
      "additional_artifact_loc_edit_location": [
        {
          "raw_output_loc": [
            "```\npackages/mui-base/src/useSelect/useSelect.ts\nline: 349\n\npackages/mui-base/src/useList/useList.ts\nline: 291\nline: 292\nline: 293\nline: 294\nline: 301\n```",
            "```\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: createHandleButtonMouseDown\nline: 305\nline: 311\n\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: getSelectTriggerProps\nline: 344\nline: 350\n\npackages/mui-base/src/useList/useList.ts\nfunction: createHandleKeyDown\nline: 301\nline: 303\n```"
          ]
        }
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "packages/mui-base/src/useSelect/useSelect.ts": [
          "function: createHandleButtonMouseDown\nline: 305\nline: 311\nfunction: getSelectTriggerProps\nline: 344\nline: 350"
        ],
        "packages/mui-base/src/useList/useList.ts": [
          "function: createHandleKeyDown\nline: 301\nline: 303"
        ],
        "packages/mui-base/src/useOption/useOption.ts": [
          ""
        ]
      },
      "patches": [
        "diff --git a/packages/mui-base/src/useList/useList.ts b/packages/mui-base/src/useList/useList.ts\nindex 6060e75..bf497f6 100644\n--- a/packages/mui-base/src/useList/useList.ts\n+++ b/packages/mui-base/src/useList/useList.ts\n@@ -1,3 +1,4 @@\n+\n 'use client';\n import * as React from 'react';\n import { unstable_useForkRef as useForkRef } from '@mui/utils';\n@@ -288,9 +289,11 @@ function useList<\n       const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n \n       if (orientation === 'vertical') {\n-        keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n+        // Include legacy Safari key values ('Up'/'Down') in addition to standard 'Arrow*'\n+        keysToPreventDefault.push('ArrowUp', 'ArrowDown', 'Up', 'Down');\n       } else {\n-        keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\n+        // Include legacy Safari key values ('Left'/'Right') in addition to standard 'Arrow*'\n+        keysToPreventDefault.push('ArrowLeft', 'ArrowRight', 'Left', 'Right');\n       }\n \n       if (focusManagement === 'activeDescendant') {\n@@ -298,7 +301,8 @@ function useList<\n         // the list handles keyboard events on its behalf.\n         // We have to `preventDefault()` is this case to prevent the browser from\n         // scrolling the view when space is pressed or submitting forms when enter is pressed.\n-        keysToPreventDefault.push(' ', 'Enter');\n+        // Include legacy 'Spacebar' for Safari.\n+        keysToPreventDefault.push(' ', 'Enter', 'Spacebar');\n       }\n \n       if (keysToPreventDefault.includes(event.key)) {\n@@ -406,4 +410,4 @@ function useList<\n   };\n }\n \n-export { useList };\n+export { useList };\ndiff --git a/packages/mui-base/src/useSelect/useSelect.ts b/packages/mui-base/src/useSelect/useSelect.ts\nindex 477ec4a..0ddb39a 100644\n--- a/packages/mui-base/src/useSelect/useSelect.ts\n+++ b/packages/mui-base/src/useSelect/useSelect.ts\n@@ -1,3 +1,4 @@\n+\n 'use client';\n import * as React from 'react';\n import {\n@@ -346,6 +347,8 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n       role: 'combobox' as const,\n       'aria-expanded': open,\n       'aria-controls': listboxId,\n+      // Ensure the trigger is tabbable across browsers (notably Safari)\n+      tabIndex: disabled ? -1 : 0,\n     };\n   };\n \n@@ -442,4 +445,4 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n   };\n }\n \n-export { useSelect };\n+export { useSelect };\n",
        "diff --git a/packages/mui-base/src/useList/useList.ts b/packages/mui-base/src/useList/useList.ts\nindex 6060e75..f43d449 100644\n--- a/packages/mui-base/src/useList/useList.ts\n+++ b/packages/mui-base/src/useList/useList.ts\n@@ -289,8 +289,12 @@ function useList<\n \n       if (orientation === 'vertical') {\n         keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n-      } else {\n+      } else if (orientation === 'horizontal') {\n         keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\n+      } else {\n+        // When orientation is not specified, prevent default for all arrow keys to avoid browser scrolling,\n+        // especially in Safari where arrow keys may scroll the page.\n+        keysToPreventDefault.push('ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight');\n       }\n \n       if (focusManagement === 'activeDescendant') {\ndiff --git a/packages/mui-base/src/useSelect/useSelect.ts b/packages/mui-base/src/useSelect/useSelect.ts\nindex 477ec4a..2143b2d 100644\n--- a/packages/mui-base/src/useSelect/useSelect.ts\n+++ b/packages/mui-base/src/useSelect/useSelect.ts\n@@ -344,6 +344,7 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n       onMouseDown: createHandleButtonMouseDown(otherHandlers),\n       ref: mergedListRootRef,\n       role: 'combobox' as const,\n+      tabIndex: 0,\n       'aria-expanded': open,\n       'aria-controls': listboxId,\n     };\n"
      ],
      "edit_loc_traj": {
        "prompt": "\nPlease review the following GitHub problem description and relevant files, and provide a set of locations that need to be edited to fix the issue.\nThe locations can be specified as class names, function or method names, or exact line numbers that require modification.\n\n### GitHub Problem Description ###\n[Select][base-ui] Keyboard navigation does not work in Safari\n### Duplicates\n\n- [X] I have searched the existing issues\n\n### Latest version\n\n- [X] I have tested the latest version\n\n### Steps to reproduce ðŸ•¹\n\nLink to live example: https://mui.com/joy-ui/react-select/#basic-usage\r\n\r\nSteps:\r\n\r\n1. Open the example in Safari\r\n2. Use the arrow keys to select an option (this does not work)\r\n**or** use the tab key to focus the Select (this does not work)\r\n\n\n### Current behavior ðŸ˜¯\n\nThe Joy Select component does not work with the keyboard in **Safari**. There are two issues:\r\n\r\n- Selecting an option with the arrow keys does not work. Instead, the arrow keys scroll the page.\r\n- Unlike the MUI Select, the Joy Select cannot be selected with the tab key. This is an accessibility issues, especially when filling out forms.\n\n### Expected behavior ðŸ¤”\n\nThe Joy Select should work with the keyboard in Safari as it does in Chrome. The arrow keys should select menu items, and the tab key should focus the Select.\n\n### Context ðŸ”¦\n\n_No response_\n\n### Your environment ðŸŒŽ\n\n_No response_\n\n###\n### packages/mui-base/src/useSelect/useSelect.ts\n1|'use client';\n2|import * as React from 'react';\n3|import {\n4|  unstable_useForkRef as useForkRef,\n5|  unstable_useId as useId,\n6|  unstable_useEnhancedEffect as useEnhancedEffect,\n7|} from '@mui/utils';\n8|import { useButton } from '../useButton';\n9|import {\n10|  ButtonClickAction,\n11|  SelectAction,\n12|  SelectActionTypes,\n13|  SelectInternalState,\n14|  SelectValue,\n15|  UseSelectButtonSlotProps,\n16|  UseSelectHiddenInputSlotProps,\n17|  UseSelectListboxSlotProps,\n18|  UseSelectParameters,\n19|  UseSelectReturnValue,\n20|} from './useSelect.types';\n21|import { useList, UseListParameters } from '../useList';\n22|import { EventHandlers } from '../utils/types';\n23|import { defaultOptionStringifier } from './defaultOptionStringifier';\n24|import { SelectProviderValue } from './SelectProvider';\n25|import { useCompoundParent } from '../utils/useCompound';\n26|import { extractEventHandlers } from '../utils/extractEventHandlers';\n27|import { SelectOption } from '../useOption/useOption.types';\n28|import { selectReducer } from './selectReducer';\n29|import { combineHooksSlotProps } from '../utils/combineHooksSlotProps';\n30|import { MuiCancellableEvent } from '../utils/MuiCancellableEvent';\n31|\n32|// visually hidden style based on https://webaim.org/techniques/css/invisiblecontent/\n33|const visuallyHiddenStyle: React.CSSProperties = {\n34|  clip: 'rect(1px, 1px, 1px, 1px)',\n35|  clipPath: 'inset(50%)',\n36|  height: '1px',\n37|  width: '1px',\n38|  margin: '-1px',\n39|  overflow: 'hidden',\n40|  padding: 0,\n41|  position: 'absolute',\n42|  left: '50%',\n43|  bottom: 0, // to display the native browser validation error at the bottom of the Select.\n44|};\n45|\n46|const noop = () => {};\n47|\n48|function defaultFormValueProvider<OptionValue>(\n49|  selectedOption: SelectOption<OptionValue> | SelectOption<OptionValue>[] | null,\n50|) {\n51|  if (Array.isArray(selectedOption)) {\n52|    if (selectedOption.length === 0) {\n53|      return '';\n54|    }\n55|\n56|    return JSON.stringify(selectedOption.map((o) => o.value));\n57|  }\n58|\n59|  if (selectedOption?.value == null) {\n60|    return '';\n61|  }\n62|\n63|  if (typeof selectedOption.value === 'string' || typeof selectedOption.value === 'number') {\n64|    return selectedOption.value;\n65|  }\n66|\n67|  return JSON.stringify(selectedOption.value);\n68|}\n69|\n70|function preventDefault(event: React.SyntheticEvent) {\n71|  event.preventDefault();\n72|}\n73|\n74|/**\n75| *\n76| * Demos:\n77| *\n78| * - [Select](https://mui.com/base-ui/react-select/#hooks)\n79| *\n80| * API:\n81| *\n82| * - [useSelect API](https://mui.com/base-ui/react-select/hooks-api/#use-select)\n83| */\n84|function useSelect<OptionValue, Multiple extends boolean = false>(\n85|  props: UseSelectParameters<OptionValue, Multiple>,\n86|): UseSelectReturnValue<OptionValue, Multiple> {\n87|  const {\n88|    areOptionsEqual,\n89|    buttonRef: buttonRefProp,\n90|    defaultOpen = false,\n91|    defaultValue: defaultValueProp,\n92|    disabled = false,\n93|    listboxId: listboxIdProp,\n94|    listboxRef: listboxRefProp,\n95|    multiple = false as Multiple,\n96|    name,\n97|    required,\n98|    onChange,\n99|    onHighlightChange,\n100|    onOpenChange,\n101|    open: openProp,\n102|    options: optionsParam,\n103|    getOptionAsString = defaultOptionStringifier,\n104|    getSerializedValue = defaultFormValueProvider,\n105|    value: valueProp,\n106|  } = props;\n107|\n108|  const buttonRef = React.useRef<HTMLElement>(null);\n109|  const handleButtonRef = useForkRef(buttonRefProp, buttonRef);\n110|\n111|  const listboxRef = React.useRef<HTMLElement>(null);\n112|  const listboxId = useId(listboxIdProp);\n113|\n114|  let defaultValue: OptionValue[] | undefined;\n115|  if (valueProp === undefined && defaultValueProp === undefined) {\n116|    defaultValue = [];\n117|  } else if (defaultValueProp !== undefined) {\n118|    if (multiple) {\n119|      defaultValue = defaultValueProp as OptionValue[];\n120|    } else {\n121|      defaultValue = defaultValueProp == null ? [] : [defaultValueProp as OptionValue];\n122|    }\n123|  }\n124|\n125|  const value = React.useMemo(() => {\n126|    if (valueProp !== undefined) {\n127|      if (multiple) {\n128|        return valueProp as OptionValue[];\n129|      }\n130|\n131|      return valueProp == null ? [] : [valueProp as OptionValue];\n132|    }\n133|\n134|    return undefined;\n135|  }, [valueProp, multiple]);\n136|\n137|  const { subitems, contextValue: compoundComponentContextValue } = useCompoundParent<\n138|    OptionValue,\n139|    SelectOption<OptionValue>\n140|  >();\n141|\n142|  const options = React.useMemo(() => {\n143|    if (optionsParam != null) {\n144|      return new Map(\n145|        optionsParam.map((option, index) => [\n146|          option.value,\n147|          {\n148|            value: option.value,\n149|            label: option.label,\n150|            disabled: option.disabled,\n151|            ref: React.createRef<HTMLElement>(),\n152|            id: `${listboxId}_${index}`,\n153|          },\n154|        ]),\n155|      );\n156|    }\n157|\n158|    return subitems;\n159|  }, [optionsParam, subitems, listboxId]);\n160|\n161|  const handleListboxRef = useForkRef(listboxRefProp, listboxRef);\n162|\n163|  const {\n164|    getRootProps: getButtonRootProps,\n165|    active: buttonActive,\n166|    focusVisible: buttonFocusVisible,\n167|    rootRef: mergedButtonRef,\n168|  } = useButton({\n169|    disabled,\n170|    rootRef: handleButtonRef,\n171|  });\n172|\n173|  const optionValues = React.useMemo(() => Array.from(options.keys()), [options]);\n174|\n175|  const getOptionByValue = React.useCallback(\n176|    (valueToGet: OptionValue) => {\n177|      // This can't be simply `options.get(valueToGet)` because of the `areOptionsEqual` prop.\n178|      // If it's provided, we assume that the user wants to compare the options by value.\n179|      if (areOptionsEqual !== undefined) {\n180|        const similarValue = optionValues.find((optionValue) =>\n181|          areOptionsEqual(optionValue, valueToGet),\n182|        )!;\n183|        return options.get(similarValue);\n184|      }\n185|\n186|      return options.get(valueToGet);\n187|    },\n188|    [options, areOptionsEqual, optionValues],\n189|  );\n190|\n191|  const isItemDisabled = React.useCallback(\n192|    (valueToCheck: OptionValue) => {\n193|      const option = getOptionByValue(valueToCheck);\n194|      return option?.disabled ?? false;\n195|    },\n196|    [getOptionByValue],\n197|  );\n198|\n199|  const stringifyOption = React.useCallback(\n200|    (valueToCheck: OptionValue) => {\n201|      const option = getOptionByValue(valueToCheck);\n202|      if (!option) {\n203|        return '';\n204|      }\n205|\n206|      return getOptionAsString(option);\n207|    },\n208|    [getOptionByValue, getOptionAsString],\n209|  );\n210|\n211|  const controlledState = React.useMemo(\n212|    () => ({\n213|      selectedValues: value,\n214|      open: openProp,\n215|    }),\n216|    [value, openProp],\n217|  );\n218|\n219|  const getItemId = React.useCallback(\n220|    (itemValue: OptionValue) => options.get(itemValue)?.id,\n221|    [options],\n222|  );\n223|\n224|  const handleSelectionChange = React.useCallback(\n225|    (\n226|      event:\n227|        | React.MouseEvent<Element, MouseEvent>\n228|        | React.KeyboardEvent<Element>\n229|        | React.FocusEvent<Element, Element>\n230|        | null,\n231|      newValues: OptionValue[],\n232|    ) => {\n233|      if (multiple) {\n234|        onChange?.(event, newValues as SelectValue<OptionValue, Multiple>);\n235|      } else {\n236|        onChange?.(event, (newValues[0] ?? null) as SelectValue<OptionValue, Multiple>);\n237|      }\n238|    },\n239|    [multiple, onChange],\n240|  );\n241|\n242|  const handleHighlightChange = React.useCallback(\n243|    (\n244|      event:\n245|        | React.MouseEvent<Element, MouseEvent>\n246|        | React.KeyboardEvent<Element>\n247|        | React.FocusEvent<Element, Element>\n248|        | null,\n249|      newValue: OptionValue | null,\n250|    ) => {\n251|      onHighlightChange?.(event, newValue ?? null);\n252|    },\n253|    [onHighlightChange],\n254|  );\n255|\n256|  const handleStateChange = React.useCallback(\n257|    (event: React.SyntheticEvent | null, field: string, fieldValue: any) => {\n258|      if (field === 'open') {\n259|        onOpenChange?.(fieldValue as boolean);\n260|        if (fieldValue === false && event?.type !== 'blur') {\n261|          buttonRef.current?.focus();\n262|        }\n263|      }\n264|    },\n265|    [onOpenChange],\n266|  );\n267|\n268|  const useListParameters: UseListParameters<\n269|    OptionValue,\n270|    SelectInternalState<OptionValue>,\n271|    SelectAction,\n272|    { multiple: boolean }\n273|  > = {\n274|    getInitialState: () => ({\n275|      highlightedValue: null,\n276|      selectedValues: defaultValue ?? [],\n277|      open: defaultOpen,\n278|    }),\n279|    getItemId,\n280|    controlledProps: controlledState,\n281|    itemComparer: areOptionsEqual,\n282|    isItemDisabled,\n283|    rootRef: mergedButtonRef,\n284|    onChange: handleSelectionChange,\n285|    onHighlightChange: handleHighlightChange,\n286|    onStateChange: handleStateChange,\n287|    reducerActionContext: React.useMemo(() => ({ multiple }), [multiple]),\n288|    items: optionValues,\n289|    getItemAsString: stringifyOption,\n290|    selectionMode: multiple ? 'multiple' : 'single',\n291|    stateReducer: selectReducer,\n292|  };\n293|\n294|  const {\n295|    dispatch,\n296|    getRootProps: getListboxRootProps,\n297|    contextValue: listContextValue,\n298|    state: { open, highlightedValue: highlightedOption, selectedValues: selectedOptions },\n299|    rootRef: mergedListRootRef,\n300|  } = useList(useListParameters);\n301|\n302|  const createHandleButtonMouseDown =\n303|    (externalEventHandlers?: EventHandlers) => (event: React.MouseEvent & MuiCancellableEvent) => {\n304|      externalEventHandlers?.onMouseDown?.(event);\n305|      if (!event.defaultMuiPrevented) {\n306|        const action: ButtonClickAction = {\n307|          type: SelectActionTypes.buttonClick,\n308|          event,\n309|        };\n310|\n311|        dispatch(action);\n312|      }\n313|    };\n314|\n315|  useEnhancedEffect(() => {\n316|    // Scroll to the currently highlighted option.\n317|    if (highlightedOption != null) {\n318|      const optionRef = getOptionByValue(highlightedOption)?.ref;\n319|      if (!listboxRef.current || !optionRef?.current) {\n320|        return;\n321|      }\n322|\n323|      const listboxClientRect = (listboxRef.current as HTMLElement).getBoundingClientRect();\n324|      const optionClientRect = optionRef.current.getBoundingClientRect();\n325|\n326|      if (optionClientRect.top < listboxClientRect.top) {\n327|        listboxRef.current.scrollTop -= listboxClientRect.top - optionClientRect.top;\n328|      } else if (optionClientRect.bottom > listboxClientRect.bottom) {\n329|        listboxRef.current.scrollTop += optionClientRect.bottom - listboxClientRect.bottom;\n330|      }\n331|    }\n332|  }, [highlightedOption, getOptionByValue]);\n333|\n334|  const getOptionMetadata = React.useCallback(\n335|    (optionValue: OptionValue) => getOptionByValue(optionValue),\n336|    [getOptionByValue],\n337|  );\n338|\n339|  const getSelectTriggerProps = <OtherHandlers extends EventHandlers>(\n340|    otherHandlers: OtherHandlers = {} as OtherHandlers,\n341|  ) => {\n342|    return {\n343|      ...otherHandlers,\n344|      onMouseDown: createHandleButtonMouseDown(otherHandlers),\n345|      ref: mergedListRootRef,\n346|      role: 'combobox' as const,\n347|      'aria-expanded': open,\n348|      'aria-controls': listboxId,\n349|    };\n350|  };\n351|\n352|  const getButtonProps = <ExternalProps extends Record<string, unknown>>(\n353|    externalProps: ExternalProps = {} as ExternalProps,\n354|  ): UseSelectButtonSlotProps<ExternalProps> => {\n355|    const externalEventHandlers = extractEventHandlers(externalProps);\n356|    const listboxAndButtonProps = combineHooksSlotProps(getButtonRootProps, getListboxRootProps);\n357|    const combinedProps = combineHooksSlotProps(listboxAndButtonProps, getSelectTriggerProps);\n358|    return {\n359|      ...externalProps,\n360|      ...combinedProps(externalEventHandlers),\n361|    };\n362|  };\n363|\n364|  const getListboxProps = <ExternalProps extends Record<string, unknown>>(\n365|    externalProps: ExternalProps = {} as ExternalProps,\n366|  ): UseSelectListboxSlotProps<ExternalProps> => {\n367|    return {\n368|      ...externalProps,\n369|      id: listboxId,\n370|      role: 'listbox' as const,\n371|      'aria-multiselectable': multiple ? 'true' : undefined,\n372|      ref: handleListboxRef,\n373|      onMouseDown: preventDefault, // to prevent the button from losing focus when interacting with the listbox\n374|    };\n375|  };\n376|\n377|  React.useDebugValue({\n378|    selectedOptions,\n379|    highlightedOption,\n380|    open,\n381|  });\n382|\n383|  const contextValue: SelectProviderValue<OptionValue> = React.useMemo(\n384|    () => ({\n385|      ...listContextValue,\n386|      ...compoundComponentContextValue,\n387|    }),\n388|    [listContextValue, compoundComponentContextValue],\n389|  );\n390|\n391|  let selectValue: SelectValue<OptionValue, Multiple>;\n392|  if (props.multiple) {\n393|    selectValue = selectedOptions as SelectValue<OptionValue, Multiple>;\n394|  } else {\n395|    selectValue = (selectedOptions.length > 0 ? selectedOptions[0] : null) as SelectValue<\n396|      OptionValue,\n397|      Multiple\n398|    >;\n399|  }\n400|\n401|  let selectedOptionsMetadata: SelectValue<SelectOption<OptionValue>, Multiple>;\n402|  if (multiple) {\n403|    selectedOptionsMetadata = (selectValue as OptionValue[])\n404|      .map((v) => getOptionMetadata(v))\n405|      .filter((o) => o !== undefined) as SelectValue<SelectOption<OptionValue>, Multiple>;\n406|  } else {\n407|    selectedOptionsMetadata = (getOptionMetadata(selectValue as OptionValue) ??\n408|      null) as SelectValue<SelectOption<OptionValue>, Multiple>;\n409|  }\n410|\n411|  const getHiddenInputProps = <ExternalProps extends Record<string, unknown>>(\n412|    externalProps: ExternalProps = {} as ExternalProps,\n413|  ): UseSelectHiddenInputSlotProps<ExternalProps> => {\n414|    return {\n415|      name,\n416|      tabIndex: -1,\n417|      'aria-hidden': true,\n418|      required: required ? true : undefined,\n419|      value: getSerializedValue(selectedOptionsMetadata),\n420|      onChange: noop,\n421|      style: visuallyHiddenStyle,\n422|      ...externalProps,\n423|    };\n424|  };\n425|\n426|  return {\n427|    buttonActive,\n428|    buttonFocusVisible,\n429|    buttonRef: mergedButtonRef,\n430|    contextValue,\n431|    disabled,\n432|    dispatch,\n433|    getButtonProps,\n434|    getHiddenInputProps,\n435|    getListboxProps,\n436|    getOptionMetadata,\n437|    listboxRef: mergedListRootRef,\n438|    open,\n439|    options: optionValues,\n440|    value: selectValue,\n441|    highlightedOption,\n442|  };\n443|}\n444|\n445|export { useSelect };\n\n\n### packages/mui-base/src/useList/useList.ts\n1|'use client';\n2|import * as React from 'react';\n3|import { unstable_useForkRef as useForkRef } from '@mui/utils';\n4|import {\n5|  UseListParameters,\n6|  ListItemState,\n7|  UseListRootSlotProps,\n8|  ListState,\n9|  ListActionContext,\n10|  UseListReturnValue,\n11|} from './useList.types';\n12|import { ListActionTypes, ListAction } from './listActions.types';\n13|import { ListContextValue } from './ListContext';\n14|import { listReducer as defaultReducer } from './listReducer';\n15|import { useListChangeNotifiers } from './useListChangeNotifiers';\n16|import { useControllableReducer } from '../utils/useControllableReducer';\n17|import {\n18|  ControllableReducerAction,\n19|  StateChangeCallback,\n20|  StateComparers,\n21|} from '../utils/useControllableReducer.types';\n22|import { areArraysEqual } from '../utils/areArraysEqual';\n23|import { useLatest } from '../utils/useLatest';\n24|import { useTextNavigation } from '../utils/useTextNavigation';\n25|import { MuiCancellableEvent } from '../utils/MuiCancellableEvent';\n26|import { extractEventHandlers } from '../utils/extractEventHandlers';\n27|import { EventHandlers } from '../utils/types';\n28|\n29|const EMPTY_OBJECT = {};\n30|const NOOP = () => {};\n31|\n32|const defaultItemComparer = <ItemValue>(optionA: ItemValue, optionB: ItemValue) =>\n33|  optionA === optionB;\n34|\n35|const defaultIsItemDisabled = () => false;\n36|\n37|const defaultItemStringifier = <ItemValue>(item: ItemValue) =>\n38|  typeof item === 'string' ? item : String(item);\n39|\n40|const defaultGetInitialState = () => ({\n41|  highlightedValue: null,\n42|  selectedValues: [],\n43|});\n44|\n45|/**\n46| * The useList is a lower-level utility that is used to build list-like components.\n47| * It's used to manage the state of the list and its items.\n48| *\n49| * Supports highlighting a single item and selecting an arbitrary number of items.\n50| *\n51| * The state of the list is managed by a controllable reducer - that is a reducer that can have its state\n52| * controlled from outside.\n53| *\n54| * By default, the state consists of `selectedValues` and `highlightedValue` but can be extended by the caller of the hook.\n55| * Also the actions that can be dispatched and the reducer function can be defined externally.\n56| *\n57| * @template ItemValue The type of the item values.\n58| * @template State The type of the list state. This should be a subtype of `ListState<ItemValue>`.\n59| * @template CustomAction The type of the actions that can be dispatched (besides the standard ListAction).\n60| * @template CustomActionContext The shape of additional properties that will be added to actions when dispatched.\n61| *\n62| * @ignore - internal hook.\n63| */\n64|function useList<\n65|  ItemValue,\n66|  State extends ListState<ItemValue> = ListState<ItemValue>,\n67|  CustomAction extends ControllableReducerAction = never,\n68|  CustomActionContext = {},\n69|>(\n70|  params: UseListParameters<ItemValue, State, CustomAction, CustomActionContext>,\n71|): UseListReturnValue<ItemValue, State, CustomAction> {\n72|  const {\n73|    controlledProps = EMPTY_OBJECT,\n74|    disabledItemsFocusable = false,\n75|    disableListWrap = false,\n76|    focusManagement = 'activeDescendant',\n77|    getInitialState = defaultGetInitialState,\n78|    getItemDomElement,\n79|    getItemId,\n80|    isItemDisabled = defaultIsItemDisabled,\n81|    rootRef: externalListRef,\n82|    onStateChange = NOOP,\n83|    items,\n84|    itemComparer = defaultItemComparer,\n85|    getItemAsString = defaultItemStringifier,\n86|    onChange,\n87|    onHighlightChange,\n88|    onItemsChange,\n89|    orientation = 'vertical',\n90|    pageSize = 5,\n91|    reducerActionContext = EMPTY_OBJECT as CustomActionContext,\n92|    selectionMode = 'single',\n93|    stateReducer: externalReducer,\n94|  } = params;\n95|\n96|  if (process.env.NODE_ENV !== 'production') {\n97|    if (focusManagement === 'DOM' && getItemDomElement == null) {\n98|      throw new Error(\n99|        'useList: The `getItemDomElement` prop is required when using the `DOM` focus management.',\n100|      );\n101|    }\n102|\n103|    if (focusManagement === 'activeDescendant' && getItemId == null) {\n104|      throw new Error(\n105|        'useList: The `getItemId` prop is required when using the `activeDescendant` focus management.',\n106|      );\n107|    }\n108|  }\n109|\n110|  const listRef = React.useRef<HTMLUListElement>(null);\n111|  const handleRef = useForkRef(externalListRef, listRef);\n112|\n113|  const handleHighlightChange = React.useCallback(\n114|    (\n115|      event: React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n116|      value: ItemValue | null,\n117|      reason: string,\n118|    ) => {\n119|      onHighlightChange?.(event, value, reason);\n120|\n121|      if (\n122|        focusManagement === 'DOM' &&\n123|        value != null &&\n124|        (reason === ListActionTypes.itemClick ||\n125|          reason === ListActionTypes.keyDown ||\n126|          reason === ListActionTypes.textNavigation)\n127|      ) {\n128|        getItemDomElement?.(value)?.focus();\n129|      }\n130|    },\n131|    [getItemDomElement, onHighlightChange, focusManagement],\n132|  );\n133|\n134|  const stateComparers = React.useMemo(\n135|    () =>\n136|      ({\n137|        highlightedValue: itemComparer,\n138|        selectedValues: (valuesArray1, valuesArray2) =>\n139|          areArraysEqual(valuesArray1, valuesArray2, itemComparer),\n140|      } as StateComparers<State>),\n141|    [itemComparer],\n142|  );\n143|\n144|  // This gets called whenever a reducer changes the state.\n145|  const handleStateChange: StateChangeCallback<State> = React.useCallback(\n146|    (event, field, value, reason, state) => {\n147|      onStateChange?.(event, field, value, reason, state);\n148|\n149|      switch (field) {\n150|        case 'highlightedValue':\n151|          handleHighlightChange(\n152|            event as React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n153|            value as ItemValue | null,\n154|            reason,\n155|          );\n156|          break;\n157|        case 'selectedValues':\n158|          onChange?.(\n159|            event as React.MouseEvent | React.KeyboardEvent | React.FocusEvent | null,\n160|            value as ItemValue[],\n161|            reason,\n162|          );\n163|          break;\n164|        default:\n165|          break;\n166|      }\n167|    },\n168|    [handleHighlightChange, onChange, onStateChange],\n169|  );\n170|\n171|  // The following object is added to each action when it's dispatched.\n172|  // It's accessible in the reducer via the `action.context` field.\n173|  const listActionContext: ListActionContext<ItemValue> = React.useMemo(() => {\n174|    return {\n175|      disabledItemsFocusable,\n176|      disableListWrap,\n177|      focusManagement,\n178|      isItemDisabled,\n179|      itemComparer,\n180|      items,\n181|      getItemAsString,\n182|      onHighlightChange: handleHighlightChange,\n183|      orientation,\n184|      pageSize,\n185|      selectionMode,\n186|      stateComparers,\n187|    };\n188|  }, [\n189|    disabledItemsFocusable,\n190|    disableListWrap,\n191|    focusManagement,\n192|    isItemDisabled,\n193|    itemComparer,\n194|    items,\n195|    getItemAsString,\n196|    handleHighlightChange,\n197|    orientation,\n198|    pageSize,\n199|    selectionMode,\n200|    stateComparers,\n201|  ]);\n202|\n203|  const initialState = getInitialState();\n204|  const reducer = (externalReducer ?? defaultReducer) as React.Reducer<\n205|    State,\n206|    ListAction<ItemValue> | CustomAction\n207|  >;\n208|\n209|  const actionContext: ListActionContext<ItemValue> & CustomActionContext = React.useMemo(\n210|    () => ({ ...reducerActionContext, ...listActionContext }),\n211|    [reducerActionContext, listActionContext],\n212|  );\n213|\n214|  const [state, dispatch] = useControllableReducer<\n215|    State,\n216|    ListAction<ItemValue> | CustomAction,\n217|    ListActionContext<ItemValue> & CustomActionContext\n218|  >({\n219|    reducer,\n220|    actionContext,\n221|    initialState: initialState as State,\n222|    controlledProps,\n223|    stateComparers,\n224|    onStateChange: handleStateChange,\n225|  });\n226|\n227|  const { highlightedValue, selectedValues } = state;\n228|\n229|  const handleTextNavigation = useTextNavigation((searchString, event) =>\n230|    dispatch({\n231|      type: ListActionTypes.textNavigation,\n232|      event,\n233|      searchString,\n234|    }),\n235|  );\n236|\n237|  // introducing refs to avoid recreating the getItemState function on each change.\n238|  const latestSelectedValues = useLatest(selectedValues);\n239|  const latestHighlightedValue = useLatest(highlightedValue);\n240|  const previousItems = React.useRef<ItemValue[]>([]);\n241|\n242|  React.useEffect(() => {\n243|    // Whenever the `items` object changes, we need to determine if the actual items changed.\n244|    // If they did, we need to dispatch an `itemsChange` action, so the selected/highlighted state is updated.\n245|    if (areArraysEqual(previousItems.current, items, itemComparer)) {\n246|      return;\n247|    }\n248|\n249|    dispatch({\n250|      type: ListActionTypes.itemsChange,\n251|      event: null,\n252|      items,\n253|      previousItems: previousItems.current,\n254|    });\n255|\n256|    previousItems.current = items;\n257|    onItemsChange?.(items);\n258|  }, [items, itemComparer, dispatch, onItemsChange]);\n259|\n260|  // Subitems are notified of changes to the highlighted and selected values.\n261|  // This is not done via context because we don't want to trigger a re-render of all the subitems each time any of them changes state.\n262|  // Instead, we use a custom message bus to publish messages about changes.\n263|  // On the child component, we use a custom hook to subscribe to these messages and re-render only when the value they care about changes.\n264|  const {\n265|    notifySelectionChanged,\n266|    notifyHighlightChanged,\n267|    registerHighlightChangeHandler,\n268|    registerSelectionChangeHandler,\n269|  } = useListChangeNotifiers<ItemValue>();\n270|\n271|  React.useEffect(() => {\n272|    notifySelectionChanged(selectedValues);\n273|  }, [selectedValues, notifySelectionChanged]);\n274|\n275|  React.useEffect(() => {\n276|    notifyHighlightChanged(highlightedValue);\n277|  }, [highlightedValue, notifyHighlightChanged]);\n278|\n279|  const createHandleKeyDown =\n280|    (externalHandlers: EventHandlers) =>\n281|    (event: React.KeyboardEvent<HTMLElement> & MuiCancellableEvent) => {\n282|      externalHandlers.onKeyDown?.(event);\n283|\n284|      if (event.defaultMuiPrevented) {\n285|        return;\n286|      }\n287|\n288|      const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n289|\n290|      if (orientation === 'vertical') {\n291|        keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n292|      } else {\n293|        keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\n294|      }\n295|\n296|      if (focusManagement === 'activeDescendant') {\n297|        // When the child element is focused using the activeDescendant attribute,\n298|        // the list handles keyboard events on its behalf.\n299|        // We have to `preventDefault()` is this case to prevent the browser from\n300|        // scrolling the view when space is pressed or submitting forms when enter is pressed.\n301|        keysToPreventDefault.push(' ', 'Enter');\n302|      }\n303|\n304|      if (keysToPreventDefault.includes(event.key)) {\n305|        event.preventDefault();\n306|      }\n307|\n308|      dispatch({\n309|        type: ListActionTypes.keyDown,\n310|        key: event.key,\n311|        event,\n312|      });\n313|\n314|      handleTextNavigation(event);\n315|    };\n316|\n317|  const createHandleBlur =\n318|    (externalHandlers: EventHandlers) =>\n319|    (event: React.FocusEvent<HTMLElement> & MuiCancellableEvent) => {\n320|      externalHandlers.onBlur?.(event);\n321|\n322|      if (event.defaultMuiPrevented) {\n323|        return;\n324|      }\n325|\n326|      if (listRef.current?.contains(event.relatedTarget)) {\n327|        // focus remains within the list\n328|        return;\n329|      }\n330|\n331|      dispatch({\n332|        type: ListActionTypes.blur,\n333|        event,\n334|      });\n335|    };\n336|\n337|  const getRootProps = <ExternalProps extends Record<string, any> = {}>(\n338|    externalProps: ExternalProps = {} as ExternalProps,\n339|  ): UseListRootSlotProps<ExternalProps> => {\n340|    const externalEventHandlers = extractEventHandlers(externalProps);\n341|    return {\n342|      ...externalProps,\n343|      'aria-activedescendant':\n344|        focusManagement === 'activeDescendant' && highlightedValue != null\n345|          ? getItemId!(highlightedValue)\n346|          : undefined,\n347|      tabIndex: focusManagement === 'DOM' ? -1 : 0,\n348|      ref: handleRef,\n349|      ...externalEventHandlers,\n350|      onBlur: createHandleBlur(externalEventHandlers),\n351|      onKeyDown: createHandleKeyDown(externalEventHandlers),\n352|    };\n353|  };\n354|\n355|  const getItemState = React.useCallback(\n356|    (item: ItemValue): ListItemState => {\n357|      const index = items.findIndex((i) => itemComparer(i, item));\n358|      const selected = (latestSelectedValues.current ?? []).some(\n359|        (value) => value != null && itemComparer(item, value),\n360|      );\n361|\n362|      const disabled = isItemDisabled(item, index);\n363|      const highlighted =\n364|        latestHighlightedValue.current != null &&\n365|        itemComparer(item, latestHighlightedValue.current);\n366|      const focusable = focusManagement === 'DOM';\n367|\n368|      return {\n369|        disabled,\n370|        focusable,\n371|        highlighted,\n372|        index,\n373|        selected,\n374|      };\n375|    },\n376|    [\n377|      items,\n378|      isItemDisabled,\n379|      itemComparer,\n380|      latestSelectedValues,\n381|      latestHighlightedValue,\n382|      focusManagement,\n383|    ],\n384|  );\n385|\n386|  const contextValue: ListContextValue<ItemValue> = React.useMemo(\n387|    () => ({\n388|      dispatch,\n389|      getItemState,\n390|      registerHighlightChangeHandler,\n391|      registerSelectionChangeHandler,\n392|    }),\n393|    [dispatch, getItemState, registerHighlightChangeHandler, registerSelectionChangeHandler],\n394|  );\n395|\n396|  React.useDebugValue({\n397|    state,\n398|  });\n399|\n400|  return {\n401|    contextValue,\n402|    dispatch,\n403|    getRootProps,\n404|    rootRef: handleRef,\n405|    state,\n406|  };\n407|}\n408|\n409|export { useList };\n\n\n### packages/mui-base/src/useOption/useOption.ts\n...\n8|\n9|/**\n10| *\n11| * Demos:\n12| *\n13| * - [Select](https://mui.com/base-ui/react-select/#hooks)\n14| *\n15| * API:\n16| *\n17| * - [useOption API](https://mui.com/base-ui/react-select/hooks-api/#use-option)\n18| */\n19|export function useOption<Value>(params: UseOptionParameters<Value>): UseOptionReturnValue {\n20|  const { value, label, disabled, rootRef: optionRefParam, id: idParam } = params;\n21|\n22|  const {\n23|    getRootProps: getListItemProps,\n24|    rootRef: listItemRefHandler,\n25|    highlighted,\n26|    selected,\n27|  } = useListItem({\n28|    item: value,\n29|  });\n30|\n31|  const id = useId(idParam);\n32|\n33|  const optionRef = React.useRef<Element>(null);\n34|\n35|  const selectOption: SelectOption<Value> = React.useMemo(\n36|    () => ({\n37|      disabled,\n38|      label,\n39|      value,\n40|      ref: optionRef,\n41|      id,\n42|    }),\n43|    [disabled, label, value, id],\n44|  );\n45|\n46|  const { index } = useCompoundItem<Value, SelectOption<Value>>(value, selectOption);\n47|\n48|  const handleRef = useForkRef(optionRefParam, optionRef, listItemRefHandler)!;\n49|\n50|  return {\n51|    getRootProps: <ExternalProps extends Record<string, unknown> = {}>(\n52|      externalProps: ExternalProps = {} as ExternalProps,\n53|    ) => {\n54|      const externalEventHandlers = extractEventHandlers(externalProps);\n55|      return {\n56|        ...externalProps,\n57|        ...getListItemProps(externalEventHandlers),\n58|        id,\n59|        ref: handleRef,\n60|        role: 'option',\n61|        'aria-selected': selected,\n62|      };\n63|    },\n64|    highlighted,\n65|    index,\n66|    selected,\n67|    rootRef: handleRef,\n68|  };\n69|}\n\n\n\n\n###\n\nPlease provide the class name, function or method name, or the exact line numbers that need to be edited.\nThe possible location outputs should be either \"class\", \"function\" or \"line\".\n\n### Examples:\n```\nfull_path1/file1.ts\nline: 10\nclass: MyClass1\nline: 51\n\nfull_path2/file2.ts\nfunction: MyClass2.my_method\nline: 12\n\nfull_path3/file3.ts\nfunction: my_function\nline: 24\nline: 156\n```\n\nReturn just the location(s) wrapped with ```.\n",
        "response": [
          "```\npackages/mui-base/src/useSelect/useSelect.ts\nline: 349\n\npackages/mui-base/src/useList/useList.ts\nline: 291\nline: 292\nline: 293\nline: 294\nline: 301\n```",
          "```\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: createHandleButtonMouseDown\nline: 305\nline: 311\n\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: getSelectTriggerProps\nline: 344\nline: 350\n\npackages/mui-base/src/useList/useList.ts\nfunction: createHandleKeyDown\nline: 301\nline: 303\n```"
        ],
        "usage": {
          "completion_tokens": 0,
          "prompt_tokens": 0
        }
      },
      "additional_artifact_loc_edit_location": [
        {
          "raw_output_loc": [
            "```\npackages/mui-base/src/useSelect/useSelect.ts\nline: 349\n\npackages/mui-base/src/useList/useList.ts\nline: 291\nline: 292\nline: 293\nline: 294\nline: 301\n```",
            "```\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: createHandleButtonMouseDown\nline: 305\nline: 311\n\npackages/mui-base/src/useSelect/useSelect.ts\nfunction: getSelectTriggerProps\nline: 344\nline: 350\n\npackages/mui-base/src/useList/useList.ts\nfunction: createHandleKeyDown\nline: 301\nline: 303\n```"
          ]
        }
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/packages/mui-base/src/useList/useList.ts b/packages/mui-base/src/useList/useList.ts\nindex 6060e75..d05b1db 100644\n--- a/packages/mui-base/src/useList/useList.ts\n+++ b/packages/mui-base/src/useList/useList.ts\n@@ -287,7 +287,8 @@ function useList<\n \n       const keysToPreventDefault = ['Home', 'End', 'PageUp', 'PageDown'];\n \n-      if (orientation === 'vertical') {\n+      if (orientation !== 'horizontal') {\n+        // Default to vertical list behavior when orientation is undefined.\n         keysToPreventDefault.push('ArrowUp', 'ArrowDown');\n       } else {\n         keysToPreventDefault.push('ArrowLeft', 'ArrowRight');\ndiff --git a/packages/mui-base/src/useSelect/useSelect.ts b/packages/mui-base/src/useSelect/useSelect.ts\nindex 477ec4a..d94b1f1 100644\n--- a/packages/mui-base/src/useSelect/useSelect.ts\n+++ b/packages/mui-base/src/useSelect/useSelect.ts\n@@ -343,7 +343,8 @@ function useSelect<OptionValue, Multiple extends boolean = false>(\n       ...otherHandlers,\n       onMouseDown: createHandleButtonMouseDown(otherHandlers),\n       ref: mergedListRootRef,\n-      role: 'combobox' as const,\n+      role: 'button' as const,\n+      'aria-haspopup': 'listbox' as const,\n       'aria-expanded': open,\n       'aria-controls': listboxId,\n     };\n",
  "7_resolved": false
}