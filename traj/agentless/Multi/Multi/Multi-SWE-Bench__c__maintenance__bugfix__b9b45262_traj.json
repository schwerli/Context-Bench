{
  "instance_id": "Multi-SWE-Bench__c__maintenance__bugfix__b9b45262",
  "original_id": "facebook__zstd-637",
  "1_model_selected_files": [
    "lib/compress/zstdmt_compress.c",
    "lib/compress/zstdmt_compress.h",
    "lib/compress/zstd_compress.c",
    "lib/common/zstd_internal.h",
    "lib/zstd.h"
  ],
  "2_embedding_selected_files": [
    "lib/compress/zstd_compress.c",
    "lib/zstd.h",
    "lib/compress/zstdmt_compress.c",
    "lib/compress/zstdmt_compress.h",
    "lib/common/zstd_common.c",
    "lib/common/zstd_internal.h",
    "lib/common/zstd_errors.h"
  ],
  "3_final_combined_files": [
    "lib/compress/zstdmt_compress.c",
    "lib/compress/zstd_compress.c",
    "lib/compress/zstdmt_compress.h",
    "lib/zstd.h"
  ],
  "4_related_elements": {
    "lib/compress/zstdmt_compress.c": [
      "function: ZSTDMT_compressChunk\nfunction: ZSTDMT_compressCCtx\nfunction: ZSTDMT_initCStream_internal\nfunction: ZSTDMT_createCompressionJob\nfunction: ZSTDMT_resetCStream\nfunction: ZSTDMT_initCStream\nclass: ZSTDMT_jobDescription\nclass: ZSTDMT_CCtx_s"
    ],
    "lib/compress/zstd_compress.c": [
      "function: ZSTD_compressBegin_advanced\nfunction: ZSTD_compressBegin_internal\nfunction: ZSTD_resetCCtx_advanced\nfunction: ZSTD_writeFrameHeader\nfunction: ZSTD_compressContinue_internal\nfunction: ZSTD_compressBegin_usingCDict\nfunction: ZSTD_copyCCtx\nclass: ZSTD_CCtx_s"
    ],
    "lib/compress/zstdmt_compress.h": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "lib/compress/zstdmt_compress.c": [
          "function: ZSTDMT_compressChunk\nline: 238"
        ],
        "lib/compress/zstd_compress.c": [
          ""
        ],
        "lib/compress/zstdmt_compress.h": [
          ""
        ]
      },
      "patches": [
        "diff --git a/lib/compress/zstdmt_compress.c b/lib/compress/zstdmt_compress.c\nindex 79f2373..981f547 100644\n--- a/lib/compress/zstdmt_compress.c\n+++ b/lib/compress/zstdmt_compress.c\n@@ -235,7 +235,7 @@ void ZSTDMT_compressChunk(void* jobDescription)\n         if (ZSTD_isError(initError)) { job->cSize = initError; goto _endJob; }\n     } else {  /* srcStart points at reloaded section */\n         size_t const dictModeError = ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceRawDict, 1);  /* Force loading dictionary in \"content-only\" mode (no header analysis) */\n-        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, 0);\n+        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, job->fullFrameSize);\n         if (ZSTD_isError(initError) || ZSTD_isError(dictModeError)) { job->cSize = initError; goto _endJob; }\n         ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceWindow, 1);\n     }\n",
        "diff --git a/lib/compress/zstdmt_compress.c b/lib/compress/zstdmt_compress.c\nindex 79f2373..9c1e068 100644\n--- a/lib/compress/zstdmt_compress.c\n+++ b/lib/compress/zstdmt_compress.c\n@@ -235,7 +235,8 @@ void ZSTDMT_compressChunk(void* jobDescription)\n         if (ZSTD_isError(initError)) { job->cSize = initError; goto _endJob; }\n     } else {  /* srcStart points at reloaded section */\n         size_t const dictModeError = ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceRawDict, 1);  /* Force loading dictionary in \"content-only\" mode (no header analysis) */\n-        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, 0);\n+        /* For the first chunk without a CDict, pass the full frame size so the content size is written in the frame header. */\n+        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, job->firstChunk ? job->fullFrameSize : 0);\n         if (ZSTD_isError(initError) || ZSTD_isError(dictModeError)) { job->cSize = initError; goto _endJob; }\n         ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceWindow, 1);\n     }\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "lib/compress/zstdmt_compress.c": [
          "function: ZSTDMT_compressChunk\nline: 238"
        ],
        "lib/compress/zstd_compress.c": [
          ""
        ],
        "lib/compress/zstdmt_compress.h": [
          ""
        ]
      },
      "patches": [
        "diff --git a/lib/compress/zstdmt_compress.c b/lib/compress/zstdmt_compress.c\nindex 79f2373..981f547 100644\n--- a/lib/compress/zstdmt_compress.c\n+++ b/lib/compress/zstdmt_compress.c\n@@ -235,7 +235,7 @@ void ZSTDMT_compressChunk(void* jobDescription)\n         if (ZSTD_isError(initError)) { job->cSize = initError; goto _endJob; }\n     } else {  /* srcStart points at reloaded section */\n         size_t const dictModeError = ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceRawDict, 1);  /* Force loading dictionary in \"content-only\" mode (no header analysis) */\n-        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, 0);\n+        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, job->fullFrameSize);\n         if (ZSTD_isError(initError) || ZSTD_isError(dictModeError)) { job->cSize = initError; goto _endJob; }\n         ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceWindow, 1);\n     }\n",
        "diff --git a/lib/compress/zstdmt_compress.c b/lib/compress/zstdmt_compress.c\nindex 79f2373..981f547 100644\n--- a/lib/compress/zstdmt_compress.c\n+++ b/lib/compress/zstdmt_compress.c\n@@ -235,7 +235,7 @@ void ZSTDMT_compressChunk(void* jobDescription)\n         if (ZSTD_isError(initError)) { job->cSize = initError; goto _endJob; }\n     } else {  /* srcStart points at reloaded section */\n         size_t const dictModeError = ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceRawDict, 1);  /* Force loading dictionary in \"content-only\" mode (no header analysis) */\n-        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, 0);\n+        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, job->fullFrameSize);\n         if (ZSTD_isError(initError) || ZSTD_isError(dictModeError)) { job->cSize = initError; goto _endJob; }\n         ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceWindow, 1);\n     }\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/lib/compress/zstdmt_compress.c b/lib/compress/zstdmt_compress.c\nindex 79f2373..981f547 100644\n--- a/lib/compress/zstdmt_compress.c\n+++ b/lib/compress/zstdmt_compress.c\n@@ -235,7 +235,7 @@ void ZSTDMT_compressChunk(void* jobDescription)\n         if (ZSTD_isError(initError)) { job->cSize = initError; goto _endJob; }\n     } else {  /* srcStart points at reloaded section */\n         size_t const dictModeError = ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceRawDict, 1);  /* Force loading dictionary in \"content-only\" mode (no header analysis) */\n-        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, 0);\n+        size_t const initError = ZSTD_compressBegin_advanced(job->cctx, job->srcStart, job->dictSize, job->params, job->fullFrameSize);\n         if (ZSTD_isError(initError) || ZSTD_isError(dictModeError)) { job->cSize = initError; goto _endJob; }\n         ZSTD_setCCtxParameter(job->cctx, ZSTD_p_forceWindow, 1);\n     }\n",
  "7_resolved": true
}