{
  "instance_id": "Multi-SWE-Bench__rust__maintenance__bugfix__92158fba",
  "original_id": "clap-rs__clap-3975",
  "1_model_selected_files": [
    "src/output/help.rs",
    "src/builder/command.rs",
    "clap_derive/src/derives/into_app.rs",
    "src/builder/app_settings.rs",
    "src/output/usage.rs"
  ],
  "2_embedding_selected_files": [],
  "3_final_combined_files": [
    "src/output/help.rs",
    "src/builder/command.rs",
    "clap_derive/src/derives/into_app.rs"
  ],
  "4_related_elements": {
    "src/output/help.rs": [
      "function: Help.write_args\nfunction: Help.write_args_unsorted\nfunction: Help.write_all_args\nfunction: Help.write_subcommands\nfunction: Help.write_templated_help"
    ],
    "src/builder/command.rs": [
      "function: Command.new\nfunction: Command._derive_display_order\nfunction: Command._build_self\nfunction: Command.get_display_order\nvariable: Command.current_disp_ord"
    ],
    "clap_derive/src/derives/into_app.rs": [
      "function: gen_for_struct\nfunction: gen_for_enum"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "src/builder/command.rs": [
          "function: Command::new"
        ],
        "clap_derive/src/derives/into_app.rs": [
          "function: gen_for_struct\nfunction: gen_for_enum"
        ],
        "src/output/help.rs": [
          ""
        ]
      },
      "patches": [
        "diff --git a/clap_derive/src/derives/into_app.rs b/clap_derive/src/derives/into_app.rs\nindex 1b03656..fade1bb 100644\n--- a/clap_derive/src/derives/into_app.rs\n+++ b/clap_derive/src/derives/into_app.rs\n@@ -58,12 +58,14 @@ pub fn gen_for_struct(\n         #[deny(clippy::correctness)]\n         impl #impl_generics clap::CommandFactory for #struct_name #ty_generics #where_clause {\n             fn command<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Args>::augment_args(#app_var)\n             }\n \n             fn command_for_update<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Args>::augment_args_for_update(#app_var)\n             }\n         }\n@@ -104,13 +106,15 @@ pub fn gen_for_enum(enum_name: &Ident, generics: &Generics, attrs: &[Attribute])\n         impl #impl_generics clap::CommandFactory for #enum_name #ty_generics #where_clause {\n             fn command<'b>() -> clap::Command<'b> {\n                 let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder)\n                     .subcommand_required(true)\n                     .arg_required_else_help(true);\n                 <Self as clap::Subcommand>::augment_subcommands(#app_var)\n             }\n \n             fn command_for_update<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Subcommand>::augment_subcommands_for_update(#app_var)\n             }\n         }\ndiff --git a/src/builder/command.rs b/src/builder/command.rs\nindex e601ebb..43147e4 100644\n--- a/src/builder/command.rs\n+++ b/src/builder/command.rs\n@@ -146,7 +146,7 @@ impl<'help> Command<'help> {\n             )\n         }\n \n-        new_inner(name.into())\n+        new_inner(name.into()).setting(AppSettings::DeriveDisplayOrder)\n     }\n \n     /// Adds an [argument] to the list of valid possibilities.\n",
        "diff --git a/src/builder/command.rs b/src/builder/command.rs\nindex e601ebb..24cad66 100644\n--- a/src/builder/command.rs\n+++ b/src/builder/command.rs\n@@ -1,3 +1,4 @@\n+\n #![allow(deprecated)]\n \n // Std\n@@ -130,6 +131,7 @@ impl<'help> Command<'help> {\n                 name,\n                 ..Default::default()\n             }\n+            .setting(AppSettings::DeriveDisplayOrder)\n             .arg(\n                 Arg::new(\"help\")\n                     .long(\"help\")\n@@ -4759,4 +4761,4 @@ where\n #[test]\n fn check_auto_traits() {\n     static_assertions::assert_impl_all!(Command: Send, Sync, Unpin);\n-}\n+}\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "src/builder/command.rs": [
          "line: 147"
        ],
        "clap_derive/src/derives/into_app.rs": [
          "line: 61\nline: 66\nline: 106\nline: 113"
        ],
        "src/output/help.rs": [
          ""
        ]
      },
      "patches": [
        "diff --git a/clap_derive/src/derives/into_app.rs b/clap_derive/src/derives/into_app.rs\nindex 1b03656..fade1bb 100644\n--- a/clap_derive/src/derives/into_app.rs\n+++ b/clap_derive/src/derives/into_app.rs\n@@ -58,12 +58,14 @@ pub fn gen_for_struct(\n         #[deny(clippy::correctness)]\n         impl #impl_generics clap::CommandFactory for #struct_name #ty_generics #where_clause {\n             fn command<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Args>::augment_args(#app_var)\n             }\n \n             fn command_for_update<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Args>::augment_args_for_update(#app_var)\n             }\n         }\n@@ -104,13 +106,15 @@ pub fn gen_for_enum(enum_name: &Ident, generics: &Generics, attrs: &[Attribute])\n         impl #impl_generics clap::CommandFactory for #enum_name #ty_generics #where_clause {\n             fn command<'b>() -> clap::Command<'b> {\n                 let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder)\n                     .subcommand_required(true)\n                     .arg_required_else_help(true);\n                 <Self as clap::Subcommand>::augment_subcommands(#app_var)\n             }\n \n             fn command_for_update<'b>() -> clap::Command<'b> {\n-                let #app_var = clap::Command::new(#name);\n+                let #app_var = clap::Command::new(#name)\n+                    .setting(clap::AppSettings::DeriveDisplayOrder);\n                 <Self as clap::Subcommand>::augment_subcommands_for_update(#app_var)\n             }\n         }\ndiff --git a/src/builder/command.rs b/src/builder/command.rs\nindex e601ebb..c459558 100644\n--- a/src/builder/command.rs\n+++ b/src/builder/command.rs\n@@ -146,7 +146,7 @@ impl<'help> Command<'help> {\n             )\n         }\n \n-        new_inner(name.into())\n+        new_inner(name.into()).setting(crate::AppSettings::DeriveDisplayOrder)\n     }\n \n     /// Adds an [argument] to the list of valid possibilities.\n",
        "diff --git a/src/builder/command.rs b/src/builder/command.rs\nindex e601ebb..0ef859a 100644\n--- a/src/builder/command.rs\n+++ b/src/builder/command.rs\n@@ -1,3 +1,4 @@\n+\n #![allow(deprecated)]\n \n // Std\n@@ -4369,18 +4370,18 @@ To change `help`s short, call `cmd.arg(Arg::new(\\\"help\\\")...)`.\",\n     pub(crate) fn _derive_display_order(&mut self) {\n         debug!(\"Command::_derive_display_order:{}\", self.name);\n \n-        if self.settings.is_set(AppSettings::DeriveDisplayOrder) {\n-            for a in self\n-                .args\n-                .args_mut()\n-                .filter(|a| !a.is_positional())\n-                .filter(|a| a.provider != ArgProvider::Generated)\n-            {\n-                a.disp_ord.make_explicit();\n-            }\n-            for (i, sc) in &mut self.subcommands.iter_mut().enumerate() {\n-                sc.disp_ord.get_or_insert(i);\n-            }\n+        // Always preserve declaration order for non-positional, user-provided args\n+        for a in self\n+            .args\n+            .args_mut()\n+            .filter(|a| !a.is_positional())\n+            .filter(|a| a.provider != ArgProvider::Generated)\n+        {\n+            a.disp_ord.make_explicit();\n+        }\n+        // And for subcommands, preserve their declaration order unless explicitly overridden\n+        for (i, sc) in &mut self.subcommands.iter_mut().enumerate() {\n+            sc.disp_ord.get_or_insert(i);\n         }\n         for sc in &mut self.subcommands {\n             sc._derive_display_order();\n@@ -4759,4 +4760,4 @@ where\n #[test]\n fn check_auto_traits() {\n     static_assertions::assert_impl_all!(Command: Send, Sync, Unpin);\n-}\n+}\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/src/builder/command.rs b/src/builder/command.rs\nindex e601ebb..24cad66 100644\n--- a/src/builder/command.rs\n+++ b/src/builder/command.rs\n@@ -1,3 +1,4 @@\n+\n #![allow(deprecated)]\n \n // Std\n@@ -130,6 +131,7 @@ impl<'help> Command<'help> {\n                 name,\n                 ..Default::default()\n             }\n+            .setting(AppSettings::DeriveDisplayOrder)\n             .arg(\n                 Arg::new(\"help\")\n                     .long(\"help\")\n@@ -4759,4 +4761,4 @@ where\n #[test]\n fn check_auto_traits() {\n     static_assertions::assert_impl_all!(Command: Send, Sync, Unpin);\n-}\n+}\n",
  "7_resolved": false
}