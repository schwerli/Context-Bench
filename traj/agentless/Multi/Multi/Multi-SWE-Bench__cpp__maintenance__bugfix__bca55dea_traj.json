{
  "instance_id": "Multi-SWE-Bench__cpp__maintenance__bugfix__bca55dea",
  "original_id": "simdjson__simdjson-1695",
  "1_model_selected_files": [
    "include/simdjson/generic/ondemand/document.h",
    "include/simdjson/generic/ondemand/document-inl.h",
    "include/simdjson/generic/ondemand/json_iterator-inl.h",
    "include/simdjson/generic/ondemand/json_iterator.h",
    "include/simdjson/generic/ondemand/document_stream-inl.h"
  ],
  "2_embedding_selected_files": [
    "include/simdjson/generic/ondemand/document.h",
    "include/simdjson/generic/ondemand/document-inl.h",
    "include/simdjson/generic/ondemand/document_stream-inl.h",
    "include/simdjson/generic/ondemand/json_iterator.h",
    "include/simdjson/generic/ondemand/json_iterator-inl.h",
    "include/simdjson/generic/ondemand/document_stream.h",
    "include/simdjson/generic/ondemand/value_iterator.h",
    "include/simdjson/generic/ondemand/array_iterator-inl.h",
    "include/simdjson/generic/ondemand/object-inl.h",
    "include/simdjson/generic/ondemand/array-inl.h",
    "include/simdjson/generic/ondemand-inl.h",
    "include/simdjson/generic/ondemand.h",
    "include/simdjson/generic/ondemand/serialization-inl.h",
    "include/simdjson/generic/ondemand/value_iterator-inl.h",
    "include/simdjson/generic/ondemand/logger-inl.h",
    "include/simdjson/generic/ondemand/array.h",
    "include/simdjson/generic/ondemand/logger.h",
    "src/generic/stage1/find_next_document_index.h",
    "include/simdjson/generic/ondemand/object_iterator-inl.h",
    "src/generic/stage2/json_iterator.h",
    "include/simdjson/generic/ondemand/object_iterator.h",
    "include/simdjson/generic/ondemand/token_position.h",
    "include/simdjson/generic/ondemand/parser-inl.h",
    "include/simdjson/generic/ondemand/value-inl.h",
    "include/simdjson/generic/ondemand/array_iterator.h",
    "include/simdjson/generic/ondemand/token_iterator.h",
    "include/simdjson/generic/ondemand/token_iterator-inl.h",
    "include/simdjson/generic/ondemand/parser.h"
  ],
  "3_final_combined_files": [
    "include/simdjson/generic/ondemand/document.h",
    "include/simdjson/generic/ondemand/document-inl.h",
    "include/simdjson/generic/ondemand/json_iterator-inl.h",
    "include/simdjson/generic/ondemand/document_stream-inl.h"
  ],
  "4_related_elements": {
    "include/simdjson/generic/ondemand/document.h": [
      ""
    ],
    "include/simdjson/generic/ondemand/document-inl.h": [
      ""
    ],
    "include/simdjson/generic/ondemand/json_iterator-inl.h": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "include/simdjson/generic/ondemand/document.h": [
          "class: simdjson::ondemand::document"
        ],
        "include/simdjson/generic/ondemand/document-inl.h": [
          "function: simdjson::ondemand::document::current_location\nline: 19\nline: 20\nline: 21"
        ],
        "include/simdjson/generic/ondemand/json_iterator-inl.h": [
          "function: simdjson::ondemand::json_iterator::current_location\nline: 184\nline: 185\nline: 186\nline: 187\nline: 188\nline: 189\nline: 190\nline: 191\nline: 192"
        ]
      },
      "patches": [
        "diff --git a/include/simdjson/generic/ondemand/document-inl.h b/include/simdjson/generic/ondemand/document-inl.h\nindex 794a59f..719de57 100644\n--- a/include/simdjson/generic/ondemand/document-inl.h\n+++ b/include/simdjson/generic/ondemand/document-inl.h\n@@ -1,3 +1,4 @@\n+\n namespace simdjson {\n namespace SIMDJSON_IMPLEMENTATION {\n namespace ondemand {\n@@ -22,6 +23,14 @@ inline std::string document::to_debug_string() noexcept {\n inline bool document::is_alive() noexcept {\n   return iter.is_alive();\n }\n+simdjson_really_inline const char *document::current_location() const noexcept {\n+  if (!iter.is_alive()) { return nullptr; }\n+  auto pos = iter.position();\n+  if (pos < iter.end_position() && pos >= iter.root_position()) {\n+    return reinterpret_cast<const char*>(iter.peek(pos));\n+  }\n+  return nullptr;\n+}\n simdjson_really_inline value_iterator document::resume_value_iterator() noexcept {\n   return value_iterator(&iter, 1, iter.root_position());\n }\n@@ -498,6 +507,7 @@ simdjson_really_inline simdjson_result<number> document_reference::get_number()\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json_token() noexcept { return doc->raw_json_token(); }\n simdjson_really_inline simdjson_result<value> document_reference::at_pointer(std::string_view json_pointer) noexcept { return doc->at_pointer(json_pointer); }\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json() noexcept { return doc->raw_json();}\n+simdjson_really_inline const char *document_reference::current_location() const noexcept { return doc ? doc->current_location() : nullptr; }\n simdjson_really_inline document_reference::operator document&() const noexcept { return *doc; }\n \n } // namespace ondemand\n@@ -665,4 +675,4 @@ simdjson_really_inline simdjson_result<SIMDJSON_IMPLEMENTATION::ondemand::value>\n }\n \n \n-} // namespace simdjson\n+} // namespace simdjson\n",
        "diff --git a/include/simdjson/generic/ondemand/document-inl.h b/include/simdjson/generic/ondemand/document-inl.h\nindex 794a59f..9948ce6 100644\n--- a/include/simdjson/generic/ondemand/document-inl.h\n+++ b/include/simdjson/generic/ondemand/document-inl.h\n@@ -22,6 +22,10 @@ inline std::string document::to_debug_string() noexcept {\n inline bool document::is_alive() noexcept {\n   return iter.is_alive();\n }\n+inline const char * document::current_location() noexcept {\n+  if (!iter.is_alive()) { return nullptr; }\n+  return iter.current_location();\n+}\n simdjson_really_inline value_iterator document::resume_value_iterator() noexcept {\n   return value_iterator(&iter, 1, iter.root_position());\n }\ndiff --git a/include/simdjson/generic/ondemand/json_iterator-inl.h b/include/simdjson/generic/ondemand/json_iterator-inl.h\nindex 16979e8..0602dd9 100644\n--- a/include/simdjson/generic/ondemand/json_iterator-inl.h\n+++ b/include/simdjson/generic/ondemand/json_iterator-inl.h\n@@ -187,14 +187,23 @@ simdjson_really_inline token_position json_iterator::end_position() const noexce\n \n inline std::string json_iterator::to_string() const noexcept {\n   if( !is_alive() ) { return \"dead json_iterator instance\"; }\n-  const char * current_structural = reinterpret_cast<const char *>(token.peek());\n+  const char * base = reinterpret_cast<const char *>(parser->implementation->buf);\n+  const char * current_structural = base ? (base + token.current_offset()) : nullptr;\n+  char structural_char = current_structural ? *current_structural : '?';\n   return std::string(\"json_iterator [ depth : \") + std::to_string(_depth)\n-          + std::string(\", structural : '\") + std::string(current_structural,1)\n+          + std::string(\", structural : '\") + std::string(1, structural_char)\n           + std::string(\"', offset : \") + std::to_string(token.current_offset())\n           + std::string(\"', error : \") + error_message(error)\n           + std::string(\" ]\");\n }\n \n+simdjson_really_inline const char * json_iterator::current_location() const noexcept {\n+  if (!is_alive()) { return nullptr; }\n+  const char * base = reinterpret_cast<const char *>(parser->implementation->buf);\n+  if (!base) { return nullptr; }\n+  return base + token.current_offset();\n+}\n+\n simdjson_really_inline bool json_iterator::is_alive() const noexcept {\n   return parser;\n }\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "include/simdjson/generic/ondemand/json_iterator-inl.h": [
          "line: 184\nline: 185\nline: 186\nline: 187\nline: 188\nline: 189\nline: 190\nline: 191\nline: 192"
        ],
        "include/simdjson/generic/ondemand/document.h": [
          "class: simdjson::ondemand::document\nclass: simdjson::ondemand::document_reference"
        ],
        "include/simdjson/generic/ondemand/document-inl.h": [
          "line: 19\nline: 20\nline: 21\nfunction: simdjson::ondemand::document.current_location\nfunction: simdjson::ondemand::document_reference.current_location"
        ]
      },
      "patches": [
        "diff --git a/include/simdjson/generic/ondemand/document-inl.h b/include/simdjson/generic/ondemand/document-inl.h\nindex 794a59f..c6f4d3b 100644\n--- a/include/simdjson/generic/ondemand/document-inl.h\n+++ b/include/simdjson/generic/ondemand/document-inl.h\n@@ -1,3 +1,4 @@\n+\n namespace simdjson {\n namespace SIMDJSON_IMPLEMENTATION {\n namespace ondemand {\n@@ -22,6 +23,13 @@ inline std::string document::to_debug_string() noexcept {\n inline bool document::is_alive() noexcept {\n   return iter.is_alive();\n }\n+simdjson_really_inline const char *document::current_location() const noexcept {\n+  if (!iter.is_alive()) { return nullptr; }\n+  // Ensure the iterator position is within the document bounds.\n+  auto pos = iter.position();\n+  if (pos < iter.root_position() || pos >= iter.end_position()) { return nullptr; }\n+  return reinterpret_cast<const char*>(iter.unsafe_pointer());\n+}\n simdjson_really_inline value_iterator document::resume_value_iterator() noexcept {\n   return value_iterator(&iter, 1, iter.root_position());\n }\n@@ -498,6 +506,9 @@ simdjson_really_inline simdjson_result<number> document_reference::get_number()\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json_token() noexcept { return doc->raw_json_token(); }\n simdjson_really_inline simdjson_result<value> document_reference::at_pointer(std::string_view json_pointer) noexcept { return doc->at_pointer(json_pointer); }\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json() noexcept { return doc->raw_json();}\n+simdjson_really_inline const char *document_reference::current_location() const noexcept {\n+  return doc ? doc->current_location() : nullptr;\n+}\n simdjson_really_inline document_reference::operator document&() const noexcept { return *doc; }\n \n } // namespace ondemand\n@@ -665,4 +676,4 @@ simdjson_really_inline simdjson_result<SIMDJSON_IMPLEMENTATION::ondemand::value>\n }\n \n \n-} // namespace simdjson\n+} // namespace simdjson\ndiff --git a/include/simdjson/generic/ondemand/json_iterator-inl.h b/include/simdjson/generic/ondemand/json_iterator-inl.h\nindex 16979e8..beccc80 100644\n--- a/include/simdjson/generic/ondemand/json_iterator-inl.h\n+++ b/include/simdjson/generic/ondemand/json_iterator-inl.h\n@@ -1,3 +1,4 @@\n+\n namespace simdjson {\n namespace SIMDJSON_IMPLEMENTATION {\n namespace ondemand {\n@@ -216,6 +217,13 @@ simdjson_really_inline const uint8_t *json_iterator::unsafe_pointer() const noex\n   return token.peek(0);\n }\n \n+simdjson_really_inline const uint8_t *json_iterator::current_location() const noexcept {\n+  if (!is_alive()) { return nullptr; }\n+  auto pos = position();\n+  if (pos < root_position() || pos >= end_position()) { return nullptr; }\n+  return unsafe_pointer();\n+}\n+\n simdjson_really_inline const uint8_t *json_iterator::peek(int32_t delta) const noexcept {\n #if SIMDJSON_CHECK_EOF\n   assert_more_tokens(delta+1);\n@@ -347,4 +355,4 @@ simdjson_really_inline simdjson_result<SIMDJSON_IMPLEMENTATION::ondemand::json_i\n simdjson_really_inline simdjson_result<SIMDJSON_IMPLEMENTATION::ondemand::json_iterator>::simdjson_result(error_code error) noexcept\n     : implementation_simdjson_result_base<SIMDJSON_IMPLEMENTATION::ondemand::json_iterator>(error) {}\n \n-} // namespace simdjson\n+} // namespace simdjson\n",
        "diff --git a/include/simdjson/generic/ondemand/document-inl.h b/include/simdjson/generic/ondemand/document-inl.h\nindex 794a59f..f33f030 100644\n--- a/include/simdjson/generic/ondemand/document-inl.h\n+++ b/include/simdjson/generic/ondemand/document-inl.h\n@@ -19,6 +19,9 @@ inline void document::rewind() noexcept {\n inline std::string document::to_debug_string() noexcept {\n   return iter.to_string();\n }\n+simdjson_really_inline const char * document::current_location() noexcept {\n+  return iter.current_location();\n+}\n inline bool document::is_alive() noexcept {\n   return iter.is_alive();\n }\ndiff --git a/include/simdjson/generic/ondemand/json_iterator-inl.h b/include/simdjson/generic/ondemand/json_iterator-inl.h\nindex 16979e8..7c4bc8c 100644\n--- a/include/simdjson/generic/ondemand/json_iterator-inl.h\n+++ b/include/simdjson/generic/ondemand/json_iterator-inl.h\n@@ -195,6 +195,13 @@ inline std::string json_iterator::to_string() const noexcept {\n           + std::string(\" ]\");\n }\n \n+simdjson_really_inline const char * json_iterator::current_location() const noexcept {\n+  // Returns a pointer to the current location in the input if valid; otherwise nullptr.\n+  if (!is_alive()) { return nullptr; }\n+  if (at_end()) { return nullptr; } // avoid one-past-the-end\n+  return reinterpret_cast<const char *>(token.peek());\n+}\n+\n simdjson_really_inline bool json_iterator::is_alive() const noexcept {\n   return parser;\n }\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/include/simdjson/generic/ondemand/document-inl.h b/include/simdjson/generic/ondemand/document-inl.h\nindex 794a59f..719de57 100644\n--- a/include/simdjson/generic/ondemand/document-inl.h\n+++ b/include/simdjson/generic/ondemand/document-inl.h\n@@ -1,3 +1,4 @@\n+\n namespace simdjson {\n namespace SIMDJSON_IMPLEMENTATION {\n namespace ondemand {\n@@ -22,6 +23,14 @@ inline std::string document::to_debug_string() noexcept {\n inline bool document::is_alive() noexcept {\n   return iter.is_alive();\n }\n+simdjson_really_inline const char *document::current_location() const noexcept {\n+  if (!iter.is_alive()) { return nullptr; }\n+  auto pos = iter.position();\n+  if (pos < iter.end_position() && pos >= iter.root_position()) {\n+    return reinterpret_cast<const char*>(iter.peek(pos));\n+  }\n+  return nullptr;\n+}\n simdjson_really_inline value_iterator document::resume_value_iterator() noexcept {\n   return value_iterator(&iter, 1, iter.root_position());\n }\n@@ -498,6 +507,7 @@ simdjson_really_inline simdjson_result<number> document_reference::get_number()\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json_token() noexcept { return doc->raw_json_token(); }\n simdjson_really_inline simdjson_result<value> document_reference::at_pointer(std::string_view json_pointer) noexcept { return doc->at_pointer(json_pointer); }\n simdjson_really_inline simdjson_result<std::string_view> document_reference::raw_json() noexcept { return doc->raw_json();}\n+simdjson_really_inline const char *document_reference::current_location() const noexcept { return doc ? doc->current_location() : nullptr; }\n simdjson_really_inline document_reference::operator document&() const noexcept { return *doc; }\n \n } // namespace ondemand\n@@ -665,4 +675,4 @@ simdjson_really_inline simdjson_result<SIMDJSON_IMPLEMENTATION::ondemand::value>\n }\n \n \n-} // namespace simdjson\n+} // namespace simdjson\n",
  "7_resolved": false
}