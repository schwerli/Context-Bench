{
  "instance_id": "Multi-SWE-Bench__c__maintenance__bugfix__634fe9b8",
  "original_id": "ponylang__ponyc-2586",
  "1_model_selected_files": [],
  "2_embedding_selected_files": [
    "src/libponyc/pass/sugar.c",
    "src/libponyc/pass/docgen.c",
    "src/libponyc/ast/token.c",
    "src/libponyc/ast/ast.c",
    "src/libponyc/ast/parser.c",
    "src/libponyc/pass/syntax.c",
    "src/libponyc/pass/docgen.h",
    "src/libponyc/pass/flatten.c",
    "src/libponyc/pass/traits.c",
    "src/libponyc/pass/refer.c",
    "src/libponyc/ast/source.c",
    "src/libponyc/pass/finalisers.c",
    "src/libponyc/pass/sugar.h",
    "src/libponyc/ast/lexer.c",
    "src/libponyc/ast/bnfprint.c",
    "src/libponyc/ast/stringtab.c",
    "src/libponyc/ast/parserapi.c",
    "src/libponyc/pass/expr.c"
  ],
  "3_final_combined_files": [
    "src/libponyc/pass/sugar.c",
    "src/libponyc/pass/docgen.c",
    "src/libponyc/ast/token.c"
  ],
  "4_related_elements": {
    "src/libponyc/pass/sugar.c": [
      "function: sugar_entity\nfunction: sugar_docstring\nfunction: sugar_new\nfunction: sugar_be\nfunction: sugar_fun\nfunction: pass_sugar"
    ],
    "src/libponyc/pass/docgen.c": [
      "function: doc_method\nfunction: doc_entity"
    ],
    "src/libponyc/ast/token.c": [
      "function: token_docstring_signature_serialise_trace\nfunction: token_docstring_signature_serialise\nfunction: token_docstring_signature_pony_type"
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "src/libponyc/pass/sugar.c": [
          "line: 153\nline: 218"
        ],
        "src/libponyc/pass/docgen.c": [
          ""
        ],
        "src/libponyc/ast/token.c": [
          ""
        ]
      },
      "patches": [
        "diff --git a/src/libponyc/pass/sugar.c b/src/libponyc/pass/sugar.c\nindex 09bc71a..c6e6c25 100644\n--- a/src/libponyc/pass/sugar.c\n+++ b/src/libponyc/pass/sugar.c\n@@ -201,6 +201,8 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n   }\n \n   // Add field initialisers to all constructors.\n+  // Ensure that if the body starts with a docstring (a leading TK_STRING),\n+  // it remains the first expression so later sugar passes can detect it.\n   if(ast_child(init_seq) != NULL)\n   {\n     member = ast_child(members);\n@@ -216,13 +218,24 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n \n           pony_assert(ast_id(n_body) == TK_SEQ);\n \n-          ast_t* init = ast_child(init_seq);\n+          // If there's a leading docstring, temporarily detach it.\n+          ast_t* first = ast_child(n_body);\n+          bool had_docstring = (first != NULL) && (ast_id(first) == TK_STRING);\n+          if(had_docstring)\n+            ast_remove(first);\n \n+          // Prepend field initialisers to the constructor body.\n+          ast_t* init = ast_child(init_seq);\n           while(init != NULL)\n           {\n             ast_add(n_body, init);\n             init = ast_sibling(init);\n           }\n+\n+          // Re-add the docstring so it remains the first expression.\n+          if(had_docstring)\n+            ast_add(n_body, first);\n+\n           break;\n         }\n \n",
        "diff --git a/src/libponyc/pass/sugar.c b/src/libponyc/pass/sugar.c\nindex 09bc71a..957b4eb 100644\n--- a/src/libponyc/pass/sugar.c\n+++ b/src/libponyc/pass/sugar.c\n@@ -218,11 +218,26 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n \n           ast_t* init = ast_child(init_seq);\n \n+          // Preserve a leading string literal (docstring) as the first expression\n+          // by temporarily removing it, inserting field initializers, then\n+          // re-adding the string at the front.\n+          ast_t* first_expr = ast_child(n_body);\n+          bool first_is_string = (first_expr != NULL) && (ast_id(first_expr) == TK_STRING);\n+          if(first_is_string)\n+          {\n+            ast_remove(first_expr);\n+          }\n+\n           while(init != NULL)\n           {\n             ast_add(n_body, init);\n             init = ast_sibling(init);\n           }\n+\n+          if(first_is_string)\n+          {\n+            ast_add(n_body, first_expr);\n+          }\n           break;\n         }\n \n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "src/libponyc/pass/sugar.c": [
          "function: sugar_entity\nline: 217"
        ],
        "src/libponyc/pass/docgen.c": [
          ""
        ],
        "src/libponyc/ast/token.c": [
          ""
        ]
      },
      "patches": [
        "diff --git a/src/libponyc/pass/sugar.c b/src/libponyc/pass/sugar.c\nindex 09bc71a..d8e6ee8 100644\n--- a/src/libponyc/pass/sugar.c\n+++ b/src/libponyc/pass/sugar.c\n@@ -216,13 +216,28 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n \n           pony_assert(ast_id(n_body) == TK_SEQ);\n \n+          // Preserve docstring position: if the first expression in the\n+          // constructor body is a string literal, it should remain first\n+          // so later sugar passes can detect it as a docstring.\n+          ast_t* first_expr = ast_child(n_body);\n+          bool has_docstring = (first_expr != NULL) && (ast_id(first_expr) == TK_STRING);\n+\n+          // Add field initialisers at the front, preserving their original order\n+          // (existing logic builds a reverse sequence and adds to the front).\n           ast_t* init = ast_child(init_seq);\n-\n           while(init != NULL)\n           {\n             ast_add(n_body, init);\n             init = ast_sibling(init);\n           }\n+\n+          // If there was a leading docstring, move it back to the front so it\n+          // remains the first expression in the body.\n+          if(has_docstring)\n+          {\n+            ast_remove(first_expr);\n+            ast_add(n_body, first_expr);\n+          }\n           break;\n         }\n \n",
        "diff --git a/src/libponyc/pass/sugar.c b/src/libponyc/pass/sugar.c\nindex 09bc71a..23879d1 100644\n--- a/src/libponyc/pass/sugar.c\n+++ b/src/libponyc/pass/sugar.c\n@@ -216,13 +216,21 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n \n           pony_assert(ast_id(n_body) == TK_SEQ);\n \n-          ast_t* init = ast_child(init_seq);\n+          /* Preserve leading docstring as first expression in the constructor body. */\n+          ast_t* first = ast_child(n_body);\n+          bool leading_docstring = (first != NULL) && (ast_id(first) == TK_STRING);\n+          if(leading_docstring)\n+            ast_remove(first);\n \n+          ast_t* init = ast_child(init_seq);\n           while(init != NULL)\n           {\n             ast_add(n_body, init);\n             init = ast_sibling(init);\n           }\n+\n+          if(leading_docstring)\n+            ast_add(n_body, first);\n           break;\n         }\n \n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/src/libponyc/pass/sugar.c b/src/libponyc/pass/sugar.c\nindex 09bc71a..957b4eb 100644\n--- a/src/libponyc/pass/sugar.c\n+++ b/src/libponyc/pass/sugar.c\n@@ -218,11 +218,26 @@ static ast_result_t sugar_entity(pass_opt_t* opt, ast_t* ast, bool add_create,\n \n           ast_t* init = ast_child(init_seq);\n \n+          // Preserve a leading string literal (docstring) as the first expression\n+          // by temporarily removing it, inserting field initializers, then\n+          // re-adding the string at the front.\n+          ast_t* first_expr = ast_child(n_body);\n+          bool first_is_string = (first_expr != NULL) && (ast_id(first_expr) == TK_STRING);\n+          if(first_is_string)\n+          {\n+            ast_remove(first_expr);\n+          }\n+\n           while(init != NULL)\n           {\n             ast_add(n_body, init);\n             init = ast_sibling(init);\n           }\n+\n+          if(first_is_string)\n+          {\n+            ast_add(n_body, first_expr);\n+          }\n           break;\n         }\n \n",
  "7_resolved": false
}