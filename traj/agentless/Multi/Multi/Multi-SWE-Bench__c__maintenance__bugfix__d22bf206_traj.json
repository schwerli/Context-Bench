{
  "instance_id": "Multi-SWE-Bench__c__maintenance__bugfix__d22bf206",
  "original_id": "ponylang__ponyc-1486",
  "1_model_selected_files": [
    "src/libponyc/expr/control.c",
    "src/libponyc/type/safeto.c",
    "src/libponyc/expr/reference.c",
    "src/libponyc/pass/expr.c",
    "src/libponyc/verify/control.c"
  ],
  "2_embedding_selected_files": [
    "src/libponyc/expr/reference.c",
    "src/libponyc/expr/control.c",
    "src/libponyc/codegen/genexpr.c",
    "src/libponyc/expr/call.c",
    "src/libponyc/expr/postfix.c",
    "src/libponyc/pass/finalisers.c",
    "src/libponyc/codegen/gencall.c",
    "src/libponyc/pass/expr.c",
    "src/libponyc/type/safeto.c",
    "src/libponyc/pass/scope.c",
    "src/libponyc/pass/sugar.c",
    "src/libponyc/pass/traits.c",
    "src/libponyc/pass/syntax.c",
    "src/libponyc/verify/call.c",
    "src/libponyc/expr/operator.c",
    "src/libponyc/reach/reach.c",
    "src/libponyc/type/alias.c",
    "src/libponyc/expr/lambda.c",
    "src/libponyc/expr/array.c",
    "src/libponyc/pass/names.c",
    "src/libponyc/expr/literal.c",
    "src/libponyc/expr/ffi.c"
  ],
  "3_final_combined_files": [
    "src/libponyc/expr/control.c",
    "src/libponyc/expr/reference.c",
    "src/libponyc/type/safeto.c",
    "src/libponyc/codegen/genexpr.c"
  ],
  "4_related_elements": {
    "src/libponyc/expr/reference.c": [
      "function: expr_reference\nfunction: expr_fieldref\nfunction: expr_this\nfunction: is_assigned_to\nfunction: valid_reference"
    ],
    "src/libponyc/expr/control.c": [
      "function: expr_recover"
    ],
    "src/libponyc/type/safeto.c": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "src/libponyc/expr/reference.c": [
          "line: 635\nline: 636\nline: 637\nline: 638\nline: 639\nline: 711\nline: 712\nline: 713\nline: 714\nline: 715\nline: 716\nline: 717\nline: 718\nline: 719\nline: 720\nline: 721\nline: 722\nline: 723\nline: 724"
        ],
        "src/libponyc/expr/control.c": [
          ""
        ],
        "src/libponyc/type/safeto.c": [
          ""
        ]
      },
      "patches": [
        "diff --git a/src/libponyc/expr/reference.c b/src/libponyc/expr/reference.c\nindex 164c9ca..cebb31e 100644\n--- a/src/libponyc/expr/reference.c\n+++ b/src/libponyc/expr/reference.c\n@@ -716,10 +716,15 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n \n           if(t->frame->recover != def_recover)\n           {\n-            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n-              \"local defined outside of a recover expression from within \"\n-              \"that recover expression\");\n-            return false;\n+            // If this local is used as the receiver in a dot expression,\n+            // defer the check to expr_dot so sendable members can be allowed.\n+            if(ast_id(ast_parent(ast)) != TK_DOT)\n+            {\n+              ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n+                \"local defined outside of a recover expression from within \"\n+                \"that recover expression\");\n+              return false;\n+            }\n           }\n         }\n       }\n",
        "diff --git a/src/libponyc/expr/reference.c b/src/libponyc/expr/reference.c\nindex 164c9ca..45a8b1f 100644\n--- a/src/libponyc/expr/reference.c\n+++ b/src/libponyc/expr/reference.c\n@@ -712,14 +712,21 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n       {\n         if(t->frame->recover != NULL)\n         {\n-          ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+          // If this reference is used as the base of a member access, defer\n+          // the recover/sendability check to the member access resolution.\n+          ast_t* parent = ast_parent(ast);\n \n-          if(t->frame->recover != def_recover)\n+          if((parent == NULL) || (ast_id(parent) != TK_DOT))\n           {\n-            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n-              \"local defined outside of a recover expression from within \"\n-              \"that recover expression\");\n-            return false;\n+            ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+\n+            if(t->frame->recover != def_recover)\n+            {\n+              ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n+                \"local defined outside of a recover expression from within \"\n+                \"that recover expression\");\n+              return false;\n+            }\n           }\n         }\n       }\n"
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "src/libponyc/expr/reference.c": [
          "function: expr_reference\nline: 634\nline: 635\nline: 636\nline: 637\nline: 638\nline: 639\nline: 711\nline: 712\nline: 713\nline: 714\nline: 715\nline: 716\nline: 717\nline: 718\nline: 719\nline: 720\nline: 721\nline: 722\nline: 723\nline: 724\nline: 725"
        ],
        "src/libponyc/expr/control.c": [
          ""
        ],
        "src/libponyc/type/safeto.c": [
          ""
        ]
      },
      "patches": [
        "diff --git a/src/libponyc/expr/reference.c b/src/libponyc/expr/reference.c\nindex 164c9ca..6bbf303 100644\n--- a/src/libponyc/expr/reference.c\n+++ b/src/libponyc/expr/reference.c\n@@ -687,6 +687,24 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n       if(is_typecheck_error(type))\n         return false;\n \n+      // In a recover expression, only allow accessing locals defined outside\n+      // the current recover if their type is sendable.\n+      if(!sendable(type))\n+      {\n+        if(t->frame->recover != NULL)\n+        {\n+          ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+\n+          if(t->frame->recover != def_recover)\n+          {\n+            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n+              \"local defined outside of a recover expression from within \"\n+              \"that recover expression\");\n+            return false;\n+          }\n+        }\n+      }\n+\n       if(!valid_reference(opt, ast, type, status))\n         return false;\n \n@@ -708,22 +726,6 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n           return false;\n       }\n \n-      if(!sendable(type))\n-      {\n-        if(t->frame->recover != NULL)\n-        {\n-          ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n-\n-          if(t->frame->recover != def_recover)\n-          {\n-            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n-              \"local defined outside of a recover expression from within \"\n-              \"that recover expression\");\n-            return false;\n-          }\n-        }\n-      }\n-\n       // Get the type of the local and attach it to our reference.\n       // Automatically consume a local if the function is done.\n       ast_t* r_type = type;\n",
        "diff --git a/src/libponyc/expr/reference.c b/src/libponyc/expr/reference.c\nindex 164c9ca..69f7030 100644\n--- a/src/libponyc/expr/reference.c\n+++ b/src/libponyc/expr/reference.c\n@@ -712,14 +712,21 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n       {\n         if(t->frame->recover != NULL)\n         {\n-          ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n-\n-          if(t->frame->recover != def_recover)\n+          // If this local is being used as the receiver in a qualified access\n+          // (eg, x.f), defer the recover check to the field access so that\n+          // sendable members can still be used from within a recover block.\n+          ast_t* parent = ast_parent(ast);\n+          if((parent == NULL) || (ast_id(parent) != TK_DOT))\n           {\n-            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n-              \"local defined outside of a recover expression from within \"\n-              \"that recover expression\");\n-            return false;\n+            ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+\n+            if(t->frame->recover != def_recover)\n+            {\n+              ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n+                \"local defined outside of a recover expression from within \"\n+                \"that recover expression\");\n+              return false;\n+            }\n           }\n         }\n       }\n"
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/src/libponyc/expr/reference.c b/src/libponyc/expr/reference.c\nindex 164c9ca..45a8b1f 100644\n--- a/src/libponyc/expr/reference.c\n+++ b/src/libponyc/expr/reference.c\n@@ -712,14 +712,21 @@ bool expr_reference(pass_opt_t* opt, ast_t** astp)\n       {\n         if(t->frame->recover != NULL)\n         {\n-          ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+          // If this reference is used as the base of a member access, defer\n+          // the recover/sendability check to the member access resolution.\n+          ast_t* parent = ast_parent(ast);\n \n-          if(t->frame->recover != def_recover)\n+          if((parent == NULL) || (ast_id(parent) != TK_DOT))\n           {\n-            ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n-              \"local defined outside of a recover expression from within \"\n-              \"that recover expression\");\n-            return false;\n+            ast_t* def_recover = ast_nearest(def, TK_RECOVER);\n+\n+            if(t->frame->recover != def_recover)\n+            {\n+              ast_error(opt->check.errors, ast, \"can't access a non-sendable \"\n+                \"local defined outside of a recover expression from within \"\n+                \"that recover expression\");\n+              return false;\n+            }\n           }\n         }\n       }\n",
  "7_resolved": false
}