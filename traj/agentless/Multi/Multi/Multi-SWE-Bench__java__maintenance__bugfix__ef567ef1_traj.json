{
  "instance_id": "Multi-SWE-Bench__java__maintenance__bugfix__ef567ef1",
  "original_id": "alibaba__fastjson2-2559",
  "1_model_selected_files": [
    "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java",
    "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java"
  ],
  "2_embedding_selected_files": [
    "core/src/main/java/com/alibaba/fastjson2/util/DoubleToDecimal.java",
    "core/src/main/java/com/alibaba/fastjson2/JSONReaderJSONB.java",
    "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java",
    "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderImplBigDecimal.java",
    "core/src/main/java/com/alibaba/fastjson2/function/impl/ToBigDecimal.java",
    "core/src/main/java/com/alibaba/fastjson2/writer/ObjectWriterImplDouble.java",
    "core/src/main/java/com/alibaba/fastjson2/function/impl/ToDouble.java",
    "core/src/main/java/com/alibaba/fastjson2/writer/ObjectWriterImplBigDecimal.java",
    "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderImplDouble.java"
  ],
  "3_final_combined_files": [
    "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java",
    "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java",
    "core/src/main/java/com/alibaba/fastjson2/util/DoubleToDecimal.java",
    "core/src/main/java/com/alibaba/fastjson2/JSONReaderJSONB.java"
  ],
  "4_related_elements": {
    "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java": [
      "function: TypeUtils.cast(java.lang.Object, java.lang.Class, com.alibaba.fastjson2.reader.ObjectReaderProvider)\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\nfunction: TypeUtils.toBigDecimal"
    ],
    "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java": [
      "variable: typeConverts\nfunction: ObjectReaderProvider.getTypeConvert\nfunction: ObjectReaderProvider.registerTypeConvert\nfunction: ObjectReaderProvider.init\nfunction: ObjectReaderProvider.ObjectReaderProvider\nclass: com.alibaba.fastjson2.writer.ObjectWriterPrimitiveImpl"
    ],
    "core/src/main/java/com/alibaba/fastjson2/util/DoubleToDecimal.java": [
      ""
    ]
  },
  "5_sampled_edit_locs_and_patches": [
    {
      "sample_index": 0,
      "edit_locs": {
        "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java": [
          "function: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue"
        ],
        "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java": [
          ""
        ],
        "core/src/main/java/com/alibaba/fastjson2/util/DoubleToDecimal.java": [
          ""
        ]
      },
      "patches": [
        "diff --git a/core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java b/core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\nindex d4ffb50..35f6f84 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\n@@ -474,10 +474,50 @@ public class ObjectReaderProvider\n \n     public Function getTypeConvert(Type from, Type to) {\n         Map<Type, Function> map = typeConverts.get(from);\n-        if (map == null) {\n-            return null;\n+        if (map != null) {\n+            Function f = map.get(to);\n+            if (f != null) {\n+                return f;\n+            }\n         }\n-        return map.get(to);\n+\n+        // Fallback: support converting org.bson.types.Decimal128 to Double/double\n+        if (from instanceof Class) {\n+            Class<?> fromClass = (Class<?>) from;\n+            String className = fromClass.getName();\n+            if (\"org.bson.types.Decimal128\".equals(className)) {\n+                if (to == Double.class || to == double.class) {\n+                    return (obj) -> {\n+                        if (obj == null) {\n+                            return to == double.class ? 0D : null;\n+                        }\n+                        try {\n+                            java.lang.reflect.Method method = obj.getClass().getMethod(\"doubleValue\");\n+                            Object v = method.invoke(obj);\n+                            if (v instanceof Double) {\n+                                return v;\n+                            }\n+                            if (v instanceof Number) {\n+                                return ((Number) v).doubleValue();\n+                            }\n+                        } catch (Throwable e) {\n+                            try {\n+                                java.lang.reflect.Method method = obj.getClass().getMethod(\"bigDecimalValue\");\n+                                Object bd = method.invoke(obj);\n+                                if (bd instanceof java.math.BigDecimal) {\n+                                    return ((java.math.BigDecimal) bd).doubleValue();\n+                                }\n+                            } catch (Throwable ignored) {\n+                                // fall through\n+                            }\n+                        }\n+                        throw new com.alibaba.fastjson2.JSONException(\"can not cast to java.lang.Double, from class \" + className);\n+                    };\n+                }\n+            }\n+        }\n+\n+        return null;\n     }\n \n     public Function registerTypeConvert(Type from, Type to, Function typeConvert) {\ndiff --git a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nindex 323802b..484f364 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n@@ -3128,6 +3128,31 @@ public class TypeUtils {\n             return Double.parseDouble(str);\n         }\n \n+        // Support org.bson.types.Decimal128 -> double\n+        String className = value.getClass().getName();\n+        if (\"org.bson.types.Decimal128\".equals(className)) {\n+            try {\n+                java.lang.reflect.Method method = value.getClass().getMethod(\"doubleValue\");\n+                Object v = method.invoke(value);\n+                if (v instanceof Double) {\n+                    return (Double) v;\n+                }\n+                if (v instanceof Number) {\n+                    return ((Number) v).doubleValue();\n+                }\n+            } catch (Throwable e) {\n+                try {\n+                    java.lang.reflect.Method method = value.getClass().getMethod(\"bigDecimalValue\");\n+                    Object bd = method.invoke(value);\n+                    if (bd instanceof BigDecimal) {\n+                        return ((BigDecimal) bd).doubleValue();\n+                    }\n+                } catch (Throwable ignored) {\n+                    // fall through\n+                }\n+            }\n+        }\n+\n         throw new JSONException(\"can not cast to decimal\");\n     }\n \n@@ -3148,6 +3173,31 @@ public class TypeUtils {\n             return Double.parseDouble(str);\n         }\n \n+        // Support org.bson.types.Decimal128 -> Double\n+        String className = value.getClass().getName();\n+        if (\"org.bson.types.Decimal128\".equals(className)) {\n+            try {\n+                java.lang.reflect.Method method = value.getClass().getMethod(\"doubleValue\");\n+                Object v = method.invoke(value);\n+                if (v instanceof Double) {\n+                    return (Double) v;\n+                }\n+                if (v instanceof Number) {\n+                    return ((Number) v).doubleValue();\n+                }\n+            } catch (Throwable e) {\n+                try {\n+                    java.lang.reflect.Method method = value.getClass().getMethod(\"bigDecimalValue\");\n+                    Object bd = method.invoke(value);\n+                    if (bd instanceof BigDecimal) {\n+                        return ((BigDecimal) bd).doubleValue();\n+                    }\n+                } catch (Throwable ignored) {\n+                    // fall through\n+                }\n+            }\n+        }\n+\n         throw new JSONException(\"can not cast to decimal\");\n     }\n \n",
        "diff --git a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nindex 323802b..47a2394 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n@@ -3120,6 +3120,24 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // Support org.bson.types.Decimal128 without adding a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                Object bd = cls.getMethod(\"bigDecimalValue\").invoke(value);\n+                if (bd instanceof BigDecimal) {\n+                    return ((BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // ignore and try toString fallback below\n+            }\n+            String str = value.toString();\n+            if (str.isEmpty() || \"null\".equals(str)) {\n+                return 0D;\n+            }\n+            return Double.parseDouble(str);\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n@@ -3140,6 +3158,24 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // Support org.bson.types.Decimal128 without adding a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                Object bd = cls.getMethod(\"bigDecimalValue\").invoke(value);\n+                if (bd instanceof BigDecimal) {\n+                    return ((BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // ignore and try toString fallback below\n+            }\n+            String str = value.toString();\n+            if (str.isEmpty() || \"null\".equals(str)) {\n+                return null;\n+            }\n+            return Double.parseDouble(str);\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n"
      ],
      "edit_loc_traj": {
        "prompt": "\nPlease review the following GitHub problem description and relevant files, and provide a set of locations that need to be edited to fix the issue.\nThe locations can be specified as class names, function or method names, or exact line numbers that require modification.\n\n### GitHub Problem Description ###\n[FEATURE]org.bson.types.Decimal128转Double时会报错\n### 请描述您的需求或者改进建议\r\n背景如下：\r\n1、我们会把`java`对象通过`fastjson`转为`String`然后通过**MQ** 发送出来，在接收端会再通过`fastjson`把`String`转化`JSONObject`\r\n```\r\n    public void handleChannel(String data) throws PropertyMapperException {\r\n        JSONObject jsonData = JSON.parseObject(data);\r\n        ViewMO inputMO = jsonData.toJavaObject(ViewMO.class);\r\n        ImportBatchDetailDO task = new ImportBatchDetailDO();\r\n        task.setData(jsonData);\r\n        task.setSyncImportTaskId(inputMO.getId());\r\n        importBatchDetailRepo.save(task);\r\n    }\r\n```\r\n2、由于fastjson缺省反序列化带小数点的数值类型为BigDecimal，所以上面`jsonData`这个`JSONObject`里面的小数都会被转为`BigDecimal`, 而由于我们的数据库用的是`mongodb`，所以存储进`mongodb`时这个`BigDecimal`又会自动被转为`org.bson.types.Decimal128`\r\n3、但是当我们从`MongoDB`读回这个`JSONObject`对象时，由于`java`映射这个`JSONObject`的小数的类型是`Double`，这时由于`fastjson`代码里的`ObjectReaderProvider.typeConverts`并没有把`org.bson.types.Decimal128`转为`Double`的**Converts**, 这时就会报**can not cast to java.lang.Double, from class org.bson.types.Decimal128**错误，以下是具体的代码：\r\n```\r\n@SpringBootTest\r\npublic class BigDecimalTest {\r\n\r\n    @Autowired\r\n    private ImportBatchDetailRepo importBatchDetailRepo;\r\n    @Test\r\n    public void testBigDecimal() {\r\n        ImportBatchDetailDO importBatchDetailDO = importBatchDetailRepo.findById(\"64dc97577e47e340a7165e0b\");\r\n        JSONObject data = importBatchDetailDO.getData();\r\n        ImportRefinedMO javaObject = data.toJavaObject(ImportRefinedMO.class);\r\n\r\n    }\r\n}\r\n\r\n@Getter\r\n@Setter\r\npublic class ImportBatchDetailDO {\r\n\r\n    private String syncImportTaskId;\r\n    private JSONObject data;\r\n\r\n}\r\n\r\n@Getter\r\n@Setter\r\npublic class ImportRefinedMO {\r\n\r\n    private Double holidayHour;\r\n}\r\n```\r\n\r\n### 请描述你建议的实现方案\r\n只要优化`TypeUtils.cast`这个方法，增加支持从`org.bson.types.Decimal128`转为`Double`就可以了，以下是具体的代码可能实现并不是最优美的方式，但是以下这个实现经过我的测试是可以解决我上面这个问题，在`TypeUtils`类的**1525**行增加以下代码:\r\n```\r\n        String objClassName = obj.getClass().getName();\r\n        if (obj instanceof Number && objClassName.equals(\"org.bson.types.Decimal128\") && targetClass == Double.class) {\r\n            ObjectWriter objectWriter = JSONFactory\r\n                    .getDefaultObjectWriterProvider()\r\n                    .getObjectWriter(obj.getClass());\r\n            if (objectWriter instanceof ObjectWriterPrimitiveImpl) {\r\n                Function function = ((ObjectWriterPrimitiveImpl<?>) objectWriter).getFunction();\r\n                if (function != null) {\r\n                    Object apply = function.apply(obj);\r\n                    Function DecimalTypeConvert = provider.getTypeConvert(apply.getClass(), targetClass);\r\n                    if (DecimalTypeConvert != null) {\r\n                        return (T) DecimalTypeConvert.apply(obj);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n```\r\n\r\n\r\n\r\n\n\n###\n### core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n...\n1820|                return getTypeName(superclass);\n1821|            }\n1822|        }\n1823|\n1824|        return typeName;\n1825|    }\n1826|\n1827|    public static Class getMapping(String typeName) {\n1828|        return TYPE_MAPPINGS.get(typeName);\n1829|    }\n1830|\n1831|    public static BigDecimal toBigDecimal(Object value) {\n1832|        if (value == null || value instanceof BigDecimal) {\n1833|            return (BigDecimal) value;\n1834|        }\n1835|\n1836|        if (value instanceof Byte || value instanceof Short || value instanceof Integer || value instanceof Long) {\n1837|            return BigDecimal.valueOf(((Number) value).longValue());\n1838|        }\n1839|\n1840|        if (value instanceof String) {\n1841|            String str = (String) value;\n1842|            if (str.isEmpty() || \"null\".equals(str)) {\n1843|                return null;\n1844|            }\n1845|            return new BigDecimal(str);\n1846|        }\n1847|\n1848|        return cast(value, BigDecimal.class);\n1849|    }\n1850|\n1851|    public static BigDecimal toBigDecimal(long i) {\n1852|        return BigDecimal.valueOf(i);\n1853|    }\n1854|\n1855|    public static BigDecimal toBigDecimal(float f) {\n1856|        byte[] bytes = new byte[15];\n1857|        int size = DoubleToDecimal.toString(f, bytes, 0, true);\n1858|        return parseBigDecimal(bytes, 0, size);\n...\n3099|        if (value instanceof String) {\n3100|            String str = (String) value;\n3101|            if (str.isEmpty() || \"null\".equals(str)) {\n3102|                return null;\n3103|            }\n3104|            return Float.parseFloat(str);\n3105|        }\n3106|\n3107|        throw new JSONException(\"can not cast to decimal\");\n3108|    }\n3109|\n3110|    public static double toDoubleValue(Object value) {\n3111|        if (value == null) {\n3112|            return 0D;\n3113|        }\n3114|\n3115|        if (value instanceof Double) {\n3116|            return (Double) value;\n3117|        }\n3118|\n3119|        if (value instanceof Number) {\n3120|            return ((Number) value).doubleValue();\n3121|        }\n3122|\n3123|        if (value instanceof String) {\n3124|            String str = (String) value;\n3125|            if (str.isEmpty() || \"null\".equals(str)) {\n3126|                return 0D;\n3127|            }\n3128|            return Double.parseDouble(str);\n3129|        }\n3130|\n3131|        throw new JSONException(\"can not cast to decimal\");\n3132|    }\n3133|\n3134|    public static Double toDouble(Object value) {\n3135|        if (value == null || value instanceof Double) {\n3136|            return (Double) value;\n3137|        }\n3138|\n3139|        if (value instanceof Number) {\n3140|            return ((Number) value).doubleValue();\n3141|        }\n3142|\n3143|        if (value instanceof String) {\n3144|            String str = (String) value;\n3145|            if (str.isEmpty() || \"null\".equals(str)) {\n3146|                return null;\n3147|            }\n3148|            return Double.parseDouble(str);\n3149|        }\n3150|\n3151|        throw new JSONException(\"can not cast to decimal\");\n3152|    }\n3153|\n3154|    public static int compare(Object a, Object b) {\n3155|        final Class typeA = a.getClass(), typeB = b.getClass();\n3156|\n3157|        if (typeA == typeB) {\n3158|            return ((Comparable) a).compareTo(b);\n3159|        }\n3160|\n3161|        if (typeA == BigDecimal.class) {\n...\n\n\n### core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\n...\n458|\n459|        modules.add(new ObjectReaderBaseModule(this));\n460|        init();\n461|    }\n462|\n463|    public ObjectReaderProvider(ObjectReaderCreator creator) {\n464|        this.creator = creator;\n465|        modules.add(new ObjectReaderBaseModule(this));\n466|        init();\n467|    }\n468|\n469|    void init() {\n470|        for (ObjectReaderModule module : modules) {\n471|            module.init(this);\n472|        }\n473|    }\n474|\n475|    public Function getTypeConvert(Type from, Type to) {\n476|        Map<Type, Function> map = typeConverts.get(from);\n477|        if (map == null) {\n478|            return null;\n479|        }\n480|        return map.get(to);\n481|    }\n482|\n483|    public Function registerTypeConvert(Type from, Type to, Function typeConvert) {\n484|        Map<Type, Function> map = typeConverts.get(from);\n485|        if (map == null) {\n486|            typeConverts.putIfAbsent(from, new ConcurrentHashMap<>());\n487|            map = typeConverts.get(from);\n488|        }\n489|        return map.put(to, typeConvert);\n490|    }\n491|\n492|    public ObjectReader getObjectReader(long hashCode) {\n493|        ObjectReaderCachePair pair = readerCache;\n494|        if (pair != null) {\n495|            if (pair.hashCode == hashCode) {\n496|                return pair.reader;\n497|            } else {\n498|                if (pair.missCount++ > 16) {\n499|                    readerCache = null;\n...\n\n\n\n\n###\n\nPlease provide the class name, function or method name, or the exact line numbers that need to be edited.\nThe possible location outputs should be either \"class\", \"function\" or \"line\".\n\n### Examples:\n```\nfull_path1/file1.java\nline: 10\nclass: MyClass1\nline: 51\n\nfull_path2/file2.java\nfunction: MyClass2.my_method\nline: 12\n\nfull_path3/file3.java\nfunction: my_function\nline: 24\nline: 156\n```\n\nReturn just the location(s) wrapped with ```.\n",
        "response": [
          "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n```",
          "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n\ncore/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\nfunction: ObjectReaderProvider.init\n```"
        ],
        "usage": {
          "completion_tokens": 0,
          "prompt_tokens": 0
        }
      },
      "additional_artifact_loc_edit_location": [
        {
          "raw_output_loc": [
            "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n```",
            "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n\ncore/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\nfunction: ObjectReaderProvider.init\n```"
          ]
        }
      ]
    },
    {
      "sample_index": 1,
      "edit_locs": {
        "core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java": [
          "function: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue"
        ],
        "core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java": [
          "function: ObjectReaderProvider.init"
        ],
        "core/src/main/java/com/alibaba/fastjson2/util/DoubleToDecimal.java": [
          ""
        ]
      },
      "patches": [
        "diff --git a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nindex 323802b..6015f52 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n@@ -3128,6 +3128,29 @@ public class TypeUtils {\n             return Double.parseDouble(str);\n         }\n \n+        // Support conversion from org.bson.types.Decimal128 without introducing a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                java.lang.reflect.Method m = cls.getMethod(\"bigDecimalValue\");\n+                Object bigDec = m.invoke(value);\n+                if (bigDec instanceof BigDecimal) {\n+                    return ((BigDecimal) bigDec).doubleValue();\n+                }\n+                String str = bigDec == null ? null : bigDec.toString();\n+                if (str == null || str.isEmpty() || \"null\".equals(str)) {\n+                    return 0D;\n+                }\n+                return Double.parseDouble(str);\n+            } catch (Throwable e) {\n+                String str = value.toString();\n+                if (str.isEmpty() || \"null\".equals(str)) {\n+                    return 0D;\n+                }\n+                return Double.parseDouble(str);\n+            }\n+        }\n+\n         throw new JSONException(\"can not cast to decimal\");\n     }\n \n@@ -3148,6 +3171,29 @@ public class TypeUtils {\n             return Double.parseDouble(str);\n         }\n \n+        // Support conversion from org.bson.types.Decimal128 without introducing a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                java.lang.reflect.Method m = cls.getMethod(\"bigDecimalValue\");\n+                Object bigDec = m.invoke(value);\n+                if (bigDec instanceof BigDecimal) {\n+                    return ((BigDecimal) bigDec).doubleValue();\n+                }\n+                String str = bigDec == null ? null : bigDec.toString();\n+                if (str == null || str.isEmpty() || \"null\".equals(str)) {\n+                    return null;\n+                }\n+                return Double.parseDouble(str);\n+            } catch (Throwable e) {\n+                String str = value.toString();\n+                if (str.isEmpty() || \"null\".equals(str)) {\n+                    return null;\n+                }\n+                return Double.parseDouble(str);\n+            }\n+        }\n+\n         throw new JSONException(\"can not cast to decimal\");\n     }\n \n",
        "diff --git a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nindex 323802b..16671e0 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n@@ -3120,6 +3120,21 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // support org.bson.types.Decimal128 without hard dependency\n+        String className = value.getClass().getName();\n+        if (\"org.bson.types.Decimal128\".equals(className)) {\n+            try {\n+                java.lang.reflect.Method m = value.getClass().getMethod(\"bigDecimalValue\");\n+                Object bd = m.invoke(value);\n+                if (bd instanceof java.math.BigDecimal) {\n+                    return ((java.math.BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // fallback to parse string representation\n+            }\n+            return Double.parseDouble(value.toString());\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n@@ -3140,6 +3155,21 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // support org.bson.types.Decimal128 without hard dependency\n+        String className = value.getClass().getName();\n+        if (\"org.bson.types.Decimal128\".equals(className)) {\n+            try {\n+                java.lang.reflect.Method m = value.getClass().getMethod(\"bigDecimalValue\");\n+                Object bd = m.invoke(value);\n+                if (bd instanceof java.math.BigDecimal) {\n+                    return ((java.math.BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // fallback to parse string representation\n+            }\n+            return Double.parseDouble(value.toString());\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n"
      ],
      "edit_loc_traj": {
        "prompt": "\nPlease review the following GitHub problem description and relevant files, and provide a set of locations that need to be edited to fix the issue.\nThe locations can be specified as class names, function or method names, or exact line numbers that require modification.\n\n### GitHub Problem Description ###\n[FEATURE]org.bson.types.Decimal128转Double时会报错\n### 请描述您的需求或者改进建议\r\n背景如下：\r\n1、我们会把`java`对象通过`fastjson`转为`String`然后通过**MQ** 发送出来，在接收端会再通过`fastjson`把`String`转化`JSONObject`\r\n```\r\n    public void handleChannel(String data) throws PropertyMapperException {\r\n        JSONObject jsonData = JSON.parseObject(data);\r\n        ViewMO inputMO = jsonData.toJavaObject(ViewMO.class);\r\n        ImportBatchDetailDO task = new ImportBatchDetailDO();\r\n        task.setData(jsonData);\r\n        task.setSyncImportTaskId(inputMO.getId());\r\n        importBatchDetailRepo.save(task);\r\n    }\r\n```\r\n2、由于fastjson缺省反序列化带小数点的数值类型为BigDecimal，所以上面`jsonData`这个`JSONObject`里面的小数都会被转为`BigDecimal`, 而由于我们的数据库用的是`mongodb`，所以存储进`mongodb`时这个`BigDecimal`又会自动被转为`org.bson.types.Decimal128`\r\n3、但是当我们从`MongoDB`读回这个`JSONObject`对象时，由于`java`映射这个`JSONObject`的小数的类型是`Double`，这时由于`fastjson`代码里的`ObjectReaderProvider.typeConverts`并没有把`org.bson.types.Decimal128`转为`Double`的**Converts**, 这时就会报**can not cast to java.lang.Double, from class org.bson.types.Decimal128**错误，以下是具体的代码：\r\n```\r\n@SpringBootTest\r\npublic class BigDecimalTest {\r\n\r\n    @Autowired\r\n    private ImportBatchDetailRepo importBatchDetailRepo;\r\n    @Test\r\n    public void testBigDecimal() {\r\n        ImportBatchDetailDO importBatchDetailDO = importBatchDetailRepo.findById(\"64dc97577e47e340a7165e0b\");\r\n        JSONObject data = importBatchDetailDO.getData();\r\n        ImportRefinedMO javaObject = data.toJavaObject(ImportRefinedMO.class);\r\n\r\n    }\r\n}\r\n\r\n@Getter\r\n@Setter\r\npublic class ImportBatchDetailDO {\r\n\r\n    private String syncImportTaskId;\r\n    private JSONObject data;\r\n\r\n}\r\n\r\n@Getter\r\n@Setter\r\npublic class ImportRefinedMO {\r\n\r\n    private Double holidayHour;\r\n}\r\n```\r\n\r\n### 请描述你建议的实现方案\r\n只要优化`TypeUtils.cast`这个方法，增加支持从`org.bson.types.Decimal128`转为`Double`就可以了，以下是具体的代码可能实现并不是最优美的方式，但是以下这个实现经过我的测试是可以解决我上面这个问题，在`TypeUtils`类的**1525**行增加以下代码:\r\n```\r\n        String objClassName = obj.getClass().getName();\r\n        if (obj instanceof Number && objClassName.equals(\"org.bson.types.Decimal128\") && targetClass == Double.class) {\r\n            ObjectWriter objectWriter = JSONFactory\r\n                    .getDefaultObjectWriterProvider()\r\n                    .getObjectWriter(obj.getClass());\r\n            if (objectWriter instanceof ObjectWriterPrimitiveImpl) {\r\n                Function function = ((ObjectWriterPrimitiveImpl<?>) objectWriter).getFunction();\r\n                if (function != null) {\r\n                    Object apply = function.apply(obj);\r\n                    Function DecimalTypeConvert = provider.getTypeConvert(apply.getClass(), targetClass);\r\n                    if (DecimalTypeConvert != null) {\r\n                        return (T) DecimalTypeConvert.apply(obj);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n```\r\n\r\n\r\n\r\n\n\n###\n### core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n...\n1820|                return getTypeName(superclass);\n1821|            }\n1822|        }\n1823|\n1824|        return typeName;\n1825|    }\n1826|\n1827|    public static Class getMapping(String typeName) {\n1828|        return TYPE_MAPPINGS.get(typeName);\n1829|    }\n1830|\n1831|    public static BigDecimal toBigDecimal(Object value) {\n1832|        if (value == null || value instanceof BigDecimal) {\n1833|            return (BigDecimal) value;\n1834|        }\n1835|\n1836|        if (value instanceof Byte || value instanceof Short || value instanceof Integer || value instanceof Long) {\n1837|            return BigDecimal.valueOf(((Number) value).longValue());\n1838|        }\n1839|\n1840|        if (value instanceof String) {\n1841|            String str = (String) value;\n1842|            if (str.isEmpty() || \"null\".equals(str)) {\n1843|                return null;\n1844|            }\n1845|            return new BigDecimal(str);\n1846|        }\n1847|\n1848|        return cast(value, BigDecimal.class);\n1849|    }\n1850|\n1851|    public static BigDecimal toBigDecimal(long i) {\n1852|        return BigDecimal.valueOf(i);\n1853|    }\n1854|\n1855|    public static BigDecimal toBigDecimal(float f) {\n1856|        byte[] bytes = new byte[15];\n1857|        int size = DoubleToDecimal.toString(f, bytes, 0, true);\n1858|        return parseBigDecimal(bytes, 0, size);\n...\n3099|        if (value instanceof String) {\n3100|            String str = (String) value;\n3101|            if (str.isEmpty() || \"null\".equals(str)) {\n3102|                return null;\n3103|            }\n3104|            return Float.parseFloat(str);\n3105|        }\n3106|\n3107|        throw new JSONException(\"can not cast to decimal\");\n3108|    }\n3109|\n3110|    public static double toDoubleValue(Object value) {\n3111|        if (value == null) {\n3112|            return 0D;\n3113|        }\n3114|\n3115|        if (value instanceof Double) {\n3116|            return (Double) value;\n3117|        }\n3118|\n3119|        if (value instanceof Number) {\n3120|            return ((Number) value).doubleValue();\n3121|        }\n3122|\n3123|        if (value instanceof String) {\n3124|            String str = (String) value;\n3125|            if (str.isEmpty() || \"null\".equals(str)) {\n3126|                return 0D;\n3127|            }\n3128|            return Double.parseDouble(str);\n3129|        }\n3130|\n3131|        throw new JSONException(\"can not cast to decimal\");\n3132|    }\n3133|\n3134|    public static Double toDouble(Object value) {\n3135|        if (value == null || value instanceof Double) {\n3136|            return (Double) value;\n3137|        }\n3138|\n3139|        if (value instanceof Number) {\n3140|            return ((Number) value).doubleValue();\n3141|        }\n3142|\n3143|        if (value instanceof String) {\n3144|            String str = (String) value;\n3145|            if (str.isEmpty() || \"null\".equals(str)) {\n3146|                return null;\n3147|            }\n3148|            return Double.parseDouble(str);\n3149|        }\n3150|\n3151|        throw new JSONException(\"can not cast to decimal\");\n3152|    }\n3153|\n3154|    public static int compare(Object a, Object b) {\n3155|        final Class typeA = a.getClass(), typeB = b.getClass();\n3156|\n3157|        if (typeA == typeB) {\n3158|            return ((Comparable) a).compareTo(b);\n3159|        }\n3160|\n3161|        if (typeA == BigDecimal.class) {\n...\n\n\n### core/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\n...\n458|\n459|        modules.add(new ObjectReaderBaseModule(this));\n460|        init();\n461|    }\n462|\n463|    public ObjectReaderProvider(ObjectReaderCreator creator) {\n464|        this.creator = creator;\n465|        modules.add(new ObjectReaderBaseModule(this));\n466|        init();\n467|    }\n468|\n469|    void init() {\n470|        for (ObjectReaderModule module : modules) {\n471|            module.init(this);\n472|        }\n473|    }\n474|\n475|    public Function getTypeConvert(Type from, Type to) {\n476|        Map<Type, Function> map = typeConverts.get(from);\n477|        if (map == null) {\n478|            return null;\n479|        }\n480|        return map.get(to);\n481|    }\n482|\n483|    public Function registerTypeConvert(Type from, Type to, Function typeConvert) {\n484|        Map<Type, Function> map = typeConverts.get(from);\n485|        if (map == null) {\n486|            typeConverts.putIfAbsent(from, new ConcurrentHashMap<>());\n487|            map = typeConverts.get(from);\n488|        }\n489|        return map.put(to, typeConvert);\n490|    }\n491|\n492|    public ObjectReader getObjectReader(long hashCode) {\n493|        ObjectReaderCachePair pair = readerCache;\n494|        if (pair != null) {\n495|            if (pair.hashCode == hashCode) {\n496|                return pair.reader;\n497|            } else {\n498|                if (pair.missCount++ > 16) {\n499|                    readerCache = null;\n...\n\n\n\n\n###\n\nPlease provide the class name, function or method name, or the exact line numbers that need to be edited.\nThe possible location outputs should be either \"class\", \"function\" or \"line\".\n\n### Examples:\n```\nfull_path1/file1.java\nline: 10\nclass: MyClass1\nline: 51\n\nfull_path2/file2.java\nfunction: MyClass2.my_method\nline: 12\n\nfull_path3/file3.java\nfunction: my_function\nline: 24\nline: 156\n```\n\nReturn just the location(s) wrapped with ```.\n",
        "response": [
          "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n```",
          "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n\ncore/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\nfunction: ObjectReaderProvider.init\n```"
        ],
        "usage": {
          "completion_tokens": 0,
          "prompt_tokens": 0
        }
      },
      "additional_artifact_loc_edit_location": [
        {
          "raw_output_loc": [
            "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n```",
            "```\ncore/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nfunction: TypeUtils.cast\nfunction: TypeUtils.toDouble\nfunction: TypeUtils.toDoubleValue\n\ncore/src/main/java/com/alibaba/fastjson2/reader/ObjectReaderProvider.java\nfunction: ObjectReaderProvider.init\n```"
          ]
        }
      ]
    }
  ],
  "6_final_selected_patch": "diff --git a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\nindex 323802b..47a2394 100644\n--- a/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n+++ b/core/src/main/java/com/alibaba/fastjson2/util/TypeUtils.java\n@@ -3120,6 +3120,24 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // Support org.bson.types.Decimal128 without adding a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                Object bd = cls.getMethod(\"bigDecimalValue\").invoke(value);\n+                if (bd instanceof BigDecimal) {\n+                    return ((BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // ignore and try toString fallback below\n+            }\n+            String str = value.toString();\n+            if (str.isEmpty() || \"null\".equals(str)) {\n+                return 0D;\n+            }\n+            return Double.parseDouble(str);\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n@@ -3140,6 +3158,24 @@ public class TypeUtils {\n             return ((Number) value).doubleValue();\n         }\n \n+        // Support org.bson.types.Decimal128 without adding a hard dependency\n+        Class<?> cls = value.getClass();\n+        if (\"org.bson.types.Decimal128\".equals(cls.getName())) {\n+            try {\n+                Object bd = cls.getMethod(\"bigDecimalValue\").invoke(value);\n+                if (bd instanceof BigDecimal) {\n+                    return ((BigDecimal) bd).doubleValue();\n+                }\n+            } catch (Throwable ignored) {\n+                // ignore and try toString fallback below\n+            }\n+            String str = value.toString();\n+            if (str.isEmpty() || \"null\".equals(str)) {\n+                return null;\n+            }\n+            return Double.parseDouble(str);\n+        }\n+\n         if (value instanceof String) {\n             String str = (String) value;\n             if (str.isEmpty() || \"null\".equals(str)) {\n",
  "7_resolved": false
}