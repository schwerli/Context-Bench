{"model_name_or_path": "output", "instance_id": "django__django-15973", "model_patch": "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 09785e8586..e459fb62f1 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -450,15 +450,19 @@ class BaseDatabaseSchemaEditor:\n \n         # Make M2M tables\n         for field in model._meta.local_many_to_many:\n-            if field.remote_field.through._meta.auto_created:\n-                self.create_model(field.remote_field.through)\n+            through = getattr(field.remote_field, \"through\", None)\n+            # Only create auto-created intermediary tables. If through is a\n+            # string (not yet resolved), it's an explicit through and should be skipped.\n+            if hasattr(through, \"_meta\") and through._meta.auto_created:\n+                self.create_model(through)\n \n     def delete_model(self, model):\n         \"\"\"Delete a model from the database.\"\"\"\n         # Handle auto-created intermediary models\n         for field in model._meta.local_many_to_many:\n-            if field.remote_field.through._meta.auto_created:\n-                self.delete_model(field.remote_field.through)\n+            through = getattr(field.remote_field, \"through\", None)\n+            if hasattr(through, \"_meta\") and through._meta.auto_created:\n+                self.delete_model(through)\n \n         # Delete the table\n         self.execute(\n@@ -630,8 +634,10 @@ class BaseDatabaseSchemaEditor:\n         involve adding a table instead (for M2M fields).\n         \"\"\"\n         # Special-case implicit M2M tables\n-        if field.many_to_many and field.remote_field.through._meta.auto_created:\n-            return self.create_model(field.remote_field.through)\n+        if field.many_to_many:\n+            through = getattr(field.remote_field, \"through\", None)\n+            if hasattr(through, \"_meta\") and through._meta.auto_created:\n+                return self.create_model(through)\n         # Get the column's definition\n         definition, params = self.column_sql(model, field, include_default=True)\n         # It might not actually have a column behind it\n@@ -704,8 +710,10 @@ class BaseDatabaseSchemaEditor:\n         but for M2Ms may involve deleting a table.\n         \"\"\"\n         # Special-case implicit M2M tables\n-        if field.many_to_many and field.remote_field.through._meta.auto_created:\n-            return self.delete_model(field.remote_field.through)\n+        if field.many_to_many:\n+            through = getattr(field.remote_field, \"through\", None)\n+            if hasattr(through, \"_meta\") and through._meta.auto_created:\n+                return self.delete_model(through)\n         # It might not actually have a column behind it\n         if field.db_parameters(connection=self.connection)[\"type\"] is None:\n             return\ndiff --git a/repro/apps/fonte/__init__.py b/repro/apps/fonte/__init__.py\nnew file mode 100644\nindex 0000000000..926b8d97ac\n--- /dev/null\n+++ b/repro/apps/fonte/__init__.py\n@@ -0,0 +1 @@\n+default_app_config = 'fonte.apps.FonteConfig'\ndiff --git a/repro/apps/fonte/apps.py b/repro/apps/fonte/apps.py\nnew file mode 100644\nindex 0000000000..0e5aeb13d2\n--- /dev/null\n+++ b/repro/apps/fonte/apps.py\n@@ -0,0 +1,4 @@\n+from django.apps import AppConfig\n+class FonteConfig(AppConfig):\n+    name = 'fonte'\n+    label = 'fonte'\ndiff --git a/repro/apps/fonte/migrations/0001_initial.py b/repro/apps/fonte/migrations/0001_initial.py\nnew file mode 100644\nindex 0000000000..25c933736e\n--- /dev/null\n+++ b/repro/apps/fonte/migrations/0001_initial.py\n@@ -0,0 +1,45 @@\n+# Generated by Django 4.2.dev20220825074133 on 2025-12-20 22:39\n+\n+from django.db import migrations, models\n+\n+\n+class Migration(migrations.Migration):\n+\n+    initial = True\n+\n+    dependencies = [\n+        (\"variavel\", \"0001_initial\"),\n+    ]\n+\n+    operations = [\n+        migrations.CreateModel(\n+            name=\"FonteModel\",\n+            fields=[\n+                (\n+                    \"id\",\n+                    models.AutoField(\n+                        auto_created=True,\n+                        primary_key=True,\n+                        serialize=False,\n+                        verbose_name=\"ID\",\n+                    ),\n+                ),\n+                (\"nome\", models.TextField(unique=True)),\n+                (\"descricao\", models.TextField()),\n+                (\"data_inicial\", models.DateField()),\n+                (\"data_final\", models.DateField(blank=True, null=True)),\n+                (\n+                    \"variaveis\",\n+                    models.ManyToManyField(\n+                        through=\"fonte_variavel.FonteVariavelModel\",\n+                        to=\"variavel.variavelmodel\",\n+                    ),\n+                ),\n+            ],\n+            options={\n+                \"verbose_name\": \"Fonte\",\n+                \"verbose_name_plural\": \"Fontes\",\n+                \"db_table\": \"fontes\",\n+            },\n+        ),\n+    ]\ndiff --git a/repro/apps/fonte/migrations/__init__.py b/repro/apps/fonte/migrations/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/repro/apps/fonte/models.py b/repro/apps/fonte/models.py\nnew file mode 100644\nindex 0000000000..e579d98b2f\n--- /dev/null\n+++ b/repro/apps/fonte/models.py\n@@ -0,0 +1,15 @@\n+from django.db.models import Model, TextField, DateField, ManyToManyField\n+\n+class FonteModel(Model):\n+    nome = TextField(unique=True)\n+    descricao = TextField()\n+    data_inicial = DateField()\n+    data_final = DateField(blank=True, null=True)\n+    variaveis = ManyToManyField(\"variavel.VariavelModel\", through=\"fonte_variavel.FonteVariavelModel\")\n+    def __str__(self):\n+        return self.nome\n+    class Meta:\n+        app_label = 'fonte'\n+        db_table = \"fontes\"\n+        verbose_name = \"Fonte\"\n+        verbose_name_plural = \"Fontes\"\ndiff --git a/repro/apps/fonte_variavel/__init__.py b/repro/apps/fonte_variavel/__init__.py\nnew file mode 100644\nindex 0000000000..c3f6f8dcc5\n--- /dev/null\n+++ b/repro/apps/fonte_variavel/__init__.py\n@@ -0,0 +1 @@\n+default_app_config = 'fonte_variavel.apps.FonteVariavelConfig'\ndiff --git a/repro/apps/fonte_variavel/apps.py b/repro/apps/fonte_variavel/apps.py\nnew file mode 100644\nindex 0000000000..0167a43298\n--- /dev/null\n+++ b/repro/apps/fonte_variavel/apps.py\n@@ -0,0 +1,3 @@\n+from django.apps import AppConfig\n+class FonteVariavelConfig(AppConfig):\n+    name = 'fonte_variavel'\ndiff --git a/repro/apps/fonte_variavel/migrations/0001_initial.py b/repro/apps/fonte_variavel/migrations/0001_initial.py\nnew file mode 100644\nindex 0000000000..3b46084b9d\n--- /dev/null\n+++ b/repro/apps/fonte_variavel/migrations/0001_initial.py\n@@ -0,0 +1,50 @@\n+# Generated by Django 4.2.dev20220825074133 on 2025-12-20 22:39\n+\n+from django.db import migrations, models\n+import django.db.models.deletion\n+\n+\n+class Migration(migrations.Migration):\n+\n+    initial = True\n+\n+    dependencies = [\n+        (\"fonte\", \"__first__\"),\n+        (\"variavel\", \"0001_initial\"),\n+    ]\n+\n+    operations = [\n+        migrations.CreateModel(\n+            name=\"FonteVariavelModel\",\n+            fields=[\n+                (\n+                    \"id\",\n+                    models.AutoField(\n+                        auto_created=True,\n+                        primary_key=True,\n+                        serialize=False,\n+                        verbose_name=\"ID\",\n+                    ),\n+                ),\n+                (\n+                    \"fonte\",\n+                    models.ForeignKey(\n+                        on_delete=django.db.models.deletion.CASCADE,\n+                        to=\"fonte.fontemodel\",\n+                    ),\n+                ),\n+                (\n+                    \"variavel\",\n+                    models.ForeignKey(\n+                        on_delete=django.db.models.deletion.CASCADE,\n+                        to=\"variavel.variavelmodel\",\n+                    ),\n+                ),\n+            ],\n+            options={\n+                \"verbose_name\": \"Fonte\",\n+                \"verbose_name_plural\": \"Fontes\",\n+                \"db_table\": \"fontes_variaveis\",\n+            },\n+        ),\n+    ]\ndiff --git a/repro/apps/fonte_variavel/migrations/__init__.py b/repro/apps/fonte_variavel/migrations/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/repro/apps/fonte_variavel/models.py b/repro/apps/fonte_variavel/models.py\nnew file mode 100644\nindex 0000000000..7ab45f0a23\n--- /dev/null\n+++ b/repro/apps/fonte_variavel/models.py\n@@ -0,0 +1,10 @@\n+from django.db.models import Model, ForeignKey, CASCADE\n+\n+class FonteVariavelModel(Model):\n+    variavel = ForeignKey('variavel.VariavelModel', on_delete=CASCADE)\n+    fonte = ForeignKey('fonte.FonteModel', on_delete=CASCADE)\n+    class Meta:\n+        app_label = 'fonte_variavel'\n+        db_table = 'fontes_variaveis'\n+        verbose_name = 'Fonte'\n+        verbose_name_plural = 'Fontes'\ndiff --git a/repro/apps/variavel/__init__.py b/repro/apps/variavel/__init__.py\nnew file mode 100644\nindex 0000000000..1101f03734\n--- /dev/null\n+++ b/repro/apps/variavel/__init__.py\n@@ -0,0 +1 @@\n+default_app_config = 'variavel.apps.VariavelConfig'\ndiff --git a/repro/apps/variavel/apps.py b/repro/apps/variavel/apps.py\nnew file mode 100644\nindex 0000000000..2cf41be704\n--- /dev/null\n+++ b/repro/apps/variavel/apps.py\n@@ -0,0 +1,4 @@\n+from django.apps import AppConfig\n+class VariavelConfig(AppConfig):\n+    name = 'variavel'\n+    label = 'variavel'\ndiff --git a/repro/apps/variavel/migrations/0001_initial.py b/repro/apps/variavel/migrations/0001_initial.py\nnew file mode 100644\nindex 0000000000..bfa4b9a617\n--- /dev/null\n+++ b/repro/apps/variavel/migrations/0001_initial.py\n@@ -0,0 +1,34 @@\n+# Generated by Django 4.2.dev20220825074133 on 2025-12-20 22:39\n+\n+from django.db import migrations, models\n+\n+\n+class Migration(migrations.Migration):\n+\n+    initial = True\n+\n+    dependencies = []\n+\n+    operations = [\n+        migrations.CreateModel(\n+            name=\"VariavelModel\",\n+            fields=[\n+                (\n+                    \"id\",\n+                    models.AutoField(\n+                        auto_created=True,\n+                        primary_key=True,\n+                        serialize=False,\n+                        verbose_name=\"ID\",\n+                    ),\n+                ),\n+                (\"nome\", models.TextField(unique=True)),\n+                (\"descricao\", models.TextField()),\n+            ],\n+            options={\n+                \"verbose_name\": \"Vari\u00e1vel\",\n+                \"verbose_name_plural\": \"Vari\u00e1veis\",\n+                \"db_table\": \"variaveis\",\n+            },\n+        ),\n+    ]\ndiff --git a/repro/apps/variavel/migrations/__init__.py b/repro/apps/variavel/migrations/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/repro/apps/variavel/models.py b/repro/apps/variavel/models.py\nnew file mode 100644\nindex 0000000000..5c97873de2\n--- /dev/null\n+++ b/repro/apps/variavel/models.py\n@@ -0,0 +1,10 @@\n+from django.db.models import Model, TextField\n+\n+class VariavelModel(Model):\n+    nome = TextField(unique=True)\n+    descricao = TextField()\n+    class Meta:\n+        app_label = 'variavel'\n+        db_table = 'variaveis'\n+        verbose_name = 'Vari\u00e1vel'\n+        verbose_name_plural = 'Vari\u00e1veis'\ndiff --git a/repro/manage.py b/repro/manage.py\nnew file mode 100644\nindex 0000000000..4462c9346c\n--- /dev/null\n+++ b/repro/manage.py\n@@ -0,0 +1,17 @@\n+#!/usr/bin/env python3\n+import os\n+import sys\n+\n+# Ensure local Django (in /testbed) is used.\n+THIS_DIR = os.path.dirname(os.path.abspath(__file__))\n+REPO_ROOT = os.path.dirname(THIS_DIR)\n+if REPO_ROOT not in sys.path:\n+    sys.path.insert(0, REPO_ROOT)\n+\n+def main():\n+    os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"repro.settings\")\n+    from django.core.management import execute_from_command_line\n+    execute_from_command_line(sys.argv)\n+\n+if __name__ == \"__main__\":\n+    main()\ndiff --git a/repro/repro/__init__.py b/repro/repro/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/repro/repro/settings.py b/repro/repro/settings.py\nnew file mode 100644\nindex 0000000000..a07b24b0d6\n--- /dev/null\n+++ b/repro/repro/settings.py\n@@ -0,0 +1,18 @@\n+SECRET_KEY = 'dummy'\n+DEBUG = True\n+ALLOWED_HOSTS = ['*']\n+INSTALLED_APPS = [\n+    'django.contrib.contenttypes',\n+    'django.contrib.auth',\n+    'fonte',\n+    'variavel',\n+    'fonte_variavel',\n+]\n+DATABASES = {\n+    'default': {\n+        'ENGINE': 'django.db.backends.sqlite3',\n+        'NAME': ':memory:',\n+    }\n+}\n+ROOT_URLCONF = 'repro.urls'\n+MIDDLEWARE = []\ndiff --git a/repro/repro/urls.py b/repro/repro/urls.py\nnew file mode 100644\nindex 0000000000..eb89e3b92a\n--- /dev/null\n+++ b/repro/repro/urls.py\n@@ -0,0 +1,2 @@\n+from django.urls import path\n+urlpatterns = []\ndiff --git a/repro/repro_script.py b/repro/repro_script.py\nnew file mode 100644\nindex 0000000000..fcbbcdfd15\n--- /dev/null\n+++ b/repro/repro_script.py\n@@ -0,0 +1,39 @@\n+# Reproduction script for ManyToMany through model resolution across apps\n+import os\n+import sys\n+\n+THIS_DIR = os.path.dirname(os.path.abspath(__file__))\n+REPO_ROOT = os.path.dirname(THIS_DIR)\n+if REPO_ROOT not in sys.path:\n+    sys.path.insert(0, REPO_ROOT)\n+\n+# Ensure our app modules are importable\n+APPS_DIR = os.path.join(THIS_DIR, 'apps')\n+if APPS_DIR not in sys.path:\n+    sys.path.insert(0, APPS_DIR)\n+\n+os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"repro.settings\")\n+\n+from django.core.management import call_command\n+from django.apps import apps\n+\n+# Load apps from our local repro apps package\n+apps.populate([\n+    'django.contrib.contenttypes',\n+    'django.contrib.auth',\n+    'fonte',\n+    'variavel',\n+    'fonte_variavel',\n+])\n+\n+# Run migrations for our apps\n+try:\n+    call_command('makemigrations', 'variavel')\n+    call_command('makemigrations', 'fonte_variavel')\n+    call_command('makemigrations', 'fonte')\n+    call_command('migrate')\n+    print('Migrations applied successfully')\n+except Exception as e:\n+    import traceback\n+    traceback.print_exc()\n+    print('Error during migrations:', e)\ndiff --git a/repro/setup.py b/repro/setup.py\nnew file mode 100644\nindex 0000000000..390a6a1f8f\n--- /dev/null\n+++ b/repro/setup.py\n@@ -0,0 +1,2 @@\n+from setuptools import setup, find_packages\n+setup(name='repro', version='0.0.0', packages=find_packages(where='apps') + ['repro'])\n"}