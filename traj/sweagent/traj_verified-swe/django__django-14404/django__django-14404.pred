{"model_name_or_path": "output", "instance_id": "django__django-14404", "model_patch": "diff --git a/django/contrib/admin/sites.py b/django/contrib/admin/sites.py\nindex 59a4a0364d..d9ab81c761 100644\n--- a/django/contrib/admin/sites.py\n+++ b/django/contrib/admin/sites.py\n@@ -420,14 +420,18 @@ class AdminSite:\n     def catch_all_view(self, request, url):\n         if settings.APPEND_SLASH and not url.endswith('/'):\n             urlconf = getattr(request, 'urlconf', None)\n-            path = '%s/' % request.path_info\n+            # Use path_info for resolving against URLconf, but build the\n+            # redirect target from request.path so that FORCE_SCRIPT_NAME (and\n+            # any script name/prefix) is preserved.\n+            path_to_resolve = '%s/' % request.path_info\n+            redirect_path = request.get_full_path(force_append_slash=True)\n             try:\n-                match = resolve(path, urlconf)\n+                match = resolve(path_to_resolve, urlconf)\n             except Resolver404:\n                 pass\n             else:\n                 if getattr(match.func, 'should_append_slash', True):\n-                    return HttpResponsePermanentRedirect(path)\n+                    return HttpResponsePermanentRedirect(redirect_path)\n         raise Http404\n \n     def _build_app_dict(self, request, label=None):\ndiff --git a/repro_force_script_name.py b/repro_force_script_name.py\nnew file mode 100644\nindex 0000000000..a43f6a6f2d\n--- /dev/null\n+++ b/repro_force_script_name.py\n@@ -0,0 +1,87 @@\n+from django.conf import settings\n+from django.http import HttpRequest\n+from django.contrib.admin.sites import AdminSite\n+import django\n+\n+# Minimal settings configuration for standalone script.\n+if not settings.configured:\n+    settings.configure(\n+        DEBUG=True,\n+        SECRET_KEY='test',\n+        APPEND_SLASH=True,\n+        FORCE_SCRIPT_NAME='/PREFIX',\n+        ALLOWED_HOSTS=['testserver'],\n+        ROOT_URLCONF='django.contrib.admin.sites',  # not used but required by Django init sometimes\n+        MIDDLEWARE=[],\n+        INSTALLED_APPS=['django.contrib.admin', 'django.contrib.auth', 'django.contrib.contenttypes'],\n+        TEMPLATES=[{\n+            'BACKEND': 'django.template.backends.django.DjangoTemplates',\n+            'APP_DIRS': True,\n+            'DIRS': [],\n+        }],\n+        DATABASES={'default': {'ENGINE': 'django.db.backends.sqlite3', 'NAME': ':memory:'}},\n+    )\n+\n+django.setup()\n+\n+# Stub resolve to simulate a matching view with should_append_slash=True.\n+class Match:\n+    class Func:\n+        should_append_slash = True\n+    func = Func()\n+\n+def stub_resolve(path, urlconf=None):\n+    # Only return a match for path ending with '/' appended.\n+    return Match()\n+\n+# Monkey-patch resolve in admin.sites module.\n+import django.contrib.admin.sites as admin_sites\n+admin_sites.resolve = stub_resolve\n+\n+# Prepare a request with FORCE_SCRIPT_NAME respected in request.path.\n+req = HttpRequest()\n+req.path_info = '/admin/resource'\n+# WSGIRequest would set path to script_name + path_info.\n+req.path = settings.FORCE_SCRIPT_NAME.rstrip('/') + req.path_info\n+req.META = {'QUERY_STRING': ''}\n+\n+site = AdminSite()\n+\n+# Simulate old behavior for comparison.\n+def old_catch_all_view(request, url):\n+    from django.http import Http404, HttpResponsePermanentRedirect\n+    from django.urls import Resolver404\n+    if settings.APPEND_SLASH and not url.endswith('/'):\n+        urlconf = getattr(request, 'urlconf', None)\n+        path = '%s/' % request.path_info\n+        try:\n+            match = admin_sites.resolve(path, urlconf)\n+        except Resolver404:\n+            pass\n+        else:\n+            if getattr(match.func, 'should_append_slash', True):\n+                return HttpResponsePermanentRedirect(path)\n+    raise Http404\n+\n+try:\n+    resp_old = old_catch_all_view(req, 'admin/resource')\n+    print('OLD redirect location:', resp_old.url)\n+except Exception as e:\n+    print('OLD behavior raised:', type(e).__name__, e)\n+\n+try:\n+    resp_new = site.catch_all_view(req, 'admin/resource')\n+    print('NEW redirect location:', resp_new.url)\n+except Exception as e:\n+    print('NEW behavior raised:', type(e).__name__, e)\n+\n+# Try with query string\n+req_qs = HttpRequest()\n+req_qs.path_info = '/admin/resource'\n+req_qs.path = settings.FORCE_SCRIPT_NAME.rstrip('/') + req_qs.path_info\n+req_qs.META = {'QUERY_STRING': 'a=1&b=2'}\n+try:\n+    resp_new_qs = site.catch_all_view(req_qs, 'admin/resource')\n+    print('NEW redirect with query:', resp_new_qs.url)\n+except Exception as e:\n+    print('NEW behavior raised (qs):', type(e).__name__, e)\n"}