{"model_name_or_path": "output", "instance_id": "astropy__astropy-14539", "model_patch": "diff --git a/astropy/io/fits/diff.py b/astropy/io/fits/diff.py\nindex 100cdf1b8..52c8177be 100644\n--- a/astropy/io/fits/diff.py\n+++ b/astropy/io/fits/diff.py\n@@ -1449,17 +1449,27 @@ class TableDataDiff(_BaseDiff):\n                 arrb.dtype, np.floating\n             ):\n                 diffs = where_not_allclose(arra, arrb, rtol=self.rtol, atol=self.atol)\n-            elif \"P\" in col.format:\n-                diffs = (\n-                    [\n-                        idx\n-                        for idx in range(len(arra))\n-                        if not np.allclose(\n-                            arra[idx], arrb[idx], rtol=self.rtol, atol=self.atol\n-                        )\n-                    ],\n-                )\n+            elif (col.format and (\"P\" in col.format or \"Q\" in col.format)):\n+                # For variable-length array columns (P = 32-bit descriptor,\n+                # Q = 64-bit descriptor), compare per-row arrays to avoid\n+                # ambiguous truth values and handle differing lengths.\n+                diff_indices = []\n+                for idx in range(len(arra)):\n+                    a_row = arra[idx]\n+                    b_row = arrb[idx]\n+                    try:\n+                        equal = np.allclose(a_row, b_row, rtol=self.rtol, atol=self.atol)\n+                    except Exception:\n+                        # Fallback for non-numeric or shape-mismatched arrays\n+                        try:\n+                            equal = np.array_equal(a_row, b_row)\n+                        except Exception:\n+                            equal = (a_row == b_row)\n+                    if not equal:\n+                        diff_indices.append(idx)\n+                diffs = (diff_indices,)\n             else:\n+                # For non-VLA columns, use vectorized comparison.\n                 diffs = np.where(arra != arrb)\n \n             self.diff_total += len(set(diffs[0]))\ndiff --git a/diffbug.fits b/diffbug.fits\nnew file mode 100644\nindex 000000000..fb6df78b7\nBinary files /dev/null and b/diffbug.fits differ\ndiff --git a/diffbug_p.fits b/diffbug_p.fits\nnew file mode 100644\nindex 000000000..67693752e\nBinary files /dev/null and b/diffbug_p.fits differ\ndiff --git a/repro_vla_diff.py b/repro_vla_diff.py\nnew file mode 100644\nindex 000000000..0b14459eb\n--- /dev/null\n+++ b/repro_vla_diff.py\n@@ -0,0 +1,6 @@\n+from astropy.io import fits\n+col = fits.Column(name='a', format='QD', array=[[0], [0, 0]])\n+hdu = fits.BinTableHDU.from_columns([col])\n+hdu.writeto('diffbug.fits', overwrite=True)\n+print(fits.FITSDiff('diffbug.fits', 'diffbug.fits').identical)\n+fits.printdiff('diffbug.fits', 'diffbug.fits')\ndiff --git a/vla_a.fits b/vla_a.fits\nnew file mode 100644\nindex 000000000..fb6df78b7\nBinary files /dev/null and b/vla_a.fits differ\ndiff --git a/vla_b.fits b/vla_b.fits\nnew file mode 100644\nindex 000000000..e2c86f531\nBinary files /dev/null and b/vla_b.fits differ\n"}