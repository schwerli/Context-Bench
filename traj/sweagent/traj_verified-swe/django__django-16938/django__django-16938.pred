{"model_name_or_path": "output", "instance_id": "django__django-16938", "model_patch": "diff --git a/django/core/serializers/python.py b/django/core/serializers/python.py\nindex 36048601af..6a7c249f38 100644\n--- a/django/core/serializers/python.py\n+++ b/django/core/serializers/python.py\n@@ -76,10 +76,15 @@ class Serializer(base.Serializer):\n             else:\n \n                 def m2m_value(value):\n-                    return self._value_from_field(value, value._meta.pk)\n+                    # Support both model instances and raw primary key values.\n+                    if isinstance(value, models.Model):\n+                        return self._value_from_field(value, value._meta.pk)\n+                    return value\n \n                 def queryset_iterator(obj, field):\n-                    return getattr(obj, field.name).only(\"pk\").iterator()\n+                    # Use values_list to avoid combining only() with managers that\n+                    # add select_related() which can cause FieldError when serializing.\n+                    return getattr(obj, field.name).values_list(\"pk\", flat=True).iterator()\n \n             m2m_iter = getattr(obj, \"_prefetched_objects_cache\", {}).get(\n                 field.name,\ndiff --git a/repro_m2m_select_related.py b/repro_m2m_select_related.py\nnew file mode 100644\nindex 0000000000..4ec61c743e\n--- /dev/null\n+++ b/repro_m2m_select_related.py\n@@ -0,0 +1,46 @@\n+import django\n+from django.conf import settings\n+from django.core import serializers\n+\n+# Configure minimal settings\n+settings.configure(\n+    INSTALLED_APPS=['reproapp'],\n+    DATABASES={\n+        'default': {\n+            'ENGINE': 'django.db.backends.sqlite3',\n+            'NAME': ':memory:',\n+        }\n+    },\n+)\n+\n+django.setup()\n+\n+from django.db import connection\n+from reproapp.models import TestTagMaster, TestTag, Test\n+\n+# Create database tables for the models\n+with connection.schema_editor() as editor:\n+    editor.create_model(TestTagMaster)\n+    editor.create_model(TestTag)\n+    editor.create_model(Test)\n+\n+# Create sample data\n+\n+tag_master = TestTagMaster.objects.create(name=\"master\")\n+tag = TestTag.objects.create(name=\"tag\", master=tag_master)\n+test = Test.objects.create(name=\"test\")\n+\n+test.tags.add(tag)\n+\n+test.save()\n+\n+# Try to serialize\n+print(\"Attempting to serialize Test instance with M2M tags...\")\n+try:\n+    data = serializers.serialize(\"json\", [test])\n+    print(\"Serialization succeeded. Output:\")\n+    print(data)\n+except Exception as e:\n+    # Print full exception type and message\n+    import traceback\n+    traceback.print_exc()\ndiff --git a/reproapp/__init__.py b/reproapp/__init__.py\nnew file mode 100644\nindex 0000000000..e69de29bb2\ndiff --git a/reproapp/apps.py b/reproapp/apps.py\nnew file mode 100644\nindex 0000000000..12d5079cbf\n--- /dev/null\n+++ b/reproapp/apps.py\n@@ -0,0 +1,5 @@\n+from django.apps import AppConfig\n+\n+class ReproappConfig(AppConfig):\n+    default_auto_field = 'django.db.models.AutoField'\n+    name = 'reproapp'\ndiff --git a/reproapp/models.py b/reproapp/models.py\nnew file mode 100644\nindex 0000000000..c51d172c26\n--- /dev/null\n+++ b/reproapp/models.py\n@@ -0,0 +1,18 @@\n+from django.db import models\n+\n+class TestTagManager(models.Manager):\n+    def get_queryset(self):\n+        qs = super().get_queryset()\n+        return qs.select_related(\"master\")\n+\n+class TestTagMaster(models.Model):\n+    name = models.CharField(max_length=120)\n+\n+class TestTag(models.Model):\n+    objects = TestTagManager()\n+    name = models.CharField(max_length=120)\n+    master = models.ForeignKey(TestTagMaster, on_delete=models.SET_NULL, null=True)\n+\n+class Test(models.Model):\n+    name = models.CharField(max_length=120)\n+    tags = models.ManyToManyField(TestTag, blank=True)\n"}