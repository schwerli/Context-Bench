{"model_name_or_path": "output", "instance_id": "django__django-12663", "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex caa03665ea..74514ddcd4 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -21,7 +21,7 @@ from django.utils.dateparse import (\n     parse_date, parse_datetime, parse_duration, parse_time,\n )\n from django.utils.duration import duration_microseconds, duration_string\n-from django.utils.functional import Promise, cached_property\n+from django.utils.functional import Promise, LazyObject, cached_property, empty\n from django.utils.ipv6 import clean_ipv6_address\n from django.utils.itercompat import is_iterable\n from django.utils.text import capfirst\n@@ -804,6 +804,19 @@ class Field(RegisterLookupMixin):\n         \"\"\"Perform preliminary non-db specific value checks and conversions.\"\"\"\n         if isinstance(value, Promise):\n             value = value._proxy____cast()\n+        # Handle SimpleLazyObject and other LazyObject wrappers.\n+        if isinstance(value, LazyObject):\n+            # If not yet evaluated, force setup; otherwise unwrap.\n+            if getattr(value, '_wrapped', empty) is empty:\n+                value._setup()\n+            value = value._wrapped\n+        # If a model instance is supplied, compare on its primary key.\n+        try:\n+            # Avoid importing Model to prevent circular imports; use duck typing.\n+            if hasattr(value, '_meta') and hasattr(value, 'pk'):\n+                value = value.pk\n+        except Exception:\n+            pass\n         return value\n \n     def get_db_prep_value(self, value, connection, prepared=False):\ndiff --git a/repro_lazyobject_subquery.py b/repro_lazyobject_subquery.py\nnew file mode 100644\nindex 0000000000..31b0309a03\n--- /dev/null\n+++ b/repro_lazyobject_subquery.py\n@@ -0,0 +1,71 @@\n+import os\n+import sys\n+\n+os.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", \"repro_settings\")\n+\n+# Create minimal settings.\n+from django.conf import settings\n+if not settings.configured:\n+    settings.configure(\n+        INSTALLED_APPS=[\n+            'django.contrib.auth',\n+            'django.contrib.contenttypes',\n+            '__main__',\n+        ],\n+        DATABASES={'default': {'ENGINE': 'django.db.backends.sqlite3', 'NAME': ':memory:'}},\n+        SECRET_KEY='test',\n+        USE_TZ=True,\n+    )\n+\n+import django\n+django.setup()\n+\n+from django.db import models, connection\n+from django.contrib.auth.models import User\n+\n+# Use __main__ app label to satisfy Django's app registry during script run.\n+\n+from django.db.models import OuterRef, Subquery\n+from django.utils.functional import SimpleLazyObject\n+\n+# Define models A, B, C mimicking the PR.\n+class A(models.Model):\n+    class Meta:\n+        app_label = '__main__'\n+    pass\n+\n+class B(models.Model):\n+    class Meta:\n+        app_label = '__main__'\n+    a = models.ForeignKey(A, on_delete=models.CASCADE)\n+\n+class C(models.Model):\n+    class Meta:\n+        app_label = '__main__'\n+    owner = models.ForeignKey(User, on_delete=models.CASCADE)\n+\n+# Create tables using schema_editor.\n+with connection.schema_editor() as schema:\n+    schema.create_model(User)\n+    schema.create_model(A)\n+    schema.create_model(B)\n+    schema.create_model(C)\n+\n+# Now perform operations from the PR.\n+owner_user = (\n+    B.objects.filter(a=OuterRef(\"pk\"))\n+    .annotate(owner_user=Subquery(C.objects.values(\"owner\")))\n+    .values(\"owner_user\")\n+)\n+\n+user = SimpleLazyObject(lambda: User.objects.create_user(\"testuser\"))\n+\n+try:\n+    # This should cause the error before the fix.\n+    # We don't care about the actual results, just that evaluation doesn't crash.\n+    list(A.objects.annotate(owner_user=Subquery(owner_user)).filter(owner_user=user))\n+    print(\"Query executed successfully without TypeError.\")\n+except Exception as e:\n+    # Show the exception type and message to confirm reproduction.\n+    print(\"Exception:\", type(e).__name__, str(e))\n+    raise\n"}