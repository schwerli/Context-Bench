{"model_name_or_path": "output", "instance_id": "django__django-16819", "model_patch": "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 967a91fdc8..5e072cfc1d 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -807,6 +807,22 @@ class IndexOperation(Operation):\n     def model_name_lower(self):\n         return self.model_name.lower()\n \n+    def references_model(self, name, app_label):\n+        \"\"\"\n+        Index operations only reference their own model. This allows the\n+        optimizer to reduce across index operations for other models.\n+        \"\"\"\n+        return name.lower() == self.model_name_lower\n+\n+    def reduce(self, operation, app_label):\n+        \"\"\"\n+        Allow optimizations to proceed across operations that don't reference\n+        this model.\n+        \"\"\"\n+        return super().reduce(operation, app_label) or not operation.references_model(\n+            self.model_name, app_label\n+        )\n+\n \n class AddIndex(IndexOperation):\n     \"\"\"Add an index on a model.\"\"\"\n@@ -820,6 +836,21 @@ class AddIndex(IndexOperation):\n             )\n         self.index = index\n \n+    def reduce(self, operation, app_label):\n+        from .models import DeleteModel\n+\n+        if isinstance(operation, DeleteModel) and self.model_name_lower == operation.name_lower:\n+            # Adding an index and then deleting the model is a no-op.\n+            return [operation]\n+        if (\n+            isinstance(operation, RemoveIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.index.name.lower() == operation.name.lower()\n+        ):\n+            # Adding and then removing the same index cancels out.\n+            return []\n+        return super().reduce(operation, app_label)\n+\n     def state_forwards(self, app_label, state):\n         state.add_index(app_label, self.model_name_lower, self.index)\n \n@@ -869,6 +900,22 @@ class RemoveIndex(IndexOperation):\n         self.model_name = model_name\n         self.name = name\n \n+    def reduce(self, operation, app_label):\n+        from .models import DeleteModel\n+\n+        if isinstance(operation, DeleteModel) and self.model_name_lower == operation.name_lower:\n+            # Removing an index and then deleting the model is equivalent to just\n+            # deleting the model.\n+            return [operation]\n+        if (\n+            isinstance(operation, AddIndex)\n+            and self.model_name_lower == operation.model_name_lower\n+            and self.name.lower() == operation.index.name.lower()\n+        ):\n+            # Removing an index and then adding the same one back cancels out.\n+            return []\n+        return super().reduce(operation, app_label)\n+\n     def state_forwards(self, app_label, state):\n         state.remove_index(app_label, self.model_name_lower, self.name)\n \ndiff --git a/reproduce_index_opt.py b/reproduce_index_opt.py\nnew file mode 100644\nindex 0000000000..4a60d6ae4f\n--- /dev/null\n+++ b/reproduce_index_opt.py\n@@ -0,0 +1,35 @@\n+# Reproduce optimization of AddIndex/RemoveIndex operations\n+from django.db import migrations, models\n+from django.db.migrations.optimizer import MigrationOptimizer\n+\n+\n+def optimize_and_print(ops):\n+    optimizer = MigrationOptimizer()\n+    optimized = optimizer.optimize(ops, app_label=\"migrations\")\n+    print(\"Before:\", [op.__class__.__name__ for op in ops])\n+    print(\"After:\", [op.__class__.__name__ for op in optimized])\n+\n+\n+def main():\n+    # Same index added then removed -> should cancel out\n+    idx = models.Index(fields=[\"pink\"], name=\"pony_pink_idx\")\n+    ops = [migrations.AddIndex(\"Pony\", idx), migrations.RemoveIndex(\"Pony\", \"pony_pink_idx\")]\n+    optimize_and_print(ops)\n+\n+    # Removed then added same index -> should cancel out\n+    idx2 = models.Index(fields=[\"pink\"], name=\"pony_pink_idx\")\n+    ops2 = [migrations.RemoveIndex(\"Pony\", \"pony_pink_idx\"), migrations.AddIndex(\"Pony\", idx2)]\n+    optimize_and_print(ops2)\n+\n+    # Add index then delete model -> should reduce to DeleteModel only\n+    idx3 = models.Index(fields=[\"pink\"], name=\"pony_pink_idx\")\n+    ops3 = [migrations.AddIndex(\"Pony\", idx3), migrations.DeleteModel(\"Pony\")] \n+    optimize_and_print(ops3)\n+\n+    # Remove index then delete model -> should reduce to DeleteModel only\n+    ops4 = [migrations.RemoveIndex(\"Pony\", \"pony_pink_idx\"), migrations.DeleteModel(\"Pony\")] \n+    optimize_and_print(ops4)\n+\n+\n+if __name__ == \"__main__\":\n+    main()\n"}